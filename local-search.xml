<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>TrieTree应用—区划查询</title>
    <link href="/2024/10/27/TrieTree%E5%BA%94%E7%94%A8%E2%80%94%E5%8C%BA%E5%88%92%E6%9F%A5%E8%AF%A2/"/>
    <url>/2024/10/27/TrieTree%E5%BA%94%E7%94%A8%E2%80%94%E5%8C%BA%E5%88%92%E6%9F%A5%E8%AF%A2/</url>
    
    <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>在日常开发中，我们经常会遇到树形结构的数据查询。以用户地址为例，在填写用户地址的时候，我们一般需要定位到用户所属的省、市、区等信息，这里的省、市、区就是典型的树形结构。</p><img src="/2024/10/27/TrieTree%E5%BA%94%E7%94%A8%E2%80%94%E5%8C%BA%E5%88%92%E6%9F%A5%E8%AF%A2/1.png" class=""><p>当我们在搜索栏输入搜索信息时，搜索栏会调用后端接口，来展示对应的参考搜索信息列表。在输入地址信息时，我们也遇到了类似的需求，通过输入的信息，获取与之相匹配的区划名称。要完成这个需求，有几种实现方式：</p><ol><li>数据库模糊搜索：将搜索内容作为数据库查询条件，通过like关键字与区划名称进行模糊搜索。</li><li>搜索引擎：引入搜索引擎，如elasticSearch，预先将区划名称导入到搜索引擎中，将搜索内容作为查询条件，调用搜索引擎进行查询。</li><li>通过Tire数据结构进行前缀匹配：将输入内容作为查询条件，在Tire树中，进行匹配，获取符合匹配的数据。</li></ol><img src="/2024/10/27/TrieTree%E5%BA%94%E7%94%A8%E2%80%94%E5%8C%BA%E5%88%92%E6%9F%A5%E8%AF%A2/2.png" class=""><p>因为用户输入搜索内容时，会实时发送对应的请求到后端，获取相关的匹配列表，如果使用数据库模糊搜索的话，一方面模糊查询数据较慢，另一方面，请求数较多，数据库较难承受，因此这个方案不可行。</p><p>通过搜索引擎进行搜索，能获取到与之匹配或相关的区划信息，但同时也会增加开发的成本，为一个比较简单的需求引入一个复杂的中间件不值得。</p><p>通过综合考虑会，这里决定使用Trie数据结构，来将搜索条件进行前缀匹配，以获取匹配的数据。</p><h1 id="TrieTree实现区划查询"><a href="#TrieTree实现区划查询" class="headerlink" title="TrieTree实现区划查询"></a>TrieTree实现区划查询</h1><h2 id="TrieTree定义"><a href="#TrieTree定义" class="headerlink" title="TrieTree定义"></a>TrieTree定义</h2><p>Tire是一种数状数据结构，可以紧凑地存储字符串，它的主要思想包括以下内容：</p><ul><li>trie是一种树状的数据结构</li><li>根代表一个空字符串</li><li>每个节点存储一个字符并有多个子节点，每个节点对应一个可能的字符</li><li>每个树节点代表一个单词或一个前缀字符串</li></ul><img src="/2024/10/27/TrieTree%E5%BA%94%E7%94%A8%E2%80%94%E5%8C%BA%E5%88%92%E6%9F%A5%E8%AF%A2/3.png" class=""><h2 id="TrieTree前缀树类定义"><a href="#TrieTree前缀树类定义" class="headerlink" title="TrieTree前缀树类定义"></a>TrieTree前缀树类定义</h2><p>如上图所示，对于区域划分，我们将区划全称依次加入到TrieTree后，生成的TrieTree的部分结构上图所示。在这棵TrieTree树中，叶子节点都是在我们数据库中真实存在的区划名称，而中间节点，有一些只是起到链接作用，而有一些也是数据库中真实存在的区划名称，比如广东、广西。针对上述的结构，我们定义的TrieNode结构如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.core.infrastructure.trie;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrieNode</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 链接词，如广、东、汕、头</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Character ch;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 节点当前值，如广东汕、广东</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String currentValue;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 是否为叶子节点</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> isLeaf;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 是否为单词</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> isWord;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 节点层级</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> level;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TrieNode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.level = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">this</span>.isLeaf = <span class="hljs-literal">false</span>;<br>        <span class="hljs-built_in">this</span>.isWord = <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TrieNode</span><span class="hljs-params">(<span class="hljs-type">int</span> level)</span> &#123;<br>        <span class="hljs-built_in">this</span>.level = level;<br>        <span class="hljs-built_in">this</span>.isLeaf = <span class="hljs-literal">false</span>;<br>        <span class="hljs-built_in">this</span>.isWord = <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Map&lt;Character, TrieNode&gt; childNodeMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(Character ch, TrieNode child)</span> &#123;<br>        childNodeMap.put(ch, child);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> TrieNode <span class="hljs-title function_">get</span><span class="hljs-params">(Character ch)</span> &#123;<br>        <span class="hljs-keyword">return</span> childNodeMap.get(ch);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>TrieNode只是我们前缀树的节点，我们还需要定义前缀树类，用于操作这些TrieNode节点，包括新增、匹配查询等：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.core.infrastructure.trie;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.LinkedList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Queue;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrieTree</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">TrieNode</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrieNode</span>();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 新增单词到前缀树中</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> word</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(String word)</span> &#123;<br>        add(root, word.toCharArray(), <span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(TrieNode t, <span class="hljs-type">char</span>[] chars, <span class="hljs-type">int</span> start)</span> &#123;<br>        <span class="hljs-keyword">if</span> (start == chars.length) &#123;<br>            t.setWord(<span class="hljs-literal">true</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> start; i &lt; chars.length; i++) &#123;<br>            <span class="hljs-type">char</span> <span class="hljs-variable">ch</span> <span class="hljs-operator">=</span> chars[i];<br>            <span class="hljs-type">TrieNode</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> t.get(ch);<br>            <span class="hljs-keyword">if</span> (child != <span class="hljs-literal">null</span>) &#123;<br>                add(child, chars, start + <span class="hljs-number">1</span>);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            child = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrieNode</span>(t.getLevel() + <span class="hljs-number">1</span>);<br>            child.setCh(ch);<br>            child.setCurrentValue(t.getCurrentValue() != <span class="hljs-literal">null</span> ? t.getCurrentValue() + ch : <span class="hljs-string">&quot;&quot;</span> + ch);<br>            <span class="hljs-keyword">if</span> (i == chars.length - <span class="hljs-number">1</span>) &#123;<br>                child.setLeaf(<span class="hljs-literal">true</span>);<br>                child.setWord(<span class="hljs-literal">true</span>);<br>            &#125;<br>            t.put(ch, child);<br>            t = child;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 匹配到该单词的第一个节点</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> word</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> TrieNode <span class="hljs-title function_">rootOfMatchWord</span><span class="hljs-params">(String word)</span> &#123;<br>        <span class="hljs-keyword">return</span> rootOfMatchWord(<span class="hljs-built_in">this</span>.root, word.toCharArray(), <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> TrieNode <span class="hljs-title function_">rootOfMatchWord</span><span class="hljs-params">(TrieNode root, <span class="hljs-type">char</span>[] chars, <span class="hljs-type">int</span> start)</span> &#123;<br>        <span class="hljs-keyword">if</span> (start == chars.length) &#123;<br>            <span class="hljs-keyword">return</span> root;<br>        &#125;<br>        <span class="hljs-type">char</span> <span class="hljs-variable">ch</span> <span class="hljs-operator">=</span> chars[start];<br>        <span class="hljs-type">TrieNode</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> root.get(ch);<br>        <span class="hljs-keyword">if</span> (child == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> rootOfMatchWord(child, chars, start + <span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 前缀和word匹配，并且属于word类型的节点</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> word</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> List&lt;TrieNode&gt; <span class="hljs-title function_">matchWord</span><span class="hljs-params">(String word)</span> &#123;<br>        <span class="hljs-type">TrieNode</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> rootOfMatchWord(word);<br>        <span class="hljs-keyword">if</span> (t == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        &#125;<br>        List&lt;TrieNode&gt; matchWordTrieNodeList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        Queue&lt;TrieNode&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br>        queue.add(t);<br>        <span class="hljs-keyword">while</span> (!queue.isEmpty()) &#123;<br>            <span class="hljs-type">TrieNode</span> <span class="hljs-variable">head</span> <span class="hljs-operator">=</span> queue.poll();<br>            <span class="hljs-keyword">if</span> (head.isWord()) &#123;<br>                matchWordTrieNodeList.add(head);<br>            &#125;<br>            <span class="hljs-keyword">for</span> (TrieNode child : head.getChildNodeMap().values()) &#123;<br>                queue.add(child);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> matchWordTrieNodeList;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        Queue&lt;TrieNode&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br>        queue.add(root);<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-keyword">while</span> (!queue.isEmpty()) &#123;<br>            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">stringBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> queue.size();<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; size; i++) &#123;<br>                <span class="hljs-type">TrieNode</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> queue.poll();<br>                stringBuilder.append(t.getCurrentValue()).append(<span class="hljs-string">&quot;(&quot;</span>).append(t.isWord()).append(<span class="hljs-string">&quot;) &quot;</span>);<br>                <span class="hljs-keyword">for</span> (TrieNode child : t.getChildNodeMap().values()) &#123;<br>                    queue.add(child);<br>                &#125;<br>            &#125;<br>            result.append(stringBuilder.toString()).append(<span class="hljs-string">&quot;\n&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> result.toString();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>我们执行下列代码，用来测试TrieTree的添加、查询方法是否正确：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@Test</span><br>  public void testTrieTree() &#123;<br>      TrieTree trieTree = new TrieTree();<br>      trieTree.add(<span class="hljs-string">&quot;广东汕头&quot;</span>);<br>      trieTree.add(<span class="hljs-string">&quot;广东汕尾&quot;</span>);<br>      trieTree.add(<span class="hljs-string">&quot;广东广州&quot;</span>);<br>      trieTree.add(<span class="hljs-string">&quot;广东深圳&quot;</span>);<br>      trieTree.add(<span class="hljs-string">&quot;广东珠海&quot;</span>);<br>      trieTree.add(<span class="hljs-string">&quot;广东佛山&quot;</span>);<br>      trieTree.add(<span class="hljs-string">&quot;浙江温州&quot;</span>);<br>      trieTree.add(<span class="hljs-string">&quot;浙江杭州&quot;</span>);<br>      trieTree.add(<span class="hljs-string">&quot;浙江嘉兴&quot;</span>);<br>      System.out.println(trieTree);<br>      <span class="hljs-type">List</span>&lt;TrieNode&gt; matchWordList = trieTree.matchWord(<span class="hljs-string">&quot;广东汕&quot;</span>);<br>      System.out.println(<span class="hljs-string">&quot;前缀匹配输入单词的有====================&quot;</span>);<br>      <span class="hljs-keyword">for</span> (TrieNode trieNode : matchWordList) &#123;<br>          System.out.println(trieNode.getCurrentValue());<br>      &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><p>执行结果如下：</p><img src="/2024/10/27/TrieTree%E5%BA%94%E7%94%A8%E2%80%94%E5%8C%BA%E5%88%92%E6%9F%A5%E8%AF%A2/4.png" class=""><h2 id="区划前缀树构建"><a href="#区划前缀树构建" class="headerlink" title="区划前缀树构建"></a>区划前缀树构建</h2><h3 id="初步实现"><a href="#初步实现" class="headerlink" title="初步实现"></a>初步实现</h3><p>在应用启动的时候，我们从数据库中查询出所有地址区划信息，并将其数据插入到我们的地址前缀树种，在查询的时候，通过地址前缀树，匹配到对应的地址信息，并返回给前端：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@Component</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">RegionPrefixTrieNodeHelper</span> &#123;<br>    private TrieTree regionTrieTree = new TrieTree();<br><br><span class="hljs-meta">    @Autowired</span><br>    private RegionRepository regionRepository;<br><br>    public <span class="hljs-type">List</span>&lt;String&gt; matchRegionNameList(String word) &#123;<br>        <span class="hljs-type">List</span>&lt;TrieNode&gt; trieNodes = regionTrieTree.matchWord(word);<br>        <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(trieNodes)) &#123;<br>            <span class="hljs-keyword">return</span> new ArrayList&lt;&gt;();<br>        &#125;<br>        <span class="hljs-keyword">return</span> trieNodes.stream().<span class="hljs-built_in">map</span>(TrieNode::getCurrentValue).collect(Collectors.toList());<br>    &#125;<br><br><span class="hljs-meta">    @PostConstruct</span><br>    public void init() &#123;<br>        <span class="hljs-type">List</span>&lt;RegionModel&gt; regionModelList = regionRepository.queryAll();<br>        <span class="hljs-keyword">for</span> (RegionModel regionModel : regionModelList) &#123;<br>            regionTrieTree.add(regionModel.getRegionFullName());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>domain层实现：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python">/**<br>   * 使用前缀树进行匹配查询<br>   * @param inputWord<br>   * @<span class="hljs-keyword">return</span><br>   */<br>  public <span class="hljs-type">List</span>&lt;String&gt; queryRegionFullNameByTrieTree(String inputWord) &#123;<br>      <span class="hljs-keyword">return</span> regionPrefixTrieNodeHelper.matchRegionNameList(inputWord);<br>  &#125;<br><br>  /**<br>   * 模糊查询<br>   * @param request<br>   * @<span class="hljs-keyword">return</span><br>   */<br>  public <span class="hljs-type">List</span>&lt;RegionModel&gt; likeQueryRegionFullName(RegionLikeQueryDomainRequest request) &#123;<br>      RegionLikeListQueryRequest regionLikeListQueryRequest = new RegionLikeListQueryRequest();<br>      regionLikeListQueryRequest.setRegionFullName(request.getRegionFullName());<br>      <span class="hljs-keyword">return</span> regionRepository.likeQueryRegionModelList(regionLikeListQueryRequest);<br>  &#125;<br><br></code></pre></td></tr></table></figure><p>facade层实现：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@Override</span><br>   public ResultT&lt;<span class="hljs-type">List</span>&lt;String&gt;&gt; prefixMatchRegionNameByWord(String word) &#123;<br>       <span class="hljs-type">List</span>&lt;String&gt; regionFullNameList = regionDomainService.queryRegionFullNameByTrieTree(word);<br>       <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(regionFullNameList)) &#123;<br>           <span class="hljs-keyword">return</span> ResultT.success(regionFullNameList);<br>       &#125;<br><br>       RegionLikeQueryDomainRequest domainRequest = new RegionLikeQueryDomainRequest();<br>       domainRequest.setRegionFullName(word);<br>       <span class="hljs-type">List</span>&lt;RegionModel&gt; regionModelList = regionDomainService.likeQueryRegionFullName(domainRequest);<br>       <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(regionFullNameList)) &#123;<br>           <span class="hljs-keyword">return</span> ResultT.success();<br>       &#125;<br>       <span class="hljs-keyword">return</span> ResultT.success(regionModelList.stream().<span class="hljs-built_in">map</span>(RegionModel::getRegionFullName).collect(Collectors.toList()));<br>   &#125;<br></code></pre></td></tr></table></figure><p>我们启动项目，访问相关的controller，查询结果如下：</p><img src="/2024/10/27/TrieTree%E5%BA%94%E7%94%A8%E2%80%94%E5%8C%BA%E5%88%92%E6%9F%A5%E8%AF%A2/5.png" class=""><h3 id="返回体大小优化"><a href="#返回体大小优化" class="headerlink" title="返回体大小优化"></a>返回体大小优化</h3><p>但上述的方式存在一个问题，当我们输入的内容较少，比如只输入“广”时，那么前缀树会将所有的以广开头的地址，都返回，这会导致返回的数据体报文很大，因此，我们需要限制返回的数据体大小：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python">// Controller层<br><span class="hljs-meta">@GetMapping(<span class="hljs-params">value = <span class="hljs-string">&quot;/queryRegionListByWord&quot;</span></span>)</span><br>    public ResultT&lt;<span class="hljs-type">List</span>&lt;String&gt;&gt; queryRegionListByWord(@RequestParam(name = <span class="hljs-string">&quot;word&quot;</span>, required = true) String word,<br><span class="hljs-meta">                                                       @RequestParam(<span class="hljs-params">name = <span class="hljs-string">&quot;num&quot;</span>, required = false</span>) Integer num) &#123;</span><br>        <span class="hljs-keyword">if</span> (num == null) &#123;<br>            num = <span class="hljs-number">10</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> regionReadFacade.prefixMatchRegionNameByWord(word, num);<br>    &#125;<br><br>// Facade层<br><span class="hljs-meta"> @Override</span><br>    public ResultT&lt;<span class="hljs-type">List</span>&lt;String&gt;&gt; prefixMatchRegionNameByWord(String word, Integer num) &#123;<br>        <span class="hljs-type">List</span>&lt;String&gt; regionFullNameList = regionDomainService.queryRegionFullNameByTrieTree(word);<br>        <span class="hljs-built_in">int</span> size = regionFullNameList.size();<br>        <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(regionFullNameList)) &#123;<br>            <span class="hljs-keyword">return</span> ResultT.success(regionFullNameList.subList(<span class="hljs-number">0</span>, size &lt; num ? size : num));<br>        &#125;<br><br>        RegionLikeQueryDomainRequest domainRequest = new RegionLikeQueryDomainRequest();<br>        domainRequest.setRegionFullName(word);<br>        <span class="hljs-type">List</span>&lt;RegionModel&gt; regionModelList = regionDomainService.likeQueryRegionFullName(domainRequest);<br>        <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(regionFullNameList)) &#123;<br>            <span class="hljs-keyword">return</span> ResultT.success();<br>        &#125;<br>        size = regionFullNameList.size();<br>        <span class="hljs-keyword">return</span> ResultT.success(regionModelList.stream()<br>                .<span class="hljs-built_in">map</span>(RegionModel::getRegionFullName)<br>                .collect(Collectors.toList())<br>                .subList(<span class="hljs-number">0</span>, size &lt; num ? size : num));<br>    &#125;<br></code></pre></td></tr></table></figure><p>我们重新启动项目，访问结果如下，此时只会匹配出符合要求的前五个地址区划信息。</p><img src="/2024/10/27/TrieTree%E5%BA%94%E7%94%A8%E2%80%94%E5%8C%BA%E5%88%92%E6%9F%A5%E8%AF%A2/6.png" class=""><h3 id="按照热度排序"><a href="#按照热度排序" class="headerlink" title="按照热度排序"></a>按照热度排序</h3><p>对于这些地址区划信息，其实会存在一个热度问题，有些区划是经常被访问的，但我们之前定义的前缀树结构，并没有体现出这些区划信息的热度，因此需要进行改造，首先，我们修改TrieNode节点，将currentValue这个属性类型修改为泛形。后续我们会将热度作为currentValue的一部分进行存储。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@Data</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrieNode</span> &lt;T&gt; &#123;<br>    /**<br>     * 链接词，如广、东、汕、头<br>     */<br>    private Character ch;<br><br>    /**<br>     * 节点当前值，如广东汕、广东<br>     */<br>    private T currentValue;<br><br>    /**<br>     * 是否为叶子节点<br>     */<br>    private boolean isLeaf;<br><br>    /**<br>     * 是否为单词<br>     */<br>    private boolean isWord;<br><br>    /**<br>     * 节点层级<br>     */<br>    private <span class="hljs-built_in">int</span> level;<br><br>    public TrieNode() &#123;<br>        this.level = <span class="hljs-number">0</span>;<br>        this.isLeaf = false;<br>        this.isWord = false;<br>    &#125;<br><br>    public TrieNode(<span class="hljs-built_in">int</span> level) &#123;<br>        this.level = level;<br>        this.isLeaf = false;<br>        this.isWord = false;<br>    &#125;<br><br>    private Map&lt;Character, TrieNode&lt;T&gt;&gt; childNodeMap = new HashMap&lt;&gt;();<br><br>    public void put(Character ch, TrieNode child) &#123;<br>        childNodeMap.put(ch, child);<br>    &#125;<br><br>    public TrieNode get(Character ch) &#123;<br>        <span class="hljs-keyword">return</span> childNodeMap.get(ch);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后修改TrieTree，将构建TrieNode当前值的行为，抽象为方法，由子类实现：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@Data</span><br>public abstract <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrieTree</span>&lt;T&gt; implements Serializable &#123;<br>    private TrieNode&lt;T&gt; root = new TrieNode();<br><br>    /**<br>     * 新增单词到前缀树中<br>     * @param word<br>     */<br>    public void add(String word) &#123;<br>        add(root, word.toCharArray(), <span class="hljs-number">0</span>);<br>    &#125;<br>    public void add(TrieNode t, char[] chars, <span class="hljs-built_in">int</span> start) &#123;<br>        <span class="hljs-keyword">if</span> (start == chars.length) &#123;<br>            t.setWord(true);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = start; i &lt; chars.length; i++) &#123;<br>            char ch = chars[i];<br>            TrieNode child = t.get(ch);<br>            <span class="hljs-keyword">if</span> (child != null) &#123;<br>                add(child, chars, start + <span class="hljs-number">1</span>);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            child = new TrieNode(t.getLevel() + <span class="hljs-number">1</span>);<br>            child.setCh(ch);<br>            child.setCurrentValue(buildCurrentValue(t, ch));<br>            <span class="hljs-keyword">if</span> (i == chars.length - <span class="hljs-number">1</span>) &#123;<br>                child.setLeaf(true);<br>                child.setWord(true);<br>            &#125;<br>            t.put(ch, child);<br>            t = child;<br>        &#125;<br>    &#125;<br><br>    /**<br>    *抽象为方法，由子类自己实现节点当前值的构造<br>    **/<br>    public abstract &lt;T&gt; T buildCurrentValue(TrieNode t, char ch) ;<br><br>    /**<br>     * 匹配到该单词的第一个节点<br>     * @param word<br>     * @<span class="hljs-keyword">return</span><br>     */<br>    public TrieNode&lt;T&gt; rootOfMatchWord(String word) &#123;<br>        <span class="hljs-keyword">return</span> rootOfMatchWord(this.root, word.toCharArray(), <span class="hljs-number">0</span>);<br>    &#125;<br><br>    private TrieNode&lt;T&gt; rootOfMatchWord(TrieNode&lt;T&gt; root, char[] chars, <span class="hljs-built_in">int</span> start) &#123;<br>        <span class="hljs-keyword">if</span> (start == chars.length) &#123;<br>            <span class="hljs-keyword">return</span> root;<br>        &#125;<br>        char ch = chars[start];<br>        TrieNode&lt;T&gt; child = root.get(ch);<br>        <span class="hljs-keyword">if</span> (child == null) &#123;<br>            <span class="hljs-keyword">return</span> null;<br>        &#125;<br>        <span class="hljs-keyword">return</span> rootOfMatchWord(child, chars, start + <span class="hljs-number">1</span>);<br>    &#125;<br><br>    /**<br>     * 前缀和word匹配，并且属于word类型的节点<br>     * @param word<br>     * @<span class="hljs-keyword">return</span><br>     */<br>    public <span class="hljs-type">List</span>&lt;TrieNode&lt;T&gt;&gt; matchWord(String word) &#123;<br>        TrieNode&lt;T&gt; t = rootOfMatchWord(word);<br>        <span class="hljs-keyword">if</span> (t == null) &#123;<br>            <span class="hljs-keyword">return</span> new ArrayList&lt;&gt;();<br>        &#125;<br>        <span class="hljs-type">List</span>&lt;TrieNode&lt;T&gt;&gt; matchWordTrieNodeList = new ArrayList&lt;&gt;();<br>        Queue&lt;TrieNode&lt;T&gt;&gt; queue = new LinkedList&lt;&gt;();<br>        queue.add(t);<br>        <span class="hljs-keyword">while</span> (!queue.isEmpty()) &#123;<br>            TrieNode&lt;T&gt; head = queue.poll();<br>            <span class="hljs-keyword">if</span> (head.isWord()) &#123;<br>                matchWordTrieNodeList.add(head);<br>            &#125;<br>            <span class="hljs-keyword">for</span> (TrieNode&lt;T&gt; child : head.getChildNodeMap().values()) &#123;<br>                queue.add(child);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> matchWordTrieNodeList;<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public String toString() &#123;<br>        Queue&lt;TrieNode&lt;T&gt;&gt; queue = new LinkedList&lt;&gt;();<br>        queue.add(root);<br>        StringBuilder result = new StringBuilder();<br>        <span class="hljs-keyword">while</span> (!queue.isEmpty()) &#123;<br>            StringBuilder stringBuilder = new StringBuilder();<br>            <span class="hljs-built_in">int</span> size = queue.size();<br>            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++) &#123;<br>                TrieNode&lt;T&gt; t = queue.poll();<br>                stringBuilder.append(t.getCurrentValue()).append(<span class="hljs-string">&quot;(&quot;</span>).append(t.isWord()).append(<span class="hljs-string">&quot;) &quot;</span>);<br>                <span class="hljs-keyword">for</span> (TrieNode&lt;T&gt; child : t.getChildNodeMap().values()) &#123;<br>                    queue.add(child);<br>                &#125;<br>            &#125;<br>            result.append(stringBuilder.toString()).append(<span class="hljs-string">&quot;\n&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> result.toString();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>定义RegionTrieNodeValue，该类有两个属性：regionFullName——当前区划的全称，value——当前区划的热度值。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@Data</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">RegionTrieNodeValue</span> implements Serializable &#123;<br>    private String regionFullName;<br><br>    private AtomicInteger value = new AtomicInteger(<span class="hljs-number">0</span>);<br><br>    public void increment() &#123;<br>        this.value.incrementAndGet();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>定义RegionTrieTree，继承自TrieTree，作为区划业务的前缀树</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python">public <span class="hljs-keyword">class</span> <span class="hljs-title class_">RegionTrieTree</span> extends TrieTree&lt;RegionTrieNodeValue&gt; &#123;<br><span class="hljs-meta">    @Override</span><br>    public  RegionTrieNodeValue buildCurrentValue(TrieNode t, char ch) &#123;<br>        RegionTrieNodeValue rootCurrentValue = (RegionTrieNodeValue) t.getCurrentValue();<br>        <span class="hljs-keyword">if</span> (rootCurrentValue == null) &#123;<br>            RegionTrieNodeValue trieNodeValue = new RegionTrieNodeValue();<br>            trieNodeValue.setRegionFullName(<span class="hljs-string">&quot;&quot;</span> + ch);<br>            <span class="hljs-keyword">return</span> trieNodeValue;<br>        &#125;<br>        RegionTrieNodeValue currentValue = new RegionTrieNodeValue();<br>        String regionFullName = rootCurrentValue.getRegionFullName() == null ?<br>                <span class="hljs-string">&quot;&quot;</span> + ch : rootCurrentValue.getRegionFullName() + ch;<br>        currentValue.setRegionFullName(regionFullName);<br>        <span class="hljs-keyword">return</span> currentValue;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>最后，修改RegionPrefixTrieNodeHelper，添加递增热度的方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@Component</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">RegionPrefixTrieNodeHelper</span> &#123;<br>    private RegionTrieTree regionTrieTree = new RegionTrieTree();<br><br><span class="hljs-meta">    @Autowired</span><br>    private RegionRepository regionRepository;<br><br>    public <span class="hljs-type">List</span>&lt;String&gt; matchRegionNameList(String word) &#123;<br>        <span class="hljs-type">List</span>&lt;TrieNode&lt;RegionTrieNodeValue&gt;&gt; trieNodes = regionTrieTree.matchWord(word);<br>        <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(trieNodes)) &#123;<br>            <span class="hljs-keyword">return</span> new ArrayList&lt;&gt;();<br>        &#125;<br>        // 按照权重排序<br>        <span class="hljs-type">List</span>&lt;RegionTrieNodeValue&gt; regionTrieNodeValueList = trieNodes.stream().<span class="hljs-built_in">map</span>(TrieNode::getCurrentValue)<br>                .<span class="hljs-built_in">sorted</span>((node1, node2) -&gt; node2.getValue().get() - node1.getValue().get())<br>                .collect(Collectors.toList());<br>        <span class="hljs-keyword">return</span> regionTrieNodeValueList.stream().<span class="hljs-built_in">map</span>(RegionTrieNodeValue::getRegionFullName)<br>                .collect(Collectors.toList());<br>    &#125;<br><br>    /**<br>     * 增加权重<br>     * @param word<br>     */<br>    public void incrementTrieNode(String word) &#123;<br>        TrieNode&lt;RegionTrieNodeValue&gt; trieNode = regionTrieTree.rootOfMatchWord(word);<br>        trieNode.getCurrentValue().increment();<br>    &#125;<br><br><span class="hljs-meta">    @PostConstruct</span><br>    public void init() &#123;<br>        <span class="hljs-type">List</span>&lt;RegionModel&gt; regionModelList = regionRepository.queryAll();<br>        <span class="hljs-keyword">for</span> (RegionModel regionModel : regionModelList) &#123;<br>            regionTrieTree.add(regionModel.getRegionFullName());<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后我们还需要暴露一个增加热度的方法，当用户选择了某一个区划后，调用该方法来增加对应区划的热度。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python">// controller层<br><span class="hljs-meta">@PostMapping(<span class="hljs-params">value = <span class="hljs-string">&quot;/chooseRegion&quot;</span></span>)</span><br>    public ResultT&lt;Boolean&gt; chooseRegion(@RequestParam(name = <span class="hljs-string">&quot;word&quot;</span>) String word) &#123;<br>        <span class="hljs-keyword">return</span> regionReadFacade.chooseRegion(word);<br>    &#125;<br><br>//facade层<br><span class="hljs-meta"> @Override</span><br>    public ResultT&lt;Boolean&gt; chooseRegion(String regionFullName) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            regionPrefixTrieNodeHelper.incrementTrieNode(regionFullName);<br>        &#125; catch (Exception e) &#123;<br>            PlatformLogger.build()<br>                    .addBizCode(<span class="hljs-string">&quot;chooseRegion&quot;</span>)<br>                    .addParam(<span class="hljs-string">&quot;regionFullName&quot;</span>, regionFullName)<br>                    .addThrowable(e)<br>                    .printErrorLog();<br>        &#125;<br>        <span class="hljs-keyword">return</span> ResultT.success(true);<br>    &#125;<br></code></pre></td></tr></table></figure><p>启动项目，首先查询区划列表，“广东”查询条件返回的前五个区划查询结果如下所示：</p><img src="/2024/10/27/TrieTree%E5%BA%94%E7%94%A8%E2%80%94%E5%8C%BA%E5%88%92%E6%9F%A5%E8%AF%A2/7.png" class=""><p>然后，我们访问chooseRegion方法，模拟用户选择某一个区划的行为：</p><img src="/2024/10/27/TrieTree%E5%BA%94%E7%94%A8%E2%80%94%E5%8C%BA%E5%88%92%E6%9F%A5%E8%AF%A2/8.png" class=""><p>再次查询”广东“，结果如下：</p><img src="/2024/10/27/TrieTree%E5%BA%94%E7%94%A8%E2%80%94%E5%8C%BA%E5%88%92%E6%9F%A5%E8%AF%A2/9.png" class="">]]></content>
    
    
    
    <tags>
      
      <tag>工作积累</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>流程引擎实现（二）—排他网关</title>
    <link href="/2024/10/05/%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E6%8E%92%E4%BB%96%E7%BD%91%E5%85%B3/"/>
    <url>/2024/10/05/%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E6%8E%92%E4%BB%96%E7%BD%91%E5%85%B3/</url>
    
    <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>在流程图中，时常会涉及到分支的判断，进入判断逻辑后，我们一般只会从分支的一个出口出来，然后往下继续执行，这在流程引擎中，称之为排他网关（Exclusive Gateway)，排他网关用于在流程执行过程中做出决策，基于流程中的条件来选择一个唯一的路径继续执行。</p><p>下面我们以登录为例，在登录流程中，会依次执行下列流程：</p><ul><li>账号定位：根据入参定位账号信息</li><li>密码检查：根据获取的账号信息，以及输入的密码，比对密码信息是否正确</li><li>状态检查：检查用户状态，判断是否被盗、冻结等</li><li>登录核身判断：<ol><li>状态检查通过，颁发登录token</li><li>状态检查不通过，设置核身相关信息，如核身类型等</li></ol></li><li>创建token：状态检查通过，则下发登录态token，若不通过，下发核身token</li></ul><p>具体的流程图如下所示：</p><img src="/2024/10/05/%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E6%8E%92%E4%BB%96%E7%BD%91%E5%85%B3/1.png" class=""><h3 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h3><h4 id="原先的执行方式"><a href="#原先的执行方式" class="headerlink" title="原先的执行方式"></a>原先的执行方式</h4><ul><li>根据流程id，解析流程配置文件，获取ActivitiFlow</li><li>遍历ActivitiFlow的所有节点，依次执行节点活动</li></ul><img src="/2024/10/05/%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E6%8E%92%E4%BB%96%E7%BD%91%E5%85%B3/2.png" class=""><h4 id="修改后的执行方式"><a href="#修改后的执行方式" class="headerlink" title="修改后的执行方式"></a>修改后的执行方式</h4><ul><li>根据流程id，解析流程配置文件，获取ActivitiFlow</li><li>执行流程节点活动<ul><li>对于ServiceTask，转为IServiceTask执行execute方法</li><li>对于排他网关，转为IExeclusiveGateway执行parseCredential方法</li></ul></li><li>节点执行完毕后，根据sequenceFlow连线信息，获取下一个节点（对于网关，会加上凭证credential的判断，来决策下一个节点）</li></ul><img src="/2024/10/05/%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E6%8E%92%E4%BB%96%E7%BD%91%E5%85%B3/3.png" class=""><h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p>首先，我们根据上述流程图，定义流程文件内容如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> standalone=<span class="hljs-string">&quot;yes&quot;</span>?&gt;<br>&lt;activiti <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;register_flow&quot;</span>&gt;<br>    &lt;!--节点定义--&gt;<br>    &lt;startEvent <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;startEvent&quot;</span>/&gt;<br>    &lt;serviceTask <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;userLocate&quot;</span> name=<span class="hljs-string">&quot;userLocate&quot;</span> description=<span class="hljs-string">&quot;账号定位&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.business.activiti.login.UserLocateActivity&quot;</span>/&gt;<br>    &lt;serviceTask <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;passwordCheck&quot;</span> name=<span class="hljs-string">&quot;passwordCheck&quot;</span> description=<span class="hljs-string">&quot;密码检查&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.business.activiti.login.PasswordCheckActivity&quot;</span>/&gt;<br>    &lt;serviceTask <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;userAccountStatusCheck&quot;</span> name=<span class="hljs-string">&quot;userAccountStatusCheck&quot;</span> description=<span class="hljs-string">&quot;账号状态检查&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.business.activiti.login.UserAccountStatusCheckActivity&quot;</span>/&gt;<br>    &lt;exclusiveGateway <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;needBuildIdentityAction&quot;</span> name=<span class="hljs-string">&quot;needBuildIdentityAction&quot;</span> description=<span class="hljs-string">&quot;是否需要转核身&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.business.activiti.login.NeedTransfer2IdentityExclusiveGateway&quot;</span>/&gt;<br>    &lt;serviceTask <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;buildIdentityAction&quot;</span> name=<span class="hljs-string">&quot;buildIdentityAction&quot;</span> description=<span class="hljs-string">&quot;核身行为构建&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.business.activiti.login.BuildIdentityActionActivity&quot;</span>/&gt;<br>    &lt;serviceTask <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;buildUserToken&quot;</span> name=<span class="hljs-string">&quot;buildUserToken&quot;</span> description=<span class="hljs-string">&quot;创建用户token&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.business.activiti.common.BuildUserTokenActivity&quot;</span>/&gt;<br>    &lt;endEvent <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;endEvent&quot;</span>/&gt;<br><br>    &lt;!--节点执行顺序编排--&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;startEvent&quot;</span> target=<span class="hljs-string">&quot;userLocate&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;userLocate&quot;</span> target=<span class="hljs-string">&quot;passwordCheck&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;passwordCheck&quot;</span> target=<span class="hljs-string">&quot;userAccountStatusCheck&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;userAccountStatusCheck&quot;</span> target=<span class="hljs-string">&quot;needBuildIdentityAction&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;needBuildIdentityAction&quot;</span> target=<span class="hljs-string">&quot;buildIdentityAction&quot;</span> credential=<span class="hljs-string">&quot;identity&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;needBuildIdentityAction&quot;</span> target=<span class="hljs-string">&quot;buildUserToken&quot;</span> credential=<span class="hljs-string">&quot;login&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;buildIdentityAction&quot;</span> target=<span class="hljs-string">&quot;buildUserToken&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;buildUserToken&quot;</span> target=<span class="hljs-string">&quot;endEvent&quot;</span>/&gt;<br>&lt;/activiti&gt;<br></code></pre></td></tr></table></figure><p>对于节点与节点之间的联系，是通过sequenceFlow来实现的，而目前我们的sequenceFlow只有source和target这两个信息，前者表示来源，后者表示去处，此时的sequenceFlow是没有阻塞条件的，当出现一个source有多个target时，我们可以在sequenceFlow加上阻塞条件，用于根据上下文信息，决策需要走哪一条路径。修改后的sequenceFlow如下，我们新增一个crendential字段，用于表示当上下文中凭证信息为相关值时，才可以走这条连线。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python">package com.yang.core.infrastructure.flow.activiti.model;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Data</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">SequenceFlowNode</span> implements Serializable &#123;<br><br>    private String source;<br><br>    private String target;<br><br>    private String credential;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>在上一节中，我们定义的activitiFlow流程模型结构如下，此时的activitiFlow对sequenceFlow不感知，因为之前涉及的时候，不存在一个来源对应多个去处的连线，所以获取节点顺序，依次执行即可。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python">package com.yang.core.infrastructure.flow.activiti.model;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.<span class="hljs-type">List</span>;<br><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivitiFlow</span> &#123;<br>    private String <span class="hljs-built_in">id</span>;<br><br>    private <span class="hljs-type">List</span>&lt;FlowNode&gt; flowNodeList = new ArrayList&lt;&gt;();<br><br>    public void addFlowNode(FlowNode flowNode) &#123;<br>        this.flowNodeList.add(flowNode);<br>    &#125;<br><br>    public <span class="hljs-type">List</span>&lt;FlowNode&gt; getFlowNodeList() &#123;<br>        <span class="hljs-keyword">return</span> this.flowNodeList;<br>    &#125;<br><br>    public String getId() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">id</span>;<br>    &#125;<br><br>    public void setId(String <span class="hljs-built_in">id</span>) &#123;<br>        this.<span class="hljs-built_in">id</span> = <span class="hljs-built_in">id</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>当前模型显然无法支持我们的排他网关，因为排他网关的入口是一个，但是出口可以是多个的，而List结构，只能支持一对一的顺序串联，所以我们对ActivitiFlow模型进行改造，使其能支持我们的一对多逻辑，同时，对模型进行充血，将一些决策逻辑收敛到模型中。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python">package com.yang.core.infrastructure.flow.activiti.model;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><br><span class="hljs-keyword">import</span> java.util.<span class="hljs-type">List</span>;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Data</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivitiFlow</span> &#123;<br>    private String <span class="hljs-built_in">id</span>;<br><br>    private FlowNode startNode;<br><br>    private FlowNode endNode;<br><br>    private <span class="hljs-type">List</span>&lt;SequenceFlowNode&gt; sequenceFlowNodeList;<br><br>    private Map&lt;String, FlowNode&gt; nodeId2FlowNodeMap;<br><br>    public FlowNode chooseNextNode(FlowNode curNode, String credential) &#123;<br>        String sourceNodeId = curNode.getId();<br>        String targetNodeId = null;<br>        <span class="hljs-keyword">for</span> (SequenceFlowNode sequenceFlowNode : sequenceFlowNodeList) &#123;<br>            <span class="hljs-keyword">if</span> (!sequenceFlowNode.getSource().equals(sourceNodeId)) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (StringUtils.isEmpty(sequenceFlowNode.getCredential())) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (sequenceFlowNode.getCredential().equals(credential)) &#123;<br>                targetNodeId = sequenceFlowNode.getTarget();<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> nodeId2FlowNodeMap.get(targetNodeId);<br>    &#125;<br><br>    public FlowNode getNextNode(FlowNode curNode) &#123;<br>        String sourceNodeId = curNode.getId();<br>        String targetNodeId = null;<br>        <span class="hljs-keyword">for</span> (SequenceFlowNode sequenceFlowNode : sequenceFlowNodeList) &#123;<br>            <span class="hljs-keyword">if</span> (sequenceFlowNode.getSource().equals(sourceNodeId)) &#123;<br>                targetNodeId = sequenceFlowNode.getTarget();<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> nodeId2FlowNodeMap.get(targetNodeId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>因为ActivitiFlow的模型结构有所变更，因此，我们需要修改对应的解析器，以适应当前结构。首先修改XmlActivitiFileParser的parseSequenceFlowNode方法，增加对credential字段的解析：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python">/**<br>    * 解析流程执行顺序节点<br>    * @param attributes<br>    * @<span class="hljs-keyword">return</span><br>    */<br>   private SequenceFlowNode parseSequenceFlowNode(NamedNodeMap attributes) &#123;<br>       Node sourceNode = attributes.getNamedItem(<span class="hljs-string">&quot;source&quot;</span>);<br>       Node targetNode = attributes.getNamedItem(<span class="hljs-string">&quot;target&quot;</span>);<br>       <span class="hljs-keyword">if</span> (sourceNode != null &amp;&amp; targetNode != null) &#123;<br>           SequenceFlowNode sequenceFlowNode = new SequenceFlowNode();<br>           sequenceFlowNode.setSource(sourceNode.getNodeValue());<br>           sequenceFlowNode.setTarget(targetNode.getNodeValue());<br><br>           Node credentialNode = attributes.getNamedItem(<span class="hljs-string">&quot;credential&quot;</span>);<br>           <span class="hljs-keyword">if</span> (credentialNode != null) &#123;<br>               sequenceFlowNode.setCredential(credentialNode.getNodeValue());<br>           &#125;<br>           <span class="hljs-keyword">return</span> sequenceFlowNode;<br>       &#125;<br>       <span class="hljs-keyword">return</span> null;<br>   &#125;<br></code></pre></td></tr></table></figure><p>其次，修改AbstractActivitiParser，使其能正确解析ActivitiFlow</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><code class="hljs python">package com.yang.core.infrastructure.flow.activiti.parser;<br><br><br><span class="hljs-keyword">import</span> com.yang.api.common.ErrorCode;<br><span class="hljs-keyword">import</span> com.yang.api.common.exception.UicException;<br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.flow.activiti.enums.FlowNodeType;<br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.flow.activiti.model.ActivitiFlow;<br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.flow.activiti.model.FlowNode;<br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.flow.activiti.model.SequenceFlowNode;<br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.utils.SpringContextUtil;<br><br><span class="hljs-keyword">import</span> java.util.*;<br><span class="hljs-keyword">import</span> java.util.function.Function;<br><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br><br>public abstract <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractActivitiFileParser</span> implements IActivitiFileParser&#123;<br><br>    /**<br>     * 填充流程节点内容<br>     * @param flowNode<br>     * @param flowNodeType<br>     */<br>    protected void richFlowNode(FlowNode flowNode, FlowNodeType flowNodeType) &#123;<br>        <span class="hljs-keyword">if</span> (flowNodeType != FlowNodeType.SERVICE_TASK &amp;&amp; flowNodeType != FlowNodeType.EXCLUSIVE_GATEWAY) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            // 填充target对象<br>            Class&lt;?&gt; aClass = Class.forName(flowNode.getClassPath());<br>            Object target = SpringContextUtil.getBeanByType(aClass);<br>            flowNode.setTarget(target);<br>        &#125; catch (ClassNotFoundException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    /**<br>     * 根据连线顺序，对流程节点进行排序，构建相应的流程flow<br>     * @param fileName<br>     * @param flowNodeList<br>     * @param sequenceFlowNodeList<br>     * @<span class="hljs-keyword">return</span><br>     */<br>    protected ActivitiFlow buildActivitiFlow(String fileName,<br>                                             <span class="hljs-type">List</span>&lt;FlowNode&gt; flowNodeList,<br>                                             <span class="hljs-type">List</span>&lt;SequenceFlowNode&gt; sequenceFlowNodeList) &#123;<br>        String startNodeId = getStartNodeId(sequenceFlowNodeList);<br>        String endNodeId = getEndNodeId(sequenceFlowNodeList);<br>        Map&lt;String, FlowNode&gt; nodeId2FlowNodeMap = flowNodeList.stream()<br>                .collect(Collectors.toMap(FlowNode::getId, Function.identity()));<br><br>        ActivitiFlow activitiFlow = new ActivitiFlow();<br>        activitiFlow.setId(fileName);<br>        activitiFlow.setStartNode(nodeId2FlowNodeMap.get(startNodeId));<br>        activitiFlow.setEndNode(nodeId2FlowNodeMap.get(endNodeId));<br>        activitiFlow.setNodeId2FlowNodeMap(nodeId2FlowNodeMap);<br>        activitiFlow.setSequenceFlowNodeList(sequenceFlowNodeList);<br>        <span class="hljs-keyword">return</span> activitiFlow;<br>    &#125;<br><br>    /**<br>     * 获取结束节点<span class="hljs-built_in">id</span><br>     * @param sequenceFlowNodeList<br>     * @<span class="hljs-keyword">return</span><br>     */<br>    private String getEndNodeId(<span class="hljs-type">List</span>&lt;SequenceFlowNode&gt; sequenceFlowNodeList) &#123;<br>        <span class="hljs-type">List</span>&lt;String&gt; oneNodeIds = filterCountOneNodeId(sequenceFlowNodeList);<br>        <span class="hljs-type">Set</span>&lt;String&gt; oneNodeIdSet = new HashSet&lt;&gt;(oneNodeIds);<br>        String endNodeId = null;<br>        <span class="hljs-keyword">for</span> (SequenceFlowNode sequenceFlowNode : sequenceFlowNodeList) &#123;<br>            String target = sequenceFlowNode.getTarget();<br>            <span class="hljs-keyword">if</span> (oneNodeIdSet.contains(target)) &#123;<br>                endNodeId = target;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> endNodeId;<br>    &#125;<br><br>    /**<br>     * 获取开始节点<span class="hljs-built_in">id</span><br>     * @param sequenceFlowNodeList<br>     * @<span class="hljs-keyword">return</span><br>     */<br>    private String getStartNodeId(<span class="hljs-type">List</span>&lt;SequenceFlowNode&gt; sequenceFlowNodeList) &#123;<br>        <span class="hljs-type">List</span>&lt;String&gt; oneNodeIds = filterCountOneNodeId(sequenceFlowNodeList);<br>        <span class="hljs-type">Set</span>&lt;String&gt; oneNodeIdSet = new HashSet&lt;&gt;(oneNodeIds);<br>        String startNodeId = null;<br>        <span class="hljs-keyword">for</span> (SequenceFlowNode sequenceFlowNode : sequenceFlowNodeList) &#123;<br>            String source = sequenceFlowNode.getSource();<br>            <span class="hljs-keyword">if</span> (oneNodeIdSet.contains(source)) &#123;<br>                startNodeId = source;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> startNodeId;<br>    &#125;<br><br><br>    /**<br>     * 过滤计数次数只有<span class="hljs-number">1</span>次的nodeId，只有startEvent和endEvent会计数<span class="hljs-number">1</span>次，其他都是两次，如果是网关，那么次数会更多<br>     * @param sequenceFlowNodeList<br>     * @<span class="hljs-keyword">return</span><br>     */<br>    private <span class="hljs-type">List</span>&lt;String&gt; filterCountOneNodeId(<span class="hljs-type">List</span>&lt;SequenceFlowNode&gt; sequenceFlowNodeList) &#123;<br>        Map&lt;String, Integer&gt; countNodeIdMap = new HashMap&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (SequenceFlowNode sequenceFlowNode : sequenceFlowNodeList) &#123;<br>            Integer sourceCount = countNodeIdMap.getOrDefault(sequenceFlowNode.getSource(), <span class="hljs-number">0</span>);<br>            countNodeIdMap.put(sequenceFlowNode.getSource(), sourceCount + <span class="hljs-number">1</span>);<br><br>            Integer targetCount = countNodeIdMap.getOrDefault(sequenceFlowNode.getTarget(), <span class="hljs-number">0</span>);<br>            countNodeIdMap.put(sequenceFlowNode.getTarget(), targetCount + <span class="hljs-number">1</span>);<br>        &#125;<br>        <span class="hljs-type">List</span>&lt;String&gt; countOneNodeIds = new ArrayList&lt;&gt;();<br>        countNodeIdMap.forEach((nodeId, count) -&gt; &#123;<br>            <span class="hljs-keyword">if</span> (count == <span class="hljs-number">1</span>) &#123;<br>                countOneNodeIds.add(nodeId);<br>            &#125;<br>        &#125;);<br>        <span class="hljs-keyword">if</span> (countOneNodeIds.size() &gt; <span class="hljs-number">2</span>) &#123;<br>            throw new UicException(ErrorCode.ACTIVITI_PARSER_ERROR);<br>        &#125;<br>        <span class="hljs-keyword">return</span> countOneNodeIds;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>最后，修改ActivitiManager类，对排他网关做定制处理，根据网关返回的凭证值，决策出下一个节点是哪一个。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs python">package com.yang.core.infrastructure.flow.activiti;<br><br><br><span class="hljs-keyword">import</span> com.yang.api.common.ErrorCode;<br><span class="hljs-keyword">import</span> com.yang.api.common.exception.UicException;<br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.flow.activiti.enums.FlowNodeType;<br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.flow.activiti.function.IExclusiveGateway;<br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.flow.activiti.function.IServiceTask;<br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.flow.activiti.model.ActivitiFlow;<br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.flow.activiti.model.FlowNode;<br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.flow.activiti.parser.IActivitiFileParser;<br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.flow.activiti.request.ActivitiEngineRequest;<br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.flow.activiti.response.ActivitiEngineResponse;<br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.utils.SpringContextUtil;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivitiFlowManager</span> &#123;<br>    private static Map&lt;String, ActivitiFlow&gt; id2ActivitiFlowCache = new HashMap&lt;&gt;();<br><br>    public static ActivitiFlow getActivitiFlow(String flowName) &#123;<br>        ActivitiFlow activitiFlow = id2ActivitiFlowCache.get(flowName);<br>        <span class="hljs-keyword">if</span> (activitiFlow != null) &#123;<br>            <span class="hljs-keyword">return</span> activitiFlow;<br>        &#125;<br>        IActivitiFileParser iActivitiFileParser = SpringContextUtil.getBeanByType(IActivitiFileParser.<span class="hljs-keyword">class</span>);<br>        synchronized (flowName.intern()) &#123;<br>            activitiFlow = id2ActivitiFlowCache.get(flowName);<br>            <span class="hljs-keyword">if</span> (activitiFlow != null) &#123;<br>                <span class="hljs-keyword">return</span> activitiFlow;<br>            &#125;<br>            activitiFlow = iActivitiFileParser.parseActivitiFlow(flowName);<br>            <span class="hljs-keyword">if</span> (activitiFlow == null) &#123;<br>                throw new UicException(ErrorCode.ACTIVITI_NOT_FOUND_ERROR);<br>            &#125;<br>            id2ActivitiFlowCache.put(flowName, activitiFlow);<br>        &#125;<br>        <span class="hljs-keyword">return</span> activitiFlow;<br>    &#125;<br><br>    /**<br>     * 流程引擎执行方法<br>     * @param flowName<br>     * @param activitiEngineRequest<br>     * @<span class="hljs-keyword">return</span><br>     * @param &lt;Request&gt;<br>     * @param &lt;Response&gt;<br>     */<br>    public static &lt;Request, Response&gt; ActivitiEngineResponse&lt;Response&gt; startEngine(String flowName,<br>                                                                                   ActivitiEngineRequest&lt;Request&gt; activitiEngineRequest) &#123;<br>        ActivitiFlow activitiFlow = getActivitiFlow(flowName);<br>        ActivitiEngineResponse&lt;Response&gt; activitiEngineResponse = new ActivitiEngineResponse&lt;&gt;();<br>        FlowNode curNode = activitiFlow.getStartNode();<br>        <span class="hljs-keyword">while</span> (curNode != null) &#123;<br>            FlowNodeType flowNodeType = curNode.getFlowNodeType();<br>            FlowNode nextFlow = null;<br>            switch (flowNodeType) &#123;<br>                <span class="hljs-keyword">case</span> START_EVENT:<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> END_EVENT:<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> SERVICE_TASK:<br>                    executeServiceTask(activitiEngineRequest, activitiEngineResponse, curNode);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> EXCLUSIVE_GATEWAY:<br>                    nextFlow = executeExclusiveGateway(activitiEngineRequest, activitiEngineResponse, curNode, activitiFlow);<br>                    <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (nextFlow != null) &#123;<br>                curNode = nextFlow;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                curNode = activitiFlow.getNextNode(curNode);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> activitiEngineResponse;<br>    &#125;<br><br>    private static &lt;Request, Response&gt; FlowNode executeExclusiveGateway(ActivitiEngineRequest&lt;Request&gt; activitiEngineRequest,<br>                                                                    ActivitiEngineResponse&lt;Response&gt; activitiEngineResponse,<br>                                                                    FlowNode curNode,<br>                                                                    ActivitiFlow activitiFlow) &#123;<br>        IExclusiveGateway iExclusiveGateway = (IExclusiveGateway) curNode.getTarget();<br>        String credential = iExclusiveGateway.chooseNextNode(activitiEngineRequest, activitiEngineResponse);<br>        <span class="hljs-keyword">return</span> activitiFlow.chooseNextNode(curNode, credential);<br>    &#125;<br><br>    private static &lt;Request, Response&gt; void executeServiceTask(ActivitiEngineRequest&lt;Request&gt; activitiEngineRequest,<br>                                                               ActivitiEngineResponse&lt;Response&gt; activitiEngineResponse, FlowNode flowNode) &#123;<br>        IServiceTask iServiceTask = (IServiceTask) flowNode.getTarget();<br>        iServiceTask.execute(activitiEngineRequest, activitiEngineResponse);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>这里的IExclusiveGateway类定义如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python">package com.yang.core.infrastructure.flow.activiti.function;<br><br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.flow.activiti.request.ActivitiEngineRequest;<br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.flow.activiti.response.ActivitiEngineResponse;<br><br>public interface IExclusiveGateway extends IActivitiService &#123;<br>    public static final String CREDENTIAL = <span class="hljs-string">&quot;credential&quot;</span>;<br><br>    default void execute(ActivitiEngineRequest request, ActivitiEngineResponse response) &#123;<br>        String credential = chooseNextNode(request, response);<br>        request.getContext().put(CREDENTIAL, credential);<br>    &#125;<br><br>    String chooseNextNode(ActivitiEngineRequest request, ActivitiEngineResponse response);<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>其具体实现示例如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python">package com.yang.business.activiti.login;<br><br><span class="hljs-keyword">import</span> com.yang.api.common.ErrorCode;<br><span class="hljs-keyword">import</span> com.yang.api.common.exception.UicException;<br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.flow.activiti.function.IExclusiveGateway;<br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.flow.activiti.request.ActivitiEngineRequest;<br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.flow.activiti.response.ActivitiEngineResponse;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">NeedTransfer2IdentityExclusiveGateway</span> implements IExclusiveGateway &#123;<br><span class="hljs-meta">    @Override</span><br>    public String chooseNextNode(ActivitiEngineRequest request, ActivitiEngineResponse response) &#123;<br>        Object needIdentityObj = response.getContext().get(<span class="hljs-string">&quot;needIdentity&quot;</span>);<br>        <span class="hljs-keyword">if</span> (needIdentityObj != null) &#123;<br>            boolean needIdentity = (Boolean) needIdentityObj;<br>            <span class="hljs-keyword">if</span> (needIdentity) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;identity&quot;</span>;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;login&quot;</span>;<br>        &#125;<br>        throw new UicException(ErrorCode.ACTIVITI_EXECUTE_ERROR);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>这里准备两个账号，一个普通账号，一个被盗账号，被盗账号会进入登录转核身节点，在该节点中，会打印控制台信息——“登录转核身&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;”，依次登录普通账号和被盗账号，结果如下：</p><img src="/2024/10/05/%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E6%8E%92%E4%BB%96%E7%BD%91%E5%85%B3/4.png" class=""><img src="/2024/10/05/%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E6%8E%92%E4%BB%96%E7%BD%91%E5%85%B3/5.png" class=""><h3 id="规则引擎决策"><a href="#规则引擎决策" class="headerlink" title="规则引擎决策"></a>规则引擎决策</h3><p>上述实现方式，有一个问题在于，我们的判断条件是一个隐式的判断条件，即sequenceFlow线条上指定的credential值和IExclusiveGateway网关产出的值相同时，可以进入该sequenceFlow线条指引的分支连线。这其实就是一个等于的判断，但是这种判断方式不够灵活，如果我们后续的需求是某个值大于、小于或不等于时，才能进行分支，那么显然现在这种方式是不能满足的，因此，我们需要引入规则引擎，通过执行规则引擎的方式，来进行决策。</p><p>整体的思路如下：</p><ul><li>网关节点，根据业务流程需要进行判断，并设置流程上下文值</li><li>网关节点执行完毕后，根据sequenceFlow条件，和流程上下文信息，调用规则引擎，判断是否符合条件，符合条件则走到sequenceFlow对应分支</li></ul><h4 id="流程上下文参数简化"><a href="#流程上下文参数简化" class="headerlink" title="流程上下文参数简化"></a>流程上下文参数简化</h4><p>之前定义的ActivitiRequest和ActivitiResponse类的内容如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-meta">@Data</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivitiEngineRequest</span> &lt;T&gt; implements Serializable &#123;<br><br>    /**<br>     * 场景code<br>     */<br>    private String scenarioCode;<br><br>    private T baseRequest;<br><br>    private Map&lt;String, Object&gt; context = new HashMap&lt;&gt;();<br>&#125;<br><br><br><br><span class="hljs-meta">@Data</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivitiEngineResponse</span> &lt;T&gt; implements Serializable &#123;<br>    /**<br>     * 场景code<br>     */<br>    private String scenarioCode;<br><br>    private T response;<br><br>    private Map&lt;String, Object&gt; context = new HashMap&lt;&gt;();<br>&#125;<br><br></code></pre></td></tr></table></figure><p>这两个类的字段有些重复，包括场景code和流程上下文context字段，特别是流程上下文字段，当我们需要塞值到上下文中时，有时候不好判断要放request的上下文还是response的上下文，其实感觉这里放request和放response都可以，为了减少歧义，这里将这两个类进行聚合，收敛到一个类中，即ActivitiExecuteContext类，其内容如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python">package com.yang.core.infrastructure.flow.activiti.context;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Data</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivitiExecuteContext</span>&lt;Request, Response&gt; implements Serializable &#123;<br>    /**<br>     * 场景code<br>     */<br>    private String scenarioCode;<br><br>    private Request baseRequest;<br>    <br>    private Response baseResponse;<br><br>    private Map&lt;String, Object&gt; context = new HashMap&lt;&gt;();<br>&#125;<br><br></code></pre></td></tr></table></figure><p>通过ActivitiExecuteContext来替换原先的ActivitiEngineRequest和ActivitiEngineResponse, 所以要修改之前用到过那两个类的接口和实现：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs python">package com.yang.core.infrastructure.flow.activiti.function;<br><br><br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.flow.activiti.context.ActivitiExecuteContext;<br><br>public interface IActivitiService &#123;<br>    void execute(ActivitiExecuteContext activitiExecuteContext);<br>&#125;<br><br><br>package com.yang.core.infrastructure.flow.activiti.function;<br><br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.flow.activiti.context.ActivitiExecuteContext;<br><br>public interface IExclusiveGateway extends IActivitiService &#123;<br>    default void execute(ActivitiExecuteContext activitiExecuteContext) &#123;<br>        parseCredential(activitiExecuteContext);<br>    &#125;<br><br>    void parseCredential(ActivitiExecuteContext activitiExecuteContext);<br><br>&#125;<br><br><br>package com.yang.core.infrastructure.flow.activiti.function;<br><br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.flow.activiti.context.ActivitiExecuteContext;<br>public interface IServiceTask&lt;DomainRequest, DomainResponse&gt; extends IActivitiService &#123;<br>    default void execute(ActivitiExecuteContext activitiExecuteContext) &#123;<br>        DomainRequest domainRequest = buildDomainRequest(activitiExecuteContext);<br>        <span class="hljs-keyword">if</span> (domainRequest != null) &#123;<br>            DomainResponse domainResponse = apply(domainRequest);<br>            attachment(domainResponse, activitiExecuteContext);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        doElse(activitiExecuteContext);<br>    &#125;<br><br>    /**<br>     * 默认不实现，一般先转为domain Request，然后调用领域层方法，进行转化，doElse适用于目前领域层无法支持相关实现，顾需要在activity层进行适配的逻辑<br>     */<br>    default void doElse(ActivitiExecuteContext activitiExecuteContext) &#123;&#125;<br><br>    /**<br>     * 入参转化<br>     * @param activitiExecuteContext<br>     * @<span class="hljs-keyword">return</span><br>     */<br>    DomainRequest buildDomainRequest(ActivitiExecuteContext activitiExecuteContext);<br><br>    /**<br>     * 领域服务调用<br>     * @param domainRequest<br>     * @<span class="hljs-keyword">return</span><br>     */<br>    DomainResponse apply(DomainRequest domainRequest);<br><br>    /**<br>     * 领域服务调用结果填充<br>     * @param domainResponse<br>     * @param activitiExecuteContext<br>     */<br>    void attachment(DomainResponse domainResponse, ActivitiExecuteContext activitiExecuteContext);<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="引入规则引擎"><a href="#引入规则引擎" class="headerlink" title="引入规则引擎"></a>引入规则引擎</h4><p>市面上常见的开源规则引擎有easy-rules、 Drools、Aviator，这里使用Aviator来作为规则引擎进行决策，首先引入相关的依赖：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">&lt;dependency&gt;<br>           &lt;groupId&gt;com.googlecode.aviator&lt;/groupId&gt;<br>           &lt;artifactId&gt;aviator&lt;/artifactId&gt;<br>           &lt;version&gt;<span class="hljs-number">5.1</span><span class="hljs-number">.4</span>&lt;/version&gt;<br>       &lt;/dependency&gt;<br></code></pre></td></tr></table></figure><p>然后创建相关的工具类</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python">package com.yang.core.infrastructure.rule;<br><br><span class="hljs-keyword">import</span> com.googlecode.aviator.AviatorEvaluator;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">AviatorUtil</span> &#123;<br>    public static Object execute(String condition, Map&lt;String, Object&gt; env) &#123;<br>        <span class="hljs-keyword">return</span> AviatorEvaluator.execute(condition, env);<br>    &#125;<br><br>    public static boolean <span class="hljs-keyword">match</span>(String condition, Map&lt;String, Object&gt; env) &#123;<br>        <span class="hljs-keyword">return</span> (Boolean) execute(condition, env);<br>    &#125;<br><br>    public static void main(String[] args) &#123;<br>        Map&lt;String, Object&gt; env = new HashMap&lt;&gt;();<br>        env.put(<span class="hljs-string">&quot;flow&quot;</span>, <span class="hljs-string">&quot;identity&quot;</span>);<br>        String condition = <span class="hljs-string">&quot;flow == &#x27;identity&#x27;&quot;</span>;<br>        System.out.println(<span class="hljs-keyword">match</span>(condition, env));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="修改流程配置"><a href="#修改流程配置" class="headerlink" title="修改流程配置"></a>修改流程配置</h4><p>原先的网关连线，通过credential来拦截是否符合条件，现在我们引入规则引擎后，可以在sequenceFlow上，通过表达式来进行拦截判断，首先修改sequenceFlow，添加condition条件字段</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python">package com.yang.core.infrastructure.flow.activiti.model;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Data</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">SequenceFlowNode</span> implements Serializable &#123;<br><br>    private String source;<br><br>    private String target;<br><br>    private String condition;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后修改流程配置文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> standalone=<span class="hljs-string">&quot;yes&quot;</span>?&gt;<br>&lt;activiti <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;register_flow&quot;</span>&gt;<br>    &lt;!--节点定义--&gt;<br>    &lt;startEvent <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;startEvent&quot;</span>/&gt;<br>    &lt;serviceTask <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;userLocate&quot;</span> name=<span class="hljs-string">&quot;userLocate&quot;</span> description=<span class="hljs-string">&quot;账号定位&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.business.activiti.login.UserLocateActivity&quot;</span>/&gt;<br>    &lt;serviceTask <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;passwordCheck&quot;</span> name=<span class="hljs-string">&quot;passwordCheck&quot;</span> description=<span class="hljs-string">&quot;密码检查&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.business.activiti.login.PasswordCheckActivity&quot;</span>/&gt;<br>    &lt;serviceTask <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;userAccountStatusCheck&quot;</span> name=<span class="hljs-string">&quot;userAccountStatusCheck&quot;</span> description=<span class="hljs-string">&quot;账号状态检查&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.business.activiti.login.UserAccountStatusCheckActivity&quot;</span>/&gt;<br>    &lt;exclusiveGateway <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;needBuildIdentityAction&quot;</span> name=<span class="hljs-string">&quot;needBuildIdentityAction&quot;</span> description=<span class="hljs-string">&quot;是否需要转核身&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.business.activiti.login.NeedTransfer2IdentityExclusiveGateway&quot;</span>/&gt;<br>    &lt;serviceTask <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;buildIdentityAction&quot;</span> name=<span class="hljs-string">&quot;buildIdentityAction&quot;</span> description=<span class="hljs-string">&quot;核身行为构建&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.business.activiti.login.BuildIdentityActionActivity&quot;</span>/&gt;<br>    &lt;serviceTask <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;buildUserToken&quot;</span> name=<span class="hljs-string">&quot;buildUserToken&quot;</span> description=<span class="hljs-string">&quot;创建用户token&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.business.activiti.common.BuildUserTokenActivity&quot;</span>/&gt;<br>    &lt;endEvent <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;endEvent&quot;</span>/&gt;<br><br>    &lt;!--节点执行顺序编排--&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;startEvent&quot;</span> target=<span class="hljs-string">&quot;userLocate&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;userLocate&quot;</span> target=<span class="hljs-string">&quot;passwordCheck&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;passwordCheck&quot;</span> target=<span class="hljs-string">&quot;userAccountStatusCheck&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;userAccountStatusCheck&quot;</span> target=<span class="hljs-string">&quot;needBuildIdentityAction&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;needBuildIdentityAction&quot;</span> target=<span class="hljs-string">&quot;buildIdentityAction&quot;</span> condition=<span class="hljs-string">&quot;flow == &#x27;identity&#x27;&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;needBuildIdentityAction&quot;</span> target=<span class="hljs-string">&quot;buildUserToken&quot;</span> condition=<span class="hljs-string">&quot;flow == &#x27;login&#x27;&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;buildIdentityAction&quot;</span> target=<span class="hljs-string">&quot;buildUserToken&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;buildUserToken&quot;</span> target=<span class="hljs-string">&quot;endEvent&quot;</span>/&gt;<br>&lt;/activiti&gt;<br></code></pre></td></tr></table></figure><p>从上面的配置文件中，我们可以看出，当上下文的flow值为identity时，走buildIdentityAction节点，当上下文的flow值为login时，走buildUserToken节点，那么，在网关节点needBuildIdentityAction中，它的作用就是根据流程当前执行内容，对流程上下文的flow进行赋值，其具体实现如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python">package com.yang.business.activiti.login;<br><br><span class="hljs-keyword">import</span> com.yang.api.common.ErrorCode;<br><span class="hljs-keyword">import</span> com.yang.api.common.exception.UicException;<br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.flow.activiti.context.ActivitiExecuteContext;<br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.flow.activiti.function.IExclusiveGateway;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">NeedTransfer2IdentityExclusiveGateway</span> implements IExclusiveGateway &#123;<br><span class="hljs-meta">    @Override</span><br>    public void parseCredential(ActivitiExecuteContext activitiExecuteContext) &#123;<br>        Object needIdentityObj = activitiExecuteContext.getContext().get(<span class="hljs-string">&quot;needIdentity&quot;</span>);<br>        <span class="hljs-keyword">if</span> (needIdentityObj != null) &#123;<br>            boolean needIdentity = (Boolean) needIdentityObj;<br>            <span class="hljs-keyword">if</span> (needIdentity) &#123;<br>                activitiExecuteContext.getContext().put(<span class="hljs-string">&quot;flow&quot;</span>, <span class="hljs-string">&quot;identity&quot;</span>);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            activitiExecuteContext.getContext().put(<span class="hljs-string">&quot;flow&quot;</span>, <span class="hljs-string">&quot;login&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        throw new UicException(ErrorCode.ACTIVITI_EXECUTE_ERROR);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后，因为我们之前将决策的逻辑放到activitiFlow类中，所以这里需要对activitiFlow的决策方法进行修改，修改内容如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python">package com.yang.core.infrastructure.flow.activiti.model;<br><br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.rule.AviatorUtil;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.<span class="hljs-type">List</span>;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Data</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivitiFlow</span> &#123;<br>    private String <span class="hljs-built_in">id</span>;<br><br>    private FlowNode startNode;<br><br>    private FlowNode endNode;<br><br>    private <span class="hljs-type">List</span>&lt;SequenceFlowNode&gt; sequenceFlowNodeList;<br><br>    private Map&lt;String, FlowNode&gt; nodeId2FlowNodeMap;<br><br>    public FlowNode chooseNextNode(FlowNode curNode, Map&lt;String, Object&gt; flowContext) &#123;<br>        String sourceNodeId = curNode.getId();<br>        String targetNodeId = null;<br>        <span class="hljs-type">List</span>&lt;SequenceFlowNode&gt; sequenceFlowNodes = new ArrayList&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (SequenceFlowNode sequenceFlowNode : sequenceFlowNodeList) &#123;<br>            <span class="hljs-keyword">if</span> (sequenceFlowNode.getSource().equals(sourceNodeId)) &#123;<br>                sequenceFlowNodes.add(sequenceFlowNode);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (sequenceFlowNodes.size() == <span class="hljs-number">1</span>) &#123;<br>            targetNodeId = sequenceFlowNodes.get(<span class="hljs-number">0</span>).getTarget();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            // 网关判断<br>            <span class="hljs-keyword">for</span> (SequenceFlowNode sequenceFlowNode : sequenceFlowNodes) &#123;<br>                String condition = sequenceFlowNode.getCondition();<br>                <span class="hljs-keyword">if</span> (AviatorUtil.<span class="hljs-keyword">match</span>(condition, flowContext)) &#123;<br>                    targetNodeId = sequenceFlowNode.getTarget();<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> nodeId2FlowNodeMap.get(targetNodeId);<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><p>启动项目，分别测试普通账号和被盗账号，结果如下：</p><img src="/2024/10/05/%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E6%8E%92%E4%BB%96%E7%BD%91%E5%85%B3/4.png" class=""><img src="/2024/10/05/%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E6%8E%92%E4%BB%96%E7%BD%91%E5%85%B3/5.png" class="">]]></content>
    
    
    
    <tags>
      
      <tag>工作积累</tag>
      
      <tag>流程引擎</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringBoot日志打印实践</title>
    <link href="/2024/10/04/SpringBoot%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0%E5%AE%9E%E8%B7%B5/"/>
    <url>/2024/10/04/SpringBoot%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>在项目当中，我们经常需要打印一些日志埋点信息，这些日志埋点信息，在后续软件的运维、稳定性建设中发挥了巨大的作用：</p><ul><li>问题追踪：通过埋点日志中的关键信息，帮助定位系统异常原因</li><li>系统监控：通过日志，监控系统的运行情况，包括性能指标、访问频率、错误等</li><li>数据分析：分析用户行为、系统性能和业务趋势等</li><li>调试：通过查看日志，帮助开发人员了解程序在执行过程中的状态和行为</li></ul><h3 id="SpringBoot整合Logback实现日志打印"><a href="#SpringBoot整合Logback实现日志打印" class="headerlink" title="SpringBoot整合Logback实现日志打印"></a>SpringBoot整合Logback实现日志打印</h3><p>SpringBoot默认使用Slf4j作为日志门面，并集成Logback作为日志实现。要在springboot中实现日志打印，只需要引入下列依赖：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">&lt;dependency&gt;<br>    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>    &lt;artifactId&gt;spring-boot-starter-logging&lt;/artifactId&gt;<br>&lt;/dependency&gt;<br></code></pre></td></tr></table></figure><p>然后在配置文件中，配置对应的日志级别：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">logging:<br>  level:<br>    root: INFO<br></code></pre></td></tr></table></figure><p>对某些特定的包，需要指定日志级别，则配置如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">logging:<br>    level:<br>        com.example.demo: DEBUG<br></code></pre></td></tr></table></figure><p>最后，我们创建logback-spring.xml，来自定义日志的配置信息，包括日志输出文件、日志格式等</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;<br>&lt;configuration&gt;<br>    &lt;<span class="hljs-built_in">property</span> name=<span class="hljs-string">&quot;LOG_PATH&quot;</span> value=<span class="hljs-string">&quot;logs&quot;</span>/&gt;<br>    &lt;<span class="hljs-built_in">property</span> name=<span class="hljs-string">&quot;LOG_FILE&quot;</span> value=<span class="hljs-string">&quot;$&#123;LOG_PATH&#125;/spring-boot-logger.log&quot;</span>/&gt;<br><br>    &lt;appender name=<span class="hljs-string">&quot;CONSOLE&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;<br>        &lt;encoder&gt;<br>            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss&#125; - %msg%n&lt;/pattern&gt;<br>        &lt;/encoder&gt;<br>    &lt;/appender&gt;<br><br>    &lt;appender name=<span class="hljs-string">&quot;FILE&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;<br>        &lt;file&gt;common.log&lt;/file&gt;<br>        &lt;rollingPolicy <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;<br>            &lt;fileNamePattern&gt;$&#123;LOG_PATH&#125;/spring-boot-logger.%d&#123;yyyy-MM-dd&#125;.log&lt;/fileNamePattern&gt;<br>            &lt;maxHistory&gt;<span class="hljs-number">30</span>&lt;/maxHistory&gt;<br>        &lt;/rollingPolicy&gt;<br>        &lt;encoder&gt;<br>            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss&#125; - %msg%n&lt;/pattern&gt;<br>        &lt;/encoder&gt;<br>    &lt;/appender&gt;<br><br>    &lt;root level=<span class="hljs-string">&quot;INFO&quot;</span>&gt;<br>        &lt;appender-ref ref=<span class="hljs-string">&quot;CONSOLE&quot;</span>/&gt;<br>        &lt;appender-ref ref=<span class="hljs-string">&quot;FILE&quot;</span>/&gt;<br>    &lt;/root&gt;<br>&lt;/configuration&gt;<br></code></pre></td></tr></table></figure><p>然后，我们在需要打印日志的类，加上Slf4j注解，然后使用log来打印日志信息即可，如下代码所示：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python">package com.yang.web.controller;<br><br><span class="hljs-keyword">import</span> com.yang.api.common.ResultT;<br><span class="hljs-keyword">import</span> com.yang.api.common.command.RegisterCommand;<br><span class="hljs-keyword">import</span> com.yang.api.common.dto.UserDTO;<br><span class="hljs-keyword">import</span> com.yang.api.common.facade.UserFacade;<br><span class="hljs-keyword">import</span> com.yang.web.request.RegisterRequest;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(<span class="hljs-params">value = <span class="hljs-string">&quot;/user&quot;</span></span>)</span><br><span class="hljs-meta">@Slf4j</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br><span class="hljs-meta">    @Autowired</span><br>    private UserFacade userFacade;<br><br><span class="hljs-meta">    @GetMapping(<span class="hljs-params">value = <span class="hljs-string">&quot;/&#123;id&#125;&quot;</span></span>)</span><br>    public ResultT&lt;UserDTO&gt; queryById(@PathVariable(<span class="hljs-string">&quot;id&quot;</span>) Integer <span class="hljs-built_in">id</span>) &#123;<br>        log.info(<span class="hljs-string">&quot;queryById===========&quot;</span>);<br>        <span class="hljs-keyword">return</span> userFacade.getById(<span class="hljs-built_in">id</span>);<br>    &#125;<br><br><span class="hljs-meta">    @PostMapping(<span class="hljs-params">value = <span class="hljs-string">&quot;/register&quot;</span></span>)</span><br>    public ResultT&lt;String&gt; register(@RequestBody RegisterRequest registerRequest) &#123;<br>        RegisterCommand registerCommand = convert2RegisterCommand(registerRequest);<br>        <span class="hljs-keyword">return</span> userFacade.register2(registerCommand);<br>    &#125;<br><br>    private RegisterCommand convert2RegisterCommand(RegisterRequest registerRequest) &#123;<br>        RegisterCommand registerCommand = new RegisterCommand();<br>        registerCommand.setLoginId(registerRequest.getLoginId());<br>        registerCommand.setEmail(registerRequest.getEmail());<br>        registerCommand.setPassword(registerRequest.getPassword());<br>        registerCommand.setExtendMaps(registerRequest.getExtendMaps());<br>        <span class="hljs-keyword">return</span> registerCommand;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后访问queryById，打印结果如下：</p><img src="/2024/10/04/SpringBoot%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0%E5%AE%9E%E8%B7%B5/1.png" class=""><h3 id="日志打印工具类"><a href="#日志打印工具类" class="headerlink" title="日志打印工具类"></a>日志打印工具类</h3><p>在logback-spring.xml中，我们虽然能配置日志打印的格式，但是不够灵活，因此，我们可以添加一个日志打印工具类，通过该工具类，来自定义项目中的日志打印格式，以方便后续更好地通过日志排查、定位问题。</p><p>首先创建一个日志打印抽象类，定义日志打印的格式：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs python">package com.yang.core.infrastructure.log;<br><br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.util.CollectionUtils;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.<span class="hljs-type">List</span>;<br><br>public abstract <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractLogPrinter</span> &#123;<br>    protected String bizCode;<br>    <br>    protected <span class="hljs-type">List</span>&lt;String&gt; params = new ArrayList&lt;&gt;();<br><br>    protected String msg;<br><br>    protected Throwable e;<br><br>    public AbstractLogPrinter addBizCode(String bizCode) &#123;<br>        this.bizCode = bizCode;<br>        <span class="hljs-keyword">return</span> this;<br>    &#125;<br><br>    public AbstractLogPrinter addMsg(String msg) &#123;<br>        this.msg = msg;<br>        <span class="hljs-keyword">return</span> this;<br>    &#125;<br><br>    public AbstractLogPrinter addParam(String key, String value) &#123;<br>        this.params.add(key);<br>        this.params.add(value);<br>        <span class="hljs-keyword">return</span> this;<br>    &#125;<br><br>    public AbstractLogPrinter addThrowable(Throwable e) &#123;<br>        this.e = e;<br>        <span class="hljs-keyword">return</span> this;<br>    &#125;<br><br>    public abstract void printBizLog();<br><br>    public abstract void printErrorLog();<br><br>    public abstract String getSeparator();<br><br>    public String commonContent() &#123;<br>        StringBuilder stringBuilder = new StringBuilder();<br>        String separator = getSeparator();<br>        stringBuilder.append(<span class="hljs-string">&quot;bizCode&quot;</span>).append(<span class="hljs-string">&quot;:&quot;</span>)<br>                .append(this.bizCode).append(separator);<br>        <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(params)) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; params.size(); i += <span class="hljs-number">2</span>) &#123;<br>                stringBuilder.append(params.get(i))<br>                        .append(<span class="hljs-string">&quot;:&quot;</span>)<br>                        .append(params.get(i + <span class="hljs-number">1</span>))<br>                        .append(separator);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(msg)) &#123;<br>            stringBuilder.append(<span class="hljs-string">&quot;msg&quot;</span>).append(<span class="hljs-string">&quot;:&quot;</span>)<br>                    .append(msg).append(separator);<br>        &#125;<br>        <span class="hljs-keyword">return</span> stringBuilder.toString();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后创建日志打印实现类，在实现类中，定制实现日志打印的级别、分隔符等内容</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python">package com.yang.core.infrastructure.log;<br><br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><br><span class="hljs-meta">@Slf4j</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">PlatformLogPrinter</span> extends AbstractLogPrinter &#123;<br><br>    public void printBizLog() &#123;<br>        log.info(commonContent());<br>    &#125;<br><br>    public void printErrorLog() &#123;<br>        <span class="hljs-keyword">if</span> (e != null) &#123;<br>            log.error(commonContent(), e);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            log.error(commonContent());<br>        &#125;<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public String getSeparator() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&lt;|&gt;&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>同时，为了方便打印日志，创建一个日志打印创建者</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">package com.yang.core.infrastructure.log;<br><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">PlatformLogger</span> &#123;<br><br>    public static AbstractLogPrinter build() &#123;<br>        <span class="hljs-keyword">return</span> new PlatformLogPrinter();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>上述内容准备完毕后，我们在controller中，使用PlatformLogger来打印日志，修改后的代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs python">package com.yang.web.controller;<br><br><span class="hljs-keyword">import</span> com.yang.api.common.ResultT;<br><span class="hljs-keyword">import</span> com.yang.api.common.command.RegisterCommand;<br><span class="hljs-keyword">import</span> com.yang.api.common.dto.UserDTO;<br><span class="hljs-keyword">import</span> com.yang.api.common.facade.UserFacade;<br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.log.PlatformLogger;<br><span class="hljs-keyword">import</span> com.yang.web.request.RegisterRequest;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(<span class="hljs-params">value = <span class="hljs-string">&quot;/user&quot;</span></span>)</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br><span class="hljs-meta">    @Autowired</span><br>    private UserFacade userFacade;<br><br><span class="hljs-meta">    @GetMapping(<span class="hljs-params">value = <span class="hljs-string">&quot;/&#123;id&#125;&quot;</span></span>)</span><br>    public ResultT&lt;UserDTO&gt; queryById(@PathVariable(<span class="hljs-string">&quot;id&quot;</span>) Integer <span class="hljs-built_in">id</span>) &#123;<br>        PlatformLogger.build()<br>                .addBizCode(<span class="hljs-string">&quot;queryById&quot;</span>)<br>                .addParam(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-built_in">id</span>.toString())<br>                .addMsg(<span class="hljs-string">&quot;query by id&quot;</span>)<br>                .printBizLog();<br>        <span class="hljs-keyword">return</span> userFacade.getById(<span class="hljs-built_in">id</span>);<br>    &#125;<br>    <br><span class="hljs-meta">    @GetMapping(<span class="hljs-params">value = <span class="hljs-string">&quot;/error/&#123;id&#125;&quot;</span></span>)</span><br>    public ResultT testError(@PathVariable(<span class="hljs-string">&quot;id&quot;</span>) Integer <span class="hljs-built_in">id</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">int</span> i = <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;<br>        &#125; catch (Throwable t) &#123;<br>            PlatformLogger.build()<br>                    .addBizCode(<span class="hljs-string">&quot;testError&quot;</span>)<br>                    .addParam(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-built_in">id</span>.toString())<br>                    .addMsg(<span class="hljs-string">&quot;test error print&quot;</span>)<br>                    .addThrowable(t)<br>                    .printErrorLog();<br>        &#125;<br>        <span class="hljs-keyword">return</span> ResultT.fail();<br>    &#125;<br><br><span class="hljs-meta">    @PostMapping(<span class="hljs-params">value = <span class="hljs-string">&quot;/register&quot;</span></span>)</span><br>    public ResultT&lt;String&gt; register(@RequestBody RegisterRequest registerRequest) &#123;<br>        RegisterCommand registerCommand = convert2RegisterCommand(registerRequest);<br>        <span class="hljs-keyword">return</span> userFacade.register2(registerCommand);<br>    &#125;<br><br>    private RegisterCommand convert2RegisterCommand(RegisterRequest registerRequest) &#123;<br>        RegisterCommand registerCommand = new RegisterCommand();<br>        registerCommand.setLoginId(registerRequest.getLoginId());<br>        registerCommand.setEmail(registerRequest.getEmail());<br>        registerCommand.setPassword(registerRequest.getPassword());<br>        registerCommand.setExtendMaps(registerRequest.getExtendMaps());<br>        <span class="hljs-keyword">return</span> registerCommand;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>启动项目，分别访问queryById和testError，打印日志内容如下：</p><img src="/2024/10/04/SpringBoot%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0%E5%AE%9E%E8%B7%B5/2.png" class=""><h3 id="日志分文件打印"><a href="#日志分文件打印" class="headerlink" title="日志分文件打印"></a>日志分文件打印</h3><p>一般情况下，我们的项目会分为不同的模块，每一个模块承担不同的职责，比如bussiness模块，主要是负责业务逻辑代码的实现，业务逻辑编排等；web模块主要负责http请求的接收，参数的校验，入参转化为业务层入参等；而core模块主要负责基础能力实现，比如持久化数据库、领域服务实现等。</p><p>对于不同的模块，我们希望将日志输出到不同的文件当中，从而协助我们后续定位问题以及建设不同模块下的监控，包括基础服务监控、业务成功率监控等。</p><img src="/2024/10/04/SpringBoot%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0%E5%AE%9E%E8%B7%B5/3.png" class=""><p>因此，我们在不同的模块下，分别实现不同的日志打印工具类：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs python">package com.yang.web.log;<br><br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.log.AbstractLogPrinter;<br><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebLogger</span> &#123;<br>    public static AbstractLogPrinter build() &#123;<br>        <span class="hljs-keyword">return</span> new WebLogPrinter();<br>    &#125;<br>&#125;<br><br><br>package com.yang.web.log;<br><br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.log.AbstractLogPrinter;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><br><span class="hljs-meta">@Slf4j</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebLogPrinter</span> extends AbstractLogPrinter &#123;<br><span class="hljs-meta">    @Override</span><br>    public void printBizLog() &#123;<br>        log.info(commonContent());<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public void printErrorLog() &#123;<br>        <span class="hljs-keyword">if</span> (this.e != null) &#123;<br>            log.error(commonContent(), e);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            log.error(commonContent());<br>        &#125;<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public String getSeparator() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&lt;|&gt;&quot;</span>;<br>    &#125;<br>&#125;<br><br><br>package com.yang.business.log;<br><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessLogger</span> &#123;<br>    public static BusinessLogPrinter build() &#123;<br>        <span class="hljs-keyword">return</span> new BusinessLogPrinter();<br>    &#125;<br>&#125;<br><br><br>package com.yang.business.log;<br><br><span class="hljs-keyword">import</span> com.yang.core.infrastructure.log.AbstractLogPrinter;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><br><span class="hljs-meta">@Slf4j</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessLogPrinter</span> extends AbstractLogPrinter &#123;<br><span class="hljs-meta">    @Override</span><br>    public void printBizLog() &#123;<br>        log.info(commonContent());<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public void printErrorLog() &#123;<br>        <span class="hljs-keyword">if</span> (this.e != null) &#123;<br>            log.error(commonContent(), e);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            log.error(commonContent());<br>        &#125;<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public String getSeparator() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&lt;|&gt;&quot;</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后我们修改logback-spring.xml文件，将不同的日志打印工具类，输出到不同的日志文件中</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs python">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;<br>&lt;configuration&gt;<br>    &lt;<span class="hljs-built_in">property</span> name=<span class="hljs-string">&quot;LOG_PATH&quot;</span> value=<span class="hljs-string">&quot;logs&quot;</span>/&gt;<br>    &lt;<span class="hljs-built_in">property</span> name=<span class="hljs-string">&quot;LOG_FILE&quot;</span> value=<span class="hljs-string">&quot;$&#123;LOG_PATH&#125;/spring-boot-logger.log&quot;</span>/&gt;<br><br>    &lt;appender name=<span class="hljs-string">&quot;CONSOLE&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;<br>        &lt;encoder&gt;<br>            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss&#125; - %msg%n&lt;/pattern&gt;<br>        &lt;/encoder&gt;<br>    &lt;/appender&gt;<br><br>    &lt;appender name=<span class="hljs-string">&quot;FILE&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;<br>        &lt;file&gt;common.log&lt;/file&gt;<br>        &lt;rollingPolicy <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;<br>            &lt;fileNamePattern&gt;$&#123;LOG_PATH&#125;/spring-boot-logger.%d&#123;yyyy-MM-dd&#125;.log&lt;/fileNamePattern&gt;<br>            &lt;maxHistory&gt;<span class="hljs-number">30</span>&lt;/maxHistory&gt;<br>        &lt;/rollingPolicy&gt;<br>        &lt;encoder&gt;<br>            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss&#125; - %msg%n&lt;/pattern&gt;<br>        &lt;/encoder&gt;<br>    &lt;/appender&gt;<br><br>    &lt;appender name=<span class="hljs-string">&quot;PLATFORM_FILE&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;<br>        &lt;file&gt;platform.log&lt;/file&gt;<br>        &lt;rollingPolicy <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;<br>            &lt;fileNamePattern&gt;$&#123;LOG_PATH&#125;/platform-logger.%d&#123;yyyy-MM-dd&#125;.log&lt;/fileNamePattern&gt;<br>            &lt;maxHistory&gt;<span class="hljs-number">30</span>&lt;/maxHistory&gt;<br>        &lt;/rollingPolicy&gt;<br>        &lt;encoder&gt;<br>            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss&#125; - %msg%n&lt;/pattern&gt;<br>        &lt;/encoder&gt;<br>    &lt;/appender&gt;<br><br>    &lt;appender name=<span class="hljs-string">&quot;BUSINESS_FILE&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;<br>        &lt;file&gt;business.log&lt;/file&gt;<br>        &lt;rollingPolicy <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;<br>            &lt;fileNamePattern&gt;$&#123;LOG_PATH&#125;/business-logger.%d&#123;yyyy-MM-dd&#125;.log&lt;/fileNamePattern&gt;<br>            &lt;maxHistory&gt;<span class="hljs-number">30</span>&lt;/maxHistory&gt;<br>        &lt;/rollingPolicy&gt;<br>        &lt;encoder&gt;<br>            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss&#125; - %msg%n&lt;/pattern&gt;<br>        &lt;/encoder&gt;<br>    &lt;/appender&gt;<br><br>    &lt;appender name=<span class="hljs-string">&quot;WEB_FILE&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;<br>        &lt;file&gt;web.log&lt;/file&gt;<br>        &lt;rollingPolicy <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;<br>            &lt;fileNamePattern&gt;$&#123;LOG_PATH&#125;/web-logger.%d&#123;yyyy-MM-dd&#125;.log&lt;/fileNamePattern&gt;<br>            &lt;maxHistory&gt;<span class="hljs-number">30</span>&lt;/maxHistory&gt;<br>        &lt;/rollingPolicy&gt;<br>        &lt;encoder&gt;<br>            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss&#125; - %msg%n&lt;/pattern&gt;<br>        &lt;/encoder&gt;<br>    &lt;/appender&gt;<br><br>    &lt;root level=<span class="hljs-string">&quot;INFO&quot;</span>&gt;<br>        &lt;appender-ref ref=<span class="hljs-string">&quot;CONSOLE&quot;</span>/&gt;<br>        &lt;appender-ref ref=<span class="hljs-string">&quot;FILE&quot;</span>/&gt;<br>    &lt;/root&gt;<br><br>    &lt;!-- 工具类PlatformLogPrinter的logger --&gt;<br>    &lt;logger name=<span class="hljs-string">&quot;com.yang.core.infrastructure.log.PlatformLogPrinter&quot;</span> level=<span class="hljs-string">&quot;INFO&quot;</span> additivity=<span class="hljs-string">&quot;false&quot;</span>&gt;<br>        &lt;appender-ref ref=<span class="hljs-string">&quot;PLATFORM_FILE&quot;</span> /&gt;<br>    &lt;/logger&gt;<br><br>    &lt;!-- 工具类BusinessLogPrinter的logger --&gt;<br>    &lt;logger name=<span class="hljs-string">&quot;com.yang.business.log.BusinessLogPrinter&quot;</span> level=<span class="hljs-string">&quot;INFO&quot;</span> additivity=<span class="hljs-string">&quot;false&quot;</span>&gt;<br>        &lt;appender-ref ref=<span class="hljs-string">&quot;BUSINESS_FILE&quot;</span> /&gt;<br>    &lt;/logger&gt;<br><br>    &lt;!-- 工具类WebLogPrinter的logger --&gt;<br>    &lt;logger name=<span class="hljs-string">&quot;com.yang.web.log.WebLogPrinter&quot;</span> level=<span class="hljs-string">&quot;INFO&quot;</span> additivity=<span class="hljs-string">&quot;false&quot;</span>&gt;<br>        &lt;appender-ref ref=<span class="hljs-string">&quot;WEB_FILE&quot;</span> /&gt;<br>    &lt;/logger&gt;<br>&lt;/configuration&gt;<br></code></pre></td></tr></table></figure><p>最后，分别在web模块、business模块和core模块下，添加埋点日志</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs python">// WEB模块<br><span class="hljs-meta">@GetMapping(<span class="hljs-params">value = <span class="hljs-string">&quot;/&#123;id&#125;&quot;</span></span>)</span><br>    public ResultT&lt;UserDTO&gt; queryById(@PathVariable(<span class="hljs-string">&quot;id&quot;</span>) Integer <span class="hljs-built_in">id</span>) &#123;<br>        WebLogger.build()<br>                .addBizCode(<span class="hljs-string">&quot;userController_queryById&quot;</span>)<br>                .addParam(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-built_in">id</span>.toString())<br>                .addMsg(<span class="hljs-string">&quot;query by id&quot;</span>)<br>                .printBizLog();<br>        <span class="hljs-keyword">return</span> userFacade.getById(<span class="hljs-built_in">id</span>);<br>    &#125;<br><br>// Business模块<br><span class="hljs-meta">@Override</span><br>    public ResultT&lt;UserDTO&gt; getById(Integer <span class="hljs-built_in">id</span>) &#123;<br>        UserQueryDomainRequest userQueryDomainRequest = new UserQueryDomainRequest.UserQueryDomainRequestBuilder()<br>                .queryMessage(<span class="hljs-built_in">id</span>.toString())<br>                .userQueryType(UserQueryType.ID)<br>                .build();<br>        UserQueryDomainResponse userQueryDomainResponse = userDomainService.query(userQueryDomainRequest);<br>        <span class="hljs-type">List</span>&lt;UserAccount&gt; userAccountList = userQueryDomainResponse.getUserAccountList();<br>        UserDTO userDTO = null;<br>        <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(userAccountList)) &#123;<br>            UserAccount userAccount = userAccountList.get(<span class="hljs-number">0</span>);<br>            userDTO = userDTOConvertor.convert2DTO(userAccount);<br>        &#125;<br>        BusinessLogger.build()<br>                .addBizCode(<span class="hljs-string">&quot;userFacade_getById&quot;</span>)<br>                .addParam(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-built_in">id</span>.toString())<br>                .addParam(<span class="hljs-string">&quot;userDTO&quot;</span>, JSONObject.toJSONString(userDTO))<br>                .addMsg(<span class="hljs-string">&quot;get by id&quot;</span>)<br>                .printBizLog();<br>        <span class="hljs-keyword">return</span> ResultT.success(userDTO);<br>    &#125;<br><br><br>// core模块<br>public UserQueryDomainResponse query(UserQueryDomainRequest userQueryDomainRequest) &#123;<br>        UserQueryType userQueryType = userQueryDomainRequest.getUserQueryType();<br>        UserDO userDO = null;<br>        switch (userQueryType) &#123;<br>            <span class="hljs-keyword">case</span> ID:<br>                userDO = queryById(Integer.valueOf(userQueryDomainRequest.getQueryMessage()));<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> EMAIL:<br>                userDO = queryByEmail(userQueryDomainRequest.getQueryMessage());<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> LOGIN_ID:<br>                userDO = queryByLoginId(userQueryDomainRequest.getQueryMessage());<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (userDO == null) &#123;<br>            <span class="hljs-keyword">return</span> new UserQueryDomainResponse();<br>        &#125;<br>        UserAccount userAccount = new UserAccount();<br>        userAccount.setId(userDO.getId());<br>        userAccount.setLoginId(userDO.getLoginId());<br>        userAccount.setEmail(userDO.getEmail());<br>        userAccount.setFeatureMap(FeatureUtils.convert2FeatureMap(userDO.getFeatures()));<br>        userAccount.setCreateTime(userDO.getCreateTime());<br>        userAccount.setUpdateTime(userDO.getUpdateTime());<br>        UserQueryDomainResponse userQueryDomainResponse = new UserQueryDomainResponse();<br>        <span class="hljs-type">List</span>&lt;UserAccount&gt; userAccounts = new ArrayList&lt;&gt;();<br>        userAccounts.add(userAccount);<br>        userQueryDomainResponse.setUserAccountList(userAccounts);<br><br>        PlatformLogger.build()<br>                .addBizCode(<span class="hljs-string">&quot;userDomainService_query&quot;</span>)<br>                .addParam(<span class="hljs-string">&quot;queryMsg&quot;</span>, userQueryDomainRequest.getQueryMessage())<br>                .addParam(<span class="hljs-string">&quot;queryType&quot;</span>, userQueryDomainRequest.getUserQueryType().name())<br>                .printBizLog();<br>        <span class="hljs-keyword">return</span> userQueryDomainResponse;<br>    &#125;<br></code></pre></td></tr></table></figure><p>启动项目，访问queryById接口，可以看到在web.log，business.log和platform.log下分别打印了不同的日志信息</p><img src="/2024/10/04/SpringBoot%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0%E5%AE%9E%E8%B7%B5/4.png" class=""><img src="/2024/10/04/SpringBoot%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0%E5%AE%9E%E8%B7%B5/5.png" class=""><img src="/2024/10/04/SpringBoot%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0%E5%AE%9E%E8%B7%B5/6.png" class=""><h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><p><a href="https://cloud.tencent.com/developer/article/2419957">【Spring Boot】深入解密Spring Boot日志：最佳实践与策略解析-腾讯云开发者社区-腾讯云 (tencent.com)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>工作积累</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>流程引擎实现（一）—串行流程实现</title>
    <link href="/2024/10/04/%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E4%B8%B2%E8%A1%8C%E6%B5%81%E7%A8%8B%E5%AE%9E%E7%8E%B0/"/>
    <url>/2024/10/04/%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E4%B8%B2%E8%A1%8C%E6%B5%81%E7%A8%8B%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>在传统的MVC架构中，和业务逻辑相关的代码一般是编写在service层，但随着业务的发展，service层会不断充斥各种逻辑，导致service层过于臃肿、庞大，此外，职责定义不够清晰，如何对service层进行瘦身，以达到职责分离的效果，成为后续开发中不断需要面对的一个难题。</p><p>通过流程引擎，将service层的各种业务逻辑，拆分到不同的activitiy节点中，从而达到职责分离的效果，此外，通过对这些activity节点进行编排，能有效进行流程追踪和监控，以及实现流程标准化。</p><p>目前主流的开源流程引擎有activiti、flowable、camunda，在我的实际工作项目中，也用到了流程引擎，基于对流程引擎的好奇和兴趣，决定自己实现一个简单的流程引擎，一方面是锻炼自己的编程能力，另一方面是加深自己对流程引擎的一些理解和认识，下面是具体的实现思路。</p><h3 id="流程引擎解析"><a href="#流程引擎解析" class="headerlink" title="流程引擎解析"></a>流程引擎解析</h3><p>无论是什么类型的流程引擎，在执行的时候，都是依据配置文件中配置的流程执行顺序，挨个执行相应的流程节点，通过这些流程节点的活动和编排的顺序，完成相关的业务逻辑，从而对外提供服务。</p><p>首先我们定义流程文件解析接口：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">public interface IActivitiFileParser &#123;<br>    ActivitiFlow parseActivitiFlow(String file);<br>&#125;<br></code></pre></td></tr></table></figure><p>以注册流程为例，假设我们的流程配置文件定义如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> standalone=<span class="hljs-string">&quot;yes&quot;</span>?&gt;<br>&lt;activiti <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;register_flow&quot;</span>&gt;<br>    &lt;!--节点定义--&gt;<br>    &lt;startEvent <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;startEvent&quot;</span>/&gt;<br>    &lt;serviceTask <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;registerFormCheck&quot;</span> name=<span class="hljs-string">&quot;registerFormCheck&quot;</span> description=<span class="hljs-string">&quot;注册表单校验&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.application.register.activiti.RegisterFormCheckActivity&quot;</span>/&gt;<br>    &lt;serviceTask <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;userConflictCheck&quot;</span> name=<span class="hljs-string">&quot;userConflictCheck&quot;</span> description=<span class="hljs-string">&quot;用户冲突定位&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.application.register.activiti.UserConflictCheckActivity&quot;</span>/&gt;<br>    &lt;serviceTask <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;encryptPassword&quot;</span> name=<span class="hljs-string">&quot;encryptPassword&quot;</span> description=<span class="hljs-string">&quot;密码加密&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.application.register.activiti.EncryptPasswordActivity&quot;</span>/&gt;<br>    &lt;serviceTask <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;userRoleRich&quot;</span> name=<span class="hljs-string">&quot;userRoleRich&quot;</span> description=<span class="hljs-string">&quot;用户权限填充&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.application.register.activiti.UserRoleRichActivity&quot;</span>/&gt;<br>    &lt;serviceTask <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;createUser&quot;</span> name=<span class="hljs-string">&quot;createUser&quot;</span> description=<span class="hljs-string">&quot;创建用户&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.application.register.activiti.CreateUserActivity&quot;</span>/&gt;<br>    &lt;serviceTask <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;buildUserToken&quot;</span> name=<span class="hljs-string">&quot;buildUserToken&quot;</span> description=<span class="hljs-string">&quot;创建用户token&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.application.register.activiti.BuildUserTokenActivity&quot;</span>/&gt;<br>    &lt;endEvent <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;endEvent&quot;</span>/&gt;<br><br>    &lt;!--节点执行顺序编排--&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;startEvent&quot;</span> target=<span class="hljs-string">&quot;registerFormCheck&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;registerFormCheck&quot;</span> target=<span class="hljs-string">&quot;userConflictCheck&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;userConflictCheck&quot;</span> target=<span class="hljs-string">&quot;encryptPassword&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;encryptPassword&quot;</span> target=<span class="hljs-string">&quot;userRoleRich&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;userRoleRich&quot;</span> target=<span class="hljs-string">&quot;createUser&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;createUser&quot;</span> target=<span class="hljs-string">&quot;buildUserToken&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;buildUserToken&quot;</span> target=<span class="hljs-string">&quot;endEvent&quot;</span>/&gt;<br>&lt;/activiti&gt;<br></code></pre></td></tr></table></figure><p>这里，我们将流程节点分为下列四类：</p><table><thead><tr><th>类型</th><th>定义</th></tr></thead><tbody><tr><td>startEvent</td><td>开始事件</td></tr><tr><td>serviceTask</td><td>服务任务，执行对应的业务逻辑活动</td></tr><tr><td>endEvent</td><td>结束事件</td></tr><tr><td>sequenceFlow</td><td>流程线，用于定义流程节点之间的执行先后顺序</td></tr></tbody></table><p>我们将这些类型，抽象到相关的枚举类中</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python">package com.yang.infrastructure.flow.activiti.enums;<br><br><br>public enum FlowNodeType &#123;<br>    START_EVENT(<span class="hljs-string">&quot;startEvent&quot;</span>),<br>    SERVICE_TASK(<span class="hljs-string">&quot;serviceTask&quot;</span>),<br>    END_EVENT(<span class="hljs-string">&quot;endEvent&quot;</span>),<br>    SEQUENCE_FLOW(<span class="hljs-string">&quot;sequenceFlow&quot;</span>);<br><br>    private String code;<br><br>    FlowNodeType(String code) &#123;<br>        this.code = code;<br>    &#125;<br><br>    public String getCode() &#123;<br>        <span class="hljs-keyword">return</span> code;<br>    &#125;<br><br>    public static FlowNodeType parseByCode(String code) &#123;<br>        <span class="hljs-keyword">for</span> (FlowNodeType value : values()) &#123;<br>            <span class="hljs-keyword">if</span> (value.getCode().equals(code)) &#123;<br>                <span class="hljs-keyword">return</span> value;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> null;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>对于上述四种类型，可以进一步划分为两类——节点类和节点连线类，我们为此定义两种模型：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python">// 节点类<br><span class="hljs-meta">@Data</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">FlowNode</span> implements Serializable &#123;<br><br>    private String <span class="hljs-built_in">id</span>;<br><br>    private String name;<br><br>    private String description;<br><br>    private Object target;<br><br>    private String classPath;<br><br>    private FlowNodeType flowNodeType;<br><br>&#125;<br><br><br>// 节点连线类<br><span class="hljs-meta">@Data</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">SequenceFlowNode</span> implements Serializable &#123;<br><br>    private String source;<br><br>    private String target;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后我们定义流程文件相关的聚合类，该类有两个属性，一个是流程id（也就是流程文件名称），另一个是该流程中的流程节点（这里以List来实现，List中元素的顺序，也就是流程节点的执行顺序）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivitiFlow</span> &#123;<br>    private String <span class="hljs-built_in">id</span>;<br><br>    private <span class="hljs-type">List</span>&lt;FlowNode&gt; flowNodeList = new ArrayList&lt;&gt;();<br><br>    public void addFlowNode(FlowNode flowNode) &#123;<br>        this.flowNodeList.add(flowNode);<br>    &#125;<br><br>    public <span class="hljs-type">List</span>&lt;FlowNode&gt; getFlowNodeList() &#123;<br>        <span class="hljs-keyword">return</span> this.flowNodeList;<br>    &#125;<br><br>    public String getId() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">id</span>;<br>    &#125;<br><br>    public void setId(String <span class="hljs-built_in">id</span>) &#123;<br>        this.<span class="hljs-built_in">id</span> = <span class="hljs-built_in">id</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后对于ActivitiFlow的构造，主要是根据流程连线和流程节点来实现，对于不同的流程文件解析类，他们负责的只是流程连线、流程节点的解析，构造过程则是通用的，因此我们将其构造过程提炼为抽象类</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs python"><br>public abstract <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractActivitiFileParser</span> implements IActivitiFileParser&#123;<br><br>    /**<br>     * 填充流程节点内容<br>     * @param flowNode<br>     * @param flowNodeType<br>     */<br>    protected void richFlowNode(FlowNode flowNode, FlowNodeType flowNodeType) &#123;<br>        <span class="hljs-keyword">if</span> (flowNodeType != FlowNodeType.SERVICE_TASK) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            // 填充target对象<br>            Class&lt;?&gt; aClass = Class.forName(flowNode.getClassPath());<br>            Object target = SpringContextUtil.getBeanByType(aClass);<br>            flowNode.setTarget(target);<br>        &#125; catch (ClassNotFoundException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    /**<br>     * 根据连线顺序，对流程节点进行排序，构建相应的流程flow<br>     * @param fileName<br>     * @param flowNodeList<br>     * @param sequenceFlowNodeList<br>     * @<span class="hljs-keyword">return</span><br>     */<br>    protected ActivitiFlow buildActivitiFlow(String fileName,<br>                                             <span class="hljs-type">List</span>&lt;FlowNode&gt; flowNodeList,<br>                                             <span class="hljs-type">List</span>&lt;SequenceFlowNode&gt; sequenceFlowNodeList) &#123;<br>        <span class="hljs-type">List</span>&lt;SequenceFlowNode&gt; sortSequenceFlowNodeList = sortSequenceFlowNodeList(sequenceFlowNodeList);<br>        ActivitiFlow activitiFlow = new ActivitiFlow();<br>        activitiFlow.setId(fileName);<br>        Map&lt;String, FlowNode&gt; id2FlowNodeMap = flowNodeList.stream()<br>                .collect(Collectors.toMap(FlowNode::getId, Function.identity()));<br>        SequenceFlowNode iterator = null;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; sortSequenceFlowNodeList.size(); i++) &#123;<br>            iterator = sortSequenceFlowNodeList.get(i);<br>            String source = iterator.getSource();<br>            FlowNode flowNode = id2FlowNodeMap.get(source);<br>            activitiFlow.addFlowNode(flowNode);<br>        &#125;<br>        FlowNode endNode = id2FlowNodeMap.get(iterator.getTarget());<br>        activitiFlow.addFlowNode(endNode);<br>        <span class="hljs-keyword">return</span> activitiFlow;<br>    &#125;<br><br>    /**<br>     * 按照开始到结束，对连线进行排序<br>     * @param sequenceFlowNodeList<br>     * @<span class="hljs-keyword">return</span><br>     */<br>    private <span class="hljs-type">List</span>&lt;SequenceFlowNode&gt; sortSequenceFlowNodeList(<span class="hljs-type">List</span>&lt;SequenceFlowNode&gt; sequenceFlowNodeList) &#123;<br>        Map&lt;String, SequenceFlowNode&gt; source2SequenceFlowNodeMap = sequenceFlowNodeList.stream()<br>                .collect(Collectors.toMap(SequenceFlowNode::getSource, Function.identity()));<br>        Map&lt;String, String&gt; target2SourceMap = new HashMap&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (SequenceFlowNode sequenceFlowNode : sequenceFlowNodeList) &#123;<br>            target2SourceMap.put(sequenceFlowNode.getTarget(), sequenceFlowNode.getSource());<br>        &#125;<br>        // 定位开始节点<br>        SequenceFlowNode startSequenceFlowNode = null;<br>        <span class="hljs-keyword">for</span> (SequenceFlowNode sequenceFlowNode : sequenceFlowNodeList) &#123;<br>            String <span class="hljs-keyword">from</span> = target2SourceMap.get(sequenceFlowNode.getSource());<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">from</span> == null) &#123;<br>                startSequenceFlowNode = sequenceFlowNode;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (startSequenceFlowNode == null) &#123;<br>            throw new UicException(ErrorCode.ACTIVITI_PARSER_CIRCULATION_ERROR);<br>        &#125;<br><br>        <span class="hljs-type">List</span>&lt;SequenceFlowNode&gt; sortSequenceFlowNodeList = new ArrayList&lt;&gt;();<br>        SequenceFlowNode iterator = startSequenceFlowNode;<br>        sortSequenceFlowNodeList.add(iterator);<br>        <span class="hljs-keyword">while</span> (true) &#123;<br>            String target = iterator.getTarget();<br>            iterator = source2SequenceFlowNodeMap.get(target);<br>            <span class="hljs-keyword">if</span> (iterator == null) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            sortSequenceFlowNodeList.add(iterator);<br>        &#125;<br>        <span class="hljs-keyword">return</span> sortSequenceFlowNodeList;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>最一般流程引擎的流程编排配置文件，是xml类型的，因此这里实现一个Xml配置文件的解析类，用于解析我们的xml流程文件，具体实现内容如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><code class="hljs python">package com.yang.infrastructure.flow.activiti.parser;<br><br><span class="hljs-keyword">import</span> com.yang.infrastructure.flow.activiti.enums.FlowNodeType;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.flow.activiti.model.ActivitiFlow;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.flow.activiti.model.FlowNode;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.flow.activiti.model.SequenceFlowNode;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.w3c.dom.Document;<br><span class="hljs-keyword">import</span> org.w3c.dom.NamedNodeMap;<br><span class="hljs-keyword">import</span> org.w3c.dom.Node;<br><span class="hljs-keyword">import</span> org.w3c.dom.NodeList;<br><span class="hljs-keyword">import</span> org.xml.sax.SAXException;<br><br><span class="hljs-keyword">import</span> javax.xml.parsers.DocumentBuilder;<br><span class="hljs-keyword">import</span> javax.xml.parsers.DocumentBuilderFactory;<br><span class="hljs-keyword">import</span> javax.xml.parsers.ParserConfigurationException;<br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.<span class="hljs-type">List</span>;<br><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">XmlActivitiFileParser</span> extends AbstractActivitiFileParser &#123;<br>    private static final String ACTIVITI_PREFIX = <span class="hljs-string">&quot;yang-engine&quot;</span>;<br><br><span class="hljs-meta">    @Override</span><br>    public ActivitiFlow parseActivitiFlow(String fileName) &#123;<br>       <span class="hljs-keyword">return</span> parseActivitiFlow(ACTIVITI_PREFIX, fileName);<br>    &#125;<br><br>    public ActivitiFlow parseActivitiFlow(String directory, String fileName) &#123;<br>        String fullFileName = directory + File.separator + fileName;<br>        InputStream inputStream = this.getClass().getClassLoader().getResourceAsStream(fullFileName);<br>        DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();<br>        <span class="hljs-keyword">try</span> &#123;<br>            DocumentBuilder db = dbf.newDocumentBuilder();<br>            Document document = db.parse(inputStream);<br>            // 解析出流程节点<br>            <span class="hljs-type">List</span>&lt;FlowNode&gt; flowNodeList = parseFlowNodeList(document);<br>            // 解析流程执行顺序<br>            <span class="hljs-type">List</span>&lt;SequenceFlowNode&gt; sequenceFlowNodeList = parseSequenceFlowNodeList(document);<br>            String activitiId = parseActivitiId(document);<br>            <span class="hljs-keyword">if</span> (StringUtils.isEmpty(activitiId)) &#123;<br>                activitiId = fileName;<br>            &#125;<br>            <span class="hljs-keyword">return</span> buildActivitiFlow(activitiId, flowNodeList, sequenceFlowNodeList);<br>        &#125; catch (ParserConfigurationException e) &#123;<br>            throw new RuntimeException(e);<br>        &#125; catch (IOException e) &#123;<br>            throw new RuntimeException(e);<br>        &#125; catch (SAXException e) &#123;<br>            throw new RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    /**<br>     * 解析流程<span class="hljs-built_in">id</span><br>     * @param document<br>     * @<span class="hljs-keyword">return</span><br>     */<br>    private String parseActivitiId(Document document) &#123;<br>        NodeList nodeList = document.getElementsByTagName(<span class="hljs-string">&quot;activiti&quot;</span>);<br>        Node activitiNode = nodeList.item(<span class="hljs-number">0</span>);<br>        NamedNodeMap attributes = activitiNode.getAttributes();<br>        Node <span class="hljs-built_in">id</span> = attributes.getNamedItem(<span class="hljs-string">&quot;id&quot;</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">id</span> != null) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">id</span>.getNodeValue();<br>        &#125;<br>        <span class="hljs-keyword">return</span> null;<br>    &#125;<br><br>    /**<br>     * 解析流程节点列表<br>     * @param document<br>     * @<span class="hljs-keyword">return</span><br>     */<br>    private <span class="hljs-type">List</span>&lt;FlowNode&gt; parseFlowNodeList(Document document) &#123;<br>        <span class="hljs-type">List</span>&lt;FlowNode&gt; flowNodeList = new ArrayList&lt;&gt;();<br>        NodeList activitiNodeList = document.getElementsByTagName(<span class="hljs-string">&quot;activiti&quot;</span>);<br>        <span class="hljs-keyword">if</span> (activitiNodeList.getLength() &lt;= <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> flowNodeList;<br>        &#125;<br>        Node activitiNode = activitiNodeList.item(<span class="hljs-number">0</span>);<br>        NodeList nodeList = activitiNode.getChildNodes();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; nodeList.getLength(); i++) &#123;<br>            Node node = nodeList.item(i);<br>            FlowNodeType flowNodeType = FlowNodeType.parseByCode(node.getNodeName());<br>            <span class="hljs-keyword">if</span> (flowNodeType == null || flowNodeType == FlowNodeType.SEQUENCE_FLOW) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            NamedNodeMap attributes = node.getAttributes();<br>            FlowNode flowNode = parseFlowNode(attributes, flowNodeType);<br>            flowNodeList.add(flowNode);<br>        &#125;<br>        <span class="hljs-keyword">return</span> flowNodeList;<br>    &#125;<br><br>    /**<br>     * 解析流程节点<br>     * @param attributes<br>     * @param flowNodeType<br>     * @<span class="hljs-keyword">return</span><br>     */<br>    private FlowNode parseFlowNode(NamedNodeMap attributes, FlowNodeType flowNodeType) &#123;<br>        <span class="hljs-keyword">if</span> (attributes == null || attributes.getLength() &lt;= <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> null;<br>        &#125;<br>        FlowNode flowNode = new FlowNode();<br>        Node idNode = attributes.getNamedItem(<span class="hljs-string">&quot;id&quot;</span>);<br>        Node nameNode = attributes.getNamedItem(<span class="hljs-string">&quot;name&quot;</span>);<br>        Node descriptionNode = attributes.getNamedItem(<span class="hljs-string">&quot;description&quot;</span>);<br>        Node classNode = attributes.getNamedItem(<span class="hljs-string">&quot;class&quot;</span>);<br>        <span class="hljs-keyword">if</span> (idNode == null) &#123;<br>            <span class="hljs-keyword">return</span> null;<br>        &#125;<br>        flowNode.setId(idNode.getNodeValue());<br>        <span class="hljs-keyword">if</span> (nameNode != null) &#123;<br>            flowNode.setName(nameNode.getNodeValue());<br>        &#125;<br>        <span class="hljs-keyword">if</span> (descriptionNode != null) &#123;<br>            flowNode.setDescription(descriptionNode.getNodeValue());<br>        &#125;<br>        <span class="hljs-keyword">if</span> (classNode != null) &#123;<br>            flowNode.setClassPath(classNode.getNodeValue());<br>        &#125;<br>        flowNode.setFlowNodeType(flowNodeType);<br>        richFlowNode(flowNode, flowNodeType);<br>        <span class="hljs-keyword">return</span> flowNode;<br>    &#125;<br><br>    /**<br>     * 解析流程执行顺序节点列表<br>     * @param document<br>     * @<span class="hljs-keyword">return</span><br>     */<br>    private <span class="hljs-type">List</span>&lt;SequenceFlowNode&gt; parseSequenceFlowNodeList(Document document) &#123;<br>        NodeList nodeList = document.getElementsByTagName(FlowNodeType.SEQUENCE_FLOW.getCode());<br>        <span class="hljs-type">List</span>&lt;SequenceFlowNode&gt; sequenceFlowNodes = new ArrayList&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; nodeList.getLength(); i++) &#123;<br>            Node node = nodeList.item(i);<br>            NamedNodeMap attributes = node.getAttributes();<br>            SequenceFlowNode sequenceFlowNode = parseSequenceFlowNode(attributes);<br>            <span class="hljs-keyword">if</span> (sequenceFlowNode != null) &#123;<br>                sequenceFlowNodes.add(sequenceFlowNode);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> sequenceFlowNodes;<br>    &#125;<br><br>    /**<br>     * 解析流程执行顺序节点<br>     * @param attributes<br>     * @<span class="hljs-keyword">return</span><br>     */<br>    private SequenceFlowNode parseSequenceFlowNode(NamedNodeMap attributes) &#123;<br>        Node sourceNode = attributes.getNamedItem(<span class="hljs-string">&quot;source&quot;</span>);<br>        Node targetNode = attributes.getNamedItem(<span class="hljs-string">&quot;target&quot;</span>);<br>        <span class="hljs-keyword">if</span> (sourceNode != null &amp;&amp; targetNode != null) &#123;<br>            SequenceFlowNode sequenceFlowNode = new SequenceFlowNode();<br>            sequenceFlowNode.setSource(sourceNode.getNodeValue());<br>            sequenceFlowNode.setTarget(targetNode.getNodeValue());<br>            <span class="hljs-keyword">return</span> sequenceFlowNode;<br>        &#125;<br>        <span class="hljs-keyword">return</span> null;<br>    &#125;<br><br>    public static void main(String[] args) &#123;<br>        IActivitiFileParser activitiFileParser = new XmlActivitiFileParser();<br>        ActivitiFlow activitiFlow = activitiFileParser.parseActivitiFlow(<span class="hljs-string">&quot;register_flow.xml&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><img src="/2024/10/04/%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E4%B8%B2%E8%A1%8C%E6%B5%81%E7%A8%8B%E5%AE%9E%E7%8E%B0/1.png" class=""><p>最后添加对应的测试方法，测试上述方式是否能成功解析流程引擎配置文件：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@Test</span><br>  public void testParseActivitiFile() &#123;<br>      IActivitiFileParser iActivitiFileParser = new XmlActivitiFileParser();<br>      ActivitiFlow activitiFlow = iActivitiFileParser.parseActivitiFlow(<span class="hljs-string">&quot;register_flow.xml&quot;</span>);<br>      <span class="hljs-keyword">for</span> (FlowNode flowNode : activitiFlow.getFlowNodeList()) &#123;<br>          System.out.println(flowNode);<br>      &#125;<br>      System.out.println(activitiFlow);<br>  &#125;<br></code></pre></td></tr></table></figure><p>解析结果如下：</p><img src="/2024/10/04/%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E4%B8%B2%E8%A1%8C%E6%B5%81%E7%A8%8B%E5%AE%9E%E7%8E%B0/2.png" class=""><h3 id="懒加载流程到缓存中"><a href="#懒加载流程到缓存中" class="headerlink" title="懒加载流程到缓存中"></a>懒加载流程到缓存中</h3><p>创建ActivitiFlow流程管理类，在第一次获取ActivitiFlow，将其加载到缓存中，以减少后续的流程配置文件解析次数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python">package com.yang.infrastructure.flow.activiti;<br><br><span class="hljs-keyword">import</span> com.yang.infrastructure.common.ErrorCode;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.common.exception.UicException;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.flow.activiti.model.ActivitiFlow;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.flow.activiti.parser.IActivitiFileParser;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.utils.SpringContextUtil;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivitiFlowManager</span> &#123;<br>    private static Map&lt;String, ActivitiFlow&gt; id2ActivitiFlowCache = new HashMap&lt;&gt;();<br><br>    public static ActivitiFlow getActivitiFlow(String flowName) &#123;<br>        ActivitiFlow activitiFlow = id2ActivitiFlowCache.get(flowName);<br>        <span class="hljs-keyword">if</span> (activitiFlow != null) &#123;<br>            <span class="hljs-keyword">return</span> activitiFlow;<br>        &#125;<br>        IActivitiFileParser iActivitiFileParser = SpringContextUtil.getBeanByType(IActivitiFileParser.<span class="hljs-keyword">class</span>);<br>        synchronized (flowName.intern()) &#123;<br>            activitiFlow = id2ActivitiFlowCache.get(flowName);<br>            <span class="hljs-keyword">if</span> (activitiFlow != null) &#123;<br>                <span class="hljs-keyword">return</span> activitiFlow;<br>            &#125;<br>            activitiFlow = iActivitiFileParser.parseActivitiFlow(flowName);<br>            <span class="hljs-keyword">if</span> (activitiFlow == null) &#123;<br>                throw new UicException(ErrorCode.ACTIVITI_NOT_FOUND_ERROR);<br>            &#125;<br>            id2ActivitiFlowCache.put(flowName, activitiFlow);<br>        &#125;<br>        <span class="hljs-keyword">return</span> activitiFlow;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="流程引擎执行"><a href="#流程引擎执行" class="headerlink" title="流程引擎执行"></a>流程引擎执行</h3><p>定义流程引擎入参和出参，这里采用泛形的方式，定义对应的入参和出参，因为我们流程引擎不感知具体的业务参数类型，只需提供一个通用的底层交互协议。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-meta">@Data</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivitiEngineRequest</span> &lt;T&gt; implements Serializable &#123;<br><br>    /**<br>     * 场景code<br>     */<br>    private String scenarioCode;<br><br>    private T baseRequest;<br>&#125;<br><br><br><br><span class="hljs-meta">@Data</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivitiEngineResponse</span> &lt;T&gt; implements Serializable &#123;<br>    /**<br>     * 场景code<br>     */<br>    private String scenarioCode;<br><br>    private T response;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后我们定义流程引擎执行接口</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">public interface IActivitiService &#123;<br>    void execute(ActivitiEngineRequest request, ActivitiEngineResponse response);<br>&#125;<br></code></pre></td></tr></table></figure><p>对于startEvent, endEvent, serviceTask这几种流程节点类型，依次去实现对应的IActivitiService，因为目前暂时只用到serviceTask，所以下面只列出serviceTask的实现</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><br>public interface IServiceTask&lt;DomainRequest, DomainResponse&gt; extends IActivitiService &#123;<br>    default void execute(ActivitiEngineRequest request, ActivitiEngineResponse response) &#123;<br>        DomainRequest domainRequest = buildDomainRequest(request, response);<br>        <span class="hljs-keyword">if</span> (domainRequest != null) &#123;<br>            DomainResponse domainResponse = apply(domainRequest);<br>            attachment(domainResponse, response);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        doElse(request, response);<br>    &#125;<br><br>    /**<br>     * 默认不实现，一般先转为domain Request，然后调用领域层方法，进行转化，doElse适用于目前领域层无法支持相关实现，顾需要在activity层进行适配的逻辑<br>     * @param request<br>     * @param response<br>     */<br>    default void doElse(ActivitiEngineRequest request, ActivitiEngineResponse response) &#123;&#125;<br><br>    /**<br>     * 入参转化<br>     * @param request<br>     * @param response<br>     * @<span class="hljs-keyword">return</span><br>     */<br>    DomainRequest buildDomainRequest(ActivitiEngineRequest request, ActivitiEngineResponse response);<br><br>    /**<br>     * 领域服务调用<br>     * @param domainRequest<br>     * @<span class="hljs-keyword">return</span><br>     */<br>    DomainResponse apply(DomainRequest domainRequest);<br><br>    /**<br>     * 领域服务调用结果填充<br>     * @param domainResponse<br>     * @param response<br>     */<br>    void attachment(DomainResponse domainResponse, ActivitiEngineResponse response);<br>&#125;<br></code></pre></td></tr></table></figure><p>在IServiceTask的流程引擎调用中，这里的实现思路是将流程引擎入参先转化为对应的领域入参，然后调用领域服务执行对应的领域操作，最后，将领域服务返回结果，转化或填充到我们的流程引擎出参当中。示例代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-meta">@Component</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">EncryptPasswordActivity</span> implements IServiceTask&lt;UserPasswordEncryptDomainRequest, UserPasswordEncryptDomainResponse&gt; &#123;<br><span class="hljs-meta">    @Autowired</span><br>    private UserPasswordDomainService userPasswordDomainService;<br><br><span class="hljs-meta">    @Override</span><br>    public UserPasswordEncryptDomainRequest buildDomainRequest(ActivitiEngineRequest request, ActivitiEngineResponse response) &#123;<br>        RegisterRequest registerRequest = (RegisterRequest) request.getBaseRequest();<br>        UserPasswordEncryptDomainRequest userPasswordEncryptDomainRequest = new UserPasswordEncryptDomainRequest();<br><br>        String encryptType = registerRequest.getExtendMaps().get(<span class="hljs-string">&quot;encryptType&quot;</span>);<br>        EncryptTypeEnum encryptTypeEnum = EncryptTypeEnum.parseByType(encryptType);<br>        userPasswordEncryptDomainRequest.setEncryptType(encryptTypeEnum);<br>        userPasswordEncryptDomainRequest.setPlainPassword(registerRequest.getPassword());<br>        <span class="hljs-keyword">return</span> userPasswordEncryptDomainRequest;<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public UserPasswordEncryptDomainResponse apply(UserPasswordEncryptDomainRequest userPasswordEncryptDomainRequest) &#123;<br>        <span class="hljs-keyword">return</span> userPasswordDomainService.encryptPassword(userPasswordEncryptDomainRequest);<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public void attachment(UserPasswordEncryptDomainResponse userPasswordEncryptDomainResponse, ActivitiEngineResponse response) &#123;<br>        UserModel userModel = (UserModel) response.getResponse();<br>        userModel.setEncryptPassword(userPasswordEncryptDomainResponse.getEncryptPassword());<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>但是这有一个缺陷，就是我们的领域服务一般都是比较原子的，当我们要执行的操作涉及多个原子操作时，上面这种思路就无法支撑，所以这里加了一个doElse来兼容，示例代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-meta">@Component</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserConflictCheckActivity</span> implements IServiceTask&lt;UserQueryDomainRequest, UserQueryDomainResponse&gt; &#123;<br><span class="hljs-meta">    @Autowired</span><br>    private UserDomainService userDomainService;<br><br><span class="hljs-meta">    @Override</span><br>    public UserQueryDomainRequest buildDomainRequest(ActivitiEngineRequest request, ActivitiEngineResponse response) &#123;<br>        <span class="hljs-keyword">return</span> null;<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public UserQueryDomainResponse apply(UserQueryDomainRequest userQueryDomainRequest) &#123;<br>        <span class="hljs-keyword">return</span> null;<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public void doElse(ActivitiEngineRequest request, ActivitiEngineResponse response) &#123;<br>        RegisterRequest registerRequest = (RegisterRequest) request.getBaseRequest();<br>        <span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(registerRequest.getLoginId())) &#123;<br>            UserQueryDomainRequest userQueryDomainRequest = new UserQueryDomainRequest.UserQueryDomainRequestBuilder()<br>                    .userQueryType(UserQueryType.LOGIN_ID)<br>                    .queryMessage(registerRequest.getLoginId())<br>                    .build();<br>            UserQueryDomainResponse userQueryDomainResponse = userDomainService.query(userQueryDomainRequest);<br>            <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(userQueryDomainResponse.getUserAccountList())) &#123;<br>                throw new UicException(ErrorCode.USER_CONFLICT_ERROR);<br>            &#125;<br>        &#125;<br>        UserQueryDomainRequest userQueryDomainRequest = new UserQueryDomainRequest.UserQueryDomainRequestBuilder()<br>                .userQueryType(UserQueryType.EMAIL)<br>                .queryMessage(registerRequest.getEmail())<br>                .build();<br>        UserQueryDomainResponse userQueryDomainResponse = userDomainService.query(userQueryDomainRequest);<br>        <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(userQueryDomainResponse.getUserAccountList())) &#123;<br>            throw new UicException(ErrorCode.USER_CONFLICT_ERROR);<br>        &#125;<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public void attachment(UserQueryDomainResponse userQueryDomainResponse, ActivitiEngineResponse response) &#123;<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>最后，我们修改ActivitiFlowManager, 增加执行方法，执行的思路是，先解析对应的流程配置，然后根据流程节点类型，依次执行对应的流程方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivitiFlowManager</span> &#123;<br>    private static Map&lt;String, ActivitiFlow&gt; id2ActivitiFlowCache = new HashMap&lt;&gt;();<br><br>    public static ActivitiFlow getActivitiFlow(String flowName) &#123;<br>        ActivitiFlow activitiFlow = id2ActivitiFlowCache.get(flowName);<br>        <span class="hljs-keyword">if</span> (activitiFlow != null) &#123;<br>            <span class="hljs-keyword">return</span> activitiFlow;<br>        &#125;<br>        IActivitiFileParser iActivitiFileParser = SpringContextUtil.getBeanByType(IActivitiFileParser.<span class="hljs-keyword">class</span>);<br>        synchronized (flowName.intern()) &#123;<br>            activitiFlow = id2ActivitiFlowCache.get(flowName);<br>            <span class="hljs-keyword">if</span> (activitiFlow != null) &#123;<br>                <span class="hljs-keyword">return</span> activitiFlow;<br>            &#125;<br>            activitiFlow = iActivitiFileParser.parseActivitiFlow(flowName);<br>            <span class="hljs-keyword">if</span> (activitiFlow == null) &#123;<br>                throw new UicException(ErrorCode.ACTIVITI_NOT_FOUND_ERROR);<br>            &#125;<br>            id2ActivitiFlowCache.put(flowName, activitiFlow);<br>        &#125;<br>        <span class="hljs-keyword">return</span> activitiFlow;<br>    &#125;<br><br>    /**<br>     * 流程引擎执行方法<br>     * @param flowName<br>     * @param activitiEngineRequest<br>     * @<span class="hljs-keyword">return</span><br>     * @param &lt;Request&gt;<br>     * @param &lt;Response&gt;<br>     */<br>    public static &lt;Request, Response&gt; ActivitiEngineResponse&lt;Response&gt; startEngine(String flowName,<br>                                                                                   ActivitiEngineRequest&lt;Request&gt; activitiEngineRequest) &#123;<br>        ActivitiFlow activitiFlow = getActivitiFlow(flowName);<br>        ActivitiEngineResponse&lt;Response&gt; activitiEngineResponse = new ActivitiEngineResponse&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (FlowNode flowNode : activitiFlow.getFlowNodeList()) &#123;<br>            FlowNodeType flowNodeType = flowNode.getFlowNodeType();<br>            switch (flowNodeType) &#123;<br>                <span class="hljs-keyword">case</span> START_EVENT:<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> END_EVENT:<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> SERVICE_TASK:<br>                    executeServiceTask(activitiEngineRequest, activitiEngineResponse, flowNode);<br>                    <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> activitiEngineResponse;<br>    &#125;<br><br>    private static &lt;Request, Response&gt; void executeServiceTask(ActivitiEngineRequest&lt;Request&gt; activitiEngineRequest, ActivitiEngineResponse&lt;Response&gt; activitiEngineResponse, FlowNode flowNode) &#123;<br>        IServiceTask iServiceTask = (IServiceTask) flowNode.getTarget();<br>        iServiceTask.execute(activitiEngineRequest, activitiEngineResponse);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>测试代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">  @Override</span><br>   public ResultT&lt;String&gt; register2(RegisterRequest registerRequest) &#123;<br>       ActivitiEngineRequest&lt;RegisterRequest&gt; activitiEngineRequest = new ActivitiEngineRequest&lt;&gt;();<br>       activitiEngineRequest.setBaseRequest(registerRequest);<br>       ActivitiEngineResponse&lt;UserModel&gt; activitiEngineResponse = ActivitiFlowManager.startEngine(<span class="hljs-string">&quot;register_flow.xml&quot;</span>, activitiEngineRequest);<br>       UserModel userModel = activitiEngineResponse.getResponse();<br>       <span class="hljs-keyword">if</span> (userModel != null &amp;&amp; userModel.getUserToken() != null) &#123;<br>           String token = userModel.getUserToken().getToken();<br>           <span class="hljs-keyword">return</span> ResultT.success(token);<br>       &#125;<br>       <span class="hljs-keyword">return</span> ResultT.fail();<br>   &#125;<br><br><br><br><span class="hljs-meta">@Test</span><br>   public void testEngineRegister() &#123;<br>       RegisterRequest registerRequest = new RegisterRequest();<br>       registerRequest.setLoginId(<span class="hljs-string">&quot;test1&quot;</span>);<br>       registerRequest.setEmail(<span class="hljs-string">&quot;2827523200@qq.com&quot;</span>);<br>       registerRequest.setPassword(<span class="hljs-string">&quot;hello1234&quot;</span>);<br>       ResultT&lt;String&gt; resultT = userService.register2(registerRequest);<br>       System.out.println(resultT);<br>       System.out.println(resultT.getData());<br>   &#125;<br></code></pre></td></tr></table></figure><p>执行结果如下：</p><img src="/2024/10/04/%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E4%B8%B2%E8%A1%8C%E6%B5%81%E7%A8%8B%E5%AE%9E%E7%8E%B0/3.png" class="">]]></content>
    
    
    
    <tags>
      
      <tag>工作积累</tag>
      
      <tag>流程引擎</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Service层瘦身思考</title>
    <link href="/2024/10/04/Service%E5%B1%82%E7%98%A6%E8%BA%AB%E6%80%9D%E8%80%83/"/>
    <url>/2024/10/04/Service%E5%B1%82%E7%98%A6%E8%BA%AB%E6%80%9D%E8%80%83/</url>
    
    <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>传统的MVC架构中，业务逻辑一般在service层实现，但随着业务的发展，service层也在不断充斥、嵌入各种业务逻辑代码，导致service层代码过于臃肿、庞大，不利于代码的维护和业务的后续迭代发展。此时我们需要对service层进行瘦身，以达到职责分离、高内聚低耦合的效果。</p><p>下面以注册链路为例，讲述如何通过各种方式，对service层的注册逻辑进行瘦身，简化，从而降低代码复杂度，并达到职责分离的效果。</p><h3 id="注册链路实现"><a href="#注册链路实现" class="headerlink" title="注册链路实现"></a>注册链路实现</h3><p>我们以用户注册为例，对于用户注册，在业务逻辑方面，依次需要进行下列操作：</p><ul><li>注册表单数据校验</li><li>账号冲突定位</li><li>密码加密处理</li><li>用户权限处理</li><li>创建用户</li><li>下发登录态</li></ul><h4 id="service层实现业务逻辑"><a href="#service层实现业务逻辑" class="headerlink" title="service层实现业务逻辑"></a>service层实现业务逻辑</h4><h5 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h5><p>在传统的MVC架构中，对于注册逻辑，属于业务层逻辑，因此会在service层进行实现，具体实现内容如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@Override</span><br>  public ResultT&lt;String&gt; register(RegisterRequest registerRequest) &#123;<br>      // 注册表单参数校验<br>      checkRegisterForm(registerRequest);<br>      // 账号冲突定位<br>      checkUserConflict(registerRequest);<br><br>      UserDO userDO = convert2DO(registerRequest);<br>      // 密码加密<br>      richPassword(userDO);<br>      // 权限设置<br>      richRole(userDO);<br>      <span class="hljs-keyword">if</span> (userMapper.insert(userDO) &gt; <span class="hljs-number">0</span>) &#123;<br>          // 创建账号成功，下发登录态<br>          String token = createLoginToken(userDO);<br>          <span class="hljs-keyword">return</span> ResultT.success(token);<br>      &#125;<br>      <span class="hljs-keyword">return</span> ResultT.fail();<br>  &#125;<br><br>  /**<br>   * 下发登录态<br>   * @param userDO<br>   * @<span class="hljs-keyword">return</span><br>   */<br>  private String createLoginToken(UserDO userDO) &#123;<br>      // mock 下发登录态<br>      <span class="hljs-keyword">return</span> UUID.randomUUID().toString();<br>  &#125;<br><br>  /**<br>   * 权限设置<br>   * @param userDO<br>   */<br>  private void richRole(UserDO userDO) &#123;<br>      // mock 先使用默认权限<br>      userDO.setRole(UserRoleConstant.DEFAULT_ROLE.toString());<br>  &#125;<br><br>  /**<br>   * 密码加密<br>   * @param userDO<br>   */<br>  private void richPassword(UserDO userDO) &#123;<br>      // mock 先不对密码做处理<br>      userDO.setPassword(userDO.getPlainPassword());<br>  &#125;<br><br>  /**<br>   * 账号冲突校验<br>   * @param registerRequest<br>   */<br>  private void checkUserConflict(RegisterRequest registerRequest) &#123;<br>      <span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(registerRequest.getLoginId())) &#123;<br>          LambdaQueryWrapper&lt;UserDO&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();<br>          queryWrapper.eq(UserDO::getLoginId, registerRequest.getLoginId());<br>          Integer count = userMapper.selectCount(queryWrapper);<br>          <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>              throw new UicException(ErrorCode.USER_CONFLICT_ERROR);<br>          &#125;<br>      &#125;<br>      LambdaQueryWrapper&lt;UserDO&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();<br>      queryWrapper.eq(UserDO::getEmail, registerRequest.getEmail());<br>      Integer count = userMapper.selectCount(queryWrapper);<br>      <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>          throw new UicException(ErrorCode.USER_CONFLICT_ERROR);<br>      &#125;<br>  &#125;<br><br>  /**<br>   * 注册表单参数校验<br>   * @param registerRequest<br>   */<br>  private void checkRegisterForm(RegisterRequest registerRequest) &#123;<br>      <span class="hljs-keyword">if</span> (StringUtils.isEmpty(registerRequest.getEmail()) || StringUtils.isEmpty(registerRequest.getPassword())) &#123;<br>          throw new UicException(ErrorCode.PARAM_VALIDATE_ERROR);<br>      &#125;<br>  &#125;<br><br>  private UserDO convert2DO(RegisterRequest registerRequest) &#123;<br>      UserDO userDO = new UserDO();<br>      userDO.setLoginId(registerRequest.getLoginId());<br>      <span class="hljs-keyword">if</span> (StringUtils.isEmpty(userDO.getLoginId())) &#123;<br>          userDO.setLoginId(UUID.randomUUID().toString().replaceAll(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>));<br>      &#125;<br>      userDO.setEmail(registerRequest.getEmail());<br>      userDO.setPlainPassword(registerRequest.getPassword());<br>      userDO.setCreateTime(new Date());<br>      userDO.setUpdateTime(new Date());<br>      <span class="hljs-keyword">return</span> userDO;<br>  &#125;<br></code></pre></td></tr></table></figure><h5 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h5><p>在上述代码中，将每一个步骤都抽取为对应的方法，思路相对比较清晰，但这建立在业务逻辑相对稳定、简单的前提下，当后续业务逻辑开始改动，比如需要使用md5对密码进行加密、根据入参决定用户权限、通过jwt创建登录态token等等，此时我们虽然能在这些方法的基础上进行修改或新增，但是这些方法后续会越来越大，不利于后续的维护，此外，我们将这些步骤都堆积在service类中，不利于后续的职责分离。</p><h4 id="抽象为执行类依次执行"><a href="#抽象为执行类依次执行" class="headerlink" title="抽象为执行类依次执行"></a>抽象为执行类依次执行</h4><h5 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h5><p>每一个方法对应一个职责，我们通过将这些逻辑，抽取为一个个执行类，并通过枚举将这些执行类的执行顺序进行编排。</p><img src="/2024/10/04/Service%E5%B1%82%E7%98%A6%E8%BA%AB%E6%80%9D%E8%80%83/1.png" class=""><p>交互图如下：</p><img src="/2024/10/04/Service%E5%B1%82%E7%98%A6%E8%BA%AB%E6%80%9D%E8%80%83/2.png" class=""><p>代码实现如下：</p><p>首先定义IFlow、IFlowExecutor、IFlowContext，然后定义AbstractFlow抽象类，实现流程执行器的增加、获取</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python">public interface IFlow &#123;<br>    <span class="hljs-type">List</span>&lt;IFlowExecutor&gt; getFlowExecutors();<br><br>    default void execute(IFlowContext iFlowContext) &#123;<br>        <span class="hljs-type">List</span>&lt;IFlowExecutor&gt; flowExecutors = getFlowExecutors();<br>        <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(flowExecutors)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (IFlowExecutor flowExecutor : flowExecutors) &#123;<br>            flowExecutor.execute(iFlowContext);<br>        &#125;<br>    &#125;<br>&#125;<br><br>public interface IFlowContext &#123;<br>&#125;<br><br><br>public interface IFlowExecutor &#123;<br>    void execute(IFlowContext iFlowContext);<br>&#125;<br><br><br>public abstract <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractFlow</span> implements IFlow &#123;<br>    protected <span class="hljs-type">List</span>&lt;IFlowExecutor&gt; iFlowExecutorList = new ArrayList&lt;&gt;();<br><br>    public <span class="hljs-type">List</span>&lt;IFlowExecutor&gt; getFlowExecutors() &#123;<br>        <span class="hljs-keyword">return</span> iFlowExecutorList;<br>    &#125;<br><br>    public void addFlowExecutor(IFlowExecutor executor) &#123;<br>        this.iFlowExecutorList.add(executor);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后依次实现表单校验、冲突校验、密码加密、权限设置、创建账号、登录态下发等执行器</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@Component</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">BuildUserTokenExecutor</span> implements IFlowExecutor &#123;<br><span class="hljs-meta">    @Autowired</span><br>    private JwtUtils jwtUtils;<br><br><span class="hljs-meta">    @Override</span><br>    public void execute(IFlowContext iFlowContext) &#123;<br>        RegisterFlowContext registerFlowContext = (RegisterFlowContext) iFlowContext;<br>        UserDO userDO = registerFlowContext.getUserDO();<br><br>        Map&lt;String, Object&gt; payloads = new HashMap&lt;&gt;();<br>        payloads.put(<span class="hljs-string">&quot;email&quot;</span>, userDO.getEmail());<br>        payloads.put(<span class="hljs-string">&quot;id&quot;</span>, userDO.getId());<br>        payloads.put(<span class="hljs-string">&quot;loginId&quot;</span>, userDO.getLoginId());<br>        payloads.put(<span class="hljs-string">&quot;role&quot;</span>, userDO.getRole());<br><br>        String token = jwtUtils.encrypt(userDO.getId().toString(), payloads);<br>        registerFlowContext.setToken(token);<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Component</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateUserExecutor</span> implements IFlowExecutor &#123;<br><span class="hljs-meta">    @Autowired</span><br>    private UserMapper userMapper;<br><br><span class="hljs-meta">    @Override</span><br>    public void execute(IFlowContext iFlowContext) &#123;<br>        RegisterFlowContext registerFlowContext = (RegisterFlowContext) iFlowContext;<br>        System.out.println(registerFlowContext);<br>        UserDO userDO = new UserDO();<br>        userDO.setLoginId(registerFlowContext.getLoginId());<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(userDO.getLoginId())) &#123;<br>            userDO.setLoginId(UUID.randomUUID().toString().replaceAll(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>));<br>        &#125;<br>        userDO.setEmail(registerFlowContext.getEmail());<br>        userDO.setPlainPassword(registerFlowContext.getPassword());<br>        userDO.setPassword(registerFlowContext.getEncryptPassword());<br>        userDO.setRole(registerFlowContext.getRoles());<br>        userDO.setCreateTime(new Date());<br>        userDO.setUpdateTime(new Date());<br>        Map&lt;String, String&gt; featureMap = new HashMap&lt;&gt;();<br>        featureMap.put(UserConstant.ENCRYPT_TYPE, registerFlowContext.getEncryptType());<br>        userDO.setFeatures(FeatureUtils.convert2Feature(featureMap));<br><br>        // 持久化数据库<br>        <span class="hljs-built_in">int</span> insert = userMapper.insert(userDO);<br>        <span class="hljs-keyword">if</span> (insert &lt;= <span class="hljs-number">0</span>) &#123;<br>            throw new UicException(ErrorCode.PERSISTENCE_DATA_ERROR);<br>        &#125;<br>        registerFlowContext.setUserDO(userDO);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-meta">@Component</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">EncryptPasswordExecutor</span> implements IFlowExecutor &#123;<br><span class="hljs-meta">    @Autowired</span><br>    private EncryptHandlerFactory encryptHandlerFactory;<br><br><span class="hljs-meta">    @Override</span><br>    public void execute(IFlowContext iFlowContext) &#123;<br>        RegisterFlowContext registerFlowContext = (RegisterFlowContext) iFlowContext;<br>        String encryptType = registerFlowContext.getEncryptType();<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(encryptType)) &#123;<br>            encryptType = EncryptTypeEnum.MD5.getType();<br>            registerFlowContext.setEncryptType(encryptType);<br>        &#125;<br>        IEncryptHandler iEncryptHandler = encryptHandlerFactory.getEncryptHandlerByType(encryptType);<br>        EncryptRequest encryptRequest = new EncryptRequest();<br>        encryptRequest.setPlainText(registerFlowContext.getPassword());<br>        String encryptPassword = iEncryptHandler.encrypt(encryptRequest);<br>        registerFlowContext.setEncryptPassword(encryptPassword);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-meta">@Component</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">RegisterFormCheckExecutor</span> implements IFlowExecutor &#123;<br><span class="hljs-meta">    @Override</span><br>    public void execute(IFlowContext iFlowContext) &#123;<br>        RegisterFlowContext registerFlowContext = (RegisterFlowContext) iFlowContext;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(registerFlowContext.getEmail())<br>                || StringUtils.isEmpty(registerFlowContext.getPassword())) &#123;<br>            throw new UicException(ErrorCode.PARAM_VALIDATE_ERROR);<br>        &#125;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-meta">@Component</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserConflictCheckExecutor</span> implements IFlowExecutor &#123;<br><span class="hljs-meta">    @Autowired</span><br>    private UserMapper userMapper;<br><br><span class="hljs-meta">    @Override</span><br>    public void execute(IFlowContext iFlowContext) &#123;<br>        RegisterFlowContext registerFlowContext = (RegisterFlowContext) iFlowContext;<br>        <span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(registerFlowContext.getLoginId())) &#123;<br>            LambdaQueryWrapper&lt;UserDO&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();<br>            queryWrapper.eq(UserDO::getLoginId, registerFlowContext.getLoginId());<br>            Integer count = userMapper.selectCount(queryWrapper);<br>            <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>                throw new UicException(ErrorCode.USER_CONFLICT_ERROR);<br>            &#125;<br>        &#125;<br>        LambdaQueryWrapper&lt;UserDO&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();<br>        queryWrapper.eq(UserDO::getEmail, registerFlowContext.getEmail());<br>        Integer count = userMapper.selectCount(queryWrapper);<br>        <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>            throw new UicException(ErrorCode.USER_CONFLICT_ERROR);<br>        &#125;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-meta">@Component</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRoleRichExecutor</span> implements IFlowExecutor &#123;<br><span class="hljs-meta">    @Override</span><br>    public void execute(IFlowContext iFlowContext) &#123;<br>        RegisterFlowContext registerFlowContext = (RegisterFlowContext) iFlowContext;<br>        UserRole userRole = new UserRole();<br>        String isSeller = registerFlowContext.getExtend(UserConstant.IS_SELLER);<br>        <span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(isSeller) &amp;&amp; Boolean.TRUE.toString().equals(isSeller)) &#123;<br>            userRole.addRole(UserRoleConstant.SELLER_ROLE);<br>        &#125;<br><br>        String isBuyer = registerFlowContext.getExtend(UserConstant.IS_BUYER);<br>        <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(isBuyer) &amp;&amp; Boolean.TRUE.toString().equals(isBuyer)) &#123;<br>            userRole.addRole(UserRoleConstant.BUYER_ROLE);<br>        &#125;<br><br>        registerFlowContext.setRoles(userRole.getRoles());<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>创建注册流程类</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">public <span class="hljs-keyword">class</span> <span class="hljs-title class_">RegisterFlow</span> extends AbstractFlow &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>最后，创建配置类，将这些执行器按照顺序添加到RegisterFlow注册流程中，从而实现流程执行器在流程中的编排</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-meta">@Configuration</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">FlowConfiguration</span> &#123;<br><span class="hljs-meta">    @DependsOn(<span class="hljs-params">&#123;<span class="hljs-string">&quot;registerFormCheckExecutor&quot;</span>, <span class="hljs-string">&quot;userConflictCheckExecutor&quot;</span>,</span></span><br><span class="hljs-params"><span class="hljs-meta">    <span class="hljs-string">&quot;encryptPasswordExecutor&quot;</span>, <span class="hljs-string">&quot;userRoleRichExecutor&quot;</span>,</span></span><br><span class="hljs-params"><span class="hljs-meta">    <span class="hljs-string">&quot;createUserExecutor&quot;</span>, <span class="hljs-string">&quot;buildUserTokenExecutor&quot;</span>&#125;</span>)</span><br><span class="hljs-meta">    @Bean</span><br>    public RegisterFlow registerFlow(@Qualifier(<span class="hljs-string">&quot;registerFormCheckExecutor&quot;</span>)IFlowExecutor registerFormCheckExecutor,<br><span class="hljs-meta">                                     @Qualifier(<span class="hljs-params"><span class="hljs-string">&quot;userConflictCheckExecutor&quot;</span></span>)IFlowExecutor userConflictCheckExecutor,</span><br><span class="hljs-meta">                                     @Qualifier(<span class="hljs-params"><span class="hljs-string">&quot;encryptPasswordExecutor&quot;</span></span>)IFlowExecutor encryptPasswordExecutor,</span><br><span class="hljs-meta">                                     @Qualifier(<span class="hljs-params"><span class="hljs-string">&quot;userRoleRichExecutor&quot;</span></span>)IFlowExecutor userRoleRichExecutor,</span><br><span class="hljs-meta">                                     @Qualifier(<span class="hljs-params"><span class="hljs-string">&quot;createUserExecutor&quot;</span></span>)IFlowExecutor createUserExecutor,</span><br><span class="hljs-meta">                                     @Qualifier(<span class="hljs-params"><span class="hljs-string">&quot;buildUserTokenExecutor&quot;</span></span>)IFlowExecutor buildUserTokenExecutor) &#123;</span><br>        RegisterFlow registerFlow = new RegisterFlow();<br>        registerFlow.addFlowExecutor(registerFormCheckExecutor);<br>        registerFlow.addFlowExecutor(userConflictCheckExecutor);<br>        registerFlow.addFlowExecutor(encryptPasswordExecutor);<br>        registerFlow.addFlowExecutor(userRoleRichExecutor);<br>        registerFlow.addFlowExecutor(createUserExecutor);<br>        registerFlow.addFlowExecutor(buildUserTokenExecutor);<br>        <span class="hljs-keyword">return</span> registerFlow;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>经过上述修改后，service层代码得到简化， 内容如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@Component</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> implements IUserService&#123;<br><span class="hljs-meta">    @Autowired</span><br>    private UserMapper userMapper;<br><br><span class="hljs-meta">    @Autowired</span><br>    private RegisterFlow registerFlow;<br><br><span class="hljs-meta">    @Override</span><br>    public UserDO getById(Integer <span class="hljs-built_in">id</span>) &#123;<br>        <span class="hljs-keyword">return</span> userMapper.selectById(<span class="hljs-built_in">id</span>);<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public ResultT&lt;String&gt; register(RegisterRequest registerRequest) &#123;<br>        RegisterFlowContext registerFlowContext = new RegisterFlowContext();<br>        registerFlowContext.setLoginId(registerRequest.getLoginId());<br>        registerFlowContext.setEmail(registerRequest.getEmail());<br>        registerFlowContext.setPassword(registerRequest.getPassword());<br>        <span class="hljs-keyword">if</span> (registerRequest.getExtendMaps() != null) &#123;<br>            registerRequest.getExtendMaps().forEach(registerFlowContext::putExtend);<br>        &#125;<br><br>        registerFlow.execute(registerFlowContext);<br>        <span class="hljs-keyword">return</span> ResultT.success(registerFlowContext.getToken());<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public boolean updateUser(UserDO userDO) &#123;<br>        <span class="hljs-keyword">return</span> false;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h5><p>上述方式虽然能将业务流程细分为不同的执行器，从而达到职责分离的作用，但是，当业务流程中，涉及分支判断，不同分支走不同业务逻辑时，上述实现方式较难支撑相关需求</p><h4 id="流程引擎实现流程编排"><a href="#流程引擎实现流程编排" class="headerlink" title="流程引擎实现流程编排"></a>流程引擎实现流程编排</h4><p>对于市面上常用的几种流程引擎，都包含下列几种功能：</p><ul><li>事件：开始事件、结束事件</li><li>活动activity：用户任务(User Task), 服务任务(Service Task) ，子流程(Sub Process)</li><li>网关GateWay：排他网关、并行网关、事件网关</li></ul><p>在我们之前提到将业务流程抽象为执行类依次执行，这里的执行类其实就相当于流程引擎的服务任务(Service Task)，而对于分支的判断，可以使用流程引擎的网关，此外，还可以通过用户任务，定位到当前节点，执行之前未完成、中断的流程。</p><h5 id="实现-2"><a href="#实现-2" class="headerlink" title="实现"></a>实现</h5><p>下面简单介绍注册流程如何通过流程引擎的服务任务编排实现。首先创建对应的流程文件：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> standalone=<span class="hljs-string">&quot;yes&quot;</span>?&gt;<br>&lt;activiti <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;register_flow&quot;</span>&gt;<br>    &lt;!--节点定义--&gt;<br>    &lt;startEvent <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;startEvent&quot;</span>/&gt;<br>    &lt;serviceTask <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;registerFormCheck&quot;</span> name=<span class="hljs-string">&quot;registerFormCheck&quot;</span> description=<span class="hljs-string">&quot;注册表单校验&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.application.register.activiti.RegisterFormCheckActivity&quot;</span>/&gt;<br>    &lt;serviceTask <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;userConflictCheck&quot;</span> name=<span class="hljs-string">&quot;userConflictCheck&quot;</span> description=<span class="hljs-string">&quot;用户冲突定位&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.application.register.activiti.UserConflictCheckActivity&quot;</span>/&gt;<br>    &lt;serviceTask <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;encryptPassword&quot;</span> name=<span class="hljs-string">&quot;encryptPassword&quot;</span> description=<span class="hljs-string">&quot;密码加密&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.application.register.activiti.EncryptPasswordActivity&quot;</span>/&gt;<br>    &lt;serviceTask <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;userRoleRich&quot;</span> name=<span class="hljs-string">&quot;userRoleRich&quot;</span> description=<span class="hljs-string">&quot;用户权限填充&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.application.register.activiti.UserRoleRichActivity&quot;</span>/&gt;<br>    &lt;serviceTask <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;createUser&quot;</span> name=<span class="hljs-string">&quot;createUser&quot;</span> description=<span class="hljs-string">&quot;创建用户&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.application.register.activiti.CreateUserActivity&quot;</span>/&gt;<br>    &lt;serviceTask <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;buildUserToken&quot;</span> name=<span class="hljs-string">&quot;buildUserToken&quot;</span> description=<span class="hljs-string">&quot;创建用户token&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;com.yang.application.register.activiti.BuildUserTokenActivity&quot;</span>/&gt;<br>    &lt;endEvent <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;endEvent&quot;</span>/&gt;<br><br>    &lt;!--节点执行顺序编排--&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;startEvent&quot;</span> target=<span class="hljs-string">&quot;registerFormCheck&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;registerFormCheck&quot;</span> target=<span class="hljs-string">&quot;userConflictCheck&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;userConflictCheck&quot;</span> target=<span class="hljs-string">&quot;encryptPassword&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;encryptPassword&quot;</span> target=<span class="hljs-string">&quot;userRoleRich&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;userRoleRich&quot;</span> target=<span class="hljs-string">&quot;createUser&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;createUser&quot;</span> target=<span class="hljs-string">&quot;buildUserToken&quot;</span>/&gt;<br>    &lt;sequenceFlow source=<span class="hljs-string">&quot;buildUserToken&quot;</span> target=<span class="hljs-string">&quot;endEvent&quot;</span>/&gt;<br>&lt;/activiti&gt;<br></code></pre></td></tr></table></figure><img src="/2024/10/04/Service%E5%B1%82%E7%98%A6%E8%BA%AB%E6%80%9D%E8%80%83/3.png" class=""><p>然后创建对应的服务任务：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@Component</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">RegisterFormCheckActivity</span> implements IServiceTask &#123;<br><span class="hljs-meta">    @Override</span><br>    public void doElse(ActivitiEngineRequest request, ActivitiEngineResponse response) &#123;<br>        RegisterRequest registerRequest = (RegisterRequest) request.getBaseRequest();<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(registerRequest.getEmail())<br>                || StringUtils.isEmpty(registerRequest.getPassword())) &#123;<br>            throw new UicException(ErrorCode.PARAM_VALIDATE_ERROR);<br>        &#125;<br>    &#125;<br><span class="hljs-meta">    @Override</span><br>    public Object buildDomainRequest(ActivitiEngineRequest request, ActivitiEngineResponse response) &#123;<br>        <span class="hljs-keyword">return</span> null;<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public Object apply(Object o) &#123;<br>        <span class="hljs-keyword">return</span> null;<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public void attachment(Object o, ActivitiEngineResponse response) &#123;<br><br>    &#125;<br>&#125;<br><br><br><span class="hljs-meta">@Component</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserConflictCheckActivity</span> implements IServiceTask&lt;UserQueryDomainRequest, UserQueryDomainResponse&gt; &#123;<br><span class="hljs-meta">    @Autowired</span><br>    private UserDomainService userDomainService;<br><br><span class="hljs-meta">    @Override</span><br>    public UserQueryDomainRequest buildDomainRequest(ActivitiEngineRequest request, ActivitiEngineResponse response) &#123;<br>        <span class="hljs-keyword">return</span> null;<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public UserQueryDomainResponse apply(UserQueryDomainRequest userQueryDomainRequest) &#123;<br>        <span class="hljs-keyword">return</span> null;<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public void doElse(ActivitiEngineRequest request, ActivitiEngineResponse response) &#123;<br>        RegisterRequest registerRequest = (RegisterRequest) request.getBaseRequest();<br>        <span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(registerRequest.getLoginId())) &#123;<br>            UserQueryDomainRequest userQueryDomainRequest = new UserQueryDomainRequest.UserQueryDomainRequestBuilder()<br>                    .userQueryType(UserQueryType.LOGIN_ID)<br>                    .queryMessage(registerRequest.getLoginId())<br>                    .build();<br>            UserQueryDomainResponse userQueryDomainResponse = userDomainService.query(userQueryDomainRequest);<br>            <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(userQueryDomainResponse.getUserAccountList())) &#123;<br>                throw new UicException(ErrorCode.USER_CONFLICT_ERROR);<br>            &#125;<br>        &#125;<br>        UserQueryDomainRequest userQueryDomainRequest = new UserQueryDomainRequest.UserQueryDomainRequestBuilder()<br>                .userQueryType(UserQueryType.EMAIL)<br>                .queryMessage(registerRequest.getEmail())<br>                .build();<br>        UserQueryDomainResponse userQueryDomainResponse = userDomainService.query(userQueryDomainRequest);<br>        <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(userQueryDomainResponse.getUserAccountList())) &#123;<br>            throw new UicException(ErrorCode.USER_CONFLICT_ERROR);<br>        &#125;<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public void attachment(UserQueryDomainResponse userQueryDomainResponse, ActivitiEngineResponse response) &#123;<br><br>    &#125;<br>&#125;<br><br><br><span class="hljs-meta">@Component</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">EncryptPasswordActivity</span> implements IServiceTask&lt;UserPasswordEncryptDomainRequest, UserPasswordEncryptDomainResponse&gt; &#123;<br><span class="hljs-meta">    @Autowired</span><br>    private UserPasswordDomainService userPasswordDomainService;<br><br><span class="hljs-meta">    @Override</span><br>    public UserPasswordEncryptDomainRequest buildDomainRequest(ActivitiEngineRequest request, ActivitiEngineResponse response) &#123;<br>        RegisterRequest registerRequest = (RegisterRequest) request.getBaseRequest();<br>        UserPasswordEncryptDomainRequest userPasswordEncryptDomainRequest = new UserPasswordEncryptDomainRequest();<br><br>        String encryptType = null;<br>        <span class="hljs-keyword">if</span> (registerRequest.getExtendMaps() != null) &#123;<br>            registerRequest.getExtendMaps().get(<span class="hljs-string">&quot;encryptType&quot;</span>);<br>        &#125;<br>        EncryptTypeEnum encryptTypeEnum = EncryptTypeEnum.parseByType(encryptType);<br>        userPasswordEncryptDomainRequest.setEncryptType(encryptTypeEnum);<br>        userPasswordEncryptDomainRequest.setPlainPassword(registerRequest.getPassword());<br>        <span class="hljs-keyword">return</span> userPasswordEncryptDomainRequest;<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public UserPasswordEncryptDomainResponse apply(UserPasswordEncryptDomainRequest userPasswordEncryptDomainRequest) &#123;<br>        <span class="hljs-keyword">return</span> userPasswordDomainService.encryptPassword(userPasswordEncryptDomainRequest);<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public void attachment(UserPasswordEncryptDomainResponse userPasswordEncryptDomainResponse, ActivitiEngineResponse response) &#123;<br>        UserModel userModel = (UserModel) response.getResponse();<br>        <span class="hljs-keyword">if</span> (userModel == null) &#123;<br>            userModel = new UserModel();<br>            response.setResponse(userModel);<br>        &#125;<br>        userModel.setEncryptPassword(userPasswordEncryptDomainResponse.getEncryptPassword());<br>    &#125;<br>&#125;<br><br><br><span class="hljs-meta">@Component</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRoleRichActivity</span> implements IServiceTask&lt;UserRoleApplyDomainRequest, UserRoleApplyDomainResponse&gt; &#123;<br><span class="hljs-meta">    @Autowired</span><br>    private UserRoleDomainService userRoleDomainService;<br><br><span class="hljs-meta">    @Override</span><br>    public UserRoleApplyDomainRequest buildDomainRequest(ActivitiEngineRequest request, ActivitiEngineResponse response) &#123;<br>        RegisterRequest registerRequest = (RegisterRequest) request.getBaseRequest();<br>        UserRoleApplyDomainRequest userRoleApplyDomainRequest = new UserRoleApplyDomainRequest();<br>        <span class="hljs-keyword">if</span> (registerRequest.getExtendMaps() != null) &#123;<br>            userRoleApplyDomainRequest.setFeatureMap(registerRequest.getExtendMaps());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            userRoleApplyDomainRequest.setFeatureMap(new HashMap&lt;&gt;());<br>        &#125;<br>        <span class="hljs-keyword">return</span> userRoleApplyDomainRequest;<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public UserRoleApplyDomainResponse apply(UserRoleApplyDomainRequest userRoleApplyDomainRequest) &#123;<br>        <span class="hljs-keyword">return</span> userRoleDomainService.applyUserRole(userRoleApplyDomainRequest);<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public void attachment(UserRoleApplyDomainResponse userRoleApplyDomainResponse, ActivitiEngineResponse response) &#123;<br>        UserModel userModel = (UserModel) response.getResponse();<br>        userModel.setUserRole(userRoleApplyDomainResponse.getUserRole());<br>    &#125;<br>&#125;<br><br><br><span class="hljs-meta">@Component</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateUserActivity</span> implements IServiceTask&lt;UserCreateDomainRequest, UserCreateDomainResponse&gt; &#123;<br><span class="hljs-meta">    @Autowired</span><br>    private UserDomainService userDomainService;<br><br><span class="hljs-meta">    @Override</span><br>    public UserCreateDomainRequest buildDomainRequest(ActivitiEngineRequest request, ActivitiEngineResponse response) &#123;<br>        RegisterRequest registerRequest = (RegisterRequest) request.getBaseRequest();<br>        UserModel userModel = (UserModel) response.getResponse();<br>        UserCreateDomainRequest userCreateDomainRequest = new UserCreateDomainRequest();<br>        userCreateDomainRequest.setLoginId(registerRequest.getLoginId());<br>        userCreateDomainRequest.setEmail(registerRequest.getEmail());<br>        Map&lt;String, String&gt; featureMap = new HashMap&lt;&gt;();<br>        <span class="hljs-keyword">if</span> (userModel.getUserRole() != null) &#123;<br>            userCreateDomainRequest.setRoles(userModel.getUserRole().getRoles());<br>        &#125;<br>        <span class="hljs-keyword">if</span> (userModel.getEncryptPassword() != null) &#123;<br>            userCreateDomainRequest.setPlainPassword(userModel.getEncryptPassword().getPlainPassword());<br>            userCreateDomainRequest.setPassword(userModel.getEncryptPassword().getEncryptPassword());<br>            featureMap.put(<span class="hljs-string">&quot;encryptType&quot;</span>, userModel.getEncryptPassword().getEncryptType().getType());<br>        &#125;<br>        userCreateDomainRequest.setFeatureMap(featureMap);<br><br>        UserAccount userAccount = convert2UserAccount(userCreateDomainRequest);<br>        userModel.setUserAccount(userAccount);<br>        <span class="hljs-keyword">return</span> userCreateDomainRequest;<br>    &#125;<br><br>    private UserAccount convert2UserAccount(UserCreateDomainRequest userCreateDomainRequest) &#123;<br>        UserAccount userAccount = new UserAccount();<br>        userAccount.setLoginId(userCreateDomainRequest.getLoginId());<br>        userAccount.setEmail(userCreateDomainRequest.getEmail());<br>        userAccount.setFeatureMap(userCreateDomainRequest.getFeatureMap());<br>        <span class="hljs-keyword">return</span> userAccount;<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public UserCreateDomainResponse apply(UserCreateDomainRequest userCreateDomainRequest) &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(userCreateDomainRequest.getLoginId())) &#123;<br>            userCreateDomainRequest.setLoginId(UUID.randomUUID().toString().replaceAll(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>));<br>        &#125;<br>        <span class="hljs-keyword">return</span> userDomainService.createUser(userCreateDomainRequest);<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public void attachment(UserCreateDomainResponse userCreateDomainResponse, ActivitiEngineResponse response) &#123;<br>        <span class="hljs-keyword">if</span> (userCreateDomainResponse.isSuccess()) &#123;<br>            UserModel userModel = (UserModel) response.getResponse();<br>            userModel.getUserAccount().setId(userCreateDomainResponse.getUserId());<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        throw new UicException(ErrorCode.PERSISTENCE_DATA_ERROR);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-meta">@Component</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">BuildUserTokenActivity</span> implements IServiceTask&lt;ApplyTokenDomainRequest, TokenDomainResponse&gt; &#123;<br><span class="hljs-meta">    @Autowired</span><br>    private UserTokenDomainService userTokenDomainService;<br><br><span class="hljs-meta">    @Override</span><br>    public ApplyTokenDomainRequest buildDomainRequest(ActivitiEngineRequest request, ActivitiEngineResponse response) &#123;<br>        UserModel userModel = (UserModel) response.getResponse();<br>        ApplyTokenDomainRequest applyTokenDomainRequest = new ApplyTokenDomainRequest();<br>        applyTokenDomainRequest.setUserId(userModel.getId());<br>        UserAccount userAccount = userModel.getUserAccount();<br>        Map&lt;String, String&gt; attachments = new HashMap&lt;&gt;();<br>        attachments.put(<span class="hljs-string">&quot;email&quot;</span>, userAccount.getEmail());<br>        attachments.put(<span class="hljs-string">&quot;loginId&quot;</span>, userAccount.getLoginId());<br>        <span class="hljs-keyword">if</span> (userModel.getUserRole() != null) &#123;<br>            attachments.put(<span class="hljs-string">&quot;roles&quot;</span>, userModel.getUserRole().getRoles());<br>        &#125;<br>        applyTokenDomainRequest.setAttachments(attachments);<br>        <span class="hljs-keyword">return</span> applyTokenDomainRequest;<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public TokenDomainResponse apply(ApplyTokenDomainRequest applyTokenDomainRequest) &#123;<br>        <span class="hljs-keyword">return</span> userTokenDomainService.applyToken(applyTokenDomainRequest);<br>    &#125;<br><br><span class="hljs-meta">    @Override</span><br>    public void attachment(TokenDomainResponse tokenDomainResponse, ActivitiEngineResponse response) &#123;<br>        UserTokenModel userToken = tokenDomainResponse.getUserToken();<br>        UserModel userModel = (UserModel) response.getResponse();<br>        userModel.setUserToken(userToken);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后我们修改service类，加上执行流程引擎的注册方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@Override</span><br>   public ResultT&lt;String&gt; register2(RegisterRequest registerRequest) &#123;<br>       ActivitiEngineRequest&lt;RegisterRequest&gt; activitiEngineRequest = new ActivitiEngineRequest&lt;&gt;();<br>       activitiEngineRequest.setBaseRequest(registerRequest);<br>       ActivitiEngineResponse&lt;UserModel&gt; activitiEngineResponse = ActivitiFlowManager.startEngine(<span class="hljs-string">&quot;register_flow.xml&quot;</span>, activitiEngineRequest);<br>       UserModel userModel = activitiEngineResponse.getResponse();<br>       <span class="hljs-keyword">if</span> (userModel != null &amp;&amp; userModel.getUserToken() != null) &#123;<br>           String token = userModel.getUserToken().getToken();<br>           <span class="hljs-keyword">return</span> ResultT.success(token);<br>       &#125;<br>       <span class="hljs-keyword">return</span> ResultT.fail();<br>   &#125;<br></code></pre></td></tr></table></figure><p>添加测试方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@Test</span><br>    public void testEngineRegister() &#123;<br>        RegisterRequest registerRequest = new RegisterRequest();<br>        registerRequest.setLoginId(<span class="hljs-string">&quot;test2&quot;</span>);<br>        registerRequest.setEmail(<span class="hljs-string">&quot;2827523201@qq.com&quot;</span>);<br>        registerRequest.setPassword(<span class="hljs-string">&quot;hello1234&quot;</span>);<br>        ResultT&lt;String&gt; resultT = userService.register2(registerRequest);<br>        System.out.println(resultT);<br>        System.out.println(resultT.getData());<br>    &#125;<br></code></pre></td></tr></table></figure><p>执行结果如下：</p><img src="/2024/10/04/Service%E5%B1%82%E7%98%A6%E8%BA%AB%E6%80%9D%E8%80%83/4.png" class=""><h5 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h5><ul><li>学习成本高：流程引擎涉及的概念较多，包括流程设计、执行、监控和优化等，此外流程引擎对程序员业务逻辑的理解能力要求较高，如何对业务流程进行拆分？拆分的粒度是多少？都是值得考量的问题。</li><li>使用成本高：大多数流程引擎需要引入数据库来记录流程执行上下文，导致使用成本、维护成本增加。</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>工作积累</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>手撸XXL-JOB（四）—远程调用定时任务</title>
    <link href="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"/>
    <url>/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/</url>
    
    <content type="html"><![CDATA[<h3 id="Java-Socket网络编程"><a href="#Java-Socket网络编程" class="headerlink" title="Java Socket网络编程"></a>Java Socket网络编程</h3><p>网络编程是Java编程中的重要组成部分，包括服务端和客户端两部分内容。Socket是Java网络编程的基本组件之一，用于在应用程序之间提供双向通信，Socket提供了一种标准的接口，允许应用程序通过网络发送和接收数据，在Java中，Socket可以分为客户端Socket和服务端Socket两种类型。<br>客户端Socket：客户端 Socket 用于与服务端 Socket 进行通信。客户端 Socket 通过指定服务端的 IP 地址和端口号，连接到服务端 Socket，然后发送数据到服务端 Socket。<br>服务端Socket：服务端 Socket 用于接收来自客户端 Socket 的连接请求，并在连接成功后，与客户端 Socket 进行通信。服务端 Socket 首先需要创建一个 ServerSocket 对象，并通过 bind 方法绑定到一个本地端口，然后等待客户端 Socket 的连接请求。<br>下面是Socket的一个示例：<br>服务端：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.demo1;<br><br><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><span class="hljs-keyword">import</span> java.net.ServerSocket;<br><span class="hljs-keyword">import</span> java.net.Socket;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ServerSocket</span> <span class="hljs-variable">serverSocket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerSocket</span>(<span class="hljs-number">8000</span>);<br>            System.out.println(<span class="hljs-string">&quot;Server started, waiting for client...&quot;</span>);<br><br>            <span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> serverSocket.accept();<br>            System.out.println(<span class="hljs-string">&quot;Client connected.&quot;</span>);<br><br>            <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(socket.getInputStream()));<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(socket.getOutputStream(), <span class="hljs-literal">true</span>);<br><br>            String message;<br>            <span class="hljs-keyword">while</span> ((message = in.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                System.out.println(<span class="hljs-string">&quot;Client:&quot;</span> + message);<br>                out.println(<span class="hljs-string">&quot;Server received message:&quot;</span> + message);<br>            &#125;<br><br>            in.close();<br>            out.close();<br>            socket.close();<br>            serverSocket.close();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>客户端：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.demo1;<br><br><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><span class="hljs-keyword">import</span> java.net.Socket;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Socket</span>(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">8000</span>);<br>            System.out.println(<span class="hljs-string">&quot;Connected to server.&quot;</span>);<br><br>            <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(socket.getInputStream()));<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(socket.getOutputStream(), <span class="hljs-literal">true</span>);<br><br>            <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">consoleIn</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(System.in));<br>            String message;<br>            <span class="hljs-keyword">while</span> ((message = consoleIn.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                out.println(message);<br>                System.out.println(<span class="hljs-string">&quot;Server:&quot;</span> + in.readLine());<br>            &#125;<br>            consoleIn.close();<br>            in.close();<br>            out.close();<br>            socket.close();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>首先启动服务端，然后启动客户端，在客户端的控制台，输入数据，服务端能接收到数据并返回对应的响应。</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/1.png" class=""><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/2.png" class=""><h3 id="远程调用定时任务"><a href="#远程调用定时任务" class="headerlink" title="远程调用定时任务"></a>远程调用定时任务</h3><p>首先，我们创建两个模块，core模块包含yang-job的一些核心内容，比如IJobExecutor执行器、JobExecuteRequest执行器请求等；client模块依赖core模块，并封装和socket客户端调用相关的一些内容。<br>然后创建一个sample1模块，用于演示。</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/3.png" class=""><h4 id="core模块"><a href="#core模块" class="headerlink" title="core模块"></a>core模块</h4><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/4.png" class=""><p>core目前定义了定时任务执行类和其入参、出参等信息，其中，YangJobTransferDTO包含任务类路径和任务请求，如下所示：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs typescript">package com.<span class="hljs-property">yang</span>.<span class="hljs-property">job</span>.<span class="hljs-property">dto</span>;<br><br><span class="hljs-keyword">import</span> com.<span class="hljs-property">yang</span>.<span class="hljs-property">job</span>.<span class="hljs-property">execute</span>.<span class="hljs-property">YangJobExecuteRequest</span>;<br><br><span class="hljs-keyword">import</span> java.<span class="hljs-property">io</span>.<span class="hljs-property">Serializable</span>;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YangJobTransferDTO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> className;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">YangJobExecuteRequest</span> yangJobExecuteRequest;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getClassName</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> className;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setClassName</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> className</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">className</span> = className;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">YangJobExecuteRequest</span> <span class="hljs-title function_">getYangJobExecuteRequest</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> yangJobExecuteRequest;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setYangJobExecuteRequest</span>(<span class="hljs-params">YangJobExecuteRequest yangJobExecuteRequest</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">yangJobExecuteRequest</span> = yangJobExecuteRequest;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="client模块"><a href="#client模块" class="headerlink" title="client模块"></a>client模块</h4><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/5.png" class=""><p>client模块定义了客户端所需要的一些类，其中，YangJob为注解类，对于每一个定时任务，需要加上YangJob注解，才能被正确调用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.job.client.annotations;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.*;<br><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> YangJob &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>YangJobClientProperty为配置信息类，目前需要两个配置信息，客户端socket的ip和端口号</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs typescript">package com.<span class="hljs-property">yang</span>.<span class="hljs-property">job</span>.<span class="hljs-property">client</span>.<span class="hljs-property">configuration</span>;<br><br><br><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">beans</span>.<span class="hljs-property">factory</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Value</span>;<br><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">stereotype</span>.<span class="hljs-property">Component</span>;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YangJobClientProperty</span> &#123;<br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">&quot;$&#123;yang-job.executor.port&#125;&quot;</span>)<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Integer</span> port;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">&quot;$&#123;yang-job.executor.ip&#125;&quot;</span>)<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> ip;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Integer</span> <span class="hljs-title function_">getPort</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> port;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setPort</span>(<span class="hljs-params">Integer port</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">port</span> = port;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getIp</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> ip;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setIp</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> ip</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">ip</span> = ip;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>YangJobClientPostProcessor在SpringBoot加载完毕后，扫描bean，将实现IYongJobExecutor的bean，注册到YangJobClientManager的map中，方便后续调用</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">package</span> com.yang.job.client.schema;<br><br><br><span class="hljs-keyword">import</span> com.yang.job.client.annotations.YangJob;<br><span class="hljs-keyword">import</span> com.yang.job.client.YangJobClientManager;<br><span class="hljs-keyword">import</span> com.yang.job.execute.IYangJobExecutor;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeansException;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.config.BeanPostProcessor;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YangJobClientPostProcessor</span> <span class="hljs-title">implements</span> <span class="hljs-title">BeanPostProcessor</span> &#123;<br>    <span class="hljs-keyword">public</span> Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException &#123;<br>        <span class="hljs-keyword">if</span> (!(bean instanceof IYangJobExecutor)) &#123;<br>            <span class="hljs-keyword">return</span> bean;<br>        &#125;<br>        YangJob <span class="hljs-keyword">annotation</span> = bean.getClass().getAnnotation(YangJob.<span class="hljs-keyword">class</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">annotation</span> == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> bean;<br>        &#125;<br>        YangJobClientManager.putJobExecutor(bean.getClass().getName(), (IYangJobExecutor) bean);<br>        <span class="hljs-keyword">return</span> bean;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>YangJobClientManager负责监听端口和管理定时任务的执行，它会监听我们配置的yang-job.execute.port端口号，然后当接收到消息时，将消息转为入参，并取出对应的定时任务执行类，执行对应的代码。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.job.client;<br><br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.yang.job.client.dto.YangJobClientPropertyDTO;<br><span class="hljs-keyword">import</span> com.yang.job.core.dto.YangJobTransferDTO;<br><span class="hljs-keyword">import</span> com.yang.job.core.dto.ResultT;<br><span class="hljs-keyword">import</span> com.yang.job.core.execute.IYangJobExecutor;<br><span class="hljs-keyword">import</span> com.yang.job.core.execute.YangJobExecuteRequest;<br><br><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><span class="hljs-keyword">import</span> java.net.ServerSocket;<br><span class="hljs-keyword">import</span> java.net.Socket;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentHashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YangJobClientManager</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, IYangJobExecutor&gt; className2JobExecutorMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">private</span> YangJobClientPropertyDTO yangJobClientPropertyDTO;<br><br>    <span class="hljs-keyword">private</span> ServerSocket serverSocket;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">YangJobClientManager</span><span class="hljs-params">(YangJobClientPropertyDTO yangJobClientPropertyDTO)</span> &#123;<br>        <span class="hljs-built_in">this</span>.yangJobClientPropertyDTO = yangJobClientPropertyDTO;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.yangJobClientPropertyDTO.getPort();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.serverSocket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerSocket</span>(port);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;init success============&quot;</span>);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> serverSocket.accept();<br>                    <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">bufferedReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(socket.getInputStream()));<br>                    <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">printWriter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(socket.getOutputStream(), <span class="hljs-literal">true</span>);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> bufferedReader.readLine();<br>                    <span class="hljs-type">YangJobTransferDTO</span> <span class="hljs-variable">yangJobTransferDTO</span> <span class="hljs-operator">=</span> JSONObject.parseObject(params, YangJobTransferDTO.class);<br>                    System.out.println(yangJobTransferDTO);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> yangJobTransferDTO.getClassName();<br>                    <span class="hljs-type">YangJobExecuteRequest</span> <span class="hljs-variable">yangJobExecuteRequest</span> <span class="hljs-operator">=</span> yangJobTransferDTO.getYangJobExecuteRequest();<br>                    <span class="hljs-type">IYangJobExecutor</span> <span class="hljs-variable">jobExecutor</span> <span class="hljs-operator">=</span> getJobExecutor(className);<br>                    <span class="hljs-keyword">if</span> (jobExecutor != <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-type">ResultT</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> jobExecutor.execute(yangJobExecuteRequest);<br>                        printWriter.println(JSONObject.toJSONString(response));<br>                    &#125;<br>                    bufferedReader.close();<br>                    printWriter.close();<br>                    socket.close();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>                <span class="hljs-keyword">if</span> (serverSocket.isClosed() || serverSocket == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>        &#125;).start();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.serverSocket != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-built_in">this</span>.serverSocket.close();<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> YangJobClientPropertyDTO <span class="hljs-title function_">getYangJobPropertyDTO</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.yangJobClientPropertyDTO;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putJobExecutor</span><span class="hljs-params">(String className, IYangJobExecutor iJobExecutor)</span> &#123;<br>        className2JobExecutorMap.put(className, iJobExecutor);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IYangJobExecutor <span class="hljs-title function_">getJobExecutor</span><span class="hljs-params">(String className)</span> &#123;<br>        <span class="hljs-keyword">return</span> className2JobExecutorMap.get(className);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>YangJobClientContext为客户端的上下文，负责监听SpringBoot刷新消息和关闭消息，并执行对应的操作。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs csharp">package com.yang.job.client;<br><br><br>import com.yang.job.client.utils.SpringContextUtils;<br>import org.springframework.context.ApplicationContext;<br>import org.springframework.context.ApplicationListener;<br>import org.springframework.context.<span class="hljs-keyword">event</span>.ApplicationContextEvent;<br>import org.springframework.context.<span class="hljs-keyword">event</span>.ContextClosedEvent;<br>import org.springframework.context.<span class="hljs-keyword">event</span>.ContextRefreshedEvent;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">YangJobClientContext</span> <span class="hljs-title">implements</span> <span class="hljs-title">ApplicationListener</span>&lt;<span class="hljs-title">ApplicationContextEvent</span>&gt; &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> YangJobClientContext instance;<br><br>    <span class="hljs-keyword">private</span> ApplicationContext applicationContext;<br><br>    @Override<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onApplicationEvent</span>(<span class="hljs-params">ApplicationContextEvent <span class="hljs-keyword">event</span></span>)</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">event</span> instanceof ContextRefreshedEvent) &#123;<br>            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;刷新了=========&quot;</span>);<br>            YangJobClientContext.instance = <span class="hljs-keyword">this</span>;<br>            instance.applicationContext = applicationContext;<br>            <span class="hljs-keyword">init</span>();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">event</span> instanceof ContextClosedEvent) &#123;<br>            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;销毁了=========&quot;</span>);<br>            shutdown();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span>()</span> &#123;<br>        YangJobClientManager yangJobClientManager = SpringContextUtils.getBeanOfType(YangJobClientManager.<span class="hljs-keyword">class</span>);<br>        yangJobClientManager.<span class="hljs-keyword">init</span>();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">shutdown</span>()</span> &#123;<br>        YangJobClientManager yangJobClientManager = SpringContextUtils.getBeanOfType(YangJobClientManager.<span class="hljs-keyword">class</span>);<br>        yangJobClientManager.shutdown();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>YangJobClientConfiguration为配置类，负责对YangJobClientPostProcessor、YangJobClientManager和YangJobClientContext的统一配置管理。</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">package</span> com.yang.job.client.configuration;<br><br><br><span class="hljs-keyword">import</span> com.yang.job.client.YangJobClientManager;<br><span class="hljs-keyword">import</span> com.yang.job.client.YangJobClientContext;<br><span class="hljs-keyword">import</span> com.yang.job.client.dto.YangJobClientPropertyDTO;<br><span class="hljs-keyword">import</span> com.yang.job.client.schema.YangJobClientPostProcessor;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-title class_"><span class="hljs-keyword">class</span> <span class="hljs-title">YangJobClientConfiguration</span> </span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> YangJobClientProperty yangJobClientProperty;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> YangJobClientPostProcessor yangJobPostProcessor() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">YangJobClientPostProcessor</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> YangJobClientManager yangJobClientManager() &#123;<br>        YangJobClientPropertyDTO yangJobClientPropertyDTO = <span class="hljs-keyword">new</span> <span class="hljs-type">YangJobClientPropertyDTO</span>();<br>        yangJobClientPropertyDTO.setIp(yangJobClientProperty.getIp());<br>        yangJobClientPropertyDTO.setPort(yangJobClientProperty.getPort());<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">YangJobClientManager</span>(yangJobClientPropertyDTO);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> YangJobClientContext yangJobContext() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">YangJobClientContext</span>();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>最后，为了使引入client依赖的应用，能自动装配我们提供的bean，我们在resources目录下创建META-INF目录，在该目录下创建spring.factories文件，文件内容如下：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.boot</span><span class="hljs-selector-class">.autoconfigure</span>.EnableAutoConfiguration=\<br>  com<span class="hljs-selector-class">.yang</span><span class="hljs-selector-class">.job</span><span class="hljs-selector-class">.client</span><span class="hljs-selector-class">.utils</span><span class="hljs-selector-class">.SpringContextUtils</span>,\<br>  com<span class="hljs-selector-class">.yang</span><span class="hljs-selector-class">.job</span><span class="hljs-selector-class">.client</span><span class="hljs-selector-class">.configuration</span><span class="hljs-selector-class">.YangJobClientProperty</span>,\<br>  com<span class="hljs-selector-class">.yang</span><span class="hljs-selector-class">.job</span><span class="hljs-selector-class">.client</span><span class="hljs-selector-class">.configuration</span>.YangJobClientConfiguration<br></code></pre></td></tr></table></figure><h4 id="sample1"><a href="#sample1" class="headerlink" title="sample1"></a>sample1</h4><p>我们创建一个sample1项目，引入spring-boot-starter-web依赖和yang-client，yang-core的依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.yang<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>yang-job-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.yang<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>yang-job-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><p>创建启动类</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript">package com.<span class="hljs-property">yang</span>.<span class="hljs-property">job</span>.<span class="hljs-property">sample1</span>;<br><br><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">SpringApplication</span>;<br><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">autoconfigure</span>.<span class="hljs-property">SpringBootApplication</span>;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YangJobSample1App</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) &#123;<br>        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">YangJobSample1App</span>.<span class="hljs-property">class</span>, args);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>创建一个任务类：</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">package</span> com.yang.job.sample1.task;<br><br><span class="hljs-keyword">import</span> com.yang.job.client.annotations.YangJob;<br><span class="hljs-keyword">import</span> com.yang.job.dto.ResultT;<br><span class="hljs-keyword">import</span> com.yang.job.execute.IYangJobExecutor;<br><span class="hljs-keyword">import</span> com.yang.job.execute.YangJobExecuteRequest;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@YangJob</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestTask1</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IYangJobExecutor</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function">ResultT <span class="hljs-title">execute</span><span class="hljs-params">(YangJobExecuteRequest yangJobExecuteRequest)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;开启定时任务了，入参为:&quot;</span> + yangJobExecuteRequest);<br>        <span class="hljs-function"><span class="hljs-keyword">return</span> ResultT.<span class="hljs-title">success</span><span class="hljs-params">()</span></span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>添加配置文件，因为client模块的YangJobClientProperty需要有yang-job.executor.port和yang-job.executor.ip这两个配置，如果我们的配置文件中，缺少这些配置，会导致报错，无法启动项目。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">YangJobSample1App</span><br><span class="hljs-attr">yang-job:</span><br>  <span class="hljs-attr">executor:</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">9999</span><br>    <span class="hljs-attr">ip:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8001</span><br></code></pre></td></tr></table></figure><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>我们先启动刚才的sample1项目，然后执行下列代码，来远程调用TestTask1方法执行类。</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> void main(<span class="hljs-keyword">String</span>[] args) &#123;<br>       <span class="hljs-keyword">try</span> &#123;<br>           Socket socket = <span class="hljs-keyword">new</span> <span class="hljs-type">Socket</span>(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">9999</span>);<br>           System.out.println(<span class="hljs-string">&quot;链接成功=============&quot;</span>);<br>           PrintWriter printWriter = <span class="hljs-keyword">new</span> <span class="hljs-type">PrintWriter</span>(socket.getOutputStream(), <span class="hljs-literal">true</span>);<br>           BufferedReader bufferedReader = <span class="hljs-keyword">new</span> <span class="hljs-type">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">InputStreamReader</span>(socket.getInputStream()));<br>           YangJobExecuteRequest yangJobExecuteRequest = <span class="hljs-keyword">new</span> <span class="hljs-type">YangJobExecuteRequest</span>();<br>           yangJobExecuteRequest.setJobId(<span class="hljs-string">&quot;1&quot;</span>);<br>           yangJobExecuteRequest.addParam(<span class="hljs-string">&quot;num&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);<br>           YangJobTransferDTO yangJobTransferDTO = <span class="hljs-keyword">new</span> <span class="hljs-type">YangJobTransferDTO</span>();<br>           yangJobTransferDTO.setClassName(<span class="hljs-string">&quot;com.yang.job.sample1.task.TestTask1&quot;</span>);<br>           yangJobTransferDTO.setYangJobExecuteRequest(yangJobExecuteRequest);<br><br>           printWriter.println(JSONObject.toJSONString(yangJobTransferDTO));<br>           System.out.println(<span class="hljs-string">&quot;response:&quot;</span> + bufferedReader.readLine());<br>           bufferedReader.close();<br>           printWriter.close();<br>           socket.close();<br>       &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>           e.printStackTrace();<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><p>执行结果如下，说明我们能成功地进行远程调用。</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/6.png" class=""><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/7.png" class=""><h3 id="添加远程任务"><a href="#添加远程任务" class="headerlink" title="添加远程任务"></a>添加远程任务</h3><h4 id="domain层"><a href="#domain层" class="headerlink" title="domain层"></a>domain层</h4><p>在上一篇文章中，我们操作的任务，都是本地任务，现在我们需要对远程任务进行操作，为了区分任务类型，我们首先在domain层添加一个任务类型枚举</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs typescript">package com.<span class="hljs-property">yang</span>.<span class="hljs-property">job</span>.<span class="hljs-property">admin</span>.<span class="hljs-property">domain</span>.<span class="hljs-property">enums</span>;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">JobTypeEnum</span> &#123;<br>    <span class="hljs-title function_">LOCAL</span>(<span class="hljs-string">&quot;local&quot;</span>, <span class="hljs-string">&quot;本地任务&quot;</span>),<br>    <span class="hljs-title function_">REMOTE</span>(<span class="hljs-string">&quot;remote&quot;</span>, <span class="hljs-string">&quot;远程任务&quot;</span>);<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> name;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> description;<br><br>    <span class="hljs-title class_">JobTypeEnum</span>(<span class="hljs-title class_">String</span> name, <span class="hljs-title class_">String</span> description) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">description</span> = description;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getName</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getDescription</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> description;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">JobTypeEnum</span> <span class="hljs-title function_">getJobTypeByName</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> name</span>) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">JobTypeEnum</span> value : <span class="hljs-title function_">values</span>()) &#123;<br>            <span class="hljs-keyword">if</span> (value.<span class="hljs-title function_">getName</span>().<span class="hljs-title function_">equals</span>(name)) &#123;<br>                <span class="hljs-keyword">return</span> value;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后修改YangJobModel，添加上任务类型枚举和远程任务信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.job.admin.domain.model;<br><br><br><span class="hljs-keyword">import</span> com.yang.job.admin.client.dto.common.BusinessException;<br><span class="hljs-keyword">import</span> com.yang.job.admin.client.dto.common.ErrorCode;<br><span class="hljs-keyword">import</span> com.yang.job.admin.domain.enums.JobExecuteStrategyEnum;<br><span class="hljs-keyword">import</span> com.yang.job.admin.domain.enums.JobTypeEnum;<br><span class="hljs-keyword">import</span> com.yang.job.admin.domain.event.SaveJobPostEvent;<br><span class="hljs-keyword">import</span> com.yang.job.admin.domain.event.SubmitJobPostEvent;<br><span class="hljs-keyword">import</span> com.yang.job.admin.domain.event.UpdateJobPostEvent;<br><span class="hljs-keyword">import</span> com.yang.job.admin.domain.valueobject.RemoteExecutorMessage;<br><span class="hljs-keyword">import</span> com.yang.job.admin.infra.event.EventCenter;<br><span class="hljs-keyword">import</span> com.yang.job.admin.infra.job.YangJobManager;<br><span class="hljs-keyword">import</span> com.yang.job.admin.infra.job.request.YangJobSubmitParam;<br><span class="hljs-keyword">import</span> com.yang.job.admin.infra.utils.CronUtils;<br><span class="hljs-keyword">import</span> com.yang.job.admin.infra.utils.SpringContextUtils;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.time.ZonedDateTime;<br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YangJobModel</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> Integer jobId;<br><br>    <span class="hljs-keyword">private</span> String jobName;<br><br>    <span class="hljs-keyword">private</span> String description;<br><br>    <span class="hljs-keyword">private</span> String cron;<br><br>    <span class="hljs-keyword">private</span> String executeClassPath;<br><br>    <span class="hljs-keyword">private</span> Runnable runnable;<br><br>    <span class="hljs-keyword">private</span> JobExecuteStrategyEnum executeStrategy;<br><br>    <span class="hljs-keyword">private</span> JobTypeEnum jobType;<br><br>    <span class="hljs-keyword">private</span> RemoteExecutorMessage remoteExecutorMessage;<br><br>    <span class="hljs-keyword">private</span> Integer enable;<br><br>    <span class="hljs-keyword">private</span> Integer open;<br><br>    <span class="hljs-keyword">private</span> Date createTime;<br><br>    <span class="hljs-keyword">private</span> Date updateTime;<br><br>    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; featureMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; executeParamMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnable</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.enable == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.enable == <span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isOpen</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (!isEnable()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.open == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.open == <span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isClose</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> !isOpen();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isLocalJob</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> JobTypeEnum.LOCAL == <span class="hljs-built_in">this</span>.jobType;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isRemoteJob</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> JobTypeEnum.REMOTE == <span class="hljs-built_in">this</span>.jobType;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setExecuteStrategy</span><span class="hljs-params">(JobExecuteStrategyEnum jobExecuteStrategyEnum)</span> &#123;<br>        <span class="hljs-keyword">if</span> (jobExecuteStrategyEnum == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.EXECUTE_STRATEGY_NO_EXIST);<br>        &#125;<br>        <span class="hljs-built_in">this</span>.executeStrategy = jobExecuteStrategyEnum;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">submitJob</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">YangJobSubmitParam</span> <span class="hljs-variable">yangJobSubmitParam</span> <span class="hljs-operator">=</span> convert2YangJobSubmitParam();<br>        <span class="hljs-type">YangJobManager</span> <span class="hljs-variable">yangJobManager</span> <span class="hljs-operator">=</span> getYangJobManager();<br>        yangJobManager.submitJob(yangJobSubmitParam);<br>        <span class="hljs-comment">// 提交任务后，发送提交任务后置事件</span><br>        <span class="hljs-type">SubmitJobPostEvent</span> <span class="hljs-variable">submitJobPostEvent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SubmitJobPostEvent</span>(yangJobSubmitParam);<br>        getEventCenter().postEvent(submitJobPostEvent);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancelJob</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">YangJobManager</span> <span class="hljs-variable">yangJobManager</span> <span class="hljs-operator">=</span> getYangJobManager();<br>        yangJobManager.cancelJob(<span class="hljs-built_in">this</span>.jobId);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> YangJobSubmitParam <span class="hljs-title function_">convert2YangJobSubmitParam</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">YangJobSubmitParam</span> <span class="hljs-variable">yangJobBuildParam</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">YangJobSubmitParam</span>();<br>        yangJobBuildParam.setJobId(<span class="hljs-built_in">this</span>.jobId);<br>        yangJobBuildParam.setRunnable(<span class="hljs-built_in">this</span>.runnable);<br>        <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">nextExecutionTime</span> <span class="hljs-operator">=</span> CronUtils.nextExecutionTime(<span class="hljs-built_in">this</span>.cron, ZonedDateTime.now());<br>        <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">nextNextExecutionTime</span> <span class="hljs-operator">=</span> CronUtils.nextExecutionTime(<span class="hljs-built_in">this</span>.cron, nextExecutionTime);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">nowEochMill</span> <span class="hljs-operator">=</span> ZonedDateTime.now().toInstant().toEpochMilli();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">executeEochMill</span> <span class="hljs-operator">=</span> nextExecutionTime.toInstant().toEpochMilli();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">secondExecuteEochMill</span> <span class="hljs-operator">=</span> nextNextExecutionTime.toInstant().toEpochMilli();<br>        yangJobBuildParam.setInitialDelay((<span class="hljs-type">int</span>)(executeEochMill - nowEochMill) / <span class="hljs-number">1000</span>);<br>        yangJobBuildParam.setPeriod((<span class="hljs-type">int</span>)(secondExecuteEochMill - executeEochMill) / <span class="hljs-number">1000</span>);<br>        yangJobBuildParam.setJobExecuteStrategy(<span class="hljs-built_in">this</span>.executeStrategy);<br>        <span class="hljs-keyword">return</span> yangJobBuildParam;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postSaveJobEvent</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">SaveJobPostEvent</span> <span class="hljs-variable">saveJobPostEvent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SaveJobPostEvent</span>(<span class="hljs-built_in">this</span>.jobId);<br>        getEventCenter().asyncPostEvent(saveJobPostEvent);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postUpdateJobEvent</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">UpdateJobPostEvent</span> <span class="hljs-variable">updateJobPostEvent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpdateJobPostEvent</span>(<span class="hljs-built_in">this</span>.jobId);<br>        getEventCenter().asyncPostEvent(updateJobPostEvent);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postDeleteJobEvent</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">UpdateJobPostEvent</span> <span class="hljs-variable">updateJobPostEvent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpdateJobPostEvent</span>(<span class="hljs-built_in">this</span>.jobId);<br>        getEventCenter().asyncPostEvent(updateJobPostEvent);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> YangJobManager <span class="hljs-title function_">getYangJobManager</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> SpringContextUtils.getBeanOfType(YangJobManager.class);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> EventCenter <span class="hljs-title function_">getEventCenter</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> SpringContextUtils.getBeanOfType(EventCenter.class);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>远程任务信息类：</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">package</span> com.yang.job.admin.domain.valueobject;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-title class_"><span class="hljs-keyword">class</span> <span class="hljs-title">RemoteExecutorMessage</span> <span class="hljs-keyword"><span class="hljs-keyword">implements</span> <span class="hljs-type">Serializable</span></span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> ip;<br><br>    <span class="hljs-keyword">private</span> Integer port;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>接着我们添加一个features枚举，用于记录映射features字段中各个key表示的含义，因为我们现在表的设计中没有任务类型字段和远程信息相关的字段，所以会将这些信息添加到features字段中</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs typescript">package com.<span class="hljs-property">yang</span>.<span class="hljs-property">job</span>.<span class="hljs-property">admin</span>.<span class="hljs-property">domain</span>.<span class="hljs-property">enums</span>;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">JobModelFeatureEnum</span> &#123;<br>    <span class="hljs-title function_">JOB_TYPE</span>(<span class="hljs-string">&quot;jobType&quot;</span>, <span class="hljs-string">&quot;任务类型&quot;</span>),<br>    <span class="hljs-title function_">REMOTE_EXECUTOR_IP</span>(<span class="hljs-string">&quot;executorIp&quot;</span>, <span class="hljs-string">&quot;执行器ip&quot;</span>),<br>    <span class="hljs-title function_">REMOTE_EXECUTOR_PORT</span>(<span class="hljs-string">&quot;executorPort&quot;</span>, <span class="hljs-string">&quot;执行器端口&quot;</span>),<br>    <span class="hljs-title function_">REMOTE_EXECUTOR_MESSAGE</span>(<span class="hljs-string">&quot;r_executor_m&quot;</span>, <span class="hljs-string">&quot;远程执行器的信息&quot;</span>);<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> name;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> description;<br><br>    <span class="hljs-title class_">JobModelFeatureEnum</span>(<span class="hljs-title class_">String</span> name, <span class="hljs-title class_">String</span> description) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">description</span> = description;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getName</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getDescription</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> description;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="client层"><a href="#client层" class="headerlink" title="client层"></a>client层</h4><p>我们修改原先的NewYangJobCommand类，加上任务类型属性</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">package</span> com.yang.job.admin.client.dto.command;<br><br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-title class_"><span class="hljs-keyword">class</span> <span class="hljs-title">NewYangJobCommand</span> <span class="hljs-keyword"><span class="hljs-keyword">implements</span> <span class="hljs-type">Serializable</span></span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> jobName;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> description;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> cron;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> executeStrategy;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> jobType;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> executeClassPath;<br><br>    <span class="hljs-keyword">private</span> Integer open;<br><br>    <span class="hljs-keyword">private</span> Map&lt;<span class="hljs-keyword">String</span>, <span class="hljs-keyword">String</span>&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-type">HashMap</span>&lt;&gt;();<br>&#125;<br></code></pre></td></tr></table></figure><p>然后修改YangJobDTO类，也加上jobType属性</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs lasso">package com.yang.job.admin.client.dto;<br><br><br><span class="hljs-keyword">import</span> lombok.<span class="hljs-built_in">Data</span>;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.<span class="hljs-built_in">Date</span>;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.<span class="hljs-built_in">Map</span>;<br><br>@<span class="hljs-built_in">Data</span><br><span class="hljs-keyword">public</span> class YangJobDTO implements Serializable &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Integer</span> jobId;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">String</span> jobName;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">String</span> description;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">String</span> cron;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">String</span> executeStrategy;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">String</span> executeClassPath;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">String</span> jobType;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Integer</span> enable;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Integer</span> open;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Date</span> createTime;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Date</span> updateTime;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt; featureMap = <span class="hljs-literal">new</span> HashMap&lt;&gt;();<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt; executeParamMap = <span class="hljs-literal">new</span> HashMap&lt;&gt;();<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="application层"><a href="#application层" class="headerlink" title="application层"></a>application层</h4><p>接着修改YangJobApplicationService类的convertYangJobModel方法，将jobType任务类型和远程任务信息添加到YangJobModel中</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">private</span> YangJobModel convert2YangJobModel(NewYangJobCommand <span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>) &#123;<br>       <span class="hljs-keyword">String</span> jobType = <span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>.getJobType();<br>       JobTypeEnum jobTypeEnum = JobTypeEnum.getJobTypeByName(jobType);<br>       <span class="hljs-keyword">if</span> (jobType == <span class="hljs-literal">null</span>) &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">BusinessException</span>(ErrorCode.PARAM_VALID_ERROR);<br>       &#125;<br>       YangJobModel yangJobModel = <span class="hljs-keyword">new</span> <span class="hljs-type">YangJobModel</span>();<br>       yangJobModel.setJobName(<span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>.getJobName());<br>       yangJobModel.setDescription(<span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>.getDescription());<br>       yangJobModel.setCron(<span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>.getCron());<br>       yangJobModel.setOpen(<span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>.getOpen());<br>       yangJobModel.setExecuteStrategy(JobExecuteStrategyEnum.getJobExecuteStrategyByName(<span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>.getExecuteStrategy()));<br>       yangJobModel.setExecuteClassPath(<span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>.getExecuteClassPath());<br>       yangJobModel.setExecuteParamMap(<span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>.getParams());<br>       yangJobModel.setJobType(jobTypeEnum);<br>       <span class="hljs-keyword">if</span> (jobTypeEnum == JobTypeEnum.REMOTE) &#123;<br>           <span class="hljs-keyword">String</span> ip = <span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>.getParams().<span class="hljs-keyword">get</span>(JobModelFeatureEnum.REMOTE_EXECUTOR_IP.getName());<br>           <span class="hljs-keyword">String</span> port = <span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>.getParams().<span class="hljs-keyword">get</span>(JobModelFeatureEnum.REMOTE_EXECUTOR_PORT.getName());<br>           <span class="hljs-keyword">if</span> (ip == <span class="hljs-literal">null</span> || port == <span class="hljs-literal">null</span>) &#123;<br>               <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">BusinessException</span>(ErrorCode.PARAM_VALID_ERROR);<br>           &#125;<br>           RemoteExecutorMessage remoteExecutorMessage = <span class="hljs-keyword">new</span> <span class="hljs-type">RemoteExecutorMessage</span>();<br>           remoteExecutorMessage.setIp(ip);<br>           remoteExecutorMessage.setPort(Integer.valueOf(port));<br>           yangJobModel.setRemoteExecutorMessage(remoteExecutorMessage);<br>       &#125; <span class="hljs-keyword">else</span> &#123;<br>           <span class="hljs-keyword">if</span> (yangJobModel.getExecuteClassPath() == <span class="hljs-literal">null</span> || yangJobModel.getExecuteClassPath().isEmpty()) &#123;<br>               <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">BusinessException</span>(ErrorCode.UN_LEGAL_CLASS_PATH);<br>           &#125;<br>           <span class="hljs-keyword">try</span> &#123;<br>               Class.forName(yangJobModel.getExecuteClassPath());<br>           &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>               e.printStackTrace();<br>               <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">BusinessException</span>(ErrorCode.UN_LEGAL_CLASS_PATH);<br>           &#125;<br>       &#125;<br>       <span class="hljs-keyword">return</span> yangJobModel;<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="infra层"><a href="#infra层" class="headerlink" title="infra层"></a>infra层</h4><p>最后修改基础设施层，首先修改YangJobModelConvertor类，将RemoteMessage和JobType转化到features中，以及从features中取出</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.job.admin.infra.gatewayimpl.repository.convertor;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.yang.job.admin.domain.enums.JobExecuteStrategyEnum;<br><span class="hljs-keyword">import</span> com.yang.job.admin.domain.enums.JobModelFeatureEnum;<br><span class="hljs-keyword">import</span> com.yang.job.admin.domain.enums.JobTypeEnum;<br><span class="hljs-keyword">import</span> com.yang.job.admin.domain.model.YangJobModel;<br><span class="hljs-keyword">import</span> com.yang.job.admin.domain.valueobject.RemoteExecutorMessage;<br><span class="hljs-keyword">import</span> com.yang.job.admin.infra.data.YangJobData;<br><span class="hljs-keyword">import</span> com.yang.job.admin.infra.job.thread.RemoteJobExecuteThread;<br><span class="hljs-keyword">import</span> com.yang.job.admin.infra.utils.FeaturesUtils;<br><span class="hljs-keyword">import</span> com.yang.job.core.dto.YangJobTransferDTO;<br><span class="hljs-keyword">import</span> com.yang.job.core.execute.IYangJobExecutor;<br><span class="hljs-keyword">import</span> com.yang.job.core.execute.YangJobExecuteRequest;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YangJobModelConvertor</span> &#123;<br>    <span class="hljs-keyword">public</span> YangJobData <span class="hljs-title function_">convert2Data</span><span class="hljs-params">(YangJobModel yangJobModel)</span> &#123;<br>        <span class="hljs-keyword">if</span> (yangJobModel == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-type">YangJobData</span> <span class="hljs-variable">yangJobData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">YangJobData</span>();<br>        yangJobData.setJobId(yangJobModel.getJobId());<br>        yangJobData.setJobName(yangJobModel.getJobName());<br>        yangJobData.setDescription(yangJobModel.getDescription());<br>        yangJobData.setCron(yangJobModel.getCron());<br>        yangJobData.setExecuteClassPath(yangJobModel.getExecuteClassPath());<br>        yangJobData.setEnable(yangJobModel.getEnable());<br>        yangJobData.setOpen(yangJobModel.getOpen());<br>        yangJobData.setCreateTime(yangJobModel.getCreateTime());<br>        yangJobData.setUpdateTime(yangJobModel.getUpdateTime());<br>        Map&lt;String, String&gt; featureMap = yangJobModel.getFeatureMap();<br>        featureMap.put(JobModelFeatureEnum.JOB_TYPE.getName(), yangJobModel.getJobType().getName());<br>        featureMap.put(JobModelFeatureEnum.REMOTE_EXECUTOR_MESSAGE.getName(), JSONObject.toJSONString(yangJobModel.getRemoteExecutorMessage()));<br>        yangJobData.setFeatures(FeaturesUtils.convert2Features(featureMap));<br>        yangJobData.setExecuteParams(FeaturesUtils.convert2Features(yangJobModel.getExecuteParamMap()));<br>        yangJobData.setExecuteStrategy(yangJobModel.getExecuteStrategy().getName());<br>        <span class="hljs-keyword">return</span> yangJobData;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> YangJobModel <span class="hljs-title function_">convert2Model</span><span class="hljs-params">(YangJobData yangJobData)</span> &#123;<br>        <span class="hljs-keyword">if</span> (yangJobData == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-type">YangJobModel</span> <span class="hljs-variable">yangJobModel</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">YangJobModel</span>();<br>        yangJobModel.setJobId(yangJobData.getJobId());<br>        yangJobModel.setDescription(yangJobData.getDescription());<br>        yangJobModel.setCron(yangJobData.getCron());<br>        yangJobModel.setJobName(yangJobData.getJobName());<br>        yangJobModel.setExecuteClassPath(yangJobData.getExecuteClassPath());<br>        yangJobModel.setEnable(yangJobData.getEnable());<br>        yangJobModel.setOpen(yangJobData.getOpen());<br>        yangJobModel.setCreateTime(yangJobData.getCreateTime());<br>        yangJobModel.setUpdateTime(yangJobData.getUpdateTime());<br>        yangJobModel.setFeatureMap(FeaturesUtils.convert2FeatureMap(yangJobData.getFeatures()));<br>        yangJobModel.setExecuteParamMap(FeaturesUtils.convert2FeatureMap(yangJobData.getExecuteParams()));<br>        <span class="hljs-type">JobExecuteStrategyEnum</span> <span class="hljs-variable">executeStrategy</span> <span class="hljs-operator">=</span> JobExecuteStrategyEnum.getJobExecuteStrategyByName(yangJobData.getExecuteStrategy());<br>        <span class="hljs-keyword">if</span> (executeStrategy == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;执行策略有误!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-type">JobTypeEnum</span> <span class="hljs-variable">jobType</span> <span class="hljs-operator">=</span> JobTypeEnum.getJobTypeByName(yangJobModel.getFeatureMap().get(JobModelFeatureEnum.JOB_TYPE.getName()));<br>        yangJobModel.setJobType(jobType);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">remoteMessageStr</span> <span class="hljs-operator">=</span> yangJobModel.getFeatureMap().get(JobModelFeatureEnum.REMOTE_EXECUTOR_MESSAGE.getName());<br>        <span class="hljs-type">RemoteExecutorMessage</span> <span class="hljs-variable">remoteExecutorMessage</span> <span class="hljs-operator">=</span> JSONObject.parseObject(remoteMessageStr, RemoteExecutorMessage.class);<br>        yangJobModel.setRemoteExecutorMessage(remoteExecutorMessage);<br><br>        yangJobModel.setExecuteStrategy(executeStrategy);<br>        yangJobModel.setRunnable(buildRunnable(yangJobModel));<br><br>        <span class="hljs-keyword">return</span> yangJobModel;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Runnable <span class="hljs-title function_">buildRunnable</span><span class="hljs-params">(YangJobModel yangJobModel)</span> &#123;<br>        <span class="hljs-keyword">if</span> (yangJobModel.isLocalJob()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">executeClassPath</span> <span class="hljs-operator">=</span> yangJobModel.getExecuteClassPath();<br>            <span class="hljs-keyword">try</span> &#123;<br>                Class&lt;?&gt; aClass = Class.forName(executeClassPath);<br>                <span class="hljs-keyword">if</span> (!IYangJobExecutor.class.isAssignableFrom(aClass)) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;该类必须实现IYangJobExecutor接口&quot;</span>);<br>                &#125;<br>                <span class="hljs-type">IYangJobExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> (IYangJobExecutor) aClass.newInstance();<br>                <span class="hljs-type">YangJobExecuteRequest</span> <span class="hljs-variable">yangJobExecuteRequest</span> <span class="hljs-operator">=</span> convert2YangJobExecuteRequest(yangJobModel);<br>                <span class="hljs-type">Runnable</span> <span class="hljs-variable">runnable</span> <span class="hljs-operator">=</span> () -&gt; executor.execute(yangJobExecuteRequest);<br>                <span class="hljs-keyword">return</span> runnable;<br>            &#125; <span class="hljs-keyword">catch</span> (InstantiationException | IllegalAccessException e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>                System.out.println(String.format(<span class="hljs-string">&quot;%s 类路径对应的类不存在&quot;</span>, executeClassPath));<br>                e.printStackTrace();<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">RemoteExecutorMessage</span> <span class="hljs-variable">remoteExecutorMessage</span> <span class="hljs-operator">=</span> yangJobModel.getRemoteExecutorMessage();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">executeClassPath</span> <span class="hljs-operator">=</span> yangJobModel.getExecuteClassPath();<br><br>            <span class="hljs-type">YangJobTransferDTO</span> <span class="hljs-variable">yangJobTransferDTO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">YangJobTransferDTO</span>();<br>            yangJobTransferDTO.setClassName(executeClassPath);<br><br>            <span class="hljs-type">YangJobExecuteRequest</span> <span class="hljs-variable">yangJobExecuteRequest</span> <span class="hljs-operator">=</span> convert2YangJobExecuteRequest(yangJobModel);<br>            yangJobTransferDTO.setYangJobExecuteRequest(yangJobExecuteRequest);<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteJobExecuteThread</span>(remoteExecutorMessage, yangJobTransferDTO);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> YangJobExecuteRequest <span class="hljs-title function_">convert2YangJobExecuteRequest</span><span class="hljs-params">(YangJobModel yangJobModel)</span> &#123;<br>        <span class="hljs-type">YangJobExecuteRequest</span> <span class="hljs-variable">yangJobExecuteRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">YangJobExecuteRequest</span>();<br>        yangJobExecuteRequest.setJobId(yangJobModel.getJobId().toString());<br>        yangJobExecuteRequest.setParams(yangJobModel.getExecuteParamMap());<br>        <span class="hljs-keyword">return</span> yangJobExecuteRequest;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后添加一个RemoteJobExecuteThread类，该类实现runnable接口，当我们的任务类型为远程调用时，其YangJobModel的runnable属性为remoteJobExecuteThread类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.job.admin.infra.job.thread;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.yang.job.admin.domain.valueobject.RemoteExecutorMessage;<br><span class="hljs-keyword">import</span> com.yang.job.core.dto.YangJobTransferDTO;<br><br><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><span class="hljs-keyword">import</span> java.net.Socket;<br><span class="hljs-keyword">import</span> java.net.UnknownHostException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteJobExecuteThread</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br>    <span class="hljs-keyword">private</span> YangJobTransferDTO yangJobTransferDTO;<br><br>    <span class="hljs-keyword">private</span> RemoteExecutorMessage remoteExecutorMessage;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RemoteJobExecuteThread</span><span class="hljs-params">(RemoteExecutorMessage remoteExecutorMessage, YangJobTransferDTO yangJobTransferDTO)</span> &#123;<br>        <span class="hljs-built_in">this</span>.remoteExecutorMessage = remoteExecutorMessage;<br>        <span class="hljs-built_in">this</span>.yangJobTransferDTO = yangJobTransferDTO;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">ip</span> <span class="hljs-operator">=</span> remoteExecutorMessage.getIp();<br>            <span class="hljs-type">Integer</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> remoteExecutorMessage.getPort();<br>            <span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Socket</span>(ip, port);<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">printWriter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(socket.getOutputStream(), <span class="hljs-literal">true</span>);<br>            <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">bufferedReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(socket.getInputStream()));<br><br>            printWriter.println(JSONObject.toJSONString(yangJobTransferDTO));<br><br>            bufferedReader.close();<br>            printWriter.close();<br>            socket.close();<br>        &#125; <span class="hljs-keyword">catch</span> (UnknownHostException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><p>我们先启动之前的sample1项目，然后启动yang-job-admin，调用<a href="http://localhost:8080/job%E6%B7%BB%E5%8A%A0%E4%BB%BB%E5%8A%A1%EF%BC%8C%E8%AF%B7%E6%B1%82%E4%BD%93%E5%A6%82%E4%B8%8B%EF%BC%9A">http://localhost:8080/job添加任务，请求体如下：</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;jobName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;RemoteJobExecutor&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;RemoteJobExecutor&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;cron&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0/10 * * * * ?&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;executeStrategy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;withFixedDelay&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;executeClassPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.yang.job.sample1.task.TestTask1&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;open&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;jobType&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;remote&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;params&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;executorIp&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;127.0.0.1&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;executorPort&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;9999&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/8.png" class=""><p>添加成功后，我们查看Sample1项目的控制台，可以看到，每10秒，这个TestTask1任务会被调用一次</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/9.png" class=""><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="https://www.yihuo.tech/programming/server-stack/exploring-the-java-network-programming-paradigm-socket-udp-nio-and-netty-in-focus/">https://www.yihuo.tech/programming/server-stack/exploring-the-java-network-programming-paradigm-socket-udp-nio-and-netty-in-focus/</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>XXL-JOB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>手撸XXL-JOB（三）—本地定时任务管理平台</title>
    <link href="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/"/>
    <url>/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/</url>
    
    <content type="html"><![CDATA[<h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>在XXL-JOB中，有一个xxl-job-admin项目，这个就相当于定时任务的调度平台，我们参考XXL-JOB，也添加这么一个调度平台，由于篇幅有限，我们先实现一个本地的定时任务调度平台，至于如何调用远程的定时任务，后面再进行讲解。</p><h4 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h4><p>首先我们创建一个springboot项目，引入下列依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.cronutils<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cron-utils<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.guava<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>guava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>31.1-jre<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><p>创建yang-job表</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `yang_job`  (<br>  `id` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `job_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `description` <span class="hljs-type">varchar</span>(<span class="hljs-number">512</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `cron` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `execute_strategy` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">&#x27;执行策略：once/withFixedDelay/withFixedRate&#x27;</span>,<br>  `execute_class_path` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `<span class="hljs-keyword">enable</span>` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span>,<br>  `<span class="hljs-keyword">open</span>` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,<br>  `create_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `update_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `features` <span class="hljs-type">varchar</span>(<span class="hljs-number">512</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `execute_params` <span class="hljs-type">varchar</span>(<span class="hljs-number">512</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY KEY</span> (`id`) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE = InnoDB AUTO_INCREMENT = <span class="hljs-number">12</span> <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> = utf8mb4 <span class="hljs-keyword">COLLATE</span> = utf8mb4_general_ci ROW_FORMAT = Dynamic;<br><br></code></pre></td></tr></table></figure><h4 id="层级关系"><a href="#层级关系" class="headerlink" title="层级关系"></a>层级关系</h4><p>对于分层，我们参考阿里巴巴的COLA项目，分为5层，分别是controller层、client层、applicatioon层、domain层和infrastructure层。如下图所示：</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/1.png" class=""><p>层级的依赖关系如下：</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/2.png" class=""><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/3.png" class=""><p>DDD四层架构，自上而下分别是用户界面层、应用层、领域层和基础设施层，上层可以依赖下层，而下层不能依赖上层。如下图所示：</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/4.png" class=""><p>COLA架构和DDD的四层架构很相似，但是它在四层架构的基础上，进一步进行了约束，如下图所示</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/5.png" class=""><p>在本项目中，尽量参考COLA架构的约束进行实现，但也会根据实际情况灵活进行修改，即便违背了COLA架构的相关约束条件，也会遵守DDD四层架构的约束。</p><h3 id="项目搭建"><a href="#项目搭建" class="headerlink" title="项目搭建"></a>项目搭建</h3><h4 id="client层"><a href="#client层" class="headerlink" title="client层"></a>client层</h4><p>client其实在COLA中，属于可选的一层，主要用于存储服务对外透出的API和DTO。在client层中，所拥有的类如下所示：</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/6.png" class=""><p>api主要定义了对外提供的接口，这里我定义两个api——YangJobQueryService和YangJobService，一个是用于查询的，一个是用于命令的。<br>在dto中，定义了三个包，其中，common包存放的，是通用的dto，比如是结果类、错误信息类、分页类等。command包存放的，则是命令类，query包存放查询类，其余的数据实体，直接放在dto包下。<br>为什么要定义command和query？这个其实体现的是CQRS模式（Command Query Responsibility Seregation，命令查询职责分离）。所谓命令，指的是会引起数据发生变化操作的总称，比如新增、更新、删除等操作，该方法要么改变对象的内部状态，但不返回任何内容，要么只返回元数据。所谓查询，指不会对数据产生变化的操作，只是按照某些条件查找数据。</p><h4 id="domain层"><a href="#domain层" class="headerlink" title="domain层"></a>domain层</h4><p>领域层主要封装了核心业务逻辑，并通过领域服务或领域对象的方法，对App提供业务实体和业务逻辑计算，领域是应用的核心，不依赖任何其他层次。</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/7.png" class=""><p>在目前的domain层中，其分层结构如上图所示，其中JobExecuteStrategyEnum就是我们之前提到的执行策略枚举。然后YangJobModel为具体的模型类，IJobModelRepository和JobModelQueryCondition为和数据库操作相关的类。<br>下面是IJobModelRepository的定义，其实这个IJobModelRepository的定义，违反我们刚才提到的”domain不依赖任何其他层次”，因为它使用到了client层提供的PageDTO，但是我觉得这里影响不大，如果说一定要遵循原则的话，可以在domain层也定义一个分页结果类，只是说在Application层中，如果涉及到分页结果的话，需要将domain层提供的分页结果转化为对外提供的分页结果。这里因为只是demo，就不做那么严格的限制了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.job.domain.repository;<br><br><br><span class="hljs-keyword">import</span> com.yang.job.client.dto.common.PageDTO;<br><span class="hljs-keyword">import</span> com.yang.job.domain.model.YangJobModel;<br><span class="hljs-keyword">import</span> com.yang.job.domain.repository.request.JobModelQueryCondition;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IJobModelRepository</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">saveYangJobModel</span><span class="hljs-params">(YangJobModel yangJobModel)</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">updateYangJobModel</span><span class="hljs-params">(YangJobModel yangJobModel)</span>;<br><br>    YangJobModel <span class="hljs-title function_">getYangJobModelById</span><span class="hljs-params">(Integer id)</span>;<br><br>    List&lt;YangJobModel&gt; <span class="hljs-title function_">getOpenYangJobModelList</span><span class="hljs-params">()</span>;<br><br>    PageDTO&lt;YangJobModel&gt; <span class="hljs-title function_">queryYangJobModelPage</span><span class="hljs-params">(JobModelQueryCondition jobModelQueryCondition)</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">deleteJobModel</span><span class="hljs-params">(Integer id)</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>YangJobModel模型的代码如下所示，其实就目前来看，这个YangJobModel模型并没有什么业务逻辑，因为我们现在刚开始搭建，主要还是面向与增删改查的，所以业务逻辑相对来说较少。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs typescript">package com.<span class="hljs-property">yang</span>.<span class="hljs-property">job</span>.<span class="hljs-property">domain</span>.<span class="hljs-property">model</span>;<br><br><br><span class="hljs-keyword">import</span> com.<span class="hljs-property">yang</span>.<span class="hljs-property">job</span>.<span class="hljs-property">client</span>.<span class="hljs-property">dto</span>.<span class="hljs-property">common</span>.<span class="hljs-property">BusinessException</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">yang</span>.<span class="hljs-property">job</span>.<span class="hljs-property">client</span>.<span class="hljs-property">dto</span>.<span class="hljs-property">common</span>.<span class="hljs-property">ErrorCode</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">yang</span>.<span class="hljs-property">job</span>.<span class="hljs-property">domain</span>.<span class="hljs-property">enums</span>.<span class="hljs-property">JobExecuteStrategyEnum</span>;<br><span class="hljs-keyword">import</span> lombok.<span class="hljs-property">Data</span>;<br><br><span class="hljs-keyword">import</span> java.<span class="hljs-property">io</span>.<span class="hljs-property">Serializable</span>;<br><span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">Date</span>;<br><span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">HashMap</span>;<br><span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">Map</span>;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YangJobModel</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Integer</span> jobId;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> jobName;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> description;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> cron;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> executeClassPath;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Runnable</span> runnable;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">JobExecuteStrategyEnum</span> executeStrategy;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Integer</span> enable;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Integer</span> open;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Date</span> createTime;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Date</span> updateTime;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; featureMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; executeParamMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isEnable</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">enable</span> == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">enable</span> == <span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isOpen</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isEnable</span>()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">open</span> == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">open</span> == <span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isClose</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> !<span class="hljs-title function_">isOpen</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setExecuteClassPath</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> executeClassPath</span>) &#123;<br>        <span class="hljs-keyword">if</span> (executeClassPath == <span class="hljs-literal">null</span> || executeClassPath.<span class="hljs-title function_">isEmpty</span>()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">UN_LEGAL_CLASS_PATH</span>);<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-title class_">Class</span>.<span class="hljs-title function_">forName</span>(executeClassPath);<br>        &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">ClassNotFoundException</span> e) &#123;<br>            e.<span class="hljs-title function_">printStackTrace</span>();<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">UN_LEGAL_CLASS_PATH</span>);<br>        &#125;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">executeClassPath</span> = executeClassPath;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setExecuteStrategy</span>(<span class="hljs-params">JobExecuteStrategyEnum jobExecuteStrategyEnum</span>) &#123;<br>        <span class="hljs-keyword">if</span> (jobExecuteStrategyEnum == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">EXECUTE_STRATEGY_NO_EXIST</span>);<br>        &#125;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">executeStrategy</span> = jobExecuteStrategyEnum;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="application层"><a href="#application层" class="headerlink" title="application层"></a>application层</h4><p>应用层主要负责获取输入、组装上下文、参数校验、调用领域层做业务处理，如果需要的话，发送消息通知等，层次是开放的，应用层也可以绕过领域层，直接访问基础设施层。</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/8.png" class=""><p>目前application相对比较简单，convertor包用于将我们的模型转化外对外提供的DTO类。<br>YangJobApplicationService的实现如下：</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-title class_"><span class="hljs-keyword">class</span> <span class="hljs-title">YangJobApplicationService</span> <span class="hljs-keyword"><span class="hljs-keyword">implements</span> <span class="hljs-type">YangJobService</span></span> </span>&#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> IJobModelRepository jobModelRepository;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> YangJobDTOConvertor yangJobDTOConvertor;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Response&lt;YangJobDTO&gt; saveYangJob(NewYangJobCommand <span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>) &#123;<br>        YangJobModel yangJobModel = convert2YangJobModel(<span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>);<br>        <span class="hljs-keyword">if</span> (jobModelRepository.saveYangJobModel(yangJobModel)) &#123;<br>            YangJobDTO yangJobDTO = yangJobDTOConvertor.convert2DTO(yangJobModel);<br>            <span class="hljs-keyword">return</span> Response.success(yangJobDTO);<br>        &#125;<br>        <span class="hljs-keyword">return</span> Response.fail();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> YangJobModel convert2YangJobModel(NewYangJobCommand <span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>) &#123;<br>        YangJobModel yangJobModel = <span class="hljs-keyword">new</span> <span class="hljs-type">YangJobModel</span>();<br>        yangJobModel.setJobName(<span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>.getJobName());<br>        yangJobModel.setDescription(<span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>.getDescription());<br>        yangJobModel.setCron(<span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>.getCron());<br>        yangJobModel.setOpen(<span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>.getOpen());<br>        yangJobModel.setExecuteStrategy(JobExecuteStrategyEnum.getJobExecuteStrategyByName(<span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>.getExecuteStrategy()));<br>        yangJobModel.setExecuteClassPath(<span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>.getExecuteClassPath());<br>        yangJobModel.setExecuteParamMap(<span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>.getParams());<br>        <span class="hljs-keyword">return</span> yangJobModel;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Response&lt;YangJobDTO&gt; updateYangJob(UpdateYangJobCommand updateYangJobCommand) &#123;<br>        YangJobModel yangJobModel = jobModelRepository.getYangJobModelById(updateYangJobCommand.getJobId());<br>        <span class="hljs-keyword">if</span> (yangJobModel == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> Response.fail();<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (updateYangJobCommand.getJobName() != <span class="hljs-literal">null</span>) &#123;<br>            yangJobModel.setJobName(updateYangJobCommand.getJobName());<br>        &#125;<br>        <span class="hljs-keyword">if</span> (updateYangJobCommand.getCron() != <span class="hljs-literal">null</span>) &#123;<br>            yangJobModel.setCron(updateYangJobCommand.getCron());<br>        &#125;<br>        <span class="hljs-keyword">if</span> (updateYangJobCommand.getOpen() != <span class="hljs-literal">null</span>) &#123;<br>            yangJobModel.setOpen(updateYangJobCommand.getOpen());<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!updateYangJobCommand.getParams().isEmpty()) &#123;<br>            yangJobModel.setExecuteParamMap(updateYangJobCommand.getParams());<br>        &#125;<br>        <span class="hljs-keyword">if</span> (updateYangJobCommand.getExecuteClassPath() != <span class="hljs-literal">null</span>) &#123;<br>            yangJobModel.setExecuteClassPath(updateYangJobCommand.getExecuteClassPath());<br>        &#125;<br>        <span class="hljs-keyword">if</span> (updateYangJobCommand.getExecuteStrategy() != <span class="hljs-literal">null</span>) &#123;<br>            yangJobModel.setExecuteStrategy(JobExecuteStrategyEnum.getJobExecuteStrategyByName(updateYangJobCommand.getExecuteStrategy()));<br>        &#125;<br>        <span class="hljs-keyword">if</span> (jobModelRepository.updateYangJobModel(yangJobModel)) &#123;<br>            YangJobDTO yangJobDTO = yangJobDTOConvertor.convert2DTO(yangJobModel);<br>            <span class="hljs-keyword">return</span> Response.success(yangJobDTO);<br>        &#125;<br>        <span class="hljs-keyword">return</span> Response.fail();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Response&lt;YangJobDTO&gt; deleteYangJob(DeleteYangJobCommand deleteYangJobCommand) &#123;<br>        Integer jobId = deleteYangJobCommand.getJobId();<br>        <span class="hljs-keyword">if</span> (jobModelRepository.deleteJobModel(jobId)) &#123;<br>            <span class="hljs-keyword">return</span> Response.success();<br>        &#125;<br>        <span class="hljs-keyword">return</span> Response.fail();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>YangJobQueryApplicationService的实现如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YangJobQueryApplicationService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">YangJobQueryService</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> IJobModelRepository jobModelRepository;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> YangJobDTOConvertor yangJobDTOConvertor;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Response&lt;PageDTO&lt;YangJobDTO&gt;&gt; <span class="hljs-title function_">queryYangJobPage</span><span class="hljs-params">(PageYangJobQuery pageYangJobQuery)</span> &#123;<br>        <span class="hljs-type">JobModelQueryCondition</span> <span class="hljs-variable">jobModelQueryCondition</span> <span class="hljs-operator">=</span> convert2JobModelQueryCondition(pageYangJobQuery);<br>        PageDTO&lt;YangJobModel&gt; modelPageDTO = jobModelRepository.queryYangJobModelPage(jobModelQueryCondition);<br>        PageDTO&lt;YangJobDTO&gt; pageDTO = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageDTO</span>&lt;&gt;();<br>        pageDTO.setPageNo(modelPageDTO.getPageNo());<br>        pageDTO.setPageSize(modelPageDTO.getPageSize());<br>        pageDTO.setPages(modelPageDTO.getPages());<br>        pageDTO.setTotal(modelPageDTO.getTotal());<br><br>        List&lt;YangJobDTO&gt; dataList = modelPageDTO.getDataList().stream()<br>                .map(yangJobDTOConvertor::convert2DTO)<br>                .collect(Collectors.toList());<br>        pageDTO.setDataList(dataList);<br>        <span class="hljs-keyword">return</span> Response.success(pageDTO);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Response&lt;YangJobDTO&gt; <span class="hljs-title function_">getYangJobDTOById</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-type">YangJobModel</span> <span class="hljs-variable">yangJobModel</span> <span class="hljs-operator">=</span> jobModelRepository.getYangJobModelById(id);<br>        <span class="hljs-type">YangJobDTO</span> <span class="hljs-variable">yangJobDTO</span> <span class="hljs-operator">=</span> yangJobDTOConvertor.convert2DTO(yangJobModel);<br>        <span class="hljs-keyword">return</span> Response.success(yangJobDTO);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> JobModelQueryCondition <span class="hljs-title function_">convert2JobModelQueryCondition</span><span class="hljs-params">(PageYangJobQuery pageYangJobQuery)</span> &#123;<br>        <span class="hljs-type">JobModelQueryCondition</span> <span class="hljs-variable">jobModelQueryCondition</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JobModelQueryCondition</span>();<br>        jobModelQueryCondition.setPageNo(pageYangJobQuery.getPageNo());<br>        jobModelQueryCondition.setPageSize(pageYangJobQuery.getPageSize());<br>        jobModelQueryCondition.setOpen(pageYangJobQuery.getOpen());<br>        <span class="hljs-keyword">return</span> jobModelQueryCondition;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这两个类，也是一个用于命令，一个用于查询。命令查询职责分离，有一个主要的作用就是实现读写分离，有时候，读取所需要的模型和写入所需要的模型是不同的，比如说一些密码、地址等私密信息，我们在读取的时候，不会读取到这些数据，而在写入的时候，需要对这些数据做一些校验、加密等操作，因此就需要将读写模型进行分离。如果在本项目中，也要进行读写分离的话，那么我们可以将YangJobModel用于命令，然后额外创建一个YangJobQueryModel用于查询，不过一般情况下，无有必要勿增实体，目前我们的YangJobModel够用了，如果后续有相应的需求，我们再将读写分离也为时不晚。</p><h4 id="controller层"><a href="#controller层" class="headerlink" title="controller层"></a>controller层</h4><p>controller层即COLA中的适配层，负责对前端展示的路由和适配，对于传统的B&#x2F;S系统而言，adapter就相当于MVC中的controller层。<br>controller层的结构如下图所示，其实就和普通的MVC层一样，定义一些VO类，然后调用application层的方法返回信息。</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/9.png" class=""><h4 id="infrastructure层"><a href="#infrastructure层" class="headerlink" title="infrastructure层"></a>infrastructure层</h4><p>infrastructure层主要负责技术细节问题的处理，比如数据库的CRUD、搜索引擎、文件系统、分布式服务的RPC等，此外，领域防腐的重任也在这里，外部依赖需要通过gateway的转义处理，才能被上面的App层和domain层使用。<br>基础设施层的内容如下图所示，data包是数据库实体和对应的mapper，exception是全局异常处理，gateway则是我们的防腐层，job包为上一章提到的定时任务基础设施。</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/10.png" class=""><h4 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h4><p>application.yml配置信息如下所示：</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">spring:</span><br><span class="hljs-symbol">  datasource:</span><br><span class="hljs-symbol">    username:</span> root<br><span class="hljs-symbol">    password:</span> <span class="hljs-number">3f</span>a4d180<br>    driver-class-name: com.mysql.cj.jdbc.Driver<br><span class="hljs-symbol">    url:</span> jdbc:mysql:<span class="hljs-comment">//localhost:3306/test?useSSL=false&amp;serverTimezone=UTC</span><br><span class="hljs-symbol">  thymeleaf:</span><br><span class="hljs-symbol">    cache:</span> false<br><span class="hljs-symbol">    prefix:</span> classpath:<span class="hljs-keyword">/templates/</span><br><span class="hljs-symbol">    encoding:</span> UTF<span class="hljs-number">-8</span><br><span class="hljs-symbol">    suffix:</span> .html<br><span class="hljs-symbol">    mode:</span> HTML<br></code></pre></td></tr></table></figure><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>启动项目，通过接口调用，进行测试。因为我们的YangJobModel模型对executeClassPath做了校验，以确保执行的类实现了IJobExecutor接口，因此，为了方便测试，我们添加两个测试类，实现IJobExecutor接口进行测试。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.job.application.task;<br><br><br><span class="hljs-keyword">import</span> com.yang.job.infra.job.execute.IYangJobExecutor;<br><span class="hljs-keyword">import</span> com.yang.job.infra.job.execute.YangJobExecuteRequest;<br><br><span class="hljs-keyword">import</span> java.text.SimpleDateFormat;<br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorldJobExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IYangJobExecutor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(YangJobExecuteRequest yangJobExecuteRequest)</span> &#123;<br>        <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">simpleDateFormat</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">nowTime</span> <span class="hljs-operator">=</span> simpleDateFormat.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        System.out.println(String.format(<span class="hljs-string">&quot;Hello world! jobId: %s, nowTime:%s&quot;</span>, yangJobExecuteRequest.getJobId(), nowTime));<br>    &#125;<br>&#125;<br><br><br><span class="hljs-keyword">package</span> com.yang.job.application.task;<br><br><br><span class="hljs-keyword">import</span> com.yang.job.infra.job.execute.IYangJobExecutor;<br><span class="hljs-keyword">import</span> com.yang.job.infra.job.execute.YangJobExecuteRequest;<br><br><span class="hljs-keyword">import</span> java.text.SimpleDateFormat;<br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestJobExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IYangJobExecutor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(YangJobExecuteRequest yangJobExecuteRequest)</span> &#123;<br>        <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">simpleDateFormat</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">nowTime</span> <span class="hljs-operator">=</span> simpleDateFormat.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        System.out.println(String.format(<span class="hljs-string">&quot;class: %s, Hello world! jobId:%s, nowTime:%s&quot;</span>,<br>                <span class="hljs-built_in">this</span>.getClass().getName(), yangJobExecuteRequest.getJobId(), nowTime<br>        ));<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后我们，启动项目，调用接口，进行测试</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/11.png" class=""><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/12.png" class=""><h3 id="启动时注册开启的定时任务"><a href="#启动时注册开启的定时任务" class="headerlink" title="启动时注册开启的定时任务"></a>启动时注册开启的定时任务</h3><p>上述流程跑通后，我们查看数据库，可以看到对应的记录，说明项目的增删改查基本没有什么问题，但是，我们从数据库中，可以看到，这些定时任务是开启的，而我们现在的后端代码中，还没有将这些定时任务添加到YangJobManager中进行定时任务的执行或取消。</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/13.png" class=""><p>因此，我们先修改YangJobModel模块中，添加提交任务的方法submitJob，这里就不符合COLA中domain不依赖其他层级的要求，因为它依赖了infrastructure基础设施层，但是仍然符合DDD四层架构中，上层依赖下层，而下层不依赖上层的要求。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.job.domain.model;<br><br><br><span class="hljs-keyword">import</span> com.yang.job.client.dto.common.BusinessException;<br><span class="hljs-keyword">import</span> com.yang.job.client.dto.common.ErrorCode;<br><span class="hljs-keyword">import</span> com.yang.job.domain.enums.JobExecuteStrategyEnum;<br><span class="hljs-keyword">import</span> com.yang.job.infra.job.YangJobManager;<br><span class="hljs-keyword">import</span> com.yang.job.infra.job.request.YangJobSubmitParam;<br><span class="hljs-keyword">import</span> com.yang.job.infra.utils.CronUtils;<br><span class="hljs-keyword">import</span> com.yang.job.infra.utils.SpringContextUtils;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.time.ZonedDateTime;<br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YangJobModel</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> Integer jobId;<br><br>    <span class="hljs-keyword">private</span> String jobName;<br><br>    <span class="hljs-keyword">private</span> String description;<br><br>    <span class="hljs-keyword">private</span> String cron;<br><br>    <span class="hljs-keyword">private</span> String executeClassPath;<br><br>    <span class="hljs-keyword">private</span> Runnable runnable;<br><br>    <span class="hljs-keyword">private</span> JobExecuteStrategyEnum executeStrategy;<br><br>    <span class="hljs-keyword">private</span> Integer enable;<br><br>    <span class="hljs-keyword">private</span> Integer open;<br><br>    <span class="hljs-keyword">private</span> Date createTime;<br><br>    <span class="hljs-keyword">private</span> Date updateTime;<br><br>    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; featureMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; executeParamMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnable</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.enable == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.enable == <span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isOpen</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (!isEnable()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.open == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.open == <span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isClose</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> !isOpen();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setExecuteClassPath</span><span class="hljs-params">(String executeClassPath)</span> &#123;<br>        <span class="hljs-keyword">if</span> (executeClassPath == <span class="hljs-literal">null</span> || executeClassPath.isEmpty()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.UN_LEGAL_CLASS_PATH);<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class.forName(executeClassPath);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.UN_LEGAL_CLASS_PATH);<br>        &#125;<br>        <span class="hljs-built_in">this</span>.executeClassPath = executeClassPath;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setExecuteStrategy</span><span class="hljs-params">(JobExecuteStrategyEnum jobExecuteStrategyEnum)</span> &#123;<br>        <span class="hljs-keyword">if</span> (jobExecuteStrategyEnum == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.EXECUTE_STRATEGY_NO_EXIST);<br>        &#125;<br>        <span class="hljs-built_in">this</span>.executeStrategy = jobExecuteStrategyEnum;<br>    &#125;<br><br>    <span class="hljs-comment">// 提交任务</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">submitJob</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">YangJobSubmitParam</span> <span class="hljs-variable">yangJobSubmitParam</span> <span class="hljs-operator">=</span> convert2YangJobSubmitParam();<br>        <span class="hljs-type">YangJobManager</span> <span class="hljs-variable">yangJobManager</span> <span class="hljs-operator">=</span> getYangJobManager();<br>        yangJobManager.submitJob(yangJobSubmitParam);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> YangJobSubmitParam <span class="hljs-title function_">convert2YangJobSubmitParam</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">YangJobSubmitParam</span> <span class="hljs-variable">yangJobBuildParam</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">YangJobSubmitParam</span>();<br>        yangJobBuildParam.setJobId(<span class="hljs-built_in">this</span>.jobId);<br>        yangJobBuildParam.setRunnable(<span class="hljs-built_in">this</span>.runnable);<br>        <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">nextExecutionTime</span> <span class="hljs-operator">=</span> CronUtils.nextExecutionTime(<span class="hljs-built_in">this</span>.cron, ZonedDateTime.now());<br>        <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">nextNextExecutionTime</span> <span class="hljs-operator">=</span> CronUtils.nextExecutionTime(<span class="hljs-built_in">this</span>.cron, nextExecutionTime);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">nowEochMill</span> <span class="hljs-operator">=</span> ZonedDateTime.now().toInstant().toEpochMilli();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">executeEochMill</span> <span class="hljs-operator">=</span> nextExecutionTime.toInstant().toEpochMilli();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">secondExecuteEochMill</span> <span class="hljs-operator">=</span> nextNextExecutionTime.toInstant().toEpochMilli();<br>        yangJobBuildParam.setInitialDelay((<span class="hljs-type">int</span>)(executeEochMill - nowEochMill) / <span class="hljs-number">1000</span>);<br>        yangJobBuildParam.setPeriod((<span class="hljs-type">int</span>)(secondExecuteEochMill - executeEochMill) / <span class="hljs-number">1000</span>);<br>        yangJobBuildParam.setJobExecuteStrategy(<span class="hljs-built_in">this</span>.executeStrategy);<br>        <span class="hljs-keyword">return</span> yangJobBuildParam;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> YangJobManager <span class="hljs-title function_">getYangJobManager</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> SpringContextUtils.getBeanOfType(YangJobManager.class);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后，我们添加YangJobContext类，作为定时任务的上下文类，在SpringBoot刷新容器的时候，监听到该刷新事件，然后从数据库中获取开启的定时任务，将该任务提交到YangJobManager中进行定时执行。当SpringBoot关闭容器的时候，监听关闭事件，然后调用YangJobManager的shutdown，关闭对应的线程池。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.job.infra.job;<br><br><span class="hljs-keyword">import</span> com.yang.job.domain.gateway.repository.IJobModelRepository;<br><span class="hljs-keyword">import</span> com.yang.job.domain.model.YangJobModel;<br><span class="hljs-keyword">import</span> com.yang.job.infra.utils.SpringContextUtils;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationListener;<br><span class="hljs-keyword">import</span> org.springframework.context.event.ApplicationContextEvent;<br><span class="hljs-keyword">import</span> org.springframework.context.event.ContextClosedEvent;<br><span class="hljs-keyword">import</span> org.springframework.context.event.ContextRefreshedEvent;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YangJobContext</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationListener</span>&lt;ApplicationContextEvent&gt; &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> YangJobContext instance;<br><br>    <span class="hljs-keyword">private</span> ApplicationContext applicationContext;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onApplicationEvent</span><span class="hljs-params">(ApplicationContextEvent event)</span> &#123;<br>        <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> ContextRefreshedEvent) &#123;<br>            System.out.println(<span class="hljs-string">&quot;刷新了=========&quot;</span>);<br>            YangJobContext.instance = <span class="hljs-built_in">this</span>;<br>            instance.applicationContext = applicationContext;<br>            init();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> ContextClosedEvent) &#123;<br>            System.out.println(<span class="hljs-string">&quot;销毁了=========&quot;</span>);<br>            shutdown();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">IJobModelRepository</span> <span class="hljs-variable">jobModelRepository</span> <span class="hljs-operator">=</span> SpringContextUtils.getBeanOfType(IJobModelRepository.class);<br>        List&lt;YangJobModel&gt; yangJobModelList = jobModelRepository.getOpenYangJobModelList();<br>        <span class="hljs-keyword">for</span> (YangJobModel yangJobModel : yangJobModelList) &#123;<br>            yangJobModel.submitJob();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">YangJobManager</span> <span class="hljs-variable">yangJobManager</span> <span class="hljs-operator">=</span> SpringContextUtils.getBeanOfType(YangJobManager.class);<br>        <span class="hljs-keyword">if</span> (yangJobManager == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        yangJobManager.shutdown();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>最后，我们添加YangJob相关的配置类，将YangJobManager和YangJobContext注册到SpringBoot容器中进行统一管理。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.job.infra.job.configuration;<br><br><span class="hljs-keyword">import</span> com.yang.job.infra.job.YangJobContext;<br><span class="hljs-keyword">import</span> com.yang.job.infra.job.YangJobManager;<br><span class="hljs-keyword">import</span> com.yang.job.infra.job.thread.YangJobThreadFactory;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.LinkedBlockingQueue;<br><span class="hljs-keyword">import</span> java.util.concurrent.ScheduledThreadPoolExecutor;<br><span class="hljs-keyword">import</span> java.util.concurrent.ThreadPoolExecutor;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YangJobConfiguration</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> ScheduledThreadPoolExecutor <span class="hljs-title function_">scheduledThreadPoolExecutor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">availableProcessors</span> <span class="hljs-operator">=</span> Runtime.getRuntime().availableProcessors();<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScheduledThreadPoolExecutor</span>(availableProcessors, <span class="hljs-keyword">new</span> <span class="hljs-title class_">YangJobThreadFactory</span>(<span class="hljs-string">&quot;yang&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> YangJobManager <span class="hljs-title function_">yangJobManager</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">YangJobManager</span>.YangJobManagerBuilder()<br>                .setScheduledExecutorService(scheduledThreadPoolExecutor())<br>                .build();<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> YangJobContext <span class="hljs-title function_">yangJobContext</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">YangJobContext</span>();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>添加上述代码后，我们重新启动项目，然后观察控制台，如下图所示，jobId为12的只执行一次，jobId为13的每隔5秒执行一次，这个和它们在数据库中的执行策略保持一致，前者为once，后者为withFixedDelay。</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/14.png" class=""><h3 id="领域事件"><a href="#领域事件" class="headerlink" title="领域事件"></a>领域事件</h3><h4 id="添加定时任务后置事件"><a href="#添加定时任务后置事件" class="headerlink" title="添加定时任务后置事件"></a>添加定时任务后置事件</h4><p>我们在添加定时任务时，接口的入参如下：</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">package</span> com.yang.job.client.dto.command;<br><br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-title class_"><span class="hljs-keyword">class</span> <span class="hljs-title">NewYangJobCommand</span> <span class="hljs-keyword"><span class="hljs-keyword">implements</span> <span class="hljs-type">Serializable</span></span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> jobName;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> description;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> cron;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> executeStrategy;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> executeClassPath;<br><br>    <span class="hljs-keyword">private</span> Integer open;<br><br>    <span class="hljs-keyword">private</span> Map&lt;<span class="hljs-keyword">String</span>, <span class="hljs-keyword">String</span>&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-type">HashMap</span>&lt;&gt;();<br>&#125;<br><br><br></code></pre></td></tr></table></figure><p>我们看到，可以通过open参数，来决定新建的定时任务是否开启，在之前的测试中，我们添加的定时任务open参数都设置为1，从数据库的角度看，数据确实持久化了，并且open的值也为1，但是从行为看是不对的，我们添加该任务，并且该任务是open的，那么当我们添加成功后，应该将该任务注册到YangJobManager。<br>最简单的方式，便是在添加成功后，做判断，如果open为1，那么调用YangJobModel的submitJob方法</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Response&lt;YangJobDTO&gt; saveYangJob(NewYangJobCommand <span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>) &#123;<br>      YangJobModel yangJobModel = convert2YangJobModel(<span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>);<br>      <span class="hljs-keyword">if</span> (jobModelRepository.saveYangJobModel(yangJobModel)) &#123;<br>          <span class="hljs-comment">// 判断任务是否开启,开启的话，注册到YangJobManager</span><br>          <span class="hljs-keyword">if</span> (yangJobModel.isOpen()) &#123;<br>              yangJobModel.submitJob();<br>          &#125;<br>          YangJobDTO yangJobDTO = yangJobDTOConvertor.convert2DTO(yangJobModel);<br>          <span class="hljs-keyword">return</span> Response.success(yangJobDTO);<br>      &#125;<br>      <span class="hljs-keyword">return</span> Response.fail();<br>  &#125;<br></code></pre></td></tr></table></figure><p>但上述方法有一个问题，如果后续我们多了其他需求，比如虽然open为0，但是这个任务比较特殊，初次入库时必须执行一次等等奇奇怪怪的需求，那么我们在添加成功后，需要有一大串判断逻辑，影响后续的维护。<br>为解决上述问题，我们可以通过事件的方式，进行解耦。在我的第一份实习中，遇到的项目，就是用事件的方式，来进行解耦，一开始我很不理解这种方式，因为发送的事件太多了，从开始到结束将近10个事件，每次看代码都要从一个事件处理类，跳到另一个事件处理类，但是后来看了一些DDD的书籍后，有点理解这种做法了，这种应该就是属于领域事件，因为这些事件，将不同子域串联起来，比如从收单到支付再到账户等域，通过领域事件，将这些不同的域串联起来，此外又不会使两个域之间存在强耦合的代码，从而方便后续的维护。<br>因此，这里也使用事件的方式，在将定时任务持久化到数据库后，发送一个持久化成功后置处理事件，由对应的事件处理者，进行逻辑判断以及相关的业务处理。<br>首先，我们在基础设施层中，添加事件的相关类。首先是我们定义一个事件类：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs csharp">package com.yang.job.infra.<span class="hljs-keyword">event</span>;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IEvent</span> &lt;<span class="hljs-title">T</span>&gt; &#123;<br>    <span class="hljs-function">T <span class="hljs-title">getData</span>()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后定义对应的事件处理类：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">package com.yang.job.infra.event;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-symbol">IEventHandler</span> &lt;<span class="hljs-symbol">Event</span> <span class="hljs-symbol">extends</span> <span class="hljs-symbol">IEvent</span>&gt; &#123;<br>    <span class="hljs-built_in">void</span> execute(Event event);<br>&#125;<br></code></pre></td></tr></table></figure><p>添加EventCenter事件中心类，用于推送同步事件或异步事件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.job.infra.event;<br><br><br><span class="hljs-keyword">import</span> com.google.common.eventbus.AsyncEventBus;<br><span class="hljs-keyword">import</span> com.google.common.eventbus.EventBus;<br><br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentHashMap;<br><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EventCenter</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">EventBus</span> <span class="hljs-variable">eventBus</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventBus</span>();<br><br>    <span class="hljs-keyword">private</span> AsyncEventBus asyncEventBus;<br><br>    <span class="hljs-keyword">private</span> ExecutorService asyncEventExecutorService;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, IEventHandler&gt; eventHandlerMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">EventCenter</span><span class="hljs-params">(ExecutorService executorService)</span> &#123;<br>        <span class="hljs-built_in">this</span>.asyncEventExecutorService = executorService;<br>        asyncEventBus = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncEventBus</span>(executorService);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postEvent</span><span class="hljs-params">(IEvent iEvent)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">eventClassName</span> <span class="hljs-operator">=</span> iEvent.getClass().getName();<br>        <span class="hljs-type">IEventHandler</span> <span class="hljs-variable">iEventHandler</span> <span class="hljs-operator">=</span> eventHandlerMap.get(eventClassName);<br>        eventBus.register(iEventHandler);<br>        eventBus.post(iEvent);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">asyncPostEvent</span><span class="hljs-params">(IEvent iEvent)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">eventClassName</span> <span class="hljs-operator">=</span> iEvent.getClass().getName();<br>        <span class="hljs-type">IEventHandler</span> <span class="hljs-variable">iEventHandler</span> <span class="hljs-operator">=</span> eventHandlerMap.get(eventClassName);<br>        asyncEventBus.register(iEventHandler);<br>        asyncEventBus.post(iEvent);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.asyncEventExecutorService == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!asyncEventExecutorService.isShutdown()) &#123;<br>            asyncEventExecutorService.shutdown();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (!asyncEventExecutorService.awaitTermination(<span class="hljs-number">10</span>, TimeUnit.SECONDS)) &#123;<br>                    asyncEventExecutorService.shutdownNow();<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerEventHandler</span><span class="hljs-params">(String eventName, IEventHandler iEventHandler)</span> &#123;<br>        eventHandlerMap.put(eventName, iEventHandler);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>因为我们使用的是google的guava事件框架，在guava中，事件处理者要在相关的方法上，添加@Subscribe注解，以便能正确监听到事件，但很多时候，我们在定义事件处理者的时候，经常会忘记加上一些注解，导致后续达不到预期的效果，难以排除问题，因此，这里添加EventBeanPostProcessor类，实现BeanPostProcessor接口，在SpringBoot的bean构造完毕后，我们检查这些事件处理者bean，判断其是否由subscribe注解。</p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs oxygene">package com.yang.job.infra.event.schema<span class="hljs-punctuation">;</span><br><br>import com.google.common.eventbus.Subscribe<span class="hljs-punctuation">;</span><br>import com.yang.job.client.dto.common.BusinessException<span class="hljs-punctuation">;</span><br>import com.yang.job.client.dto.common.ErrorCode<span class="hljs-punctuation">;</span><br>import com.yang.job.infra.event.EventCenter<span class="hljs-punctuation">;</span><br>import com.yang.job.infra.event.IEventHandler<span class="hljs-punctuation">;</span><br>import org.springframework.beans.BeansException<span class="hljs-punctuation">;</span><br>import org.springframework.beans.factory.config.BeanPostProcessor<span class="hljs-punctuation">;</span><br>import org.springframework.stereotype.Component<span class="hljs-punctuation">;</span><br><br>import java.lang.reflect.Method<span class="hljs-punctuation">;</span><br><br>@Component<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> EventBeanPostProcessor <span class="hljs-keyword">implements</span> BeanPostProcessor <span class="hljs-comment">&#123;</span><br><span class="hljs-comment">    @Override</span><br><span class="hljs-comment">    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException &#123;</span><br><span class="hljs-comment">        if (!(bean instanceof IEventHandler)) &#123;</span><br><span class="hljs-comment">            return bean;</span><br><span class="hljs-comment">        &#125;</span><br>        <span class="hljs-keyword">Method</span> <span class="hljs-title function_">subscribeMethod</span> = <span class="hljs-title function_">getSubscribeMethod</span><span class="hljs-params">(bean)</span>;<br>        <span class="hljs-keyword">Class</span>&lt;?&gt;[] parameterTypes = subscribeMethod.getParameterTypes()<span class="hljs-punctuation">;</span><br>        String eventName = parameterTypes[<span class="hljs-number">0</span>].getName()<span class="hljs-punctuation">;</span><br>        EventCenter.registerEventHandler(eventName, (IEventHandler) bean)<span class="hljs-punctuation">;</span><br>        return bean<span class="hljs-punctuation">;</span><br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">Method</span> <span class="hljs-title function_">getSubscribeMethod</span><span class="hljs-params">(Object bean)</span> <span class="hljs-comment">&#123;</span><br><span class="hljs-comment">        Method[] methods = bean.getClass().getDeclaredMethods();</span><br><span class="hljs-comment">        Method subscribeMethod = null;</span><br><span class="hljs-comment">        int subscribeCount = 0;</span><br><span class="hljs-comment">        for (Method method : methods) &#123;</span><br><span class="hljs-comment">            if (!method.isAnnotationPresent(Subscribe.class)) &#123;</span><br><span class="hljs-comment">                continue;</span><br><span class="hljs-comment">            &#125;</span><br>            <span class="hljs-title function_">Class</span>&lt;?&gt;[] <span class="hljs-title function_">parameterTypes</span> = <span class="hljs-title function_">method</span>.<span class="hljs-title function_">getParameterTypes</span><span class="hljs-params">()</span>;<br>            <span class="hljs-keyword">if</span> (parameterTypes.length &gt; <span class="hljs-number">1</span>) <span class="hljs-comment">&#123;</span><br><span class="hljs-comment">                continue;</span><br><span class="hljs-comment">            &#125;</span><br>            <span class="hljs-keyword">if</span> (parameterTypes[<span class="hljs-number">0</span>].isInterface()) <span class="hljs-comment">&#123;</span><br><span class="hljs-comment">                continue;</span><br><span class="hljs-comment">            &#125;</span><br>            ++ subscribeCount<span class="hljs-punctuation">;</span><br>            subscribeMethod = <span class="hljs-keyword">method</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (subscribeCount == <span class="hljs-number">0</span>) <span class="hljs-comment">&#123;</span><br><span class="hljs-comment">            throw new BusinessException(ErrorCode.EVENT_HANDLE_NOT_SUBSCRIBE);</span><br><span class="hljs-comment">        &#125;</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (subscribeCount &gt; <span class="hljs-number">1</span>) <span class="hljs-comment">&#123;</span><br><span class="hljs-comment">            throw new BusinessException(ErrorCode.EVENT_HANDLE_SUBSCRIBE_TOO_MANY_METHOD);</span><br><span class="hljs-comment">        &#125;</span><br>        return subscribeMethod<span class="hljs-punctuation">;</span><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后添加EventBusContext上下文类</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">package</span> com.yang.job.infra.event;<br><br><br><span class="hljs-keyword">import</span> com.yang.job.infra.utils.SpringContextUtils;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationListener;<br><span class="hljs-keyword">import</span> org.springframework.context.event.ApplicationContextEvent;<br><span class="hljs-keyword">import</span> org.springframework.context.event.ContextClosedEvent;<br><span class="hljs-keyword">import</span> org.springframework.context.event.ContextRefreshedEvent;<br><span class="hljs-keyword">import</span> org.springframework.core.Ordered;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusContext</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ApplicationListener</span>&lt;<span class="hljs-title">ApplicationContextEvent</span>&gt;, <span class="hljs-title">Ordered</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> EventBusContext instance;<br><br>    <span class="hljs-keyword">private</span> ApplicationContextEvent applicationContextEvent;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">onApplicationEvent</span><span class="hljs-params">(ApplicationContextEvent event)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> ContextRefreshedEvent) &#123;<br>            System.out.println(<span class="hljs-string">&quot;刷新了==============&quot;</span>);<br>            EventBusContext.instance = <span class="hljs-keyword">this</span>;<br>            instance.applicationContextEvent = applicationContextEvent;<br>        &#125; <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(event <span class="hljs-keyword">instanceof</span> ContextClosedEvent)</span> </span>&#123;<br>            System.out.println(<span class="hljs-string">&quot;销毁了==============&quot;</span>);<br>            EventCenter eventcenter = SpringContextUtils.getBeanOfType(EventCenter.class);<br>            eventcenter.shutdown();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">getOrder</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">30</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>最后，添加event相关的配置类：</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">package</span> com.yang.job.infra.event.configuration;<br><br><span class="hljs-keyword">import</span> com.yang.job.infra.event.EventBusContext;<br><span class="hljs-keyword">import</span> com.yang.job.infra.event.EventCenter;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.*;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-title class_"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusConfiguration</span> </span>&#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> ExecutorService asyncEventExecutorService() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">ThreadPoolExecutor</span>(Runtime.getRuntime().availableProcessors(),<br>                Runtime.getRuntime().availableProcessors() * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>,<br>                <span class="hljs-number">60</span>, TimeUnit.SECONDS,<br>                <span class="hljs-keyword">new</span> <span class="hljs-type">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">200</span>),<br>                Executors.defaultThreadFactory(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-type">ThreadPoolExecutor</span>.CallerRunsPolicy());<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> EventCenter eventCenter() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">EventCenter</span>(asyncEventExecutorService());<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> EventBusContext eventBusContext() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">EventBusContext</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>上述event基础设施搭建完毕后，我们开始添加对应的事件。但是这个事件应该放在哪一层，是比较困惑我的，因为这个不算领域事件，毕竟我们项目中并没有涉及到其他的域，但是如果放在application层又不太好，毕竟application只是对业务流程的编排，是一层薄薄的封装，而这些事件处理者是承担一部分业务逻辑的，最后决定还是放在domain层，理由是domain层主要是业务逻辑的封装，而事件也是业务逻辑的一部分。<br>我们添加定时任务添加成功后置事件：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">package</span> com.yang.job.domain.event;<br><br><br><span class="hljs-keyword">import</span> com.yang.job.infra.event.IEvent;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SaveJobPostEvent</span> <span class="hljs-title">implements</span> <span class="hljs-title">IEvent</span>&lt;<span class="hljs-type">Integer</span>&gt; &#123;<br>    <span class="hljs-keyword">private</span> Integer jobId;<br><br>    <span class="hljs-keyword">public</span> SaveJobPostEvent(Integer jobId) &#123;<br>        <span class="hljs-keyword">this</span>.jobId = jobId;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Integer getData() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.jobId;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>添加对应的事件处理者：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.job.domain.event.handler;<br><br><br><span class="hljs-keyword">import</span> com.google.common.eventbus.Subscribe;<br><span class="hljs-keyword">import</span> com.yang.job.domain.event.SaveJobPostEvent;<br><span class="hljs-keyword">import</span> com.yang.job.domain.gateway.repository.IJobModelRepository;<br><span class="hljs-keyword">import</span> com.yang.job.domain.model.YangJobModel;<br><span class="hljs-keyword">import</span> com.yang.job.infra.event.IEventHandler;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SaveJobPostEventHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IEventHandler</span>&lt;SaveJobPostEvent&gt; &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> IJobModelRepository jobModelRepository;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Subscribe</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(SaveJobPostEvent event)</span> &#123;<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">jobId</span> <span class="hljs-operator">=</span> event.getData();<br>        <span class="hljs-type">YangJobModel</span> <span class="hljs-variable">yangJobModel</span> <span class="hljs-operator">=</span> jobModelRepository.getYangJobModelById(jobId);<br>        <span class="hljs-keyword">if</span> (yangJobModel == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!yangJobModel.isOpen()) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// 执行任务</span><br>        yangJobModel.submitJob();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后我们修改YangJobApplicationService的saveYangJob方法，在持久化数据库成功后，发送持久化成功后置事件：</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-meta">@Override</span><br>   <span class="hljs-keyword">public</span> Response&lt;YangJobDTO&gt; saveYangJob(NewYangJobCommand <span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>) &#123;<br>       YangJobModel yangJobModel = convert2YangJobModel(<span class="hljs-keyword">new</span><span class="hljs-type">YangJobCommand</span>);<br>       <span class="hljs-keyword">if</span> (jobModelRepository.saveYangJobModel(yangJobModel)) &#123;<br>           <span class="hljs-comment">// 发送事件</span><br>           yangJobModel.postSaveJobEvent();<br>           YangJobDTO yangJobDTO = yangJobDTOConvertor.convert2DTO(yangJobModel);<br>           <span class="hljs-keyword">return</span> Response.success(yangJobDTO);<br>       &#125;<br>       <span class="hljs-keyword">return</span> Response.fail();<br>   &#125;<br></code></pre></td></tr></table></figure><p>修改YangJobModel，加上推送事件的方法：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postSaveJobEvent</span>()</span> &#123;<br>    SaveJobPostEvent saveJobPostEvent = <span class="hljs-keyword">new</span> SaveJobPostEvent(<span class="hljs-keyword">this</span>.jobId);<br>    getEventCenter().asyncPostEvent(saveJobPostEvent);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> EventCenter <span class="hljs-title">getEventCenter</span>()</span> &#123;<br>    <span class="hljs-keyword">return</span> SpringContextUtils.getBeanOfType(EventCenter.<span class="hljs-keyword">class</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>重新启动项目，我们再次添加一个定时任务，并将定时任务设置为open</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/15.png" class=""><p>添加成功后，我们查看控制台，可以看到，确实有发送对应的事件，将定时任务注册到YangJobManger中。</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/16.png" class=""><h4 id="更新定时任务后置事件"><a href="#更新定时任务后置事件" class="headerlink" title="更新定时任务后置事件"></a>更新定时任务后置事件</h4><p>添加更新定时任务后置事件：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">package</span> com.yang.job.domain.event;<br><br><span class="hljs-keyword">import</span> com.yang.job.infra.event.IEvent;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UpdateJobPostEvent</span> <span class="hljs-title">implements</span> <span class="hljs-title">IEvent</span>&lt;<span class="hljs-type">Integer</span>&gt; &#123;<br>    <span class="hljs-keyword">private</span> Integer jobId;<br><br>    <span class="hljs-keyword">public</span> UpdateJobPostEvent(Integer jobId) &#123;<br>        <span class="hljs-keyword">this</span>.jobId = jobId;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Integer getData() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.jobId;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>添加对应的事件处理者，当我们更新定时任务后，可能更新的内容是将定时任务关闭或开启，也可能是对应的策略，因此，我们的事件处理者会首先关闭对应的定时任务，然后再判断定时任务是否开启，开启的话，重新将任务注册到YangJobManager中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.job.domain.event.handler;<br><br><br><span class="hljs-keyword">import</span> com.google.common.eventbus.Subscribe;<br><span class="hljs-keyword">import</span> com.yang.job.domain.event.UpdateJobPostEvent;<br><span class="hljs-keyword">import</span> com.yang.job.domain.gateway.repository.IJobModelRepository;<br><span class="hljs-keyword">import</span> com.yang.job.domain.model.YangJobModel;<br><span class="hljs-keyword">import</span> com.yang.job.infra.event.IEventHandler;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UpdateJobPostEventHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IEventHandler</span>&lt;UpdateJobPostEvent&gt; &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> IJobModelRepository jobModelRepository;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Subscribe</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(UpdateJobPostEvent event)</span> &#123;<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">jobId</span> <span class="hljs-operator">=</span> event.getData();<br>        <span class="hljs-type">YangJobModel</span> <span class="hljs-variable">yangJobModel</span> <span class="hljs-operator">=</span> jobModelRepository.getYangJobModelById(jobId);<br>        <span class="hljs-keyword">if</span> (yangJobModel == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// 先取消任务</span><br>        yangJobModel.cancelJob();<br>        <span class="hljs-keyword">if</span> (yangJobModel.isOpen()) &#123;<br>            <span class="hljs-comment">// 重新执行任务</span><br>            yangJobModel.submitJob();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>修改YangJobModel，加上取消任务和推送更新后置事件的方法</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">cancelJob</span>()</span> &#123;<br>     YangJobManager yangJobManager = getYangJobManager();<br>     yangJobManager.cancelJob(<span class="hljs-keyword">this</span>.jobId);<br> &#125;<br><br> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postUpdateJobEvent</span>()</span> &#123;<br>     UpdateJobPostEvent updateJobPostEvent = <span class="hljs-keyword">new</span> UpdateJobPostEvent(<span class="hljs-keyword">this</span>.jobId);<br>     getEventCenter().asyncPostEvent(updateJobPostEvent);<br> &#125;<br></code></pre></td></tr></table></figure><p>最后，我们修改YangJobApplicationService的updateYangJob方法，在持久化数据库后，发送更新定时任务后置事件</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs sas">@Override<br>   public Response&lt;YangJobDTO&gt; updateYangJob(UpdateYangJobCommand updateYangJobCommand) &#123;<br>       YangJobModel yangJobModel = jobModelRepository.getYangJobModelById(updateYangJobCommand.getJobId());<br>       <span class="hljs-keyword">if</span> (yangJobModel == <span class="hljs-keyword">null</span>) &#123;<br>           <span class="hljs-keyword">return</span> Response.fail();<br>       &#125;<br><br>       <span class="hljs-keyword">if</span> (updateYangJobCommand.getJobName() != <span class="hljs-keyword">null</span>) &#123;<br>           yangJobModel.setJobName(updateYangJobCommand.getJobName());<br>       &#125;<br>       <span class="hljs-keyword">if</span> (updateYangJobCommand.getCro<span class="hljs-meta">n</span>() != <span class="hljs-keyword">null</span>) &#123;<br>           yangJobModel.setCro<span class="hljs-meta">n</span>(updateYangJobCommand.getCro<span class="hljs-meta">n</span>());<br>       &#125;<br>       <span class="hljs-keyword">if</span> (updateYangJobCommand.get<span class="hljs-meta">Open</span>() != <span class="hljs-keyword">null</span>) &#123;<br>           yangJobModel.<span class="hljs-keyword">set</span><span class="hljs-meta">Open</span>(updateYangJobCommand.get<span class="hljs-meta">Open</span>());<br>       &#125;<br>       <span class="hljs-keyword">if</span> (!updateYangJobCommand.getParams().isEmpty()) &#123;<br>           yangJobModel.setExecuteParamMap(updateYangJobCommand.getParams());<br>       &#125;<br>       <span class="hljs-keyword">if</span> (updateYangJobCommand.getExecuteClassPath() != <span class="hljs-keyword">null</span>) &#123;<br>           yangJobModel.setExecuteClassPath(updateYangJobCommand.getExecuteClassPath());<br>       &#125;<br>       <span class="hljs-keyword">if</span> (updateYangJobCommand.getExecuteStrategy() != <span class="hljs-keyword">null</span>) &#123;<br>           yangJobModel.setExecuteStrategy(JobExecuteStrategyEnum.getJobExecuteStrategyByName(updateYangJobCommand.getExecuteStrategy()));<br>       &#125;<br>       <span class="hljs-keyword">if</span> (jobModelRepository.updateYangJobModel(yangJobModel)) &#123;<br>          // 发送事件<br>           yangJobModel.postUpdateJobEvent();<br>           YangJobDTO yangJobDTO = yangJobDTOConvertor.convert2DTO(yangJobModel);<br>           <span class="hljs-keyword">return</span> Response.success(yangJobDTO);<br>       &#125;<br>       <span class="hljs-keyword">return</span> Response.fail();<br>   &#125;<br><br></code></pre></td></tr></table></figure><p>重启项目，我们先观察控制台，可以看到jobId为14的任务每5秒执行一次</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/17.png" class=""><p>然后我们调用close接口，关闭jobId为14的定时任务。</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/18.png" class=""><p>调用成功后，再次查看控制台，可见此时该定时任务不再执行。</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/19.png" class=""><h4 id="删除定时任务后置事件"><a href="#删除定时任务后置事件" class="headerlink" title="删除定时任务后置事件"></a>删除定时任务后置事件</h4><p>因为我们这里的删除，其实都是逻辑删除，本质上其实就是更新了enable字段，因此，删除成功后，推送更新定时任务后置事件即可，不过，这里虽然没有专门的删除定时任务后置事件，但还是在YangJobModel中，添加一个postDeleteJobEvent方法。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postDeleteJobEvent</span>()</span> &#123;<br>        UpdateJobPostEvent updateJobPostEvent = <span class="hljs-keyword">new</span> UpdateJobPostEvent(<span class="hljs-keyword">this</span>.jobId);<br>        getEventCenter().asyncPostEvent(updateJobPostEvent);<br>    &#125;<br></code></pre></td></tr></table></figure><p>然后我们修改YangJobApplicationService的deleteYangJob方法，在删除操作成功后，调用postDeleteJobEvent方法，推送对应的事件。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Response&lt;YangJobDTO&gt; <span class="hljs-title function_">deleteYangJob</span><span class="hljs-params">(DeleteYangJobCommand deleteYangJobCommand)</span> &#123;<br>      <span class="hljs-type">Integer</span> <span class="hljs-variable">jobId</span> <span class="hljs-operator">=</span> deleteYangJobCommand.getJobId();<br>      <span class="hljs-keyword">if</span> (jobModelRepository.deleteJobModel(jobId)) &#123;<br>          <span class="hljs-type">YangJobModel</span> <span class="hljs-variable">yangJobModel</span> <span class="hljs-operator">=</span> jobModelRepository.getYangJobModelById(jobId);<br>          yangJobModel.postDeleteJobEvent();<br>          <span class="hljs-keyword">return</span> Response.success();<br>      &#125;<br>      <span class="hljs-keyword">return</span> Response.fail();<br>  &#125;<br></code></pre></td></tr></table></figure><h4 id="提交任务后置事件"><a href="#提交任务后置事件" class="headerlink" title="提交任务后置事件"></a>提交任务后置事件</h4><p>之前我们提到，任务的执行策略有四种——立即执行、执行一次、任务执行完毕后间隔执行、任务执行开始后间隔执行。但是我们现在的系统中，假设前两种策略对应的定时任务执行过了，那么按道理来说，不应该再继续执行了，可是，当我们重启系统时，因为它们在数据库中的open字段值为1，也就是任务状态是开启的，所以会再次被执行。<br>为解决上述问题，我们在提交任务给YangJobManager后，发送一个提交任务后置事件，在对应的事件处理者中，判断执行策略，如果是前两种策略，那么我们提交成功后需要把任务状态设置为关闭。<br>首先，我们添加提交任务后置事件：</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">package</span> com.yang.job.domain.event;<br><br><br><span class="hljs-keyword">import</span> com.yang.job.infra.event.IEvent;<br><span class="hljs-keyword">import</span> com.yang.job.infra.job.request.YangJobSubmitParam;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SubmitJobPostEvent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IEvent</span>&lt;<span class="hljs-title">YangJobSubmitParam</span>&gt; </span>&#123;<br>    <span class="hljs-keyword">private</span> YangJobSubmitParam yangJobSubmitParam;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SubmitJobPostEvent</span><span class="hljs-params">(YangJobSubmitParam yangJobSubmitParam)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.yangJobSubmitParam = yangJobSubmitParam;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function">YangJobSubmitParam <span class="hljs-title">getData</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> yangJobSubmitParam;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>添加对应的事件处理者：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.job.domain.event.handler;<br><br><span class="hljs-keyword">import</span> com.google.common.eventbus.Subscribe;<br><span class="hljs-keyword">import</span> com.yang.job.domain.enums.JobExecuteStrategyEnum;<br><span class="hljs-keyword">import</span> com.yang.job.domain.event.SubmitJobPostEvent;<br><span class="hljs-keyword">import</span> com.yang.job.domain.gateway.repository.IJobModelRepository;<br><span class="hljs-keyword">import</span> com.yang.job.domain.model.YangJobModel;<br><span class="hljs-keyword">import</span> com.yang.job.infra.event.IEventHandler;<br><span class="hljs-keyword">import</span> com.yang.job.infra.job.request.YangJobSubmitParam;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SubmitJobPostEventHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IEventHandler</span>&lt;SubmitJobPostEvent&gt; &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> IJobModelRepository jobModelRepository;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Subscribe</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(SubmitJobPostEvent event)</span> &#123;<br>        <span class="hljs-type">YangJobSubmitParam</span> <span class="hljs-variable">yangJobSubmitParam</span> <span class="hljs-operator">=</span> event.getData();<br>        <span class="hljs-type">JobExecuteStrategyEnum</span> <span class="hljs-variable">jobExecuteStrategy</span> <span class="hljs-operator">=</span> yangJobSubmitParam.getJobExecuteStrategy();<br>        <span class="hljs-keyword">if</span> (jobExecuteStrategy == JobExecuteStrategyEnum.IMMEDIATE_EXECUTE || jobExecuteStrategy == JobExecuteStrategyEnum.ONCE) &#123;<br>            <span class="hljs-comment">// 对于立即执行的任务，执行完毕后，要关闭任务</span><br>            <span class="hljs-type">YangJobModel</span> <span class="hljs-variable">yangJobModel</span> <span class="hljs-operator">=</span> jobModelRepository.getYangJobModelById(yangJobSubmitParam.getJobId());<br>            <span class="hljs-keyword">if</span> (!yangJobModel.isOpen()) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            yangJobModel.setOpen(<span class="hljs-number">0</span>);<br>            jobModelRepository.updateYangJobModel(yangJobModel);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>最后，我们修改YangJobModel的submitJob方法，在提交任务后，发送提交任务后置事件</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs abnf">public void submitJob() &#123;<br>       YangJobSubmitParam yangJobSubmitParam <span class="hljs-operator">=</span> convert2YangJobSubmitParam()<span class="hljs-comment">;</span><br>       YangJobManager yangJobManager <span class="hljs-operator">=</span> getYangJobManager()<span class="hljs-comment">;</span><br>       yangJobManager.submitJob(yangJobSubmitParam)<span class="hljs-comment">;</span><br>       // 提交任务后，发送提交任务后置事件<br>       SubmitJobPostEvent submitJobPostEvent <span class="hljs-operator">=</span> new SubmitJobPostEvent(yangJobSubmitParam)<span class="hljs-comment">;</span><br>       getEventCenter().postEvent(submitJobPostEvent)<span class="hljs-comment">;</span><br>   &#125;<br></code></pre></td></tr></table></figure><p>上述准备完毕后，我们启动项目：<br>在数据库中，jobId&#x3D;12的，执行策略为once，那么在启动项目后，发送提交任务后置事件，会将jobId的open属性重新设置为0</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/20.png" class=""><p>我们启动项目后，刷新数据库，可见open确实被重新设置为0。</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E6%9C%AC%E5%9C%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/21.png" class="">]]></content>
    
    
    
    <tags>
      
      <tag>XXL-JOB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>手撸XXL-JOB（二）—定时任务管理</title>
    <link href="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86/"/>
    <url>/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86/</url>
    
    <content type="html"><![CDATA[<p>在上一节中，我们介绍了SpringBoot中关于定时任务的执行方式，以及ScheduledExecutorService接口提供的定时任务执行方法。假设我们现在要写类似XXL-JOB这样的任务调度平台，那么，对于任务的管理，是尤为重要的。接下来我们将一步一步，实现一个任务调度管理类。</p><h3 id="YangJobManager类基础实现"><a href="#YangJobManager类基础实现" class="headerlink" title="YangJobManager类基础实现"></a>YangJobManager类基础实现</h3><p>假设我们现在的任务管理类，名为YangJobManager类。对于定时任务的执行，我们最终会调用到ScheduledExecutorService的相关方法，因此，我们的YangJobManager类，需要有ScheduledExecutorService属性，其次，我们希望能对要执行的定时线程任务，其命名进行修改，因此，我们需要有一个线程工厂的属性。基于上述两点，我们对YangJobManager类进行实现：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs arduino">package com.yang.job;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.ScheduledExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.ThreadFactory;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YangJobManager</span> &#123;<br>    <span class="hljs-keyword">private</span> ScheduledExecutorService scheduledExecutorService;<br><br>    <span class="hljs-keyword">private</span> ThreadFactory threadFactory;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">YangJobManager</span><span class="hljs-params">(ScheduledExecutorService scheduledExecutorService, ThreadFactory threadFactory)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.scheduledExecutorService = scheduledExecutorService;<br>        <span class="hljs-keyword">this</span>.threadFactory = threadFactory;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">schedule</span><span class="hljs-params">(Runnable runnable, Long delay)</span> </span>&#123;<br>        Thread thread = threadFactory.<span class="hljs-built_in">newThread</span>(runnable);<br>        scheduledExecutorService.<span class="hljs-built_in">schedule</span>(thread, delay, TimeUnit.SECONDS);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">scheduleWithFixedDelay</span><span class="hljs-params">(Runnable runnable, Long delay, Long period)</span> </span>&#123;<br>        Thread thread = threadFactory.<span class="hljs-built_in">newThread</span>(runnable);<br>        scheduledExecutorService.<span class="hljs-built_in">scheduleWithFixedDelay</span>(thread, delay, period, TimeUnit.SECONDS);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">scheduleWithFixedRate</span><span class="hljs-params">(Runnable runnable, Long delay, Long period)</span> </span>&#123;<br>        Thread thread = threadFactory.<span class="hljs-built_in">newThread</span>(runnable);<br>        scheduledExecutorService.<span class="hljs-built_in">scheduleAtFixedRate</span>(thread, delay, period, TimeUnit.SECONDS);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">shutdown</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.scheduledExecutorService == null) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.scheduledExecutorService.<span class="hljs-built_in">isShutdown</span>()) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        scheduledExecutorService.<span class="hljs-built_in">shutdown</span>();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (!scheduledExecutorService.<span class="hljs-built_in">awaitTermination</span>(<span class="hljs-number">10</span>, TimeUnit.SECONDS)) &#123;<br>                scheduledExecutorService.<span class="hljs-built_in">shutdownNow</span>();<br>            &#125;<br>        &#125; <span class="hljs-built_in">catch</span> (InterruptedException e) &#123;<br>            e.<span class="hljs-built_in">printStackTrace</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后，我们实现YangJobThreadFactory，完成对线程的命名</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">public</span> <span class="hljs-title class_"><span class="hljs-keyword">class</span> <span class="hljs-title">YangJobThreadFactory</span> <span class="hljs-keyword"><span class="hljs-keyword">implements</span> <span class="hljs-type">ThreadFactory</span></span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> poolName;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> threadPrefixName;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AtomicInteger poolNumber = <span class="hljs-keyword">new</span> <span class="hljs-type">AtomicInteger</span>(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">private</span> AtomicInteger threadNumber = <span class="hljs-keyword">new</span> <span class="hljs-type">AtomicInteger</span>(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">public</span> YangJobThreadFactory(<span class="hljs-keyword">String</span> poolName) &#123;<br>        <span class="hljs-built_in">this</span>.poolName = poolName;<br>        <span class="hljs-built_in">this</span>.threadPrefixName = poolName + <span class="hljs-string">&quot;-pool-&quot;</span> + poolNumber.getAndIncrement() + <span class="hljs-string">&quot;-thread-&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">String</span> getPoolName() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.poolName;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Thread <span class="hljs-keyword">new</span><span class="hljs-type">Thread</span>(Runnable r) &#123;<br>        Thread thread = <span class="hljs-keyword">new</span> <span class="hljs-type">Thread</span>(r);<br>        thread.setName(<span class="hljs-built_in">this</span>.threadPrefixName + threadNumber.getAndIncrement());<br>        <span class="hljs-keyword">return</span> thread;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后我们添加测试方法：</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs livescript">public <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> main(<span class="hljs-built_in">String</span>[] args) &#123;<br>       ThreadFactory threadFactory = <span class="hljs-keyword">new</span> YangJobThreadFactory(<span class="hljs-string">&quot;yang&quot;</span>);<br>       ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(<span class="hljs-number">4</span>, threadFactory);<br>       YangJobManager yangJobManager = <span class="hljs-keyword">new</span> YangJobManager(scheduledExecutorService, threadFactory);<br><br>       yangJobManager.schedule<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">           System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;schedule定时任务开始执行：&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>());</span></span><br><span class="hljs-params"><span class="hljs-function">       &#125;, <span class="hljs-number">1</span>L)</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">       <span class="hljs-title">yangJobManager</span>.<span class="hljs-title">scheduleWithFixedDelay</span><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">           System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;withFixedDelay定时任务开始执行：&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>());</span></span><br><span class="hljs-params"><span class="hljs-function">       &#125;, <span class="hljs-number">0</span>L, <span class="hljs-number">1</span>L)</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">       <span class="hljs-title">yangJobManager</span>.<span class="hljs-title">scheduleWithFixedRate</span><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">           System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;withFixedRate定时任务开始执行：&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>());</span></span><br><span class="hljs-params"><span class="hljs-function">       &#125;, <span class="hljs-number">0</span>L, <span class="hljs-number">1</span>L)</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">       <span class="hljs-title">try</span> &#123;</span><br><span class="hljs-function">           <span class="hljs-title">Thread</span>.<span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">20000</span>)</span>;</span><br><span class="hljs-function">       &#125; <span class="hljs-title">catch</span> <span class="hljs-params">(InterruptedException e)</span> &#123;</span><br><span class="hljs-function">           <span class="hljs-title">throw</span> <span class="hljs-title">new</span> <span class="hljs-title">RuntimeException</span><span class="hljs-params">(e)</span>;</span><br><span class="hljs-function">       &#125;</span><br><span class="hljs-function">       <span class="hljs-title">yangJobManager</span>.<span class="hljs-title">shutdown</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">   &#125;</span><br></code></pre></td></tr></table></figure><p>执行结果如下：</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86/1.png" class=""><h3 id="提供统一的schedule方法"><a href="#提供统一的schedule方法" class="headerlink" title="提供统一的schedule方法"></a>提供统一的schedule方法</h3><p>虽然我们能顺利将任务提交给YangJobManager执行，当感觉还不够收敛，因为我们创建了三个方法：schedule，scheduleWithFixedDelay, shceduleWithFixedRate，每个方法执行逻辑都差不多，最后都是调用scheduledExecutorService的相关方法，我们可以将这些方法都收敛到一个入口——schedule，然后在入参中添加一个参数，表示要执行的策略，根据入参的参数，选择对应的方法执行。<br>首先，我们添加一个执行策略枚举：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs typescript">package com.<span class="hljs-property">yang</span>.<span class="hljs-property">job</span>.<span class="hljs-property">enums</span>;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">JobExecuteStrategyEnum</span> &#123;<br>    <span class="hljs-title function_">IMMEDIATE_EXECUTE</span>(<span class="hljs-string">&quot;immediate&quot;</span>, <span class="hljs-string">&quot;立即执行&quot;</span>),<br>    <span class="hljs-title function_">ONCE</span>(<span class="hljs-string">&quot;once&quot;</span>, <span class="hljs-string">&quot;执行一次&quot;</span>),<br>    <span class="hljs-title function_">WITH_FIXED_DELAY</span>(<span class="hljs-string">&quot;withFixedDelay&quot;</span>, <span class="hljs-string">&quot;任务执行完毕后间隔执行&quot;</span>),<br>    <span class="hljs-title function_">WITH_FIXED_RATE</span>(<span class="hljs-string">&quot;withFixedRate&quot;</span>, <span class="hljs-string">&quot;任务执行开始后间隔执行&quot;</span>);<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> name;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> description;<br><br>    <span class="hljs-title class_">JobExecuteStrategyEnum</span>(<span class="hljs-title class_">String</span> name, <span class="hljs-title class_">String</span> description) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">description</span> = description;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getName</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">JobExecuteStrategyEnum</span> <span class="hljs-title function_">getJobExecuteStrategyByName</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> name</span>) &#123;<br>        <span class="hljs-keyword">if</span> (name == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">JobExecuteStrategyEnum</span> value : <span class="hljs-title function_">values</span>()) &#123;<br>            <span class="hljs-keyword">if</span> (name.<span class="hljs-title function_">equals</span>(value.<span class="hljs-title function_">getName</span>())) &#123;<br>                <span class="hljs-keyword">return</span> value;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isLegal</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> name</span>) &#123;<br>        <span class="hljs-title class_">JobExecuteStrategyEnum</span> jobExecuteStrategyByName = <span class="hljs-title function_">getJobExecuteStrategyByName</span>(name);<br>        <span class="hljs-keyword">return</span> jobExecuteStrategyByName != <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getDescription</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> description;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后添加YangJobManager的schedule方法的入参类：</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">package</span> com.yang.job.request;<br><br><span class="hljs-keyword">import</span> com.yang.job.enums.JobExecuteStrategyEnum;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-title class_"><span class="hljs-keyword">class</span> <span class="hljs-title">YangJobSubmitParam</span> <span class="hljs-keyword"><span class="hljs-keyword">implements</span> <span class="hljs-type">Serializable</span></span> </span>&#123;<br>    <span class="hljs-keyword">private</span> Runnable runnable;<br>    <br>    <span class="hljs-keyword">private</span> Integer initialDelay;<br>    <br>    <span class="hljs-keyword">private</span> Integer period;<br>    <br>    <span class="hljs-keyword">private</span> JobExecuteStrategyEnum jobExecuteStrategy;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>最后，修改YangJobManager类，将执行定时任务收敛到schedule方法，进入该方法，首先根据入参判断执行策略，如果是immediate，那么直接对入参的runnable调用run方法执行接口，其他的策略则分别对应scheduledExecutorService的schedule、scheduledWithFixedDelay、scheduledWithFixedRate方法，此外，这里对属性也进行修改，去除ThreadFactory属性。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.job;<br><br><span class="hljs-keyword">import</span> com.yang.job.enums.JobExecuteStrategyEnum;<br><span class="hljs-keyword">import</span> com.yang.job.request.YangJobSubmitParam;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.ScheduledExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YangJobManager</span> &#123;<br>    <span class="hljs-keyword">private</span> ScheduledExecutorService scheduledExecutorService;<br>    <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">YangJobManager</span><span class="hljs-params">(ScheduledExecutorService scheduledExecutorService)</span> &#123;<br>        <span class="hljs-built_in">this</span>.scheduledExecutorService = scheduledExecutorService;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">schedule</span><span class="hljs-params">(YangJobSubmitParam yangJobSubmitParam)</span> &#123;<br>        <span class="hljs-type">JobExecuteStrategyEnum</span> <span class="hljs-variable">jobExecuteStrategy</span> <span class="hljs-operator">=</span> yangJobSubmitParam.getJobExecuteStrategy();<br>        <span class="hljs-keyword">if</span> (jobExecuteStrategy == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;缺少执行策略=========&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">Runnable</span> <span class="hljs-variable">runnable</span> <span class="hljs-operator">=</span> yangJobSubmitParam.getRunnable();<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">initialDelay</span> <span class="hljs-operator">=</span> yangJobSubmitParam.getInitialDelay();<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">period</span> <span class="hljs-operator">=</span> yangJobSubmitParam.getPeriod();<br>        <span class="hljs-keyword">switch</span> (jobExecuteStrategy) &#123;<br>            <span class="hljs-keyword">case</span> IMMEDIATE_EXECUTE:<br>                runnable.run();<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> ONCE:<br>                scheduledExecutorService.schedule(runnable, initialDelay, TimeUnit.SECONDS);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> WITH_FIXED_DELAY:<br>                scheduledExecutorService.scheduleWithFixedDelay(runnable, initialDelay, period, TimeUnit.SECONDS);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> WITH_FIXED_RATE:<br>                scheduledExecutorService.scheduleAtFixedRate(runnable, initialDelay, period, TimeUnit.SECONDS);<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.scheduledExecutorService == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.scheduledExecutorService.isShutdown()) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        scheduledExecutorService.shutdown();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (!scheduledExecutorService.awaitTermination(<span class="hljs-number">10</span>, TimeUnit.SECONDS)) &#123;<br>                scheduledExecutorService.shutdownNow();<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>最后，我们添加测试方法：</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs livescript">public <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> main(<span class="hljs-built_in">String</span>[] args) &#123;<br>        ThreadFactory threadFactory = <span class="hljs-keyword">new</span> YangJobThreadFactory(<span class="hljs-string">&quot;yang&quot;</span>);<br>        ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(<span class="hljs-number">4</span>, threadFactory);<br>        YangJobManager yangJobManager = <span class="hljs-keyword">new</span> YangJobManager(scheduledExecutorService);<br><br>        YangJobSubmitParam yangJobSubmitParam1 = <span class="hljs-keyword">new</span> YangJobSubmitParam();<br>        yangJobSubmitParam1.setRunnable<span class="hljs-function"><span class="hljs-params">(() -&gt; System.out.println(<span class="hljs-string">&quot;立即执行======&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()))</span>;</span><br><span class="hljs-function">        <span class="hljs-title">yangJobSubmitParam1</span>.<span class="hljs-title">setJobExecuteStrategy</span><span class="hljs-params">(JobExecuteStrategyEnum.IMMEDIATE_EXECUTE)</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">        <span class="hljs-title">YangJobSubmitParam</span> <span class="hljs-title">yangJobSubmitParam2</span> = <span class="hljs-title">new</span> <span class="hljs-title">YangJobSubmitParam</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        <span class="hljs-title">yangJobSubmitParam2</span>.<span class="hljs-title">setRunnable</span><span class="hljs-params">(() -&gt; System.out.println(<span class="hljs-string">&quot;执行一次======&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()))</span>;</span><br><span class="hljs-function">        <span class="hljs-title">yangJobSubmitParam2</span>.<span class="hljs-title">setInitialDelay</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span>;</span><br><span class="hljs-function">        <span class="hljs-title">yangJobSubmitParam2</span>.<span class="hljs-title">setJobExecuteStrategy</span><span class="hljs-params">(JobExecuteStrategyEnum.ONCE)</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">        <span class="hljs-title">YangJobSubmitParam</span> <span class="hljs-title">yangJobSubmitParam3</span> = <span class="hljs-title">new</span> <span class="hljs-title">YangJobSubmitParam</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        <span class="hljs-title">yangJobSubmitParam3</span>.<span class="hljs-title">setRunnable</span><span class="hljs-params">(() -&gt; System.out.println(<span class="hljs-string">&quot;withFixedDelay=====&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()))</span>;</span><br><span class="hljs-function">        <span class="hljs-title">yangJobSubmitParam3</span>.<span class="hljs-title">setInitialDelay</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span>;</span><br><span class="hljs-function">        <span class="hljs-title">yangJobSubmitParam3</span>.<span class="hljs-title">setPeriod</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span>;</span><br><span class="hljs-function">        <span class="hljs-title">yangJobSubmitParam3</span>.<span class="hljs-title">setJobExecuteStrategy</span><span class="hljs-params">(JobExecuteStrategyEnum.WITH_FIXED_DELAY)</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">        <span class="hljs-title">YangJobSubmitParam</span> <span class="hljs-title">yangJobSubmitParam4</span> = <span class="hljs-title">new</span> <span class="hljs-title">YangJobSubmitParam</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        <span class="hljs-title">yangJobSubmitParam4</span>.<span class="hljs-title">setRunnable</span><span class="hljs-params">(() -&gt; System.out.println(<span class="hljs-string">&quot;withFixedRate=====&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()))</span>;</span><br><span class="hljs-function">        <span class="hljs-title">yangJobSubmitParam4</span>.<span class="hljs-title">setInitialDelay</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span>;</span><br><span class="hljs-function">        <span class="hljs-title">yangJobSubmitParam4</span>.<span class="hljs-title">setPeriod</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span>;</span><br><span class="hljs-function">        <span class="hljs-title">yangJobSubmitParam4</span>.<span class="hljs-title">setJobExecuteStrategy</span><span class="hljs-params">(JobExecuteStrategyEnum.WITH_FIXED_RATE)</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">        <span class="hljs-title">yangJobManager</span>.<span class="hljs-title">schedule</span><span class="hljs-params">(yangJobSubmitParam1)</span>;</span><br><span class="hljs-function">        <span class="hljs-title">yangJobManager</span>.<span class="hljs-title">schedule</span><span class="hljs-params">(yangJobSubmitParam2)</span>;</span><br><span class="hljs-function">        <span class="hljs-title">yangJobManager</span>.<span class="hljs-title">schedule</span><span class="hljs-params">(yangJobSubmitParam3)</span>;</span><br><span class="hljs-function">        <span class="hljs-title">yangJobManager</span>.<span class="hljs-title">schedule</span><span class="hljs-params">(yangJobSubmitParam4)</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">        <span class="hljs-title">try</span> &#123;</span><br><span class="hljs-function">            <span class="hljs-title">Thread</span>.<span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">20000</span>)</span>;</span><br><span class="hljs-function">        &#125; <span class="hljs-title">catch</span> <span class="hljs-params">(InterruptedException e)</span> &#123;</span><br><span class="hljs-function">            <span class="hljs-title">throw</span> <span class="hljs-title">new</span> <span class="hljs-title">RuntimeException</span><span class="hljs-params">(e)</span>;</span><br><span class="hljs-function">        &#125;</span><br><span class="hljs-function">        <span class="hljs-title">yangJobManager</span>.<span class="hljs-title">shutdown</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">    &#125;</span><br></code></pre></td></tr></table></figure><p>执行结果如下：</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86/2.png" class=""><h3 id="提交任务和取消任务"><a href="#提交任务和取消任务" class="headerlink" title="提交任务和取消任务"></a>提交任务和取消任务</h3><p>任务的提交对应的是schedule方法，但我们的YangJobManager类缺少了关于任务的取消逻辑。在ScheduledExecutorService的各个定时执行方法中，其返回值是一个ScheduleFuture类，我们可以通过该类的cancel方法，来将对应的线程任务进行取消。此外，对于每一个任务，我们需要有一个任务标识，所以，我们先修改YangJobSubmitParam类：</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs fortran">package com.yang.job.request;<br><br><span class="hljs-keyword">import</span> com.yang.job.enums.JobExecuteStrategyEnum;<br><span class="hljs-keyword">import</span> lombok.<span class="hljs-keyword">Data</span>;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br>@<span class="hljs-keyword">Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> YangJobSubmitParam implements Serializable &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">Integer</span> jobId;<br>    <br>    <span class="hljs-keyword">private</span> Runnable runnable;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">Integer</span> initialDelay;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">Integer</span> period;<br><br>    <span class="hljs-keyword">private</span> JobExecuteStrategyEnum jobExecuteStrategy;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后，我们修改YangJobManager类，首先将schedule方法改为submit方法，这样更见名知义，在submit方法中，除了理解执行策略外，其他策略都会获取返回的ScheduleFuture，然后存入对应的map，在取消的时候，我们根据jobId从map中找到对应的ScheduleFuture，并执行cancel方法，以此来取消任务。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.job;<br><br><span class="hljs-keyword">import</span> com.yang.job.enums.JobExecuteStrategyEnum;<br><span class="hljs-keyword">import</span> com.yang.job.request.YangJobSubmitParam;<br><br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentHashMap;<br><span class="hljs-keyword">import</span> java.util.concurrent.ScheduledExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.ScheduledFuture;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YangJobManager</span> &#123;<br>    <span class="hljs-keyword">private</span> ScheduledExecutorService scheduledExecutorService;<br><br>    <span class="hljs-keyword">private</span> Map&lt;String, ScheduledFuture&gt; jobId2ScheduleFutureMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">YangJobManager</span><span class="hljs-params">(ScheduledExecutorService scheduledExecutorService)</span> &#123;<br>        <span class="hljs-built_in">this</span>.scheduledExecutorService = scheduledExecutorService;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">submitJob</span><span class="hljs-params">(YangJobSubmitParam yangJobSubmitParam)</span> &#123;<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">jobId</span> <span class="hljs-operator">=</span> yangJobSubmitParam.getJobId();<br>        <span class="hljs-keyword">if</span> (jobId == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;缺少任务标识=========&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">ScheduledFuture</span> <span class="hljs-variable">scheduledFuture</span> <span class="hljs-operator">=</span> jobId2ScheduleFutureMap.get(jobId.toString());<br>        <span class="hljs-keyword">if</span> (scheduledFuture != <span class="hljs-literal">null</span> &amp;&amp; !scheduledFuture.isCancelled()) &#123;<br>            <span class="hljs-comment">// jobId存在对应的任务</span><br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <br>        <span class="hljs-type">JobExecuteStrategyEnum</span> <span class="hljs-variable">jobExecuteStrategy</span> <span class="hljs-operator">=</span> yangJobSubmitParam.getJobExecuteStrategy();<br>        <span class="hljs-keyword">if</span> (jobExecuteStrategy == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;缺少执行策略=========&quot;</span>);<br>        &#125;<br>        <br>        <span class="hljs-keyword">if</span> (jobExecuteStrategy == JobExecuteStrategyEnum.IMMEDIATE_EXECUTE) &#123;<br>            yangJobSubmitParam.getRunnable().run();<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        scheduledFuture = scheduleJob(yangJobSubmitParam);<br>        jobId2ScheduleFutureMap.put(jobId.toString(), scheduledFuture);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancelJob</span><span class="hljs-params">(Integer jobId)</span> &#123;<br>        <span class="hljs-keyword">if</span> (jobId == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-type">ScheduledFuture</span> <span class="hljs-variable">scheduledFuture</span> <span class="hljs-operator">=</span> jobId2ScheduleFutureMap.get(jobId.toString());<br>        <span class="hljs-keyword">if</span> (scheduledFuture == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!scheduledFuture.isCancelled()) &#123;<br>            scheduledFuture.cancel(<span class="hljs-literal">true</span>);<br>        &#125;<br>        jobId2ScheduleFutureMap.remove(jobId.toString());<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> ScheduledFuture <span class="hljs-title function_">scheduleJob</span><span class="hljs-params">(YangJobSubmitParam yangJobSubmitParam)</span> &#123;<br>        <span class="hljs-type">Runnable</span> <span class="hljs-variable">runnable</span> <span class="hljs-operator">=</span> yangJobSubmitParam.getRunnable();<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">initialDelay</span> <span class="hljs-operator">=</span> yangJobSubmitParam.getInitialDelay();<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">period</span> <span class="hljs-operator">=</span> yangJobSubmitParam.getPeriod();<br>        <span class="hljs-type">JobExecuteStrategyEnum</span> <span class="hljs-variable">jobExecuteStrategy</span> <span class="hljs-operator">=</span> yangJobSubmitParam.getJobExecuteStrategy();<br>        <span class="hljs-keyword">switch</span> (jobExecuteStrategy) &#123;<br>            <span class="hljs-keyword">case</span> ONCE:<br>                <span class="hljs-keyword">return</span> scheduledExecutorService.schedule(runnable, initialDelay, TimeUnit.SECONDS);<br>            <span class="hljs-keyword">case</span> WITH_FIXED_DELAY:<br>                <span class="hljs-keyword">return</span> scheduledExecutorService.scheduleWithFixedDelay(runnable, initialDelay, period, TimeUnit.SECONDS);<br>            <span class="hljs-keyword">case</span> WITH_FIXED_RATE:<br>                <span class="hljs-keyword">return</span> scheduledExecutorService.scheduleAtFixedRate(runnable, initialDelay, period, TimeUnit.SECONDS);<br>        &#125;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;执行策略有误===========&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.scheduledExecutorService == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.scheduledExecutorService.isShutdown()) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        scheduledExecutorService.shutdown();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (!scheduledExecutorService.awaitTermination(<span class="hljs-number">10</span>, TimeUnit.SECONDS)) &#123;<br>                scheduledExecutorService.shutdownNow();<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>最后，我们添加对应的测试方法：</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs livescript">public <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> main(<span class="hljs-built_in">String</span>[] args) &#123;<br>       ThreadFactory threadFactory = <span class="hljs-keyword">new</span> YangJobThreadFactory(<span class="hljs-string">&quot;yang&quot;</span>);<br>       ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(<span class="hljs-number">4</span>, threadFactory);<br><br>       YangJobManager yangJobManager = <span class="hljs-keyword">new</span> YangJobManager(scheduledExecutorService);<br>       YangJobSubmitParam yangJobSubmitParam = <span class="hljs-keyword">new</span> YangJobSubmitParam();<br>       yangJobSubmitParam.setJobId(<span class="hljs-number">1</span>);<br>       yangJobSubmitParam.setRunnable<span class="hljs-function"><span class="hljs-params">(() -&gt; System.out.println(<span class="hljs-string">&quot;执行任务=====&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()))</span>;</span><br><span class="hljs-function">       <span class="hljs-title">yangJobSubmitParam</span>.<span class="hljs-title">setInitialDelay</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span>;</span><br><span class="hljs-function">       <span class="hljs-title">yangJobSubmitParam</span>.<span class="hljs-title">setPeriod</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span>;</span><br><span class="hljs-function">       <span class="hljs-title">yangJobSubmitParam</span>.<span class="hljs-title">setJobExecuteStrategy</span><span class="hljs-params">(JobExecuteStrategyEnum.WITH_FIXED_RATE)</span>;</span><br><span class="hljs-function">       <span class="hljs-title">yangJobManager</span>.<span class="hljs-title">submitJob</span><span class="hljs-params">(yangJobSubmitParam)</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">       <span class="hljs-title">try</span> &#123;</span><br><span class="hljs-function">           <span class="hljs-title">Thread</span>.<span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">10000</span>)</span>;</span><br><span class="hljs-function">       &#125; <span class="hljs-title">catch</span> <span class="hljs-params">(InterruptedException e)</span> &#123;</span><br><span class="hljs-function">           <span class="hljs-title">e</span>.<span class="hljs-title">printStackTrace</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">       &#125;</span><br><span class="hljs-function">       <span class="hljs-title">System</span>.<span class="hljs-title">out</span>.<span class="hljs-title">println</span><span class="hljs-params">(<span class="hljs-string">&quot;取消任务==========&quot;</span>)</span>;</span><br><span class="hljs-function">       <span class="hljs-title">yangJobManager</span>.<span class="hljs-title">cancelJob</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span>;</span><br><span class="hljs-function">       <span class="hljs-title">try</span> &#123;</span><br><span class="hljs-function">           <span class="hljs-title">Thread</span>.<span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">10000</span>)</span>;</span><br><span class="hljs-function">       &#125; <span class="hljs-title">catch</span> <span class="hljs-params">(InterruptedException e)</span> &#123;</span><br><span class="hljs-function">           <span class="hljs-title">e</span>.<span class="hljs-title">printStackTrace</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">       &#125;</span><br><span class="hljs-function">       <span class="hljs-title">yangJobManager</span>.<span class="hljs-title">shutdown</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">   &#125;</span><br></code></pre></td></tr></table></figure><p>在该方法中，我们提交任务，该任务间隔时间为2秒，10秒过后，取消任务，取消任务过后，再睡眠10秒，在后面10秒钟，不会执行任务（或执行一次，因为在cancel之前刚好有任务没执行完），执行结果如下：</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86/3.png" class=""><h3 id="YangJobManager建造者"><a href="#YangJobManager建造者" class="headerlink" title="YangJobManager建造者"></a>YangJobManager建造者</h3><p>对于YangJobManager，目前我们所拥有的属性、方法都比较简单，但是如果后续这个类进一步扩展，构造该类可能会变得很麻烦，因此，我们添加一个YangJobBuilder建造者类，用于构造YangJobManager，此外，我们将YangJobManager的构造方法设置为private，从而将构造YangJobManager的职责，彻底收敛到YangJobManagerBuilder类中，我们修改YangJobManager类如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">package</span> com.yang.job;<br><br><span class="hljs-keyword">import</span> com.yang.job.enums.JobExecuteStrategyEnum;<br><span class="hljs-keyword">import</span> com.yang.job.factory.YangJobThreadFactory;<br><span class="hljs-keyword">import</span> com.yang.job.request.YangJobSubmitParam;<br><br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.concurrent.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YangJobManager</span> &#123;<br>    <span class="hljs-keyword">private</span> ScheduledExecutorService scheduledExecutorService;<br><br>    <span class="hljs-keyword">private</span> Map&lt;String, ScheduledFuture&gt; jobId2ScheduleFutureMap = new ConcurrentHashMap&lt;&gt;();<br><br>    <span class="hljs-keyword">private</span> YangJobManager(ScheduledExecutorService scheduledExecutorService) &#123;<br>        <span class="hljs-keyword">this</span>.scheduledExecutorService = scheduledExecutorService;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> void submitJob(YangJobSubmitParam yangJobSubmitParam) &#123;<br>        Integer jobId = yangJobSubmitParam.getJobId();<br>        <span class="hljs-keyword">if</span> (jobId == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> new RuntimeException(<span class="hljs-string">&quot;缺少任务标识=========&quot;</span>);<br>        &#125;<br>        ScheduledFuture scheduledFuture = jobId2ScheduleFutureMap.<span class="hljs-keyword">get</span>(jobId.toString());<br>        <span class="hljs-keyword">if</span> (scheduledFuture != <span class="hljs-literal">null</span> &amp;&amp; !scheduledFuture.isCancelled()) &#123;<br>            <span class="hljs-comment">// jobId存在对应的任务</span><br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        JobExecuteStrategyEnum jobExecuteStrategy = yangJobSubmitParam.getJobExecuteStrategy();<br>        <span class="hljs-keyword">if</span> (jobExecuteStrategy == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> new RuntimeException(<span class="hljs-string">&quot;缺少执行策略=========&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (jobExecuteStrategy == JobExecuteStrategyEnum.IMMEDIATE_EXECUTE) &#123;<br>            yangJobSubmitParam.getRunnable().run();<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        scheduledFuture = scheduleJob(yangJobSubmitParam);<br>        jobId2ScheduleFutureMap.put(jobId.toString(), scheduledFuture);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> void cancelJob(Integer jobId) &#123;<br>        <span class="hljs-keyword">if</span> (jobId == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        ScheduledFuture scheduledFuture = jobId2ScheduleFutureMap.<span class="hljs-keyword">get</span>(jobId.toString());<br>        <span class="hljs-keyword">if</span> (scheduledFuture == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!scheduledFuture.isCancelled()) &#123;<br>            scheduledFuture.cancel(<span class="hljs-literal">true</span>);<br>        &#125;<br>        jobId2ScheduleFutureMap.remove(jobId.toString());<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> ScheduledFuture scheduleJob(YangJobSubmitParam yangJobSubmitParam) &#123;<br>        Runnable runnable = yangJobSubmitParam.getRunnable();<br>        Integer initialDelay = yangJobSubmitParam.getInitialDelay();<br>        Integer period = yangJobSubmitParam.getPeriod();<br>        JobExecuteStrategyEnum jobExecuteStrategy = yangJobSubmitParam.getJobExecuteStrategy();<br>        switch (jobExecuteStrategy) &#123;<br>            case ONCE:<br>                <span class="hljs-keyword">return</span> scheduledExecutorService.schedule(runnable, initialDelay, TimeUnit.SECONDS);<br>            case WITH_FIXED_DELAY:<br>                <span class="hljs-keyword">return</span> scheduledExecutorService.scheduleWithFixedDelay(runnable, initialDelay, period, TimeUnit.SECONDS);<br>            case WITH_FIXED_RATE:<br>                <span class="hljs-keyword">return</span> scheduledExecutorService.scheduleAtFixedRate(runnable, initialDelay, period, TimeUnit.SECONDS);<br>        &#125;<br>        <span class="hljs-keyword">throw</span> new RuntimeException(<span class="hljs-string">&quot;执行策略有误===========&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> void shutdown() &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.scheduledExecutorService == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.scheduledExecutorService.isShutdown()) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        scheduledExecutorService.shutdown();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (!scheduledExecutorService.awaitTermination(<span class="hljs-number">10</span>, TimeUnit.SECONDS)) &#123;<br>                scheduledExecutorService.shutdownNow();<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> static <span class="hljs-keyword">class</span> <span class="hljs-title class_">YangJobManagerBuilder</span> &#123;<br>        <span class="hljs-keyword">private</span> ThreadFactory threadFactory;<br><br>        <span class="hljs-keyword">private</span> ScheduledExecutorService scheduledExecutorService;<br><br>        <span class="hljs-keyword">public</span> YangJobManagerBuilder() &#123;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> YangJobManagerBuilder setThreadFactory(ThreadFactory threadFactory) &#123;<br>            <span class="hljs-keyword">this</span>.threadFactory = threadFactory;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<br>        &#125;<br>        <br>        <span class="hljs-keyword">public</span> YangJobManagerBuilder setScheduledExecutorService(ScheduledExecutorService scheduledExecutorService) &#123;<br>            <span class="hljs-keyword">this</span>.scheduledExecutorService = scheduledExecutorService;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<br>        &#125;<br>        <br>        <span class="hljs-keyword">public</span> YangJobManager build() &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.threadFactory == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">this</span>.threadFactory = new YangJobThreadFactory(<span class="hljs-string">&quot;yang&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.scheduledExecutorService == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">this</span>.scheduledExecutorService = Executors.newScheduledThreadPool(Runtime.getRuntime().availableProcessors(),<br>                        <span class="hljs-keyword">this</span>.threadFactory);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.scheduledExecutorService instanceof ScheduledThreadPoolExecutor) &#123;<br>                    ScheduledThreadPoolExecutor scheduledThreadPoolExecutor = (ScheduledThreadPoolExecutor) <span class="hljs-keyword">this</span>.scheduledExecutorService;<br>                    scheduledThreadPoolExecutor.setThreadFactory(<span class="hljs-keyword">this</span>.threadFactory);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">return</span> new YangJobManager(<span class="hljs-keyword">this</span>.scheduledExecutorService);<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="任务执行类"><a href="#任务执行类" class="headerlink" title="任务执行类"></a>任务执行类</h3><p>在之前的代码中，我们的Runnable都是匿名函数类，但是在我们的定时任务调度平台中，一般情况下，这个任务是会持久化到数据库中的，我们一般不会说把这个Runnable的代码也存到数据库吧，一般存储的，应该就是某个任务执行类的类路径，和方法名，以及入参，然后在启动项目时，从数据库中加载这些数据，并通过反射或代理等方式，来构造这个Runnable。<br>首先，我们定义一个任务执行类，来规范任务的执行方法和入参格式：</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-comment">// 任务执行类</span><br><span class="hljs-keyword">package</span> com.yang.job.execute;<br><br><span class="hljs-keyword">public</span> <span class="hljs-title class_"><span class="hljs-keyword">interface</span> <span class="hljs-title">IYangJobExecutor</span> </span>&#123;<br>    void execute(YangJobExecuteRequest yangJobExecuteRequest);<br>&#125;<br><br><span class="hljs-comment">// 任务执行方法入参</span><br><span class="hljs-keyword">package</span> com.yang.job.execute;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-title class_"><span class="hljs-keyword">class</span> <span class="hljs-title">YangJobExecuteRequest</span> <span class="hljs-keyword"><span class="hljs-keyword">implements</span> <span class="hljs-type">Serializable</span></span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> jobId;<br><br>    <span class="hljs-keyword">private</span> Map&lt;<span class="hljs-keyword">String</span>, <span class="hljs-keyword">String</span>&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-type">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> void addParam(<span class="hljs-keyword">String</span> key, <span class="hljs-keyword">String</span> value) &#123;<br>        params.put(key, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">String</span> getParam(<span class="hljs-keyword">String</span> key) &#123;<br>        <span class="hljs-keyword">return</span> params.<span class="hljs-keyword">get</span>(key);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>接着，我们创建这个YangJobExecutor的实现类，用于测试，在该类中，执行任务的方法很简单，打印当前类的名字以及入参。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">package com.yang.task;<br><br><span class="hljs-keyword">import</span> com.yang.job.<span class="hljs-keyword">execute</span>.IYangJobExecutor;<br><span class="hljs-keyword">import</span> com.yang.job.<span class="hljs-keyword">execute</span>.YangJobExecuteRequest;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-built_in">public</span> <span class="hljs-keyword">class</span> TestJobExecutor implements IYangJobExecutor &#123;<br>    @Override<br>    <span class="hljs-built_in">public</span> <span class="hljs-type">void</span> <span class="hljs-keyword">execute</span>(YangJobExecuteRequest yangJobExecuteRequest) &#123;<br>        <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(String.format(&quot;%s 任务执行类执行了，入参为：%s, 当前时间:%s&quot;,<br>                this.getClass().getName(), yangJobExecuteRequest.toString(),<br>                <span class="hljs-built_in">new</span> <span class="hljs-type">Date</span>().toString()));<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后我们创建一个YangJobData，假设我们从数据库中获取的数据格式如下：</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">package</span> com.yang.job.data;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-title class_"><span class="hljs-keyword">class</span> <span class="hljs-title">YangJobData</span> <span class="hljs-keyword"><span class="hljs-keyword">implements</span> <span class="hljs-type">Serializable</span></span> </span>&#123;<br>    <span class="hljs-keyword">private</span> Integer jobId;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> cron;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> executeStrategy;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> executeClassPath;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> executeParams;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>executeStrategy表示任务的执行策略，executeClassPath表示要执行的任务类的路径，executeParams表示执行任务方法的入参。<br>在XXL-JOB中，我们可以使用cron来设置定时任务的执行时间，因此我们这里，也使用cron作为定时任务的执行时间设置，为了解析cron表达式，我们添加下列依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.cronutils<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cron-utils<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>然后创建一个CronUtils工具类，用于解析cron表达式。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.demo.infra.utils;<br><br><span class="hljs-keyword">import</span> com.cronutils.model.CronType;<br><span class="hljs-keyword">import</span> com.cronutils.model.definition.CronDefinition;<br><span class="hljs-keyword">import</span> com.cronutils.model.definition.CronDefinitionBuilder;<br><span class="hljs-keyword">import</span> com.cronutils.model.time.ExecutionTime;<br><span class="hljs-keyword">import</span> com.cronutils.parser.CronParser;<br><br><span class="hljs-keyword">import</span> java.time.ZonedDateTime;<br><span class="hljs-keyword">import</span> java.util.Optional;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CronUtils</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">CronDefinition</span> <span class="hljs-variable">CRON_DEFINITION</span> <span class="hljs-operator">=</span> CronDefinitionBuilder.instanceDefinitionFor(CronType.QUARTZ);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">CronParser</span> <span class="hljs-variable">CRON_PARSER</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CronParser</span>(CRON_DEFINITION);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ZonedDateTime <span class="hljs-title function_">nextExecutionTime</span><span class="hljs-params">(String cron, ZonedDateTime startTime)</span> &#123;<br>        <span class="hljs-type">ExecutionTime</span> <span class="hljs-variable">executionTime</span> <span class="hljs-operator">=</span> ExecutionTime.forCron(CRON_PARSER.parse(cron));<br>        Optional&lt;ZonedDateTime&gt; zonedDateTime = executionTime.nextExecution(startTime);<br>        <span class="hljs-keyword">return</span> zonedDateTime.get();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>对于执行方法的入参，一般情况下，就是任务的id，以及一些扩展信息，这些扩展信息一般以键值对的形式存储，即”key:value;key:value;”这些形式，所以这里添加一个FeaturesUtils类，用于解析这些键值对信息：</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">package</span> com.<span class="hljs-property">yang</span>.<span class="hljs-property">job</span>.<span class="hljs-property">utils</span>;<br><br><br><span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">HashMap</span>;<br><span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">Map</span>;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeaturesUtils</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">String</span> KEY_KEY_SEPARATOR = <span class="hljs-string">&quot;;&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">String</span> KEY_VALUE_SEPARATOR = <span class="hljs-string">&quot;:&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt; <span class="hljs-title function_">convert2FeatureMap</span>(<span class="hljs-built_in">String</span> features) &#123;<br>        Map&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt; featureMap = <span class="hljs-keyword">new </span><span class="hljs-class title_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-keyword">if</span> (features == <span class="hljs-literal">null</span> || features.<span class="hljs-property">isEmpty</span>()) &#123;<br>            <span class="hljs-keyword">return</span> featureMap;<br>        &#125;<br>        <span class="hljs-built_in">String</span>[] keyValues = features.<span class="hljs-property">split</span>(KEY_KEY_SEPARATOR);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">String</span> keyValue : keyValues) &#123;<br>            <span class="hljs-built_in">String</span>[] <span class="hljs-built_in">split</span> = keyValue.<span class="hljs-property">split</span>(KEY_VALUE_SEPARATOR);<br>            <span class="hljs-built_in">String</span> <span class="hljs-built_in">key</span> = <span class="hljs-built_in">split</span>[<span class="hljs-number">0</span>];<br>            <span class="hljs-built_in">String</span> value = <span class="hljs-built_in">split</span>[<span class="hljs-number">1</span>];<br>            featureMap.<span class="hljs-property">put</span>(<span class="hljs-built_in">key</span>, value);<br>        &#125;<br>        <span class="hljs-keyword">return</span> featureMap;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">String</span> <span class="hljs-title function_">convert2Features</span>(Map&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt; featureMap) &#123;<br>        <span class="hljs-keyword">if</span> (featureMap == <span class="hljs-literal">null</span> || featureMap.<span class="hljs-property">isEmpty</span>()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br>        StringBuilder stringBuilder = <span class="hljs-keyword">new </span><span class="hljs-class title_">StringBuilder</span>();<br>        featureMap.<span class="hljs-property">forEach</span>((<span class="hljs-built_in">key</span>, value) -&gt; &#123;<br>            stringBuilder.<span class="hljs-property">append</span>(<span class="hljs-built_in">key</span>)<br>                    .<span class="hljs-property">append</span>(KEY_VALUE_SEPARATOR)<br>                    .<span class="hljs-property">append</span>(value)<br>                    .<span class="hljs-property">append</span>(KEY_KEY_SEPARATOR);<br>        &#125;);<br>        <span class="hljs-keyword">return</span> stringBuilder.<span class="hljs-property">toString</span>();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后我们添加测试方法，模拟从数据库中获取数据，并根据任务类路径，获取对应的runnable并提交到YangJobManager中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>      <span class="hljs-type">YangJobData</span> <span class="hljs-variable">yangJobData</span> <span class="hljs-operator">=</span> mockYangJobData();<br>      <span class="hljs-type">YangJobSubmitParam</span> <span class="hljs-variable">yangJobSubmitParam</span> <span class="hljs-operator">=</span> convert2YangJobSubmitParam(yangJobData);<br><br>      <span class="hljs-type">YangJobManager</span> <span class="hljs-variable">yangJobManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">YangJobManager</span>.YangJobManagerBuilder()<br>              .setThreadFactory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">YangJobThreadFactory</span>(<span class="hljs-string">&quot;yang&quot;</span>))<br>              .build();<br>      yangJobManager.submitJob(yangJobSubmitParam);<br><br>      <span class="hljs-keyword">try</span> &#123;<br>          Thread.sleep(<span class="hljs-number">20000</span>);<br>      &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>      &#125;<br>      yangJobManager.shutdown();<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> YangJobSubmitParam <span class="hljs-title function_">convert2YangJobSubmitParam</span><span class="hljs-params">(YangJobData yangJobData)</span> &#123;<br>      <span class="hljs-type">YangJobSubmitParam</span> <span class="hljs-variable">yangJobSubmitParam</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">YangJobSubmitParam</span>();<br>      yangJobSubmitParam.setJobId(yangJobData.getJobId());<br>      yangJobSubmitParam.setJobExecuteStrategy(JobExecuteStrategyEnum.getJobExecuteStrategyByName(yangJobData.getExecuteStrategy()));<br>      <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">nextExecutionTime</span> <span class="hljs-operator">=</span> CronUtils.nextExecutionTime(yangJobData.getCron(), ZonedDateTime.now());<br>      <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">nextNextExecutionTime</span> <span class="hljs-operator">=</span> CronUtils.nextExecutionTime(yangJobData.getCron(), nextExecutionTime);<br>      <span class="hljs-type">long</span> <span class="hljs-variable">nowEochMill</span> <span class="hljs-operator">=</span> ZonedDateTime.now().toInstant().toEpochMilli();<br>      <span class="hljs-type">long</span> <span class="hljs-variable">executeEochMill</span> <span class="hljs-operator">=</span> nextExecutionTime.toInstant().toEpochMilli();<br>      <span class="hljs-type">long</span> <span class="hljs-variable">secondExecuteEochMill</span> <span class="hljs-operator">=</span> nextNextExecutionTime.toInstant().toEpochMilli();<br>      yangJobSubmitParam.setInitialDelay((<span class="hljs-type">int</span>)(executeEochMill - nowEochMill) / <span class="hljs-number">1000</span>);<br>      yangJobSubmitParam.setPeriod((<span class="hljs-type">int</span>)(secondExecuteEochMill - executeEochMill) / <span class="hljs-number">1000</span>);<br><br>      <span class="hljs-keyword">try</span> &#123;<br>          Class&lt;?&gt; aClass = Class.forName(yangJobData.getExecuteClassPath());<br>          <span class="hljs-keyword">if</span> (!IYangJobExecutor.class.isAssignableFrom(aClass)) &#123;<br>              <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;任务类必须实现IYangJobExecutor接口&quot;</span>);<br>          &#125;<br>          <span class="hljs-type">IYangJobExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> (IYangJobExecutor) aClass.newInstance();<br>          <span class="hljs-type">YangJobExecuteRequest</span> <span class="hljs-variable">yangJobExecuteRequest</span> <span class="hljs-operator">=</span> convert2YangJobExecuteRequest(yangJobData);<br>          <span class="hljs-type">Runnable</span> <span class="hljs-variable">runnable</span> <span class="hljs-operator">=</span> () -&gt; executor.execute(yangJobExecuteRequest);<br>          yangJobSubmitParam.setRunnable(runnable);<br>      &#125; <span class="hljs-keyword">catch</span> (InstantiationException | IllegalAccessException e) &#123;<br>          e.printStackTrace();<br>      &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>          e.printStackTrace();<br>      &#125;<br>      <span class="hljs-keyword">return</span> yangJobSubmitParam;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> YangJobExecuteRequest <span class="hljs-title function_">convert2YangJobExecuteRequest</span><span class="hljs-params">(YangJobData yangJobData)</span> &#123;<br>      <span class="hljs-type">YangJobExecuteRequest</span> <span class="hljs-variable">yangJobExecuteRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">YangJobExecuteRequest</span>();<br>      yangJobExecuteRequest.setJobId(yangJobData.getJobId().toString());<br>      yangJobExecuteRequest.setParams(FeaturesUtils.convert2FeatureMap(yangJobData.getExecuteParams()));<br>      <span class="hljs-keyword">return</span> yangJobExecuteRequest;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> YangJobData <span class="hljs-title function_">mockYangJobData</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-type">YangJobData</span> <span class="hljs-variable">yangJobData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">YangJobData</span>();<br>      yangJobData.setJobId(<span class="hljs-number">1</span>);<br>      yangJobData.setCron(<span class="hljs-string">&quot;0/5 * * * * ?&quot;</span>);<br>      yangJobData.setExecuteStrategy(JobExecuteStrategyEnum.WITH_FIXED_DELAY.getName());<br>      yangJobData.setExecuteClassPath(<span class="hljs-string">&quot;com.yang.task.TestJobExecutor&quot;</span>);<br>      yangJobData.setExecuteParams(<span class="hljs-string">&quot;jobId:1;startIndex:1;endIndex:10;&quot;</span>);<br>      <span class="hljs-keyword">return</span> yangJobData;<br>  &#125;<br></code></pre></td></tr></table></figure><p>这里对于cron的解析，其实不是特别好，这里的思路是，获取下一次执行的时间，和下下一次执行的时间，然后以此来计算initialDelay和period，但是如果这个cron表示的是某几天、某几个小时，比如说星期一、星期二、星期三执行，那么我们那种解析方式是有误的，这个可以后续再好好斟酌一下，目前先这样解析。<br>执行结果如下：</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86/4.png" class="">]]></content>
    
    
    
    <tags>
      
      <tag>XXL-JOB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>手撸XXL-JOB（一）—定时任务的执行</title>
    <link href="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%89%A7%E8%A1%8C/"/>
    <url>/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%89%A7%E8%A1%8C/</url>
    
    <content type="html"><![CDATA[<h3 id="SpringBoot执行定时任务"><a href="#SpringBoot执行定时任务" class="headerlink" title="SpringBoot执行定时任务"></a>SpringBoot执行定时任务</h3><p>对于定时任务的执行，SpringBoot提供了三种创建方式：<br>1）基于注解(@Scheduled)<br>2）基于接口（SchedulingConfigurer）<br>3）基于注解设定多线程定时任务</p><h4 id="基于Scheduled注解"><a href="#基于Scheduled注解" class="headerlink" title="基于Scheduled注解"></a>基于Scheduled注解</h4><p>首先我们创建一个SpringBoot项目，然后引入spring-boot-starter-web依赖，在启动类上添加EnableScheduling注解开启定时任务管理。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs typescript">package com.<span class="hljs-property">yang</span>.<span class="hljs-property">demo1</span>;<br><br><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">SpringApplication</span>;<br><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">autoconfigure</span>.<span class="hljs-property">SpringBootApplication</span>;<br><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">scheduling</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">EnableScheduling</span>;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableScheduling</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScheduledDemoApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) &#123;<br>        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">ScheduledDemoApplication</span>.<span class="hljs-property">class</span>, args);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后我们创建一个定时任务，并使用Scheduled注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.demo1;<br><br><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.Scheduled;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.text.SimpleDateFormat;<br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoTask</span> &#123;<br>    <span class="hljs-meta">@Scheduled(cron = &quot;0/5 * * * * ?&quot;)</span> <span class="hljs-comment">// 每5秒执行一次</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">df</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;hello world: &quot;</span> + df.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>启动项目，执行结果如下所示，每隔5秒，便会执行一次定时任务。</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%89%A7%E8%A1%8C/1.png" class=""><p>Scheduled注解类的源码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.scheduling.annotation;<br> <br><span class="hljs-keyword">import</span> java.lang.annotation.Documented;<br><span class="hljs-keyword">import</span> java.lang.annotation.ElementType;<br><span class="hljs-keyword">import</span> java.lang.annotation.Repeatable;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.annotation.RetentionPolicy;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br> <br><span class="hljs-meta">@Target(&#123;ElementType.METHOD, ElementType.ANNOTATION_TYPE&#125;)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Repeatable(Schedules.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Scheduled &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">CRON_DISABLED</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;-&quot;</span>;<br> <br>    String <span class="hljs-title function_">cron</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;&quot;</span>;<br> <br>    String <span class="hljs-title function_">zone</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;&quot;</span>;<br> <br>    <span class="hljs-type">long</span> <span class="hljs-title function_">fixedDelay</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> -<span class="hljs-number">1L</span>;<br> <br>    String <span class="hljs-title function_">fixedDelayString</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;&quot;</span>;<br> <br>    <span class="hljs-type">long</span> <span class="hljs-title function_">fixedRate</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> -<span class="hljs-number">1L</span>;<br> <br>    String <span class="hljs-title function_">fixedRateString</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;&quot;</span>;<br> <br>    <span class="hljs-type">long</span> <span class="hljs-title function_">initialDelay</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> -<span class="hljs-number">1L</span>;<br> <br>    String <span class="hljs-title function_">initialDelayString</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>除了刚才代码中使用到的cron参数，我们还可以使用fixedDelay和fixedRate等参数。fixedDelay和fixedRate很相似，但又略有不同，其中fixedDelay表示在某次任务执行完毕后，间隔fixedDelay的时间再执行，而fixedRate表示在某次任务执行开始后，间隔fixedRate的时间再执行。<br>我们对这两个参数，添加对应的测试方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Scheduled(fixedDelay = 5000)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeFixedDelay</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">df</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);<br>      System.out.println(<span class="hljs-string">&quot;executeFixedDelay开始执行了==========&quot;</span> + df.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));<br>      <span class="hljs-keyword">try</span> &#123;<br>          Thread.sleep(<span class="hljs-number">2000</span>);<br>      &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>          e.printStackTrace();<br>      &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Scheduled(fixedRate = 5000)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeFixedRate</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">df</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);<br>      System.out.println(<span class="hljs-string">&quot;executeFixedRate开始执行了==========&quot;</span> + df.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));<br>      <span class="hljs-keyword">try</span> &#123;<br>          Thread.sleep(<span class="hljs-number">2000</span>);<br>      &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>          e.printStackTrace();<br>      &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><p>启动项目，执行结果如下。我们可以看到，executeFixedDelay在任务执行完毕后，间隔5秒才执行下一个任务，也就是说，两个任务之间间隔7秒，而executeFixedRate在任务执行开始后，间隔5秒执行下一个任务，也就是两个任务之间间隔5秒。综上所示，fixedDelay和fixedRate之间的区别，其实就在于计算两个任务执行间隔时，需不需要考虑任务的执行时长。</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%89%A7%E8%A1%8C/2.png" class=""><h4 id="基于SchedulingConfigurer接口"><a href="#基于SchedulingConfigurer接口" class="headerlink" title="基于SchedulingConfigurer接口"></a>基于SchedulingConfigurer接口</h4><p>首先我们在数据库中创建t_cron表，并添加数据：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> t_cron;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_cron  (<br>  cron_id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">PRIMARY</span> KEY,<br>  cron <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>  <br>);<br> <br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_cron <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;0/5 * * * * ?&#x27;</span>);<br></code></pre></td></tr></table></figure><p>然后修改pom.xml，加上数据库的相关依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>修改配置文件：</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">spring</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">datasource</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">username</span><span class="hljs-punctuation">:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attribute">password</span><span class="hljs-punctuation">:</span> <span class="hljs-string">3fa4d180</span><br>    <span class="hljs-attribute">url</span><span class="hljs-punctuation">:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/test01?useSSL=false&amp;serverTimezone=UTC</span><br>    <span class="hljs-attribute">driver-class-name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br><span class="hljs-attribute">mybatis-plus</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">configuration</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">log-impl</span><span class="hljs-punctuation">:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span><br></code></pre></td></tr></table></figure><p>创建对应的mapper：</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">package</span> com.yang.demo1.mapper;<br><br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Select;<br><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-title class_"><span class="hljs-keyword">interface</span> <span class="hljs-title">CronMapper</span> </span>&#123;<br>    <span class="hljs-meta">@Select</span>(<span class="hljs-string">&quot;select cron from t_cron limit 1&quot;</span>)<br>    <span class="hljs-keyword">String</span> getCron();<br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后，我们编写定时任务，通过读取我们在数据库设置好的执行周期，来执行定时任务，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.demo1;<br><br><span class="hljs-keyword">import</span> com.yang.demo1.mapper.CronMapper;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.EnableScheduling;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.SchedulingConfigurer;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.config.ScheduledTaskRegistrar;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.support.CronTrigger;<br><br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableScheduling</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicScheduleConfigurer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SchedulingConfigurer</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CronMapper cronMapper;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureTasks</span><span class="hljs-params">(ScheduledTaskRegistrar taskRegistrar)</span> &#123;<br>        taskRegistrar.addTriggerTask(<br>                () -&gt; execute(),<br>                triggerContext -&gt; &#123;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">cron</span> <span class="hljs-operator">=</span> cronMapper.getCron();<br>                    <span class="hljs-keyword">if</span> (StringUtils.isEmpty(cron)) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;cron 格式有误&quot;</span>);<br>                    &#125;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CronTrigger</span>(cron).nextExecutionTime(triggerContext);<br>                &#125;<br>        );<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;hello world:&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>执行结果如下所示，一开始的cron是每5秒执行一次，后来我们修改cron，改为10秒执行一次，此时任务的执行频率，也随之我们数据库的修改动态地进行了调整。</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%89%A7%E8%A1%8C/3.png" class=""><h4 id="EnableAsync注解"><a href="#EnableAsync注解" class="headerlink" title="EnableAsync注解"></a>EnableAsync注解</h4><p>对于Scheduled，默认为单线程，当开启多个任务时，任务地执行实际会受到上一个任务执行时间地影响，所以需要使用Async注解，通过该注解开启多线程使任务之间不会相互影响。</p><h3 id="ScheduledExecutorService执行定时任务"><a href="#ScheduledExecutorService执行定时任务" class="headerlink" title="ScheduledExecutorService执行定时任务"></a>ScheduledExecutorService执行定时任务</h3><p>SpringBoot执行定时任务很简单，但是如果我们不使用SpringBoot，又该如何启动定时任务？这个时候，我们就可以使用ScheduledExecutorService接口，这个接口用于在一些预定义的延迟之后运行任务或定期运行任务。我们可以通过Executors类的工厂方法实例化ScheduledExecutorService，如下：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">ScheduledExecutorService scheduledExecutorService <span class="hljs-operator">=</span> Executors.newSingleThreadScheduledExecutor()<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>在ScheduledExecutorService接口中，有三个主要方法：<br>1）schedule：允许在指定的延迟后执行一次任务。<br>2）scheduleAtFixedRate：允许在指定的初始延迟后执行任务，然后以一定的周期重复执行，其中period参数用于指定两个任务的开始时间之间的间隔时间，因此任务执行的频率是固定的。<br>3）scheduleWithFixedDelay：类似于scheduleAtFixedRate，它也重复执行给定的任务，单period参数用于指定前一个任务的结束和下一个任务的开始之间的间隔时间，也就是指定下一个任务延时多久后才执行，执行频率可能会有所不同，具体取决于执行任务给定任务所需的时间。</p><h4 id="schedule方法"><a href="#schedule方法" class="headerlink" title="schedule方法"></a>schedule方法</h4><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs livescript">package com.yang.demo2;<br><br><span class="hljs-keyword">import</span> java.util.<span class="hljs-built_in">Date</span>;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><span class="hljs-keyword">import</span> java.util.concurrent.ScheduledExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScheduledExecutorServiceMain</span> &#123;<br>    public <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> main(<span class="hljs-built_in">String</span>[] args) &#123;<br>        ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(<span class="hljs-number">1</span>);<br>        scheduledExecutorService.schedule<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">            System.out.println(<span class="hljs-string">&quot;Hello World:&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>());</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125;, <span class="hljs-number">1</span>, TimeUnit.SECONDS)</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">        <span class="hljs-title">try</span> &#123;</span><br><span class="hljs-function">            <span class="hljs-title">Thread</span>.<span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">20000</span>)</span>;</span><br><span class="hljs-function">        &#125; <span class="hljs-title">catch</span> <span class="hljs-params">(InterruptedException e)</span> &#123;</span><br><span class="hljs-function">            <span class="hljs-title">throw</span> <span class="hljs-title">new</span> <span class="hljs-title">RuntimeException</span><span class="hljs-params">(e)</span>;</span><br><span class="hljs-function">        &#125;</span><br><span class="hljs-function">        <span class="hljs-title">scheduledExecutorService</span>.<span class="hljs-title">shutdown</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        <span class="hljs-title">try</span> &#123;</span><br><span class="hljs-function">            <span class="hljs-title">if</span> <span class="hljs-params">(!scheduledExecutorService.awaitTermination(<span class="hljs-number">10</span>, TimeUnit.SECONDS))</span> &#123;</span><br><span class="hljs-function">                <span class="hljs-title">scheduledExecutorService</span>.<span class="hljs-title">shutdownNow</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">            &#125;</span><br><span class="hljs-function">        &#125; <span class="hljs-title">catch</span> <span class="hljs-params">(InterruptedException e)</span> &#123;</span><br><span class="hljs-function">            <span class="hljs-title">e</span>.<span class="hljs-title">printStackTrace</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        &#125;</span><br><span class="hljs-function">    &#125;</span><br><span class="hljs-function">&#125;</span><br><span class="hljs-function"></span><br></code></pre></td></tr></table></figure><p>结果如下：在延迟一秒后，开始执行任务，且只执行一次。</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%89%A7%E8%A1%8C/4.png" class=""><h4 id="scheduleAtFixRate"><a href="#scheduleAtFixRate" class="headerlink" title="scheduleAtFixRate"></a>scheduleAtFixRate</h4><p>当我们需要在固定延迟后，定期执行任务时，可以使用scheduleAtFixedRate方法，如下所示，每隔2秒执行相同的任务</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs livescript">public <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> main(<span class="hljs-built_in">String</span>[] args) &#123;<br>        ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(<span class="hljs-number">1</span>);<br>        scheduledExecutorService.scheduleAtFixedRate<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">            System.out.println(<span class="hljs-string">&quot;Hello World:&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>());</span></span><br><span class="hljs-params"><span class="hljs-function">            <span class="hljs-keyword">try</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                Thread.sleep(<span class="hljs-number">1000</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">                e.printStackTrace();</span></span><br><span class="hljs-params"><span class="hljs-function">            &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">        &#125;, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, TimeUnit.SECONDS)</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">        <span class="hljs-title">try</span> &#123;</span><br><span class="hljs-function">            <span class="hljs-title">Thread</span>.<span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">20000</span>)</span>;</span><br><span class="hljs-function">        &#125; <span class="hljs-title">catch</span> <span class="hljs-params">(InterruptedException e)</span> &#123;</span><br><span class="hljs-function">            <span class="hljs-title">throw</span> <span class="hljs-title">new</span> <span class="hljs-title">RuntimeException</span><span class="hljs-params">(e)</span>;</span><br><span class="hljs-function">        &#125;</span><br><span class="hljs-function">        <span class="hljs-title">scheduledExecutorService</span>.<span class="hljs-title">shutdown</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        <span class="hljs-title">try</span> &#123;</span><br><span class="hljs-function">            <span class="hljs-title">if</span> <span class="hljs-params">(!scheduledExecutorService.awaitTermination(<span class="hljs-number">10</span>, TimeUnit.SECONDS))</span> &#123;</span><br><span class="hljs-function">                <span class="hljs-title">scheduledExecutorService</span>.<span class="hljs-title">shutdownNow</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">            &#125;</span><br><span class="hljs-function">        &#125; <span class="hljs-title">catch</span> <span class="hljs-params">(InterruptedException e)</span> &#123;</span><br><span class="hljs-function">            <span class="hljs-title">e</span>.<span class="hljs-title">printStackTrace</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">        &#125;</span><br><span class="hljs-function">    &#125;</span><br></code></pre></td></tr></table></figure><p>结果如下：</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%89%A7%E8%A1%8C/5.png" class=""><p>如果任务执行时间比间隔时间长，那么scheduledExecutorService将等待当前任务执行完毕后再开始执行下一个任务，我们修改代码如下：</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs livescript">ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(<span class="hljs-number">4</span>);<br>       scheduledExecutorService.scheduleAtFixedRate<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">           System.out.println(<span class="hljs-string">&quot;Hello World:&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>());</span></span><br><span class="hljs-params"><span class="hljs-function">           <span class="hljs-keyword">try</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">               Thread.sleep(<span class="hljs-number">3000</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">           &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">               e.printStackTrace();</span></span><br><span class="hljs-params"><span class="hljs-function">           &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">       &#125;, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, TimeUnit.SECONDS)</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">       <span class="hljs-title">try</span> &#123;</span><br><span class="hljs-function">           <span class="hljs-title">Thread</span>.<span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">20000</span>)</span>;</span><br><span class="hljs-function">       &#125; <span class="hljs-title">catch</span> <span class="hljs-params">(InterruptedException e)</span> &#123;</span><br><span class="hljs-function">           <span class="hljs-title">throw</span> <span class="hljs-title">new</span> <span class="hljs-title">RuntimeException</span><span class="hljs-params">(e)</span>;</span><br><span class="hljs-function">       &#125;</span><br><span class="hljs-function">       <span class="hljs-title">scheduledExecutorService</span>.<span class="hljs-title">shutdown</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">       <span class="hljs-title">try</span> &#123;</span><br><span class="hljs-function">           <span class="hljs-title">if</span> <span class="hljs-params">(!scheduledExecutorService.awaitTermination(<span class="hljs-number">10</span>, TimeUnit.SECONDS))</span> &#123;</span><br><span class="hljs-function">               <span class="hljs-title">scheduledExecutorService</span>.<span class="hljs-title">shutdownNow</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">           &#125;</span><br><span class="hljs-function">       &#125; <span class="hljs-title">catch</span> <span class="hljs-params">(InterruptedException e)</span> &#123;</span><br><span class="hljs-function">           <span class="hljs-title">e</span>.<span class="hljs-title">printStackTrace</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">       &#125;</span><br></code></pre></td></tr></table></figure><p>结果如下，每隔3秒执行一次任务</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%89%A7%E8%A1%8C/6.png" class=""><h4 id="scheduleWithFixedDelay方法"><a href="#scheduleWithFixedDelay方法" class="headerlink" title="scheduleWithFixedDelay方法"></a>scheduleWithFixedDelay方法</h4><p>如果任务之间必须具有固定长度的延迟，那么可以使用scheduleWithFixedDelay方法。</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs livescript">public <span class="hljs-keyword">static</span> <span class="hljs-literal">void</span> main(<span class="hljs-built_in">String</span>[] args) &#123;<br>      ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(<span class="hljs-number">4</span>);<br>      scheduledExecutorService.scheduleWithFixedDelay<span class="hljs-function"><span class="hljs-params">(() -&gt; &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">          System.out.println(<span class="hljs-string">&quot;Hello World:&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>());</span></span><br><span class="hljs-params"><span class="hljs-function">          <span class="hljs-keyword">try</span> &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">              Thread.sleep(<span class="hljs-number">1000</span>);</span></span><br><span class="hljs-params"><span class="hljs-function">          &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">              e.printStackTrace();</span></span><br><span class="hljs-params"><span class="hljs-function">          &#125;</span></span><br><span class="hljs-params"><span class="hljs-function">      &#125;, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, TimeUnit.SECONDS)</span>;</span><br><span class="hljs-function"></span><br><span class="hljs-function">      <span class="hljs-title">try</span> &#123;</span><br><span class="hljs-function">          <span class="hljs-title">Thread</span>.<span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-number">20000</span>)</span>;</span><br><span class="hljs-function">      &#125; <span class="hljs-title">catch</span> <span class="hljs-params">(InterruptedException e)</span> &#123;</span><br><span class="hljs-function">          <span class="hljs-title">throw</span> <span class="hljs-title">new</span> <span class="hljs-title">RuntimeException</span><span class="hljs-params">(e)</span>;</span><br><span class="hljs-function">      &#125;</span><br><span class="hljs-function">      <span class="hljs-title">scheduledExecutorService</span>.<span class="hljs-title">shutdown</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">      <span class="hljs-title">try</span> &#123;</span><br><span class="hljs-function">          <span class="hljs-title">if</span> <span class="hljs-params">(!scheduledExecutorService.awaitTermination(<span class="hljs-number">10</span>, TimeUnit.SECONDS))</span> &#123;</span><br><span class="hljs-function">              <span class="hljs-title">scheduledExecutorService</span>.<span class="hljs-title">shutdownNow</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">          &#125;</span><br><span class="hljs-function">      &#125; <span class="hljs-title">catch</span> <span class="hljs-params">(InterruptedException e)</span> &#123;</span><br><span class="hljs-function">          <span class="hljs-title">e</span>.<span class="hljs-title">printStackTrace</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">      &#125;</span><br><span class="hljs-function">  &#125;</span><br></code></pre></td></tr></table></figure><p>在上述代码中，任务执行时长需要1秒，然后设置的间隔时间为2秒，因此，我们可以看到，每隔任务之间，间隔3秒执行一次</p><img src="/2024/05/14/%E6%89%8B%E6%92%B8XXL-JOB%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%89%A7%E8%A1%8C/7.png" class="">]]></content>
    
    
    
    <tags>
      
      <tag>XXL-JOB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>手撸Mybatis（五）——连接数据库进行insert，update和delete</title>
    <link href="/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E4%BA%94%EF%BC%89%E2%80%94%E2%80%94%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9B%E8%A1%8Cinsert%EF%BC%8Cupdate%E5%92%8Cdelete/"/>
    <url>/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E4%BA%94%EF%BC%89%E2%80%94%E2%80%94%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9B%E8%A1%8Cinsert%EF%BC%8Cupdate%E5%92%8Cdelete/</url>
    
    <content type="html"><![CDATA[<h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>在上一章中，我们成功实现了数据库的连接，以及单个字段的查询、resultType映射查询、resultMap映射查询。在本章，我们将讲解关于增加、修改和删除操作。</p><h3 id="insert操作"><a href="#insert操作" class="headerlink" title="insert操作"></a>insert操作</h3><p>首先，我们修改IUserMapper类，添加insertUser接口</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.test;<br><br>public interface IUserMapper <span class="hljs-punctuation">&#123;</span><br>    String queryUserName(Integer id);<br><br>    Integer queryUserAge(Integer id);<br><br>    User queryUserById(Integer id);<br><br>    IdUserNameVO queryIdUserNameVOById(Integer id);<br><br>    void insertUser(User user);<br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>修改UserMapper.xml，加上insertUser相关的xml块</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">&lt;insert id=<span class="hljs-string">&quot;insertUser&quot;</span> parameterType=<span class="hljs-string">&quot;com.yang.mybatis.test.User&quot;</span>&gt;<br>       insert into user( user_name<span class="hljs-punctuation">,</span> password<span class="hljs-punctuation">,</span> age<span class="hljs-punctuation">,</span> create_time)<br>       values( #<span class="hljs-punctuation">&#123;</span>userName<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> #<span class="hljs-punctuation">&#123;</span>password<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> #<span class="hljs-punctuation">&#123;</span>age<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> #<span class="hljs-punctuation">&#123;</span>createTime<span class="hljs-punctuation">&#125;</span>)<br>   &lt;/insert&gt;<br></code></pre></td></tr></table></figure><p>我们注意到，对于每一个接口方法，其对应的xml块，类型有select，insert，update和delete这几种类型，此外，还有一个parameterType参数，因此，我们需要再次修改MybatisSqlStatement类，加上operateType和parameterType参数</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs json">public class MybatisSqlStatement implements Serializable <span class="hljs-punctuation">&#123;</span><br>    private String namespace;<br><br>    private String id;<br><br>    private String sql;<br><br>    private String resultType;<br><br>    private String resultMap;<br><br>    private String operateType;<br><br>    private String parameterType;<br>  <br>    ...省略getter 和setter<br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>接着修改XmlMybatisMapperParser的parseStatement方法，在解析mapper.xml的时候，设置对应的值</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs json">private void parseStatement(MybatisMapperXmlConfiguration mybatisMapperXmlConfiguration<span class="hljs-punctuation">,</span> List&lt;Element&gt; elements) <span class="hljs-punctuation">&#123;</span><br>       if (elements == <span class="hljs-literal"><span class="hljs-keyword">null</span></span> || elements.isEmpty()) <span class="hljs-punctuation">&#123;</span><br>           return;<br>       <span class="hljs-punctuation">&#125;</span><br>       String namespace = mybatisMapperXmlConfiguration.getMapperName();<br>       for (Element element <span class="hljs-punctuation">:</span> elements) <span class="hljs-punctuation">&#123;</span><br>           String id = element.attributeValue(<span class="hljs-string">&quot;id&quot;</span>);<br>           String resultType = element.attributeValue(<span class="hljs-string">&quot;resultType&quot;</span>);<br>           String resultMap = element.attributeValue(<span class="hljs-string">&quot;resultMap&quot;</span>);<br>           String parameterType = element.attributeValue(<span class="hljs-string">&quot;parameterType&quot;</span>);<br>           String sql = element.getText().trim();<br><br>           MybatisSqlStatement mybatisSqlStatement = new MybatisSqlStatement();<br>           mybatisSqlStatement.setNamespace(namespace);<br>           mybatisSqlStatement.setId(id);<br>           mybatisSqlStatement.setSql(sql);<br>           mybatisSqlStatement.setResultType(resultType);<br>           mybatisSqlStatement.setResultMap(resultMap);<br>           mybatisSqlStatement.setParameterType(parameterType);<br>           mybatisSqlStatement.setOperateType(element.getName().toLowerCase());<br><br>           mybatisMapperXmlConfiguration.addMybatisSqlStatement(mybatisSqlStatement);<br>       <span class="hljs-punctuation">&#125;</span><br>   <span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>定义IMybatisPreparedStatementBuilder接口，用于接收请求参数并设置参数值到preparedStatement</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.execute;<br><br><br><br>import com.yang.mybatis.execute.request.MybatisPreparedStatementBuilderRequest;<br><br>import java.sql.PreparedStatement;<br>import java.sql.SQLException;<br><br>public interface IMybatisPreparedStatementBuilder <span class="hljs-punctuation">&#123;</span><br>    PreparedStatement buildPreparedStatement(MybatisPreparedStatementBuilderRequest mybatisPreparedStatementBuilderRequest) throws SQLException;<br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>其中，MybatisPreparedStatementBuilderRequest的定义如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.execute.request;<br><br>import com.yang.mybatis.config.MybatisSqlStatement;<br><br>import java.io.Serializable;<br>import java.sql.Connection;<br><br>public class MybatisPreparedStatementBuilderRequest implements Serializable <span class="hljs-punctuation">&#123;</span><br>    private Connection connection;<br>    private Object<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> parameters;<br>    private MybatisSqlStatement mybatisSqlStatement;<br>    private String operateType;<br><br>    public Connection getConnection() <span class="hljs-punctuation">&#123;</span><br>        return connection;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setConnection(Connection connection) <span class="hljs-punctuation">&#123;</span><br>        this.connection = connection;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public Object<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> getParameters() <span class="hljs-punctuation">&#123;</span><br>        return parameters;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setParameters(Object<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> parameters) <span class="hljs-punctuation">&#123;</span><br>        this.parameters = parameters;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisSqlStatement getMybatisSqlStatement() <span class="hljs-punctuation">&#123;</span><br>        return mybatisSqlStatement;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setMybatisSqlStatement(MybatisSqlStatement mybatisSqlStatement) <span class="hljs-punctuation">&#123;</span><br>        this.mybatisSqlStatement = mybatisSqlStatement;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public String getOperateType() <span class="hljs-punctuation">&#123;</span><br>        return operateType;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setOperateType(String operateType) <span class="hljs-punctuation">&#123;</span><br>        this.operateType = operateType;<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>该接口的默认实现类为：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.execute;<br><br>import com.yang.mybatis.config.MybatisSqlStatement;<br>import com.yang.mybatis.execute.request.MybatisPreparedStatementBuilderRequest;<br>import org.apache.commons.lang3.StringUtils;<br><br>import java.lang.reflect.Field;<br>import java.sql.Connection;<br>import java.sql.PreparedStatement;<br>import java.sql.SQLException;<br>import java.util.ArrayList;<br>import java.util.HashMap;<br>import java.util.List;<br>import java.util.Map;<br><br>public class DefaultMybatisPreparedStatementBuilder implements IMybatisPreparedStatementBuilder <span class="hljs-punctuation">&#123;</span><br>    @Override<br>    public PreparedStatement buildPreparedStatement(MybatisPreparedStatementBuilderRequest mybatisPreparedStatementBuilderRequest) throws SQLException <span class="hljs-punctuation">&#123;</span><br>        Connection connection = mybatisPreparedStatementBuilderRequest.getConnection();<br>        Object<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> parameters = mybatisPreparedStatementBuilderRequest.getParameters();<br><br>        MybatisSqlStatement mybatisSqlStatement = mybatisPreparedStatementBuilderRequest.getMybatisSqlStatement();<br>        String rawSql = mybatisSqlStatement.getSql();<br><br>        List&lt;String&gt; parameterNameList = new ArrayList&lt;&gt;();<br>        String sql = extractRawSql(rawSql<span class="hljs-punctuation">,</span> parameterNameList);<br>        PreparedStatement preparedStatement = connection.prepareStatement(sql);<br><br>        String parameterType = mybatisSqlStatement.getParameterType();<br>        if (StringUtils.isEmpty(parameterType)) <span class="hljs-punctuation">&#123;</span><br>            if (parameterNameList.size() != parameters.length) <span class="hljs-punctuation">&#123;</span><br>                throw new RuntimeException(<span class="hljs-string">&quot;SQL语句参数个数不匹配====&quot;</span>);<br>            <span class="hljs-punctuation">&#125;</span><br>            int index = <span class="hljs-number">1</span>;<br>            for (Object o <span class="hljs-punctuation">:</span> parameters) <span class="hljs-punctuation">&#123;</span><br>                preparedStatement.setObject(index ++<span class="hljs-punctuation">,</span> o);<br>            <span class="hljs-punctuation">&#125;</span><br>            return preparedStatement;<br>        <span class="hljs-punctuation">&#125;</span><br><br>        try <span class="hljs-punctuation">&#123;</span><br>            Object parameter = parameters<span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span>;<br>            Class&lt;?&gt; aClass = Class.forName(parameterType);<br>            Field<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> fields = aClass.getDeclaredFields();<br>            Map&lt;String<span class="hljs-punctuation">,</span> Field&gt; filedName2FieldMap = new HashMap&lt;&gt;();<br>            for (Field field <span class="hljs-punctuation">:</span> fields) <span class="hljs-punctuation">&#123;</span><br>                filedName2FieldMap.put(field.getName()<span class="hljs-punctuation">,</span> field);<br>            <span class="hljs-punctuation">&#125;</span><br><br>            List&lt;Object&gt; parameterValueList = new ArrayList&lt;&gt;();<br>            for (String parameterName <span class="hljs-punctuation">:</span> parameterNameList) <span class="hljs-punctuation">&#123;</span><br>                Field field = filedName2FieldMap.get(parameterName);<br>                if (field == <span class="hljs-literal"><span class="hljs-keyword">null</span></span>) <span class="hljs-punctuation">&#123;</span><br>                    throw new RuntimeException(<span class="hljs-string">&quot;SQL参数不存在&quot;</span>);<br>                <span class="hljs-punctuation">&#125;</span><br>                field.setAccessible(<span class="hljs-literal"><span class="hljs-keyword">true</span></span>);<br>                Object value = field.get(parameter);<br>                parameterValueList.add(value);<br>            <span class="hljs-punctuation">&#125;</span><br><br>            int index = <span class="hljs-number">1</span>;<br>            for (Object o <span class="hljs-punctuation">:</span> parameterValueList) <span class="hljs-punctuation">&#123;</span><br>                preparedStatement.setObject(index++<span class="hljs-punctuation">,</span> o);<br>            <span class="hljs-punctuation">&#125;</span><br>            return preparedStatement;<br>        <span class="hljs-punctuation">&#125;</span> catch (ClassNotFoundException | IllegalAccessException e) <span class="hljs-punctuation">&#123;</span><br>            e.printStackTrace();<br>            throw new RuntimeException(e);<br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><br>    private String extractRawSql(String rawSql<span class="hljs-punctuation">,</span> List&lt;String&gt; parameterNameList) <span class="hljs-punctuation">&#123;</span><br>        StringBuilder sqlBuilder = new StringBuilder();<br>        int start = <span class="hljs-number">0</span>;<br>        int end = <span class="hljs-number">-1</span>;<br>        while ((end = rawSql.indexOf(<span class="hljs-string">&quot;#&quot;</span><span class="hljs-punctuation">,</span> start)) != <span class="hljs-number">-1</span>) <span class="hljs-punctuation">&#123;</span><br>            sqlBuilder.append(rawSql.substring(start<span class="hljs-punctuation">,</span> end - <span class="hljs-number">1</span>))<br>                    .append(<span class="hljs-string">&quot; ? &quot;</span>);<br>            int parameterStart = end + <span class="hljs-number">2</span>;<br>            int parameterEnd = rawSql.indexOf(<span class="hljs-string">&quot;&#125;&quot;</span><span class="hljs-punctuation">,</span> parameterStart);<br>            parameterNameList.add(rawSql.substring(parameterStart<span class="hljs-punctuation">,</span> parameterEnd));<br>            start = parameterEnd + <span class="hljs-number">1</span>;<br>        <span class="hljs-punctuation">&#125;</span><br>        sqlBuilder.append(rawSql.substring(start));<br><br>        return sqlBuilder.toString();<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>然后，我们修改DefaultMybatisSqlSession类，在execute方法中我们先使用IMybatisPreparedStatementBuilder来构建PreparedStatement，然后执行相关操作，最后再通过IMybatisResultParser来对结果进行解析。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.session;<br><br>import com.yang.mybatis.config.MybatisConfiguration;<br>import com.yang.mybatis.config.MybatisEnvironment;<br>import com.yang.mybatis.config.MybatisMapperXmlConfiguration;<br>import com.yang.mybatis.config.MybatisSqlStatement;<br>import com.yang.mybatis.execute.DefaultMybatisPreparedStatementBuilder;<br>import com.yang.mybatis.execute.DefaultMybatisResultParser;<br>import com.yang.mybatis.execute.IMybatisPreparedStatementBuilder;<br>import com.yang.mybatis.execute.IMybatisResultParser;<br>import com.yang.mybatis.execute.request.MybatisPreparedStatementBuilderRequest;<br>import com.yang.mybatis.execute.request.MybatisResultParserRequest;<br>import com.yang.mybatis.proxy.MapperProxyFactory;<br><br>import java.sql.Connection;<br>import java.sql.PreparedStatement;<br>import java.sql.ResultSet;<br>import java.sql.SQLException;<br>import java.util.Map;<br><br><br>public class DefaultMybatisSqlSession implements IMybatisSqlSession <span class="hljs-punctuation">&#123;</span><br>    private MapperProxyFactory mapperProxyFactory;<br>    private MybatisConfiguration mybatisConfiguration;<br><br>    private IMybatisResultParser iMybatisResultParser;<br><br>    private IMybatisPreparedStatementBuilder iMybatisPreparedStatementBuilder;<br><br>    public DefaultMybatisSqlSession(MapperProxyFactory mapperProxyFactory<span class="hljs-punctuation">,</span> IMybatisPreparedStatementBuilder iMybatisPreparedStatementBuilder<span class="hljs-punctuation">,</span><br>                                    IMybatisResultParser iMybatisResultParser) <span class="hljs-punctuation">&#123;</span><br>        this.mapperProxyFactory = mapperProxyFactory;<br>        this.mybatisConfiguration = mapperProxyFactory.getMybatisConfiguration();<br>        this.iMybatisPreparedStatementBuilder = iMybatisPreparedStatementBuilder;<br>        this.iMybatisResultParser = iMybatisResultParser;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    @Override<br>    public &lt;T&gt; T execute(String method<span class="hljs-punctuation">,</span> Object parameter) <span class="hljs-punctuation">&#123;</span><br>        Map&lt;String<span class="hljs-punctuation">,</span> MybatisSqlStatement&gt; mapperMethod2SqlStatementsMap = mapperProxyFactory.getMybatisConfiguration().getMapperMethod2SqlStatementsMap();<br>        MybatisSqlStatement mybatisSqlStatement = mapperMethod2SqlStatementsMap.get(method);<br><br>        MybatisEnvironment defaultMybatisEnvironment = this.mybatisConfiguration.getDefaultMybatisEnvironment();<br><br>        return new TransactionInvoke&lt;T&gt;() <span class="hljs-punctuation">&#123;</span><br>            @Override<br>            public T execute(Connection connection) throws SQLException <span class="hljs-punctuation">&#123;</span><br>                Object<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> parameters = (Object<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>) parameter;<br>                String operateType = mybatisSqlStatement.getOperateType();<br><br>                MybatisPreparedStatementBuilderRequest mybatisPreparedStatementBuilderRequest = new MybatisPreparedStatementBuilderRequest();<br>                mybatisPreparedStatementBuilderRequest.setConnection(connection);<br>                mybatisPreparedStatementBuilderRequest.setMybatisSqlStatement(mybatisSqlStatement);<br>                mybatisPreparedStatementBuilderRequest.setParameters(parameters);<br>                mybatisPreparedStatementBuilderRequest.setOperateType(operateType);<br>                PreparedStatement preparedStatement = iMybatisPreparedStatementBuilder.buildPreparedStatement(mybatisPreparedStatementBuilderRequest);<br><br>                ResultSet resultSet = <span class="hljs-literal"><span class="hljs-keyword">null</span></span>;<br>                if (<span class="hljs-string">&quot;select&quot;</span>.equals(operateType)) <span class="hljs-punctuation">&#123;</span><br>                    resultSet = preparedStatement.executeQuery();<br>                <span class="hljs-punctuation">&#125;</span> else <span class="hljs-punctuation">&#123;</span><br>                    preparedStatement.execute();<br>                <span class="hljs-punctuation">&#125;</span><br><br>                String mapperName = mybatisSqlStatement.getNamespace();<br>                MybatisMapperXmlConfiguration mybatisMapperXmlConfiguration = mybatisConfiguration.getMybatisMapperXmlConfiguration(mapperName);<br><br>                MybatisResultParserRequest mybatisResultParserRequest = new MybatisResultParserRequest();<br>                mybatisResultParserRequest.setResultSet(resultSet);<br>                mybatisResultParserRequest.setMybatisSqlStatement(mybatisSqlStatement);<br>                mybatisResultParserRequest.setMybatisMapperXmlConfiguration(mybatisMapperXmlConfiguration);<br>                mybatisResultParserRequest.setOperateType(operateType);<br>                T result = iMybatisResultParser.parseResult(mybatisResultParserRequest);<br>                if (resultSet != <span class="hljs-literal"><span class="hljs-keyword">null</span></span>) <span class="hljs-punctuation">&#123;</span><br>                    resultSet.close();<br>                <span class="hljs-punctuation">&#125;</span><br>                return result;<br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span>.invoke(defaultMybatisEnvironment.getMybatisDataSource());<br>    <span class="hljs-punctuation">&#125;</span><br><br>    @Override<br>    public &lt;T&gt; T getMapper(Class&lt;T&gt; type) <span class="hljs-punctuation">&#123;</span><br>        return (T) mapperProxyFactory.newInstance(type<span class="hljs-punctuation">,</span> this);<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>这里还需要修改DefaultMybatisSqlSessionFactory类，将IMybatisResultParser和IMybatisPreparedStatementBuilder的构建职责迁移于此，从而避免每一个SqlSession都需要重复创建这些类。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.session;<br><br>import com.yang.mybatis.execute.DefaultMybatisPreparedStatementBuilder;<br>import com.yang.mybatis.execute.DefaultMybatisResultParser;<br>import com.yang.mybatis.execute.IMybatisPreparedStatementBuilder;<br>import com.yang.mybatis.execute.IMybatisResultParser;<br>import com.yang.mybatis.proxy.MapperProxyFactory;<br><br>public class DefaultMybatisSqlSessionFactory implements IMybatisSqlSessionFactory <span class="hljs-punctuation">&#123;</span><br>    private MapperProxyFactory mapperProxyFactory;<br>    private IMybatisPreparedStatementBuilder iMybatisPreparedStatementBuilder = new DefaultMybatisPreparedStatementBuilder();<br>    private IMybatisResultParser iMybatisResultParser = new DefaultMybatisResultParser();<br><br>    public DefaultMybatisSqlSessionFactory(MapperProxyFactory mapperProxyFactory) <span class="hljs-punctuation">&#123;</span><br>        this.mapperProxyFactory = mapperProxyFactory;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    @Override<br>    public IMybatisSqlSession openSession() <span class="hljs-punctuation">&#123;</span><br>        return new DefaultMybatisSqlSession(mapperProxyFactory<span class="hljs-punctuation">,</span> iMybatisPreparedStatementBuilder<span class="hljs-punctuation">,</span> iMybatisResultParser);<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>添加测试代码，进行测试：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.test;<br><br>import com.yang.mybatis.config.parser.XmlMybatisConfigurationParser;<br>import com.yang.mybatis.config.parser.XmlMybatisMapperParser;<br>import com.yang.mybatis.session.IMybatisSqlSession;<br>import com.yang.mybatis.session.IMybatisSqlSessionFactory;<br>import com.yang.mybatis.session.MybatisSqlSessionFactoryBuilder;<br><br>import java.time.LocalDateTime;<br><br><br>public class Main <span class="hljs-punctuation">&#123;</span><br>    public static void main(String<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> args) <span class="hljs-punctuation">&#123;</span><br>        String configPath = <span class="hljs-string">&quot;mybatis-config.xml&quot;</span>;<br>        IMybatisSqlSessionFactory mybatisSqlSessionFactory = new MybatisSqlSessionFactoryBuilder()<br>                .setMybatisMapperParser(new XmlMybatisMapperParser())<br>                .setMybatisConfigurationParser(new XmlMybatisConfigurationParser())<br>                .setConfigPath(configPath)<br>                .buildSqlSessionFactory();<br>        IMybatisSqlSession mybatisSqlSession = mybatisSqlSessionFactory.openSession();<br>        IUserMapper userMapper = mybatisSqlSession.getMapper(IUserMapper.class);<br><br>        User user = new User();<br>        user.setUserName(<span class="hljs-string">&quot;test&quot;</span>);<br>        user.setPassword(<span class="hljs-string">&quot;test&quot;</span>);<br>        user.setAge(<span class="hljs-number">4</span>);<br>        user.setCreateTime(LocalDateTime.now());<br>        userMapper.insertUser(user);<br>    <span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>运行上述方法，再次查看数据库，结果如下：</p><img src="/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E4%BA%94%EF%BC%89%E2%80%94%E2%80%94%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9B%E8%A1%8Cinsert%EF%BC%8Cupdate%E5%92%8Cdelete/1.png" class=""><h3 id="update操作"><a href="#update操作" class="headerlink" title="update操作"></a>update操作</h3><p>首先，我们在IUserMapper接口上，添加一个updateUserById方法</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json">void updateUserById(User user);<br><br></code></pre></td></tr></table></figure><p>然后修改UserMapper.xml，添加上updateUserById相关的xml块</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json">&lt;update id=<span class="hljs-string">&quot;updateUserById&quot;</span> parameterType=<span class="hljs-string">&quot;com.yang.mybatis.test.User&quot;</span>&gt;<br>       update user<br>       set user_name = #<span class="hljs-punctuation">&#123;</span>userName<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>           password = #<span class="hljs-punctuation">&#123;</span>password<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>           age = #<span class="hljs-punctuation">&#123;</span>age<span class="hljs-punctuation">&#125;</span><br>       where id = #<span class="hljs-punctuation">&#123;</span>id<span class="hljs-punctuation">&#125;</span><br>   &lt;/update&gt;<br></code></pre></td></tr></table></figure><p>添加测试方法，进行测试</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json">String configPath = <span class="hljs-string">&quot;mybatis-config.xml&quot;</span>;<br>     MybatisSqlSessionFactory mybatisSqlSessionFactory = new MybatisSqlSessionFactoryBuilder()<br>             .setMybatisMapperParser(new XmlMybatisMapperParser())<br>             .setMybatisConfigurationParser(new XmlMybatisConfigurationParser())<br>             .setConfigPath(configPath)<br>             .buildSqlSessionFactory();<br>     IMybatisSqlSession mybatisSqlSession = mybatisSqlSessionFactory.openSession();<br>     IUserMapper userMapper = mybatisSqlSession.getMapper(IUserMapper.class);<br>     User user = userMapper.queryUserById(<span class="hljs-number">4</span>);<br>     user.setUserName(<span class="hljs-string">&quot;cxy1&quot;</span>);<br>     user.setPassword(<span class="hljs-string">&quot;1234&quot;</span>);<br>     user.setAge(<span class="hljs-number">10</span>);<br>     userMapper.updateUserById(user);<br></code></pre></td></tr></table></figure><p>运行方法后，查看数据库，结果如下：</p><img src="/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E4%BA%94%EF%BC%89%E2%80%94%E2%80%94%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9B%E8%A1%8Cinsert%EF%BC%8Cupdate%E5%92%8Cdelete/2.png" class=""><h3 id="delete操作"><a href="#delete操作" class="headerlink" title="delete操作"></a>delete操作</h3><p>首先，修改IUserMapper，添加deleteUserById方法</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json">void deleteUserById(Integer id);<br><br></code></pre></td></tr></table></figure><p>然后在UserMapper.xml中添加上对应的xml块</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">&lt;delete id=<span class="hljs-string">&quot;deleteUserById&quot;</span> parameterType=<span class="hljs-string">&quot;int&quot;</span>&gt;<br>        delete from user<br>        where id = #<span class="hljs-punctuation">&#123;</span>id<span class="hljs-punctuation">&#125;</span><br>    &lt;/delete&gt;<br></code></pre></td></tr></table></figure><p>添加测试方法，进行测试：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs json">public static void main(String<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> args) <span class="hljs-punctuation">&#123;</span><br>       String configPath = <span class="hljs-string">&quot;mybatis-config.xml&quot;</span>;<br>       IMybatisSqlSessionFactory mybatisSqlSessionFactory = new MybatisSqlSessionFactoryBuilder()<br>               .setMybatisMapperParser(new XmlMybatisMapperParser())<br>               .setMybatisConfigurationParser(new XmlMybatisConfigurationParser())<br>               .setConfigPath(configPath)<br>               .buildSqlSessionFactory();<br>       IMybatisSqlSession mybatisSqlSession = mybatisSqlSessionFactory.openSession();<br>       IUserMapper userMapper = mybatisSqlSession.getMapper(IUserMapper.class);<br>       userMapper.deleteUserById(<span class="hljs-number">5</span>);<br>   <span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>结果如下:</p><img src="/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E4%BA%94%EF%BC%89%E2%80%94%E2%80%94%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9B%E8%A1%8Cinsert%EF%BC%8Cupdate%E5%92%8Cdelete/3.png" class=""><p>可以看出，这里因为我们使用的是parameterType是int而不是java.lang.Integer，所以会报错，但是一般情况下，像int，float，long等小写，一般我们也会使用的，而且用的频率比java.lang.Integer的频率更大，那么，我们其实可以添加一个假名，将int这些小写的方式和对应的包装类关联起来。我们修改DefaultMybatisPreparedStatementBuilder，修改内容如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.execute;<br><br>import com.yang.mybatis.config.MybatisSqlStatement;<br>import com.yang.mybatis.execute.request.MybatisPreparedStatementBuilderRequest;<br>import org.apache.commons.lang3.StringUtils;<br><br>import java.lang.reflect.Field;<br>import java.sql.Connection;<br>import java.sql.PreparedStatement;<br>import java.sql.SQLException;<br>import java.util.ArrayList;<br>import java.util.HashMap;<br>import java.util.List;<br>import java.util.Map;<br><br>public class DefaultMybatisPreparedStatementBuilder implements IMybatisPreparedStatementBuilder <span class="hljs-punctuation">&#123;</span><br>    private Map&lt;String<span class="hljs-punctuation">,</span> String&gt; baseAliasMap = new HashMap&lt;&gt;();<br><br>    <span class="hljs-punctuation">&#123;</span><br>        baseAliasMap.put(<span class="hljs-string">&quot;int&quot;</span><span class="hljs-punctuation">,</span> Integer.class.getName());<br>        baseAliasMap.put(<span class="hljs-string">&quot;float&quot;</span><span class="hljs-punctuation">,</span> Float.class.getName());<br>        baseAliasMap.put(<span class="hljs-string">&quot;double&quot;</span><span class="hljs-punctuation">,</span> Double.class.getName());<br>        baseAliasMap.put(<span class="hljs-string">&quot;long&quot;</span><span class="hljs-punctuation">,</span> Long.class.getName());<br>        baseAliasMap.put(<span class="hljs-string">&quot;byte&quot;</span><span class="hljs-punctuation">,</span> Byte.class.getName());<br>        baseAliasMap.put(<span class="hljs-string">&quot;short&quot;</span><span class="hljs-punctuation">,</span> Short.class.getName());<br>        baseAliasMap.put(<span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span> String.class.getName());<br>        baseAliasMap.put(<span class="hljs-string">&quot;String&quot;</span><span class="hljs-punctuation">,</span> String.class.getName());<br>        baseAliasMap.put(<span class="hljs-string">&quot;char&quot;</span><span class="hljs-punctuation">,</span> Character.class.getName());<br>    <span class="hljs-punctuation">&#125;</span><br>    @Override<br>    public PreparedStatement buildPreparedStatement(MybatisPreparedStatementBuilderRequest mybatisPreparedStatementBuilderRequest) throws SQLException <span class="hljs-punctuation">&#123;</span><br>        Connection connection = mybatisPreparedStatementBuilderRequest.getConnection();<br>        Object<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> parameters = mybatisPreparedStatementBuilderRequest.getParameters();<br><br>        MybatisSqlStatement mybatisSqlStatement = mybatisPreparedStatementBuilderRequest.getMybatisSqlStatement();<br>        String rawSql = mybatisSqlStatement.getSql();<br><br>        List&lt;String&gt; parameterNameList = new ArrayList&lt;&gt;();<br>        String sql = extractRawSql(rawSql<span class="hljs-punctuation">,</span> parameterNameList);<br>        PreparedStatement preparedStatement = connection.prepareStatement(sql);<br><br>        String parameterType = mybatisSqlStatement.getParameterType();<br>        if (StringUtils.isEmpty(parameterType)) <span class="hljs-punctuation">&#123;</span><br>            if (parameterNameList.size() != parameters.length) <span class="hljs-punctuation">&#123;</span><br>                throw new RuntimeException(<span class="hljs-string">&quot;SQL语句参数个数不匹配====&quot;</span>);<br>            <span class="hljs-punctuation">&#125;</span><br>            int index = <span class="hljs-number">1</span>;<br>            for (Object o <span class="hljs-punctuation">:</span> parameters) <span class="hljs-punctuation">&#123;</span><br>                preparedStatement.setObject(index ++<span class="hljs-punctuation">,</span> o);<br>            <span class="hljs-punctuation">&#125;</span><br>            return preparedStatement;<br>        <span class="hljs-punctuation">&#125;</span><br><br>        try <span class="hljs-punctuation">&#123;</span><br>            Object parameter = parameters<span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span>;<br>            if (baseAliasMap.containsKey(parameterType)) <span class="hljs-punctuation">&#123;</span><br>                if (parameters.length != <span class="hljs-number">1</span>) <span class="hljs-punctuation">&#123;</span><br>                    throw new RuntimeException(<span class="hljs-string">&quot;SQL语句有误, 只能有一个parameterType参数&quot;</span>);<br>                <span class="hljs-punctuation">&#125;</span><br>                preparedStatement.setObject(<span class="hljs-number">1</span><span class="hljs-punctuation">,</span> parameter);<br>                return preparedStatement;<br>            <span class="hljs-punctuation">&#125;</span><br>            Class&lt;?&gt; aClass = Class.forName(parameterType);<br>            Field<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> fields = aClass.getDeclaredFields();<br>            Map&lt;String<span class="hljs-punctuation">,</span> Field&gt; filedName2FieldMap = new HashMap&lt;&gt;();<br>            for (Field field <span class="hljs-punctuation">:</span> fields) <span class="hljs-punctuation">&#123;</span><br>                filedName2FieldMap.put(field.getName()<span class="hljs-punctuation">,</span> field);<br>            <span class="hljs-punctuation">&#125;</span><br><br>            List&lt;Object&gt; parameterValueList = new ArrayList&lt;&gt;();<br>            for (String parameterName <span class="hljs-punctuation">:</span> parameterNameList) <span class="hljs-punctuation">&#123;</span><br>                Field field = filedName2FieldMap.get(parameterName);<br>                if (field == <span class="hljs-literal"><span class="hljs-keyword">null</span></span>) <span class="hljs-punctuation">&#123;</span><br>                    throw new RuntimeException(<span class="hljs-string">&quot;SQL参数不存在&quot;</span>);<br>                <span class="hljs-punctuation">&#125;</span><br>                field.setAccessible(<span class="hljs-literal"><span class="hljs-keyword">true</span></span>);<br>                Object value = field.get(parameter);<br>                parameterValueList.add(value);<br>            <span class="hljs-punctuation">&#125;</span><br><br>            int index = <span class="hljs-number">1</span>;<br>            for (Object o <span class="hljs-punctuation">:</span> parameterValueList) <span class="hljs-punctuation">&#123;</span><br>                preparedStatement.setObject(index++<span class="hljs-punctuation">,</span> o);<br>            <span class="hljs-punctuation">&#125;</span><br>            return preparedStatement;<br>        <span class="hljs-punctuation">&#125;</span> catch (ClassNotFoundException | IllegalAccessException e) <span class="hljs-punctuation">&#123;</span><br>            throw new RuntimeException(e);<br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><br>    private String extractRawSql(String rawSql<span class="hljs-punctuation">,</span> List&lt;String&gt; parameterNameList) <span class="hljs-punctuation">&#123;</span><br>        StringBuilder sqlBuilder = new StringBuilder();<br>        int start = <span class="hljs-number">0</span>;<br>        int end = <span class="hljs-number">-1</span>;<br>        while ((end = rawSql.indexOf(<span class="hljs-string">&quot;#&quot;</span><span class="hljs-punctuation">,</span> start)) != <span class="hljs-number">-1</span>) <span class="hljs-punctuation">&#123;</span><br>            sqlBuilder.append(rawSql.substring(start<span class="hljs-punctuation">,</span> end - <span class="hljs-number">1</span>))<br>                    .append(<span class="hljs-string">&quot; ? &quot;</span>);<br>            int parameterStart = end + <span class="hljs-number">2</span>;<br>            int parameterEnd = rawSql.indexOf(<span class="hljs-string">&quot;&#125;&quot;</span><span class="hljs-punctuation">,</span> parameterStart);<br>            parameterNameList.add(rawSql.substring(parameterStart<span class="hljs-punctuation">,</span> parameterEnd));<br>            start = parameterEnd + <span class="hljs-number">1</span>;<br>        <span class="hljs-punctuation">&#125;</span><br>        sqlBuilder.append(rawSql.substring(start));<br><br>        return sqlBuilder.toString();<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>再次运行测试方法，这次没有报错了，然后我们查看数据库，结果如下，说明删除成功了。 </p><img src="/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E4%BA%94%EF%BC%89%E2%80%94%E2%80%94%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9B%E8%A1%8Cinsert%EF%BC%8Cupdate%E5%92%8Cdelete/4.png" class="">]]></content>
    
    
    
    <tags>
      
      <tag>-Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>手撸Mybatis（四）——连接数据库进行简单查询</title>
    <link href="/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E2%80%94%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9B%E8%A1%8C%E7%AE%80%E5%8D%95%E6%9F%A5%E8%AF%A2/"/>
    <url>/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E2%80%94%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9B%E8%A1%8C%E7%AE%80%E5%8D%95%E6%9F%A5%E8%AF%A2/</url>
    
    <content type="html"><![CDATA[<h3 id="添加数据库操作模板"><a href="#添加数据库操作模板" class="headerlink" title="添加数据库操作模板"></a>添加数据库操作模板</h3><p>对于JDBC操作，一般包括以下几个步骤：<br>1）注册驱动<br>2）建立连接<br>3）执行sql语句<br>4）处理结果<br>5）释放资源<br>上面这些步骤，真正和我们处理相关的，是第三步和第四步，其他步骤，都是通用的逻辑，因此，我们可以将这些步骤抽象成一个模板方法类，其内容如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.session;<br><br>import com.yang.mybatis.config.MybatisDataSource;<br><br>import java.sql.Connection;<br>import java.sql.DriverManager;<br>import java.sql.SQLException;<br><br><br>public abstract class TransactionInvoke&lt;T&gt; <span class="hljs-punctuation">&#123;</span><br>    public T invoke(MybatisDataSource mybatisDataSource) <span class="hljs-punctuation">&#123;</span><br>        String username = mybatisDataSource.getUsername();<br>        String password = mybatisDataSource.getPassword();<br>        String url = mybatisDataSource.getUrl();<br>        String driver = mybatisDataSource.getDriver();<br><br>        Connection connection = <span class="hljs-literal"><span class="hljs-keyword">null</span></span>;<br>        T result = <span class="hljs-literal"><span class="hljs-keyword">null</span></span>;<br>        try <span class="hljs-punctuation">&#123;</span><br>            Class.forName(driver);<br>            connection = DriverManager.getConnection(url<span class="hljs-punctuation">,</span> username<span class="hljs-punctuation">,</span> password);<br>            connection.setAutoCommit(<span class="hljs-literal"><span class="hljs-keyword">false</span></span>);<br>            result = execute(connection);<br>            connection.commit();<br>        <span class="hljs-punctuation">&#125;</span> catch (SQLException e) <span class="hljs-punctuation">&#123;</span><br>            try <span class="hljs-punctuation">&#123;</span><br>                connection.rollback();<br>            <span class="hljs-punctuation">&#125;</span> catch (SQLException ex) <span class="hljs-punctuation">&#123;</span><br>                throw new RuntimeException(ex);<br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span> catch (ClassNotFoundException e) <span class="hljs-punctuation">&#123;</span><br>            throw new RuntimeException(e);<br>        <span class="hljs-punctuation">&#125;</span> finally <span class="hljs-punctuation">&#123;</span><br>            closeResource(connection);<br>        <span class="hljs-punctuation">&#125;</span><br>        return result;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    private void closeResource(Connection connection) <span class="hljs-punctuation">&#123;</span><br>        if (connection != <span class="hljs-literal"><span class="hljs-keyword">null</span></span>) <span class="hljs-punctuation">&#123;</span><br>            try <span class="hljs-punctuation">&#123;</span><br>                connection.close();<br>            <span class="hljs-punctuation">&#125;</span> catch (SQLException e) <span class="hljs-punctuation">&#123;</span><br>                throw new RuntimeException(e);<br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><br>    public abstract T execute(Connection connection) throws SQLException;<br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>因为涉及到数据库操作，所以我们要先引入mysql的依赖：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">&lt;dependency&gt;<br>          &lt;groupId&gt;mysql&lt;/groupId&gt;<br>          &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;<br>          &lt;version&gt;<span class="hljs-number">8.0</span><span class="hljs-number">.27</span>&lt;/version&gt;<br>      &lt;/dependency&gt;<br></code></pre></td></tr></table></figure><h3 id="查询某个字段"><a href="#查询某个字段" class="headerlink" title="查询某个字段"></a>查询某个字段</h3><p>首先，我们修改DefaultMybatisSqlSession中，在该类中，执行我们的sql语句，其中，执行sql和对sql查询结果进行处理的内容，收敛在execute方法中。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.session;<br><br>import com.yang.mybatis.config.MybatisConfiguration;<br>import com.yang.mybatis.config.MybatisEnvironment;<br>import com.yang.mybatis.config.MybatisSqlStatement;<br>import com.yang.mybatis.proxy.MapperProxyFactory;<br><br>import java.sql.Connection;<br>import java.sql.PreparedStatement;<br>import java.sql.ResultSet;<br>import java.sql.SQLException;<br>import java.util.ArrayList;<br>import java.util.List;<br>import java.util.Map;<br><br><br>public class DefaultMybatisSqlSession implements IMybatisSqlSession <span class="hljs-punctuation">&#123;</span><br>    private MapperProxyFactory mapperProxyFactory;<br>    private MybatisConfiguration mybatisConfiguration;<br><br>    public DefaultMybatisSqlSession(MapperProxyFactory mapperProxyFactory) <span class="hljs-punctuation">&#123;</span><br>        this.mapperProxyFactory = mapperProxyFactory;<br>        this.mybatisConfiguration = mapperProxyFactory.getMybatisConfiguration();<br>    <span class="hljs-punctuation">&#125;</span><br><br>    @Override<br>    public &lt;T&gt; T execute(String method<span class="hljs-punctuation">,</span> Object parameter) <span class="hljs-punctuation">&#123;</span><br>        Map&lt;String<span class="hljs-punctuation">,</span> MybatisSqlStatement&gt; mapperMethod2SqlStatementsMap = mapperProxyFactory.getMybatisConfiguration().getMapperMethod2SqlStatementsMap();<br>        MybatisSqlStatement mybatisSqlStatement = mapperMethod2SqlStatementsMap.get(method);<br><br><br>        MybatisEnvironment defaultMybatisEnvironment = this.mybatisConfiguration.getDefaultMybatisEnvironment();<br><br>        return new TransactionInvoke&lt;T&gt;() <span class="hljs-punctuation">&#123;</span><br>            @Override<br>            public T execute(Connection connection) throws SQLException <span class="hljs-punctuation">&#123;</span><br>                String rawSql = mybatisSqlStatement.getSql();<br>                List&lt;String&gt; parameterNameList = new ArrayList&lt;&gt;();<br>                String sql = extractRawSql(rawSql<span class="hljs-punctuation">,</span> parameterNameList);<br>                Object<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> parameters = (Object<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>) parameter;<br>                PreparedStatement preparedStatement = connection.prepareStatement(sql);<br>                if (parameterNameList.size() != parameters.length) <span class="hljs-punctuation">&#123;</span><br>                    throw new RuntimeException(<span class="hljs-string">&quot;SQL语句参数个数不匹配====&quot;</span>);<br>                <span class="hljs-punctuation">&#125;</span><br>                int index = <span class="hljs-number">1</span>;<br>                for (Object o <span class="hljs-punctuation">:</span> parameters) <span class="hljs-punctuation">&#123;</span><br>                    preparedStatement.setObject(index ++<span class="hljs-punctuation">,</span> o);<br>                <span class="hljs-punctuation">&#125;</span><br>                ResultSet resultSet = preparedStatement.executeQuery();<br><br>                T result = <span class="hljs-literal"><span class="hljs-keyword">null</span></span>;<br>                if (resultSet.next()) <span class="hljs-punctuation">&#123;</span><br>                    result = (T) resultSet.getObject(<span class="hljs-number">1</span>);<br>                <span class="hljs-punctuation">&#125;</span><br><br>                resultSet.close();<br>                return result;<br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span>.invoke(defaultMybatisEnvironment.getMybatisDataSource());<br>    <span class="hljs-punctuation">&#125;</span><br><br>    private String extractRawSql(String rawSql<span class="hljs-punctuation">,</span> List&lt;String&gt; parameterNameList) <span class="hljs-punctuation">&#123;</span><br>        StringBuilder sqlBuilder = new StringBuilder();<br>        int start = <span class="hljs-number">0</span>;<br>        int end = <span class="hljs-number">-1</span>;<br>        while ((end = rawSql.indexOf(<span class="hljs-string">&quot;#&quot;</span><span class="hljs-punctuation">,</span> start)) != <span class="hljs-number">-1</span>) <span class="hljs-punctuation">&#123;</span><br>            sqlBuilder.append(rawSql.substring(start<span class="hljs-punctuation">,</span> end - <span class="hljs-number">1</span>))<br>                    .append(<span class="hljs-string">&quot; ? &quot;</span>);<br>            int parameterStart = end + <span class="hljs-number">2</span>;<br>            int parameterEnd = rawSql.indexOf(<span class="hljs-string">&quot;&#125;&quot;</span><span class="hljs-punctuation">,</span> parameterStart);<br>            parameterNameList.add(rawSql.substring(parameterStart<span class="hljs-punctuation">,</span> parameterEnd));<br>            start = parameterEnd + <span class="hljs-number">1</span>;<br>        <span class="hljs-punctuation">&#125;</span><br>        sqlBuilder.append(rawSql.substring(start));<br><br>        return sqlBuilder.toString();<br>    <span class="hljs-punctuation">&#125;</span><br><br><br>    @Override<br>    public &lt;T&gt; T getMapper(Class&lt;T&gt; type) <span class="hljs-punctuation">&#123;</span><br>        return (T) mapperProxyFactory.newInstance(type<span class="hljs-punctuation">,</span> this);<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>最后我们添加测试方法，进行测试：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs json">String configPath = <span class="hljs-string">&quot;mybatis-config.xml&quot;</span>;<br>        IMybatisSqlSessionFactory mybatisSqlSessionFactory = new MybatisSqlSessionFactoryBuilder()<br>                .setMybatisMapperParser(new XmlMybatisMapperParser())<br>                .setMybatisConfigurationParser(new XmlMybatisConfigurationParser())<br>                .setConfigPath(configPath)<br>                .buildSqlSessionFactory();<br><br>        IMybatisSqlSession mybatisSqlSession = mybatisSqlSessionFactory.openSession();<br><br>        IUserMapper userMapper = mybatisSqlSession.getMapper(IUserMapper.class);<br>        System.out.println(userMapper.queryUserName(<span class="hljs-number">1</span>));<br></code></pre></td></tr></table></figure><p>测试结果如下：</p><img src="/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E2%80%94%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9B%E8%A1%8C%E7%AE%80%E5%8D%95%E6%9F%A5%E8%AF%A2/1.png" class=""><h3 id="查询结果封装为对象"><a href="#查询结果封装为对象" class="headerlink" title="查询结果封装为对象"></a>查询结果封装为对象</h3><h4 id="基于resultType"><a href="#基于resultType" class="headerlink" title="基于resultType"></a>基于resultType</h4><p>上述的操作，只对查询某个字段有效，假设我们要获取的是一个对象，比如我们在UserMapper添加如下方法：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json">User queryUserById(Integer id);<br><br></code></pre></td></tr></table></figure><p>其中，User类内容如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs json"><br>public class User implements Serializable <span class="hljs-punctuation">&#123;</span><br>    private Integer id;<br><br>    private String userName;<br><br>    private String password;<br><br>    private Integer age;<br><br>    private LocalDateTime createTime;<br><br>    public Integer getId() <span class="hljs-punctuation">&#123;</span><br>        return id;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setId(Integer id) <span class="hljs-punctuation">&#123;</span><br>        this.id = id;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public String getUserName() <span class="hljs-punctuation">&#123;</span><br>        return userName;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setUserName(String userName) <span class="hljs-punctuation">&#123;</span><br>        this.userName = userName;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public String getPassword() <span class="hljs-punctuation">&#123;</span><br>        return password;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setPassword(String password) <span class="hljs-punctuation">&#123;</span><br>        this.password = password;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public Integer getAge() <span class="hljs-punctuation">&#123;</span><br>        return age;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setAge(Integer age) <span class="hljs-punctuation">&#123;</span><br>        this.age = age;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public LocalDateTime getCreateTime() <span class="hljs-punctuation">&#123;</span><br>        return createTime;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setCreateTime(LocalDateTime createTime) <span class="hljs-punctuation">&#123;</span><br>        this.createTime = createTime;<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>该方法对于的mapperxml查询块如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">&lt;select id=<span class="hljs-string">&quot;queryUserById&quot;</span> resultType=<span class="hljs-string">&quot;com.yang.mybatis.test.User&quot;</span>&gt;<br>      select * from user<br>      where id = #<span class="hljs-punctuation">&#123;</span>id<span class="hljs-punctuation">&#125;</span><br>  &lt;/select&gt;<br></code></pre></td></tr></table></figure><p>此时，当我们使用JDBC执行sql，获取ResultSet后，我们可以根据resultType的类型，通过反射的方式，来创建对应的结果，并将属性填充到对象中。<br>首先，我们修改MybatisSqlStatement，添加resultType字段</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.config;<br><br>import java.io.Serializable;<br><br>public class MybatisSqlStatement implements Serializable <span class="hljs-punctuation">&#123;</span><br>    private String namespace;<br><br>    private String id;<br><br>    private String sql;<br>    <br>    private String resultType;<br><br>    public String getNamespace() <span class="hljs-punctuation">&#123;</span><br>        return namespace;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setNamespace(String namespace) <span class="hljs-punctuation">&#123;</span><br>        this.namespace = namespace;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public String getId() <span class="hljs-punctuation">&#123;</span><br>        return id;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setId(String id) <span class="hljs-punctuation">&#123;</span><br>        this.id = id;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public String getSql() <span class="hljs-punctuation">&#123;</span><br>        return sql;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setSql(String sql) <span class="hljs-punctuation">&#123;</span><br>        this.sql = sql;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public String getResultType() <span class="hljs-punctuation">&#123;</span><br>        return resultType;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setResultType(String resultType) <span class="hljs-punctuation">&#123;</span><br>        this.resultType = resultType;<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>然后修改XmlMybatisMapperParser的parseStatement方法，设置对应的resultType值</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs json">private void parseStatement(List&lt;MybatisSqlStatement&gt; mybatisSqlStatements<span class="hljs-punctuation">,</span> List&lt;Element&gt; elements<span class="hljs-punctuation">,</span> Element root) <span class="hljs-punctuation">&#123;</span><br>        if (elements == <span class="hljs-literal"><span class="hljs-keyword">null</span></span> || elements.isEmpty()) <span class="hljs-punctuation">&#123;</span><br>            return;<br>        <span class="hljs-punctuation">&#125;</span><br>        String namespace = root.attributeValue(<span class="hljs-string">&quot;namespace&quot;</span>);<br>        for (Element element <span class="hljs-punctuation">:</span> elements) <span class="hljs-punctuation">&#123;</span><br>            String id = element.attributeValue(<span class="hljs-string">&quot;id&quot;</span>);<br>            String resultType = element.attributeValue(<span class="hljs-string">&quot;resultType&quot;</span>);<br>            String sql = element.getText().trim();<br><br>            MybatisSqlStatement mybatisSqlStatement = new MybatisSqlStatement();<br>            mybatisSqlStatement.setNamespace(namespace);<br>            mybatisSqlStatement.setId(id);<br>            mybatisSqlStatement.setSql(sql);<br>            mybatisSqlStatement.setResultType(resultType);<br><br>            mybatisSqlStatements.add(mybatisSqlStatement);<br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>最后修改DefaultMybatisSqlSession:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.session;<br><br>import com.google.common.base.CaseFormat;<br>import com.yang.mybatis.config.MybatisConfiguration;<br>import com.yang.mybatis.config.MybatisEnvironment;<br>import com.yang.mybatis.config.MybatisSqlStatement;<br>import com.yang.mybatis.proxy.MapperProxyFactory;<br><br>import java.lang.reflect.Field;<br>import java.sql.Connection;<br>import java.sql.PreparedStatement;<br>import java.sql.ResultSet;<br>import java.sql.SQLException;<br>import java.util.ArrayList;<br>import java.util.HashMap;<br>import java.util.List;<br>import java.util.Map;<br><br><br>public class DefaultMybatisSqlSession implements IMybatisSqlSession <span class="hljs-punctuation">&#123;</span><br>    private MapperProxyFactory mapperProxyFactory;<br>    private MybatisConfiguration mybatisConfiguration;<br><br>    public DefaultMybatisSqlSession(MapperProxyFactory mapperProxyFactory) <span class="hljs-punctuation">&#123;</span><br>        this.mapperProxyFactory = mapperProxyFactory;<br>        this.mybatisConfiguration = mapperProxyFactory.getMybatisConfiguration();<br>    <span class="hljs-punctuation">&#125;</span><br><br>    @Override<br>    public &lt;T&gt; T execute(String method<span class="hljs-punctuation">,</span> Object parameter) <span class="hljs-punctuation">&#123;</span><br>        Map&lt;String<span class="hljs-punctuation">,</span> MybatisSqlStatement&gt; mapperMethod2SqlStatementsMap = mapperProxyFactory.getMybatisConfiguration().getMapperMethod2SqlStatementsMap();<br>        MybatisSqlStatement mybatisSqlStatement = mapperMethod2SqlStatementsMap.get(method);<br><br><br>        MybatisEnvironment defaultMybatisEnvironment = this.mybatisConfiguration.getDefaultMybatisEnvironment();<br><br>        return new TransactionInvoke&lt;T&gt;() <span class="hljs-punctuation">&#123;</span><br>            @Override<br>            public T execute(Connection connection) throws SQLException <span class="hljs-punctuation">&#123;</span><br>                String rawSql = mybatisSqlStatement.getSql();<br>                List&lt;String&gt; parameterNameList = new ArrayList&lt;&gt;();<br>                String sql = extractRawSql(rawSql<span class="hljs-punctuation">,</span> parameterNameList);<br>                Object<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> parameters = (Object<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>) parameter;<br>                PreparedStatement preparedStatement = connection.prepareStatement(sql);<br>                if (parameterNameList.size() != parameters.length) <span class="hljs-punctuation">&#123;</span><br>                    throw new RuntimeException(<span class="hljs-string">&quot;SQL语句参数个数不匹配====&quot;</span>);<br>                <span class="hljs-punctuation">&#125;</span><br>                int index = <span class="hljs-number">1</span>;<br>                for (Object o <span class="hljs-punctuation">:</span> parameters) <span class="hljs-punctuation">&#123;</span><br>                    preparedStatement.setObject(index ++<span class="hljs-punctuation">,</span> o);<br>                <span class="hljs-punctuation">&#125;</span><br>                ResultSet resultSet = preparedStatement.executeQuery();<br><br>                T result = parseResult(resultSet<span class="hljs-punctuation">,</span> mybatisSqlStatement);<br>                resultSet.close();<br>                return result;<br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span>.invoke(defaultMybatisEnvironment.getMybatisDataSource());<br>    <span class="hljs-punctuation">&#125;</span><br><br>    private &lt;T&gt; T parseResult(ResultSet resultSet<span class="hljs-punctuation">,</span> MybatisSqlStatement mybatisSqlStatement) throws SQLException <span class="hljs-punctuation">&#123;</span><br>        String resultType = mybatisSqlStatement.getResultType();<br>        if (resultType == <span class="hljs-literal"><span class="hljs-keyword">null</span></span> || resultType.isEmpty()) <span class="hljs-punctuation">&#123;</span><br>            return (T) resultSet.getObject(<span class="hljs-number">1</span>);<br>        <span class="hljs-punctuation">&#125;</span><br><br>        try <span class="hljs-punctuation">&#123;</span><br>            Class&lt;?&gt; aClass = Class.forName(resultType);<br>            Field<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> fields = aClass.getDeclaredFields();<br>            Map&lt;String<span class="hljs-punctuation">,</span> String&gt; fieldName2ColumnNameMap = new HashMap&lt;&gt;();<br>            Map&lt;String<span class="hljs-punctuation">,</span> Field&gt; fieldName2FieldMap = new HashMap&lt;&gt;();<br>            for (Field field <span class="hljs-punctuation">:</span> fields) <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-comment">// 驼峰命名转下划线</span><br>                String columnName = CaseFormat.LOWER_CAMEL.to(CaseFormat.LOWER_UNDERSCORE<span class="hljs-punctuation">,</span> field.getName());<br>                fieldName2ColumnNameMap.put(field.getName()<span class="hljs-punctuation">,</span> columnName);<br>                fieldName2FieldMap.put(field.getName()<span class="hljs-punctuation">,</span> field);<br>            <span class="hljs-punctuation">&#125;</span><br><br>            Object result = aClass.newInstance();<br>            while (resultSet.next()) <span class="hljs-punctuation">&#123;</span><br>                for (Map.Entry&lt;String<span class="hljs-punctuation">,</span> String&gt; entry <span class="hljs-punctuation">:</span> fieldName2ColumnNameMap.entrySet()) <span class="hljs-punctuation">&#123;</span><br>                    String fieldName = entry.getKey();<br>                    String columnName = entry.getValue();<br><br>                    Object columnValue = resultSet.getObject(columnName);<br>                    Field field = fieldName2FieldMap.get(fieldName);<br>                    field.setAccessible(<span class="hljs-literal"><span class="hljs-keyword">true</span></span>);<br>                    field.set(result<span class="hljs-punctuation">,</span> columnValue);<br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>            return (T)result;<br>        <span class="hljs-punctuation">&#125;</span> catch (ClassNotFoundException e) <span class="hljs-punctuation">&#123;</span><br>            throw new RuntimeException(e);<br>        <span class="hljs-punctuation">&#125;</span> catch (InstantiationException | IllegalAccessException e) <span class="hljs-punctuation">&#123;</span><br>            throw new RuntimeException(e);<br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><br>    private String extractRawSql(String rawSql<span class="hljs-punctuation">,</span> List&lt;String&gt; parameterNameList) <span class="hljs-punctuation">&#123;</span><br>        StringBuilder sqlBuilder = new StringBuilder();<br>        int start = <span class="hljs-number">0</span>;<br>        int end = <span class="hljs-number">-1</span>;<br>        while ((end = rawSql.indexOf(<span class="hljs-string">&quot;#&quot;</span><span class="hljs-punctuation">,</span> start)) != <span class="hljs-number">-1</span>) <span class="hljs-punctuation">&#123;</span><br>            sqlBuilder.append(rawSql.substring(start<span class="hljs-punctuation">,</span> end - <span class="hljs-number">1</span>))<br>                    .append(<span class="hljs-string">&quot; ? &quot;</span>);<br>            int parameterStart = end + <span class="hljs-number">2</span>;<br>            int parameterEnd = rawSql.indexOf(<span class="hljs-string">&quot;&#125;&quot;</span><span class="hljs-punctuation">,</span> parameterStart);<br>            parameterNameList.add(rawSql.substring(parameterStart<span class="hljs-punctuation">,</span> parameterEnd));<br>            start = parameterEnd + <span class="hljs-number">1</span>;<br>        <span class="hljs-punctuation">&#125;</span><br>        sqlBuilder.append(rawSql.substring(start));<br><br>        return sqlBuilder.toString();<br>    <span class="hljs-punctuation">&#125;</span><br><br><br>    @Override<br>    public &lt;T&gt; T getMapper(Class&lt;T&gt; type) <span class="hljs-punctuation">&#123;</span><br>        return (T) mapperProxyFactory.newInstance(type<span class="hljs-punctuation">,</span> this);<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>这里将和结果相关的解析，抽取到parseResult方法中，此外，因为数据库是字段是下划线格式，类的属性是驼峰格式，因此，这里引入了Guava依赖，方便使用它的CaseFormat类进行格式转化。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">&lt;dependency&gt;<br>          &lt;groupId&gt;com.google.guava&lt;/groupId&gt;<br>          &lt;artifactId&gt;guava&lt;/artifactId&gt;<br>          &lt;version&gt;<span class="hljs-number">31.1</span>-jre&lt;/version&gt;<br>      &lt;/dependency&gt;<br></code></pre></td></tr></table></figure><p>最后，我们添加测试方法，进行测试：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs json">public static void main(String<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> args) <span class="hljs-punctuation">&#123;</span><br>       String configPath = <span class="hljs-string">&quot;mybatis-config.xml&quot;</span>;<br>       IMybatisSqlSessionFactory mybatisSqlSessionFactory = new MybatisSqlSessionFactoryBuilder()<br>               .setMybatisMapperParser(new XmlMybatisMapperParser())<br>               .setMybatisConfigurationParser(new XmlMybatisConfigurationParser())<br>               .setConfigPath(configPath)<br>               .buildSqlSessionFactory();<br><br>       IMybatisSqlSession mybatisSqlSession = mybatisSqlSessionFactory.openSession();<br><br>       IUserMapper userMapper = mybatisSqlSession.getMapper(IUserMapper.class);<br>       User user = userMapper.queryUserById(<span class="hljs-number">1</span>);<br>       System.out.println(user);<br>       System.out.println(user.getId());<br>       System.out.println(user.getUserName());<br>       System.out.println(user.getPassword());<br>       System.out.println(user.getAge());<br>       System.out.println(user.getCreateTime());<br>   <span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>测试结果如下：</p><img src="/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E2%80%94%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9B%E8%A1%8C%E7%AE%80%E5%8D%95%E6%9F%A5%E8%AF%A2/2.png" class=""><h4 id="基于resultMap"><a href="#基于resultMap" class="headerlink" title="基于resultMap"></a>基于resultMap</h4><p>上面的方式，是基于resultType来进行解析的，但是在mybatis中，还有另外一种将sql字段和类对象属性映射的方式，就是resultMap。<br>首先，我们创建一个IdUserNameVO类</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.test;<br><br>import java.io.Serializable;<br><br>public class IdUserNameVO implements Serializable <span class="hljs-punctuation">&#123;</span><br>    private Integer id;<br><br>    private String userName;<br><br>    public Integer getId() <span class="hljs-punctuation">&#123;</span><br>        return id;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setId(Integer id) <span class="hljs-punctuation">&#123;</span><br>        this.id = id;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public String getUserName() <span class="hljs-punctuation">&#123;</span><br>        return userName;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setUserName(String userName) <span class="hljs-punctuation">&#123;</span><br>        this.userName = userName;<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>在IUserMapper中，我们添加下列方法：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json">IdUserNameVO queryIdUserNameVOById(Integer id);<br><br></code></pre></td></tr></table></figure><p>修改UserMapper.xml，加上queryIdUserNameVOById的sql语句和对应的resultMap</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs json">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;<br>&lt;!DOCTYPE mapper<br>        PUBLIC <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span><br>        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;<br><br><br>&lt;mapper namespace=<span class="hljs-string">&quot;com.yang.mybatis.test.IUserMapper&quot;</span>&gt;<br>    &lt;resultMap id=<span class="hljs-string">&quot;idUserName&quot;</span> type=<span class="hljs-string">&quot;com.yang.mybatis.test.IdUserNameVO&quot;</span>&gt;<br>        &lt;id property=<span class="hljs-string">&quot;id&quot;</span> column=<span class="hljs-string">&quot;id&quot;</span> javaType=<span class="hljs-string">&quot;Integer&quot;</span> jdbcType=<span class="hljs-string">&quot;int&quot;</span>/&gt;<br>        &lt;result property=<span class="hljs-string">&quot;userName&quot;</span> column=<span class="hljs-string">&quot;user_name&quot;</span> javaType=<span class="hljs-string">&quot;String&quot;</span> jdbcType=<span class="hljs-string">&quot;VARCHAR&quot;</span>/&gt;<br>    &lt;/resultMap&gt;<br><br>    &lt;select id=<span class="hljs-string">&quot;queryUserName&quot;</span>&gt;<br>        select user_name from user where id = #<span class="hljs-punctuation">&#123;</span>id<span class="hljs-punctuation">&#125;</span><br>    &lt;/select&gt;<br>    &lt;select id=<span class="hljs-string">&quot;queryUserAge&quot;</span>&gt;<br>        select age from user where id = #<span class="hljs-punctuation">&#123;</span>id<span class="hljs-punctuation">&#125;</span><br>    &lt;/select&gt;<br>    &lt;select id=<span class="hljs-string">&quot;queryUserById&quot;</span> resultType=<span class="hljs-string">&quot;com.yang.mybatis.test.User&quot;</span>&gt;<br>        select * from user<br>        where id = #<span class="hljs-punctuation">&#123;</span>id<span class="hljs-punctuation">&#125;</span><br>    &lt;/select&gt;<br>    &lt;select id=<span class="hljs-string">&quot;queryIdUserNameVOById&quot;</span> resultMap=<span class="hljs-string">&quot;idUserName&quot;</span>&gt;<br>        select id<span class="hljs-punctuation">,</span> user_name<br>        from user<br>        where id = #<span class="hljs-punctuation">&#123;</span>id<span class="hljs-punctuation">&#125;</span><br>    &lt;/select&gt;<br>&lt;/mapper&gt;<br></code></pre></td></tr></table></figure><p>之前，我们在解析每一个mapper.xml文件时，解析出来的结果，是一个MybatisSqlStatement列表，但是这种方式还不能更好的表达一个mapper.xml中包含的信息，因此，我们修改代码，现在对于每一个mapper.xml文件，解析出来的结果位MybatisMapperXmlConfiguration类，该类定义如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.config;<br><br>import java.io.Serializable;<br>import java.util.ArrayList;<br>import java.util.HashMap;<br>import java.util.List;<br>import java.util.Map;<br><br>public class MybatisMapperXmlConfiguration implements Serializable <span class="hljs-punctuation">&#123;</span><br>    private String mapperName;<br><br>    private List&lt;MybatisSqlStatement&gt; mybatisSqlStatements = new ArrayList&lt;&gt;();<br><br>    private Map&lt;String<span class="hljs-punctuation">,</span> MybatisResultMap&gt; mybatisResultMaps = new HashMap&lt;&gt;();<br><br><br>    public List&lt;MybatisSqlStatement&gt; getMybatisSqlStatements() <span class="hljs-punctuation">&#123;</span><br>        return mybatisSqlStatements;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setMybatisSqlStatements(List&lt;MybatisSqlStatement&gt; mybatisSqlStatements) <span class="hljs-punctuation">&#123;</span><br>        this.mybatisSqlStatements = mybatisSqlStatements;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public List&lt;MybatisResultMap&gt; getMybatisResultMaps() <span class="hljs-punctuation">&#123;</span><br>        return new ArrayList&lt;&gt;(mybatisResultMaps.values());<br>    <span class="hljs-punctuation">&#125;</span><br><br><br>    public void addMybatisSqlStatement(MybatisSqlStatement mybatisSqlStatement) <span class="hljs-punctuation">&#123;</span><br>        this.mybatisSqlStatements.add(mybatisSqlStatement);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void addMybatisResultMap(MybatisResultMap mybatisResultMap) <span class="hljs-punctuation">&#123;</span><br>        this.mybatisResultMaps.put(mybatisResultMap.getId()<span class="hljs-punctuation">,</span> mybatisResultMap);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisResultMap getMybatisResultMap(String id) <span class="hljs-punctuation">&#123;</span><br>        return this.mybatisResultMaps.get(id);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public String getMapperName() <span class="hljs-punctuation">&#123;</span><br>        return mapperName;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setMapperName(String mapperName) <span class="hljs-punctuation">&#123;</span><br>        this.mapperName = mapperName;<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>MybatisResultMap的定义如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.config;<br><br>import java.io.Serializable;<br>import java.util.ArrayList;<br>import java.util.List;<br><br>public class MybatisResultMap implements Serializable <span class="hljs-punctuation">&#123;</span><br>    private String id;<br>    private String type;<br>    private MybatisResultMapProperty idProperty;<br><br>    private List&lt;MybatisResultMapProperty&gt; properties = new ArrayList&lt;&gt;();<br><br>    public void addMybatisResultMapProperty(MybatisResultMapProperty mybatisResultMapProperty) <span class="hljs-punctuation">&#123;</span><br>        this.properties.add(mybatisResultMapProperty);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public String getId() <span class="hljs-punctuation">&#123;</span><br>        return id;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setId(String id) <span class="hljs-punctuation">&#123;</span><br>        this.id = id;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public String getType() <span class="hljs-punctuation">&#123;</span><br>        return type;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setType(String type) <span class="hljs-punctuation">&#123;</span><br>        this.type = type;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisResultMapProperty getIdProperty() <span class="hljs-punctuation">&#123;</span><br>        return idProperty;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setIdProperty(MybatisResultMapProperty idProperty) <span class="hljs-punctuation">&#123;</span><br>        this.idProperty = idProperty;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public List&lt;MybatisResultMapProperty&gt; getProperties() <span class="hljs-punctuation">&#123;</span><br>        return this.properties;<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>MybatisResultMapProperty类定义如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.config;<br><br>import java.io.Serializable;<br><br>public class MybatisResultMapProperty implements Serializable <span class="hljs-punctuation">&#123;</span><br>    private String property;<br><br>    private String column;<br><br>    private String javaType;<br><br>    private String jdbcType;<br><br>   ... 省略getter和setter<br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>我们修改IMybatisMapperParser接口：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.config.parser;<br><br>import com.yang.mybatis.config.MybatisMapperXmlConfiguration;<br><br>public interface IMybatisMapperParser <span class="hljs-punctuation">&#123;</span><br>    MybatisMapperXmlConfiguration parseMapper(String path);<br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>修改MybatisStatement，加上resultMap属性：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.config;<br><br>import java.io.Serializable;<br><br>public class MybatisSqlStatement implements Serializable <span class="hljs-punctuation">&#123;</span><br>    private String namespace;<br><br>    private String id;<br><br>    private String sql;<br><br>    private String resultType;<br><br>    private String resultMap;<br><br>    public String getNamespace() <span class="hljs-punctuation">&#123;</span><br>        return namespace;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setNamespace(String namespace) <span class="hljs-punctuation">&#123;</span><br>        this.namespace = namespace;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public String getId() <span class="hljs-punctuation">&#123;</span><br>        return id;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setId(String id) <span class="hljs-punctuation">&#123;</span><br>        this.id = id;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public String getSql() <span class="hljs-punctuation">&#123;</span><br>        return sql;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setSql(String sql) <span class="hljs-punctuation">&#123;</span><br>        this.sql = sql;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public String getResultType() <span class="hljs-punctuation">&#123;</span><br>        return resultType;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setResultType(String resultType) <span class="hljs-punctuation">&#123;</span><br>        this.resultType = resultType;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public String getResultMap() <span class="hljs-punctuation">&#123;</span><br>        return resultMap;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setResultMap(String resultMap) <span class="hljs-punctuation">&#123;</span><br>        this.resultMap = resultMap;<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>修改其IMybatisMapperParser具体实现：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.config.parser;<br><br>import com.yang.mybatis.config.MybatisMapperXmlConfiguration;<br>import com.yang.mybatis.config.MybatisResultMap;<br>import com.yang.mybatis.config.MybatisResultMapProperty;<br>import com.yang.mybatis.config.MybatisSqlStatement;<br>import org.dom4j.Document;<br>import org.dom4j.DocumentException;<br>import org.dom4j.Element;<br>import org.dom4j.io.SAXReader;<br><br>import java.io.InputStream;<br>import java.util.HashSet;<br>import java.util.List;<br>import java.util.Set;<br><br>public class XmlMybatisMapperParser implements IMybatisMapperParser <span class="hljs-punctuation">&#123;</span><br>    private final static Set&lt;String&gt; tagSet = new HashSet&lt;&gt;();<br><br>    private final static Set&lt;String&gt; resultMapTagSet = new HashSet&lt;&gt;();<br><br>    static <span class="hljs-punctuation">&#123;</span><br>        tagSet.add(<span class="hljs-string">&quot;select&quot;</span>);<br>        tagSet.add(<span class="hljs-string">&quot;insert&quot;</span>);<br>        tagSet.add(<span class="hljs-string">&quot;update&quot;</span>);<br>        tagSet.add(<span class="hljs-string">&quot;delete&quot;</span>);<br>        tagSet.add(<span class="hljs-string">&quot;SELECT&quot;</span>);<br>        tagSet.add(<span class="hljs-string">&quot;INSERT&quot;</span>);<br>        tagSet.add(<span class="hljs-string">&quot;UPDATE&quot;</span>);<br>        tagSet.add(<span class="hljs-string">&quot;DELETE&quot;</span>);<br><br>        resultMapTagSet.add(<span class="hljs-string">&quot;resultMap&quot;</span>);<br>        resultMapTagSet.add(<span class="hljs-string">&quot;ResultMap&quot;</span>);<br>    <span class="hljs-punctuation">&#125;</span><br>    @Override<br>    public MybatisMapperXmlConfiguration parseMapper(String path) <span class="hljs-punctuation">&#123;</span><br>        MybatisMapperXmlConfiguration mybatisMapperXmlConfiguration = new MybatisMapperXmlConfiguration();<br>        try <span class="hljs-punctuation">&#123;</span><br>            InputStream inputStream = this.getClass().getClassLoader().getResourceAsStream(path);<br>            SAXReader saxReader = new SAXReader();<br>            Document document = saxReader.read(inputStream);<br>            Element root = document.getRootElement();<br><br>            parseMapperName(mybatisMapperXmlConfiguration<span class="hljs-punctuation">,</span> root);<br>            for (String tag <span class="hljs-punctuation">:</span> tagSet) <span class="hljs-punctuation">&#123;</span><br>                List&lt;Element&gt; elements = root.elements(tag);<br>                parseStatement(mybatisMapperXmlConfiguration<span class="hljs-punctuation">,</span> elements);<br>            <span class="hljs-punctuation">&#125;</span><br>            for (String tag<span class="hljs-punctuation">:</span> resultMapTagSet) <span class="hljs-punctuation">&#123;</span><br>                List&lt;Element&gt; elements = root.elements(tag);<br>                parseResultMap(mybatisMapperXmlConfiguration<span class="hljs-punctuation">,</span> elements);<br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span> catch (DocumentException e) <span class="hljs-punctuation">&#123;</span><br>            e.printStackTrace();<br>        <span class="hljs-punctuation">&#125;</span><br>        return mybatisMapperXmlConfiguration;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    private void parseMapperName(MybatisMapperXmlConfiguration mybatisMapperXmlConfiguration<span class="hljs-punctuation">,</span> Element root) <span class="hljs-punctuation">&#123;</span><br>        String mapperName = root.attributeValue(<span class="hljs-string">&quot;namespace&quot;</span>);<br>        mybatisMapperXmlConfiguration.setMapperName(mapperName);<br><br>    <span class="hljs-punctuation">&#125;</span><br><br>    private void parseResultMap(MybatisMapperXmlConfiguration mybatisMapperXmlConfiguration<span class="hljs-punctuation">,</span> List&lt;Element&gt; elements) <span class="hljs-punctuation">&#123;</span><br>        if (elements == <span class="hljs-literal"><span class="hljs-keyword">null</span></span> || elements.isEmpty()) <span class="hljs-punctuation">&#123;</span><br>            return;<br>        <span class="hljs-punctuation">&#125;</span><br>        for (Element element <span class="hljs-punctuation">:</span> elements) <span class="hljs-punctuation">&#123;</span><br>            String id = element.attributeValue(<span class="hljs-string">&quot;id&quot;</span>);<br>            String type = element.attributeValue(<span class="hljs-string">&quot;type&quot;</span>);<br><br>            MybatisResultMap mybatisResultMap = new MybatisResultMap();<br>            mybatisResultMap.setId(id);<br>            mybatisResultMap.setType(type);<br><br>            Element idElement = element.element(<span class="hljs-string">&quot;id&quot;</span>);<br>            if (idElement != <span class="hljs-literal"><span class="hljs-keyword">null</span></span>) <span class="hljs-punctuation">&#123;</span><br>                MybatisResultMapProperty mybatisResultMapProperty = buildMybatisResultMapProperty(idElement);<br>                mybatisResultMap.addMybatisResultMapProperty(mybatisResultMapProperty);<br>                mybatisResultMap.setIdProperty(mybatisResultMapProperty);<br>            <span class="hljs-punctuation">&#125;</span><br><br>            List&lt;Element&gt; resultList = element.elements(<span class="hljs-string">&quot;result&quot;</span>);<br>            for (Element resultElement <span class="hljs-punctuation">:</span> resultList) <span class="hljs-punctuation">&#123;</span><br>                MybatisResultMapProperty mybatisResultMapProperty = buildMybatisResultMapProperty(resultElement);<br>                mybatisResultMap.addMybatisResultMapProperty(mybatisResultMapProperty);<br>            <span class="hljs-punctuation">&#125;</span><br><br>            mybatisMapperXmlConfiguration.addMybatisResultMap(mybatisResultMap);<br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><br>    private MybatisResultMapProperty buildMybatisResultMapProperty(Element element) <span class="hljs-punctuation">&#123;</span><br>        MybatisResultMapProperty mybatisResultMapProperty = new MybatisResultMapProperty();<br>        String property = element.attributeValue(<span class="hljs-string">&quot;property&quot;</span>);<br>        String column = element.attributeValue(<span class="hljs-string">&quot;column&quot;</span>);<br>        String javaType = element.attributeValue(<span class="hljs-string">&quot;javaType&quot;</span>);<br>        String jdbcType = element.attributeValue(<span class="hljs-string">&quot;jdbcType&quot;</span>);<br>        mybatisResultMapProperty.setProperty(property);<br>        mybatisResultMapProperty.setColumn(column);<br>        mybatisResultMapProperty.setJavaType(javaType);<br>        mybatisResultMapProperty.setJdbcType(jdbcType);<br>        return mybatisResultMapProperty;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    private void parseStatement(MybatisMapperXmlConfiguration mybatisMapperXmlConfiguration<span class="hljs-punctuation">,</span> List&lt;Element&gt; elements) <span class="hljs-punctuation">&#123;</span><br>        if (elements == <span class="hljs-literal"><span class="hljs-keyword">null</span></span> || elements.isEmpty()) <span class="hljs-punctuation">&#123;</span><br>            return;<br>        <span class="hljs-punctuation">&#125;</span><br>        String namespace = mybatisMapperXmlConfiguration.getMapperName();<br>        for (Element element <span class="hljs-punctuation">:</span> elements) <span class="hljs-punctuation">&#123;</span><br>            String id = element.attributeValue(<span class="hljs-string">&quot;id&quot;</span>);<br>            String resultType = element.attributeValue(<span class="hljs-string">&quot;resultType&quot;</span>);<br>            String resultMap = element.attributeValue(<span class="hljs-string">&quot;resultMap&quot;</span>);<br>            String sql = element.getText().trim();<br><br>            MybatisSqlStatement mybatisSqlStatement = new MybatisSqlStatement();<br>            mybatisSqlStatement.setNamespace(namespace);<br>            mybatisSqlStatement.setId(id);<br>            mybatisSqlStatement.setSql(sql);<br>            mybatisSqlStatement.setResultType(resultType);<br>            mybatisSqlStatement.setResultMap(resultMap);<br><br>            mybatisMapperXmlConfiguration.addMybatisSqlStatement(mybatisSqlStatement);<br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>修改MybatisSqlSessionFactoryBuilder类：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.session;<br><br>import com.yang.mybatis.config.MybatisConfiguration;<br>import com.yang.mybatis.config.MybatisMapperXmlConfiguration;<br>import com.yang.mybatis.config.MybatisSqlStatement;<br>import com.yang.mybatis.config.parser.IMybatisConfigurationParser;<br>import com.yang.mybatis.config.parser.IMybatisMapperParser;<br>import com.yang.mybatis.mapper.MapperProxyFactory;<br><br>import java.util.List;<br><br>public class MybatisSqlSessionFactoryBuilder <span class="hljs-punctuation">&#123;</span><br>    private IMybatisConfigurationParser mybatisConfigurationParser;<br><br>    private IMybatisMapperParser mybatisMapperParser;<br><br>    private String configPath;<br><br>    public MybatisSqlSessionFactory buildSqlSessionFactory() <span class="hljs-punctuation">&#123;</span><br>        if (configPath == <span class="hljs-literal"><span class="hljs-keyword">null</span></span> || configPath.isEmpty()) <span class="hljs-punctuation">&#123;</span><br>            throw new RuntimeException(<span class="hljs-string">&quot;配置文件路径不合法==========&quot;</span>);<br>        <span class="hljs-punctuation">&#125;</span><br>        if (this.mybatisMapperParser == <span class="hljs-literal"><span class="hljs-keyword">null</span></span> || this.mybatisConfigurationParser == <span class="hljs-literal"><span class="hljs-keyword">null</span></span>) <span class="hljs-punctuation">&#123;</span><br>            throw new RuntimeException(<span class="hljs-string">&quot;缺少解析器=======&quot;</span>);<br>        <span class="hljs-punctuation">&#125;</span><br>        MybatisConfiguration mybatisConfiguration = mybatisConfigurationParser.parser(configPath);<br>        List&lt;String&gt; mapperPaths = mybatisConfiguration.getMapperPaths();<br>        for (String mapperPath <span class="hljs-punctuation">:</span> mapperPaths) <span class="hljs-punctuation">&#123;</span><br>            MybatisMapperXmlConfiguration mybatisMapperXmlConfiguration = this.mybatisMapperParser.parseMapper(mapperPath);<br>            List&lt;MybatisSqlStatement&gt; mybatisSqlStatements = mybatisMapperXmlConfiguration.getMybatisSqlStatements();<br>            for (MybatisSqlStatement mybatisSqlStatement <span class="hljs-punctuation">:</span> mybatisSqlStatements) <span class="hljs-punctuation">&#123;</span><br>                String mapperMethod = mybatisSqlStatement.getNamespace() + <span class="hljs-string">&quot;.&quot;</span> + mybatisSqlStatement.getId();<br>                mybatisConfiguration.putMapperMethod2MybatisSqlStatement(mapperMethod<span class="hljs-punctuation">,</span> mybatisSqlStatement);<br>            <span class="hljs-punctuation">&#125;</span><br>            mybatisConfiguration.putMapperXmlConfiguration(mybatisMapperXmlConfiguration.getMapperName()<span class="hljs-punctuation">,</span> mybatisMapperXmlConfiguration);<br>        <span class="hljs-punctuation">&#125;</span><br><br>        MapperProxyFactory mapperProxyFactory = new MapperProxyFactory(mybatisConfiguration);<br>        return new DefaultMybatisSqlSessionFactory(mapperProxyFactory);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisSqlSessionFactoryBuilder setConfigPath(String configPath) <span class="hljs-punctuation">&#123;</span><br>        this.configPath = configPath;<br>        return this;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisSqlSessionFactoryBuilder setMybatisConfigurationParser(IMybatisConfigurationParser iMybatisConfigurationParser) <span class="hljs-punctuation">&#123;</span><br>        this.mybatisConfigurationParser = iMybatisConfigurationParser;<br>        return this;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisSqlSessionFactoryBuilder setMybatisMapperParser(IMybatisMapperParser iMybatisMapperParser) <span class="hljs-punctuation">&#123;</span><br>        this.mybatisMapperParser = iMybatisMapperParser;<br>        return this;<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>之前对于结果的解析，我们都是在DefaultMybatisSqlSession类中进行的，但是现在我们发现，结果的类型逐渐变得多样性了，如果都放在DefaultMybatisSqlSession类中，会使这个类十分庞大，因此，我们将解析结果的职责， 提取到IMybatisResultParser类中，首先定义该接口：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.execute;<br><br>import com.yang.mybatis.execute.request.MybatisResultParserRequest;<br><br>import java.sql.SQLException;<br><br>public interface IMybatisResultParser <span class="hljs-punctuation">&#123;</span><br>    final static int ONE_COLUMNE = <span class="hljs-number">0</span>;<br>    final static int RESULT_TYPE = <span class="hljs-number">1</span>;<br>    final static int RESULT_MAP = <span class="hljs-number">2</span>;<br><br>    &lt;T&gt; T parseResult(MybatisResultParserRequest mybatisResultParserRequest) throws SQLException;<br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>MybatisResultParserRequest:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.execute.request;<br><br>import com.yang.mybatis.config.MybatisMapperXmlConfiguration;<br>import com.yang.mybatis.config.MybatisSqlStatement;<br><br>import java.io.Serializable;<br>import java.sql.ResultSet;<br><br>public class MybatisResultParserRequest implements Serializable <span class="hljs-punctuation">&#123;</span><br>    private ResultSet resultSet;<br>    private MybatisSqlStatement mybatisSqlStatement;<br>    private MybatisMapperXmlConfiguration mybatisMapperXmlConfiguration;<br><br>    public MybatisResultParserRequest() <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-punctuation">&#125;</span><br><br><br>    public ResultSet getResultSet() <span class="hljs-punctuation">&#123;</span><br>        return resultSet;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setResultSet(ResultSet resultSet) <span class="hljs-punctuation">&#123;</span><br>        this.resultSet = resultSet;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisSqlStatement getMybatisSqlStatement() <span class="hljs-punctuation">&#123;</span><br>        return mybatisSqlStatement;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setMybatisSqlStatement(MybatisSqlStatement mybatisSqlStatement) <span class="hljs-punctuation">&#123;</span><br>        this.mybatisSqlStatement = mybatisSqlStatement;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisMapperXmlConfiguration getMybatisMapperXmlConfiguration() <span class="hljs-punctuation">&#123;</span><br>        return mybatisMapperXmlConfiguration;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setMybatisMapperXmlConfiguration(MybatisMapperXmlConfiguration mybatisMapperXmlConfiguration) <span class="hljs-punctuation">&#123;</span><br>        this.mybatisMapperXmlConfiguration = mybatisMapperXmlConfiguration;<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>然后定义其具体实现：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.execute;<br><br>import com.google.common.base.CaseFormat;<br>import com.yang.mybatis.config.MybatisMapperXmlConfiguration;<br>import com.yang.mybatis.config.MybatisResultMap;<br>import com.yang.mybatis.config.MybatisResultMapProperty;<br>import com.yang.mybatis.config.MybatisSqlStatement;<br>import com.yang.mybatis.execute.request.MybatisResultParserRequest;<br>import org.apache.commons.lang3.StringUtils;<br><br>import java.lang.reflect.Field;<br>import java.sql.ResultSet;<br>import java.sql.SQLException;<br>import java.util.HashMap;<br>import java.util.Map;<br>import java.util.stream.Collectors;<br><br>public class DefaultMybatisResultParser implements IMybatisResultParser <span class="hljs-punctuation">&#123;</span><br>    @Override<br>    public &lt;T&gt; T parseResult(MybatisResultParserRequest mybatisResultParserRequest) throws SQLException <span class="hljs-punctuation">&#123;</span><br>        ResultSet resultSet = mybatisResultParserRequest.getResultSet();<br>        if (resultSet == <span class="hljs-literal"><span class="hljs-keyword">null</span></span>) <span class="hljs-punctuation">&#123;</span><br>            return <span class="hljs-literal"><span class="hljs-keyword">null</span></span>;<br>        <span class="hljs-punctuation">&#125;</span><br>        MybatisSqlStatement mybatisSqlStatement = mybatisResultParserRequest.getMybatisSqlStatement();<br>        MybatisMapperXmlConfiguration mybatisMapperXmlConfiguration = mybatisResultParserRequest.getMybatisMapperXmlConfiguration();<br>        int resultTypeCode = parseResultTypeCode(mybatisSqlStatement);<br>        switch (resultTypeCode) <span class="hljs-punctuation">&#123;</span><br>            case ONE_COLUMNE<span class="hljs-punctuation">:</span><br>                return parseResultOfOneColumn(resultSet<span class="hljs-punctuation">,</span> mybatisSqlStatement);<br>            case RESULT_TYPE<span class="hljs-punctuation">:</span><br>                return parseResultOfResultType(resultSet<span class="hljs-punctuation">,</span> mybatisSqlStatement);<br>        <span class="hljs-punctuation">&#125;</span><br>        return parseResultOfResultMap(resultSet<span class="hljs-punctuation">,</span> mybatisSqlStatement<span class="hljs-punctuation">,</span> mybatisMapperXmlConfiguration);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    private &lt;T&gt; T parseResultOfResultMap(ResultSet resultSet<span class="hljs-punctuation">,</span> MybatisSqlStatement mybatisSqlStatement<span class="hljs-punctuation">,</span><br>                                         MybatisMapperXmlConfiguration mybatisMapperXmlConfiguration) throws SQLException <span class="hljs-punctuation">&#123;</span><br>        String resultMap = mybatisSqlStatement.getResultMap();<br><br>        MybatisResultMap mybatisResultMap = mybatisMapperXmlConfiguration.getMybatisResultMap(resultMap);<br><br>        String classType = mybatisResultMap.getType();<br>        Map&lt;String<span class="hljs-punctuation">,</span> String&gt; fieldName2ColumnNameMap = mybatisResultMap.getProperties()<br>                .stream()<br>                .collect(Collectors.toMap(MybatisResultMapProperty<span class="hljs-punctuation">:</span><span class="hljs-punctuation">:</span>getProperty<span class="hljs-punctuation">,</span> MybatisResultMapProperty<span class="hljs-punctuation">:</span><span class="hljs-punctuation">:</span>getColumn));<br><br>        return parseResultOfClassAndFields(resultSet<span class="hljs-punctuation">,</span> classType<span class="hljs-punctuation">,</span> fieldName2ColumnNameMap);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    private &lt;T&gt; T parseResultOfResultType(ResultSet resultSet<span class="hljs-punctuation">,</span> MybatisSqlStatement mybatisSqlStatement) throws SQLException <span class="hljs-punctuation">&#123;</span><br>        String resultType = mybatisSqlStatement.getResultType();<br><br>        try <span class="hljs-punctuation">&#123;</span><br>            Class&lt;?&gt; aClass = Class.forName(resultType);<br>            Field<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> fields = aClass.getDeclaredFields();<br>            Map&lt;String<span class="hljs-punctuation">,</span> String&gt; fieldName2ColumnNameMap = new HashMap&lt;&gt;();<br>            for (Field field <span class="hljs-punctuation">:</span> fields) <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-comment">// 驼峰命名转下划线</span><br>                String columnName = CaseFormat.LOWER_CAMEL.to(CaseFormat.LOWER_UNDERSCORE<span class="hljs-punctuation">,</span> field.getName());<br>                fieldName2ColumnNameMap.put(field.getName()<span class="hljs-punctuation">,</span> columnName);<br>            <span class="hljs-punctuation">&#125;</span><br><br>            return parseResultOfClassAndFields(resultSet<span class="hljs-punctuation">,</span> resultType<span class="hljs-punctuation">,</span> fieldName2ColumnNameMap);<br>        <span class="hljs-punctuation">&#125;</span> catch (ClassNotFoundException e) <span class="hljs-punctuation">&#123;</span><br>            throw new RuntimeException(e);<br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><br>    private &lt;T&gt; T parseResultOfClassAndFields(ResultSet resultSet<span class="hljs-punctuation">,</span> String classType<span class="hljs-punctuation">,</span> Map&lt;String<span class="hljs-punctuation">,</span> String&gt; fieldName2ColumnNameMap ) throws SQLException <span class="hljs-punctuation">&#123;</span><br>        try <span class="hljs-punctuation">&#123;</span><br>            Class&lt;?&gt; aClass = Class.forName(classType);<br>            Field<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> fields = aClass.getDeclaredFields();<br><br>            Map&lt;String<span class="hljs-punctuation">,</span> Field&gt; fieldName2FieldMap = new HashMap&lt;&gt;();<br>            for (Field field <span class="hljs-punctuation">:</span> fields) <span class="hljs-punctuation">&#123;</span><br>                fieldName2FieldMap.put(field.getName()<span class="hljs-punctuation">,</span> field);<br>            <span class="hljs-punctuation">&#125;</span><br><br>            Object result = aClass.newInstance();<br>            while (resultSet.next()) <span class="hljs-punctuation">&#123;</span><br>                for (Map.Entry&lt;String<span class="hljs-punctuation">,</span> String&gt; entry <span class="hljs-punctuation">:</span> fieldName2ColumnNameMap.entrySet()) <span class="hljs-punctuation">&#123;</span><br>                    String fieldName = entry.getKey();<br>                    String columnName = entry.getValue();<br><br>                    Object columnValue = resultSet.getObject(columnName);<br>                    Field field = fieldName2FieldMap.get(fieldName);<br>                    field.setAccessible(<span class="hljs-literal"><span class="hljs-keyword">true</span></span>);<br>                    field.set(result<span class="hljs-punctuation">,</span> columnValue);<br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>            return (T)result;<br>        <span class="hljs-punctuation">&#125;</span> catch (ClassNotFoundException | InstantiationException | IllegalAccessException e) <span class="hljs-punctuation">&#123;</span><br>            throw new RuntimeException(e);<br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><br>    private &lt;T&gt; T parseResultOfOneColumn(ResultSet resultSet<span class="hljs-punctuation">,</span> MybatisSqlStatement mybatisSqlStatement) throws SQLException <span class="hljs-punctuation">&#123;</span><br>        return (T) resultSet.getObject(<span class="hljs-number">1</span>);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    private int parseResultTypeCode(MybatisSqlStatement mybatisSqlStatement) <span class="hljs-punctuation">&#123;</span><br>        String resultType = mybatisSqlStatement.getResultType();<br>        String resultMap = mybatisSqlStatement.getResultMap();<br>        if (StringUtils.isEmpty(resultType) &amp;&amp; StringUtils.isEmpty(resultMap)) <span class="hljs-punctuation">&#123;</span><br>            return ONE_COLUMNE;<br>        <span class="hljs-punctuation">&#125;</span><br>        if (StringUtils.isNotEmpty(resultType) &amp;&amp; StringUtils.isNotEmpty(resultMap)) <span class="hljs-punctuation">&#123;</span><br>            throw new RuntimeException(<span class="hljs-string">&quot;resultType和resultMap不能同时存在&quot;</span>);<br>        <span class="hljs-punctuation">&#125;</span><br>        if (StringUtils.isNotEmpty(resultType)) <span class="hljs-punctuation">&#123;</span><br>            return RESULT_TYPE;<br>        <span class="hljs-punctuation">&#125;</span><br>        return RESULT_MAP;<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>最后，我们修改DefaultMybatisSqlSession类：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.session;<br><br>import com.yang.mybatis.config.MybatisConfiguration;<br>import com.yang.mybatis.config.MybatisEnvironment;<br>import com.yang.mybatis.config.MybatisMapperXmlConfiguration;<br>import com.yang.mybatis.config.MybatisSqlStatement;<br>import com.yang.mybatis.execute.DefaultMybatisResultParser;<br>import com.yang.mybatis.execute.IMybatisResultParser;<br>import com.yang.mybatis.execute.request.MybatisResultParserRequest;<br>import com.yang.mybatis.proxy.MapperProxyFactory;<br><br>import java.sql.Connection;<br>import java.sql.PreparedStatement;<br>import java.sql.ResultSet;<br>import java.sql.SQLException;<br>import java.util.ArrayList;<br>import java.util.List;<br>import java.util.Map;<br><br><br>public class DefaultMybatisSqlSession implements IMybatisSqlSession <span class="hljs-punctuation">&#123;</span><br>    private MapperProxyFactory mapperProxyFactory;<br>    private MybatisConfiguration mybatisConfiguration;<br><br>    private IMybatisResultParser iMybatisResultParser = new DefaultMybatisResultParser();<br><br>    public DefaultMybatisSqlSession(MapperProxyFactory mapperProxyFactory) <span class="hljs-punctuation">&#123;</span><br>        this.mapperProxyFactory = mapperProxyFactory;<br>        this.mybatisConfiguration = mapperProxyFactory.getMybatisConfiguration();<br>    <span class="hljs-punctuation">&#125;</span><br><br>    @Override<br>    public &lt;T&gt; T execute(String method<span class="hljs-punctuation">,</span> Object parameter) <span class="hljs-punctuation">&#123;</span><br>        Map&lt;String<span class="hljs-punctuation">,</span> MybatisSqlStatement&gt; mapperMethod2SqlStatementsMap = mapperProxyFactory.getMybatisConfiguration().getMapperMethod2SqlStatementsMap();<br>        MybatisSqlStatement mybatisSqlStatement = mapperMethod2SqlStatementsMap.get(method);<br><br><br>        MybatisEnvironment defaultMybatisEnvironment = this.mybatisConfiguration.getDefaultMybatisEnvironment();<br><br>        return new TransactionInvoke&lt;T&gt;() <span class="hljs-punctuation">&#123;</span><br>            @Override<br>            public T execute(Connection connection) throws SQLException <span class="hljs-punctuation">&#123;</span><br>                String rawSql = mybatisSqlStatement.getSql();<br>                List&lt;String&gt; parameterNameList = new ArrayList&lt;&gt;();<br>                String sql = extractRawSql(rawSql<span class="hljs-punctuation">,</span> parameterNameList);<br>                Object<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> parameters = (Object<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>) parameter;<br>                PreparedStatement preparedStatement = connection.prepareStatement(sql);<br>                if (parameterNameList.size() != parameters.length) <span class="hljs-punctuation">&#123;</span><br>                    throw new RuntimeException(<span class="hljs-string">&quot;SQL语句参数个数不匹配====&quot;</span>);<br>                <span class="hljs-punctuation">&#125;</span><br>                int index = <span class="hljs-number">1</span>;<br>                for (Object o <span class="hljs-punctuation">:</span> parameters) <span class="hljs-punctuation">&#123;</span><br>                    preparedStatement.setObject(index ++<span class="hljs-punctuation">,</span> o);<br>                <span class="hljs-punctuation">&#125;</span><br>                ResultSet resultSet = preparedStatement.executeQuery();<br><br>                String mapperName = mybatisSqlStatement.getNamespace();<br>                MybatisMapperXmlConfiguration mybatisMapperXmlConfiguration = mybatisConfiguration.getMybatisMapperXmlConfiguration(mapperName);<br><br>                MybatisResultParserRequest mybatisResultParserRequest = new MybatisResultParserRequest();<br>                mybatisResultParserRequest.setResultSet(resultSet);<br>                mybatisResultParserRequest.setMybatisSqlStatement(mybatisSqlStatement);<br>                mybatisResultParserRequest.setMybatisMapperXmlConfiguration(mybatisMapperXmlConfiguration);<br>                T result = iMybatisResultParser.parseResult(mybatisResultParserRequest);<br>                resultSet.close();<br>                return result;<br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span>.invoke(defaultMybatisEnvironment.getMybatisDataSource());<br>    <span class="hljs-punctuation">&#125;</span><br><br>    private String extractRawSql(String rawSql<span class="hljs-punctuation">,</span> List&lt;String&gt; parameterNameList) <span class="hljs-punctuation">&#123;</span><br>        StringBuilder sqlBuilder = new StringBuilder();<br>        int start = <span class="hljs-number">0</span>;<br>        int end = <span class="hljs-number">-1</span>;<br>        while ((end = rawSql.indexOf(<span class="hljs-string">&quot;#&quot;</span><span class="hljs-punctuation">,</span> start)) != <span class="hljs-number">-1</span>) <span class="hljs-punctuation">&#123;</span><br>            sqlBuilder.append(rawSql.substring(start<span class="hljs-punctuation">,</span> end - <span class="hljs-number">1</span>))<br>                    .append(<span class="hljs-string">&quot; ? &quot;</span>);<br>            int parameterStart = end + <span class="hljs-number">2</span>;<br>            int parameterEnd = rawSql.indexOf(<span class="hljs-string">&quot;&#125;&quot;</span><span class="hljs-punctuation">,</span> parameterStart);<br>            parameterNameList.add(rawSql.substring(parameterStart<span class="hljs-punctuation">,</span> parameterEnd));<br>            start = parameterEnd + <span class="hljs-number">1</span>;<br>        <span class="hljs-punctuation">&#125;</span><br>        sqlBuilder.append(rawSql.substring(start));<br><br>        return sqlBuilder.toString();<br>    <span class="hljs-punctuation">&#125;</span><br><br><br>    @Override<br>    public &lt;T&gt; T getMapper(Class&lt;T&gt; type) <span class="hljs-punctuation">&#123;</span><br>        return (T) mapperProxyFactory.newInstance(type<span class="hljs-punctuation">,</span> this);<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>添加测试代码，进行测试：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json">public static void main(String<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> args) <span class="hljs-punctuation">&#123;</span><br>        String configPath = <span class="hljs-string">&quot;mybatis-config.xml&quot;</span>;<br>        IMybatisSqlSessionFactory mybatisSqlSessionFactory = new MybatisSqlSessionFactoryBuilder()<br>                .setMybatisConfigurationParser(new XmlMybatisConfigurationParser())<br>                .setMybatisMapperParser(new XmlMybatisMapperParser())<br>                .setConfigPath(configPath)<br>                .buildSqlSessionFactory();<br>        IMybatisSqlSession mybatisSqlSession = mybatisSqlSessionFactory.openSession();<br>        IUserMapper userMapper = mybatisSqlSession.getMapper(IUserMapper.class);<br>        IdUserNameVO idUserNameVO = userMapper.queryIdUserNameVOById(<span class="hljs-number">1</span>);<br>        System.out.println(idUserNameVO.getId());<br>        System.out.println(idUserNameVO.getUserName());<br>    <span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>测试结果如下：</p><img src="/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E2%80%94%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9B%E8%A1%8C%E7%AE%80%E5%8D%95%E6%9F%A5%E8%AF%A2/3.png" class="">]]></content>
    
    
    
    <tags>
      
      <tag>-Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>手撸Mybatis（三）——收敛SQL操作到SqlSession</title>
    <link href="/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E2%80%94%E6%94%B6%E6%95%9BSQL%E6%93%8D%E4%BD%9C%E5%88%B0SqlSession/"/>
    <url>/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E2%80%94%E6%94%B6%E6%95%9BSQL%E6%93%8D%E4%BD%9C%E5%88%B0SqlSession/</url>
    
    <content type="html"><![CDATA[<h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>在上一章中，我们实现了读取mapper配置并构造相关的mapper代理对象，读取mapper.xml文件中的sql信息等操作，现在，在上一章的基础上，我们接着开始链接数据库，通过封装JDBC，来实现我们数据库操作。</p><h4 id="数据库准备"><a href="#数据库准备" class="headerlink" title="数据库准备"></a>数据库准备</h4><p>我们创建一个user表，用于后续进行测试，user表的结构如下图所示：</p><img src="/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E2%80%94%E6%94%B6%E6%95%9BSQL%E6%93%8D%E4%BD%9C%E5%88%B0SqlSession/1.png" class=""><p>user表的内容如下：</p><img src="/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E2%80%94%E6%94%B6%E6%95%9BSQL%E6%93%8D%E4%BD%9C%E5%88%B0SqlSession/2.png" class=""><h4 id="添加User类"><a href="#添加User类" class="headerlink" title="添加User类"></a>添加User类</h4><p>我们根据表结构，创建对应的user类，user类的结构如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.test;<br><br>import java.io.Serializable;<br>import java.util.Date;<br><br>public class User implements Serializable <span class="hljs-punctuation">&#123;</span><br>    private Integer id;<br>    <br>    private String userName;<br>    <br>    private String password;<br>    <br>    private Integer age;<br>    <br>    private Date createTime;<br><br>    public Integer getId() <span class="hljs-punctuation">&#123;</span><br>        return id;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setId(Integer id) <span class="hljs-punctuation">&#123;</span><br>        this.id = id;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public String getUserName() <span class="hljs-punctuation">&#123;</span><br>        return userName;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setUserName(String userName) <span class="hljs-punctuation">&#123;</span><br>        this.userName = userName;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public String getPassword() <span class="hljs-punctuation">&#123;</span><br>        return password;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setPassword(String password) <span class="hljs-punctuation">&#123;</span><br>        this.password = password;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public Integer getAge() <span class="hljs-punctuation">&#123;</span><br>        return age;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setAge(Integer age) <span class="hljs-punctuation">&#123;</span><br>        this.age = age;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public Date getCreateTime() <span class="hljs-punctuation">&#123;</span><br>        return createTime;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setCreateTime(Date createTime) <span class="hljs-punctuation">&#123;</span><br>        this.createTime = createTime;<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><h4 id="JDBC基础操作"><a href="#JDBC基础操作" class="headerlink" title="JDBC基础操作"></a>JDBC基础操作</h4><p>在使用jdbc之前，我们先引入mysql的依赖</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">&lt;dependency&gt;<br>            &lt;groupId&gt;mysql&lt;/groupId&gt;<br>            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;<br>            &lt;version&gt;<span class="hljs-number">8.0</span><span class="hljs-number">.27</span>&lt;/version&gt;<br>        &lt;/dependency&gt;<br></code></pre></td></tr></table></figure><p>jdbc的操作，一般分为下面几个步骤：<br>1）加载JDBC驱动程序<br>2）创建数据库链接<br>3）创建一个preparedStatement<br>4）执行SQL语句<br>5）遍历数据集<br>6）处理异常，关闭JDBC对象资源<br>示例代码如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs json">public static void main(String<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> args) throws SQLException <span class="hljs-punctuation">&#123;</span><br>       String url = <span class="hljs-string">&quot;jdbc:mysql://localhost:3306/test?useSSL=false&quot;</span>;<br>       String username = <span class="hljs-string">&quot;root&quot;</span>;<br>       String password = <span class="hljs-string">&quot;3fa4d180&quot;</span>;<br><br>       Connection conn = <span class="hljs-literal"><span class="hljs-keyword">null</span></span>;<br>       try <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-comment">// 1. 加载驱动</span><br>           Class.forName(<span class="hljs-string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);<br>          <span class="hljs-comment">// 2. 创建数据库链接</span><br>           conn = DriverManager.getConnection(url<span class="hljs-punctuation">,</span> username<span class="hljs-punctuation">,</span> password);<br>           conn.setAutoCommit(<span class="hljs-literal"><span class="hljs-keyword">false</span></span>);<br><br>          <span class="hljs-comment">// 3. 创建preparedStatement</span><br>           String sql = <span class="hljs-string">&quot;select user_name from user where id = ?&quot;</span>;<br>           PreparedStatement preparedStatement = conn.prepareStatement(sql);<br>           preparedStatement.setInt(<span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span>);<br>           <span class="hljs-comment">// 4. 执行sql</span><br>          ResultSet resultSet = preparedStatement.executeQuery();<br>          <span class="hljs-comment">// 5. 遍历结果</span><br>          if (resultSet.next()) <span class="hljs-punctuation">&#123;</span><br>               System.out.println(resultSet.getString(<span class="hljs-number">1</span>));<br>           <span class="hljs-punctuation">&#125;</span><br>           conn.commit();<br>       <span class="hljs-punctuation">&#125;</span> catch (SQLException | ClassNotFoundException e) <span class="hljs-punctuation">&#123;</span><br>           conn.rollback();<br>           e.printStackTrace();<br>       <span class="hljs-punctuation">&#125;</span> finally <span class="hljs-punctuation">&#123;</span><br>         <span class="hljs-comment">// 6. 释放连接</span><br>           conn.close();<br>       <span class="hljs-punctuation">&#125;</span><br>   <span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>执行上述代码，结果如下：</p><img src="/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E2%80%94%E6%94%B6%E6%95%9BSQL%E6%93%8D%E4%BD%9C%E5%88%B0SqlSession/3.png" class=""><h3 id="将sql操作，收敛到SqlSession"><a href="#将sql操作，收敛到SqlSession" class="headerlink" title="将sql操作，收敛到SqlSession"></a>将sql操作，收敛到SqlSession</h3><p>在上一章，当我们调用mapper的方法时，最终是通过在MapperProxy中获取对应的MybatisStatement，然后打印出sql信息的，但是如果后续操作数据库是，也在MapperProxy中执行sql的话，不太方便管理。因此，我们添加一个IMybatisSqlSession类，后续对于数据库的操作，收敛到此类进行。<br>首先，我们添加IMybatisSqlSession：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.session;<br><br>public interface IMybatisSqlSession <span class="hljs-punctuation">&#123;</span><br><br>    &lt;T&gt; T execute(String method<span class="hljs-punctuation">,</span> Object parameter);<br><br>    &lt;T&gt; T getMapper(Class&lt;T&gt; type);<br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>然后添加其默认实现：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.session;<br><br>import com.yang.mybatis.proxy.MapperProxyFactory;<br><br>public class DefaultMybatisSqlSession implements IMybatisSqlSession <span class="hljs-punctuation">&#123;</span><br>    private MapperProxyFactory mapperProxyFactory;<br><br>    public DefaultMybatisSqlSession(MapperProxyFactory mapperProxyFactory) <span class="hljs-punctuation">&#123;</span><br>        this.mapperProxyFactory = mapperProxyFactory;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    @Override<br>    public &lt;T&gt; T execute(String method<span class="hljs-punctuation">,</span> Object parameter) <span class="hljs-punctuation">&#123;</span><br>        return (T)(<span class="hljs-string">&quot;你被代理了!&quot;</span> + method + <span class="hljs-string">&quot;,入参:&quot;</span> + parameter);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    @Override<br>    public &lt;T&gt; T getMapper(Class&lt;T&gt; type) <span class="hljs-punctuation">&#123;</span><br>        return (T) mapperProxyFactory.newInstance(type<span class="hljs-punctuation">,</span> this);<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>添加IMybatisSqlSession的工厂接口</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.session;<br><br>public interface MybatisSqlSessionFactory <span class="hljs-punctuation">&#123;</span><br>    IMybatisSqlSession openSession();<br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>添加工厂的默认实现：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.session;<br><br>import com.yang.mybatis.proxy.MapperProxyFactory;<br><br>public class DefaultMybatisSqlSessionFactory implements IMybatisSqlSessionFactory <span class="hljs-punctuation">&#123;</span><br>    private MapperProxyFactory mapperProxyFactory;<br><br>    public DefaultMybatisSqlSessionFactory(MapperProxyFactory mapperProxyFactory) <span class="hljs-punctuation">&#123;</span><br>        this.mapperProxyFactory = mapperProxyFactory;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    @Override<br>    public IMybatisSqlSession openSession() <span class="hljs-punctuation">&#123;</span><br>        return new DefaultMybatisSqlSession(mapperProxyFactory);<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>修改MapperProxyFactory，在新建MapperProxy的时候，将imybatisSqlSession传递给MapperProxy。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.proxy;<br><br>import com.yang.mybatis.config.MybatisConfiguration;<br>import com.yang.mybatis.session.IMybatisSqlSession;<br><br>import java.lang.reflect.Proxy;<br><br>public class MapperProxyFactory <span class="hljs-punctuation">&#123;</span><br>    private MybatisConfiguration mybatisConfiguration;<br><br><br>    public MapperProxyFactory(MybatisConfiguration mybatisConfiguration) <span class="hljs-punctuation">&#123;</span><br>        this.mybatisConfiguration = mybatisConfiguration;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public Object newInstance(Class mapperType<span class="hljs-punctuation">,</span> IMybatisSqlSession mybatisSqlSession) <span class="hljs-punctuation">&#123;</span><br>        MapperProxy mapperProxy = new MapperProxy(mapperType<span class="hljs-punctuation">,</span> mybatisSqlSession);<br>        return Proxy.newProxyInstance(mapperType.getClassLoader()<span class="hljs-punctuation">,</span><br>                new Class<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">&#123;</span>mapperType<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                mapperProxy);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisConfiguration getMybatisConfiguration() <span class="hljs-punctuation">&#123;</span><br>        return mybatisConfiguration;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setMybatisConfiguration(MybatisConfiguration mybatisConfiguration) <span class="hljs-punctuation">&#123;</span><br>        this.mybatisConfiguration = mybatisConfiguration;<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>然后修改MapperProxy，在真正执行的时候，通过iMybatisSqlSession的execute，来执行sql操作，以此实现sql操作由iMybatisSqlSession来统一管理。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.proxy;<br><br>import com.yang.mybatis.session.IMybatisSqlSession;<br><br>import java.lang.reflect.InvocationHandler;<br>import java.lang.reflect.Method;<br><br>public class MapperProxy&lt;T&gt; implements InvocationHandler <span class="hljs-punctuation">&#123;</span><br><br>    private Class&lt;T&gt; mapperInterface;<br><br>    private IMybatisSqlSession sqlSession;<br><br>    public MapperProxy(Class&lt;T&gt; mapperInterface<span class="hljs-punctuation">,</span> IMybatisSqlSession mybatisSqlSession) <span class="hljs-punctuation">&#123;</span><br>        this.mapperInterface = mapperInterface;<br>        this.sqlSession = mybatisSqlSession;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    @Override<br>    public Object invoke(Object proxy<span class="hljs-punctuation">,</span> Method method<span class="hljs-punctuation">,</span> Object<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> args) throws Throwable <span class="hljs-punctuation">&#123;</span><br>        if (Object.class.equals(method.getDeclaringClass())) <span class="hljs-punctuation">&#123;</span><br>            return method.invoke(this<span class="hljs-punctuation">,</span> args);<br>        <span class="hljs-punctuation">&#125;</span><br>        String methodName = this.mapperInterface.getName() + <span class="hljs-string">&quot;.&quot;</span> + method.getName();<br>        return sqlSession.execute(methodName<span class="hljs-punctuation">,</span> args);<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>最后，我们添加sqlSession工厂类的创建者，通过创建者模式，来创建SqlSession工厂</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.session;<br><br>import com.yang.mybatis.config.MybatisConfiguration;<br>import com.yang.mybatis.config.MybatisSqlStatement;<br>import com.yang.mybatis.config.parser.IMybatisConfigurationParser;<br>import com.yang.mybatis.config.parser.IMybatisMapperParser;<br>import com.yang.mybatis.proxy.MapperProxyFactory;<br><br>import java.util.List;<br>import java.util.Map;<br>import java.util.stream.Collectors;<br><br>public class MybatisSqlSessionFactoryBuilder <span class="hljs-punctuation">&#123;</span><br>    private IMybatisConfigurationParser mybatisConfigurationParser;<br><br>    private IMybatisMapperParser mybatisMapperParser;<br><br>    private String configPath;<br><br>    public IMybatisSqlSessionFactory buildSqlSessionFactory() <span class="hljs-punctuation">&#123;</span><br>        if (configPath == <span class="hljs-literal"><span class="hljs-keyword">null</span></span> || configPath.isEmpty()) <span class="hljs-punctuation">&#123;</span><br>            throw new RuntimeException(<span class="hljs-string">&quot;配置文件路径不合法==========&quot;</span>);<br>        <span class="hljs-punctuation">&#125;</span><br>        if (this.mybatisMapperParser == <span class="hljs-literal"><span class="hljs-keyword">null</span></span> || this.mybatisConfigurationParser == <span class="hljs-literal"><span class="hljs-keyword">null</span></span>) <span class="hljs-punctuation">&#123;</span><br>            throw new RuntimeException(<span class="hljs-string">&quot;缺少解析器=======&quot;</span>);<br>        <span class="hljs-punctuation">&#125;</span><br>        MybatisConfiguration mybatisConfiguration = mybatisConfigurationParser.parser(configPath);<br>        List&lt;String&gt; mapperPaths = mybatisConfiguration.getMapperPaths();<br>        for (String mapperPath <span class="hljs-punctuation">:</span> mapperPaths) <span class="hljs-punctuation">&#123;</span><br>            List&lt;MybatisSqlStatement&gt; mybatisSqlStatements = this.mybatisMapperParser.parseMapper(mapperPath);<br>            Map&lt;String<span class="hljs-punctuation">,</span> List&lt;MybatisSqlStatement&gt;&gt; mapperNameGroupMap = mybatisSqlStatements.stream()<br>                    .collect(Collectors.groupingBy(MybatisSqlStatement<span class="hljs-punctuation">:</span><span class="hljs-punctuation">:</span>getNamespace));<br><br>            for (Map.Entry&lt;String<span class="hljs-punctuation">,</span> List&lt;MybatisSqlStatement&gt;&gt; entry <span class="hljs-punctuation">:</span> mapperNameGroupMap.entrySet()) <span class="hljs-punctuation">&#123;</span><br>                String mapperName = entry.getKey();<br>                List&lt;MybatisSqlStatement&gt; sqlSessionList = entry.getValue();<br>                mybatisConfiguration.putMybatisSqlStatementList(mapperName<span class="hljs-punctuation">,</span> sqlSessionList);<br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br><br>        MapperProxyFactory mapperProxyFactory = new MapperProxyFactory(mybatisConfiguration);<br>        return new DefaultMybatisSqlSessionFactory(mapperProxyFactory);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisSqlSessionFactoryBuilder setConfigPath(String configPath) <span class="hljs-punctuation">&#123;</span><br>        this.configPath = configPath;<br>        return this;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisSqlSessionFactoryBuilder setMybatisConfigurationParser(IMybatisConfigurationParser iMybatisConfigurationParser) <span class="hljs-punctuation">&#123;</span><br>        this.mybatisConfigurationParser = iMybatisConfigurationParser;<br>        return this;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisSqlSessionFactoryBuilder setMybatisMapperParser(IMybatisMapperParser iMybatisMapperParser) <span class="hljs-punctuation">&#123;</span><br>        this.mybatisMapperParser = iMybatisMapperParser;<br>        return this;<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>添加测试代码，进行测试：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.test;<br><br>import com.yang.mybatis.config.parser.XmlMybatisConfigurationParser;<br>import com.yang.mybatis.config.parser.XmlMybatisMapperParser;<br>import com.yang.mybatis.session.IMybatisSqlSession;<br>import com.yang.mybatis.session.IMybatisSqlSessionFactory;<br>import com.yang.mybatis.session.MybatisSqlSessionFactoryBuilder;<br><br><br>public class Main <span class="hljs-punctuation">&#123;</span><br>    public static void main(String<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> args) <span class="hljs-punctuation">&#123;</span><br>        String configPath = <span class="hljs-string">&quot;mybatis-config.xml&quot;</span>;<br>        IMybatisSqlSessionFactory mybatisSqlSessionFactory = new MybatisSqlSessionFactoryBuilder()<br>                .setMybatisMapperParser(new XmlMybatisMapperParser())<br>                .setMybatisConfigurationParser(new XmlMybatisConfigurationParser())<br>                .setConfigPath(configPath)<br>                .buildSqlSessionFactory();<br><br>        IMybatisSqlSession mybatisSqlSession = mybatisSqlSessionFactory.openSession();<br><br>        IUserMapper userMapper = mybatisSqlSession.getMapper(IUserMapper.class);<br>        System.out.println(userMapper.queryUserName(<span class="hljs-number">1</span>));<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><img src="/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E2%80%94%E6%94%B6%E6%95%9BSQL%E6%93%8D%E4%BD%9C%E5%88%B0SqlSession/4.png" class=""><h3 id="SqlSession获取执行方法对应的sql语句"><a href="#SqlSession获取执行方法对应的sql语句" class="headerlink" title="SqlSession获取执行方法对应的sql语句"></a>SqlSession获取执行方法对应的sql语句</h3><p>首先，修改MybatisConfiguration，之前是将每一个mapper和他所拥有的MybatisSqlStatement列表关联起来，现在感觉粒度太大，因此，该为每一个mapper的方法和对应的MybatisSqlStatement关联。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.config;<br><br>import java.io.Serializable;<br>import java.util.ArrayList;<br>import java.util.HashMap;<br>import java.util.List;<br>import java.util.Map;<br><br>public class MybatisConfiguration implements Serializable <span class="hljs-punctuation">&#123;</span><br>    private Map&lt;String<span class="hljs-punctuation">,</span> MybatisEnvironment&gt; id2EnvironmentMap = new HashMap&lt;&gt;();<br><br>    private MybatisEnvironment defaultMybatisEnvironment;<br><br>    private List&lt;String&gt; mapperPaths = new ArrayList&lt;&gt;();<br><br>    private Map&lt;String<span class="hljs-punctuation">,</span> MybatisSqlStatement&gt; mapperMethod2SqlStatementsMap = new HashMap&lt;&gt;();<br><br>    public void putMapperMethod2MybatisSqlStatement(String mapperMethod<span class="hljs-punctuation">,</span> MybatisSqlStatement mybatisSqlStatement) <span class="hljs-punctuation">&#123;</span><br>        this.mapperMethod2SqlStatementsMap.put(mapperMethod<span class="hljs-punctuation">,</span> mybatisSqlStatement);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisSqlStatement getMybatisSqlStatement(String mapperMethod) <span class="hljs-punctuation">&#123;</span><br>        return this.mapperMethod2SqlStatementsMap.get(mapperMethod);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public Map&lt;String<span class="hljs-punctuation">,</span> MybatisSqlStatement&gt; getMapperMethod2SqlStatementsMap() <span class="hljs-punctuation">&#123;</span><br>        return this.mapperMethod2SqlStatementsMap;<br>    <span class="hljs-punctuation">&#125;</span><br><br><br>    public void addEnvironment(String id<span class="hljs-punctuation">,</span> MybatisEnvironment mybatisEnvironment) <span class="hljs-punctuation">&#123;</span><br>        this.id2EnvironmentMap.put(id<span class="hljs-punctuation">,</span> mybatisEnvironment);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisEnvironment getEnvironment(String id) <span class="hljs-punctuation">&#123;</span><br>        return id2EnvironmentMap.get(id);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisEnvironment getDefaultMybatisEnvironment() <span class="hljs-punctuation">&#123;</span><br>        return defaultMybatisEnvironment;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setDefaultMybatisEnvironment(MybatisEnvironment defaultMybatisEnvironment) <span class="hljs-punctuation">&#123;</span><br>        this.defaultMybatisEnvironment = defaultMybatisEnvironment;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void addMapperPath(String mapperPath) <span class="hljs-punctuation">&#123;</span><br>        this.mapperPaths.add(mapperPath);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public List&lt;String&gt; getMapperPaths() <span class="hljs-punctuation">&#123;</span><br>        return this.mapperPaths;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public List&lt;MybatisEnvironment&gt; getEnvironments() <span class="hljs-punctuation">&#123;</span><br>        return new ArrayList&lt;&gt;(id2EnvironmentMap.values());<br>    <span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>然后修改MybatisSqlSessionFactoryBuilder:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.session;<br><br>import com.yang.mybatis.config.MybatisConfiguration;<br>import com.yang.mybatis.config.MybatisSqlStatement;<br>import com.yang.mybatis.config.parser.IMybatisConfigurationParser;<br>import com.yang.mybatis.config.parser.IMybatisMapperParser;<br>import com.yang.mybatis.proxy.MapperProxyFactory;<br><br>import java.util.List;<br><br>public class MybatisSqlSessionFactoryBuilder <span class="hljs-punctuation">&#123;</span><br>    private IMybatisConfigurationParser mybatisConfigurationParser;<br><br>    private IMybatisMapperParser mybatisMapperParser;<br><br>    private String configPath;<br><br>    public IMybatisSqlSessionFactory buildSqlSessionFactory() <span class="hljs-punctuation">&#123;</span><br>        if (configPath == <span class="hljs-literal"><span class="hljs-keyword">null</span></span> || configPath.isEmpty()) <span class="hljs-punctuation">&#123;</span><br>            throw new RuntimeException(<span class="hljs-string">&quot;配置文件路径不合法==========&quot;</span>);<br>        <span class="hljs-punctuation">&#125;</span><br>        if (this.mybatisMapperParser == <span class="hljs-literal"><span class="hljs-keyword">null</span></span> || this.mybatisConfigurationParser == <span class="hljs-literal"><span class="hljs-keyword">null</span></span>) <span class="hljs-punctuation">&#123;</span><br>            throw new RuntimeException(<span class="hljs-string">&quot;缺少解析器=======&quot;</span>);<br>        <span class="hljs-punctuation">&#125;</span><br>        MybatisConfiguration mybatisConfiguration = mybatisConfigurationParser.parser(configPath);<br>        List&lt;String&gt; mapperPaths = mybatisConfiguration.getMapperPaths();<br>        for (String mapperPath <span class="hljs-punctuation">:</span> mapperPaths) <span class="hljs-punctuation">&#123;</span><br>            List&lt;MybatisSqlStatement&gt; mybatisSqlStatements = this.mybatisMapperParser.parseMapper(mapperPath);<br>            for (MybatisSqlStatement mybatisSqlStatement <span class="hljs-punctuation">:</span> mybatisSqlStatements) <span class="hljs-punctuation">&#123;</span><br>                String methodName = mybatisSqlStatement.getNamespace() + <span class="hljs-string">&quot;.&quot;</span> + mybatisSqlStatement.getId();<br>                mybatisConfiguration.putMapperMethod2MybatisSqlStatement(methodName<span class="hljs-punctuation">,</span> mybatisSqlStatement);<br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br><br>        MapperProxyFactory mapperProxyFactory = new MapperProxyFactory(mybatisConfiguration);<br>        return new DefaultMybatisSqlSessionFactory(mapperProxyFactory);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisSqlSessionFactoryBuilder setConfigPath(String configPath) <span class="hljs-punctuation">&#123;</span><br>        this.configPath = configPath;<br>        return this;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisSqlSessionFactoryBuilder setMybatisConfigurationParser(IMybatisConfigurationParser iMybatisConfigurationParser) <span class="hljs-punctuation">&#123;</span><br>        this.mybatisConfigurationParser = iMybatisConfigurationParser;<br>        return this;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisSqlSessionFactoryBuilder setMybatisMapperParser(IMybatisMapperParser iMybatisMapperParser) <span class="hljs-punctuation">&#123;</span><br>        this.mybatisMapperParser = iMybatisMapperParser;<br>        return this;<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>修改DefaultMybatisSqlSession类，获取方法对应的MybatisStatement</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.session;<br><br>import com.yang.mybatis.config.MybatisSqlStatement;<br>import com.yang.mybatis.proxy.MapperProxyFactory;<br><br><br>public class DefaultMybatisSqlSession implements IMybatisSqlSession <span class="hljs-punctuation">&#123;</span><br>    private MapperProxyFactory mapperProxyFactory;<br><br>    public DefaultMybatisSqlSession(MapperProxyFactory mapperProxyFactory) <span class="hljs-punctuation">&#123;</span><br>        this.mapperProxyFactory = mapperProxyFactory;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    @Override<br>    public &lt;T&gt; T execute(String method<span class="hljs-punctuation">,</span> Object parameter) <span class="hljs-punctuation">&#123;</span><br>        MybatisSqlStatement mybatisSqlStatement = this.mapperProxyFactory.getMybatisConfiguration().getMybatisSqlStatement(method);<br>        return (T)(<span class="hljs-string">&quot;method:&quot;</span> + method + <span class="hljs-string">&quot;sql:&quot;</span>+ mybatisSqlStatement.getSql() + <span class="hljs-string">&quot;,入参:&quot;</span> + parameter);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    @Override<br>    public &lt;T&gt; T getMapper(Class&lt;T&gt; type) <span class="hljs-punctuation">&#123;</span><br>        return (T) mapperProxyFactory.newInstance(type<span class="hljs-punctuation">,</span> this);<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>添加测试方法进行测试：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json">public static void main(String<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> args) <span class="hljs-punctuation">&#123;</span><br>       String configPath = <span class="hljs-string">&quot;mybatis-config.xml&quot;</span>;<br>       MybatisSqlSessionFactory mybatisSqlSessionFactory = new MybatisSqlSessionFactoryBuilder()<br>               .setMybatisMapperParser(new XmlMybatisMapperParser())<br>               .setMybatisConfigurationParser(new XmlMybatisConfigurationParser())<br>               .setConfigPath(configPath)<br>               .buildSqlSessionFactory();<br><br>       IMybatisSqlSession mybatisSqlSession = mybatisSqlSessionFactory.openSession();<br><br>       IUserMapper userMapper = mybatisSqlSession.getMapper(IUserMapper.class);<br>       System.out.println(userMapper.queryUserAge(<span class="hljs-number">1</span>));<br>   <span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>测试结果如下：</p><img src="/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E2%80%94%E6%94%B6%E6%95%9BSQL%E6%93%8D%E4%BD%9C%E5%88%B0SqlSession/5.png" class=""><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="https://blog.csdn.net/weixin_43520450/article/details/107230205">https://blog.csdn.net/weixin_43520450&#x2F;article&#x2F;details&#x2F;107230205</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>-Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>手撸Mybatis（二）——配置项的获取</title>
    <link href="/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E9%85%8D%E7%BD%AE%E9%A1%B9%E7%9A%84%E8%8E%B7%E5%8F%96/"/>
    <url>/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E9%85%8D%E7%BD%AE%E9%A1%B9%E7%9A%84%E8%8E%B7%E5%8F%96/</url>
    
    <content type="html"><![CDATA[<h3 id="配置项解析"><a href="#配置项解析" class="headerlink" title="配置项解析"></a>配置项解析</h3><p>在mybatis中，一般我们会定义一个mapper-config.xml文件，来配置数据库连接的相关信息，以及我们的mapperxml文件存放目录。在本章，我们会读取这些文件，将其配置信息进行解析。<br>因为涉及到xml的解析，因此，我们先添加dom4j的依赖，以方便后续解析xml</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">&lt;dependency&gt;<br>            &lt;groupId&gt;org.dom4j&lt;/groupId&gt;<br>            &lt;artifactId&gt;dom4j&lt;/artifactId&gt;<br>            &lt;version&gt;<span class="hljs-number">2.1</span><span class="hljs-number">.3</span>&lt;/version&gt;<br>        &lt;/dependency&gt;<br></code></pre></td></tr></table></figure><p>mybatis-config.xml的内容如下，对于每一个环境，都有对应的数据源信息，此外，mappers标签存储的是mapper.xml文件的位置。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs json">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;<br>&lt;!DOCTYPE configuration<br>        PUBLIC <span class="hljs-string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span><br>        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;<br>&lt;configuration&gt;<br>    &lt;environments default=<span class="hljs-string">&quot;development&quot;</span>&gt;<br>        &lt;environment id=<span class="hljs-string">&quot;development&quot;</span>&gt;<br>            &lt;transactionManager type=<span class="hljs-string">&quot;JDBC&quot;</span>/&gt;<br>            &lt;dataSource type=<span class="hljs-string">&quot;POOLED&quot;</span>&gt;<br>                &lt;property name=<span class="hljs-string">&quot;driver&quot;</span> value=<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>/&gt;<br>                &lt;property name=<span class="hljs-string">&quot;url&quot;</span> value=<span class="hljs-string">&quot;jdbc:mysql://192.168.102.128:3306/test&quot;</span>/&gt;<br>                &lt;property name=<span class="hljs-string">&quot;username&quot;</span> value=<span class="hljs-string">&quot;root&quot;</span>/&gt;<br>                &lt;property name=<span class="hljs-string">&quot;password&quot;</span> value=<span class="hljs-string">&quot;123456&quot;</span>/&gt;<br>            &lt;/dataSource&gt;<br>        &lt;/environment&gt;<br>    &lt;/environments&gt;<br>    &lt;mappers&gt;<br>        &lt;mapper resource=<span class="hljs-string">&quot;mapper/UserMapper.xml&quot;</span>/&gt;<br>    &lt;/mappers&gt;<br>&lt;/configuration&gt;<br></code></pre></td></tr></table></figure><p>首先，我们添加MybatisDataSource，用来记录数据源信息</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.config;<br><br>import java.io.Serializable;<br><br>public class MybatisDataSource implements Serializable <span class="hljs-punctuation">&#123;</span><br>    private String driver;<br>    private String url;<br>    private String username;<br>    private String password;<br><br>    public String getDriver() <span class="hljs-punctuation">&#123;</span><br>        return driver;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public String getUrl() <span class="hljs-punctuation">&#123;</span><br>        return url;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public String getUsername() <span class="hljs-punctuation">&#123;</span><br>        return username;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public String getPassword() <span class="hljs-punctuation">&#123;</span><br>        return password;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setDriver(String driver) <span class="hljs-punctuation">&#123;</span><br>        this.driver = driver;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setUrl(String url) <span class="hljs-punctuation">&#123;</span><br>        this.url = url;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setUsername(String username) <span class="hljs-punctuation">&#123;</span><br>        this.username = username;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setPassword(String password) <span class="hljs-punctuation">&#123;</span><br>        this.password = password;<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>然后添加一个MybatisEnvironment，用来存储环境信息</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.config;<br><br>import java.io.Serializable;<br><br>public class MybatisEnvironment implements Serializable <span class="hljs-punctuation">&#123;</span><br>    private String id;<br><br>    private MybatisDataSource mybatisDataSource;<br><br>    public String getId() <span class="hljs-punctuation">&#123;</span><br>        return id;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setId(String id) <span class="hljs-punctuation">&#123;</span><br>        this.id = id;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisDataSource getMybatisDataSource() <span class="hljs-punctuation">&#123;</span><br>        return mybatisDataSource;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setMybatisDataSource(MybatisDataSource mybatisDataSource) <span class="hljs-punctuation">&#123;</span><br>        this.mybatisDataSource = mybatisDataSource;<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>然后是MybatisConfiguration，我们读取mybatis-config.xml配置文件后，配置信息就存储在这个类中。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.config;<br><br>import java.io.Serializable;<br>import java.util.ArrayList;<br>import java.util.HashMap;<br>import java.util.List;<br>import java.util.Map;<br><br>public class MybatisConfiguration implements Serializable <span class="hljs-punctuation">&#123;</span><br>    private Map&lt;String<span class="hljs-punctuation">,</span> MybatisEnvironment&gt; id2EnvironmentMap = new HashMap&lt;&gt;();<br><br>    private MybatisEnvironment defaultMybatisEnvironment;<br><br>    private List&lt;String&gt; mapperPaths = new ArrayList&lt;&gt;();<br><br>    public void addEnvironment(String id<span class="hljs-punctuation">,</span> MybatisEnvironment mybatisEnvironment) <span class="hljs-punctuation">&#123;</span><br>        this.id2EnvironmentMap.put(id<span class="hljs-punctuation">,</span> mybatisEnvironment);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisEnvironment getEnvironment(String id) <span class="hljs-punctuation">&#123;</span><br>        return id2EnvironmentMap.get(id);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisEnvironment getDefaultMybatisEnvironment() <span class="hljs-punctuation">&#123;</span><br>        return defaultMybatisEnvironment;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setDefaultMybatisEnvironment(MybatisEnvironment defaultMybatisEnvironment) <span class="hljs-punctuation">&#123;</span><br>        this.defaultMybatisEnvironment = defaultMybatisEnvironment;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void addMapperPath(String mapperPath) <span class="hljs-punctuation">&#123;</span><br>        this.mapperPaths.add(mapperPath);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public List&lt;String&gt; getMapperPaths() <span class="hljs-punctuation">&#123;</span><br>        return this.mapperPaths;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public List&lt;MybatisEnvironment&gt; getEnvironments() <span class="hljs-punctuation">&#123;</span><br>        return new ArrayList&lt;&gt;(id2EnvironmentMap.values());<br>    <span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>对于mybatis-config.xml的解析，我们定义一个IMybatisConfigParser接口</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.config.parser;<br><br>import com.yang.mybatis.config.MybatisConfiguration;<br><br>public interface IMybatisConfigurationParser <span class="hljs-punctuation">&#123;</span><br>    MybatisConfiguration parser(String path) ;<br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>然后定义其实现类：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.config.parser;<br><br>import com.yang.mybatis.config.MybatisConfiguration;<br>import com.yang.mybatis.config.MybatisDataSource;<br>import com.yang.mybatis.config.MybatisEnvironment;<br>import org.dom4j.Document;<br>import org.dom4j.Element;<br>import org.dom4j.io.SAXReader;<br><br>import java.io.InputStream;<br>import java.util.HashMap;<br>import java.util.List;<br>import java.util.Map;<br><br>public class XmlMybatisConfigurationParser implements IMybatisConfigurationParser <span class="hljs-punctuation">&#123;</span><br><br>    @Override<br>    public MybatisConfiguration parser(String path) <span class="hljs-punctuation">&#123;</span><br>        MybatisConfiguration mybatisConfiguration = new MybatisConfiguration();<br>        try <span class="hljs-punctuation">&#123;</span><br>            InputStream inputStream = this.getClass().getClassLoader().getResourceAsStream(path);<br>            SAXReader saxReader = new SAXReader();<br>            <span class="hljs-comment">// 1. 读取文档</span><br>            Document document = saxReader.read(inputStream);<br>            Element root = document.getRootElement();<br><br>            parseEnvironments(mybatisConfiguration<span class="hljs-punctuation">,</span> root.element(<span class="hljs-string">&quot;environments&quot;</span>));<br>            parseMappers(mybatisConfiguration<span class="hljs-punctuation">,</span> root.element(<span class="hljs-string">&quot;mappers&quot;</span>));<br>        <span class="hljs-punctuation">&#125;</span> catch (Exception e) <span class="hljs-punctuation">&#123;</span><br>            e.printStackTrace();<br>        <span class="hljs-punctuation">&#125;</span><br>        return mybatisConfiguration;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    private void parseMappers(MybatisConfiguration mybatisConfiguration<span class="hljs-punctuation">,</span> Element mappers) <span class="hljs-punctuation">&#123;</span><br>        List&lt;Element&gt; mapperList = mappers.elements(<span class="hljs-string">&quot;mapper&quot;</span>);<br>        for (Element mapper <span class="hljs-punctuation">:</span> mapperList) <span class="hljs-punctuation">&#123;</span><br>            String resource = mapper.attributeValue(<span class="hljs-string">&quot;resource&quot;</span>);<br>            mybatisConfiguration.addMapperPath(resource);<br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><br>    private void parseEnvironments(MybatisConfiguration mybatisConfiguration<span class="hljs-punctuation">,</span> Element environments) <span class="hljs-punctuation">&#123;</span><br>        String defaultId = environments.attributeValue(<span class="hljs-string">&quot;default&quot;</span>);<br>        for (Element element <span class="hljs-punctuation">:</span> environments.elements()) <span class="hljs-punctuation">&#123;</span><br>            String id = element.attributeValue(<span class="hljs-string">&quot;id&quot;</span>);<br><br>            Element dataSource = element.element(<span class="hljs-string">&quot;dataSource&quot;</span>);<br>            List&lt;Element&gt; properties = dataSource.elements(<span class="hljs-string">&quot;property&quot;</span>);<br>            Map&lt;String<span class="hljs-punctuation">,</span> String&gt; propertyMap = new HashMap&lt;&gt;();<br>            for (Element property <span class="hljs-punctuation">:</span> properties) <span class="hljs-punctuation">&#123;</span><br>                propertyMap.put(property.attributeValue(<span class="hljs-string">&quot;name&quot;</span>)<span class="hljs-punctuation">,</span> property.attributeValue(<span class="hljs-string">&quot;value&quot;</span>));<br>            <span class="hljs-punctuation">&#125;</span><br>            String driver = propertyMap.get(<span class="hljs-string">&quot;driver&quot;</span>);<br>            String url = propertyMap.get(<span class="hljs-string">&quot;url&quot;</span>);<br>            String username = propertyMap.get(<span class="hljs-string">&quot;username&quot;</span>);<br>            String password = propertyMap.get(<span class="hljs-string">&quot;password&quot;</span>);<br>            MybatisDataSource mybatisDataSource = new MybatisDataSource();<br>            mybatisDataSource.setDriver(driver);<br>            mybatisDataSource.setUrl(url);<br>            mybatisDataSource.setUsername(username);<br>            mybatisDataSource.setPassword(password);<br><br>            MybatisEnvironment mybatisEnvironment = new MybatisEnvironment();<br>            mybatisEnvironment.setId(id);<br>            mybatisEnvironment.setMybatisDataSource(mybatisDataSource);<br>            mybatisConfiguration.addEnvironment(id<span class="hljs-punctuation">,</span> mybatisEnvironment);<br>            if (id.equals(defaultId)) <span class="hljs-punctuation">&#123;</span><br>                mybatisConfiguration.setDefaultMybatisEnvironment(mybatisEnvironment);<br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>然后添加测试代码进行测试：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs json">IMybatisConfigurationParser mybatisConfigurationParser = new XmlMybatisConfigurationParser();<br>       MybatisConfiguration mybatisConfiguration = mybatisConfigurationParser.parser(<span class="hljs-string">&quot;mybatis-config.xml&quot;</span>);<br>       System.out.println(<span class="hljs-string">&quot;mapperPaths==========&quot;</span>);<br>       for (String mapperPath <span class="hljs-punctuation">:</span> mybatisConfiguration.getMapperPaths()) <span class="hljs-punctuation">&#123;</span><br>           System.out.println(mapperPath);<br>       <span class="hljs-punctuation">&#125;</span><br>       System.out.println(<span class="hljs-string">&quot;environments========&quot;</span>);<br>       for (MybatisEnvironment environment <span class="hljs-punctuation">:</span> mybatisConfiguration.getEnvironments()) <span class="hljs-punctuation">&#123;</span><br>           MybatisDataSource mybatisDataSource = environment.getMybatisDataSource();<br>           System.out.println(<span class="hljs-string">&quot;id:&quot;</span> + environment.getId()<br>           + <span class="hljs-string">&quot;,driver:&quot;</span> + mybatisDataSource.getDriver()<br>           + <span class="hljs-string">&quot;,url:&quot;</span> + mybatisDataSource.getUrl()<br>           + <span class="hljs-string">&quot;,username:&quot;</span> + mybatisDataSource.getUsername()<br>           + <span class="hljs-string">&quot;,password:&quot;</span> + mybatisDataSource.getPassword());<br>       <span class="hljs-punctuation">&#125;</span><br>       System.out.println(<span class="hljs-string">&quot;defaultEnvironment=======&quot;</span>);<br>       MybatisEnvironment defaultMybatisEnvironment = mybatisConfiguration.getDefaultMybatisEnvironment();<br>       MybatisDataSource mybatisDataSource = defaultMybatisEnvironment.getMybatisDataSource();<br>       System.out.println(<span class="hljs-string">&quot;id:&quot;</span> + defaultMybatisEnvironment.getId()<br>               + <span class="hljs-string">&quot;,driver:&quot;</span> + mybatisDataSource.getDriver()<br>               + <span class="hljs-string">&quot;,url:&quot;</span> + mybatisDataSource.getUrl()<br>               + <span class="hljs-string">&quot;,username:&quot;</span> + mybatisDataSource.getUsername()<br>               + <span class="hljs-string">&quot;,password:&quot;</span> + mybatisDataSource.getPassword());<br></code></pre></td></tr></table></figure><p>结果如下：</p><img src="/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E9%85%8D%E7%BD%AE%E9%A1%B9%E7%9A%84%E8%8E%B7%E5%8F%96/1.png" class=""><h3 id="mapperXml的解析"><a href="#mapperXml的解析" class="headerlink" title="mapperXml的解析"></a>mapperXml的解析</h3><p>首先添加一个MybatisSqlStatement</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.config;<br><br>import java.io.Serializable;<br><br>public class MybatisSqlStatement implements Serializable <span class="hljs-punctuation">&#123;</span><br>    private String namespace;<br><br>    private String id;<br><br>    private String sql;<br><br>    public String getNamespace() <span class="hljs-punctuation">&#123;</span><br>        return namespace;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setNamespace(String namespace) <span class="hljs-punctuation">&#123;</span><br>        this.namespace = namespace;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public String getId() <span class="hljs-punctuation">&#123;</span><br>        return id;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setId(String id) <span class="hljs-punctuation">&#123;</span><br>        this.id = id;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public String getSql() <span class="hljs-punctuation">&#123;</span><br>        return sql;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setSql(String sql) <span class="hljs-punctuation">&#123;</span><br>        this.sql = sql;<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>添加解析mapper文件的接口</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.config.parser;<br><br>import com.yang.mybatis.config.MybatisSqlStatement;<br><br>import java.util.List;<br><br>public interface IMybatisMapperParser <span class="hljs-punctuation">&#123;</span><br>    List&lt;MybatisSqlStatement&gt; parseMapper(String path);<br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>具体实现：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.config.parser;<br><br>import com.yang.mybatis.config.MybatisSqlStatement;<br>import org.dom4j.Document;<br>import org.dom4j.DocumentException;<br>import org.dom4j.Element;<br>import org.dom4j.io.SAXReader;<br><br>import java.io.InputStream;<br>import java.util.ArrayList;<br>import java.util.HashSet;<br>import java.util.List;<br>import java.util.Set;<br><br>public class XmlMybatisMapperParser implements IMybatisMapperParser <span class="hljs-punctuation">&#123;</span><br>    private final static Set&lt;String&gt; tagSet = new HashSet&lt;&gt;();<br><br>    static <span class="hljs-punctuation">&#123;</span><br>        tagSet.add(<span class="hljs-string">&quot;select&quot;</span>);<br>        tagSet.add(<span class="hljs-string">&quot;insert&quot;</span>);<br>        tagSet.add(<span class="hljs-string">&quot;update&quot;</span>);<br>        tagSet.add(<span class="hljs-string">&quot;delete&quot;</span>);<br>        tagSet.add(<span class="hljs-string">&quot;SELECT&quot;</span>);<br>        tagSet.add(<span class="hljs-string">&quot;INSERT&quot;</span>);<br>        tagSet.add(<span class="hljs-string">&quot;UPDATE&quot;</span>);<br>        tagSet.add(<span class="hljs-string">&quot;DELETE&quot;</span>);<br>    <span class="hljs-punctuation">&#125;</span><br>    @Override<br>    public List&lt;MybatisSqlStatement&gt; parseMapper(String path) <span class="hljs-punctuation">&#123;</span><br>        List&lt;MybatisSqlStatement&gt; mybatisSqlStatements = new ArrayList&lt;&gt;();<br>        try <span class="hljs-punctuation">&#123;</span><br>            InputStream inputStream = this.getClass().getClassLoader().getResourceAsStream(path);<br>            SAXReader saxReader = new SAXReader();<br>            Document document = saxReader.read(inputStream);<br>            Element root = document.getRootElement();<br><br>            for (String tag <span class="hljs-punctuation">:</span> tagSet) <span class="hljs-punctuation">&#123;</span><br>                List&lt;Element&gt; elements = root.elements(tag);<br>                parseStatement(mybatisSqlStatements<span class="hljs-punctuation">,</span> elements<span class="hljs-punctuation">,</span> root);<br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span> catch (DocumentException e) <span class="hljs-punctuation">&#123;</span><br>            e.printStackTrace();<br>        <span class="hljs-punctuation">&#125;</span><br>        return mybatisSqlStatements;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    private void parseStatement(List&lt;MybatisSqlStatement&gt; mybatisSqlStatements<span class="hljs-punctuation">,</span> List&lt;Element&gt; elements<span class="hljs-punctuation">,</span> Element root) <span class="hljs-punctuation">&#123;</span><br>        if (elements == <span class="hljs-literal"><span class="hljs-keyword">null</span></span> || elements.isEmpty()) <span class="hljs-punctuation">&#123;</span><br>            return;<br>        <span class="hljs-punctuation">&#125;</span><br>        String namespace = root.attributeValue(<span class="hljs-string">&quot;namespace&quot;</span>);<br>        for (Element element <span class="hljs-punctuation">:</span> elements) <span class="hljs-punctuation">&#123;</span><br>            String id = element.attributeValue(<span class="hljs-string">&quot;id&quot;</span>);<br>            String sql = element.getText().trim();<br><br>            MybatisSqlStatement mybatisSqlStatement = new MybatisSqlStatement();<br>            mybatisSqlStatement.setNamespace(namespace);<br>            mybatisSqlStatement.setId(id);<br>            mybatisSqlStatement.setSql(sql);<br><br>            mybatisSqlStatements.add(mybatisSqlStatement);<br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>然后，我们创建一个UserMapper.xml，用于测试，该文件内容如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;<br>&lt;!DOCTYPE mapper<br>        PUBLIC <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span><br>        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;<br><br><br>&lt;mapper namespace=<span class="hljs-string">&quot;com.yang.mybatis.test.IUserMapper&quot;</span>&gt;<br>    &lt;select id=<span class="hljs-string">&quot;queryUserName&quot;</span>&gt;<br>        select user_name from user where id = #<span class="hljs-punctuation">&#123;</span>id<span class="hljs-punctuation">&#125;</span><br>    &lt;/select&gt;<br>    &lt;select id=<span class="hljs-string">&quot;queryUserAge&quot;</span>&gt;<br>        select age from user where id = #<span class="hljs-punctuation">&#123;</span>id<span class="hljs-punctuation">&#125;</span><br>    &lt;/select&gt;<br>&lt;/mapper&gt;<br></code></pre></td></tr></table></figure><p>添加测试代码，进行测试：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json">public static void main(String<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> args) <span class="hljs-punctuation">&#123;</span><br>    IMybatisMapperParser mybatisMapperParser = new XmlMybatisMapperParser();<br>    List&lt;MybatisSqlStatement&gt; mybatisSqlStatements = mybatisMapperParser.parseMapper(<span class="hljs-string">&quot;mapper/UserMapper.xml&quot;</span>);<br>    for (MybatisSqlStatement mybatisSqlStatement <span class="hljs-punctuation">:</span> mybatisSqlStatements) <span class="hljs-punctuation">&#123;</span><br>        System.out.println(<span class="hljs-string">&quot;=================&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;namespace:&quot;</span> + mybatisSqlStatement.getNamespace());<br>        System.out.println(<span class="hljs-string">&quot;id:&quot;</span> + mybatisSqlStatement.getId());<br>        System.out.println(<span class="hljs-string">&quot;sql:&quot;</span> + mybatisSqlStatement.getSql());<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>结果如下：</p><img src="/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E9%85%8D%E7%BD%AE%E9%A1%B9%E7%9A%84%E8%8E%B7%E5%8F%96/2.png" class=""><h3 id="MapperProxyFactory注册Mapper"><a href="#MapperProxyFactory注册Mapper" class="headerlink" title="MapperProxyFactory注册Mapper"></a>MapperProxyFactory注册Mapper</h3><p>这里再修改一些MybatisConfiguration，因为mapperXML里的内容，其实我认为也属于配置项，因此收敛到MybatisConfiguration，方便后续统一管理</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.config;<br><br>import java.io.Serializable;<br>import java.util.ArrayList;<br>import java.util.HashMap;<br>import java.util.List;<br>import java.util.Map;<br><br>public class MybatisConfiguration implements Serializable <span class="hljs-punctuation">&#123;</span><br>    private Map&lt;String<span class="hljs-punctuation">,</span> MybatisEnvironment&gt; id2EnvironmentMap = new HashMap&lt;&gt;();<br><br>    private MybatisEnvironment defaultMybatisEnvironment;<br><br>    private List&lt;String&gt; mapperPaths = new ArrayList&lt;&gt;();<br><br>    private Map&lt;String<span class="hljs-punctuation">,</span> List&lt;MybatisSqlStatement&gt;&gt; mapper2SqlStatementsMap = new HashMap&lt;&gt;();<br><br>    public void putMybatisSqlStatementList(String mapperName<span class="hljs-punctuation">,</span> List&lt;MybatisSqlStatement&gt; mybatisSqlStatementList) <span class="hljs-punctuation">&#123;</span><br>        if (mapper2SqlStatementsMap.containsKey(mapperName)) <span class="hljs-punctuation">&#123;</span><br>            mapper2SqlStatementsMap.get(mapperName).addAll(mybatisSqlStatementList);<br>        <span class="hljs-punctuation">&#125;</span> else <span class="hljs-punctuation">&#123;</span><br>            mapper2SqlStatementsMap.put(mapperName<span class="hljs-punctuation">,</span> mybatisSqlStatementList);<br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><br>    public Map&lt;String<span class="hljs-punctuation">,</span> List&lt;MybatisSqlStatement&gt;&gt; getMapper2SqlStatementsMap() <span class="hljs-punctuation">&#123;</span><br>        return this.mapper2SqlStatementsMap;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void addEnvironment(String id<span class="hljs-punctuation">,</span> MybatisEnvironment mybatisEnvironment) <span class="hljs-punctuation">&#123;</span><br>        this.id2EnvironmentMap.put(id<span class="hljs-punctuation">,</span> mybatisEnvironment);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisEnvironment getEnvironment(String id) <span class="hljs-punctuation">&#123;</span><br>        return id2EnvironmentMap.get(id);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public MybatisEnvironment getDefaultMybatisEnvironment() <span class="hljs-punctuation">&#123;</span><br>        return defaultMybatisEnvironment;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void setDefaultMybatisEnvironment(MybatisEnvironment defaultMybatisEnvironment) <span class="hljs-punctuation">&#123;</span><br>        this.defaultMybatisEnvironment = defaultMybatisEnvironment;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public void addMapperPath(String mapperPath) <span class="hljs-punctuation">&#123;</span><br>        this.mapperPaths.add(mapperPath);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public List&lt;String&gt; getMapperPaths() <span class="hljs-punctuation">&#123;</span><br>        return this.mapperPaths;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public List&lt;MybatisEnvironment&gt; getEnvironments() <span class="hljs-punctuation">&#123;</span><br>        return new ArrayList&lt;&gt;(id2EnvironmentMap.values());<br>    <span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>然后修改MapperProxy，接收MybatisSqlStatement数组，在执行的时候，根据执行方法，找到对应的MybatisSqlStatement，获取mapper Xml对应的sql语句，并打印出来</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.mapper;<br><br>import com.yang.mybatis.config.MybatisSqlStatement;<br><br>import java.lang.reflect.InvocationHandler;<br>import java.lang.reflect.Method;<br>import java.util.HashMap;<br>import java.util.List;<br>import java.util.Map;<br><br>public class MapperProxy&lt;T&gt; implements InvocationHandler <span class="hljs-punctuation">&#123;</span><br>    private Map&lt;String<span class="hljs-punctuation">,</span> MybatisSqlStatement&gt; sqlSessionMap = new HashMap&lt;&gt;();<br><br>    private Class&lt;T&gt; mapperInterface;<br><br>    public MapperProxy(Class&lt;T&gt; mapperInterface<span class="hljs-punctuation">,</span> List&lt;MybatisSqlStatement&gt; mybatisSqlStatementList) <span class="hljs-punctuation">&#123;</span><br>        this.mapperInterface = mapperInterface;<br>        for (MybatisSqlStatement mybatisSqlStatement <span class="hljs-punctuation">:</span> mybatisSqlStatementList) <span class="hljs-punctuation">&#123;</span><br>            String mapperName = mybatisSqlStatement.getNamespace();<br>            String id = mybatisSqlStatement.getId();<br>            String key = mapperName + <span class="hljs-string">&quot;.&quot;</span> + id;<br>            sqlSessionMap.put(key<span class="hljs-punctuation">,</span> mybatisSqlStatement);<br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><br>    @Override<br>    public Object invoke(Object proxy<span class="hljs-punctuation">,</span> Method method<span class="hljs-punctuation">,</span> Object<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> args) throws Throwable <span class="hljs-punctuation">&#123;</span><br>        if (Object.class.equals(method.getDeclaringClass())) <span class="hljs-punctuation">&#123;</span><br>            return method.invoke(this<span class="hljs-punctuation">,</span> args);<br>        <span class="hljs-punctuation">&#125;</span><br>        String key = this.mapperInterface.getName() + <span class="hljs-string">&quot;.&quot;</span> + method.getName();<br>        return <span class="hljs-string">&quot;你的被代理了!&quot;</span> + sqlSessionMap.get(key).getSql();<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>接着修改MybatisProxyFactory，通过配置信息，加载对应的mapper.xml文件并进行解析</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.mapper;<br><br>import com.yang.mybatis.config.MybatisConfiguration;<br>import com.yang.mybatis.config.MybatisSqlStatement;<br><br>import java.lang.reflect.Proxy;<br>import java.util.HashMap;<br>import java.util.List;<br>import java.util.Map;<br><br>public class MapperProxyFactory <span class="hljs-punctuation">&#123;</span><br>    private Map&lt;Class<span class="hljs-punctuation">,</span> MapperProxy&gt; mapperProxyMap = new HashMap&lt;&gt;();<br><br><br>    public MapperProxyFactory(MybatisConfiguration mybatisConfiguration) <span class="hljs-punctuation">&#123;</span><br>        Map&lt;String<span class="hljs-punctuation">,</span> List&lt;MybatisSqlStatement&gt;&gt; mapperName2SqlStatementsMap = mybatisConfiguration.getMapper2SqlStatementsMap();<br>        mapperName2SqlStatementsMap.forEach((mapperName<span class="hljs-punctuation">,</span> sqlStatementList) -&gt; <span class="hljs-punctuation">&#123;</span><br>            try <span class="hljs-punctuation">&#123;</span><br>                Class&lt;?&gt; type = Class.forName(mapperName);<br>                mapperProxyMap.put(type<span class="hljs-punctuation">,</span> new MapperProxy(type<span class="hljs-punctuation">,</span> sqlStatementList));<br>            <span class="hljs-punctuation">&#125;</span> catch (ClassNotFoundException e) <span class="hljs-punctuation">&#123;</span><br>                throw new RuntimeException(e);<br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span>);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public Object newInstance(Class mapperType) <span class="hljs-punctuation">&#123;</span><br>        MapperProxy mapperProxy = mapperProxyMap.get(mapperType);<br>        return Proxy.newProxyInstance(mapperType.getClassLoader()<span class="hljs-punctuation">,</span><br>                new Class<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">&#123;</span>mapperType<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                mapperProxy);<br>    <span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>添加测试方法，进行测试：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs json">public static void main(String<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> args) <span class="hljs-punctuation">&#123;</span><br>        IMybatisConfigurationParser iMybatisConfigurationParser = new XmlMybatisConfigurationParser();<br>        MybatisConfiguration mybatisConfiguration = iMybatisConfigurationParser.parser(<span class="hljs-string">&quot;mybatis-config.xml&quot;</span>);<br><br>        IMybatisMapperParser iMybatisMapperParser = new XmlMybatisMapperParser();<br>        List&lt;String&gt; mapperPaths = mybatisConfiguration.getMapperPaths();<br>        for (String mapperPath <span class="hljs-punctuation">:</span> mapperPaths) <span class="hljs-punctuation">&#123;</span><br>            List&lt;MybatisSqlStatement&gt; mybatisSqlStatements = iMybatisMapperParser.parseMapper(mapperPath);<br>            Map&lt;String<span class="hljs-punctuation">,</span> List&lt;MybatisSqlStatement&gt;&gt; mapperNameGroupMap = mybatisSqlStatements.stream()<br>                    .collect(Collectors.groupingBy(MybatisSqlStatement<span class="hljs-punctuation">:</span><span class="hljs-punctuation">:</span>getNamespace));<br><br>            for (Map.Entry&lt;String<span class="hljs-punctuation">,</span> List&lt;MybatisSqlStatement&gt;&gt; entry <span class="hljs-punctuation">:</span> mapperNameGroupMap.entrySet()) <span class="hljs-punctuation">&#123;</span><br>                String mapperName = entry.getKey();<br>                List&lt;MybatisSqlStatement&gt; sqlSessionList = entry.getValue();<br>                mybatisConfiguration.putMybatisSqlStatementList(mapperName<span class="hljs-punctuation">,</span> sqlSessionList);<br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br><br>        MapperProxyFactory mapperProxyFactory = new MapperProxyFactory(mybatisConfiguration);<br>        IUserMapper userMapper = (IUserMapper) mapperProxyFactory.newInstance(IUserMapper.class);<br>        System.out.println(userMapper.queryUserName(<span class="hljs-number">1</span>));<br>    <span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>测试结果如下：</p><img src="/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E9%85%8D%E7%BD%AE%E9%A1%B9%E7%9A%84%E8%8E%B7%E5%8F%96/3.png" class=""><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="https://zhuanlan.zhihu.com/p/338300626">https://zhuanlan.zhihu.com/p/338300626</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>-Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>手撸Mybatis（一）——代理mapper</title>
    <link href="/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E2%80%94%E4%BB%A3%E7%90%86mapper/"/>
    <url>/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E2%80%94%E4%BB%A3%E7%90%86mapper/</url>
    
    <content type="html"><![CDATA[<h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>最近刚写完毕设，闲来无事，看到网上有一个手撸Mybatis的教程，于是想自己实现一个简易版的Mybatis。</p><h3 id="创建简单的映射器代理工厂"><a href="#创建简单的映射器代理工厂" class="headerlink" title="创建简单的映射器代理工厂"></a>创建简单的映射器代理工厂</h3><p>在使用mybatis的时候，我们一般只需要定义mapper的接口，并添加相应的@Mapper注解，然后实现对应的xml文件即可，而不需要对mapper接口进行具体的实现。其实本质上，这些mapper接口是有实现的，但不是我们手动通过implement来实现，而是通过代理的方式进行实现。因此，对于Mybatis的手撸，首先要关注的，就是如何对mapper进行代理。<br>首先我们定义一个MapperProxy，该类实现InvocationHandler接口，通过实现该接口，实现动态代理。这里有两个属性——sqlSession和mapperInterface，其中，sqlSession是用来模拟执行sql语句的。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.proxy;<br><br>import java.lang.reflect.InvocationHandler;<br>import java.lang.reflect.Method;<br>import java.util.Map;<br><br>public class MapperProxy&lt;T&gt; implements InvocationHandler <span class="hljs-punctuation">&#123;</span><br>    private Map&lt;String<span class="hljs-punctuation">,</span> Object&gt; sqlSession ;<br><br>    private Class&lt;T&gt; mapperInterface;<br><br>    public MapperProxy(Map&lt;String<span class="hljs-punctuation">,</span> Object&gt; sqlSession<span class="hljs-punctuation">,</span> Class&lt;T&gt; mapperInterface) <span class="hljs-punctuation">&#123;</span><br>        this.sqlSession = sqlSession;<br>        this.mapperInterface = mapperInterface;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    @Override<br>    public Object invoke(Object proxy<span class="hljs-punctuation">,</span> Method method<span class="hljs-punctuation">,</span> Object<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> args) throws Throwable <span class="hljs-punctuation">&#123;</span><br>        if (Object.class.equals(method.getDeclaringClass())) <span class="hljs-punctuation">&#123;</span><br>            return method.invoke(this<span class="hljs-punctuation">,</span> args);<br>        <span class="hljs-punctuation">&#125;</span><br>        String key = this.mapperInterface.getName() + <span class="hljs-string">&quot;.&quot;</span> + method.getName();<br>        return sqlSession.get(key);<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>当我们在执行mapper的某个方法时，最终会进入到invoke方法，并通过sqlSession来获取模拟值。<br>接着我们定义MapperProxyFactory，每一个mapper都有一个MapperProxyFactory与之相对于，然后newInstance方法接收模拟的sql结果，并通过Proxy.newProxyInstance创建动态代理对象。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.proxy;<br><br>import java.lang.reflect.Proxy;<br>import java.util.Map;<br><br>public class MapperProxyFactory &lt;T&gt; <span class="hljs-punctuation">&#123;</span><br>    private final Class&lt;T&gt; mapperInterface;<br><br>    public MapperProxyFactory(Class&lt;T&gt; mapperInterface) <span class="hljs-punctuation">&#123;</span><br>        this.mapperInterface = mapperInterface;<br>    <span class="hljs-punctuation">&#125;</span><br><br>    public T newInstance(Map&lt;String<span class="hljs-punctuation">,</span> Object&gt; sqlSession) <span class="hljs-punctuation">&#123;</span><br>        MapperProxy&lt;T&gt; mapperProxy = new MapperProxy&lt;&gt;(sqlSession<span class="hljs-punctuation">,</span> mapperInterface);<br>        return (T) Proxy.newProxyInstance(mapperInterface.getClassLoader()<span class="hljs-punctuation">,</span><br>                new Class<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">&#123;</span>mapperInterface<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                mapperProxy);<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>最后，我们先创建一个IUserMapper类</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.test;<br><br>public interface IUserMapper <span class="hljs-punctuation">&#123;</span><br>        String queryUserName(Integer id);<br><br>        Integer queryUserAge(Integer id);<br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>然后创建对应的测试方法</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.test;<br><br>import com.yang.mybatis.proxy.MapperProxyFactory;<br><br>import java.util.HashMap;<br>import java.util.Map;<br><br>public class Main <span class="hljs-punctuation">&#123;</span><br>    public static void main(String<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> args) <span class="hljs-punctuation">&#123;</span><br>        MapperProxyFactory&lt;IUserMapper&gt; userDaoMapperProxyFactory = new MapperProxyFactory&lt;&gt;(IUserMapper.class);<br>        Map&lt;String<span class="hljs-punctuation">,</span> Object&gt; sqlSession = new HashMap&lt;&gt;();<br>        sqlSession.put(<span class="hljs-string">&quot;com.yang.mybatis.test.IUserMapper.queryUserName&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;模拟查询用户名&quot;</span>);<br>        sqlSession.put(<span class="hljs-string">&quot;com.yang.mybatis.test.IUserMapper.queryUserAge&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span>);<br>        IUserMapper iUserMapper = userDaoMapperProxyFactory.newInstance(sqlSession);<br>        System.out.println(iUserMapper.queryUserAge(<span class="hljs-number">1</span>));<br>        System.out.println(iUserMapper.queryUserName(<span class="hljs-number">1</span>));<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>运行结果如下：</p><img src="/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E2%80%94%E4%BB%A3%E7%90%86mapper/1.png" class=""><h3 id="实现映射器的注册和使用"><a href="#实现映射器的注册和使用" class="headerlink" title="实现映射器的注册和使用"></a>实现映射器的注册和使用</h3><p>像上述的这种方法，我们每次要获取一个Mapper，就要new一个对应的MapperProxyFactory，这样不太方便。一般情况下，mapper是放在同一个包下的，那么我们可以通过扫描包，来初始化MapperProxyFactory。至于上一节的sqlSession，因为我们目前是模拟数据，所以在初始化过程中，把这些模拟数据要随便mock住就行。<br>因为要扫描包获取包下的Class类，我们先添加hutool-all，以便通过其提供的ClassScanner获取包</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">&lt;dependency&gt;<br>         &lt;groupId&gt;cn.hutool&lt;/groupId&gt;<br>         &lt;artifactId&gt;hutool-all&lt;/artifactId&gt;<br>         &lt;version&gt;<span class="hljs-number">5.8</span><span class="hljs-number">.12</span>&lt;/version&gt;<br>     &lt;/dependency&gt;<br></code></pre></td></tr></table></figure><p>然后，我们修改MapperProxyFactory</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.yang.mybatis.proxy;<br><br>import cn.hutool.core.lang.ClassScanner;<br><br>import java.lang.reflect.Method;<br>import java.lang.reflect.Proxy;<br>import java.util.HashMap;<br>import java.util.Map;<br>import java.util.Set;<br><br>public class MapperProxyFactory <span class="hljs-punctuation">&#123;</span><br>    private Map&lt;Class<span class="hljs-punctuation">,</span> MapperProxy&gt; mapperProxyMap = new HashMap&lt;&gt;();<br><br>    public MapperProxyFactory(String packageName) <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-comment">// 扫描包</span><br>        ClassScanner scanner = new ClassScanner(packageName);<br>        Set&lt;Class&lt;?&gt;&gt; mapperTypes = scanner.scan();<br>        for (Class&lt;?&gt; mapperType <span class="hljs-punctuation">:</span> mapperTypes) <span class="hljs-punctuation">&#123;</span><br>            if (!mapperType.isInterface()) <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-comment">// 只对接口进行处理</span><br>                continue;<br>            <span class="hljs-punctuation">&#125;</span><br><br>            Map&lt;String<span class="hljs-punctuation">,</span> String&gt; mockSqlSession = mockSqlSession(mapperType);<br>            MapperProxy mapperProxy = new MapperProxy(mockSqlSession<span class="hljs-punctuation">,</span> mapperType);<br>            mapperProxyMap.put(mapperType<span class="hljs-punctuation">,</span> mapperProxy);<br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><br>    public Object newInstance(Class mapperType) <span class="hljs-punctuation">&#123;</span><br>        MapperProxy mapperProxy = mapperProxyMap.get(mapperType);<br>        return Proxy.newProxyInstance(mapperType.getClassLoader()<span class="hljs-punctuation">,</span><br>                new Class<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">&#123;</span>mapperType<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                mapperProxy);<br>    <span class="hljs-punctuation">&#125;</span><br><br>    private Map&lt;String<span class="hljs-punctuation">,</span> String&gt; mockSqlSession(Class mapperType) <span class="hljs-punctuation">&#123;</span><br>        Map&lt;String<span class="hljs-punctuation">,</span> String&gt; sqlSession = new HashMap&lt;&gt;();<br>        for (Method method <span class="hljs-punctuation">:</span> mapperType.getMethods()) <span class="hljs-punctuation">&#123;</span><br>            String methodName = method.getName();<br>            String key = mapperType.getName() + <span class="hljs-string">&quot;.&quot;</span> + methodName;<br>            sqlSession.put(key<span class="hljs-punctuation">,</span> key);<br>        <span class="hljs-punctuation">&#125;</span><br>        return sqlSession;<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>最后进行测试：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">public static void main(String<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span> args) <span class="hljs-punctuation">&#123;</span><br>      MapperProxyFactory mapperProxyFactory = new MapperProxyFactory(<span class="hljs-string">&quot;com.yang.mybatis.test&quot;</span>);<br>      IUserMapper iUserMapper = (IUserMapper) mapperProxyFactory.newInstance(IUserMapper.class);<br>      System.out.println(iUserMapper.queryUserName(<span class="hljs-number">1</span>));<br>  <span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>测试结果如下：</p><img src="/2024/05/05/%E6%89%8B%E6%92%B8Mybatis%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E2%80%94%E4%BB%A3%E7%90%86mapper/2.png" class="">]]></content>
    
    
    
    <tags>
      
      <tag>-Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringSecurity学习2—SpringSecurity授权</title>
    <link href="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/"/>
    <url>/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/</url>
    
    <content type="html"><![CDATA[<h3 id="1-引言"><a href="#1-引言" class="headerlink" title="1. 引言"></a>1. 引言</h3><p>Spring Security进行认证和鉴权的时候，就是利用一系列的Filter来进行拦截的。如下图所示，一个请求想要访问到API就会从左到右经过蓝线框里的过滤器，其中黄色部分是负责认证的过滤器，蓝色部分负责异常处理，橙色部分则是负责授权。经过一些列拦截最终访问到我们的API。</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/1.png" class=""><p>这里需要重点关注两个过滤器：UsernamePasswordAuthenticationFilter负责登录认证，FilterSecurityInterceptor负责权限授权。<br>在SpringSecurity中，会使用默认的FilterSecurityInterceptor来进行权限校验，在FilterSecurityInterceptor中会从SecurityContextHolder获取其中的Authentication，然后获取其中的权限信息，判断当前用户是否拥有访问当前资源所需的权限。<br>SpringSecurity中的Authentication类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Authentication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Principal</span>, Serializable &#123;<br><span class="hljs-comment">//权限数据列表</span><br>    Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities();<br><br>    Object <span class="hljs-title function_">getCredentials</span><span class="hljs-params">()</span>;<br><br>    Object <span class="hljs-title function_">getDetails</span><span class="hljs-params">()</span>;<br><br>    Object <span class="hljs-title function_">getPrincipal</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAuthenticated</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAuthenticated</span><span class="hljs-params">(<span class="hljs-type">boolean</span> var1)</span> <span class="hljs-keyword">throws</span> IllegalArgumentException;<br>&#125;<br></code></pre></td></tr></table></figure><p>Principal: 用户信息，没有认证时一般是用户名，认证后一般是用户对象<br>Credentials: 用户凭证，一般是密码<br>Authorities: 用户权限</p><h3 id="2-代码示例"><a href="#2-代码示例" class="headerlink" title="2. 代码示例"></a>2. 代码示例</h3><p>将权限信息，赋值给UserDetails<br>在我们之前自定义的UserContextDetails中，已经有对应的权限信息了，因此，我们可以将其权限信息，转化为对应的Authority类，我们修改MyUserDetails类，将UserContextDetails中和权限相关的类，转化为SpringSecurity体系中的权限类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.infrastructure.security;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.PermissionDetails;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.UserContextDetails;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> org.springframework.security.core.GrantedAuthority;<br><span class="hljs-keyword">import</span> org.springframework.security.core.authority.AuthorityUtils;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<br><span class="hljs-keyword">import</span> org.springframework.util.CollectionUtils;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.Collection;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyUserDetails</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetails</span> &#123;<br>    <span class="hljs-keyword">private</span> UserContextDetails userContextDetails;<br><br>    <span class="hljs-keyword">private</span> String password;<br><br>    <span class="hljs-keyword">private</span> List&lt;GrantedAuthority&gt; authorityList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyUserDetails</span><span class="hljs-params">(UserContextDetails userContextDetails)</span> &#123;<br>        <span class="hljs-built_in">this</span>.userContextDetails = userContextDetails;<br>        richAuthority();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">richAuthority</span><span class="hljs-params">()</span> &#123;<br>        List&lt;PermissionDetails&gt; permissionDetails = userContextDetails.getPermissionDetails();<br>        <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(permissionDetails)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        String[] permissions = permissionDetails.stream().map(PermissionDetails::getName)<br>                .collect(Collectors.toList()).toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">0</span>]);<br>        <span class="hljs-built_in">this</span>.authorityList = AuthorityUtils.createAuthorityList(permissions);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyUserDetails</span><span class="hljs-params">(UserContextDetails userContextDetails, String password)</span> &#123;<br>        <span class="hljs-built_in">this</span>.userContextDetails = userContextDetails;<br>        <span class="hljs-built_in">this</span>.password = password;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.authorityList;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.password;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> userContextDetails.getUsername();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnabled</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后还需要修改JwtTokenVerifyFilter类，在构建UsernamePasswordAuthenticationToken的时候，将权限赋值上去。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.infrastructure.security.filter;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.yang.domain.data.Role;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.PermissionDetails;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.UserContextDetails;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.config.JwtTokenProperty;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.request.JwtTokenVerifyRequest;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.response.JwtTokenVerifyDTO;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.service.JwtTokenService;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.security.MyUserDetails;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.utils.RedisUtils;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.utils.SpringContextUtils;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;<br><span class="hljs-keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<br><span class="hljs-keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;<br><br><span class="hljs-keyword">import</span> javax.servlet.FilterChain;<br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtTokenVerifyFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OncePerRequestFilter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;token&quot;</span>);<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(token)) &#123;<br>            filterChain.doFilter(request, response);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-type">UserContextDetails</span> <span class="hljs-variable">userContextDetails</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">userDetailsFromRedis</span> <span class="hljs-operator">=</span> getUserDetailsFromRedis(token);<br>        <span class="hljs-keyword">if</span> (userDetailsFromRedis != <span class="hljs-literal">null</span>) &#123;<br>            userContextDetails = (UserContextDetails) userDetailsFromRedis;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (userContextDetails == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">JwtTokenService</span> <span class="hljs-variable">jwtTokenService</span> <span class="hljs-operator">=</span> SpringContextUtils.getBeanOfType(JwtTokenService.class);<br>            <span class="hljs-type">JwtTokenProperty</span> <span class="hljs-variable">jwtTokenProperty</span> <span class="hljs-operator">=</span> SpringContextUtils.getBeanOfType(JwtTokenProperty.class);<br><br>            <span class="hljs-type">JwtTokenVerifyRequest</span> <span class="hljs-variable">jwtTokenVerifyRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtTokenVerifyRequest</span>();<br>            jwtTokenVerifyRequest.setToken(token);<br>            jwtTokenVerifyRequest.setSecret(jwtTokenProperty.getSecret());<br><br>            <span class="hljs-type">JwtTokenVerifyDTO</span> <span class="hljs-variable">verify</span> <span class="hljs-operator">=</span> jwtTokenService.verify(jwtTokenVerifyRequest);<br>            <span class="hljs-keyword">if</span> (verify == <span class="hljs-literal">null</span>) &#123;<br>                filterChain.doFilter(request, response);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            userContextDetails = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserContextDetails</span>();<br>            userContextDetails.setId(Integer.valueOf(verify.getSubject()));<br>            userContextDetails.setToken(token);<br>            userContextDetails.setUsername(verify.getPayLoads().get(<span class="hljs-string">&quot;username&quot;</span>));<br>            userContextDetails.setExtendMap(verify.getPayLoads());<br>            List&lt;Role&gt; roles = JSONObject.parseArray(verify.getPayLoads().get(<span class="hljs-string">&quot;roles&quot;</span>), Role.class);<br>            userContextDetails.setPermissionDetails(roles.stream().map(role -&gt; &#123;<br>                <span class="hljs-type">PermissionDetails</span> <span class="hljs-variable">permissionDetails</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PermissionDetails</span>();<br>                permissionDetails.setName(role.getCode());<br>                <span class="hljs-keyword">return</span> permissionDetails;<br>            &#125;).collect(Collectors.toList()));<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (userContextDetails == <span class="hljs-literal">null</span>) &#123;<br>            filterChain.doFilter(request, response);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-type">UserDetails</span> <span class="hljs-variable">userDetails</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyUserDetails</span>(userContextDetails);<br>        <span class="hljs-type">UsernamePasswordAuthenticationToken</span> <span class="hljs-variable">authenticationToken</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(userDetails, <span class="hljs-literal">null</span>, userDetails.getAuthorities());<br>        SecurityContextHolder.getContext().setAuthentication(authenticationToken);<br>        filterChain.doFilter(request, response);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">getUserDetailsFromRedis</span><span class="hljs-params">(String token)</span> &#123;<br>        <span class="hljs-type">RedisUtils</span> <span class="hljs-variable">redisUtils</span> <span class="hljs-operator">=</span> SpringContextUtils.getBeanOfType(RedisUtils.class);<br>        <span class="hljs-keyword">return</span> redisUtils.getKey(<span class="hljs-string">&quot;token:&quot;</span> + token);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-2-URL层面的授权"><a href="#2-2-URL层面的授权" class="headerlink" title="2.2. URL层面的授权"></a>2.2. URL层面的授权</h4><p>在配置类中，http.authorizeRequests()主要是对url进行控制，配置顺序会影响之后授权的效果，越是具体的应该放前面，越是笼统的应该放后面。<br>anyRequest(): 表示匹配所有的请求，一般情况下此方法都会使用，设置全部内容都需要进行认证，会放到最后。<br>antMatchers：参数是不定向参数，每个参数是一个ant表达式，用于匹配URL规则。</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">ANT 通配符说明<br>? 匹配任何单字符<br><span class="hljs-bullet">* </span>匹配0或者任意数量的字符<br><span class="hljs-bullet">** </span>匹配0或者更多的目录<br></code></pre></td></tr></table></figure><p>假设我们对&#x2F;security&#x2F;permitAll可以免认证，配置为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">http.authorizeRequests<br>.antMatchers(<span class="hljs-string">&quot;/security/permitAll&quot;</span>).permitAll()<br></code></pre></td></tr></table></figure><p>在上述配置中，我们在antMatchers(“&#x2F;security&#x2F;permitAll”)后调用了permitAll()表示不需要认证，随意访问，在SpringSecurity中提供了多种内置控制。</p><h5 id="2-2-1-直接授权"><a href="#2-2-1-直接授权" class="headerlink" title="2.2.1. 直接授权"></a>2.2.1. 直接授权</h5><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>permitAll()</td><td>所匹配的 URL ,任何人都允许访问</td></tr><tr><td>denyAll()</td><td>所匹配的 URL, 任何人都不允许被访问</td></tr><tr><td>authenticated()</td><td>所匹配的 URL ,任何人 都需要被认证才能访问</td></tr><tr><td>anonymous()</td><td>表示可以匿名访问匹配的 URL。和 permitAll()效果类似，只是设置为 anonymous()的 url 会执行 filter 链中</td></tr><tr><td>rememberMe()</td><td>被“remember me”的用户允许访问</td></tr><tr><td>fullyAuthenticated()</td><td>如果用户不是被 remember me ,才可以访问。</td></tr></tbody></table><p>anonymouse和permitAll的区别：前者表示匿名访问，仅允许匿名用户访问，如果登录认证后，带有token信息再去请求，这个anonymouse关联的资源就不能访问；permitAll登录能访问，不登陆也能返回，一般用于静态资源js等。<br>假设我们的SpringSecurity配置如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.infrastructure.security.config;<br><br><span class="hljs-keyword">import</span> com.yang.infrastructure.security.filter.JwtTokenVerifyFilter;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.security.handler.JwtAccessDeniedExceptionHandler;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.security.handler.JwtAuthenticationExceptionHandler;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;<br><span class="hljs-keyword">import</span> org.springframework.security.web.SecurityFilterChain;<br><span class="hljs-keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;<br><br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableWebSecurity</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    SecurityFilterChain <span class="hljs-title function_">filterChain</span><span class="hljs-params">(HttpSecurity httpSecurity)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        httpSecurity.headers().cacheControl(); <span class="hljs-comment">// 禁用缓存</span><br>        <span class="hljs-comment">// 登录和注册接口，放行</span><br>        <span class="hljs-keyword">return</span> httpSecurity.authorizeRequests()<br>                .antMatchers(<span class="hljs-string">&quot;/user/login&quot;</span>).permitAll()<br>                .antMatchers(<span class="hljs-string">&quot;/user/register&quot;</span>).permitAll()<br>                .antMatchers(<span class="hljs-string">&quot;/security/permitAll&quot;</span>).permitAll()<br>                .antMatchers(<span class="hljs-string">&quot;/security/anonymous&quot;</span>).anonymous()<br>                .anyRequest().authenticated()<br>                .and()<br>                .csrf().disable()<br>                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS) <span class="hljs-comment">// 设置无状态连接，即不创建session</span><br>                .and()<br>                .cors().disable() <span class="hljs-comment">// 解决跨域问题</span><br>                .exceptionHandling()<br>                .authenticationEntryPoint(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtAuthenticationExceptionHandler</span>()) <span class="hljs-comment">// 未认证异常处理</span><br>                .accessDeniedHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtAccessDeniedExceptionHandler</span>()) <span class="hljs-comment">// 权限不足异常处理</span><br>                .and()<br>                .addFilterBefore(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtTokenVerifyFilter</span>(), UsernamePasswordAuthenticationFilter.class) <span class="hljs-comment">// 添加自定义过滤器</span><br>                .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里对登录、注册、permitAll接口放行，对anonymouse接口允许匿名访问。然后我们添加对应的controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.controller;<br><br><span class="hljs-keyword">import</span> com.yang.infrastructure.common.Response;<br><span class="hljs-keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(value = &quot;/security&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">UserDetails</span>  <span class="hljs-variable">userDetails</span> <span class="hljs-operator">=</span> (UserDetails) SecurityContextHolder.getContext().getAuthentication().getPrincipal();<br>        System.out.println(userDetails);<br>        <span class="hljs-keyword">return</span> Response.success(<span class="hljs-string">&quot;hello&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/anonymous&quot;)</span><br>    <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">anonymous</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Response.success(<span class="hljs-string">&quot;anonymous&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/permitAll&quot;)</span><br>    <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">permitAll</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Response.success(<span class="hljs-string">&quot;permitAll&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>运行项目，进行测试，在未登录的情况下，访问anonymous和permitAll接口：</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/2.png" class=""><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/3.png" class=""><p>在登录情况下访问anonymous和permitAll</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/4.png" class=""><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/5.png" class=""><h5 id="2-2-2-权限授权"><a href="#2-2-2-权限授权" class="headerlink" title="2.2.2. 权限授权"></a>2.2.2. 权限授权</h5><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>hasAuthority(String authorities)</td><td>拥有指定权限的用户可以访问</td></tr><tr><td>hasAnyAuthority(String… authorities)</td><td>拥有指定任一权限的用户可访问</td></tr></tbody></table><p>我们修改SpringSecurity的配置，添加下面的权限信息：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">.antMatchers(<span class="hljs-string">&quot;/security/student&quot;</span>)<br>.hasAuthority(<span class="hljs-string">&quot;STUDENT&quot;</span>)<br>.antMatchers(<span class="hljs-string">&quot;/security/studentOrCounselor&quot;</span>)<br>.hasAnyAuthority(<span class="hljs-string">&quot;STUDENT&quot;</span>, <span class="hljs-string">&quot;COUNSELOR&quot;</span>)<br></code></pre></td></tr></table></figure><p>然后添加相应的测试接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(value = &quot;/student&quot;)</span><br><span class="hljs-keyword">public</span> Response <span class="hljs-title function_">student</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> Response.success(<span class="hljs-string">&quot;学生可以访问&quot;</span>);<br>&#125;<br><br><span class="hljs-meta">@GetMapping(value = &quot;/studentOrCounselor&quot;)</span><br><span class="hljs-keyword">public</span> Response <span class="hljs-title function_">studentOrCounselor</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> Response.success(<span class="hljs-string">&quot;学生或辅导员可以访问&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>接着，使用学生账号访问上面两个接口：</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/6.png" class=""><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/7.png" class=""><p>使用辅导员账号访问上面两个接口</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/8.png" class=""><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/9.png" class=""><h5 id="2-2-3-角色授权"><a href="#2-2-3-角色授权" class="headerlink" title="2.2.3. 角色授权"></a>2.2.3. 角色授权</h5><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>hasRole(String role)</td><td>拥有指定角色的用户可以访问,角色将被增加ROLE_前缀</td></tr><tr><td>hasAnyRoles(String… roles)</td><td>拥有指定任一角色的用户可访问</td></tr></tbody></table><p>这个功能和基于权限认证感觉差不多，只是我们在设置Authority的时候，要加上ROLE_前缀，不然匹配不上，这里就不做演示了。</p><h4 id="2-3-基于注解进行权限校验"><a href="#2-3-基于注解进行权限校验" class="headerlink" title="2.3. 基于注解进行权限校验"></a>2.3. 基于注解进行权限校验</h4><p>在SpringSecurity中，可以通过使用注解的方式进行权限校验，以下是一些常用的SpringSecurity注解：<br>1）@PreAuthorize和@ PostAuthorize: 用于方法安全性，可以定义方法执行前或执行后的权限校验。前者用于方法执行前，可以根据表达式判断是否有权限执行该方法，后者用于方法执行后，可以检测方法执行的结果是否有权限。<br>2）@Secured：该注解用于方法或类上，要求用户具有所有的指定角色。<br>3）@PermitAll：用于方法或类上，表示该方法对所有用户开放，无需权限即可访问。<br>4）@DenyAll：用于方法或类上，表示该方法对所有用户都不可访问。<br>5）@Authenticated：用于方法上，表示用户需要被认证（即已经通过身份验证）。<br>上述这些注解，SpringSecurity会利用表达式进行动态权限校验，其中可以使用hasRole、hasAuthority、hasAnyRole、hasAnyAuthority等方法来判断用户角色或权限。<br>在方法的权限控制上，SpringSecurity支持三种类型的注解，JSR-250注解，@Secured注解和表达式的注解，这三种注解默认都没有启动，需要通过@EnableGlobalMethodSecurity来启用，这些注解都可以卸载Service接口或方法上，也可以写到Controller或Controller的方法上。</p><h5 id="2-3-1-表达式的注解"><a href="#2-3-1-表达式的注解" class="headerlink" title="2.3.1. 表达式的注解"></a>2.3.1. 表达式的注解</h5><p>我们以PreAuthorize注解为例，首先，要在配置类中开启注解，在配置类上，加上下面这行代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span><br></code></pre></td></tr></table></figure><p>然后，我们添加两个接口，用于测试PreAuthorize注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PreAuthorize(value = &quot;hasAuthority(&#x27;STUDENT&#x27;)&quot;)</span><br>  <span class="hljs-meta">@GetMapping(value = &quot;/permitStudent&quot;)</span><br>  <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">permitStudent</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> Response.success(<span class="hljs-string">&quot;学生才有权限&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-meta">@PreAuthorize(value = &quot;hasAnyAuthority(&#x27;STUDENT&#x27;, &#x27;COUNSELOR&#x27;)&quot;)</span><br>  <span class="hljs-meta">@GetMapping(value = &quot;/permitStudentAndCounselor&quot;)</span><br>  <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">permitStudentAndCounselor</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> Response.success(<span class="hljs-string">&quot;学生和辅导员才有权限&quot;</span>);<br>  &#125;<br></code></pre></td></tr></table></figure><p>使用学生账号，访问上面两个接口：</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/10.png" class=""><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/11.png" class=""><p>使用辅导员账号访问上面两个接口：</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/12.png" class=""><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/13.png" class=""><h5 id="2-3-2-JSR-250注解"><a href="#2-3-2-JSR-250注解" class="headerlink" title="2.3.2. JSR-250注解"></a>2.3.2. JSR-250注解</h5><p>首先，修改SpringSecurity配置类，在刚才的基础上，开启jsr-250注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled = true, jsr250Enabled = true)</span><br></code></pre></td></tr></table></figure><p>然后添加一个接口，用于测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PermitAll</span><br> <span class="hljs-meta">@GetMapping(value = &quot;/jsr250PermitAll&quot;)</span><br> <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">jsr250PermitAll</span><span class="hljs-params">()</span> &#123;<br>     <span class="hljs-keyword">return</span> Response.success(<span class="hljs-string">&quot;jsr250PermitAll&quot;</span>);<br> &#125;<br></code></pre></td></tr></table></figure><p>首先，分别使用不同权限的用户登录token，访问该接口，结果如下：</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/14.png" class=""><p>然后，不携带token访问该接口（未登录状态下访问接口）：</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/15.png" class=""><p>这里会被拦截，原因是会先经过FilterSecurityInterceptor过滤器，利用匿名的认证用户进行投票决策，此时vote返回-1（因为没有匹配到当前url，只能匹配authenticated)，默认AffirmativeBased决策下就会直接抛出AccessDeniedException，因此就不会今日到MethodSecurityInterceptor的判断逻辑，必须认证之后才行。debug过程如下：<br>首先会浸入FilterSecurityInterceptor过滤器：</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/16.png" class=""><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/17.png" class=""><p>此时使用的是匿名的认证用户，进行投票决策</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/18.png" class=""><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/19.png" class=""><p>因为没有匹配到当前url，智能匹配authenticated，因此vote返回-1</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/20.png" class=""><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/21.png" class=""><p>最后，抛出AccessDeniedException异常</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/22.png" class=""><h5 id="2-3-3-Secured注解"><a href="#2-3-3-Secured注解" class="headerlink" title="2.3.3. Secured注解"></a>2.3.3. Secured注解</h5><p>首先，修改SpringSecurity的配置类，开启Secured注解的支持。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled = true, jsr250Enabled = true, securedEnabled = true)</span><br></code></pre></td></tr></table></figure><p>Secured是专门用来判断是否具有角色的，参数要以ROLE开头，不过我们之前设置的权限，如STUDENT、COUNSELOR都没有以ROLE开头，我们先修改一些MyUserDetails类的richAuthority，加上ROLE前缀。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">richAuthority</span><span class="hljs-params">()</span> &#123;<br>      List&lt;PermissionDetails&gt; permissionDetails = userContextDetails.getPermissionDetails();<br>      <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(permissionDetails)) &#123;<br>          <span class="hljs-keyword">return</span>;<br>      &#125;<br>      String[] permissions = permissionDetails.stream().map(permission -&gt; <span class="hljs-string">&quot;ROLE_&quot;</span> + permission.getName())<br>              .collect(Collectors.toList()).toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">0</span>]);<br>      <span class="hljs-built_in">this</span>.authorityList = AuthorityUtils.createAuthorityList(permissions);<br>  &#125;<br></code></pre></td></tr></table></figure><p>然后添加测试方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Secured(value = &quot;ROLE_STUDENT&quot;)</span><br>   <span class="hljs-meta">@GetMapping(value = &quot;/securedStudent&quot;)</span><br>   <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">securedStudent</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-keyword">return</span> Response.success(<span class="hljs-string">&quot;securedStudent&quot;</span>);<br>   &#125;<br></code></pre></td></tr></table></figure><p>分别用学生账号和辅导员账号访问该接口，结果如下：</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/23.png" class=""><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A02%E2%80%94SpringSecurity%E6%8E%88%E6%9D%83/24.png" class=""><h3 id="3-参考文章"><a href="#3-参考文章" class="headerlink" title="3. 参考文章"></a>3. 参考文章</h3><p><a href="https://blog.csdn.net/weixin_46073538/article/details/128641746">https://blog.csdn.net/weixin_46073538/article/details/128641746</a><br><a href="https://blog.csdn.net/qq_41071876/article/details/122086856">https://blog.csdn.net/qq_41071876/article/details/122086856</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>SpringBoot</tag>
      
      <tag>SpringSecurity</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringSecurity学习1—SpringSecurity认证</title>
    <link href="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A01%E2%80%94SpringSecurity%E8%AE%A4%E8%AF%81/"/>
    <url>/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A01%E2%80%94SpringSecurity%E8%AE%A4%E8%AF%81/</url>
    
    <content type="html"><![CDATA[<h3 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h3><p>Spring Security是一个用于包含应用程序安全性的Java框架，它提供了一套全面的安全解决方案，包括身份验证、授权、防止攻击等功能。它基于过滤器链的概念，可以轻松地集成到任何基于Spring的应用程序中，它支持多种身份验证选项和授权策略，此外，还提供一些附加功能，如集成第三方身份验证提供商和单点登录，以及会话管理和密码编码等。</p><h3 id="2-SpringBoot整合SpringSecurity"><a href="#2-SpringBoot整合SpringSecurity" class="headerlink" title="2. SpringBoot整合SpringSecurity"></a>2. SpringBoot整合SpringSecurity</h3><h4 id="2-1-引言"><a href="#2-1-引言" class="headerlink" title="2.1. 引言"></a>2.1. 引言</h4><p>代码实现，基于前两章提到的登录、注册和鉴权项目，这里将使用SpringSecurity框架，逐步替代前两章自定义的认证授权实现。首先，注释掉WebMvcConfiguration类，去除该类对我们后续使用SpringSecurity的影响。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//package com.yang.infrastructure.configuration;</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//import com.yang.infrastructure.auth.interceptors.JwtTokenVerifyInterceptor;</span><br><span class="hljs-comment">//import com.yang.infrastructure.auth.interceptors.PermissionVerifyInterceptor;</span><br><span class="hljs-comment">//import org.springframework.context.annotation.Configuration;</span><br><span class="hljs-comment">//import org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="hljs-comment">//import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//@Configuration</span><br><span class="hljs-comment">//public class WebMvcConfiguration implements WebMvcConfigurer &#123;</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//    @Override</span><br><span class="hljs-comment">//    public void addInterceptors(InterceptorRegistry registry) &#123;</span><br><span class="hljs-comment">//        registry.addInterceptor(new JwtTokenVerifyInterceptor())</span><br><span class="hljs-comment">//                .addPathPatterns(&quot;/**&quot;) // 拦截所有请求</span><br><span class="hljs-comment">//                .excludePathPatterns(&quot;/user/login&quot;, &quot;/user/register&quot;); // 排除登录、注册接口</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//        PermissionVerifyInterceptor permissionVerifyInterceptor = new PermissionVerifyInterceptor();</span><br><span class="hljs-comment">//        permissionVerifyInterceptor.addPermission(&quot;STUDENT&quot;, &quot;/student/needPermission&quot;);</span><br><span class="hljs-comment">//        permissionVerifyInterceptor.addPermission(&quot;COUNSELOR&quot;, &quot;/counselor/*&quot;);</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//        registry.addInterceptor(permissionVerifyInterceptor)</span><br><span class="hljs-comment">//                .addPathPatterns(&quot;/**&quot;) // 拦截所有请求</span><br><span class="hljs-comment">//                .excludePathPatterns(&quot;/user/login&quot;, &quot;/user/register&quot;); // 排除登录、注册接口</span><br><span class="hljs-comment">//    &#125;</span><br><span class="hljs-comment">//&#125;</span><br></code></pre></td></tr></table></figure><h4 id="2-2-SpringSecurity完整流程"><a href="#2-2-SpringSecurity完整流程" class="headerlink" title="2.2. SpringSecurity完整流程"></a>2.2. SpringSecurity完整流程</h4><p>SpringSecurity功能的实现主要是一系列过滤器链相互配合完成的</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A01%E2%80%94SpringSecurity%E8%AE%A4%E8%AF%81/1.png" class=""><p>SecurityContextPersistenceFilter：整个拦截过程的入口和出口（也就是第一个和最后一个拦截器），会在请求开始时从配置后的SecurityContextRepository中获取SecurityContext，然后把它设置给SecurityContextHolder，请求完成后将SecurityContextHolder持有的SecurityContext再保存到配置后的SecurityContextRepository，同时清除SecurityContextHolder所持有的SecurityContext；<br>UsernamePasswordAuthenticationFilter：用于处理来自表单提交的认证，该表单必须提供对应的用户名和密码，其内部还有登录成功或失败后进行处理的AuthenticationSuccessHandler和AuthenticationFailureHandler，这些都可以根据需求做相关改变；<br>Filter Security Interceptor：用于保护web资源，使用AccessDecisionManager对当前用户进行授权访问；<br>ExceptionTranslationFilter：捕获来着FilterChain所有的异常，并进行处理，但它只会处理两类异常：AuthenticationException和AccessDeniedException，其他异常会继续抛出。</p><h4 id="2-3-认证流程"><a href="#2-3-认证流程" class="headerlink" title="2.3. 认证流程"></a>2.3. 认证流程</h4><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A01%E2%80%94SpringSecurity%E8%AE%A4%E8%AF%81/2.png" class=""><p>AuthenticationManager：定义认证Authentication的方法<br>UserDetailsService：加载用户特定数据的核心接口，里面定义了一个根据用户名查询用户信息的方法<br>UserDetails接口：提供核心用户信息，通过UserDetailsService根据用户名获取处理的用户信息，要封装成UserDetails对象返回，然后将这些信息封装到Authentication对象中。<br>入门案例<br>引入依赖<br>首先，我们引入SpringSecurity的依赖</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependency&gt;<br>           &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>           &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;<br>       &lt;/dependency&gt;<br></code></pre></td></tr></table></figure><p>然后定义一个测试接口，用于测试SpringSecurity：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.controller;<br><br><span class="hljs-keyword">import</span> com.yang.infrastructure.common.Response;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(value = &quot;/security&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Response.success(<span class="hljs-string">&quot;hello&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>启动项目，访问&#x2F;security&#x2F;hello接口，此时会跳转到登录界面</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A01%E2%80%94SpringSecurity%E8%AE%A4%E8%AF%81/3.png" class=""><p>在控制台中，我们可以看到如下内容</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A01%E2%80%94SpringSecurity%E8%AE%A4%E8%AF%81/4.png" class=""><p>我们使用user用户名，以及控制台中的密码，在表单提交登录,此时便会跳转到登录成功页面。</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A01%E2%80%94SpringSecurity%E8%AE%A4%E8%AF%81/5.png" class=""><h4 id="2-4-2-UserDetailsService"><a href="#2-4-2-UserDetailsService" class="headerlink" title="2.4.2. UserDetailsService"></a>2.4.2. UserDetailsService</h4><p>在每次启动项目的时候，我们查看控制台时，总是能看到下面生成了一串UUID字符串</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A01%E2%80%94SpringSecurity%E8%AE%A4%E8%AF%81/6.png" class=""><p>这是因为在默认情况下，SpringSecurity自动化地帮我们完成以下三件事情：<br>1）开启FormLogin登录认证模式：假设我们还没有登录，然后访问&#x2F;security&#x2F;hello测试接口，那么请求会被重定向到页面&#x2F;login，提示使用用户名和密码登录。<br>2）生成用于登录的用户名和密码：用户名是user，密码就是上面启动日志中随机生成的字符串<br>3）注册用于认证和鉴权的过滤器：SpringSecurity本质就是通过过滤器或过滤器（链）实现的，每一个接口请求都会按顺序经过这些过滤器的“过滤”，每个过滤器承担各自的职责，组合起来共同完成认证和鉴权，根据配置的不同，注册的过滤器有所不同。<br>使用默认用户名和随机密码的方式不够灵活，因此，我们可以实现SpringSecurity提供的UserDetailsService接口。这里先介绍SpringSecurity预置的两种常见的存储介质实现：<br>1）InMemoryUserDetailsManager：基于内存的实现<br>2）JdbcUserDetailsManager：基于数据库的实现<br>我们介绍以下InMemoryUserDetailsManager，我们创建用户实例和InMemoryUserDetailsManager实例，并使用@Bean将InMemoryUserDetailsManager实例注入到SpringSecurity中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> UserDetailsManager <span class="hljs-title function_">users</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">UserDetails</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> User.builder()<br>                .username(<span class="hljs-string">&quot;cxy&quot;</span>)<br>                .password(<span class="hljs-string">&quot;&#123;bcrypt&#125;$2a$10$CrPsv1X3hM&quot;</span> +<br>                        <span class="hljs-string">&quot;.giwVZyNsrKuaRvpJZyGQycJg78xT7Dm68K4DWN/lxS&quot;</span>) <span class="hljs-comment">// 使用Bcrypt算法加密</span><br>                .roles(<span class="hljs-string">&quot;USER&quot;</span>)<br>                .build();<br><br>        <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>        manager.createUser(user);<br>        <span class="hljs-keyword">return</span> manager;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>重新启动项目，访问测试接口&#x2F;security&#x2F;hello，用户名输入cxy，密码输入123456</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A01%E2%80%94SpringSecurity%E8%AE%A4%E8%AF%81/7.png" class=""><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A01%E2%80%94SpringSecurity%E8%AE%A4%E8%AF%81/8.png" class=""><p>JdbcUserDetailsManager的实现与InMemoryUserDetailsManager类似，这里就不赘述了。<br>除了上面这两种内置实现，我们还可以自定义UserDetailsService的实现。但这里不进行介绍，因为UserDetailsService是基于表单认证这种模式的，而有时候，我们的登录方式、登录页面与它提供的又不一样，因此，我们下面会讲到，如何接入我们自定义的登录接口，登录方式。</p><h4 id="2-4-3-登录和注册放行"><a href="#2-4-3-登录和注册放行" class="headerlink" title="2.4.3. 登录和注册放行"></a>2.4.3. 登录和注册放行</h4><p>上面这种整合方式，会对所有的请求进行拦截，但是一般情况下，我们是不拦截用户登录和用户注册接口的，而且现在的项目一般是前后端分离，没必要跳转到专门的登录页面。<br>这里使用的springboot版本是2.7.0，在Spring Boot 2.7.0之前的版本中，我们需要写个配置类继承WebSecurityConfigurerAdapter，然后重写Adapter中的三个方法进行配置，如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableWebSecurity</span><br><span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OldSecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UmsAdminService adminService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity httpSecurity)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//省略HttpSecurity的配置</span><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        auth.userDetailsService(userDetailsService())<br>                .passwordEncoder(passwordEncoder());<br>    &#125;<br>    <br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> AuthenticationManager <span class="hljs-title function_">authenticationManagerBean</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.authenticationManagerBean();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>但这种方式在SpringBoot 2.7.0中，WebSecurityConfigurerAdapter已经被弃用了，新用法中，无需继承WebSecurityConfigurerAdapter，只需要直接声明一个配置类，再配置一个生成SecurityFilterChainBean方法，配置信息如下，我们对&#x2F;user&#x2F;login和&#x2F;user&#x2F;register接口，进行放行，而其他接口，都需要进行验证。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.infrastructure.auth.config;<br><br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;<br><span class="hljs-keyword">import</span> org.springframework.security.web.SecurityFilterChain;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    SecurityFilterChain <span class="hljs-title function_">filterChain</span><span class="hljs-params">(HttpSecurity httpSecurity)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 登录和注册接口，放行</span><br>        <span class="hljs-keyword">return</span> httpSecurity.authorizeRequests()<br>                .antMatchers(<span class="hljs-string">&quot;/user/login&quot;</span>).permitAll()<br>                .antMatchers(<span class="hljs-string">&quot;/user/register&quot;</span>).permitAll()<br>                .anyRequest().authenticated()<br>                .and()<br>                .csrf().disable()<br>                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS) <span class="hljs-comment">// 设置无状态连接，即不创建session</span><br>                .and()<br>                .cors().disable() <span class="hljs-comment">// 解决跨域问题</span><br>                .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>http.authorizeHttpRequests(): 指定哪些请求需要什么样的认证或授权，这里使用anyRequest()和authenticated()表示所有请求均需要认证。<br>http.authorizeHttpRequests()：表示我们使用HttpBasic认证。<br>在上面的配置中，我们配置了登录接口和注册接口允许放行，其他接口进行拦截，然后我们访问登录接口，可以看出登录接口放行通过，能顺利访问。</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A01%E2%80%94SpringSecurity%E8%AE%A4%E8%AF%81/9.png" class=""><p>再访问&#x2F;security&#x2F;hello接口，结果是403，说明无权访问。</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A01%E2%80%94SpringSecurity%E8%AE%A4%E8%AF%81/10.png" class=""><h5 id="2-4-4-异常处理"><a href="#2-4-4-异常处理" class="headerlink" title="2.4.4. 异常处理"></a>2.4.4. 异常处理</h5><p>在最开始的时候，我们没有配置任何东西时，没有权限便会默认跳转到用户登录界面，现在因为我们没有配置登录表单路径，所以会直接提示403，我们可以在配置类中，配置异常处理方式，方便返回一些格式化的数据供前端做出决策。<br>我们创建一个JwtAuthenticationExceptionHandler，该类实现自AuthenticationEntryPoint接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtAuthenticationExceptionHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthenticationEntryPoint</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commence</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        sendErrorResponse(response);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendErrorResponse</span><span class="hljs-params">(HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Response&lt;Object&gt; errorResponse = Response.fail(ResultCode.AUTHENTICATION_FAIL);<br>        response.setCharacterEncoding(<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        response.setStatus(HttpStatus.UNAUTHORIZED.value());<br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>        writer.write(JSONObject.toJSONString(errorResponse));<br>        writer.flush();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后我们修改SpringSecurity的配置类，添加上和异常处理相关的配置：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    SecurityFilterChain <span class="hljs-title function_">filterChain</span><span class="hljs-params">(HttpSecurity httpSecurity)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 登录和注册接口，放行</span><br>        <span class="hljs-keyword">return</span> httpSecurity.authorizeRequests()<br>                .antMatchers(<span class="hljs-string">&quot;/user/login&quot;</span>).permitAll()<br>                .antMatchers(<span class="hljs-string">&quot;/user/register&quot;</span>).permitAll()<br>                .anyRequest().authenticated()<br>                .and()<br>                .csrf().disable()<br>                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS) <span class="hljs-comment">// 设置无状态连接，即不创建session</span><br>                .and()<br>                .cors().disable() <span class="hljs-comment">// 解决跨域问题</span><br>                .exceptionHandling()<br>                .authenticationEntryPoint(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtAuthenticationExceptionHandler</span>()) <span class="hljs-comment">// 未认证异常处理</span><br>                .and()<br>                .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>接着再次访问&#x2F;security&#x2F;hello接口，结果如下：</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A01%E2%80%94SpringSecurity%E8%AE%A4%E8%AF%81/11.png" class=""><p>同理，在权限不足的情况下，我们也可以实现相关的异常处理类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtAccessDeniedExceptionHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AccessDeniedHandler</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        sendErrorResponse(response);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendErrorResponse</span><span class="hljs-params">(HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Response&lt;Object&gt; errorResponse = Response.fail(ResultCode.ACCESS_DENIED);<br>        response.setCharacterEncoding(<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        response.setStatus(HttpStatus.UNAUTHORIZED.value());<br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>        writer.write(JSONObject.toJSONString(errorResponse));<br>        writer.flush();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>修改配置类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    SecurityFilterChain <span class="hljs-title function_">filterChain</span><span class="hljs-params">(HttpSecurity httpSecurity)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 登录和注册接口，放行</span><br>        <span class="hljs-keyword">return</span> httpSecurity.authorizeRequests()<br>                .antMatchers(<span class="hljs-string">&quot;/user/login&quot;</span>).permitAll()<br>                .antMatchers(<span class="hljs-string">&quot;/user/register&quot;</span>).permitAll()<br>                .anyRequest().authenticated()<br>                .and()<br>                .csrf().disable()<br>                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS) <span class="hljs-comment">// 设置无状态连接，即不创建session</span><br>                .and()<br>                .cors().disable() <span class="hljs-comment">// 解决跨域问题</span><br>                .exceptionHandling()<br>                .authenticationEntryPoint(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtAuthenticationExceptionHandler</span>()) <span class="hljs-comment">// 未认证异常处理</span><br>                .accessDeniedHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtAccessDeniedExceptionHandler</span>()) <span class="hljs-comment">// 权限不足异常处理</span><br>                .and()<br>                .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="2-4-5-认证过滤器"><a href="#2-4-5-认证过滤器" class="headerlink" title="2.4.5. 认证过滤器"></a>2.4.5. 认证过滤器</h5><p>当我们登录成功后，一般会返回一个token，然后前端后续将这个token，携带于请求头，想后端发起访问，后端解析这个token，来判断该请求是否认证通过，通过，则放行。在SpringSecurity中，我们可以通过addFilterBefore()将我们自定义过滤器添加上去，然后再我们的自定义过滤器中，实现相关的token解析逻辑。<br>首先我们定义一个MyUserDetails类，实现UserDetails接口，UserDetails提供用户的核心信息，在前两篇文章中，用户的核心信息，存储于UserContextDetails类中，这里我们沿用该类，当然，也可以自己重新定义一个类用于保存用户的核心信息，甚至直接把用户实体类作为核心信息，这个依据项目的需要。目前的实现中，除了获取用户名之外，其他都是空实现，因为其他的接口，暂时还不需要。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.infrastructure.security;<br><br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.UserContextDetails;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> org.springframework.security.core.GrantedAuthority;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<br><br><span class="hljs-keyword">import</span> java.util.Collection;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyUserDetails</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetails</span> &#123;<br>    <span class="hljs-keyword">private</span> UserContextDetails userContextDetails;<br><br>    <span class="hljs-keyword">private</span> String password;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyUserDetails</span><span class="hljs-params">(UserContextDetails userContextDetails)</span> &#123;<br>        <span class="hljs-built_in">this</span>.userContextDetails = userContextDetails;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyUserDetails</span><span class="hljs-params">(UserContextDetails userContextDetails, String password)</span> &#123;<br>        <span class="hljs-built_in">this</span>.userContextDetails = userContextDetails;<br>        <span class="hljs-built_in">this</span>.password = password;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.password;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> userContextDetails.getUsername();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnabled</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>我们我们添加一个JwtTokenVerifyFilter，这个类继承于OncePerRequestFilter，其具体实现如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.infrastructure.security.filter;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.yang.domain.data.Role;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.PermissionDetails;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.UserContextDetails;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.config.JwtTokenProperty;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.request.JwtTokenVerifyRequest;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.response.JwtTokenVerifyDTO;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.service.JwtTokenService;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.security.MyUserDetails;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.utils.RedisUtils;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.utils.SpringContextUtils;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;<br><span class="hljs-keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<br><span class="hljs-keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;<br><br><span class="hljs-keyword">import</span> javax.servlet.FilterChain;<br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtTokenVerifyFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OncePerRequestFilter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;token&quot;</span>);<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(token)) &#123;<br>            filterChain.doFilter(request, response);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-type">UserContextDetails</span> <span class="hljs-variable">userContextDetails</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">userDetailsFromRedis</span> <span class="hljs-operator">=</span> getUserDetailsFromRedis(token);<br>        <span class="hljs-keyword">if</span> (userDetailsFromRedis != <span class="hljs-literal">null</span>) &#123;<br>            userContextDetails = (UserContextDetails) userDetailsFromRedis;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (userContextDetails == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">JwtTokenService</span> <span class="hljs-variable">jwtTokenService</span> <span class="hljs-operator">=</span> SpringContextUtils.getBeanOfType(JwtTokenService.class);<br>            <span class="hljs-type">JwtTokenProperty</span> <span class="hljs-variable">jwtTokenProperty</span> <span class="hljs-operator">=</span> SpringContextUtils.getBeanOfType(JwtTokenProperty.class);<br><br>            <span class="hljs-type">JwtTokenVerifyRequest</span> <span class="hljs-variable">jwtTokenVerifyRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtTokenVerifyRequest</span>();<br>            jwtTokenVerifyRequest.setToken(token);<br>            jwtTokenVerifyRequest.setSecret(jwtTokenProperty.getSecret());<br><br>            <span class="hljs-type">JwtTokenVerifyDTO</span> <span class="hljs-variable">verify</span> <span class="hljs-operator">=</span> jwtTokenService.verify(jwtTokenVerifyRequest);<br>            <span class="hljs-keyword">if</span> (verify == <span class="hljs-literal">null</span>) &#123;<br>                filterChain.doFilter(request, response);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            userContextDetails = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserContextDetails</span>();<br>            userContextDetails.setId(Integer.valueOf(verify.getSubject()));<br>            userContextDetails.setToken(token);<br>            userContextDetails.setUsername(verify.getPayLoads().get(<span class="hljs-string">&quot;username&quot;</span>));<br>            userContextDetails.setExtendMap(verify.getPayLoads());<br>            List&lt;Role&gt; roles = JSONObject.parseArray(verify.getPayLoads().get(<span class="hljs-string">&quot;roles&quot;</span>), Role.class);<br>            userContextDetails.setPermissionDetails(roles.stream().map(role -&gt; &#123;<br>                <span class="hljs-type">PermissionDetails</span> <span class="hljs-variable">permissionDetails</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PermissionDetails</span>();<br>                permissionDetails.setName(role.getCode());<br>                <span class="hljs-keyword">return</span> permissionDetails;<br>            &#125;).collect(Collectors.toList()));<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (userContextDetails == <span class="hljs-literal">null</span>) &#123;<br>            filterChain.doFilter(request, response);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-type">UserDetails</span> <span class="hljs-variable">userDetails</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyUserDetails</span>(userContextDetails);<br>        <span class="hljs-type">UsernamePasswordAuthenticationToken</span> <span class="hljs-variable">authenticationToken</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(userDetails, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>        SecurityContextHolder.getContext().setAuthentication(authenticationToken);<br>        filterChain.doFilter(request, response);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">getUserDetailsFromRedis</span><span class="hljs-params">(String token)</span> &#123;<br>        <span class="hljs-type">RedisUtils</span> <span class="hljs-variable">redisUtils</span> <span class="hljs-operator">=</span> SpringContextUtils.getBeanOfType(RedisUtils.class);<br>        <span class="hljs-keyword">return</span> redisUtils.getKey(<span class="hljs-string">&quot;token:&quot;</span> + token);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>其实从上面的实现中，会发现，与我们之前的JwtTokenVerifyInterceptor很像，不过我们当时只是简单地通过线程上下文来传递用户核心信息，而SpringSecurity对此进一步作出封装:<br>1）UsernamePasswordAuthenticationToken：SpringSecurity用于表示基于用户名和密码地身份验证对象，继承自AbstractAuthenticationToken类，包含了用户名和密码等凭据信息，在身份验证过程中，UsernamePasswordAuthenticationToken用于封装用户提交地身份验证凭据，并在后续身份验证过程中进行传递和处理。<br>2）SecurityContextHolder：SpringSecurity用于管理安全上下文地持有者，提供一个静态方法getContext()用于获取当前线程中地安全上下文。<br>最后，我们将这个过滤器，添加到SpringSecurity的配置类中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    SecurityFilterChain <span class="hljs-title function_">filterChain</span><span class="hljs-params">(HttpSecurity httpSecurity)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 登录和注册接口，放行</span><br>        <span class="hljs-keyword">return</span> httpSecurity.authorizeRequests()<br>                .antMatchers(<span class="hljs-string">&quot;/user/login&quot;</span>).permitAll()<br>                .antMatchers(<span class="hljs-string">&quot;/user/register&quot;</span>).permitAll()<br>                .anyRequest().authenticated()<br>                .and()<br>                .csrf().disable()<br>                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS) <span class="hljs-comment">// 设置无状态连接，即不创建session</span><br>                .and()<br>                .cors().disable() <span class="hljs-comment">// 解决跨域问题</span><br>                .exceptionHandling()<br>                .authenticationEntryPoint(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtAuthenticationExceptionHandler</span>()) <span class="hljs-comment">// 未认证异常处理</span><br>                .accessDeniedHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtAccessDeniedExceptionHandler</span>()) <span class="hljs-comment">// 权限不足异常处理</span><br>                .and()<br>                .addFilterBefore(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtTokenVerifyFilter</span>(), UsernamePasswordAuthenticationFilter.class) <span class="hljs-comment">// 添加自定义过滤器</span><br>                .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后我们启动项目，先进行登录</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A01%E2%80%94SpringSecurity%E8%AE%A4%E8%AF%81/12.png" class=""><p>登录成功后，携带该token，作为请求头，访问&#x2F;security&#x2F;hello测试接口,访问成功</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A01%E2%80%94SpringSecurity%E8%AE%A4%E8%AF%81/13.png" class=""><p>然后我们携带一个无效的token，作为请求头，再次访问&#x2F;security&#x2F;hello测试接口</p><img src="/2024/04/03/SpringSecurity%E5%AD%A6%E4%B9%A01%E2%80%94SpringSecurity%E8%AE%A4%E8%AF%81/14.png" class=""><h3 id="3-参考文章"><a href="#3-参考文章" class="headerlink" title="3. 参考文章"></a>3. 参考文章</h3><p><a href="https://segmentfault.com/a/1190000041947192">https://segmentfault.com/a/1190000041947192</a><br><a href="https://blog.csdn.net/m0_37989980/article/details/107519382">https://blog.csdn.net/m0_37989980/article/details/107519382</a><br><a href="https://zhuanlan.zhihu.com/p/455858001">https://zhuanlan.zhihu.com/p/455858001</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>SpringBoot</tag>
      
      <tag>SpringSecurity</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>鉴权学习</title>
    <link href="/2024/04/03/%E9%89%B4%E6%9D%83%E5%AD%A6%E4%B9%A0/"/>
    <url>/2024/04/03/%E9%89%B4%E6%9D%83%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<h3 id="1-引言"><a href="#1-引言" class="headerlink" title="1. 引言"></a>1. 引言</h3><p>鉴权指身份认证授权，在计算机安全领域，是指验证一个实体的身份并决定这个实体是否被授权执行某项任务的过程，简单来说，就是确认一个用户或者系统是否拥有进行某项操作的权权利。<br>鉴权通常包含两个方面：<br>1）身份认证（Authentication）：确定一个用户或实体是否为其声称的个体。这通常通过用户名和密码、生物特征识别、智能卡等方式实现。我们在上一篇提到的内容，就属于身份认证的相关内容。<br>2）授权（Authorization）：在身份被确认之后，鉴权系统还会检查该用户是否有权限执行特定的操作。例如，一个用户可能有权访问某个系统，但没有权限修改数据。<br>我们在上一章登录、注册学习的基础上，添加一个权限表和一个用户权限表。</p><img src="/2024/04/03/%E9%89%B4%E6%9D%83%E5%AD%A6%E4%B9%A0/1.png" class=""><img src="/2024/04/03/%E9%89%B4%E6%9D%83%E5%AD%A6%E4%B9%A0/2.png" class=""><p>以大学为例，一般有学生、辅导员、教务员、讲师、教授等身份，如下图所示：</p><img src="/2024/04/03/%E9%89%B4%E6%9D%83%E5%AD%A6%E4%B9%A0/3.png" class=""><h3 id="2-修改用户注册"><a href="#2-修改用户注册" class="headerlink" title="2. 修改用户注册"></a>2. 修改用户注册</h3><p>对于每个用户，都应该有对应的权限，用户和权限的关系，可以是一对多的，比如在大学内，一个人，既可以是学生，也可以是辅导员，比如兼职辅导员；既可以是讲师，也可以是班主任。因此，我们修改用户注册接口，在新增用户的同时，添加用户的权限。</p><h4 id="2-1-infrastructure层"><a href="#2-1-infrastructure层" class="headerlink" title="2.1. infrastructure层"></a>2.1. infrastructure层</h4><p>修改UserContextDetails类，加上用户权限信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserContextDetails</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> Integer id;<br><br>    <span class="hljs-keyword">private</span> String token;<br><br>    <span class="hljs-keyword">private</span> String username;<br><br>    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; extendMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-comment">// 权限</span><br>    <span class="hljs-keyword">private</span> List&lt;PermissionDetails&gt; permissionDetails = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>&#125;<br></code></pre></td></tr></table></figure><p>修改JwtTokenVerifyInterceptor类，在获取UserContextDetails时，填充用户权限信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>       <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;token&quot;</span>);<br>       <span class="hljs-keyword">if</span> (StringUtils.isEmpty(token)) &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.TOKEN_FAILED);<br>       &#125;<br>       <span class="hljs-type">Object</span> <span class="hljs-variable">userDetails</span> <span class="hljs-operator">=</span> getUserDetailsFromRedis(token);<br>       <span class="hljs-keyword">if</span> (userDetails != <span class="hljs-literal">null</span>) &#123; <span class="hljs-comment">// 判断该token在Redis是否存在</span><br>           <span class="hljs-comment">// 设置线程上下文</span><br>           System.out.println(<span class="hljs-string">&quot;设置线程上下文====================&quot;</span>);<br>           <span class="hljs-type">UserContextDetails</span> <span class="hljs-variable">userContextDetails</span> <span class="hljs-operator">=</span> (UserContextDetails) userDetails;<br>           userContextDetails.setToken(token);<br>           UserContextThreadLocal.setUserContextDetails(userContextDetails);<br>           <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>       &#125;<br><br>       <span class="hljs-type">JwtTokenService</span> <span class="hljs-variable">jwtTokenService</span> <span class="hljs-operator">=</span> SpringContextUtils.getBeanOfType(JwtTokenService.class);<br>       <span class="hljs-type">JwtTokenProperty</span> <span class="hljs-variable">jwtTokenProperty</span> <span class="hljs-operator">=</span> SpringContextUtils.getBeanOfType(JwtTokenProperty.class);<br><br>       <span class="hljs-type">JwtTokenVerifyRequest</span> <span class="hljs-variable">jwtTokenVerifyRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtTokenVerifyRequest</span>();<br>       jwtTokenVerifyRequest.setToken(token);<br>       jwtTokenVerifyRequest.setSecret(jwtTokenProperty.getSecret());<br><br>       <span class="hljs-type">JwtTokenVerifyDTO</span> <span class="hljs-variable">verify</span> <span class="hljs-operator">=</span> jwtTokenService.verify(jwtTokenVerifyRequest);<br>       <span class="hljs-keyword">if</span> (verify == <span class="hljs-literal">null</span>) &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.TOKEN_FAILED);<br>       &#125;<br><br>       <span class="hljs-comment">// 设置线程上下文</span><br>       System.out.println(<span class="hljs-string">&quot;设置线程上下文====================&quot;</span>);<br>       <span class="hljs-type">UserContextDetails</span> <span class="hljs-variable">userContextDetails</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserContextDetails</span>();<br>       userContextDetails.setId(Integer.valueOf(verify.getSubject()));<br>       userContextDetails.setToken(token);<br>       userContextDetails.setUsername(verify.getPayLoads().get(<span class="hljs-string">&quot;username&quot;</span>));<br>       userContextDetails.setExtendMap(verify.getPayLoads());<br>       List&lt;Role&gt; roles = JSONObject.parseArray(verify.getPayLoads().get(<span class="hljs-string">&quot;roles&quot;</span>), Role.class);<br>       userContextDetails.setPermissionDetails(roles.stream().map(role -&gt; &#123;<br>           <span class="hljs-type">PermissionDetails</span> <span class="hljs-variable">permissionDetails</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PermissionDetails</span>();<br>           permissionDetails.setName(role.getCode());<br>           <span class="hljs-keyword">return</span> permissionDetails;<br>       &#125;).collect(Collectors.toList()));<br>       UserContextThreadLocal.setUserContextDetails(userContextDetails);<br>       <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="2-2-domain层"><a href="#2-2-domain层" class="headerlink" title="2.2. domain层"></a>2.2. domain层</h4><p>添加Role和UserRole相关的实体类、存储类、领域服务类，这里不贴代码了，比较简单。<br>添加RoleEnum枚举类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.domain.common;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">RoleEnum</span> &#123;<br>    STUDENT(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;STUDENT&quot;</span>),<br>    COUNSELOR(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;COUNSELOR&quot;</span>),<br>    ACADEMIC_ADMINISTRATOR(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;ACADEMIC_ADMINISTRATOR&quot;</span>);<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> code;<br><br>    <span class="hljs-keyword">private</span> String description;<br><br>    RoleEnum(<span class="hljs-type">int</span> code, String description) &#123;<br>        <span class="hljs-built_in">this</span>.code = code;<br>        <span class="hljs-built_in">this</span>.description = description;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.code;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDescription</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.description;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> RoleEnum <span class="hljs-title function_">findByCode</span><span class="hljs-params">(<span class="hljs-type">int</span> code)</span> &#123;<br>        <span class="hljs-keyword">for</span> (RoleEnum role : values()) &#123;<br>            <span class="hljs-keyword">if</span> (role.getCode() == code) &#123;<br>                <span class="hljs-keyword">return</span> role;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>修改user实体类，加上权限列表属性</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName(value = &quot;t_user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span><br>    <span class="hljs-keyword">private</span> Integer id;<br><br>    <span class="hljs-keyword">private</span> String username;<br><br>    <span class="hljs-keyword">private</span> String password;<br><br>    <span class="hljs-keyword">private</span> String salt;<br><br>    <span class="hljs-comment">// 是否冻结 0未冻结 1已冻结</span><br>    <span class="hljs-keyword">private</span> Integer freeze;<br><br>    <span class="hljs-keyword">private</span> Date createTime;<br><br>    <span class="hljs-keyword">private</span> Date updateTime;<br><br>    <span class="hljs-meta">@TableField(exist = false)</span><br>    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; featuresMap;<br><br>    <span class="hljs-keyword">private</span> String features;<br><br>    <span class="hljs-meta">@TableField(exist = false)</span><br>    <span class="hljs-keyword">private</span> List&lt;Role&gt; roles;<br>&#125;<br></code></pre></td></tr></table></figure><p>修改userRepository，在获取用户的时候，填充用户的权限信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Repository</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepository</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IUserRepository</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IUserRoleRepository userRoleRepository;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IRoleRepository roleRepository;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">UN_FREEZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">FREEZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(User user)</span> &#123;<br>        user.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        user.setUpdateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        user.setFreeze(UN_FREEZE);<br>        user.setFeaturesMap(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;());<br>        user.setFeatures(JSONObject.toJSONString(user.getFeaturesMap()));<br>        <span class="hljs-keyword">return</span> userMapper.insert(user) &gt; <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findByUsernameAndPassword</span><span class="hljs-params">(String username, String password)</span> &#123;<br>        LambdaQueryWrapper&lt;User&gt; queryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>        queryWrapper.eq(User::getUsername, username);<br>        queryWrapper.eq(User::getPassword, password);<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectOne(queryWrapper);<br>        <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) &#123;<br>            user.setRoles(findRoleByUserId(user.getId()));<br>        &#125;<br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findByUsername</span><span class="hljs-params">(String username)</span> &#123;<br>        LambdaQueryWrapper&lt;User&gt; queryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>        queryWrapper.eq(User::getUsername, username);<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectOne(queryWrapper);<br>        <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) &#123;<br>            user.setRoles(findRoleByUserId(user.getId()));<br>        &#125;<br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findById</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectById(id);<br>        <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) &#123;<br>            user.setRoles(findRoleByUserId(user.getId()));<br>        &#125;<br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> &#123;<br>        user.setUpdateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        <span class="hljs-keyword">return</span> userMapper.updateById(user) &gt; <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> List&lt;Role&gt; <span class="hljs-title function_">findRoleByUserId</span><span class="hljs-params">(Integer userId)</span> &#123;<br>        List&lt;UserRole&gt; userRoles = userRoleRepository.findUserRoleByUserId(userId);<br>        <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(userRoles)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        &#125;<br>        List&lt;Integer&gt; roleIdList = userRoles.stream().map(UserRole::getRoleId)<br>                .distinct().collect(Collectors.toList());<br>        <span class="hljs-keyword">return</span> roleRepository.findRoleInIds(roleIdList);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-3-application层"><a href="#2-3-application层" class="headerlink" title="2.3. application层"></a>2.3. application层</h4><p>修改用户注册接口,添加用户之后，插入一条用户权限记录。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> User <span class="hljs-title function_">register</span><span class="hljs-params">(RegisterUserRequest request)</span> &#123;<br>      <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.register(request);<br><br>      <span class="hljs-type">Integer</span> <span class="hljs-variable">roleId</span> <span class="hljs-operator">=</span> request.getRoleId();<br>      <span class="hljs-keyword">if</span> (roleId == <span class="hljs-literal">null</span> || roleService.findById(roleId) == <span class="hljs-literal">null</span>) &#123;<br>          roleId = RoleEnum.STUDENT.getCode();<br>      &#125;<br>      <br>      <span class="hljs-type">UserRole</span> <span class="hljs-variable">userRole</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserRole</span>();<br>      userRole.setUserId(user.getId());<br>      userRole.setRoleId(roleId);<br>      <br>      userRoleService.save(userRole);<br>      <span class="hljs-keyword">return</span> user;<br>  &#125;<br></code></pre></td></tr></table></figure><p>在登录的时候，生成token时，将权限信息作为payloads的一部分，修改UserApplicationService的login方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> UserLoginDTO <span class="hljs-title function_">login</span><span class="hljs-params">(LoginUserRequest request)</span> &#123;<br>      <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.login(request);<br>      <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.LOGIN_FAILED);<br>      &#125;<br>      <span class="hljs-comment">// 生成token</span><br>      <span class="hljs-type">UserLoginDTO</span> <span class="hljs-variable">userLoginDTO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserLoginDTO</span>();<br>      userLoginDTO.setUser(user);<br><br>      <span class="hljs-type">JwtTokenGenerateRequest</span> <span class="hljs-variable">jwtGenerateRequest</span> <span class="hljs-operator">=</span> userLoginConvertor.convert2JwtTokenGenerateRequest(user);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> jwtTokenService.generateJwtToken(jwtGenerateRequest);<br>      userLoginDTO.setToken(token);<br><br>      <span class="hljs-type">UserContextDetails</span> <span class="hljs-variable">userContextDetails</span> <span class="hljs-operator">=</span> userLoginConvertor.convert2UserContextDetails(user);<br>      <span class="hljs-comment">// token存储到redis</span><br>      redisUtils.setKey(<span class="hljs-string">&quot;token:&quot;</span> + token, userContextDetails, jwtGenerateRequest.getExpireTime());<br>      <span class="hljs-keyword">return</span> userLoginDTO;<br>  &#125;<br></code></pre></td></tr></table></figure><p>将和UserDetailsContext相关的转化，收敛到UserLoginConvertor，方便维护</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserLoginConvertor</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> JwtTokenProperty jwtTokenProperty;<br><br>    <span class="hljs-keyword">public</span> JwtTokenGenerateRequest <span class="hljs-title function_">convert2JwtTokenGenerateRequest</span><span class="hljs-params">(User user)</span> &#123;<br>        <span class="hljs-type">JwtTokenGenerateRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtTokenGenerateRequest</span>();<br>        request.setSubject(user.getId().toString());<br>        request.setExpireTime(jwtTokenProperty.getExpire());<br>        request.setSecret(jwtTokenProperty.getSecret());<br>        request.setPayLoads(convert2Payloads(user));<br><br>        <span class="hljs-keyword">return</span> request;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; <span class="hljs-title function_">convert2Payloads</span><span class="hljs-params">(User user)</span> &#123;<br>        Map&lt;String, String&gt; payloads = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        payloads.put(<span class="hljs-string">&quot;username&quot;</span>, user.getUsername());<br>        payloads.put(<span class="hljs-string">&quot;id&quot;</span>, user.getId().toString());<br>        payloads.put(<span class="hljs-string">&quot;salt&quot;</span>, user.getSalt());<br>        payloads.put(<span class="hljs-string">&quot;roles&quot;</span>, JSONObject.toJSONString(user.getRoles()));<br>        <span class="hljs-keyword">return</span> payloads;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> UserContextDetails <span class="hljs-title function_">convert2UserContextDetails</span><span class="hljs-params">(User user)</span> &#123;<br>        <span class="hljs-type">UserContextDetails</span> <span class="hljs-variable">userContextDetails</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserContextDetails</span>();<br>        userContextDetails.setId(user.getId());<br>        userContextDetails.setUsername(user.getUsername());<br>        userContextDetails.setExtendMap(convert2Payloads(user));<br>        userContextDetails.setPermissionDetails(user.getRoles().stream().map(role -&gt; &#123;<br>            <span class="hljs-type">PermissionDetails</span> <span class="hljs-variable">permissionDetails</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PermissionDetails</span>();<br>            permissionDetails.setName(role.getCode());<br>            <span class="hljs-keyword">return</span> permissionDetails;<br>        &#125;).collect(Collectors.toList()));<br>        <span class="hljs-keyword">return</span> userContextDetails;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-4-测试"><a href="#2-4-测试" class="headerlink" title="2.4. 测试"></a>2.4. 测试</h4><p>我们调用注册接口，分别添加张三、李四、王五的信息，他们分别是学生、辅导员、教务员，测试结果如下：</p><img src="/2024/04/03/%E9%89%B4%E6%9D%83%E5%AD%A6%E4%B9%A0/4.png" class=""><img src="/2024/04/03/%E9%89%B4%E6%9D%83%E5%AD%A6%E4%B9%A0/5.png" class=""><p>调用登录接口，然后查看对应的redis内容，可以看到确实有权限信息</p><img src="/2024/04/03/%E9%89%B4%E6%9D%83%E5%AD%A6%E4%B9%A0/6.png" class=""><h3 id="3-基于注解的鉴权"><a href="#3-基于注解的鉴权" class="headerlink" title="3. 基于注解的鉴权"></a>3. 基于注解的鉴权</h3><p>对于不同的角色，其权限一般是不同的，以请假为例，当学生因为某些原因不能上学时，可以请假，而请假一般需要有辅导员或教务员批准，因此，学生有请假的权限，教务员和辅导员有审批假条的权限。</p><h4 id="3-1-infrastructure层"><a href="#3-1-infrastructure层" class="headerlink" title="3.1. infrastructure层"></a>3.1. infrastructure层</h4><p>首先，添加一个权限注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Retention(value = RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(value = ElementType.METHOD)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Permission &#123;<br>    String[] code();<br>&#125;<br></code></pre></td></tr></table></figure><p>然后添加一个切面类，解析该注解中，要求的权限，然后获取用户上下文，根据用户上下文中的权限，来判断是否有符合的，如果都不符合，那么抛出权限不足的异常。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.infrastructure.auth.aspect;<br><br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.PermissionDetails;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.UserContextDetails;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.UserContextThreadLocal;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.annotations.Permission;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.common.ResultCode;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.exception.BusinessException;<br><span class="hljs-keyword">import</span> org.aspectj.lang.JoinPoint;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Aspect;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Before;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Pointcut;<br><span class="hljs-keyword">import</span> org.aspectj.lang.reflect.MethodSignature;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.springframework.util.CollectionUtils;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Set;<br><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionAspect</span> &#123;<br>    <span class="hljs-meta">@Pointcut(value = &quot;@annotation(com.yang.infrastructure.auth.annotations.Permission)&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pointCut</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Before(value = &quot;pointCut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeAdvice</span><span class="hljs-params">(JoinPoint joinPoint)</span> &#123;<br>        <span class="hljs-type">MethodSignature</span> <span class="hljs-variable">methodSignature</span> <span class="hljs-operator">=</span> (MethodSignature) joinPoint.getSignature();<br>        <span class="hljs-type">Permission</span> <span class="hljs-variable">permission</span> <span class="hljs-operator">=</span> methodSignature.getMethod().getAnnotation(Permission.class);<br><br>        <span class="hljs-comment">// 获取注解中要求的权限</span><br>        String[] code = permission.code();<br>        <span class="hljs-keyword">if</span> (code == <span class="hljs-literal">null</span> || code.length == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// 没有指定权限时，不进行拦截</span><br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 指定权限，先获取当前用户的权限列表</span><br>        <span class="hljs-type">UserContextDetails</span> <span class="hljs-variable">userContextDetails</span> <span class="hljs-operator">=</span> UserContextThreadLocal.get();<br>        List&lt;PermissionDetails&gt; permissionDetails = userContextDetails.getPermissionDetails();<br><br>        <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(permissionDetails)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.ACCESS_DENIED);<br>        &#125;<br><br>        Set&lt;String&gt; ownPermissionSet = permissionDetails.stream().map(PermissionDetails::getName)<br>                .collect(Collectors.toSet());<br><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">containPermission</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">for</span> (String c : code) &#123;<br>            <span class="hljs-keyword">if</span> (ownPermissionSet.contains(c)) &#123;<br>                containPermission = <span class="hljs-literal">true</span>;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!containPermission) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.ACCESS_DENIED);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-2-controller层"><a href="#3-2-controller层" class="headerlink" title="3.2. controller层"></a>3.2. controller层</h4><p>controller层中，添加一个LeaveController类，用于测试，其中，学生可以提出申请离校，而辅导员和教务员可以进行审批。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.controller;<br><br><span class="hljs-keyword">import</span> com.yang.controller.request.leave.AskForLeaveRequest;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.UserContextDetails;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.UserContextThreadLocal;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.annotations.Permission;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.common.Response;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(value = &quot;/leave&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LeaveController</span> &#123;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/apply&quot;)</span><br>    <span class="hljs-meta">@Permission(code = &quot;STUDENT&quot;)</span><br>    <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">applyForLeave</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> AskForLeaveRequest request)</span> &#123;<br>        <span class="hljs-type">UserContextDetails</span> <span class="hljs-variable">userContextDetails</span> <span class="hljs-operator">=</span> UserContextThreadLocal.get();<br>        System.out.println(userContextDetails.getUsername() + <span class="hljs-string">&quot;申请离校，离校时间：&quot;</span> + request.getLeaveDays()<br>        + <span class="hljs-string">&quot;，离校原因：&quot;</span> + request.getReason());<br>        System.out.println(userContextDetails.getPermissionDetails());<br>        <span class="hljs-keyword">return</span> Response.success();<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/approval&quot;)</span><br>    <span class="hljs-meta">@Permission(code = &#123;&quot;COUNSELOR&quot;, &quot;ACADEMIC_ADMINISTRATOR&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">approvalLeave</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">UserContextDetails</span> <span class="hljs-variable">userContextDetails</span> <span class="hljs-operator">=</span> UserContextThreadLocal.get();<br>        System.out.println(userContextDetails.getUsername() + <span class="hljs-string">&quot;审批离校申请&quot;</span>);<br>        System.out.println(userContextDetails.getPermissionDetails());<br>        <span class="hljs-keyword">return</span> Response.success();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-3-测试"><a href="#3-3-测试" class="headerlink" title="3.3. 测试"></a>3.3. 测试</h4><p>首先用学生账号登录，然后分别访问&#x2F;apply接口和&#x2F;approval接口</p><img src="/2024/04/03/%E9%89%B4%E6%9D%83%E5%AD%A6%E4%B9%A0/7.png" class=""><img src="/2024/04/03/%E9%89%B4%E6%9D%83%E5%AD%A6%E4%B9%A0/8.png" class=""><p>然后登录一个辅导员账号，再次访问&#x2F;apply和&#x2F;approval接口</p><img src="/2024/04/03/%E9%89%B4%E6%9D%83%E5%AD%A6%E4%B9%A0/9.png" class=""><img src="/2024/04/03/%E9%89%B4%E6%9D%83%E5%AD%A6%E4%B9%A0/10.png" class=""><p>我们查看控制台，也能看到该账户的权限确实是辅导员权限</p><img src="/2024/04/03/%E9%89%B4%E6%9D%83%E5%AD%A6%E4%B9%A0/11.png" class=""><h3 id="4-基于拦截器的鉴权"><a href="#4-基于拦截器的鉴权" class="headerlink" title="4. 基于拦截器的鉴权"></a>4. 基于拦截器的鉴权</h3><p>虽然上述基于注解的鉴权，能完成用户的权限校验，但是如果我们有很多个接口，他们的权限要求都是一样的，比如以&#x2F;student开头地请求，都需要学生权限，如果是基于注解地鉴权，我们就需要对这些接口一个一个地加上注解，进行鉴权，这样很麻烦。因此，我们可以使用拦截器，对符合某些路径地请求，进行权限校验。</p><h4 id="4-1-infrastructure层"><a href="#4-1-infrastructure层" class="headerlink" title="4.1. infrastructure层"></a>4.1. infrastructure层</h4><p>我们在基础设施层，加上对应地拦截器，拦截用户请求，并解析出请求地路径，根据路径，找出该路径需要匹配地权限，最后再根据用户上下文，判断是否满足该权限。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.infrastructure.auth.interceptors;<br><br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.PermissionDetails;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.UserContextDetails;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.UserContextThreadLocal;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.common.ResultCode;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.exception.BusinessException;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.util.CollectionUtils;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.Optional;<br><span class="hljs-keyword">import</span> java.util.Set;<br><span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentHashMap;<br><span class="hljs-keyword">import</span> java.util.function.Function;<br><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionVerifyInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br>    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; uri2PermissionMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addPermission</span><span class="hljs-params">(String permission, String... uris)</span> &#123;<br>        <span class="hljs-keyword">if</span> (uris.length &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">for</span> (String url : uris) &#123;<br>                uri2PermissionMap.put(url, permission);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addPermission</span><span class="hljs-params">(String permission, List&lt;String&gt; uriList)</span> &#123;<br>        <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(uriList)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (String uri : uriList) &#123;<br>            uri2PermissionMap.put(uri, permission);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">requestURI</span> <span class="hljs-operator">=</span> request.getRequestURI();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">permission</span> <span class="hljs-operator">=</span> getPermissionOfUri(requestURI);<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(permission)) &#123;<br>            <span class="hljs-comment">// 没有权限要求，直接通过</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-type">UserContextDetails</span> <span class="hljs-variable">userContextDetails</span> <span class="hljs-operator">=</span> UserContextThreadLocal.get();<br>        List&lt;PermissionDetails&gt; permissionDetails = userContextDetails.getPermissionDetails();<br>        <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(permissionDetails)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.ACCESS_DENIED);<br>        &#125;<br><br>        <span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> permissionDetails.stream()<br>                .filter(permissionDetail -&gt; permissionDetail.getName().equals(permission))<br>                .count();<br>        <span class="hljs-keyword">if</span> (count &lt;= <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.ACCESS_DENIED);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getPermissionOfUri</span><span class="hljs-params">(String uri)</span> &#123;<br>        Set&lt;String&gt; keySet = <span class="hljs-built_in">this</span>.uri2PermissionMap.keySet();<br>        <span class="hljs-keyword">if</span> (keySet.contains(uri)) &#123;<br>            <span class="hljs-keyword">return</span> uri2PermissionMap.get(uri);<br>        &#125;<br><br>        Map&lt;String, String&gt; map = keySet.stream().filter(key -&gt; key.endsWith(<span class="hljs-string">&quot;*&quot;</span>))<br>                .collect(Collectors.toMap(key -&gt; &#123;<br>                    <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> key.lastIndexOf(<span class="hljs-string">&quot;*&quot;</span>);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">tempKey</span> <span class="hljs-operator">=</span> key.substring(<span class="hljs-number">0</span>, index);<br>                    <span class="hljs-keyword">return</span> tempKey;<br>                &#125;, Function.identity()));<br><br>        <span class="hljs-keyword">for</span> (String key : map.keySet()) &#123;<br>            <span class="hljs-keyword">if</span> (uri.startsWith(key)) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">originKey</span> <span class="hljs-operator">=</span> map.get(key);<br>                <span class="hljs-keyword">return</span> uri2PermissionMap.get(originKey);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后将这个拦截器，添加到配置中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.infrastructure.configuration;<br><br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.interceptors.JwtTokenVerifyInterceptor;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.interceptors.PermissionVerifyInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebMvcConfiguration</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> &#123;<br>        registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtTokenVerifyInterceptor</span>())<br>                .addPathPatterns(<span class="hljs-string">&quot;/**&quot;</span>) <span class="hljs-comment">// 拦截所有请求</span><br>                .excludePathPatterns(<span class="hljs-string">&quot;/user/login&quot;</span>, <span class="hljs-string">&quot;/user/register&quot;</span>); <span class="hljs-comment">// 排除登录、注册接口</span><br><br>        <span class="hljs-type">PermissionVerifyInterceptor</span> <span class="hljs-variable">permissionVerifyInterceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PermissionVerifyInterceptor</span>();<br>        permissionVerifyInterceptor.addPermission(<span class="hljs-string">&quot;STUDENT&quot;</span>, <span class="hljs-string">&quot;/student/needPermission&quot;</span>);<br>        permissionVerifyInterceptor.addPermission(<span class="hljs-string">&quot;COUNSELOR&quot;</span>, <span class="hljs-string">&quot;/counselor/*&quot;</span>);<br><br>        registry.addInterceptor(permissionVerifyInterceptor)<br>                .addPathPatterns(<span class="hljs-string">&quot;/**&quot;</span>) <span class="hljs-comment">// 拦截所有请求</span><br>                .excludePathPatterns(<span class="hljs-string">&quot;/user/login&quot;</span>, <span class="hljs-string">&quot;/user/register&quot;</span>); <span class="hljs-comment">// 排除登录、注册接口</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="4-2-测试"><a href="#4-2-测试" class="headerlink" title="4.2. 测试"></a>4.2. 测试</h4><p>首先，使用辅导员的token，依次访问&#x2F;student&#x2F;needPermission, &#x2F;student&#x2F;notPermission和&#x2F;counselor的相关接口</p><img src="/2024/04/03/%E9%89%B4%E6%9D%83%E5%AD%A6%E4%B9%A0/12.png" class=""><img src="/2024/04/03/%E9%89%B4%E6%9D%83%E5%AD%A6%E4%B9%A0/13.png" class=""><img src="/2024/04/03/%E9%89%B4%E6%9D%83%E5%AD%A6%E4%B9%A0/14.png" class=""><p>然后使用普通学生的token，依次访问&#x2F;student&#x2F;needPermission, &#x2F;student&#x2F;notPermission和&#x2F;counselor的相关接口</p><img src="/2024/04/03/%E9%89%B4%E6%9D%83%E5%AD%A6%E4%B9%A0/15.png" class=""><img src="/2024/04/03/%E9%89%B4%E6%9D%83%E5%AD%A6%E4%B9%A0/16.png" class=""><img src="/2024/04/03/%E9%89%B4%E6%9D%83%E5%AD%A6%E4%B9%A0/17.png" class="">]]></content>
    
    
    
    <tags>
      
      <tag>SpringBoot</tag>
      
      <tag>SpringSecurity</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>登录、注册学习</title>
    <link href="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/"/>
    <url>/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<h3 id="1-引言"><a href="#1-引言" class="headerlink" title="1. 引言"></a>1. 引言</h3><p>在项目中，登录、注册一般都是项目的必备功能，因为它们的用户管理和身份验证的基础，通过登录和注册，能有效保护用户个人数据，并根据用户权限，进行对应的资源访问控制。此外，还能对注册后的用户进行行为分析，以便提供对应的个性化服务。</p><h3 id="2-登录、注册实现"><a href="#2-登录、注册实现" class="headerlink" title="2. 登录、注册实现"></a>2. 登录、注册实现</h3><h4 id="2-1-项目结构介绍"><a href="#2-1-项目结构介绍" class="headerlink" title="2.1. 项目结构介绍"></a>2.1. 项目结构介绍</h4><p>这里的项目结构，借鉴周志明老师提出的凤凰架构，将项目分为四层：<br>1）domain： 领域层，负责实现业务逻辑，即表达业务概念、处理业务状态信息以及业务规这些行为，提供对应的领域服务。<br>2）infrastructure：基础设施层，向其他层提供通用的技术能力，譬如持久化能力、远程访问通信、工具集等。<br>3）application：应用层，负责软件本身对外暴露的能力，通过整合各个领域服务，进行协助，对外提供服务，相当于各个领域服务的门面，类似于MVC架构中的service层。<br>4）controller：负责向用户显示信息或解释用户发出的命令，即MVC架构中的controller层。</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/1.png" class=""><h4 id="2-2-简单实现"><a href="#2-2-简单实现" class="headerlink" title="2.2. 简单实现"></a>2.2. 简单实现</h4><h5 id="2-2-1-准备工作"><a href="#2-2-1-准备工作" class="headerlink" title="2.2.1. 准备工作"></a>2.2.1. 准备工作</h5><p>首先引入下列依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-lang3<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><p>创建对应的数据库，数据库表结构如下：</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/2.png" class=""><p>这里的username添加了唯一索引，因为用户名一般都是唯一的。</p><h5 id="2-2-2-domain层"><a href="#2-2-2-domain层" class="headerlink" title="2.2.2. domain层"></a>2.2.2. domain层</h5><p>创建对应的实体类，以及相关的repository仓储层和domainservice领域服务</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName(value = &quot;t_user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span><br>    <span class="hljs-keyword">private</span> Integer id;<br><br>    <span class="hljs-keyword">private</span> String username;<br><br>    <span class="hljs-keyword">private</span> String password;<br><br>    <span class="hljs-comment">// 是否冻结 0未冻结 1已冻结</span><br>    <span class="hljs-keyword">private</span> Integer freeze;<br><br>    <span class="hljs-keyword">private</span> Date createTime;<br><br>    <span class="hljs-keyword">private</span> Date updateTime;<br><br>    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; featuresMap;<br><br>    <span class="hljs-keyword">private</span> String features;<br>&#125;<br><br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUserRepository</span> &#123;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(User user)</span>;<br><br><br>    User <span class="hljs-title function_">findByUsernameAndPassword</span><span class="hljs-params">(String username, String password)</span>;<br>&#125;<br><br><br><br><span class="hljs-meta">@Repository</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepository</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IUserRepository</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">UN_FREEZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">FREEZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(User user)</span> &#123;<br>        user.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        user.setUpdateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        user.setFreeze(UN_FREEZE);<br>        user.setFeaturesMap(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;());<br>        user.setFeatures(JSONObject.toJSONString(user.getFeaturesMap()));<br>        <span class="hljs-keyword">return</span> userMapper.insert(user) &gt; <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findByUsernameAndPassword</span><span class="hljs-params">(String username, String password)</span> &#123;<br>        LambdaQueryWrapper&lt;User&gt; queryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>        queryWrapper.eq(User::getUsername, username);<br>        queryWrapper.eq(User::getPassword, password);<br>        <span class="hljs-keyword">return</span> userMapper.selectOne(queryWrapper);<br>    &#125;<br><br><br>&#125;<br><br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> IUserRepository userRepository;<br><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">register</span><span class="hljs-params">(RegisterUserRequest request)</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>        user.setUsername(request.getUsername());<br>        user.setPassword(request.getPassword());<br>        <span class="hljs-keyword">try</span> &#123;<br>            userRepository.saveUser(user);<br>            <span class="hljs-keyword">return</span> user;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.SERVER_ERROR);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">login</span><span class="hljs-params">(LoginUserRequest request)</span> &#123;<br>        <span class="hljs-keyword">return</span> userRepository.findByUsernameAndPassword(request.getUsername(), request.getPassword());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="2-2-3-controller层"><a href="#2-2-3-controller层" class="headerlink" title="2.2.3. controller层"></a>2.2.3. controller层</h5><p>添加userController，在该类中添加注册和登录的接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(value = &quot;/user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-meta">@PostMapping(value = &quot;/register&quot;)</span><br>    <span class="hljs-keyword">public</span> Response&lt;User&gt; <span class="hljs-title function_">register</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> RegisterUserRequest request)</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.register(request);<br>        <span class="hljs-keyword">return</span> Response.success(user);<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(value = &quot;/login&quot;)</span><br>    <span class="hljs-keyword">public</span> Response&lt;User&gt; <span class="hljs-title function_">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> LoginUserRequest request)</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.login(request);<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.LOGIN_FAILED);<br>        &#125;<br>        <span class="hljs-keyword">return</span> Response.success(user);<br>    &#125;<br>&#125;<br><br><br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginUserRequest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> String username;<br><br>    <span class="hljs-keyword">private</span> String password;<br>&#125;<br><br><br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RegisterUserRequest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> String username;<br><br>    <span class="hljs-keyword">private</span> String password;<br><br>&#125;<br></code></pre></td></tr></table></figure><h5 id="2-2-4-infrastructure层"><a href="#2-2-4-infrastructure层" class="headerlink" title="2.2.4. infrastructure层"></a>2.2.4. infrastructure层</h5><p>添加基础设施，比如异常类、返回结果类、错误码，全局异常处理等</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ResultCode</span> &#123;<br>    SUCCESS(<span class="hljs-number">200</span>, <span class="hljs-string">&quot;操作成功&quot;</span>),<br>    ACCESS_DENIED(<span class="hljs-number">403</span>, <span class="hljs-string">&quot;没有权限&quot;</span>),<br>    FAILED(<span class="hljs-number">400</span>, <span class="hljs-string">&quot;操作失败&quot;</span>),<br><br>    LOGIN_FAILED(<span class="hljs-number">400</span>, <span class="hljs-string">&quot;用户不存在或密码错误&quot;</span>),<br>    SERVER_ERROR(<span class="hljs-number">500</span>, <span class="hljs-string">&quot;服务器错误&quot;</span>);<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> code;<br><br>    <span class="hljs-keyword">private</span> String msg;<br><br>    ResultCode(<span class="hljs-type">int</span> code, String msg) &#123;<br>        <span class="hljs-built_in">this</span>.code = code;<br>        <span class="hljs-built_in">this</span>.msg = msg;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.code;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMsg</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.msg;<br>    &#125;<br>&#125;<br><br><br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Response</span> &lt;T&gt; &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> code;<br><br>    <span class="hljs-keyword">private</span> String msg;<br><br>    <span class="hljs-keyword">private</span> T data;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Response</span><span class="hljs-params">(Integer code, String msg)</span> &#123;<br>        <span class="hljs-built_in">this</span>.code = code;<br>        <span class="hljs-built_in">this</span>.msg = msg;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Response</span><span class="hljs-params">(Integer code, String msg, T data)</span> &#123;<br>        <span class="hljs-built_in">this</span>.code = code;<br>        <span class="hljs-built_in">this</span>.msg = msg;<br>        <span class="hljs-built_in">this</span>.data = data;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Response</span><span class="hljs-params">(ResultCode resultCode)</span> &#123;<br>        <span class="hljs-built_in">this</span>.code = resultCode.getCode();<br>        <span class="hljs-built_in">this</span>.msg = resultCode.getMsg();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Response</span><span class="hljs-params">(ResultCode resultCode, T data)</span> &#123;<br>        <span class="hljs-built_in">this</span>.code = resultCode.getCode();<br>        <span class="hljs-built_in">this</span>.msg = resultCode.getMsg();<br>        <span class="hljs-built_in">this</span>.data = data;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Response&lt;T&gt; <span class="hljs-title function_">success</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>&lt;&gt;(ResultCode.SUCCESS);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Response&lt;T&gt; <span class="hljs-title function_">success</span><span class="hljs-params">(T data)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>&lt;&gt;(ResultCode.SUCCESS, data);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Response&lt;T&gt; <span class="hljs-title function_">fail</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>&lt;&gt;(ResultCode.FAILED);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Response&lt;T&gt; <span class="hljs-title function_">error</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>&lt;&gt;(ResultCode.SERVER_ERROR);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Response&lt;T&gt; <span class="hljs-title function_">fail</span><span class="hljs-params">(ResultCode resultCode)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>&lt;&gt;(resultCode);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Response&lt;T&gt; <span class="hljs-title function_">fail</span><span class="hljs-params">(String msg)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>&lt;&gt;(ResultCode.FAILED.getCode(), msg);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.code;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMsg</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.msg;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">getData</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.data;<br>    &#125;<br>&#125;<br><br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RuntimeException</span> &#123;<br>    <span class="hljs-keyword">private</span> ResultCode resultCode;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BusinessException</span><span class="hljs-params">(ResultCode resultCode)</span> &#123;<br>        <span class="hljs-built_in">super</span>(resultCode.getMsg());<br>        <span class="hljs-built_in">this</span>.resultCode = resultCode;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> ResultCode <span class="hljs-title function_">getResultCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.resultCode;<br>    &#125;<br>&#125;<br><br><br><br><span class="hljs-meta">@RestControllerAdvice</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> &#123;<br>    <span class="hljs-meta">@ExceptionHandler(value = BusinessException.class)</span><br>    <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">handleBusinessException</span><span class="hljs-params">(BusinessException businessException)</span> &#123;<br>        <span class="hljs-keyword">return</span> Response.fail(businessException.getResultCode());<br>    &#125;<br><br>    <span class="hljs-meta">@ExceptionHandler(value = Exception.class)</span><br>    <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">handleException</span><span class="hljs-params">(Exception e)</span> &#123;<br>        <span class="hljs-keyword">return</span> Response.fail(e.getMessage());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="2-2-5-application层"><a href="#2-2-5-application层" class="headerlink" title="2.2.5. application层"></a>2.2.5. application层</h5><p>因为现在的功能比较简单，不涉及到多个领域对象的交互，所以这里暂时不添加相关的应用服务。</p><h5 id="2-2-6-测试"><a href="#2-2-6-测试" class="headerlink" title="2.2.6. 测试"></a>2.2.6. 测试</h5><p>所以接口测试工具，分别对注册接口和登录接口进行访问</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/3.png" class=""><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/4.png" class=""><h4 id="2-3-密码加密"><a href="#2-3-密码加密" class="headerlink" title="2.3. 密码加密"></a>2.3. 密码加密</h4><p>上述流程虽然能够跑通，但是存在一个问题，用户密码在数据库中，以明文的方式进行存储，这样不太合理，容易将用户数据泄露出去。因此，这里进行修改。<br>在用户密码加密中，我们经常会使用到盐（Salt），盐是一种随机值，它与用户密码组合起来，形成一个组合密码，然后使用加密哈希函数（比如SHA-）对组合密码进行加密，生成哈希值，并将加密后的哈希值存储在数据库中，当用户登录时，系统会取出存储的哈希值，通过与用户输入的密码组合，进行哈希加密，然后比对与数据库中存储的值是否一致。</p><h5 id="2-3-1-修改表结构"><a href="#2-3-1-修改表结构" class="headerlink" title="2.3.1. 修改表结构"></a>2.3.1. 修改表结构</h5><p>在之前的表设计中，我们预留了一个features字段，表示扩展信息，我们其实可以将盐存入到扩展信息中，但是因为盐我们在登录中进场使用到，因此，还是单独作为一个字段，修改后的表结构如下：</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/5.png" class=""><h5 id="2-3-2-infrastructure层"><a href="#2-3-2-infrastructure层" class="headerlink" title="2.3.2. infrastructure层"></a>2.3.2. infrastructure层</h5><p>在基础设施层中，添加上加密工具类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.infrastructure.utils;<br><br><span class="hljs-keyword">import</span> cn.hutool.crypto.SecureUtil;<br><span class="hljs-keyword">import</span> cn.hutool.crypto.digest.Digester;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.ThreadLocalRandom;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EncryptUtils</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Digester</span> <span class="hljs-variable">sha256</span> <span class="hljs-operator">=</span> SecureUtil.sha256();<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">char</span>[] saltChars = <span class="hljs-string">&quot;0123456789abcdefghijklmnopqrstuvwxyz&quot;</span>.toCharArray();<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SALT_LEN</span> <span class="hljs-operator">=</span> <span class="hljs-number">6</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 加密</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> originPwd</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> salt</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">encrypt</span><span class="hljs-params">(String originPwd, String salt)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">newPwd</span> <span class="hljs-operator">=</span> salt + originPwd;<br>        <span class="hljs-type">byte</span>[] digest = sha256.digest(newPwd);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(digest);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成盐</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">generateSalt</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-type">ThreadLocalRandom</span> <span class="hljs-variable">threadLocalRandom</span> <span class="hljs-operator">=</span> ThreadLocalRandom.current();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; SALT_LEN; i++) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> threadLocalRandom.nextInt(saltChars.length);<br>            sb.append(saltChars[index]);<br>        &#125;<br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="2-3-3-domain"><a href="#2-3-3-domain" class="headerlink" title="2.3.3. domain"></a>2.3.3. domain</h5><p>修改domain层中的userService，在注册的时候，设置盐，并对密码进行加密，在登录的时候，根据盐和输入密码，生成哈希值，与数据库中的哈希值进行对比。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.domain.service;<br><br><span class="hljs-keyword">import</span> com.yang.controller.request.LoginUserRequest;<br><span class="hljs-keyword">import</span> com.yang.controller.request.RegisterUserRequest;<br><span class="hljs-keyword">import</span> com.yang.domain.data.User;<br><span class="hljs-keyword">import</span> com.yang.domain.repository.IUserRepository;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.common.ResultCode;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.exception.BusinessException;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.utils.EncryptUtils;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> IUserRepository userRepository;<br><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">register</span><span class="hljs-params">(RegisterUserRequest request)</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>        user.setUsername(request.getUsername());<br>        <span class="hljs-comment">// 设置盐</span><br>        user.setSalt(EncryptUtils.generateSalt());<br>        user.setPassword(EncryptUtils.encrypt(request.getPassword(), user.getSalt()));<br>        <span class="hljs-keyword">try</span> &#123;<br>            userRepository.saveUser(user);<br>            <span class="hljs-keyword">return</span> user;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.SERVER_ERROR);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">login</span><span class="hljs-params">(LoginUserRequest request)</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userRepository.findByUsername(request.getUsername());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">salt</span> <span class="hljs-operator">=</span> user.getSalt();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> EncryptUtils.encrypt(request.getPassword(), salt);<br>        <span class="hljs-keyword">if</span> (password.equals(user.getPassword())) &#123;<br>            <span class="hljs-keyword">return</span> user;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="2-3-4-测试"><a href="#2-3-4-测试" class="headerlink" title="2.3.4. 测试"></a>2.3.4. 测试</h5><p>重新运行项目，调用注册接口和登录接口</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/6.png" class=""><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/7.png" class=""><p>查看数据库，可以看出此时的password确实是经过加密后生成的。</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/8.png" class=""><h3 id="3-Token生成"><a href="#3-Token生成" class="headerlink" title="3. Token生成"></a>3. Token生成</h3><h4 id="3-1-准备工作"><a href="#3-1-准备工作" class="headerlink" title="3.1. 准备工作"></a>3.1. 准备工作</h4><p>一般情况下，除了登录和注册接口，不需要进行登录拦截之外，其他的接口，都需要对用户的登录状态进行拦截，判断用户是否登录，如若未登录，则提示用户需要进行登录。对此，我们在用户登录成功后，可以返回一个token作为登录凭证返回给前端。</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/9.png" class=""><p>这里我们在构建token的时候，使用JWT来构建，JWT(JSON Web Token)是为了在网络应用环境间传递声明而执行的一种基于JSON的开放标准。JWT主要由三部分组成：<br>1）头部（Header），通常包含两部分信息，alg(alogirthm，指定用于签名或加密令牌的算法），typ（类型，表明令牌的类型为JWT）</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;alg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;HS256&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;typ&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;JWT&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>2）有效载荷（Payload），一个json对象，包含一系列声明，比如sub（subject主题，通常是用户id），name（用户名称），exp（过期时间）等。<br>3）签名：对前两部分的串行化后的字符串使用指定的算法（如SHA256或RSA签名）生成的一个加密串，它的作用是保证令牌的完整性和真实性，保证传输过程中没有被修改。<br>这三个部分之间用.分隔，构成JWT的完整结构，如：</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">eyJhbGciOiJIUzI<span class="hljs-number">1</span><span class="hljs-symbol">NiIsInR5</span>cCI<span class="hljs-number">6</span>IkpX<span class="hljs-attr">VCJ9</span>.eyJzdWIiOiIxMj<span class="hljs-name">M0</span><span class="hljs-symbol">NTY3</span>ODkwIiwibmFtZSI<span class="hljs-number">6</span>Ikpva<span class="hljs-name">G4</span>gR<span class="hljs-name">G9</span>lIiwiaWF<span class="hljs-number">0</span>Ijox<span class="hljs-symbol">NTE2</span>Mj<span class="hljs-name">M5</span>MDIyfQ.TJVA<span class="hljs-number">95</span><span class="hljs-keyword">Or</span><span class="hljs-name">M7</span>E<span class="hljs-number">2</span>cBab<span class="hljs-number">30</span>RMHrHDcEfxjoYZgeFO<span class="hljs-symbol">NFh7</span>H<span class="hljs-number">8</span>RU<br></code></pre></td></tr></table></figure><p>为整合JWT，我们引入下列依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.auth0<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>java-jwt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.10.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="3-2-infrastructure层"><a href="#3-2-infrastructure层" class="headerlink" title="3.2. infrastructure层"></a>3.2. infrastructure层</h4><p>在基础设施层，我们添加和鉴权相关的信息，首先添加一个jwt配置类，用于配置jwt使用的密钥和过期时间</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.infrastructure.auth.config;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtTokenProperty</span> &#123;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;jwt.token.secret&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String secret;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;jwt.token.expire&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer expire;<br>&#125;<br></code></pre></td></tr></table></figure><p>定义一个JwtTokenService接口，以及对应的实现类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">JwtTokenService</span> &#123;<br>    String <span class="hljs-title function_">generateJwtToken</span><span class="hljs-params">(JwtTokenGenerateRequest request)</span>;<br><br>    JwtTokenVerifyDTO <span class="hljs-title function_">verify</span><span class="hljs-params">(JwtTokenVerifyRequest request)</span>;<br><br>&#125;<br><br><br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtTokenServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">JwtTokenService</span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">EXPIRE_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">604800</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SECRET</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;helloworld&quot;</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateJwtToken</span><span class="hljs-params">(JwtTokenGenerateRequest request)</span> &#123;<br>        JWTCreator.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> JWT.create();<br>        <span class="hljs-keyword">if</span> (MapUtil.isNotEmpty(request.getPayLoads())) &#123;<br>            request.getPayLoads().forEach((k, v) -&gt; &#123;<br>                builder.withClaim(k, v);<br>            &#125;);<br>        &#125;<br><br>        <span class="hljs-type">Calendar</span> <span class="hljs-variable">expireTime</span> <span class="hljs-operator">=</span> Calendar.getInstance();<br>        expireTime.add(Calendar.SECOND, request.getExpireTime() != <span class="hljs-literal">null</span> ? request.getExpireTime() : EXPIRE_TIME);<br>        <span class="hljs-keyword">return</span> builder.withSubject(request.getSubject())<br>                .withIssuedAt(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>())<br>                .withExpiresAt(expireTime.getTime())<br>                .sign(Algorithm.HMAC256(StringUtils.isNotEmpty(request.getSecret()) ? request.getSecret() : SECRET));<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> JwtTokenVerifyDTO <span class="hljs-title function_">verify</span><span class="hljs-params">(JwtTokenVerifyRequest request)</span> &#123;<br>        <span class="hljs-type">JWTVerifier</span> <span class="hljs-variable">jwtVerifier</span> <span class="hljs-operator">=</span> JWT.require<br>                (Algorithm.HMAC256(StringUtils.isNotEmpty(request.getSecret()) ? request.getSecret() : SECRET))<br>                .build();<br>        <span class="hljs-type">DecodedJWT</span> <span class="hljs-variable">decodedJWT</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            decodedJWT = jwtVerifier.verify(request.getToken());<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.TOKEN_FAILED);<br>        &#125;<br><br>        <span class="hljs-type">JwtTokenVerifyDTO</span> <span class="hljs-variable">jwtTokenVerifyDTO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtTokenVerifyDTO</span>();<br>        Map&lt;String, Claim&gt; claims = decodedJWT.getClaims();<br>        <span class="hljs-keyword">if</span> (MapUtil.isNotEmpty(claims)) &#123;<br>            claims.forEach((k, v) -&gt; &#123;<br>                jwtTokenVerifyDTO.getPayLoads().put(k, v.asString());<br>            &#125;);<br>        &#125;<br>        jwtTokenVerifyDTO.setSubject(decodedJWT.getSubject());<br>        jwtTokenVerifyDTO.setExpireTime(decodedJWT.getExpiresAt());<br>        <span class="hljs-keyword">return</span> jwtTokenVerifyDTO;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-3-application层"><a href="#3-3-application层" class="headerlink" title="3.3. application层"></a>3.3. application层</h4><p>因为现在登录涉及到token等操作，对于token的生成， 这个不属于userService领域服务范围，因此就涉及到多个服务之间的协作，所以此时使用applicationService来整合多个服务。我们添加一个UserApplicationService类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.application.service;<br><br><span class="hljs-keyword">import</span> com.yang.application.dto.UserLoginDTO;<br><span class="hljs-keyword">import</span> com.yang.controller.request.LoginUserRequest;<br><span class="hljs-keyword">import</span> com.yang.controller.request.RegisterUserRequest;<br><span class="hljs-keyword">import</span> com.yang.domain.data.User;<br><span class="hljs-keyword">import</span> com.yang.domain.service.UserService;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.config.JwtTokenProperty;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.request.JwtTokenGenerateRequest;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.service.JwtTokenService;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.common.ResultCode;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.exception.BusinessException;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserApplicationService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> JwtTokenProperty jwtTokenProperty;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> JwtTokenService jwtTokenService;<br><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">register</span><span class="hljs-params">(RegisterUserRequest request)</span> &#123;<br>        <span class="hljs-keyword">return</span> userService.register(request);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> UserLoginDTO <span class="hljs-title function_">login</span><span class="hljs-params">(LoginUserRequest request)</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.login(request);<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.LOGIN_FAILED);<br>        &#125;<br>        <span class="hljs-comment">// 生成token</span><br>        <span class="hljs-type">UserLoginDTO</span> <span class="hljs-variable">userLoginDTO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserLoginDTO</span>();<br>        userLoginDTO.setUser(user);<br><br>        <span class="hljs-type">JwtTokenGenerateRequest</span> <span class="hljs-variable">jwtGenerateRequest</span> <span class="hljs-operator">=</span> convert2JwtTokenGenerateRequest(user);<br>        userLoginDTO.setToken(jwtTokenService.generateJwtToken(jwtGenerateRequest));<br>        <span class="hljs-keyword">return</span> userLoginDTO;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> JwtTokenGenerateRequest <span class="hljs-title function_">convert2JwtTokenGenerateRequest</span><span class="hljs-params">(User user)</span> &#123;<br>        <span class="hljs-type">JwtTokenGenerateRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtTokenGenerateRequest</span>();<br>        request.setSubject(user.getId().toString());<br>        request.setExpireTime(jwtTokenProperty.getExpire());<br>        request.setSecret(jwtTokenProperty.getSecret());<br><br>        Map&lt;String, String&gt; payloads = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        payloads.put(<span class="hljs-string">&quot;username&quot;</span>, user.getUsername());<br>        payloads.put(<span class="hljs-string">&quot;id&quot;</span>, user.getId().toString());<br>        payloads.put(<span class="hljs-string">&quot;salt&quot;</span>, user.getSalt());<br>        request.setPayLoads(payloads);<br><br>        <span class="hljs-keyword">return</span> request;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-4-controller层"><a href="#3-4-controller层" class="headerlink" title="3.4. controller层"></a>3.4. controller层</h4><p>我们修改controller层，改用applicationService，并添加一个接口，来测试我们的JwtTokenService解析是否正确</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.controller;<br><br><span class="hljs-keyword">import</span> com.yang.application.service.UserApplicationService;<br><span class="hljs-keyword">import</span> com.yang.application.dto.UserLoginDTO;<br><span class="hljs-keyword">import</span> com.yang.controller.request.LoginUserRequest;<br><span class="hljs-keyword">import</span> com.yang.controller.request.RegisterUserRequest;<br><span class="hljs-keyword">import</span> com.yang.domain.data.User;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.config.JwtTokenProperty;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.request.JwtTokenVerifyRequest;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.response.JwtTokenVerifyDTO;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.service.JwtTokenService;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.common.Response;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.common.ResultCode;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.exception.BusinessException;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(value = &quot;/user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br>   <span class="hljs-meta">@Autowired</span><br>   <span class="hljs-keyword">private</span> UserApplicationService userApplicationService;<br><br>    <span class="hljs-meta">@PostMapping(value = &quot;/register&quot;)</span><br>    <span class="hljs-keyword">public</span> Response&lt;User&gt; <span class="hljs-title function_">register</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> RegisterUserRequest request)</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userApplicationService.register(request);<br>        <span class="hljs-keyword">return</span> Response.success(user);<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(value = &quot;/login&quot;)</span><br>    <span class="hljs-keyword">public</span> Response&lt;UserLoginDTO&gt; <span class="hljs-title function_">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> LoginUserRequest request)</span> &#123;<br>        <span class="hljs-type">UserLoginDTO</span> <span class="hljs-variable">userLoginDTO</span> <span class="hljs-operator">=</span> userApplicationService.login(request);<br>        <span class="hljs-keyword">if</span> (userLoginDTO == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.LOGIN_FAILED);<br>        &#125;<br>        <span class="hljs-keyword">return</span> Response.success(userLoginDTO);<br>    &#125;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> JwtTokenService jwtTokenService;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> JwtTokenProperty jwtTokenProperty;<br>    <br>    <span class="hljs-meta">@GetMapping(value = &quot;/verify&quot;)</span><br>    <span class="hljs-keyword">public</span> Response&lt;JwtTokenVerifyDTO&gt; <span class="hljs-title function_">verify</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(name = &quot;token&quot;)</span>String token)</span> &#123;<br>        <span class="hljs-type">JwtTokenVerifyRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtTokenVerifyRequest</span>();<br>        request.setToken(token);<br>        request.setSecret(jwtTokenProperty.getSecret());<br>        <span class="hljs-type">JwtTokenVerifyDTO</span> <span class="hljs-variable">verify</span> <span class="hljs-operator">=</span> jwtTokenService.verify(request);<br>        <span class="hljs-keyword">return</span> Response.success(verify);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-5-测试"><a href="#3-5-测试" class="headerlink" title="3.5. 测试"></a>3.5. 测试</h4><p>首先调用登录接口，进行测试</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/10.png" class=""><p>将登录接口返回的token复制，调用verfiy接口，解析成功，说明JwtTokenService没问题</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/11.png" class=""><p>然后我们随意捏造一个token进行访问，结果如下：</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/12.png" class=""><h3 id="4-登录拦截"><a href="#4-登录拦截" class="headerlink" title="4. 登录拦截"></a>4. 登录拦截</h3><p>后端返回token 给前端后，前端保存这个token,在后续发送请求时，将这个token携带到请求头进行访问，后端解析请求头，解析该token，判断token是否生效，当token有效时，对请求进行放行。也就是说，我们在执行业务代码之前，都会先对请求进行拦截，并校验token的合法性。因此，就需要使用到拦截器。</p><h4 id="4-1-infrastructure层"><a href="#4-1-infrastructure层" class="headerlink" title="4.1. infrastructure层"></a>4.1. infrastructure层</h4><p>在基础设施层，添加和登录拦截有关的类，首先添加一个Spring上下文工具类，帮助获取容器中的bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.infrastructure.utils;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.BeansException;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContextAware;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringContextUtils</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationContextAware</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ApplicationContext applicationContext;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicationContext</span><span class="hljs-params">(ApplicationContext applicationContext)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        SpringContextUtils.applicationContext = applicationContext;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span>&lt;T&gt;  T <span class="hljs-title function_">getBeanOfType</span><span class="hljs-params">(Class&lt;T&gt; clazz)</span> &#123;<br>        <span class="hljs-keyword">return</span> applicationContext.getBean(clazz);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">getBeanOfName</span><span class="hljs-params">(String name, Class&lt;T&gt; clazz)</span> &#123;<br>        <span class="hljs-keyword">return</span> applicationContext.getBean(name, clazz);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后添加一个JwtTokenVerifyInterceptor类，实现HandlerInterceptor，表示判断token是否有效的拦截器。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.infrastructure.auth.interceptors;<br><br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.config.JwtTokenProperty;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.request.JwtTokenVerifyRequest;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.response.JwtTokenVerifyDTO;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.service.JwtTokenService;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.common.ResultCode;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.exception.BusinessException;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.utils.SpringContextUtils;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtTokenVerifyInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;token&quot;</span>);<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(token)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.TOKEN_FAILED);<br>        &#125;<br>        <span class="hljs-type">JwtTokenService</span> <span class="hljs-variable">jwtTokenService</span> <span class="hljs-operator">=</span> SpringContextUtils.getBeanOfType(JwtTokenService.class);<br>        <span class="hljs-type">JwtTokenProperty</span> <span class="hljs-variable">jwtTokenProperty</span> <span class="hljs-operator">=</span> SpringContextUtils.getBeanOfType(JwtTokenProperty.class);<br><br>        <span class="hljs-type">JwtTokenVerifyRequest</span> <span class="hljs-variable">jwtTokenVerifyRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtTokenVerifyRequest</span>();<br>        jwtTokenVerifyRequest.setToken(token);<br>        jwtTokenVerifyRequest.setSecret(jwtTokenProperty.getSecret());<br><br>        <span class="hljs-type">JwtTokenVerifyDTO</span> <span class="hljs-variable">verify</span> <span class="hljs-operator">=</span> jwtTokenService.verify(jwtTokenVerifyRequest);<br>        <span class="hljs-keyword">if</span> (verify == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.TOKEN_FAILED);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后添加一个配置类，配置刚才的拦截器</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">package</span> com.yang.infrastructure.configuration;<br><br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.interceptors.JwtTokenVerifyInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-title class_"><span class="hljs-keyword">class</span> <span class="hljs-title">WebMvcConfiguration</span> <span class="hljs-keyword"><span class="hljs-keyword">implements</span> <span class="hljs-type">WebMvcConfigurer</span></span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> void addInterceptors(InterceptorRegistry registry) &#123;<br>        registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-type">JwtTokenVerifyInterceptor</span>())<br>                .addPathPatterns(<span class="hljs-string">&quot;/**&quot;</span>) <span class="hljs-comment">// 拦截所有请求</span><br>                .excludePathPatterns(<span class="hljs-string">&quot;/user/login&quot;</span>, <span class="hljs-string">&quot;/user/register&quot;</span>); <span class="hljs-comment">// 排除登录、注册接口</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="4-2-测试"><a href="#4-2-测试" class="headerlink" title="4.2. 测试"></a>4.2. 测试</h4><p>首先，我们在请求头，不添加token，访问测试接口，结果如下：</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/13.png" class=""><p>然后在请求头，添加无效的token，访问测试接口，结果如下：</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/14.png" class=""><p>携带登录返回的token，访问测试接口，结果如下：</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/15.png" class=""><h3 id="5-token存储"><a href="#5-token存储" class="headerlink" title="5. token存储"></a>5. token存储</h3><h4 id="5-1-准备工作"><a href="#5-1-准备工作" class="headerlink" title="5.1. 准备工作"></a>5.1. 准备工作</h4><p>上述实现，虽然能够完成登录拦截的需求，但是有一个问题，我们每次访问接口，都需要对token进行验证，判断这个token是否有效，为减少解析token的耗时，我们可以将token存起来并设置一个过期时间，这个时候，我们就可以使用reids了。此时，我们的调用流程，如下图所示：</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/16.png" class=""><p>因此，我们添加redis的相关依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="5-2-infrastructure层"><a href="#5-2-infrastructure层" class="headerlink" title="5.2. infrastructure层"></a>5.2. infrastructure层</h4><p>在基础设施层，添加上redis的配置类和相关的工具类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfiguration</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisTemplate <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;<br>        RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();<br>        redisTemplate.setConnectionFactory(redisConnectionFactory);<br><br>        <span class="hljs-type">StringRedisSerializer</span> <span class="hljs-variable">stringRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>();<br>        <span class="hljs-type">Jackson2JsonRedisSerializer</span> <span class="hljs-variable">jackson2JsonRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonRedisSerializer</span>(Object.class);<br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);<br>        jackson2JsonRedisSerializer.setObjectMapper(objectMapper);<br><br>        redisTemplate.setKeySerializer(stringRedisSerializer);<br>        redisTemplate.setHashKeySerializer(stringRedisSerializer);<br>        redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);<br>        redisTemplate.setHashValueSerializer(jackson2JsonRedisSerializer);<br>        <span class="hljs-keyword">return</span> redisTemplate;<br>    &#125;<br>&#125;<br><br><br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisUtils</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setKey</span><span class="hljs-params">(String key, Object value)</span> &#123;<br>        redisTemplate.opsForValue().set(key, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setKey</span><span class="hljs-params">(String key, Object value, Long expire)</span> &#123;<br>        setKey(key, value, expire, TimeUnit.SECONDS);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setKey</span><span class="hljs-params">(String key, Object value, Long expire, TimeUnit timeUnit)</span> &#123;<br>        redisTemplate.opsForValue().set(key, value, expire, timeUnit);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getKey</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-keyword">return</span> redisTemplate.opsForValue().get(key);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后修改JwtTokenVerifyInterceptor拦截器，先查询redis上是否存在对应的token，有的话放行，否则使用JwtTokenService验证token是否有效</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;token&quot;</span>);<br>      <span class="hljs-keyword">if</span> (StringUtils.isEmpty(token)) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.TOKEN_FAILED);<br>      &#125;<br>      <span class="hljs-keyword">if</span>(verifyByRedis(token)) &#123; <span class="hljs-comment">// 判断该token在Redis是否存在</span><br>          System.out.println(<span class="hljs-string">&quot;Redis中存在这个token，放行&quot;</span>);<br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      &#125;<br>      System.out.println(<span class="hljs-string">&quot;Redis中不存在这个token，解析该token&quot;</span>);<br>      <span class="hljs-type">JwtTokenService</span> <span class="hljs-variable">jwtTokenService</span> <span class="hljs-operator">=</span> SpringContextUtils.getBeanOfType(JwtTokenService.class);<br>      <span class="hljs-type">JwtTokenProperty</span> <span class="hljs-variable">jwtTokenProperty</span> <span class="hljs-operator">=</span> SpringContextUtils.getBeanOfType(JwtTokenProperty.class);<br><br>      <span class="hljs-type">JwtTokenVerifyRequest</span> <span class="hljs-variable">jwtTokenVerifyRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtTokenVerifyRequest</span>();<br>      jwtTokenVerifyRequest.setToken(token);<br>      jwtTokenVerifyRequest.setSecret(jwtTokenProperty.getSecret());<br><br>      <span class="hljs-type">JwtTokenVerifyDTO</span> <span class="hljs-variable">verify</span> <span class="hljs-operator">=</span> jwtTokenService.verify(jwtTokenVerifyRequest);<br>      <span class="hljs-keyword">if</span> (verify == <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.TOKEN_FAILED);<br>      &#125;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">verifyByRedis</span><span class="hljs-params">(String token)</span> &#123;<br>      <span class="hljs-type">RedisUtils</span> <span class="hljs-variable">redisUtils</span> <span class="hljs-operator">=</span> SpringContextUtils.getBeanOfType(RedisUtils.class);<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> redisUtils.getKey(<span class="hljs-string">&quot;token:&quot;</span> + token);<br>      <span class="hljs-keyword">return</span> key != <span class="hljs-literal">null</span>;<br>  &#125;<br></code></pre></td></tr></table></figure><h4 id="5-3-application层"><a href="#5-3-application层" class="headerlink" title="5.3. application层"></a>5.3. application层</h4><p>修改登录逻辑中，在生成token后，将token存入redis</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> UserLoginDTO <span class="hljs-title function_">login</span><span class="hljs-params">(LoginUserRequest request)</span> &#123;<br>       <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.login(request);<br>       <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.LOGIN_FAILED);<br>       &#125;<br>       <span class="hljs-comment">// 生成token</span><br>       <span class="hljs-type">UserLoginDTO</span> <span class="hljs-variable">userLoginDTO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserLoginDTO</span>();<br>       userLoginDTO.setUser(user);<br><br>       <span class="hljs-type">JwtTokenGenerateRequest</span> <span class="hljs-variable">jwtGenerateRequest</span> <span class="hljs-operator">=</span> convert2JwtTokenGenerateRequest(user);<br>       <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> jwtTokenService.generateJwtToken(jwtGenerateRequest);<br>       userLoginDTO.setToken(token);<br><br>       <span class="hljs-comment">// token存储到redis</span><br>       redisUtils.setKey(<span class="hljs-string">&quot;token:&quot;</span> + token, jwtGenerateRequest, jwtGenerateRequest.getExpireTime());<br>       <span class="hljs-keyword">return</span> userLoginDTO;<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="5-4-测试"><a href="#5-4-测试" class="headerlink" title="5.4. 测试"></a>5.4. 测试</h4><p>首先访问登录接口，登录成功后，查看redis中是否含有对应的token</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/17.png" class=""><p>redis中存在对应的token，然后我们访问测试接口，查看命令行,此时redis中存在该token，因此直接放行</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/18.png" class=""><p>然后我们删除redis中的这个key，再次访问测试接口，此时redis不存在这个key，因此就需要进行token的解析。</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/19.png" class=""><h3 id="6-用户信息更新"><a href="#6-用户信息更新" class="headerlink" title="6. 用户信息更新"></a>6. 用户信息更新</h3><p>用户信息，一般情况下更新的频率比较低，但也不是没有，常见的更新有：用户修改密码、用户修改昵称等。我们以用户修改密码为例，进行示例。<br>当用户修改密码时，我们只需要使用数据库中的salt，结合用户输入的新密码，生成新的哈希值，存入数据库，此外，因为用户信息更新了，我们最好将用户的token生效，存入redis的token，我们可以很容易地将其删除，但是，前端保存地token信息，我们修改不了，因此，最好是前端在更新操作成功后，主动删除请求头的token，从而时用户再次操作时，提示token失效，进行登录。</p><h4 id="6-1-infrastructure层"><a href="#6-1-infrastructure层" class="headerlink" title="6.1. infrastructure层"></a>6.1. infrastructure层</h4><p>首先，修改RedisUtils工具类，加上删除key的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">removeKey</span><span class="hljs-params">(String key)</span> &#123;<br>       <span class="hljs-keyword">return</span> redisTemplate.delete(key);<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="6-2-domain层"><a href="#6-2-domain层" class="headerlink" title="6.2. domain层"></a>6.2. domain层</h4><p>修改UserService，添加修改密码的相关操作</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updatePassword</span><span class="hljs-params">(UpdatePasswordRequest request)</span> &#123;<br>       <span class="hljs-type">Integer</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> request.getId();<br>       <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userRepository.findById(userId);<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>           <span class="hljs-keyword">return</span>;<br>       &#125;<br>       <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> request.getPassword();<br>       <span class="hljs-type">String</span> <span class="hljs-variable">newPassword</span> <span class="hljs-operator">=</span> EncryptUtils.encrypt(password, user.getSalt());<br>       user.setPassword(newPassword);<br><br>       <span class="hljs-keyword">try</span> &#123;<br>           userRepository.updateUser(user);<br>       &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.SERVER_ERROR);<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="6-3-application层"><a href="#6-3-application层" class="headerlink" title="6.3. application层"></a>6.3. application层</h4><p>在UserApplicationService类，添加修改用户密码的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updatePassword</span><span class="hljs-params">(UpdatePasswordRequest updatePasswordRequest, HttpServletRequest request)</span> &#123;<br>       userService.updatePassword(updatePasswordRequest);<br>       <br>       <span class="hljs-comment">// 删除token</span><br>       <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;token&quot;</span>);<br>       redisUtils.removeKey(<span class="hljs-string">&quot;token:&quot;</span> + token);<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="6-4-controller层"><a href="#6-4-controller层" class="headerlink" title="6.4. controller层"></a>6.4. controller层</h4><p>在UserController类，添加修改用户密码的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PutMapping(value = &quot;/updatePassword&quot;)</span><br>   <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">updatePassword</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> UpdatePasswordRequest request, HttpServletRequest httpServletRequest)</span> &#123;<br>       userApplicationService.updatePassword(request, httpServletRequest);<br>       <span class="hljs-keyword">return</span> Response.success();<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="6-5-测试"><a href="#6-5-测试" class="headerlink" title="6.5. 测试"></a>6.5. 测试</h4><p>首先进行登录，登录成功后，在redis中多了一个token</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/20.png" class=""><p>然后调用更新密码接口</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/21.png" class=""><p>再次查看redis，发现token被删除了，然后查看数据库，能看出我们的密码也改变了</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/22.png" class=""><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/23.png" class=""><h3 id="7-用户上下文"><a href="#7-用户上下文" class="headerlink" title="7. 用户上下文"></a>7. 用户上下文</h3><p>上面的代码，看似合理，但是有一个问题，更新密码的时候，传了两个值，一个是用户id，另一个才是用户输入的密码。在之前我们提到，我们通过登录拦截，规避了未登录用户操作系统资源的问题，但是对于我们刚才实现的修改密码接口，可能出现这种情况，用户A携带自己登录的token，请求体中id为用户B的id，调用修改密码的接口，这就导致，用户A修改了用户B的密码，这是不合理的，因此，这里将对代码进一步做修改，在进行拦截操作后，将用户信息，存储于用户上下文，然后在修改密码时，直接使用用户上下文中的用户id，而不是依靠前端传递的id。</p><h4 id="7-1-infrastructure层"><a href="#7-1-infrastructure层" class="headerlink" title="7.1. infrastructure层"></a>7.1. infrastructure层</h4><p>首先，我们定义一个用户上下文信息类，用于存储用户的主要信息，包括用户id，token，用户名等。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.infrastructure.auth;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserContextDetails</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> Integer id;<br>    <br>    <span class="hljs-keyword">private</span> String token;<br>    <br>    <span class="hljs-keyword">private</span> String username;<br>    <br>    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; extendMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>&#125;<br></code></pre></td></tr></table></figure><p>添加一个线程上下文类，用于存储用户上下文信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.infrastructure.auth;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserContextThreadLocal</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;UserContextDetails&gt; userContextDetailsThreadLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUserContextDetails</span><span class="hljs-params">(UserContextDetails userContextDetails)</span> &#123;<br>        userContextDetailsThreadLocal.set(userContextDetails);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> UserContextDetails <span class="hljs-title function_">get</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> userContextDetailsThreadLocal.get();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">()</span> &#123;<br>        userContextDetailsThreadLocal.remove();<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Integer <span class="hljs-title function_">getUserId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> userContextDetailsThreadLocal.get().getId();<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getToken</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> userContextDetailsThreadLocal.get().getToken();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后，修改我们的JwtTokenVerifyInterceptor拦截器，这里我们实现了afterCompletion。在preHandler方法中，设置对应的线程上下文，在afterCompletion清除线程上下文，注意，设置线程上下文和清除线程上下文的操作，必须成对出现，否则会造成内存泄露。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yang.infrastructure.auth.interceptors;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.UserContextDetails;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.UserContextThreadLocal;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.config.JwtTokenProperty;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.request.JwtTokenVerifyRequest;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.response.JwtTokenVerifyDTO;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.auth.service.JwtTokenService;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.common.ResultCode;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.exception.BusinessException;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.utils.RedisUtils;<br><span class="hljs-keyword">import</span> com.yang.infrastructure.utils.SpringContextUtils;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.lang.Nullable;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtTokenVerifyInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;token&quot;</span>);<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(token)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.TOKEN_FAILED);<br>        &#125;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">userDetails</span> <span class="hljs-operator">=</span> getUserDetailsFromRedis(token);<br>        <span class="hljs-keyword">if</span> (userDetails != <span class="hljs-literal">null</span>) &#123; <span class="hljs-comment">// 判断该token在Redis是否存在</span><br>            <span class="hljs-comment">// 设置线程上下文</span><br>            System.out.println(<span class="hljs-string">&quot;设置线程上下文====================&quot;</span>);<br>            <span class="hljs-type">UserContextDetails</span> <span class="hljs-variable">userContextDetails</span> <span class="hljs-operator">=</span> (UserContextDetails) userDetails;<br>            userContextDetails.setToken(token);<br>            UserContextThreadLocal.setUserContextDetails(userContextDetails);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-type">JwtTokenService</span> <span class="hljs-variable">jwtTokenService</span> <span class="hljs-operator">=</span> SpringContextUtils.getBeanOfType(JwtTokenService.class);<br>        <span class="hljs-type">JwtTokenProperty</span> <span class="hljs-variable">jwtTokenProperty</span> <span class="hljs-operator">=</span> SpringContextUtils.getBeanOfType(JwtTokenProperty.class);<br><br>        <span class="hljs-type">JwtTokenVerifyRequest</span> <span class="hljs-variable">jwtTokenVerifyRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtTokenVerifyRequest</span>();<br>        jwtTokenVerifyRequest.setToken(token);<br>        jwtTokenVerifyRequest.setSecret(jwtTokenProperty.getSecret());<br><br>        <span class="hljs-type">JwtTokenVerifyDTO</span> <span class="hljs-variable">verify</span> <span class="hljs-operator">=</span> jwtTokenService.verify(jwtTokenVerifyRequest);<br>        <span class="hljs-keyword">if</span> (verify == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.TOKEN_FAILED);<br>        &#125;<br><br>        <span class="hljs-comment">// 设置线程上下文</span><br>        System.out.println(<span class="hljs-string">&quot;设置线程上下文====================&quot;</span>);<br>        <span class="hljs-type">UserContextDetails</span> <span class="hljs-variable">userContextDetails</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserContextDetails</span>();<br>        userContextDetails.setId(Integer.valueOf(verify.getSubject()));<br>        userContextDetails.setToken(token);<br>        userContextDetails.setUsername(verify.getPayLoads().get(<span class="hljs-string">&quot;username&quot;</span>));<br>        userContextDetails.setExtendMap(verify.getPayLoads());<br>        UserContextThreadLocal.setUserContextDetails(userContextDetails);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">getUserDetailsFromRedis</span><span class="hljs-params">(String token)</span> &#123;<br>        <span class="hljs-type">RedisUtils</span> <span class="hljs-variable">redisUtils</span> <span class="hljs-operator">=</span> SpringContextUtils.getBeanOfType(RedisUtils.class);<br>        <span class="hljs-keyword">return</span> redisUtils.getKey(<span class="hljs-string">&quot;token:&quot;</span> + token);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, <span class="hljs-meta">@Nullable</span> Exception ex)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;清除线程上下文=======================&quot;</span>);<br>        <span class="hljs-comment">// 清除线程上下文</span><br>        UserContextThreadLocal.remove();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="7-2-domain层"><a href="#7-2-domain层" class="headerlink" title="7.2. domain层"></a>7.2. domain层</h4><p>修改UserService的updatePassword方法，userId从线程上下文获取</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updatePassword</span><span class="hljs-params">(UpdatePasswordRequest request)</span> &#123;<br>       <span class="hljs-type">Integer</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserContextThreadLocal.getUserId();<br>       <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userRepository.findById(userId);<br>       <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>           <span class="hljs-keyword">return</span>;<br>       &#125;<br>       <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> request.getPassword();<br>       <span class="hljs-type">String</span> <span class="hljs-variable">newPassword</span> <span class="hljs-operator">=</span> EncryptUtils.encrypt(password, user.getSalt());<br>       user.setPassword(newPassword);<br><br>       <span class="hljs-keyword">try</span> &#123;<br>           userRepository.updateUser(user);<br>       &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.SERVER_ERROR);<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="7-3-application层"><a href="#7-3-application层" class="headerlink" title="7.3. application层"></a>7.3. application层</h4><p>修改application层updatePassword方法，token从线程上下文获取</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updatePassword</span><span class="hljs-params">(UpdatePasswordRequest updatePasswordRequest)</span> &#123;<br>       userService.updatePassword(updatePasswordRequest);<br><br>       <span class="hljs-comment">// 删除token</span><br>       <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> UserContextThreadLocal.getToken();<br>       redisUtils.removeKey(<span class="hljs-string">&quot;token:&quot;</span> + token);<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="7-4-controller层"><a href="#7-4-controller层" class="headerlink" title="7.4. controller层"></a>7.4. controller层</h4><p>修改controller层的updatePassword方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PutMapping(value = &quot;/updatePassword&quot;)</span><br>   <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">updatePassword</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> UpdatePasswordRequest request)</span> &#123;<br>       userApplicationService.updatePassword(request);<br>       <span class="hljs-keyword">return</span> Response.success();<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="7-5-测试"><a href="#7-5-测试" class="headerlink" title="7.5. 测试"></a>7.5. 测试</h4><p>调用用户登录接口，然后查看redis，可以看出，现在存储的value类型，是UserContextDetails类型</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/24.png" class=""><p>调用测试接口，然后查看控制台</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/25.png" class=""><p>然后查看控制台，从控制台中可以看出，设置线程上下文和清除线程上下文成对出现。</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/26.png" class=""><p>测试修改密码接口</p><img src="/2024/04/03/%E7%99%BB%E5%BD%95%E3%80%81%E6%B3%A8%E5%86%8C%E5%AD%A6%E4%B9%A0/27.png" class=""><p>修改成功，说明线程上下文的取值没有问题。</p><h3 id="8-参考文档"><a href="#8-参考文档" class="headerlink" title="8. 参考文档"></a>8. 参考文档</h3><p><a href="https://segmentfault.com/a/1190000040003653">https://segmentfault.com/a/1190000040003653</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>SpringBoot</tag>
      
      <tag>SpringSecurity</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MongoDB学习2—SpringBoot集成MongoDB</title>
    <link href="/2024/04/03/MongoDB%E5%AD%A6%E4%B9%A02%E2%80%94SpringBoot%E9%9B%86%E6%88%90MongoDB/"/>
    <url>/2024/04/03/MongoDB%E5%AD%A6%E4%B9%A02%E2%80%94SpringBoot%E9%9B%86%E6%88%90MongoDB/</url>
    
    <content type="html"><![CDATA[<h3 id="1-引言"><a href="#1-引言" class="headerlink" title="1. 引言"></a>1. 引言</h3><p>SpringBoot要集成MongoDB，可以直接使用spring-data-mongodb提供的MongoTemplate和MongoRepository这两种方式，前者操作比较灵活，后者比较简单。<br>引入依赖如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>joda-time<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>joda-time<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.10.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.vintage<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-vintage-engine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><p>application.yml配置信息如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">data:</span><br>    <span class="hljs-attr">mongodb:</span><br>      <span class="hljs-attr">uri:</span> <span class="hljs-string">mongodb://127.0.0.1:27017/test</span><br></code></pre></td></tr></table></figure><h3 id="2-代码示例"><a href="#2-代码示例" class="headerlink" title="2. 代码示例"></a>2. 代码示例</h3><p>首先，我们创建一个test数据库，在这个数据库中，创建一个user集合，用于演示：</p><img src="/2024/04/03/MongoDB%E5%AD%A6%E4%B9%A02%E2%80%94SpringBoot%E9%9B%86%E6%88%90MongoDB/1.png" class=""><h4 id="2-1-MongoTemplate使用"><a href="#2-1-MongoTemplate使用" class="headerlink" title="2.1. MongoTemplate使用"></a>2.1. MongoTemplate使用</h4><h5 id="2-1-1-插入和简单查询"><a href="#2-1-1-插入和简单查询" class="headerlink" title="2.1.1. 插入和简单查询"></a>2.1.1. 插入和简单查询</h5><p>我们添加测试方法，首先测试插入和一些简单查询：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testInsertAndSimpleFind</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-comment">// 测试添加</span><br>       <span class="hljs-type">User</span> <span class="hljs-variable">createUser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>       createUser.setAge(<span class="hljs-number">20</span>);<br>       createUser.setName(<span class="hljs-string">&quot;cxy&quot;</span>);<br>       createUser.setEmail(<span class="hljs-string">&quot;123@qq.com&quot;</span>);<br>       createUser.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>       createUser = mongoTemplate.insert(createUser);<br>       System.out.println(JSONObject.toJSONString(createUser));<br><br>       <span class="hljs-comment">// 根据id查询</span><br>       <span class="hljs-type">User</span> <span class="hljs-variable">userById</span> <span class="hljs-operator">=</span> mongoTemplate.findById(createUser.getId(), User.class);<br>       System.out.println(JSONObject.toJSONString(userById));<br><br>       <span class="hljs-comment">// 查询全部</span><br>       List&lt;User&gt; allUsers = mongoTemplate.findAll(User.class);<br>       System.out.println(JSONObject.toJSONString(allUsers));<br>   &#125;<br></code></pre></td></tr></table></figure><p>执行结果如下：</p><img src="/2024/04/03/MongoDB%E5%AD%A6%E4%B9%A02%E2%80%94SpringBoot%E9%9B%86%E6%88%90MongoDB/2.png" class=""><p>查看数据库，确实多了一条记录</p><img src="/2024/04/03/MongoDB%E5%AD%A6%E4%B9%A02%E2%80%94SpringBoot%E9%9B%86%E6%88%90MongoDB/3.png" class=""><h5 id="2-1-2-更新"><a href="#2-1-2-更新" class="headerlink" title="2.1.2. 更新"></a>2.1.2. 更新</h5><p>接着我们测试mongoTemplate的修改</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testUpdateMongoTemplate</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;65ea70bf090d176df859e5fa&quot;</span>;<br>      <span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Query</span>(Criteria.where(<span class="hljs-string">&quot;_id&quot;</span>).is(id));<br>      <span class="hljs-type">Update</span> <span class="hljs-variable">update</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Update</span>();<br>      update.set(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;cxy123&quot;</span>);<br>      update.set(<span class="hljs-string">&quot;age&quot;</span>, <span class="hljs-number">20</span>);<br>      <span class="hljs-type">UpdateResult</span> <span class="hljs-variable">upsert</span> <span class="hljs-operator">=</span> mongoTemplate.upsert(query, update, User.class);<br>      <span class="hljs-type">long</span> <span class="hljs-variable">modifiedCount</span> <span class="hljs-operator">=</span> upsert.getModifiedCount();<br>      System.out.println(<span class="hljs-string">&quot;受影响的条数：&quot;</span> + modifiedCount);<br>  &#125;<br></code></pre></td></tr></table></figure><p>执行上述代码，查看数据库，数据库确实被修改了。</p><img src="/2024/04/03/MongoDB%E5%AD%A6%E4%B9%A02%E2%80%94SpringBoot%E9%9B%86%E6%88%90MongoDB/4.png" class=""><h5 id="2-1-3-删除"><a href="#2-1-3-删除" class="headerlink" title="2.1.3. 删除"></a>2.1.3. 删除</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDeleteMongoTemplate</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;65ea70bf090d176df859e5fa&quot;</span>;<br>       <span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Query</span>(Criteria.where(<span class="hljs-string">&quot;_id&quot;</span>).is(id));<br>       <span class="hljs-type">DeleteResult</span> <span class="hljs-variable">deleteResult</span> <span class="hljs-operator">=</span> mongoTemplate.remove(query, User.class);<br>       System.out.println(<span class="hljs-string">&quot;删除个数：&quot;</span> + deleteResult.getDeletedCount());<br>   &#125;<br></code></pre></td></tr></table></figure><p>执行完毕后，查看数控库，相关的集合被成功删除。</p><img src="/2024/04/03/MongoDB%E5%AD%A6%E4%B9%A02%E2%80%94SpringBoot%E9%9B%86%E6%88%90MongoDB/5.png" class=""><h5 id="2-1-4-条件查询"><a href="#2-1-4-条件查询" class="headerlink" title="2.1.4. 条件查询"></a>2.1.4. 条件查询</h5><p>我们先插入一些测试数据，方便后续测试条件查询</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertTestUser</span><span class="hljs-params">()</span> &#123;<br>     <span class="hljs-type">User</span> <span class="hljs-variable">user1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>     user1.setName(<span class="hljs-string">&quot;张三&quot;</span>);<br>     user1.setAge(<span class="hljs-number">10</span>);<br>     user1.setEmail(<span class="hljs-string">&quot;zhangsna@qq.com&quot;</span>);<br>     user1.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>     <br>     <span class="hljs-type">User</span> <span class="hljs-variable">user2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>     user2.setName(<span class="hljs-string">&quot;李四&quot;</span>);<br>     user2.setAge(<span class="hljs-number">20</span>);<br>     user2.setEmail(<span class="hljs-string">&quot;lisi@163.com&quot;</span>);<br>     user2.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>     <br>     <span class="hljs-type">User</span> <span class="hljs-variable">user3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>     user3.setName(<span class="hljs-string">&quot;王五&quot;</span>);<br>     user3.setAge(<span class="hljs-number">30</span>);<br>     user3.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>     <br>     List&lt;User&gt; userList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>     userList.add(user1);<br>     userList.add(user2);<br>     userList.add(user3);<br>     <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>         <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>         user.setName(<span class="hljs-string">&quot;name:&quot;</span> + i);<br>         user.setAge(<span class="hljs-number">20</span> + i);<br>         user.setEmail(<span class="hljs-string">&quot;template&quot;</span> + i + <span class="hljs-string">&quot;@qq.com&quot;</span>);<br>         user.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>         userList.add(user);<br>     &#125;<br>     mongoTemplate.insert(userList, User.class);<br> &#125;<br></code></pre></td></tr></table></figure><p>假设我们现在查询姓名为张三的用户：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testFindByName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Query</span>();<br>        query.addCriteria(Criteria.where(<span class="hljs-string">&quot;name&quot;</span>).is(<span class="hljs-string">&quot;张三&quot;</span>));<br>        <span class="hljs-type">User</span> <span class="hljs-variable">zhangsan</span> <span class="hljs-operator">=</span> mongoTemplate.findOne(query, User.class);<br>        System.out.println(<span class="hljs-string">&quot;张三：&quot;</span> + JSONObject.toJSONString(zhangsan));<br>    &#125;<br></code></pre></td></tr></table></figure><p>执行结果如下：</p><img src="/2024/04/03/MongoDB%E5%AD%A6%E4%B9%A02%E2%80%94SpringBoot%E9%9B%86%E6%88%90MongoDB/6.png" class=""><p>查询年龄在20到30之间的用户：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testFindByAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Query</span>();<br>        query.addCriteria(Criteria.where(<span class="hljs-string">&quot;age&quot;</span>).gte(<span class="hljs-number">20</span>).lte(<span class="hljs-number">30</span>));<br>        List&lt;User&gt; users = mongoTemplate.find(query, User.class);<br>        <span class="hljs-keyword">for</span> (User user : users) &#123;<br>            System.out.println(<span class="hljs-string">&quot;age:&quot;</span> + user.getAge() + <span class="hljs-string">&quot;:&quot;</span> + JSONObject.toJSONString(user));<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>结果如下：</p><img src="/2024/04/03/MongoDB%E5%AD%A6%E4%B9%A02%E2%80%94SpringBoot%E9%9B%86%E6%88%90MongoDB/7.png" class=""><p>当我们要进行查询的时候，可以使用where来查询，上述演示的，只是对一个field进行条件查询，当我们需要对多个field进行条件查询时，可以使用and来连接，假设我们要查询姓名为王五并且年龄为30岁的人，测试方法如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testFindByNameAndAge</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Query</span>();<br>      query.addCriteria(Criteria.where(<span class="hljs-string">&quot;name&quot;</span>).is(<span class="hljs-string">&quot;王五&quot;</span>)<br>              .and(<span class="hljs-string">&quot;age&quot;</span>).is(<span class="hljs-number">30</span>));<br><br>      List&lt;User&gt; users = mongoTemplate.find(query, User.class);<br>      <span class="hljs-keyword">for</span> (User user : users) &#123;<br>          System.out.println(<span class="hljs-string">&quot;age:&quot;</span> + user.getAge() + <span class="hljs-string">&quot;:&quot;</span> + JSONObject.toJSONString(user));<br>      &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><p>测试结果如下：</p><img src="/2024/04/03/MongoDB%E5%AD%A6%E4%B9%A02%E2%80%94SpringBoot%E9%9B%86%E6%88%90MongoDB/8.png" class=""><h5 id="2-1-5-分页查询"><a href="#2-1-5-分页查询" class="headerlink" title="2.1.5. 分页查询"></a>2.1.5. 分页查询</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testPage</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-type">int</span> <span class="hljs-variable">pageNo</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>       <span class="hljs-type">int</span> <span class="hljs-variable">pageSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br><br>       <span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Query</span>();<br>       query.skip((pageNo - <span class="hljs-number">1</span>) * pageSize).limit(pageSize);<br>       List&lt;User&gt; users = mongoTemplate.find(query, User.class);<br>       <span class="hljs-keyword">for</span> (User user : users) &#123;<br>           System.out.println(<span class="hljs-string">&quot;user:&quot;</span> + JSONObject.toJSONString(user));<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><p>测试结果如下：</p><img src="/2024/04/03/MongoDB%E5%AD%A6%E4%B9%A02%E2%80%94SpringBoot%E9%9B%86%E6%88%90MongoDB/9.png" class=""><h4 id="2-2-MongoRepository"><a href="#2-2-MongoRepository" class="headerlink" title="2.2. MongoRepository"></a>2.2. MongoRepository</h4><p>Spring Data提供对mongodb数据访问的支持，我们只需要继承MongoRepository类，按照SpringData规范就可以了。<br>首先，我们添加UserRepository接口，继承MongoRepository&lt;User, String&gt;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.repository;<br><br><span class="hljs-keyword">import</span> org.example.pojo.User;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.repository.MongoRepository;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Repository;<br><br><span class="hljs-meta">@Repository</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MongoRepository</span>&lt;User, String&gt; &#123;<br>&#125;<br><br>然后创建UserService，用于对user进行增删改查<br><span class="hljs-keyword">package</span> org.example.service;<br><br><span class="hljs-keyword">import</span> org.example.pojo.User;<br><span class="hljs-keyword">import</span> org.example.repository.UserRepository;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.data.domain.*;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserRepository userRepository;<br>    <br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">saveUser</span><span class="hljs-params">(User user)</span> &#123;<br>        user.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        <span class="hljs-keyword">return</span> userRepository.save(user);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> &#123;<br>        <span class="hljs-comment">// 插入和更新都是使用save</span><br>        <span class="hljs-keyword">return</span> userRepository.save(user);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeUserById</span><span class="hljs-params">(String id)</span> &#123;<br>        userRepository.deleteById(id);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findById</span><span class="hljs-params">(String id)</span> &#123;<br>        <span class="hljs-keyword">return</span> userRepository.findById(id).get();<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> userRepository.findAll();<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">findByNameAndAge</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">conditionUser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>        conditionUser.setName(name);<br>        conditionUser.setAge(age);<br>        Example&lt;User&gt; example = Example.of(conditionUser);<br>        <span class="hljs-keyword">return</span> userRepository.findAll(example);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">findPage</span><span class="hljs-params">(<span class="hljs-type">int</span> pageNo, <span class="hljs-type">int</span> pageSize)</span> &#123;<br>        <span class="hljs-type">Pageable</span> <span class="hljs-variable">pageable</span> <span class="hljs-operator">=</span> PageRequest.of(pageNo, pageSize);<br>        Page&lt;User&gt; page = userRepository.findAll(pageable);<br>        <span class="hljs-keyword">return</span> page.getContent();<br>    &#125;<br>    <br>   <br>&#125;<br></code></pre></td></tr></table></figure><p>添加测试方法，测试查询是否生效：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>   <span class="hljs-keyword">private</span> UserService userService;<br><br>   <span class="hljs-meta">@Test</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testFind</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-comment">// 根据id查询</span><br>       <span class="hljs-type">User</span> <span class="hljs-variable">findById</span> <span class="hljs-operator">=</span> userService.findById(<span class="hljs-string">&quot;65ea7586b4c1f3160f791b06&quot;</span>);<br>       System.out.println(JSONObject.toJSONString(findById));<br><br>       <span class="hljs-comment">// 根据姓名和年龄查询</span><br>       List&lt;User&gt; zhangsan = userService.findByNameAndAge(<span class="hljs-string">&quot;张三&quot;</span>, <span class="hljs-number">10</span>);<br>       System.out.println(JSONObject.toJSONString(zhangsan));<br><br>       <span class="hljs-comment">// 分页查询</span><br>       List&lt;User&gt; page = userService.findPage(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>);<br>       System.out.println(JSONObject.toJSONString(page));<br><br>       <span class="hljs-comment">// 查询全部</span><br>       List&lt;User&gt; all = userService.findAll();<br>       System.out.println(JSONObject.toJSONString(all));<br><br>   &#125;<br></code></pre></td></tr></table></figure><p>查询结果如下：</p><img src="/2024/04/03/MongoDB%E5%AD%A6%E4%B9%A02%E2%80%94SpringBoot%E9%9B%86%E6%88%90MongoDB/10.png" class="">]]></content>
    
    
    
    <tags>
      
      <tag>中间件</tag>
      
      <tag>MongoDB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MongoDB学习1—MongoDB简介</title>
    <link href="/2024/04/03/MongoDB%E5%AD%A6%E4%B9%A01%E2%80%94MongoDB%E7%AE%80%E4%BB%8B/"/>
    <url>/2024/04/03/MongoDB%E5%AD%A6%E4%B9%A01%E2%80%94MongoDB%E7%AE%80%E4%BB%8B/</url>
    
    <content type="html"><![CDATA[<h3 id="1-MongoDB介绍"><a href="#1-MongoDB介绍" class="headerlink" title="1. MongoDB介绍"></a>1. MongoDB介绍</h3><h4 id="1-1-什么是MongoDB"><a href="#1-1-什么是MongoDB" class="headerlink" title="1.1. 什么是MongoDB"></a>1.1. 什么是MongoDB</h4><p>MongoDB是由C++语言编写的，是一个基于分布式文件存储的开源数据库系统，旨在为WEB应用提供可扩展的高性能数据存储解决方案。它将数据存储为一个文档，数据结构由键值(key&#x3D;&gt;value）对组成，MongoDB文档类似于JSON对象，字段值可以包含其他文档，数组即文档数组。</p><img src="/2024/04/03/MongoDB%E5%AD%A6%E4%B9%A01%E2%80%94MongoDB%E7%AE%80%E4%BB%8B/1.png" class=""><h4 id="1-2-特点"><a href="#1-2-特点" class="headerlink" title="1.2. 特点"></a>1.2. 特点</h4><p>MongoDB具有以下特点：</p><ol><li>文档导向： MongoDB使用文档导向的数据模型，数据以文档的形式存储，类似于JSON对象。文档是一个键值对的集合，支持嵌套结构和动态模式。</li><li>灵活的模式： MongoDB是一个无模式（Schemaless）数据库，意味着不需要预定义模式和表结构。每个文档可以具有不同的字段和结构，这使得数据模型更加灵活，适用于各种类型的数据。</li><li>分布式存储： MongoDB可以在多个服务器上进行部署，实现数据的分布式存储和横向扩展。它支持副本集（Replica Set）和分片集群（Sharded Cluster），提供高可用性和可伸缩性。</li><li>丰富的查询语言： MongoDB提供了丰富的查询功能，支持灵活的条件查询、范围查询、正则表达式、聚合管道等。它还支持地理空间查询和文本搜索等特殊类型的查询。</li><li>支持事务： MongoDB从版本4.0开始支持事务，可以在单个文档或多个文档上执行原子性的读写操作。事务能够确保数据的一致性和完整性，适用于复杂的数据操作场景。</li></ol><h4 id="1-3-MongoDB的应用"><a href="#1-3-MongoDB的应用" class="headerlink" title="1.3. MongoDB的应用"></a>1.3. MongoDB的应用</h4><p>MongoDB在许多应用场景中具有广泛的应用，以下是一些常见的MongoDB应用场景：</p><ol><li>实时分析和大数据处理： MongoDB适用于实时数据分析和大数据处理场景。它可以存储和处理大量的非结构化或半结构化数据，支持高并发读写操作和复杂的聚合查询。这使得它成为处理实时数据、日志分析和数据挖掘等任务的理想选择。</li><li>内容管理系统（CMS）： MongoDB可以用作内容管理系统的后端数据库。它的灵活的数据模型和无模式特性使得存储和管理各种类型的内容（如文章、页面、多媒体文件等）变得简单。此外，MongoDB的高性能和可扩展性能够满足CMS的需求。</li><li>物联网（IoT）应用： MongoDB适用于物联网应用，用于存储和处理大量的传感器数据和设备数据。它可以轻松地处理大规模的时间序列数据，支持地理空间查询和实时数据分析，使得物联网应用的数据管理和分析更加便捷。</li><li>实时应用和实时通信： MongoDB的低延迟和高吞吐量使其适用于实时应用和实时通信场景。它可以存储和处理实时产生的数据，如聊天消息、实时推送、实时游戏数据等。MongoDB的副本集和分片集群提供了高可用性和可伸缩性，确保实时应用的稳定性和性能。</li><li>目录和目标存储： MongoDB可以用作目录和目标存储，用于存储和管理大量的结构化和非结构化数据。它的灵活的数据模型和强大的查询功能使得存储和检索数据变得更高效和便捷。</li><li>用户数据和个性化推荐： MongoDB可以存储和管理用户数据，如用户配置、偏好设置、历史记录等。它可以用于个性化推荐系统，根据用户的行为和偏好提供个性化的推荐内容。</li></ol><h3 id="2-MongoDB安装和启动"><a href="#2-MongoDB安装和启动" class="headerlink" title="2. MongoDB安装和启动"></a>2. MongoDB安装和启动</h3><p>windows下载地址：<a href="https://www.mongodb.com/try/download/community">https://www.mongodb.com/try/download/community</a><br>下载完毕后，安装过程中，一路next就可以，如果不想放到C盘，在下面这一步选择想要存放的位置，其余的next就可以了。</p><img src="/2024/04/03/MongoDB%E5%AD%A6%E4%B9%A01%E2%80%94MongoDB%E7%AE%80%E4%BB%8B/2.png" class=""><p>安装完毕后，在MongoDB目录的bin目录下，执行mongod.exe文件，启动mongodb。<br>启动完毕后，可以访问<a href="http://localhost:27017，出现下面内容，说明启动成功">http://localhost:27017，出现下面内容，说明启动成功</a></p><img src="/2024/04/03/MongoDB%E5%AD%A6%E4%B9%A01%E2%80%94MongoDB%E7%AE%80%E4%BB%8B/3.png" class=""><h3 id="3-MongoDB概念"><a href="#3-MongoDB概念" class="headerlink" title="3. MongoDB概念"></a>3. MongoDB概念</h3><p>在MongoDB中，基本的概念是文档、集合、数据库，如下表所示：</p><table><thead><tr><th>SQL术语概念</th><th>MongoDB术语概念</th><th>解释</th></tr></thead><tbody><tr><td>database</td><td>database</td><td>数据库</td></tr><tr><td>table</td><td>collection</td><td>数据库表&#x2F;集合</td></tr><tr><td>row</td><td>document</td><td>数据库行&#x2F;文档</td></tr><tr><td>column</td><td>field</td><td>数据库字段&#x2F;域</td></tr><tr><td>index</td><td>index</td><td>索引</td></tr><tr><td>table joins</td><td></td><td>表连接,MongoDB不支持</td></tr><tr><td>primary key</td><td>primary key</td><td>主键，MongoDB自动将_id字段设置为主键</td></tr></tbody></table><h4 id="3-1-数据库"><a href="#3-1-数据库" class="headerlink" title="3.1. 数据库"></a>3.1. 数据库</h4><p>一个mongodb中可以创建多个数据库，默认数据库为”db”，数据库的命名有以下要求：<br>1）不能是空字符串(“”)<br>2）不得含有’’(空格)、.、$、&#x2F;、和\0（空字符）<br>3）应全部小写<br>4）最多64字节<br>有一些数据库名是保留的，可以直接访问这些有特殊作用的数据库：<br>1）admin：从权限的角度来看，这生”root”数据库，要是将一个用户添加到这个数据库，这个用户自动继承所有数据库的权限，一些特定的服务器端命令也智能从这个数据库运行，比如列出所有的数据库或者关闭服务器。<br>2）local：这个数据永远不会被复制，可以用来存储于本地单台服务器的任何集合<br>3）config：当Mongo用于分片设置时，config数据库在内部使用，用于保存分片的相关信息。</p><h4 id="3-2-文档（Document）"><a href="#3-2-文档（Document）" class="headerlink" title="3.2. 文档（Document）"></a>3.2. 文档（Document）</h4><p>文档是一组键值(key-value)对，但MongoDB的文档不需要设置相同的字段，并且相同字段不需要相同的数据类型，这与关系型数据库有很大区别，也是MongoDB非常突出的特点。<br>需要注意的是：</p><ol><li>文档中的键&#x2F;值对是有序的。</li><li>文档中的值不仅可以是在双引号里面的字符串，还可以是其他几种数据类型（甚至可以是整个嵌入的文档)。</li><li>MongoDB区分类型和大小写。</li><li>MongoDB的文档不能有重复的键。</li><li>文档的键是字符串。除了少数例外情况，键可以使用任意UTF-8字符。</li></ol><h4 id="3-3-集合"><a href="#3-3-集合" class="headerlink" title="3.3. 集合"></a>3.3. 集合</h4><p>集合就是MongoDB文档组，类似于RDBMS（关系数据库管理系统:Relational Database Management System)中的表格。<br>集合存在于数据库中，集合没有固定的结构，这意味着你在对集合可以插入不同格式和类型的数据，但通常情况下我们插入集合的数据库都会有一定的关联性。</p><h4 id="3-4-MongoDB数据类型："><a href="#3-4-MongoDB数据类型：" class="headerlink" title="3.4. MongoDB数据类型："></a>3.4. MongoDB数据类型：</h4><p>下表是MongoDB中常用的数据类型：</p><table><thead><tr><th>数据类型</th><th>描述</th></tr></thead><tbody><tr><td>String</td><td>字符串。 存储数据常用的数据类型。在 MongoDB 中，UTF-8 编码的字符串才是合法的。</td></tr><tr><td>Integer</td><td>整型数值。用于存储数值。根据你所采用的服务器，可分为 32 位或 64 位。</td></tr><tr><td>Boolean</td><td>布尔值。用于存储布尔值（真&#x2F;假）。</td></tr><tr><td>Double</td><td>双精度浮点值。用于存储浮点值。</td></tr><tr><td>Min&#x2F;Max keys</td><td>将一个值与 BSON（二进制的 JSON）元素的最低值和最高值相对比。 Array 用于将数组或列表或多个值存储为一个键。</td></tr><tr><td>Timestamp</td><td>时间戳。记录文档修改或添加的具体时间。</td></tr><tr><td>Object</td><td>用于内嵌文档。</td></tr><tr><td>Null</td><td>用于创建空值。</td></tr><tr><td>Symbol</td><td>符号。该数据类型基本上等同于字符串类型，但不同的是，它一般用于采用特殊符号类型的语言。</td></tr><tr><td>Date</td><td>日期时间。用 UNIX 时间格式来存储当前日期或时间。你可以指定自己的日期时间：创建 Date 对象，传入年月日信息。</td></tr><tr><td>Object ID</td><td>对象 ID。用于创建文档的 ID。</td></tr><tr><td>Binary Data</td><td>二进制数据。 用于存储二进制数据。</td></tr><tr><td>Code</td><td>代码类型。用于在文档中存储 JavaScript 代码。</td></tr><tr><td>Regular expression</td><td>正则表达式类型。用于存储正则表达式。</td></tr></tbody></table>]]></content>
    
    
    
    <tags>
      
      <tag>中间件</tag>
      
      <tag>MongoDB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redis学习6—Redis分布式锁</title>
    <link href="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"/>
    <url>/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/</url>
    
    <content type="html"><![CDATA[<h3 id="1-引言"><a href="#1-引言" class="headerlink" title="1. 引言"></a>1. 引言</h3><h4 id="1-1-分布式锁"><a href="#1-1-分布式锁" class="headerlink" title="1.1. 分布式锁"></a>1.1. 分布式锁</h4><p>分布式锁（Distributed Lock）是一种用于分布式系统中实现互斥访问的机制，在分布式系统中，多个节点同时访问共享资源可能导致数据不一致或竞态条件的问题，分布式锁通过协调多个节点之间的访问，确保在同一时间只有一个节点能获得对共享资源的独占访问权限，从而解决并发访问问题。</p><h4 id="1-2-分布式锁实现方式"><a href="#1-2-分布式锁实现方式" class="headerlink" title="1.2. 分布式锁实现方式"></a>1.2. 分布式锁实现方式</h4><p>常用的分布式锁实现方式有：<br>1）基于数据库的分布式锁（乐观锁)：使用数据库的事务特性和唯一约束来实现分布式锁。通过在数据库中创建一个特定的表或记录来表示锁的状态，节点可以通过获取或释放该记录来获取或释放锁。<br>2）基于缓存的分布式锁：使用分布式缓存系统（如Redis）的原子操作来实现分布式锁，节点可以通过在缓存中设置一个特定的键值对来获取锁，并利用缓存的原子性操作来保证锁的互斥性。<br>3）基于zookeeper的分布式锁：zookeeper是一个分布式协调服务，可以用于实现分布式锁，节点可以通过在zookeeper中创建一个临时有序节点来表示锁的占用状态，通过比较节点 的序号来确定锁的拥有权。</p><h3 id="2-基于数据库的分布式锁（乐观锁）"><a href="#2-基于数据库的分布式锁（乐观锁）" class="headerlink" title="2. 基于数据库的分布式锁（乐观锁）"></a>2. 基于数据库的分布式锁（乐观锁）</h3><p>基于数据库的分布式锁实现方案，一般是在表中加一个字段，用于表示版本号，当读取数据时，会读取对应的版本号，在更新数据的时候，也会相应的更新版本号（比如版本号递增），且在更新数据的时候，会判断当前版本号是否正确，以账户余额修改为例，具体流程如下：<br>1）查询账户信息（此时从数据库中查出的版本号为version1)<br>2）根据请求对账户对象进行操作<br>3）更新数据库(update t_account set 字段&#x3D;新值, version &#x3D; version + 1 where id &#x3D; #{accountId} and version &#x3D; version1的值)<br>在这个过程中，最重要的就是更新sql的语句，也就是在更新的时候，判断版本号是否被修改过，只有没有被修改过，我们才能更新成功。<br>示例如下：<br>首先，我们创建一个账户表：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/1.png" class=""><p>然后在账户表上插入一条数据，假设账户中有1000元</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/2.png" class=""><p>对应的实体类和mapper：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@TableName(value = &quot;t_account&quot;)</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span><br>    <span class="hljs-keyword">private</span> Integer id;<br><br>    <span class="hljs-keyword">private</span> Integer userId;<br><br>    <span class="hljs-keyword">private</span> Integer balance;<br><br>    <span class="hljs-keyword">private</span> Date createTime;<br><br>    <span class="hljs-keyword">private</span> Date updateTime;<br><br>    <span class="hljs-keyword">private</span> Integer version;<br>&#125;<br><br><br><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AccountMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;Account&gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后我们创建一个AccountService，先演示没有乐观锁时，会造成的问题</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.service;<br><br><span class="hljs-keyword">import</span> org.example.mapper.AccountMapper;<br><span class="hljs-keyword">import</span> org.example.pojo.Account;<br><span class="hljs-keyword">import</span> org.example.request.account.TakeOutMoneyRequest;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AccountMapper accountMapper;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">takeOutMoneyWithoutOpLock</span><span class="hljs-params">(TakeOutMoneyRequest request)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">accountId</span> <span class="hljs-operator">=</span> request.getAccountId();<br>        <span class="hljs-type">Account</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> accountMapper.selectById(accountId);<br>        <span class="hljs-keyword">if</span> (account.getBalance() - request.getMoney() &lt; <span class="hljs-number">0</span>) &#123;<br>            System.out.println(<span class="hljs-string">&quot;余额不足==============&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        Thread.sleep(<span class="hljs-number">1000</span>);<br><br>        account.setBalance(account.getBalance() - request.getMoney());<br>        account.setUpdateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        <span class="hljs-keyword">return</span> accountMapper.updateById(account) &gt; <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>添加一个测试类，用于演示并发情况下，账户余额的减少</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.service;<br><br><span class="hljs-keyword">import</span> org.example.mapper.AccountMapper;<br><span class="hljs-keyword">import</span> org.example.pojo.Account;<br><span class="hljs-keyword">import</span> org.example.request.account.TakeOutMoneyRequest;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AccountMapper accountMapper;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">takeOutMoneyWithoutOpLock</span><span class="hljs-params">(TakeOutMoneyRequest request)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">accountId</span> <span class="hljs-operator">=</span> request.getAccountId();<br>        <span class="hljs-type">Account</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> accountMapper.selectById(accountId);<br>        <span class="hljs-keyword">if</span> (account.getBalance() - request.getMoney() &lt; <span class="hljs-number">0</span>) &#123;<br>            System.out.println(<span class="hljs-string">&quot;余额不足==============&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        Thread.sleep(<span class="hljs-number">1000</span>);<br><br>        account.setBalance(account.getBalance() - request.getMoney());<br>        account.setUpdateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        <span class="hljs-keyword">return</span> accountMapper.updateById(account) &gt; <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>运行测试方法，结果如下图所示，说明都更新成功了</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/3.png" class=""><p>然后查看数据库：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/4.png" class=""><p>如上图所示，原先我们的账户余额是1000元，每次扣除100元，经过10次扣减后，账户余额应该为0，但是因为并发问题，导致查询的时候，有多个请求查询到同一个值，最后导致数据不一致。<br>我们修改Account，添加使用乐观锁进行扣减余额的方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">takeOutMoneyWithOpLock</span><span class="hljs-params">(TakeOutMoneyRequest request)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>     <span class="hljs-type">Integer</span> <span class="hljs-variable">accountId</span> <span class="hljs-operator">=</span> request.getAccountId();<br>     <span class="hljs-type">Account</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> accountMapper.selectById(accountId);<br>     <span class="hljs-keyword">if</span> (account.getBalance() - request.getMoney() &lt; <span class="hljs-number">0</span>) &#123;<br>         System.out.println(<span class="hljs-string">&quot;余额不足==============&quot;</span>);<br>         <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>     &#125;<br>     Thread.sleep(<span class="hljs-number">1000</span>);<br><br>     LambdaUpdateWrapper&lt;Account&gt; lambdaUpdateWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaUpdateWrapper</span>&lt;&gt;();<br>     lambdaUpdateWrapper.set(Account::getVersion, account.getVersion() + <span class="hljs-number">1</span>)<br>             .set(Account::getUpdateTime, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>())<br>                     .set(Account::getBalance, account.getBalance() - request.getMoney())<br>                             .eq(Account::getVersion, account.getVersion())<br>                                     .eq(Account::getId, request.getAccountId());<br>     <span class="hljs-keyword">return</span> accountMapper.update(account, lambdaUpdateWrapper) &gt; <span class="hljs-number">0</span>;<br> &#125;<br></code></pre></td></tr></table></figure><p>我们把金额修改回1000，然后添加测试方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testTakeoutMoneyWithOpLock</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>       <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>);<br>       Callable&lt;Boolean&gt; takeoutTask = () -&gt; &#123;<br>           <span class="hljs-type">TakeOutMoneyRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TakeOutMoneyRequest</span>();<br>           request.setAccountId(<span class="hljs-number">1</span>);<br>           request.setMoney(<span class="hljs-number">100</span>);<br>           <span class="hljs-keyword">try</span> &#123;<br>               <span class="hljs-keyword">return</span> accountService.takeOutMoneyWithOpLock(request);<br>           &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>               <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>           &#125;<br>       &#125;;<br>       List&lt;Future&lt;Boolean&gt;&gt; futureList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>       <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>           Future&lt;Boolean&gt; future = executorService.submit(takeoutTask);<br>           futureList.add(future);<br>       &#125;<br><br>       <span class="hljs-keyword">for</span> (Future&lt;Boolean&gt; future : futureList) &#123;<br>           System.out.println(future.get());<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><p>运行测试方法，结果如下，说明只有两次更新成功了，其余的更新，都以为乐观锁被修改了，导致更新失败</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/5.png" class=""><p>然后我们查看数据库，结果如下，因为扣减了两次，所有余额为800，这个数据对的上。</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/6.png" class=""><p>乐观锁的实现思路，是基于对并发更新的乐观假设，也就是认为冲突的概率较低，因此在读取和提交数据时进行版本号或时间戳的比较，而不是在数据访问阶段进行加锁操作，避免了显示的锁竞争，提高了并发性能。但乐观锁并不能完全消除并发冲突，只是在提交数据时进行冲突检测和处理，如果系统中的并发冲突非常频繁，乐观锁的效率可能会下降。</p><h3 id="3-基于Redis的分布式锁"><a href="#3-基于Redis的分布式锁" class="headerlink" title="3. 基于Redis的分布式锁"></a>3. 基于Redis的分布式锁</h3><h4 id="3-1-基于Redis的SETNX实现分布式锁"><a href="#3-1-基于Redis的SETNX实现分布式锁" class="headerlink" title="3.1. 基于Redis的SETNX实现分布式锁"></a>3.1. 基于Redis的SETNX实现分布式锁</h4><p>SETNX指的是set if not exist，也就是当key不存在的时候，设置key的值，存在的话，什么都不做, 其语法为:</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-keyword">set</span> key <span class="hljs-comment">value nx</span><br></code></pre></td></tr></table></figure><p>如果我们要设置过期时间的话，可以使用</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-keyword">set</span> key <span class="hljs-comment">value ex</span> 时间 <span class="hljs-comment">nx</span><br></code></pre></td></tr></table></figure><p>如下图所示，在使用nx指令的时候，只有在该key不存在的时候，才能设置成功</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/7.png" class=""><p>我们修改之前的RedisUtils工具类，添加上和这两条指令相关的方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setIfAbsent</span><span class="hljs-params">(String key, Object value)</span> &#123;<br>       <span class="hljs-keyword">return</span> redisTemplate.opsForValue().setIfAbsent(key, value);<br>   &#125;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 不存在时设置值，适用与分布式锁的场景</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> key</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> value</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> time</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setIfAbsent</span><span class="hljs-params">(String key, Object value, <span class="hljs-type">long</span> time)</span> &#123;<br>       <span class="hljs-keyword">return</span> setIfAbsent(key, value, time, TimeUnit.SECONDS);<br>   &#125;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setIfAbsent</span><span class="hljs-params">(String key, Object value, <span class="hljs-type">long</span> time, TimeUnit timeUnit)</span> &#123;<br>       <span class="hljs-keyword">return</span> redisTemplate.opsForValue().setIfAbsent(key, value, time, timeUnit);<br>   &#125;<br></code></pre></td></tr></table></figure><h5 id="3-1-1-通过setnx实现分布式锁"><a href="#3-1-1-通过setnx实现分布式锁" class="headerlink" title="3.1.1. 通过setnx实现分布式锁"></a>3.1.1. 通过setnx实现分布式锁</h5><p>具体流程如下：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/24.png" class=""><p>我们修改AccountService，添加和该指令相关的方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>  <span class="hljs-keyword">private</span> RedisUtils redisUtils;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">takeOutMoneyWithSetnx</span><span class="hljs-params">(TakeOutMoneyRequest request)</span> &#123;<br>      <span class="hljs-type">Integer</span> <span class="hljs-variable">accountId</span> <span class="hljs-operator">=</span> request.getAccountId();<br>      <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lock::&quot;</span> + accountId;<br><br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redisUtils.setIfAbsent(key, request.getAccountId());<br>      <span class="hljs-keyword">if</span> (!lock) &#123;<br>          <span class="hljs-comment">// 加锁失败，返回</span><br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      &#125;<br>      <span class="hljs-comment">// 加锁成功</span><br>      <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-type">Account</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> accountMapper.selectById(accountId);<br>          account.setBalance(account.getBalance() - request.getMoney());<br>          account.setUpdateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>          <span class="hljs-keyword">return</span> accountMapper.updateById(account) &gt; <span class="hljs-number">0</span>;<br>      &#125; <span class="hljs-keyword">finally</span> &#123;<br>          <span class="hljs-comment">// 释放锁</span><br>          redisUtils.removeKey(key);<br>      &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><p>添加测试方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testTakeoutMoneyWithSetnx</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>);<br>        Callable&lt;Boolean&gt; takeoutTask = () -&gt; &#123;<br>            <span class="hljs-type">TakeOutMoneyRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TakeOutMoneyRequest</span>();<br>            request.setAccountId(<span class="hljs-number">1</span>);<br>            request.setMoney(<span class="hljs-number">100</span>);<br>            <span class="hljs-keyword">return</span> accountService.takeOutMoneyWithSetnx(request);<br>        &#125;;<br>        List&lt;Future&lt;Boolean&gt;&gt; futureList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            Future&lt;Boolean&gt; future = executorService.submit(takeoutTask);<br>            futureList.add(future);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (Future&lt;Boolean&gt; future : futureList) &#123;<br>            System.out.println(future.get());<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>测试结果如下：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/8.png" class=""><p>我们查看数据库，确实只扣减了100</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/9.png" class=""><p>这里冲突次数比较多，因此更新的效率有点低，我们可以将对应的方法修改一下，加上重试，修改代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>  <span class="hljs-keyword">private</span> RedisUtils redisUtils;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">takeOutMoneyWithSetnx</span><span class="hljs-params">(TakeOutMoneyRequest request)</span> &#123;<br>      <span class="hljs-type">Integer</span> <span class="hljs-variable">accountId</span> <span class="hljs-operator">=</span> request.getAccountId();<br>      <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lock::&quot;</span> + accountId;<br><br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redisUtils.setIfAbsent(key, request.getAccountId());<br>      <span class="hljs-keyword">if</span> (lock) &#123;<br>          <span class="hljs-comment">// 加锁成功</span><br>          <span class="hljs-keyword">try</span> &#123;<br>              <span class="hljs-type">Account</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> accountMapper.selectById(accountId);<br>              account.setBalance(account.getBalance() - request.getMoney());<br>              account.setUpdateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>              <span class="hljs-keyword">return</span> accountMapper.updateById(account) &gt; <span class="hljs-number">0</span>;<br>          &#125; <span class="hljs-keyword">finally</span> &#123;<br>              <span class="hljs-comment">// 释放锁</span><br>              redisUtils.removeKey(key);<br>          &#125;<br>      &#125;<br>      <span class="hljs-comment">// 加锁失败，进行重试</span><br>      <span class="hljs-keyword">try</span> &#123;<br>          Thread.sleep(<span class="hljs-number">100</span>);<br>      &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>          e.printStackTrace();<br>      &#125;<br>      <span class="hljs-keyword">return</span> takeOutMoneyWithSetnx(request);<br>  &#125;<br></code></pre></td></tr></table></figure><p>这里休眠了一段时间，是因为要涉及到递归调用，可能会导致栈空间溢出，我们再次执行测试代码，结果如下，经过重试后，执行成功率变高。</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/10.png" class=""><p>查看数据库，确实扣减了10次。</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/11.png" class=""><p>但是，使用set key value nx存在一个问题，如果setnx占锁成功，但是服务器宕机了，没有执行删除锁的逻辑，那么就会造成这个锁一直没有被释放，最终导致死锁。</p><h5 id="3-1-2-setnx-with-expire"><a href="#3-1-2-setnx-with-expire" class="headerlink" title="3.1.2. setnx with expire"></a>3.1.2. setnx with expire</h5><p>为解决setnx造成的死锁问题，我们在setnx的基础上，加上过期时间，来解决上述问题。我们给AccountService添加上对应的方法如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">takeOutMoneyWithSetnxExpire</span><span class="hljs-params">(TakeOutMoneyRequest request)</span> &#123;<br>       <span class="hljs-type">Integer</span> <span class="hljs-variable">accountId</span> <span class="hljs-operator">=</span> request.getAccountId();<br>       <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lock::&quot;</span> + accountId;<br>       <br>       <span class="hljs-comment">// 占有锁并设置过期时间</span><br>       <span class="hljs-type">boolean</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redisUtils.setIfAbsent(key, request.getAccountId(), TTL);<br>       <span class="hljs-keyword">if</span> (lock) &#123;<br>           <span class="hljs-comment">// 加锁成功</span><br>           <span class="hljs-keyword">try</span> &#123;<br>               <span class="hljs-type">Account</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> accountMapper.selectById(accountId);<br>               account.setBalance(account.getBalance() - request.getMoney());<br>               account.setUpdateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>               <span class="hljs-keyword">return</span> accountMapper.updateById(account) &gt; <span class="hljs-number">0</span>;<br>           &#125; <span class="hljs-keyword">finally</span> &#123;<br>               <span class="hljs-comment">// 释放锁</span><br>               redisUtils.removeKey(key);<br>           &#125;<br>       &#125;<br>       <span class="hljs-comment">// 加锁失败，进行重试</span><br>       <span class="hljs-keyword">try</span> &#123;<br>           Thread.sleep(<span class="hljs-number">100</span>);<br>       &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>           e.printStackTrace();<br>       &#125;<br>       <span class="hljs-keyword">return</span> takeOutMoneyWithSetnx(request);<br>   &#125;<br></code></pre></td></tr></table></figure><p>添加上对应的测试方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testTakeoutMoneyWithSetnxExpire</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>);<br>        Callable&lt;Boolean&gt; takeoutTask = () -&gt; &#123;<br>            <span class="hljs-type">TakeOutMoneyRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TakeOutMoneyRequest</span>();<br>            request.setAccountId(<span class="hljs-number">1</span>);<br>            request.setMoney(<span class="hljs-number">100</span>);<br>            <span class="hljs-keyword">return</span> accountService.takeOutMoneyWithSetnxExpire(request);<br>        &#125;;<br>        List&lt;Future&lt;Boolean&gt;&gt; futureList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            Future&lt;Boolean&gt; future = executorService.submit(takeoutTask);<br>            futureList.add(future);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (Future&lt;Boolean&gt; future : futureList) &#123;<br>            System.out.println(future.get());<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>测试结果如下：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/12.png" class=""><p>我们 查看数据库，数据库也确实扣减了10次</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/13.png" class=""><p>但是，这个方案还是有一定缺陷，因为我们设置的这个过期时间，是根据我们的经验设置的，而业务代码的执行时长，是不确定的，那么可能存在这种情况，假设我们现在有三个请求过来，我们设置的过期时间是100ms<br>1）请求A占锁成功，执行业务代码<br>2）请求A执行100ms后，锁过期，但此时请求A的业务代码还未执行完毕<br>3）请求B占锁成功，执行业务代码<br>4）请求A执行完毕，执行释放锁的逻辑，导致把B占有的锁打开了<br>5）请求C占锁成功，执行业务代码<br>6）请求B执行完毕，执行释放锁的逻辑，导致把C占有的锁打开了<br>这里是因为，这三个请求占有的锁的key都是相同的，而我们在释放锁的时候，只是执行删除key的命令，并不在意这个锁是谁占有的。<br>这种情况，我们可以通过lua脚本来解决，思路如下：<br>1）占锁的时候，设置value值为用户标识<br>2）释放锁的时候，通过lua脚本，判断此时key对应的value值，与传入值是否相同，只有相同的时候，我们才执行删除key的逻辑。<br>我们修改刚才的方法，如下，在占锁的时候，我们设置value值为当前的线程id（这里是为了演示，实际业务场景中，应该是多个用户抢占同一个资源，因此可以将vlaue值设置为用户的标识，比如用户id），然后在释放资源的时候，执行lua脚本，判断value值是否相同，相同则执行删除操作。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>  <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;<br>  <br> <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">takeOutMoneyWithSetnxExpire</span><span class="hljs-params">(TakeOutMoneyRequest request)</span> &#123;<br>      <span class="hljs-type">Integer</span> <span class="hljs-variable">accountId</span> <span class="hljs-operator">=</span> request.getAccountId();<br>      <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lock::&quot;</span> + accountId;<br><br>      <span class="hljs-type">long</span> <span class="hljs-variable">threadId</span> <span class="hljs-operator">=</span> Thread.currentThread().getId();<br>      <span class="hljs-comment">// 占有锁并设置过期时间</span><br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redisUtils.setIfAbsent(key, threadId, TTL);<br>      <span class="hljs-keyword">if</span> (lock) &#123;<br>          <span class="hljs-comment">// 加锁成功</span><br>          <span class="hljs-keyword">try</span> &#123;<br>              <span class="hljs-type">Account</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> accountMapper.selectById(accountId);<br>              account.setBalance(account.getBalance() - request.getMoney());<br>              account.setUpdateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>              <span class="hljs-keyword">return</span> accountMapper.updateById(account) &gt; <span class="hljs-number">0</span>;<br>          &#125; <span class="hljs-keyword">finally</span> &#123;<br>              <span class="hljs-comment">// 释放锁</span><br>              <span class="hljs-comment">// lua脚本</span><br>              <span class="hljs-type">String</span> <span class="hljs-variable">script</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;if redis.call(&#x27;get&#x27;, KEYS[1]) == ARGV[1] then return redis.call(&#x27;del&#x27;, KEYS[1]) else return 0 end&quot;</span>;<br>              redisTemplate.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;Long&gt;(script, Long.class), Arrays.asList(key), threadId);<br>          &#125;<br>      &#125;<br>      <span class="hljs-comment">// 加锁失败，进行重试</span><br>      <span class="hljs-keyword">try</span> &#123;<br>          Thread.sleep(<span class="hljs-number">100</span>);<br>      &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>          e.printStackTrace();<br>      &#125;<br>      <span class="hljs-keyword">return</span> takeOutMoneyWithSetnx(request);<br>  &#125;<br></code></pre></td></tr></table></figure><p>再次执行测试代码：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/14.png" class=""><p>查看数据库，确实减少10次</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/15.png" class=""><p>但这里还有一个问题没有解决，因为我们设置的TTL，是我们的经验值，不准确，所以还是会存在，某个请求占有锁后，还没执行完毕，锁过期了，被另外一个请求占有，此时会出现两个请求都认为自己占有锁的情况。</p><h4 id="3-2-Redisson"><a href="#3-2-Redisson" class="headerlink" title="3.2. Redisson"></a>3.2. Redisson</h4><h5 id="3-2-1-简介"><a href="#3-2-1-简介" class="headerlink" title="3.2.1. 简介"></a>3.2.1. 简介</h5><p>Redisson是一个在Redis基础上实现的Java驻内存数据网络，它不仅提供一系列的分布式java常用对象，还提供许多分布式服务，其宗旨是促进使用者对Redis的关注分离（Separation of Concern），从而让使用者能将精力更多集中在处理业务逻辑上。</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/16.png" class=""><h5 id="3-2-2-SpringBoot-整合Redisson"><a href="#3-2-2-SpringBoot-整合Redisson" class="headerlink" title="3.2.2. SpringBoot 整合Redisson"></a>3.2.2. SpringBoot 整合Redisson</h5><p>引入redisson的maven依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.15.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>然后自定义配置类（这里使用的是单节点Redis配置）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.config;<br><br><span class="hljs-keyword">import</span> org.redisson.Redisson;<br><span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;<br><span class="hljs-keyword">import</span> org.redisson.config.Config;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedissonConfiguration</span> &#123;<br>    <br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedissonClient <span class="hljs-title function_">redisson</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 1. 创建配置</span><br>        <span class="hljs-type">Config</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Config</span>();<br>        <span class="hljs-comment">// 集群模式</span><br><span class="hljs-comment">//        config.useClusterServers().addNodeAddress(&quot;集群ip1&quot;, &quot;集群id2&quot;);</span><br>        <span class="hljs-comment">// 2. 根据Config创建出RedissonClient示例</span><br>        config.useSingleServer().setAddress(<span class="hljs-string">&quot;redis://127.0.0.1:6379&quot;</span>);<br>        <span class="hljs-keyword">return</span> Redisson.create(config);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>我们添加测试方法，来测试redisson的一些基本操作：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.redisson.api.*;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedissonTest</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedissonClient redissonClient;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testRedisson</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 字符串操作</span><br>        RBucket&lt;Object&gt; rBuck = redissonClient.getBucket(<span class="hljs-string">&quot;name&quot;</span>);<br>        rBuck.set(<span class="hljs-string">&quot;cxy&quot;</span>, <span class="hljs-number">30</span>, TimeUnit.SECONDS);<br>        System.out.println(redissonClient.getBucket(<span class="hljs-string">&quot;name&quot;</span>).get());<br><br>        <span class="hljs-comment">// 哈希操作</span><br>        RMap&lt;Object, Object&gt; student = redissonClient.getMap(<span class="hljs-string">&quot;student&quot;</span>);<br>        student.put(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-number">1</span>);<br>        student.put(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;cxy&quot;</span>);<br>        student.put(<span class="hljs-string">&quot;age&quot;</span>, <span class="hljs-number">20</span>);<br>        student.expire(<span class="hljs-number">30</span>, TimeUnit.SECONDS);<br><br>        System.out.println(redissonClient.getMap(<span class="hljs-string">&quot;student&quot;</span>).get(<span class="hljs-string">&quot;name&quot;</span>));<br><br>        <span class="hljs-comment">// 列表操作</span><br>        RList&lt;Object&gt; schools = redissonClient.getList(<span class="hljs-string">&quot;schools&quot;</span>);<br>        schools.add(<span class="hljs-string">&quot;华南理工大学&quot;</span>);<br>        schools.add(<span class="hljs-string">&quot;中山大学&quot;</span>);<br>        schools.add(<span class="hljs-string">&quot;暨南大学&quot;</span>);<br>        System.out.println(JSONObject.toJSONString(redissonClient.getList(<span class="hljs-string">&quot;schools&quot;</span>)));<br><br>        <span class="hljs-comment">// 集合操作</span><br>        RSet&lt;Object&gt; schoolSet = redissonClient.getSet(<span class="hljs-string">&quot;schoolSet&quot;</span>);<br>        schoolSet.add(<span class="hljs-string">&quot;华南理工大学&quot;</span>);<br>        schoolSet.add(<span class="hljs-string">&quot;中山大学&quot;</span>);<br>        schoolSet.add(<span class="hljs-string">&quot;暨南大学&quot;</span>);<br>        System.out.println(JSONObject.toJSONString(redissonClient.getSet(<span class="hljs-string">&quot;schoolSet&quot;</span>)));<br><br>        <span class="hljs-comment">// ZSet操作</span><br>        RScoredSortedSet&lt;Object&gt; schoolScoreSet = redissonClient.getScoredSortedSet(<span class="hljs-string">&quot;schoolScoreSet&quot;</span>);<br>        schoolScoreSet.add(<span class="hljs-number">100d</span>, <span class="hljs-string">&quot;华南理工大学&quot;</span>);<br>        schoolScoreSet.add(<span class="hljs-number">90d</span>, <span class="hljs-string">&quot;中山大学&quot;</span>);<br>        schoolScoreSet.add(<span class="hljs-number">80d</span>, <span class="hljs-string">&quot;暨南大学&quot;</span>);<br>        System.out.println(JSONObject.toJSONString(redissonClient.getScoredSortedSet(<span class="hljs-string">&quot;schoolScoreSet&quot;</span>)));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>结果如下：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/17.png" class=""><h5 id="3-2-3-Redisson分布式锁"><a href="#3-2-3-Redisson分布式锁" class="headerlink" title="3.2.3. Redisson分布式锁"></a>3.2.3. Redisson分布式锁</h5><p>redisson加锁，可以使用lock方法，注意，在加锁的时候，处理完业务逻辑后要记得释放锁，测试代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testLock</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>      <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">2</span>);<br>      <span class="hljs-type">Runnable</span> <span class="hljs-variable">lockTask</span> <span class="hljs-operator">=</span> () -&gt; &#123;<br>          <span class="hljs-keyword">try</span> &#123;<br>              lock();<br>          &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>              e.printStackTrace();<br>          &#125;<br>      &#125;;<br>      List&lt; Future&gt; futureList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++) &#123;<br>          futureList.add(executorService.submit(lockTask));<br>      &#125;<br>      <span class="hljs-keyword">for</span> (Future future : futureList) &#123;<br>          future.get();<br>      &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>      <span class="hljs-type">RLock</span> <span class="hljs-variable">myLock</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">&quot;myLock&quot;</span>);<br>      myLock.lock();<br>      <span class="hljs-keyword">try</span> &#123;<br>          System.out.println(<span class="hljs-string">&quot;currentTime:&quot;</span> + System.currentTimeMillis());<br>          Thread.sleep(<span class="hljs-number">2000</span>);<br>          System.out.println(<span class="hljs-string">&quot;执行业务代码&quot;</span>);<br>      &#125; <span class="hljs-keyword">finally</span> &#123;<br>          myLock.unlock();<br>      &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><p>测试结果如下，从执行结果可以看出，当多个线程抢占锁时，后面的锁，需要等待，即这个锁是阻塞的。</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/18.png" class=""><p>如果不想阻塞的话，我们可以使用tryLock来上锁，结合刚才的accountService，我们先修改accountService，加上对应的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>   <span class="hljs-keyword">private</span> RedissonClient redissonClient;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">takeoutMoneyWithRedissonTryLock</span><span class="hljs-params">(TakeOutMoneyRequest request)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>       <span class="hljs-type">Integer</span> <span class="hljs-variable">accountId</span> <span class="hljs-operator">=</span> request.getAccountId();<br>       <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lock::&quot;</span> + accountId;<br><br>       <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(key);<br>       <span class="hljs-keyword">if</span> (lock.tryLock(<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, TimeUnit.SECONDS)) &#123; <span class="hljs-comment">// 过期时间为2秒，最长存活时间为4秒</span><br>           <span class="hljs-comment">// 上锁成功</span><br>           <span class="hljs-keyword">try</span> &#123;<br>               Thread.sleep(<span class="hljs-number">1000</span>);<br>               <span class="hljs-type">Account</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> accountMapper.selectById(accountId);<br>               account.setBalance(account.getBalance() - request.getMoney());<br>               account.setUpdateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>               <span class="hljs-keyword">return</span> accountMapper.updateById(account) &gt; <span class="hljs-number">0</span>;<br>           &#125; <span class="hljs-keyword">finally</span> &#123;<br>               <span class="hljs-comment">// 释放锁</span><br>               lock.unlock();<br>           &#125;<br>       &#125;<br>       <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>   &#125;<br></code></pre></td></tr></table></figure><p>添加测试方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testTakeoutMoneyWithRedissonTryLock</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>     <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>);<br>     Callable&lt;Boolean&gt; takeoutTask = () -&gt; &#123;<br>         <span class="hljs-type">TakeOutMoneyRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TakeOutMoneyRequest</span>();<br>         request.setAccountId(<span class="hljs-number">1</span>);<br>         request.setMoney(<span class="hljs-number">100</span>);<br>         <span class="hljs-keyword">return</span> accountService.takeoutMoneyWithRedissonTryLock(request);<br>     &#125;;<br>     List&lt;Future&lt;Boolean&gt;&gt; futureList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>     <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>         Future&lt;Boolean&gt; future = executorService.submit(takeoutTask);<br>         futureList.add(future);<br>     &#125;<br><br>     <span class="hljs-keyword">for</span> (Future&lt;Boolean&gt; future : futureList) &#123;<br>         System.out.println(future.get());<br>     &#125;<br> &#125;<br></code></pre></td></tr></table></figure><p>测试结果如下:</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/19.png" class=""><p>查看数据库，减少的次数与上面的次数一致</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/20.png" class=""><p>不过上面这种，成功率比较低，因此我们可以将tryLock改为lock方法，来上锁，我们修改accountService，添加相关方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">takeoutMoneyWithRedissonLock</span><span class="hljs-params">(TakeOutMoneyRequest request)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>      <span class="hljs-type">Integer</span> <span class="hljs-variable">accountId</span> <span class="hljs-operator">=</span> request.getAccountId();<br>      <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lock::&quot;</span> + accountId;<br><br>      <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(key);<br>      lock.lock(<span class="hljs-number">2</span>, TimeUnit.SECONDS);<br>      <span class="hljs-comment">// 上锁成功</span><br>      <span class="hljs-keyword">try</span> &#123;<br>          Thread.sleep(<span class="hljs-number">1000</span>);<br>          <span class="hljs-type">Account</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> accountMapper.selectById(accountId);<br>          account.setBalance(account.getBalance() - request.getMoney());<br>          account.setUpdateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>          <span class="hljs-keyword">return</span> accountMapper.updateById(account) &gt; <span class="hljs-number">0</span>;<br>      &#125; <span class="hljs-keyword">finally</span> &#123;<br>          <span class="hljs-comment">// 释放锁</span><br>          lock.unlock();<br>      &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><p>添加测试方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testTakeoutMoneyWithRedissonLock</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>       <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>);<br>       Callable&lt;Boolean&gt; takeoutTask = () -&gt; &#123;<br>           <span class="hljs-type">TakeOutMoneyRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TakeOutMoneyRequest</span>();<br>           request.setAccountId(<span class="hljs-number">1</span>);<br>           request.setMoney(<span class="hljs-number">100</span>);<br>           <span class="hljs-keyword">return</span> accountService.takeoutMoneyWithRedissonLock(request);<br>       &#125;;<br>       List&lt;Future&lt;Boolean&gt;&gt; futureList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>       <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>           Future&lt;Boolean&gt; future = executorService.submit(takeoutTask);<br>           futureList.add(future);<br>       &#125;<br><br>       <span class="hljs-keyword">for</span> (Future&lt;Boolean&gt; future : futureList) &#123;<br>           System.out.println(future.get());<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><p>测试结果如下：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/21.png" class=""><p>查看数据库，扣减次数确实为10次。</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/22.png" class=""><h5 id="3-2-4-watch-dog-看门狗机制"><a href="#3-2-4-watch-dog-看门狗机制" class="headerlink" title="3.2.4. watch dog 看门狗机制"></a>3.2.4. watch dog 看门狗机制</h5><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A06%E2%80%94Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/23.png" class=""><p>Redisson中的分布式锁自带自动续期机制，其提供了一个专门用来监控和续期锁的Watch Dog（看门狗），如果操作共享资源的线程还没有执行完成的话，Watch Dog会不断延长锁的过期时间，从而保证锁不会因为超时而被释放。</p><h3 id="4-参考文章"><a href="#4-参考文章" class="headerlink" title="4. 参考文章"></a>4. 参考文章</h3><p><a href="https://zhuanlan.zhihu.com/p/374306005">https://zhuanlan.zhihu.com/p/374306005</a><br><a href="https://my.oschina.net/u/4499317/blog/5039486">https://my.oschina.net/u/4499317/blog/5039486</a><br><a href="https://blog.csdn.net/qq_15071263/article/details/101277474">https://blog.csdn.net/qq_15071263/article/details/101277474</a><br><a href="https://www.cnblogs.com/jelly12345/p/14699492.html">https://www.cnblogs.com/jelly12345/p/14699492.html</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>中间件</tag>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redis学习5-Redis应用之签到</title>
    <link href="/2024/04/02/Redis%E5%AD%A6%E4%B9%A05-Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%AD%BE%E5%88%B0/"/>
    <url>/2024/04/02/Redis%E5%AD%A6%E4%B9%A05-Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%AD%BE%E5%88%B0/</url>
    
    <content type="html"><![CDATA[<h3 id="1-Redis位图bitMap"><a href="#1-Redis位图bitMap" class="headerlink" title="1. Redis位图bitMap"></a>1. Redis位图bitMap</h3><p>位图由一系列二进制位组成，每个位可以被设置为1或0，当我们在处理需要高效存储和操作大量二进制位数据的适合，位图是一个非常有用的工具。<br>位图操作命令有：</p><ol><li>SETBIT：设置位图中指定位置的位的值。可以将位设置为 0 或 1。</li><li>GETBIT：获取位图中指定位置的位的值。</li><li>BITCOUNT：计算位图中置为 1 的位的数量。</li><li>BITOP：对多个位图执行逻辑运算（AND、OR、XOR、NOT）。</li><li>BITFIELD：执行复杂的位字段操作，允许你在位图上进行位级别的读写操作。<br>其中，用的最多的是前三个操作，示例如下：<img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A05-Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%AD%BE%E5%88%B0/1.png" class="">位图的应用十分广泛，包括但不限于以下几方面：<br>● 统计用户活跃度：可以使用位图追踪用户的登录活动，每个用户对应一个位图，每天的登录状态可以用一个二进制位表示，通过 BITOP 命令可以计算多个用户的交集，从而得到活跃用户的统计信息。<br>● 数据压缩：位图可以高效地存储大量的二进制数据，比如布隆过滤器（Bloom Filter）就是基于位图实现的一种数据结构，用于快速判断元素是否存在。<br>● 事件计数：可以使用位图记录每天不同时间段的事件发生情况，比如网站的访问量，每个时间段对应一个位图，每次事件发生时将对应的位设置为 1，通过 BITCOUNT 命令可以计算出每个时间段的事件数量。<br>● 权限管理：可以使用位图来管理用户的权限，每个用户对应一个位图，每个权限对应一个二进制位，通过 BITOP 命令可以进行权限的并集、交集等操作。</li></ol><h3 id="2-RedisTemplate操作位图"><a href="#2-RedisTemplate操作位图" class="headerlink" title="2. RedisTemplate操作位图"></a>2. RedisTemplate操作位图</h3><p>在之前的几篇文章中，我们总结了一个Redis工具类，但是那个工具类中，并没有和位图相关的操作，这里添加和位图操作相关的方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// value: true为1， false为0</span><br> <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setBit</span><span class="hljs-params">(String key, <span class="hljs-type">int</span> offset, <span class="hljs-type">boolean</span> value)</span> &#123;<br>     <span class="hljs-keyword">return</span> redisTemplate.opsForValue().setBit(key, offset, value);<br> &#125;<br><br> <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getBit</span><span class="hljs-params">(String key, <span class="hljs-type">int</span> offset)</span> &#123;<br>     <span class="hljs-keyword">return</span> redisTemplate.opsForValue().getBit(key, offset);<br> &#125;<br><br> <span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 统计对应值为1 的数量</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> key</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">  */</span><br> <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">bitCount</span><span class="hljs-params">(String key)</span> &#123;<br>     <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-number">0L</span>;<br>     &#125;<br>     <span class="hljs-keyword">return</span> redisTemplate.execute((RedisCallback&lt;Long&gt;) con -&gt; con.bitCount(key.getBytes()));<br> &#125;<br><br> <span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 统计在字节范围内，对应值为1的数量</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> key</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> start</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">  */</span><br> <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">bitCount</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> start, <span class="hljs-type">long</span> end)</span> &#123;<br>     <span class="hljs-keyword">return</span> redisTemplate.execute((RedisCallback&lt;Long&gt;) con -&gt; con.bitCount(key.getBytes(), start, end));<br> &#125;<br></code></pre></td></tr></table></figure><p>添加测试类，用于测试位图操作：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> org.example.util.RedisUtils;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisBitMapTest</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisUtils redisUtils;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testBitMap</span><span class="hljs-params">()</span> &#123;<br>        redisUtils.setBit(<span class="hljs-string">&quot;bit&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>);<br>        redisUtils.setBit(<span class="hljs-string">&quot;bit&quot;</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">true</span>);<br>        redisUtils.setBit(<span class="hljs-string">&quot;bit&quot;</span>, <span class="hljs-number">3</span>, <span class="hljs-literal">true</span>);<br>        redisUtils.setBit(<span class="hljs-string">&quot;bit&quot;</span>, <span class="hljs-number">7</span>, <span class="hljs-literal">true</span>);<br>        System.out.println(redisUtils.bitCount(<span class="hljs-string">&quot;bit&quot;</span>));<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>执行结果如下：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A05-Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%AD%BE%E5%88%B0/2.png" class=""><p>我们通过Redis可视化工具，查看bit的值，可以看出其二进制值与我们操作的一致</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A05-Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%AD%BE%E5%88%B0/3.png" class=""><h3 id="3-位图应用之签到"><a href="#3-位图应用之签到" class="headerlink" title="3. 位图应用之签到"></a>3. 位图应用之签到</h3><p>在很多时候，我们遇到用户签到的场景，用户进入应用时，获取用户当天的签到情况，如果没有签到，用户可以签到，一般这种功能，可以通过set数据结构或bitMap来实现，但bitMap和set相比，其占用的空间更小，因此我们选择使用bitMap来实现签到的功能。<br>SignService：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.util;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.connection.BitFieldSubCommands;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> java.time.LocalDate;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SignService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisUtils redisUtils;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 签到</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sign</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDate.now();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> buildCacheKey(id, now);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">dayOfMonth</span> <span class="hljs-operator">=</span> now.getDayOfMonth();<br><br>        <span class="hljs-comment">// 签到</span><br>        redisUtils.setBit(key, dayOfMonth, <span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 判断是否签到</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSign</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDate.now();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> buildCacheKey(id, now);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">dayOfMonth</span> <span class="hljs-operator">=</span> now.getDayOfMonth();<br>        <span class="hljs-keyword">return</span> redisUtils.getBit(key, dayOfMonth);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取当月的签到次数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getSignCountOfThisMonth</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDate.now();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> buildCacheKey(id, now);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">dayOfMonth</span> <span class="hljs-operator">=</span> now.getDayOfMonth();<br>        List&lt;Long&gt; result = redisTemplate.opsForValue().bitField(key,<br>                BitFieldSubCommands.create()<br>                        .get(BitFieldSubCommands.BitFieldType.unsigned(dayOfMonth)).valueAt(<span class="hljs-number">1</span>));<br>        <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span> || result.isEmpty()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0L</span>;<br>        &#125;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> result.get(<span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (num == <span class="hljs-literal">null</span> || num == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0L</span>;<br>        &#125;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">binaryStr</span> <span class="hljs-operator">=</span> Long.toString(num, <span class="hljs-number">2</span>);<br><br>        <span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; binaryStr.length(); i++) &#123;<br>            <span class="hljs-type">char</span> <span class="hljs-variable">ch</span> <span class="hljs-operator">=</span> binaryStr.charAt(i);<br>            <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">&#x27;1&#x27;</span>) &#123;<br>                count ++;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> count;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取本月连续签到次数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getContinuousSignCountOfThisMonth</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDate.now();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> buildCacheKey(id, now);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">dayOfMonth</span> <span class="hljs-operator">=</span> now.getDayOfMonth();<br>        List&lt;Long&gt; result = redisTemplate.opsForValue().bitField(key,<br>                BitFieldSubCommands.create()<br>                        .get(BitFieldSubCommands.BitFieldType.unsigned(dayOfMonth)).valueAt(<span class="hljs-number">1</span>));<br>        <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span> || result.isEmpty()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0L</span>;<br>        &#125;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> result.get(<span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (num == <span class="hljs-literal">null</span> || num == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0L</span>;<br>        &#125;<br><br>        <span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">if</span> ((num &amp; <span class="hljs-number">1</span>) == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                count ++;<br>            &#125;<br>            num &gt;&gt;&gt;= <span class="hljs-number">1</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> count;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildCacheKey</span><span class="hljs-params">(Integer id, LocalDate localDate)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">year</span> <span class="hljs-operator">=</span> localDate.getYear();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">monthValue</span> <span class="hljs-operator">=</span> localDate.getMonthValue();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sign:&quot;</span> + year + <span class="hljs-string">&quot;:&quot;</span> + monthValue + <span class="hljs-string">&quot;:&quot;</span> + id;<br>        <span class="hljs-keyword">return</span> key;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>测试代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SignService signService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSign</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 签到</span><br>        signService.sign(<span class="hljs-number">1</span>);<br><br>        <span class="hljs-comment">// 判断是否签到</span><br>        System.out.println(<span class="hljs-string">&quot;是否签到：&quot;</span> + signService.isSign(<span class="hljs-number">1</span>));<br><br>        <span class="hljs-comment">// 获取当月的签到次数</span><br>        System.out.println(<span class="hljs-string">&quot;当月的签到次数：&quot;</span> + signService.getSignCountOfThisMonth(<span class="hljs-number">1</span>));<br><br>        <span class="hljs-comment">// 获取当月的连续签到次数</span><br>        System.out.println(<span class="hljs-string">&quot;当月连续签到次数：&quot;</span> + signService.getContinuousSignCountOfThisMonth(<span class="hljs-number">1</span>));<br>    &#125;<br></code></pre></td></tr></table></figure><p>运行结果如下：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A05-Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%AD%BE%E5%88%B0/4.png" class="">]]></content>
    
    
    
    <tags>
      
      <tag>中间件</tag>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redis学习4—Redis应用之限流</title>
    <link href="/2024/04/02/Redis%E5%AD%A6%E4%B9%A04%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E9%99%90%E6%B5%81/"/>
    <url>/2024/04/02/Redis%E5%AD%A6%E4%B9%A04%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E9%99%90%E6%B5%81/</url>
    
    <content type="html"><![CDATA[<h3 id="1-引言"><a href="#1-引言" class="headerlink" title="1. 引言"></a>1. 引言</h3><p>Redis作为一个内存数据库其读写速度非常快，并且支持原子操作，这使得它非常适合处理频繁的请求，一般情况下，我们会使用Redis作为缓存数据库，但处理做缓存数据库之外，Redis的应用还十分广泛，比如这一节，我们将讲解Redis在限流方面的应用。</p><h3 id="2-通过setnx实现限流"><a href="#2-通过setnx实现限流" class="headerlink" title="2. 通过setnx实现限流"></a>2. 通过setnx实现限流</h3><p>我们通过切面，来获取某给接口在一段时间内的请求次数，当请求次数超过某个值时，抛出限流异常，直接返回，不执行业务逻辑。思路大致如下：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A04%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E9%99%90%E6%B5%81/1.png" class=""><h4 id="2-1-初步实现"><a href="#2-1-初步实现" class="headerlink" title="2.1. 初步实现"></a>2.1. 初步实现</h4><p>我们参照上面的流程，对Redis限流进行实现。首先引入aop切面相关的依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>然后添加一个限流注解类，这个注解有三个属性，maxTimes表示最大访问次数，interval表示限流间隙，unit表示时间的单位，假设配置的值为maxTimes&#x3D;10, interval&#x3D;1, unit&#x3D; TimeUnit.SECONDS，那么表示在1秒内，限制访问次数为10次。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.annotations;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.ElementType;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.annotation.RetentionPolicy;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-meta">@Target(value = ElementType.METHOD)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Limit &#123;<br>    <span class="hljs-comment">// 访问次数</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">maxTimes</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">1</span>;<br><br>    <span class="hljs-comment">// 间隔时间</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">interval</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">1</span>;<br><br>    <span class="hljs-comment">// 时间单位</span><br>    <span class="hljs-keyword">public</span> TimeUnit <span class="hljs-title function_">unit</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> TimeUnit.SECONDS;<br>&#125;<br></code></pre></td></tr></table></figure><p>返回结果类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.common;<br><br><span class="hljs-keyword">import</span> lombok.Getter;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Response</span> &lt;T&gt;  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-meta">@Getter</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> code;<br><br>    <span class="hljs-meta">@Getter</span><br>    <span class="hljs-keyword">private</span> String msg;<br><br>    <span class="hljs-meta">@Getter</span><br>    <span class="hljs-keyword">private</span> T data;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Response</span><span class="hljs-params">(<span class="hljs-type">int</span> code, String msg)</span> &#123;<br>        <span class="hljs-built_in">this</span>.code = code;<br>        <span class="hljs-built_in">this</span>.msg = msg;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Response</span><span class="hljs-params">(<span class="hljs-type">int</span> code, String msg, T data)</span> &#123;<br>        <span class="hljs-built_in">this</span>.code = code;<br>        <span class="hljs-built_in">this</span>.msg = msg;<br>        <span class="hljs-built_in">this</span>.data = data;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Response</span><span class="hljs-params">(ResultCode resultCode)</span> &#123;<br>        <span class="hljs-built_in">this</span>.code = resultCode.getCode();<br>        <span class="hljs-built_in">this</span>.msg = resultCode.getMsg();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Response</span><span class="hljs-params">(ResultCode resultCode, T data)</span> &#123;<br>        <span class="hljs-built_in">this</span>.code = resultCode.getCode();<br>        <span class="hljs-built_in">this</span>.msg = resultCode.getMsg();<br>        <span class="hljs-built_in">this</span>.data = data;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Response <span class="hljs-title function_">success</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(ResultCode.SUCCESS);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Response <span class="hljs-title function_">success</span><span class="hljs-params">(T data)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(ResultCode.SUCCESS, data);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Response <span class="hljs-title function_">fail</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(ResultCode.FAIL);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Response <span class="hljs-title function_">fail</span><span class="hljs-params">(ResultCode resultCode)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(resultCode);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Response <span class="hljs-title function_">error</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(ResultCode.SERVER_ERROR);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Response <span class="hljs-title function_">error</span><span class="hljs-params">(String msg)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(ResultCode.SERVER_ERROR.getCode(), msg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>错误码类，在错误码中，我们添加一个LIMIT_ERROR，表示该接口被限流。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.common;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ResultCode</span> &#123;<br>    SUCCESS(<span class="hljs-number">200</span>, <span class="hljs-string">&quot;操作成功&quot;</span>),<br><br>    FAIL(<span class="hljs-number">400</span>, <span class="hljs-string">&quot;操作失败&quot;</span>),<br><br>    SERVER_ERROR(<span class="hljs-number">500</span>, <span class="hljs-string">&quot;服务器错误&quot;</span>),<br><br>    LIMIT_ERROR(<span class="hljs-number">400</span>, <span class="hljs-string">&quot;限流&quot;</span>);<br><br>    <span class="hljs-type">int</span> code;<br><br>    String msg;<br><br>    ResultCode(<span class="hljs-type">int</span> code, String msg) &#123;<br>        <span class="hljs-built_in">this</span>.code = code;<br>        <span class="hljs-built_in">this</span>.msg = msg;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.code;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMsg</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.msg;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>业务异常类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RuntimeException</span> &#123;<br>    <span class="hljs-keyword">private</span> ResultCode resultCode;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BusinessException</span><span class="hljs-params">(ResultCode resultCode)</span> &#123;<br>        <span class="hljs-built_in">super</span>(resultCode.getMsg());<br>        <span class="hljs-built_in">this</span>.resultCode = resultCode;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> ResultCode <span class="hljs-title function_">getResultCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.resultCode;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>全局异常处理类，在我们的切面中，如果发现访问次数大于最大访问次数，那么抛出限流异常，由全局异常处理类进行处理，返回对应的结果</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.exception;<br><br><span class="hljs-keyword">import</span> org.example.common.Response;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestControllerAdvice;<br><br><span class="hljs-meta">@RestControllerAdvice</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> &#123;<br>    <span class="hljs-meta">@ExceptionHandler(value = BusinessException.class)</span><br>    <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">handleBusinessException</span><span class="hljs-params">(BusinessException e)</span> &#123;<br>        <span class="hljs-keyword">return</span> Response.fail(e.getResultCode());<br>    &#125;<br><br>    <span class="hljs-meta">@ExceptionHandler(value = Exception.class)</span><br>    <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">handleException</span><span class="hljs-params">(Exception e)</span> &#123;<br>        <span class="hljs-keyword">return</span> Response.error(e.getMessage());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>限流切面类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.aspect;<br><br><span class="hljs-keyword">import</span> org.aspectj.lang.JoinPoint;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Aspect;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Before;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Pointcut;<br><span class="hljs-keyword">import</span> org.aspectj.lang.reflect.MethodSignature;<br><span class="hljs-keyword">import</span> org.example.annotations.Limit;<br><span class="hljs-keyword">import</span> org.example.common.ResultCode;<br><span class="hljs-keyword">import</span> org.example.exception.BusinessException;<br><span class="hljs-keyword">import</span> org.example.util.RedisUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LimitAspect</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisUtils redisUtils;<br><br>    <span class="hljs-meta">@Pointcut(&quot;@annotation(org.example.annotations.Limit)&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pointCut</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Before(&quot;pointCut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeAdvice</span><span class="hljs-params">(JoinPoint joinPoint)</span> &#123;<br>        <span class="hljs-comment">// 获取方法名</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> joinPoint.getSignature().getName();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">prefixMethod</span> <span class="hljs-operator">=</span> joinPoint.getSignature().getDeclaringTypeName();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">fullMethodName</span> <span class="hljs-operator">=</span> prefixMethod + <span class="hljs-string">&quot;.&quot;</span> + methodName;<br>        System.out.println(<span class="hljs-string">&quot;methodName:&quot;</span> + fullMethodName);<br><br>        Object[] args = joinPoint.getArgs();<br>        <span class="hljs-keyword">for</span> (Object arg : args) &#123;<br>            System.out.println(<span class="hljs-string">&quot;method argument:&quot;</span> + arg);<br>        &#125;<br><br>        <span class="hljs-comment">// 获取注解参数</span><br>        <span class="hljs-type">MethodSignature</span> <span class="hljs-variable">methodSignature</span> <span class="hljs-operator">=</span> (MethodSignature) joinPoint.getSignature();<br>        <span class="hljs-type">Limit</span> <span class="hljs-variable">annotation</span> <span class="hljs-operator">=</span> methodSignature.getMethod().getAnnotation(Limit.class);<br>        System.out.println(annotation.unit());<br>        System.out.println(annotation.maxTimes());<br>        System.out.println(annotation.interval());<br><br>        <span class="hljs-comment">// 获取redis值</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> redisUtils.getKey(fullMethodName);<br>        <span class="hljs-keyword">if</span> (key != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">Integer</span> <span class="hljs-variable">redisValue</span> <span class="hljs-operator">=</span> (Integer) key;<br>            <span class="hljs-comment">// 小于限流值</span><br>            <span class="hljs-keyword">if</span> (redisValue.compareTo(annotation.maxTimes()) &lt; <span class="hljs-number">0</span>) &#123;<br>                redisUtils.increment(fullMethodName);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-comment">// 大于限流值</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.LIMIT_ERROR);<br>        &#125;<br><br>        <span class="hljs-comment">// 获取的值为null, 设置数据到redis中</span><br>        redisUtils.addKey(fullMethodName, <span class="hljs-number">1</span>, annotation.interval(), annotation.unit());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>最后添加一个TestController类，用于进行接口的测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.controller;<br><br><span class="hljs-keyword">import</span> org.example.annotations.Limit;<br><span class="hljs-keyword">import</span> org.example.common.Response;<br><span class="hljs-keyword">import</span> org.example.common.ResultCode;<br><span class="hljs-keyword">import</span> org.example.exception.BusinessException;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(value = &quot;/test&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/hello1&quot;)</span><br>    <span class="hljs-meta">@Limit(maxTimes = 10, interval = 100, unit = TimeUnit.SECONDS)</span><br>    <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">hello1</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(name = &quot;name&quot;, defaultValue = &quot;cxy&quot;)</span> String name)</span> &#123;<br>        <span class="hljs-keyword">return</span> Response.success(<span class="hljs-string">&quot;hello1 success &quot;</span> + name);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>从上面的接口注解配置中，可以看出，这个接口在100秒内最多访问10次，我们启动项目，访问&#x2F;test&#x2F;hello1，前10次的访问结果为：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A04%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E9%99%90%E6%B5%81/2.png" class=""><p>第11次时，开始限流了</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A04%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E9%99%90%E6%B5%81/3.png" class=""><p>这里看起来不是很直观，我们将时间间隙改为2，表示2秒最多由10个请求能执行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(value = &quot;/hello1&quot;)</span><br>    <span class="hljs-meta">@Limit(maxTimes = 10, interval = 2, unit = TimeUnit.SECONDS)</span><br>    <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">hello1</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(name = &quot;name&quot;, defaultValue = &quot;cxy&quot;)</span> String name)</span> &#123;<br>        <span class="hljs-keyword">return</span> Response.success(<span class="hljs-string">&quot;hello1 success &quot;</span> + name);<br>    &#125;<br></code></pre></td></tr></table></figure><p>使用postman进行并发请求，下面的redis限流测试，就是刚才提到的<a href="http://localhost:8080/test/hello1?name=cxy%E8%BF%99%E4%B8%AA%E8%AF%B7%E6%B1%82">http://localhost:8080/test/hello1?name=cxy这个请求</a></p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A04%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E9%99%90%E6%B5%81/4.png" class=""><p>执行该并发测试，结果如下：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A04%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E9%99%90%E6%B5%81/5.png" class=""><p>这里20个请求中，有10个成功，10个被限流。不过这个postman结果展示不太好，只能一个一个查看结果，这里就不一一展示了。</p><h4 id="2-2-职责分离"><a href="#2-2-职责分离" class="headerlink" title="2.2. 职责分离"></a>2.2. 职责分离</h4><p>上面的代码，虽然能成功限流，但是有一个问题，就是切面类的beforeAdvice方法中，做的事情太多了，又是解析请求参数、解析注解参数，又是使用查询Redis，进行限流判断，我们应该将限流逻辑的判断，此外，这里使用的是Redis，如果后续我们不使用Redis，换成其他方式进行限流判断的话，需要改很多处代码，因此，这里要做一些优化，包括：<br>1）定义限流请求类，用于封装访问的方法名、注解信息等内容<br>2）定义限流处理接口<br>3）定义Redis限流处理类，通过Redis实现限流处理接口<br>我们首先定义一个限流请求类，封装限流处理所需要的参数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.request;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LimitRequest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> String methodName;<br><br>    <span class="hljs-keyword">private</span> Integer interval;<br><br>    <span class="hljs-keyword">private</span> Integer maxTimes;<br><br>    <span class="hljs-keyword">private</span> TimeUnit timeUnit;<br><br>    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; extendMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>&#125;<br></code></pre></td></tr></table></figure><p>定义限流处理接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.limit;<br><br><span class="hljs-keyword">import</span> org.example.request.limit.LimitRequest;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LimitHandler</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLimit</span><span class="hljs-params">(LimitRequest limitRequest)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>定义Redis的限流处理类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.limit;<br><br><span class="hljs-keyword">import</span> org.example.common.ResultCode;<br><span class="hljs-keyword">import</span> org.example.exception.BusinessException;<br><span class="hljs-keyword">import</span> org.example.request.limit.LimitRequest;<br><span class="hljs-keyword">import</span> org.example.util.RedisUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisLimitHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LimitHandler</span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisUtils redisUtils;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLimit</span><span class="hljs-params">(LimitRequest limitRequest)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> limitRequest.getMethodName();<br>        <span class="hljs-comment">// 获取redis值</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> redisUtils.getKey(methodName);<br>        <span class="hljs-keyword">if</span> (key != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">Integer</span> <span class="hljs-variable">redisValue</span> <span class="hljs-operator">=</span> (Integer) key;<br>            <span class="hljs-comment">// 小于限流值</span><br>            <span class="hljs-keyword">if</span> (redisValue.compareTo(limitRequest.getMaxTimes()) &lt;= <span class="hljs-number">0</span>) &#123;<br>                redisUtils.increment(methodName);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-comment">// 大于限流值</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.LIMIT_ERROR);<br>        &#125;<br><br>        <span class="hljs-comment">// 获取的值为null, 设置数据到redis中</span><br>        redisUtils.addKey(methodName, <span class="hljs-number">1</span>, limitRequest.getInterval(), limitRequest.getTimeUnit());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>修改LimitAspect代码，但后续更换限流策略是，只需要修改LimitHandler的bean即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.aspect;<br><br><span class="hljs-keyword">import</span> org.aspectj.lang.JoinPoint;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Aspect;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Before;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Pointcut;<br><span class="hljs-keyword">import</span> org.aspectj.lang.reflect.MethodSignature;<br><span class="hljs-keyword">import</span> org.example.annotations.Limit;<br><span class="hljs-keyword">import</span> org.example.limit.LimitHandler;<br><span class="hljs-keyword">import</span> org.example.request.limit.LimitRequest;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LimitAspect</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> LimitHandler redisLimitHandler;<br><br>    <span class="hljs-meta">@Pointcut(&quot;@annotation(org.example.annotations.Limit)&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pointCut</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Before(&quot;pointCut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeAdvice</span><span class="hljs-params">(JoinPoint joinPoint)</span> &#123;<br>        <span class="hljs-type">LimitRequest</span> <span class="hljs-variable">limitRequest</span> <span class="hljs-operator">=</span> convert2LimitRequest(joinPoint);<br><br>        redisLimitHandler.handleLimit(limitRequest);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> LimitRequest <span class="hljs-title function_">convert2LimitRequest</span><span class="hljs-params">(JoinPoint joinPoint)</span> &#123;<br>        <span class="hljs-type">LimitRequest</span> <span class="hljs-variable">limitRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LimitRequest</span>();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> joinPoint.getSignature().getName();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">prefixMethod</span> <span class="hljs-operator">=</span> joinPoint.getSignature().getDeclaringTypeName();<br>        limitRequest.setMethodName(prefixMethod + <span class="hljs-string">&quot;.&quot;</span> + methodName);<br><br>        Object[] args = joinPoint.getArgs();<br>        limitRequest.getExtendMap().put(<span class="hljs-string">&quot;args&quot;</span>, args);<br><br>        <span class="hljs-type">MethodSignature</span> <span class="hljs-variable">methodSignature</span> <span class="hljs-operator">=</span> (MethodSignature) joinPoint.getSignature();<br>        <span class="hljs-type">Limit</span> <span class="hljs-variable">annotation</span> <span class="hljs-operator">=</span> methodSignature.getMethod().getAnnotation(Limit.class);<br>        limitRequest.setInterval(annotation.interval());<br>        limitRequest.setMaxTimes(annotation.maxTimes());<br>        limitRequest.setTimeUnit(annotation.unit());<br>        <span class="hljs-keyword">return</span> limitRequest;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-通过Zset实现限流"><a href="#3-通过Zset实现限流" class="headerlink" title="3. 通过Zset实现限流"></a>3. 通过Zset实现限流</h3><p>我们可以将请求打造成一个zset数组，每一次请求进来时，value保持一致，可以用UUID生成，然后score用当前时间戳表示，通过range方法，来获取某个时间范围内，请求的个数，然后根据这个个数与限流值对比，当大于限流值时，进行限流操作。<br>我们修改RedisLimitHandler代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLimit</span><span class="hljs-params">(LimitRequest limitRequest)</span> &#123;<br>      handleLimitByZSet(limitRequest);<br>   &#125;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLimitByZSet</span><span class="hljs-params">(LimitRequest limitRequest)</span> &#123;<br>       <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> limitRequest.getMethodName();<br><br>       <span class="hljs-type">long</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>       <span class="hljs-type">long</span> <span class="hljs-variable">interval</span> <span class="hljs-operator">=</span> TimeUnit.MILLISECONDS.convert(limitRequest.getInterval(), limitRequest.getTimeUnit());<br><br>       <span class="hljs-keyword">if</span> (redisUtils.hasKey(methodName)) &#123;<br>           <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> redisUtils.rangeByScore(methodName, Double.valueOf(currentTime - interval), Double.valueOf(currentTime)).size();<br>           <span class="hljs-keyword">if</span> (count &gt; limitRequest.getMaxTimes()) &#123;<br>               <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResultCode.LIMIT_ERROR);<br>           &#125;<br>       &#125;<br>       redisUtils.addZSet(methodName, UUID.randomUUID().toString(), Double.valueOf(currentTime));<br>   &#125;<br></code></pre></td></tr></table></figure><p>然后添加一个测试类，用于模拟并发场景下的多个请求</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> org.example.common.Response;<br><span class="hljs-keyword">import</span> org.example.common.ResultCode;<br><span class="hljs-keyword">import</span> org.example.controller.TestController;<br><span class="hljs-keyword">import</span> org.example.exception.BusinessException;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.concurrent.*;<br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisLimitTest</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TestController testController;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testLimit</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>);<br>        Callable&lt;Response&gt; callable = () -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;cxy&quot;</span>;<br>                <span class="hljs-keyword">return</span> testController.hello1(name);<br>            &#125; <span class="hljs-keyword">catch</span> (BusinessException e) &#123;<br>                <span class="hljs-keyword">return</span> Response.fail(e.getResultCode());<br>            &#125;<br>        &#125;;<br>        List&lt;Future&lt;Response&gt;&gt; futureList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) &#123;<br>            Future&lt;Response&gt; submit = executorService.submit(callable);<br>            futureList.add(submit);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (Future&lt;Response&gt; future : futureList) &#123;<br>            System.out.println(JSONObject.toJSONString(future.get()));<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>运行结果如下：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A04%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E9%99%90%E6%B5%81/6.png" class=""><p>我们可以看到，这里确实进行限流了，但是，这个限流个数不太对，这是因为可能多个请求都执行到这条代码，获取到同一个值，然后才进行更新。<br> int count &#x3D; redisUtils.rangeByScore(methodName, Double.valueOf(currentTime - interval), Double.valueOf(currentTime)).size();<br>比如有5个请求同时打过来，此时的执行到上面这条代码时，redis中符合范围的刚好有9条，那么这5个请求在进行判断时，都小于限流值，因此都会执行，然后才是更新zset，这个就是并发场景下的问题了。<br>另外，使用zset还有一个问题，它虽然能达到滑动窗口的效果，但是zset的数据结构会越来越大。</p>]]></content>
    
    
    
    <tags>
      
      <tag>中间件</tag>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redis学习3—Redis应用之缓存</title>
    <link href="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/"/>
    <url>/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/</url>
    
    <content type="html"><![CDATA[<h3 id="1-引言"><a href="#1-引言" class="headerlink" title="1. 引言"></a>1. 引言</h3><h4 id="1-1-缓存的意义"><a href="#1-1-缓存的意义" class="headerlink" title="1.1. 缓存的意义"></a>1.1. 缓存的意义</h4><p>Redis作为一个NoSql数据库，被广泛的当作缓存数据库使用，所谓缓存，就是数据交换的缓冲区。使用缓存的具体原因有：</p><ol><li>缓存数据存储于代码中，而代码运行在内存中，内存的读写性能远高于磁盘，通过缓存，可以大大降低用户访问并发量带来的服务器读写压力。</li><li>实际开发过程中，企业的数据量，少则几十万，多则上千万，如此大的数据量，如果没有缓存来作为“避震器”，系统是几乎撑不住的，所以企业会大量运用缓存技术。<img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/1.png" class=""></li></ol><h4 id="1-2-缓存的分类"><a href="#1-2-缓存的分类" class="headerlink" title="1.2. 缓存的分类"></a>1.2. 缓存的分类</h4><p>对于缓存，我们可以分为以下几类：</p><ol><li>浏览器缓存：主要存在于浏览器端的缓存</li><li>应用层缓存：本地缓存（比如tomcat本地缓存）或缓存数据库（比如redis）</li><li>数据库缓存：在数据库中有一片空间是buffer pool，增删改查数据都会先加载到mysql的缓存中</li><li>CPU缓存：当代计算机最大的问题是 cpu性能提升了，但内存读写速度没有跟上，所以为了适应当下的情况，增加了cpu的L1，L2，L3级的缓存<img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/2.png" class=""></li></ol><h3 id="2-缓存模型"><a href="#2-缓存模型" class="headerlink" title="2. 缓存模型"></a>2. 缓存模型</h3><h4 id="2-1-查询、添加缓存"><a href="#2-1-查询、添加缓存" class="headerlink" title="2.1. 查询、添加缓存"></a>2.1. 查询、添加缓存</h4><p>一般情况下，在查询数据库之前，先查询缓存，如果缓存数据存在，就直接返回缓存数据，如果不存在，查询数据库，并将数据存入redis，具体的模型如下：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/3.png" class=""><h4 id="2-2-缓存淘汰"><a href="#2-2-缓存淘汰" class="headerlink" title="2.2. 缓存淘汰"></a>2.2. 缓存淘汰</h4><p>内存的空间是有限的，当我们向redis存储太多数据时，redis会对部分数据进行淘汰，淘汰数据的场景有：</p><ol><li>内存淘汰：Redis自动进行，当redis内存达到设定的max-memery时，会自动触发淘汰机制，淘汰掉一些不重要的数据。</li><li>超时剔除：当对redis设置了过期时间TTL时，Redis会将超时的数据进行删除。</li><li>主动更新：通过手动调用方法把缓存删除掉，常用于解决缓存与数据库不一致的问题。<br>Redis自动进行内存淘汰时，主要有6+2种数据淘汰机制，可以分为以下三大类：</li><li>不淘汰数据<br>● noeviction ，不进行数据淘汰，当缓存被写满后，Redis不提供服务直接返回错误。</li><li>在设置过期时间的键值对中，<br>● volatile-random ，在设置过期时间的键值对中随机删除<br>● volatile-ttl ，在设置过期时间的键值对，基于过期时间的先后进行删除，越早过期的越先被删除。<br>● volatile-lru ， 基于LRU(Least Recently Used) 算法筛选设置了过期时间的键值对， 最近最少使用的原则来筛选数据<br>● volatile-lfu ，使用 LFU( Least Frequently Used ) 算法选择设置了过期时间的键值对, 使用频率最少的键值对,来筛选数据。</li><li>在所有键值对中<br>● allkeys-random， 从所有键值对中随机选择并删除数据<br>● allkeys-lru， 使用 LRU 算法在所有数据中进行筛选<br>● allkeys-lfu， 使用 LFU 算法在所有数据中进行筛选<img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/4.png" class=""></li></ol><h4 id="2-3-数据库缓存不一致解决方案"><a href="#2-3-数据库缓存不一致解决方案" class="headerlink" title="2.3. 数据库缓存不一致解决方案"></a>2.3. 数据库缓存不一致解决方案</h4><p>因为我们的缓存数据来自于数据库，而数据库的数据会随业务的需要而发生变化，当数据库中的数据变化，而缓存没有同步该数据，此时便会产生一致性问题。具体的解决策略有：</p><ol><li>Cache Aside Pattern（旁路缓存）</li><li>Read&#x2F;Write-Through Pattern（读写穿透）</li><li>Write Behind Pattern（异步缓存写入）</li></ol><h5 id="2-3-1-Cache-Aside-Pattern（旁路缓存模式）"><a href="#2-3-1-Cache-Aside-Pattern（旁路缓存模式）" class="headerlink" title="2.3.1. Cache Aside Pattern（旁路缓存模式）"></a>2.3.1. Cache Aside Pattern（旁路缓存模式）</h5><p>该模式是平时使用比较多的一个缓存读写模式，比较适合读请求比较多的场景，在该模式中，需要同时维系db和cache，并且以db的结果为准。</p><h6 id="2-3-1-1-写"><a href="#2-3-1-1-写" class="headerlink" title="2.3.1.1. 写"></a>2.3.1.1. 写</h6><p>先更新db，然后再直接删除cache</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/5.png" class=""><p>注意，不能先删除cache，在写db，因为在并发的情况下，可能存在，请求1删除缓存，然后写db，并且写db操作还没结束，这时请求2获取缓存，此时因为缓存被删除了，因此会从数据库读数据， 并存入缓存，这个时候的数据是未更新的，当请求2结束后，请求1写db结束，此时就会造成数据库和缓存中的数据不一致。</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/6.png" class=""><p>旁路缓存理论上来说，也会造成数据库和缓存不一致的问题，比如：请求 1 先写数据 A，请求 2 随后读数据 A 的话，就很有可能产生数据不一致性的问题。<br>这个过程可以简单描述为：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/7.png" class=""><p>但这种概率很小，因为缓存的写入速度比数据库的写入速度快很多。</p><h6 id="2-3-1-2-读"><a href="#2-3-1-2-读" class="headerlink" title="2.3.1.2. 读"></a>2.3.1.2. 读</h6><p>从cache中读取数据，读取到就直接返回。如果读取不到，从db中读取数据返回，然后再把数据放到cache中。</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/8.png" class=""><h6 id="2-3-1-3-Cache-Aside-Pattern的缺陷"><a href="#2-3-1-3-Cache-Aside-Pattern的缺陷" class="headerlink" title="2.3.1.3. Cache Aside Pattern的缺陷"></a>2.3.1.3. Cache Aside Pattern的缺陷</h6><ol><li>首次请求数据一定不在cache：这种情况可以先将热点数据提前放入cache中。</li><li>写操作比较频繁，会导致cache的数据被频繁删除，影响缓存命中率：更新db的时候同时更新cache，但是给缓存设置一个比较短的过期时间，保证即使数据不一致的话，影响也比较小。</li></ol><h5 id="2-3-2-Read-Write-Through-Pattern（读写穿透）"><a href="#2-3-2-Read-Write-Through-Pattern（读写穿透）" class="headerlink" title="2.3.2. Read&#x2F;Write Through Pattern（读写穿透）"></a>2.3.2. Read&#x2F;Write Through Pattern（读写穿透）</h5><p>服务端把 cache 视为主要数据存储，从中读取数据并将数据写入其中。cache 服务负责将此数据读取和写入 db，从而减轻了应用程序的职责。这种策略比较少使用，因为Redis并没有提供cache将数据写入db的功能。</p><h6 id="2-3-2-1-写（Write-Through）"><a href="#2-3-2-1-写（Write-Through）" class="headerlink" title="2.3.2.1. 写（Write Through）"></a>2.3.2.1. 写（Write Through）</h6><p>● 先查 cache，cache 中不存在，直接更新 db。<br>● cache 中存在，则先更新 cache，然后 cache 服务自己更新 db（同步更新 cache 和 db）。</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/9.png" class=""><h6 id="2-3-2-2-读（Read-Through）"><a href="#2-3-2-2-读（Read-Through）" class="headerlink" title="2.3.2.2. 读（Read Through）"></a>2.3.2.2. 读（Read Through）</h6><p>● 从 cache 中读取数据，读取到就直接返回 。<br>● 读取不到的话，先从 db 加载，写入到 cache 后返回响应。</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/10.png" class=""><h6 id="2-3-2-3-缺陷"><a href="#2-3-2-3-缺陷" class="headerlink" title="2.3.2.3. 缺陷"></a>2.3.2.3. 缺陷</h6><ol><li>实现困难，如Redis并没有提供cache将数据写入db的功能</li><li>和Cache Aside Pattern一样，首次请求数据一定不在cache中</li></ol><h5 id="2-3-3-Write-Behind-Pattern（异步缓存写入）"><a href="#2-3-3-Write-Behind-Pattern（异步缓存写入）" class="headerlink" title="2.3.3. Write Behind Pattern（异步缓存写入）"></a>2.3.3. Write Behind Pattern（异步缓存写入）</h5><p>与Read&#x2F;Write Through Pattern相似，都是由cache服务来负责cache和db的读写，但是，Read&#x2F;Write Through是同步更新cache和db，而Write Behind是只更新缓存，不直接更新db，改为异步批量的方式，更新db。<br>这种方式对数据一致性带来了更大的挑战，比如 cache 数据可能还没异步更新 db 的话，cache 服务可能就就挂掉了。这种策略在我们平时开发过程中也非常非常少见，但是不代表它的应用场景少，比如消息队列中消息的异步写入磁盘、MySQL 的 Innodb Buffer Pool 机制都用到了这种策略。<br>Write Behind Pattern 下 db 的写性能非常高，非常适合一些数据经常变化又对数据一致性要求没那么高的场景，比如浏览量、点赞量。</p><h3 id="3-缓存常见的问题"><a href="#3-缓存常见的问题" class="headerlink" title="3. 缓存常见的问题"></a>3. 缓存常见的问题</h3><h4 id="3-1-缓存雪崩"><a href="#3-1-缓存雪崩" class="headerlink" title="3.1. 缓存雪崩"></a>3.1. 缓存雪崩</h4><p>缓存雪崩，指缓存在同一时间大面积的生效（比如缓存数据过期），导致大量的请求都直接落到数据库上，给数据库造成了巨大的压力。此外，如果缓存服务器宕机也会导致缓存雪崩现象，导致所有的请求都落到了数据库上。</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/11.png" class=""><p>解决方法有：</p><ol><li>采用Redis集群，避免单机出现问题导致整个缓存服务器无法使用。</li><li>限流，避免同时处理大量请求。</li><li>多级缓存，比如本地缓存+Redis缓存的组合，当Redis缓存出现问题时，可以从本地缓存中获取部分数据。</li><li>设置不同的生效时间比如随机设置缓存的失效时间。</li><li>缓存永不生效。</li><li>缓存预热，在程序启动后或运行过程中，主动将热点数据加载到缓存中。</li></ol><h4 id="3-2-缓存穿透"><a href="#3-2-缓存穿透" class="headerlink" title="3.2. 缓存穿透"></a>3.2. 缓存穿透</h4><p>缓存穿透指大量请求的key是不合理的，根本不存在与缓存和数据库中，这就导致这些请求直接到了数据库，给数据库造成巨大压力。比如黑客故意制造一些非法的key发起大量请求，导致大量请求落到数据库，结果数据库上也没有查到对应的数据。</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/12.png" class=""><p>解决方法：</p><ol><li>参数校验：对不合法的参数请求，直接抛出异常信息给客户端，比如查询的数据库id不能为0，手机格式不正确等。</li><li>缓存无效key：将这些无效的key设置到缓存中，并设置一个较短的过期时间。这种方法可以解决请求的key变化不频繁的情况。</li><li>接口限流。</li><li>布隆过滤器：通过布隆过滤器判断一个给定数据是否存在于海量数据中。具体做法是：把所有可能存在的请求的值都存放在布隆过滤器中，当用户请求过来，先判断用户发来的请求的值是否存在于布隆过滤器中。不存在的话，直接返回请求参数错误信息给客户端，存在的话才会走下面的流程。<img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/13.png" class=""></li></ol><h4 id="3-3-缓存击穿"><a href="#3-3-缓存击穿" class="headerlink" title="3.3. 缓存击穿"></a>3.3. 缓存击穿</h4><p>缓存击穿，指请求的key对应的是热点数据，该数据存在于数据库中，但是不存在于缓存中（通常是因为缓存中的数据已经过期），这就会导致瞬时大量请求直接打到了数据库上，对数据库造成巨大压力。比如秒杀进行过程中，缓存中的某个秒杀商品数据过期，导致瞬时大量对该商品的请求直接落到数据库上，对数据库造成巨大压力。</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/14.png" class=""><p>解决方法：</p><ol><li>设置热点数据永不过期或过期时间较长。</li><li>针对热点数据提取预热，将其存入缓存中并设置合理的过期时间。</li><li>请求数据库写数据到缓存之前，先获取互斥锁，保证只有一个请求会落到数据库上，减少数据库的压力。</li></ol><h3 id="4-SpringBoot整合Redis实现缓存"><a href="#4-SpringBoot整合Redis实现缓存" class="headerlink" title="4. SpringBoot整合Redis实现缓存"></a>4. SpringBoot整合Redis实现缓存</h3><h4 id="4-1-准备数据库数据"><a href="#4-1-准备数据库数据" class="headerlink" title="4.1. 准备数据库数据"></a>4.1. 准备数据库数据</h4><p>首先我们创建一个t_user表，并插入几条数据，用于后续的查询：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/15.png" class=""><h4 id="4-2-读缓存"><a href="#4-2-读缓存" class="headerlink" title="4.2. 读缓存"></a>4.2. 读缓存</h4><p>创建User类和对应的UserMapper</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@TableName(value = &quot;t_user&quot;)</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span><br>    <span class="hljs-keyword">private</span> Integer id;<br><br>    <span class="hljs-keyword">private</span> String username;<br><br>    <span class="hljs-keyword">private</span> String password;<br>&#125;<br><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;User&gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>UserService</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-comment">// 过期时间</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-variable">ttl</span> <span class="hljs-operator">=</span> <span class="hljs-number">100L</span>;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisUtils redisUtils;<br><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user:&quot;</span> + id;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> redisUtils.getKey(key);<br>        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 缓存中存在该数据</span><br>            <span class="hljs-keyword">return</span> (User) value;<br>        &#125;<br><br>        <span class="hljs-comment">// 缓存中不存在该数据, 从数据库中查询</span><br>        <span class="hljs-type">User</span> <span class="hljs-variable">userFromDB</span> <span class="hljs-operator">=</span> getUserFromDB(id);<br>        <span class="hljs-keyword">if</span> (userFromDB == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        redisUtils.addKey(key, userFromDB, ttl);<br>        <span class="hljs-keyword">return</span> userFromDB;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> User <span class="hljs-title function_">getUserFromDB</span><span class="hljs-params">(Integer id)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;从数据库中查询====================&quot;</span>);<br>        <span class="hljs-keyword">return</span> userMapper.selectById(id);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>添加一个测试方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> org.example.pojo.User;<br><span class="hljs-keyword">import</span> org.example.service.UserService;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisCacheTest</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGetUserById</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">userById</span> <span class="hljs-operator">=</span> userService.getUserById(<span class="hljs-number">1</span>);<br>        System.out.println(userById);<br><br>        userById = userService.getUserById(<span class="hljs-number">1</span>);<br>        System.out.println(userById);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>执行测试方法，结果如下：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/16.png" class=""><p>从上述内容中，可以看出，第一次查询时，因为数据不存在于缓存中，所以会查询数据库，第二次查询时，从缓存中查询到数据，直接返回。<br>但是这里涉及到一个序列化的问题，我们通过下载一些redis桌面可视化工具，查看这些数据，发现这些key和value都有一些奇怪的编码，如下图所示：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/17.png" class=""><p>这是因为，默认情况下，redisTemplate使用JDK的序列化器(JdkSerializationRedisSerializer)对存储的对象进行序列哈和反序列化操作，这可能导致序列化结果不可读或占用较多的存储空间。因此，我们需要在配置redisTemplate的时候，设置对应的序列化器，我们修改上一章的RedisConfiguration类，修改结果如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.config;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfiguration</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;<br>        RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();<br>        redisTemplate.setConnectionFactory(redisConnectionFactory);<br><br>        <span class="hljs-type">StringRedisSerializer</span> <span class="hljs-variable">stringRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>();<br>        <span class="hljs-type">Jackson2JsonRedisSerializer</span> <span class="hljs-variable">jackson2JsonRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonRedisSerializer</span>(Object.class);<br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);<br>        jackson2JsonRedisSerializer.setObjectMapper(objectMapper);<br><br>        <span class="hljs-comment">// 设置key的序列化器为StringRedisSerializer</span><br>        redisTemplate.setKeySerializer(stringRedisSerializer);<br>        <span class="hljs-comment">// 设置value的序列化器为Jackson2JsonRedisSerializer</span><br>        redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);<br><br>        <span class="hljs-comment">// 设置hash key的序列化器为StringRedisSerializer</span><br>        redisTemplate.setHashKeySerializer(stringRedisSerializer);<br>        <span class="hljs-comment">// 设置hash value的序列化器为Jackson2JsonRedisSerializer</span><br>        redisTemplate.setHashValueSerializer(jackson2JsonRedisSerializer);<br><br>        <span class="hljs-comment">// 完成其他配置后，初始化RedisTemplate</span><br>        redisTemplate.afterPropertiesSet();<br>        <span class="hljs-keyword">return</span> redisTemplate;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>我们将之前那些key全部删除掉，然后重新运行测试代码，结果如下：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/18.png" class=""><p>通过redis可视化工具，也能清楚地看到每个key和value的结构和信息。</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/19.png" class=""><p>上面的代码，存在一些问题，当请求1查询id&#x3D;1的用户，从缓存中查询不到时，会查询数据库，然后将数据更新到数据库，然后请求2查询id&#x3D;1的用户，从缓存中查询到，便直接返回，这是理想的情况。但是，可能请求1查询数据库还没执行完，请求2过来了，此时缓存中没有id&#x3D;1的用户，因此请求2也会去查询数据库。<br>比如我们修改getUserFromDB，加上Thread.sleep(2000)，模拟数据库的查询较慢，然后修改测试代码，模拟多个请求同时查询id&#x3D;1的用户的情况：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGetUserById</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>     <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">2</span>);<br>     Callable&lt;User&gt; getUserTask = () -&gt; userService.getUserById(<span class="hljs-number">1</span>);<br><br>     Future&lt;User&gt; submit1 = executorService.submit(getUserTask);<br>     Future&lt;User&gt; submit2 = executorService.submit(getUserTask);<br>     System.out.println(submit1.get());<br>     System.out.println(submit2.get());<br> &#125;<br></code></pre></td></tr></table></figure><p>此时再次执行测试代码，结果如下：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/20.png" class=""><p>解决上面的情况，方式就是加锁，我们修改UserService的代码如下,这里通过synchronized加锁，然后锁的对象使用key，这样可以将锁的粒度缩小一点。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Integer id)</span> &#123;<br>       <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user:&quot;</span> + id;<br>       <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> redisUtils.getKey(key);<br>       <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>           <span class="hljs-comment">// 缓存中存在该数据</span><br>           <span class="hljs-keyword">return</span> (User) value;<br>       &#125;<br><br>       <span class="hljs-type">User</span> <span class="hljs-variable">userFromDB</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>       <span class="hljs-keyword">synchronized</span> (key.intern()) &#123;<br>           <span class="hljs-comment">// 再次查询缓存</span><br>           value = redisUtils.getKey(key);<br>           <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>               <span class="hljs-keyword">return</span> (User) value;<br>           &#125;<br><br>           <span class="hljs-comment">// 缓存中不存在该数据, 从数据库中查询</span><br>           userFromDB = getUserFromDB(id);<br>           <span class="hljs-keyword">if</span> (userFromDB == <span class="hljs-literal">null</span>) &#123;<br>               <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>           &#125;<br>           redisUtils.addKey(key, userFromDB, ttl);<br>       &#125;<br>       <span class="hljs-keyword">return</span> userFromDB;<br>   &#125;<br><br>   <span class="hljs-keyword">private</span> User <span class="hljs-title function_">getUserFromDB</span><span class="hljs-params">(Integer id)</span> &#123;<br>       <span class="hljs-keyword">try</span> &#123;<br>           Thread.sleep(<span class="hljs-number">2000</span>);<br>       &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>           e.printStackTrace();<br>       &#125;<br>       System.out.println(<span class="hljs-string">&quot;从数据库中查询====================&quot;</span>);<br>       <span class="hljs-keyword">return</span> userMapper.selectById(id);<br>   &#125;<br></code></pre></td></tr></table></figure><p>重新运行测试方法，结果如下：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/21.png" class=""><p>通过加锁，可以解决被访问多次的情况，但是这样的锁有一个问题，这个锁，只适用于单机的情况，当我们的服务部署在多台服务器上时，这些服务器上的应用，对应的JVM都不同，因此锁住的，不是同一个对象，后续会单独对分布式锁进行讲解，这里先不予讨论。</p><h4 id="4-3-更新缓存"><a href="#4-3-更新缓存" class="headerlink" title="4.3. 更新缓存"></a>4.3. 更新缓存</h4><p>修改userService，添加修改用户的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(UpdateUserRequest updateUserRequest)</span> &#123;<br>       <span class="hljs-keyword">if</span> (updateUserRequest.getId() == <span class="hljs-literal">null</span>) &#123;<br>           <span class="hljs-keyword">return</span>;<br>       &#125;<br>       <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> getUserById(updateUserRequest.getId());<br>       <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>           <span class="hljs-keyword">return</span>;<br>       &#125;<br>       <span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(updateUserRequest.getUsername())) &#123;<br>           user.setUsername(updateUserRequest.getUsername());<br>       &#125;<br>       <span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(updateUserRequest.getPassword())) &#123;<br>           user.setPassword(updateUserRequest.getPassword());<br>       &#125;<br>       <span class="hljs-comment">// 先更新数据库</span><br>       <span class="hljs-type">int</span> <span class="hljs-variable">updateResult</span> <span class="hljs-operator">=</span> userMapper.updateById(user);<br>       <span class="hljs-keyword">if</span> (updateResult == <span class="hljs-number">1</span>) &#123;<br>           <span class="hljs-comment">// 更新成功，删除缓存</span><br>           redisUtils.removeKey(<span class="hljs-string">&quot;user:&quot;</span> + updateUserRequest.getId());<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><p>添加测试方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testUpdateUser</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-type">UpdateUserRequest</span> <span class="hljs-variable">updateUserRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpdateUserRequest</span>();<br>       updateUserRequest.setId(<span class="hljs-number">1</span>);<br>       updateUserRequest.setPassword(<span class="hljs-string">&quot;12345&quot;</span>);<br>       userService.updateUser(updateUserRequest);<br><br>       <span class="hljs-type">User</span> <span class="hljs-variable">userById</span> <span class="hljs-operator">=</span> userService.getUserById(<span class="hljs-number">1</span>);<br>       System.out.println(userById);<br>   &#125;<br></code></pre></td></tr></table></figure><p>测试结果如下</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/22.png" class=""><h3 id="5-SpringBoot整合SpringCache-Redis"><a href="#5-SpringBoot整合SpringCache-Redis" class="headerlink" title="5. SpringBoot整合SpringCache+Redis"></a>5. SpringBoot整合SpringCache+Redis</h3><p>在上面的代码中，我们发现，和Redis查询的操作，和我们的业务代码糅合在一起， 不方便进行处理，如果后续我们缓存服务器从Redis改为其他缓存服务器，需要修改多处代码，不利于项目的扩展和维护。<br>SpringCache框架是Spring框架提供的一套基于注解的缓存解决方案，在应用程序中简化了缓存操作的管理和使用。它通过在方法上添加缓存注解，来实现自动缓存的功能，其常用注解有：<br>1）@Cacheable: 表示该方法返回结果可以被缓存，当方法被调用时，先检查缓存，如果缓存命中，直接返回缓存中的结果，不再执行方法体中的逻辑。<br>2） @CachePut：表示该方法的返回结果需要更新缓存，每次方法被调用后，都会将返回结果更新到缓存中。<br>3）@CacheEvit：表示该方法会清除缓存中的数据，可以用于在更新或删除数据时清除相应的缓存。</p><h4 id="5-1-整合SpringCache"><a href="#5-1-整合SpringCache" class="headerlink" title="5.1. 整合SpringCache"></a>5.1. 整合SpringCache</h4><p>添加Spring Cache的依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>在启动类上加上注解开启缓存</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableCaching</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisApp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(RedisApp.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="5-2-测试Cacheable和CacheEvict"><a href="#5-2-测试Cacheable和CacheEvict" class="headerlink" title="5.2. 测试Cacheable和CacheEvict"></a>5.2. 测试Cacheable和CacheEvict</h4><p>我们在userService类上，加上两个方法，用于测试Cacheable和CacheEvit注解。<br>添加getUserById2方法，该方法中的逻辑为查询数据库操作</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Cacheable(value = &quot;user&quot;, key = &quot;#id&quot;)</span><br>  <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById2</span><span class="hljs-params">(Integer id)</span> &#123;<br>      System.out.println(<span class="hljs-string">&quot;从数据库中查询==============&quot;</span>);<br>      <span class="hljs-keyword">return</span> userMapper.selectById(id);<br>  &#125;<br></code></pre></td></tr></table></figure><p>然后添加一个测试方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>   <span class="hljs-keyword">private</span> UserService userService;<br><br>   <span class="hljs-meta">@Test</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGetUserById</span><span class="hljs-params">()</span> &#123;<br>       System.out.println(userService.getUserById2(<span class="hljs-number">1</span>));<br>       System.out.println(userService.getUserById2(<span class="hljs-number">1</span>));<br>   &#125;<br></code></pre></td></tr></table></figure><p>测试结果如下，第一次查询时，查询数据库，第二次直接查询缓存。</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/23.png" class=""><p>然后我们查看reids缓存，发现这个key的值是user::1，这个和我们之前定义的不太相同，而且没有过期时间，除此之外，这个value的值，序列化有问题</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/24.png" class=""><p>我们修改RedisConfiguration，添加RedisCacheConfiguration的相关配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.config;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.cache.RedisCacheConfiguration;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.RedisSerializationContext;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;<br><br><span class="hljs-keyword">import</span> java.time.Duration;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfiguration</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;<br>        RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();<br>        redisTemplate.setConnectionFactory(redisConnectionFactory);<br><br>        <span class="hljs-type">StringRedisSerializer</span> <span class="hljs-variable">stringRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>();<br>        <span class="hljs-type">Jackson2JsonRedisSerializer</span> <span class="hljs-variable">jackson2JsonRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonRedisSerializer</span>(Object.class);<br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);<br>        jackson2JsonRedisSerializer.setObjectMapper(objectMapper);<br><br>        <span class="hljs-comment">// 设置key的序列化器为StringRedisSerializer</span><br>        redisTemplate.setKeySerializer(stringRedisSerializer);<br>        <span class="hljs-comment">// 设置value的序列化器为Jackson2JsonRedisSerializer</span><br>        redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);<br><br>        <span class="hljs-comment">// 设置hash key的序列化器为StringRedisSerializer</span><br>        redisTemplate.setHashKeySerializer(stringRedisSerializer);<br>        <span class="hljs-comment">// 设置hash value的序列化器为Jackson2JsonRedisSerializer</span><br>        redisTemplate.setHashValueSerializer(jackson2JsonRedisSerializer);<br><br>        <span class="hljs-comment">// 完成其他配置后，初始化RedisTemplate</span><br>        redisTemplate.afterPropertiesSet();<br>        <span class="hljs-keyword">return</span> redisTemplate;<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisCacheConfiguration <span class="hljs-title function_">redisCacheConfiguration</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">Jackson2JsonRedisSerializer</span> <span class="hljs-variable">jackson2JsonRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonRedisSerializer</span>(Object.class);<br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);<br>        jackson2JsonRedisSerializer.setObjectMapper(objectMapper);<br><br>        <span class="hljs-comment">//相当于new了一个RedisCacheConfiguration</span><br>        <span class="hljs-type">RedisCacheConfiguration</span>  <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> RedisCacheConfiguration.defaultCacheConfig();<br>        configuration = configuration.serializeValuesWith<br>                <span class="hljs-comment">// 指定value序列化器</span><br>                        (RedisSerializationContext.SerializationPair.fromSerializer(jackson2JsonRedisSerializer))<br>                <span class="hljs-comment">// 指定 key的TTL</span><br>                .entryTtl(Duration.ofSeconds(<span class="hljs-number">100</span>))<br>                <span class="hljs-comment">// 指定前缀</span><br>                .prefixCacheNameWith(<span class="hljs-string">&quot;user::&quot;</span>);<br>        <span class="hljs-keyword">return</span> configuration;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>删除原先的缓存，然后重新运行测试代码，然后查看缓存信息，结果如下：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/25.png" class=""><p>此时过期时间和序列化均设置成功。但这样配置还有一些问题，通过这种全局配置，所有cache key的TTL都一样，实际开发中，不同的cache key可能需要的TTL都不同，我们修改RedisConfiguration，为不同的key配置上不同的过期时间</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.config;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.cache.RedisCacheManagerBuilderCustomizer;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.cache.RedisCacheConfiguration;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.RedisSerializationContext;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;<br><br><span class="hljs-keyword">import</span> java.time.Duration;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfiguration</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;<br>        RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();<br>        redisTemplate.setConnectionFactory(redisConnectionFactory);<br><br>        <span class="hljs-type">StringRedisSerializer</span> <span class="hljs-variable">stringRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>();<br>        <span class="hljs-type">Jackson2JsonRedisSerializer</span> <span class="hljs-variable">jackson2JsonRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonRedisSerializer</span>(Object.class);<br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);<br>        jackson2JsonRedisSerializer.setObjectMapper(objectMapper);<br><br>        <span class="hljs-comment">// 设置key的序列化器为StringRedisSerializer</span><br>        redisTemplate.setKeySerializer(stringRedisSerializer);<br>        <span class="hljs-comment">// 设置value的序列化器为Jackson2JsonRedisSerializer</span><br>        redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);<br><br>        <span class="hljs-comment">// 设置hash key的序列化器为StringRedisSerializer</span><br>        redisTemplate.setHashKeySerializer(stringRedisSerializer);<br>        <span class="hljs-comment">// 设置hash value的序列化器为Jackson2JsonRedisSerializer</span><br>        redisTemplate.setHashValueSerializer(jackson2JsonRedisSerializer);<br><br>        <span class="hljs-comment">// 完成其他配置后，初始化RedisTemplate</span><br>        redisTemplate.afterPropertiesSet();<br>        <span class="hljs-keyword">return</span> redisTemplate;<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisCacheManagerBuilderCustomizer <span class="hljs-title function_">redisCacheManagerBuilderCustomizer</span><span class="hljs-params">()</span> &#123;<br>        Jackson2JsonRedisSerializer&lt;Object&gt; jackson2JsonRedisSerializer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonRedisSerializer</span>&lt;&gt;(Object.class);<br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);<br>        jackson2JsonRedisSerializer.setObjectMapper(objectMapper);<br><br>        <span class="hljs-keyword">return</span> (builder) -&gt; &#123;<br>            Map&lt;String, RedisCacheConfiguration&gt; cacheConfigurations = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>            cacheConfigurations.put(<span class="hljs-string">&quot;user&quot;</span>,<br>                    RedisCacheConfiguration.defaultCacheConfig()<br>                            .entryTtl(Duration.ofSeconds(<span class="hljs-number">60</span>))<br>                            .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(jackson2JsonRedisSerializer)));<br><br>            cacheConfigurations.put(<span class="hljs-string">&quot;product&quot;</span>,<br>                    RedisCacheConfiguration.defaultCacheConfig()<br>                            .entryTtl(Duration.ofSeconds(<span class="hljs-number">120</span>))<br>                            .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(jackson2JsonRedisSerializer)));<br><br>            builder.withInitialCacheConfigurations(cacheConfigurations);<br>        &#125;;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><p>运行结果如下：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/26.png" class=""><p>接着，我们测试CacheEvict，首先在userService中添加一个更新方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@CacheEvict(value = &quot;user&quot;, key = &quot;#updateUserRequest.id&quot;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser2</span><span class="hljs-params">(UpdateUserRequest updateUserRequest)</span> &#123;<br>      <span class="hljs-keyword">if</span> (updateUserRequest.getId() == <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">return</span>;<br>      &#125;<br>      <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> getUserById2(updateUserRequest.getId());<br>      <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">return</span>;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(updateUserRequest.getUsername())) &#123;<br>          user.setUsername(updateUserRequest.getUsername());<br>      &#125;<br>      <span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(updateUserRequest.getPassword())) &#123;<br>          user.setPassword(updateUserRequest.getPassword());<br>      &#125;<br>      <span class="hljs-comment">// 先更新数据库</span><br>      userMapper.updateById(user);<br>  &#125;<br></code></pre></td></tr></table></figure><p>然后添加测试方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testUpdateUser</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-type">UpdateUserRequest</span> <span class="hljs-variable">updateUserRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpdateUserRequest</span>();<br>       updateUserRequest.setId(<span class="hljs-number">1</span>);<br>       updateUserRequest.setPassword(<span class="hljs-string">&quot;123456&quot;</span>);<br>       userService.updateUser2(updateUserRequest);<br>   &#125;<br></code></pre></td></tr></table></figure><p>运行该测试方法，然后去看对应的redis缓存，发现更新成功后，该缓存被删除掉，说明CacheEvict生效</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A03%E2%80%94Redis%E5%BA%94%E7%94%A8%E4%B9%8B%E7%BC%93%E5%AD%98/27.png" class="">]]></content>
    
    
    
    <tags>
      
      <tag>中间件</tag>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redis学习2—SpringBoot整合Redis、Redis工具类</title>
    <link href="/2024/04/02/Redis%E5%AD%A6%E4%B9%A02%E2%80%94SpringBoot%E6%95%B4%E5%90%88Redis%E3%80%81Redis%E5%B7%A5%E5%85%B7%E7%B1%BB/"/>
    <url>/2024/04/02/Redis%E5%AD%A6%E4%B9%A02%E2%80%94SpringBoot%E6%95%B4%E5%90%88Redis%E3%80%81Redis%E5%B7%A5%E5%85%B7%E7%B1%BB/</url>
    
    <content type="html"><![CDATA[<h3 id="1-依赖和配置"><a href="#1-依赖和配置" class="headerlink" title="1. 依赖和配置"></a>1. 依赖和配置</h3><h4 id="1-1-pom-xml"><a href="#1-1-pom-xml" class="headerlink" title="1.1. pom.xml"></a>1.1. pom.xml</h4><p>SpringBoot整合Redis，需要引入spring-boot-starter-data-redis依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>当我们需要配置redis的连接池时，还需要引入commons-pool2依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-pool2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>application.yml配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br>    <span class="hljs-attr">database:</span> <span class="hljs-number">0</span><br>    <span class="hljs-attr">jedis:</span><br>      <span class="hljs-attr">pool:</span><br>        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">8</span><br>        <span class="hljs-attr">max-active:</span> <span class="hljs-number">8</span><br>        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>这里的jedis指的是使用jedis客户端，这里也可以将jedis改为lettuce，表示使用lettuce客户端，客户端下面的pool表示的是连接池的相关配置。<br>上述的配置针对的是单机redis配置，如果使用的是集群，配置如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">cluster:</span><br>      <span class="hljs-attr">nodes:</span> <span class="hljs-number">10.255</span><span class="hljs-number">.144</span><span class="hljs-number">.115</span><span class="hljs-string">:7001,10.255.144.115:7002,10.255.144.115:7003,10.255.144.115:7004,10.255.144.115:7005,10.255.144.115:7006</span><br>      <span class="hljs-attr">max-redirects:</span> <span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><h3 id="2-RedisTemplate"><a href="#2-RedisTemplate" class="headerlink" title="2. RedisTemplate"></a>2. RedisTemplate</h3><p>上述的配置完毕后，我们就可以在项目中操作redis了，操作的时候，可以直接使用spring-boot-starter-data-redis为我们提供的RedisTemplate这个类，也可以使用StringRedisTemplate，两者的方法基本一致，后者可以看作RedisTemplate&lt;String, String&gt; 。<br>在上一节中，提到，Redis有多种数据类型，比如string、list、hash、set、zset等，这些类型的操作在RedisTemplate分别对应opsForValue(), opsForList(), opsForHash(), opsForSet(), opsForZSet()。<br>具体的操作演示如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisAppTest</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGet</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;字符串操作=================&quot;</span>);<br>        redisTemplate.opsForValue().set(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;cxy&quot;</span>);<br>        System.out.println(redisTemplate.opsForValue().get(<span class="hljs-string">&quot;name&quot;</span>));<br><br>        System.out.println(<span class="hljs-string">&quot;列表操作&quot;</span>);<br>        redisTemplate.opsForList().leftPush(<span class="hljs-string">&quot;school&quot;</span>, <span class="hljs-string">&quot;华南理工大学&quot;</span>);<br>        redisTemplate.opsForList().leftPush(<span class="hljs-string">&quot;school&quot;</span>, <span class="hljs-string">&quot;中山大学&quot;</span>);<br>        redisTemplate.opsForList().leftPush(<span class="hljs-string">&quot;school&quot;</span>, <span class="hljs-string">&quot;华南农业大学&quot;</span>);<br>        List&lt;String&gt; school = redisTemplate.opsForList().range(<span class="hljs-string">&quot;school&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>);<br>        <span class="hljs-keyword">for</span> (String s : school) &#123;<br>            System.out.print(s + <span class="hljs-string">&quot; &quot;</span>);<br>        &#125;<br>        System.out.println();<br><br>        System.out.println(<span class="hljs-string">&quot;hash操作&quot;</span>);<br>        redisTemplate.opsForHash().put(<span class="hljs-string">&quot;student&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;cxy&quot;</span>);<br>        redisTemplate.opsForHash().put(<span class="hljs-string">&quot;student&quot;</span>, <span class="hljs-string">&quot;age&quot;</span>, <span class="hljs-string">&quot;21&quot;</span>);<br>        redisTemplate.opsForHash().put(<span class="hljs-string">&quot;student&quot;</span>, <span class="hljs-string">&quot;sex&quot;</span>, <span class="hljs-string">&quot;male&quot;</span>);<br>        System.out.println(redisTemplate.opsForHash().get(<span class="hljs-string">&quot;student&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>));<br>        System.out.println(redisTemplate.opsForHash().get(<span class="hljs-string">&quot;student&quot;</span>, <span class="hljs-string">&quot;age&quot;</span>));<br>        System.out.println(redisTemplate.opsForHash().get(<span class="hljs-string">&quot;student&quot;</span>, <span class="hljs-string">&quot;sex&quot;</span>));<br><br>        System.out.println(<span class="hljs-string">&quot;set操作&quot;</span>);<br>        redisTemplate.opsForSet().add(<span class="hljs-string">&quot;project&quot;</span>, <span class="hljs-string">&quot;软件工程&quot;</span>, <span class="hljs-string">&quot;计算机技术&quot;</span>, <span class="hljs-string">&quot;通信工程&quot;</span>, <span class="hljs-string">&quot;软件工程&quot;</span>);<br>        Set&lt;String&gt; project = redisTemplate.opsForSet().members(<span class="hljs-string">&quot;project&quot;</span>);<br>        <span class="hljs-keyword">for</span> (String s : project) &#123;<br>            System.out.print(s + <span class="hljs-string">&quot; &quot;</span>);<br>        &#125;<br>        System.out.println();<br><br>        System.out.println(<span class="hljs-string">&quot;zset操作&quot;</span>);<br>        redisTemplate.opsForZSet().add(<span class="hljs-string">&quot;movie&quot;</span>, <span class="hljs-string">&quot;热辣滚烫&quot;</span>, <span class="hljs-number">2.7d</span>);<br>        redisTemplate.opsForZSet().add(<span class="hljs-string">&quot;movie&quot;</span>, <span class="hljs-string">&quot;飞驰人生&quot;</span>, <span class="hljs-number">9.1d</span>);<br>        redisTemplate.opsForZSet().add(<span class="hljs-string">&quot;movie&quot;</span>, <span class="hljs-string">&quot;熊出没之逆转时空&quot;</span>, <span class="hljs-number">9.3d</span>);<br>        redisTemplate.opsForZSet().add(<span class="hljs-string">&quot;movie&quot;</span>, <span class="hljs-string">&quot;二十一条&quot;</span>, <span class="hljs-number">8.2d</span>);<br>        Set&lt;String&gt; movie = redisTemplate.opsForZSet().rangeByScore(<span class="hljs-string">&quot;movie&quot;</span>, <span class="hljs-number">3.0d</span>, <span class="hljs-number">9.3d</span>);<br>        <span class="hljs-keyword">for</span> (String s : movie) &#123;<br>            System.out.print(s + <span class="hljs-string">&quot; &quot;</span>);<br>        &#125;<br>        System.out.println();<br><br>        System.out.println(<span class="hljs-string">&quot;基数操作&quot;</span>);<br>        redisTemplate.opsForHyperLogLog().add(<span class="hljs-string">&quot;accessIp&quot;</span>, <span class="hljs-string">&quot;127.0.0.1&quot;</span>);<br>        redisTemplate.opsForHyperLogLog().add(<span class="hljs-string">&quot;accessIp&quot;</span>, <span class="hljs-string">&quot;192.168.10.1&quot;</span>);<br>        redisTemplate.opsForHyperLogLog().add(<span class="hljs-string">&quot;accessIp&quot;</span>, <span class="hljs-string">&quot;192.168.0.1&quot;</span>);<br>        redisTemplate.opsForHyperLogLog().add(<span class="hljs-string">&quot;accessIp&quot;</span>, <span class="hljs-string">&quot;33.45.23.1&quot;</span>);<br>        System.out.println(redisTemplate.opsForHyperLogLog().size(<span class="hljs-string">&quot;accessIp&quot;</span>));<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>运行结果如下：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A02%E2%80%94SpringBoot%E6%95%B4%E5%90%88Redis%E3%80%81Redis%E5%B7%A5%E5%85%B7%E7%B1%BB/1.png" class=""><h3 id="3-RedisUtils工具类"><a href="#3-RedisUtils工具类" class="headerlink" title="3. RedisUtils工具类"></a>3. RedisUtils工具类</h3><p>虽然RedisTemplate提供的redis操作很全面，但对于不了解redis的开发同学来说，直接看RedisTemplate的方法不够见名知义，因此一般情况下，我们都会单独封装一个工具类，将常用的一些方法进行抽象，以方便后续使用。<br>创建Redis配置类，配置RedisTemplate</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfiguration</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;<br>        RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();<br>        redisTemplate.setConnectionFactory(redisConnectionFactory);<br>        <span class="hljs-keyword">return</span> redisTemplate;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>工具类代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.util;<br><br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.ZSetOperations;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.util.*;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisUtils</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">removeKey</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-keyword">return</span> redisTemplate.delete(key);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasKey</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> redisTemplate.hasKey(key);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">expire</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> time)</span> &#123;<br>        <span class="hljs-keyword">return</span> expire(key, time, TimeUnit.SECONDS);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">expire</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> time, TimeUnit timeUnit)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> redisTemplate.expire(key, time, timeUnit);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addKey</span><span class="hljs-params">(String key, Object value, <span class="hljs-type">long</span> time)</span> &#123;<br>        addKey(key, value, time, TimeUnit.SECONDS);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addKey</span><span class="hljs-params">(String key, Object value, <span class="hljs-type">long</span> time, TimeUnit timeUnit)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        redisTemplate.opsForValue().set(key, value, time, timeUnit);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addKey</span><span class="hljs-params">(String key, Object value)</span> &#123;<br>        redisTemplate.opsForValue().set(key, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getKey</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> redisTemplate.opsForValue().get(key);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">(String key)</span> &#123;<br>        increment(key, <span class="hljs-number">1L</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> delta)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        redisTemplate.opsForValue().increment(key, delta);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decrement</span><span class="hljs-params">(String key)</span> &#123;<br>        decrement(key, <span class="hljs-number">1L</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decrement</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> delta)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        redisTemplate.opsForValue().decrement(key, delta);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">leftPush</span><span class="hljs-params">(String key, List&lt;Object&gt; values)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        redisTemplate.opsForList().leftPushAll(key, values);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">leftPush</span><span class="hljs-params">(String key, Object... value)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        redisTemplate.opsForList().leftPushAll(key, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">leftPop</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> redisTemplate.opsForList().leftPop(key);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;Object&gt; <span class="hljs-title function_">range</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> start, <span class="hljs-type">long</span> end)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        &#125;<br>        <span class="hljs-keyword">return</span> redisTemplate.opsForList().range(key, start, end);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">indexOfList</span><span class="hljs-params">(String key, <span class="hljs-type">int</span> index)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> redisTemplate.opsForList().index(key, index);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addHash</span><span class="hljs-params">(String key, Map&lt;String, Object&gt; map)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (map == <span class="hljs-literal">null</span> || map.isEmpty()) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        map.forEach((field, value) -&gt; &#123;<br>            redisTemplate.opsForHash().put(key, field, value);<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addField</span><span class="hljs-params">(String key, String field, Object value)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key) || StringUtils.isEmpty(field)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        redisTemplate.opsForHash().put(key, field, value);<br>    &#125;<br><br>     <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeField</span><span class="hljs-params">(String key, String field)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key) || StringUtils.isEmpty(field)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        redisTemplate.opsForHash().delete(key, field);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getEntries</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        &#125;<br>        Map&lt;Object, Object&gt; entries = redisTemplate.opsForHash().entries(key);<br>        Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        entries.forEach((k, v) -&gt; &#123;<br>            result.put(k.toString(), v);<br>        &#125;);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getField</span><span class="hljs-params">(String key, String field)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key) || StringUtils.isEmpty(field)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> redisTemplate.opsForHash().get(key, field);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">hasField</span><span class="hljs-params">(String key, String field)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key) || StringUtils.isEmpty(field)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> redisTemplate.opsForHash().hasKey(key, field);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addSet</span><span class="hljs-params">(String key, String... value)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        redisTemplate.opsForSet().add(key, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Set&lt;Object&gt; <span class="hljs-title function_">members</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>        &#125;<br>        <span class="hljs-keyword">return</span> redisTemplate.opsForSet().members(key);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">isMember</span><span class="hljs-params">(String key, Object value)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> redisTemplate.opsForSet().isMember(key, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addZSet</span><span class="hljs-params">(String key, Object value, Double score)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        redisTemplate.opsForZSet().add(key, value, score);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Set&lt;Object&gt; <span class="hljs-title function_">rangeByScore</span><span class="hljs-params">(String key, Double min, Double max)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>        &#125;<br>        <span class="hljs-keyword">return</span> redisTemplate.opsForZSet().rangeByScore(key, min, max);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Set&lt;ZSetOperations.TypedTuple&lt;Object&gt;&gt; rangeByScoreWithScore(String key, Double min, Double max) &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>        &#125;<br>       <span class="hljs-keyword">return</span> redisTemplate.opsForZSet().rangeByScoreWithScores(key, min, max);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addHyperLogLog</span><span class="hljs-params">(String key, Object... value)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        redisTemplate.opsForHyperLogLog().add(key, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addHyperLogLog</span><span class="hljs-params">(String key, List value)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        redisTemplate.opsForHyperLogLog().add(key, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">countHyperLogLog</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0L</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> redisTemplate.opsForHyperLogLog().size(key);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>修改之前的测试代码，将redisTemplate，改为我们的工具类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisUtils redisUtils;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testRedisUtils</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;字符串操作=================&quot;</span>);<br>       redisUtils.addKey(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;cxy&quot;</span>);<br>        System.out.println(redisUtils.getKey(<span class="hljs-string">&quot;name&quot;</span>));<br><br>        System.out.println(<span class="hljs-string">&quot;列表操作&quot;</span>);<br>        redisUtils.leftPush(<span class="hljs-string">&quot;school&quot;</span>, <span class="hljs-string">&quot;华南理工大学&quot;</span>);<br>        redisUtils.leftPush(<span class="hljs-string">&quot;school&quot;</span>, <span class="hljs-string">&quot;中山大学&quot;</span>);<br>        redisUtils.leftPush(<span class="hljs-string">&quot;school&quot;</span>, <span class="hljs-string">&quot;华南农业大学&quot;</span>);<br>        List&lt;Object&gt; school = redisUtils.range(<span class="hljs-string">&quot;school&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>);<br>        <span class="hljs-keyword">for</span> (Object s : school) &#123;<br>            System.out.print(s + <span class="hljs-string">&quot; &quot;</span>);<br>        &#125;<br>        System.out.println();<br><br>        System.out.println(<span class="hljs-string">&quot;hash操作&quot;</span>);<br>        redisUtils.addField(<span class="hljs-string">&quot;student&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;cxy&quot;</span>);<br>        redisUtils.addField(<span class="hljs-string">&quot;student&quot;</span>, <span class="hljs-string">&quot;age&quot;</span>, <span class="hljs-string">&quot;21&quot;</span>);<br>        redisUtils.addField(<span class="hljs-string">&quot;student&quot;</span>, <span class="hljs-string">&quot;sex&quot;</span>, <span class="hljs-string">&quot;male&quot;</span>);<br>        System.out.println(redisUtils.getField(<span class="hljs-string">&quot;student&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>));<br>        System.out.println(redisUtils.getField(<span class="hljs-string">&quot;student&quot;</span>, <span class="hljs-string">&quot;age&quot;</span>));<br>        System.out.println(redisUtils.getField(<span class="hljs-string">&quot;student&quot;</span>, <span class="hljs-string">&quot;sex&quot;</span>));<br><br>        System.out.println(<span class="hljs-string">&quot;set操作&quot;</span>);<br>        redisUtils.addSet(<span class="hljs-string">&quot;project&quot;</span>, <span class="hljs-string">&quot;软件工程&quot;</span>, <span class="hljs-string">&quot;计算机技术&quot;</span>, <span class="hljs-string">&quot;通信工程&quot;</span>, <span class="hljs-string">&quot;软件工程&quot;</span>);<br>        Set&lt;Object&gt; project = redisUtils.members(<span class="hljs-string">&quot;project&quot;</span>);<br>        <span class="hljs-keyword">for</span> (Object s : project) &#123;<br>            System.out.print(s + <span class="hljs-string">&quot; &quot;</span>);<br>        &#125;<br>        System.out.println();<br><br>        System.out.println(<span class="hljs-string">&quot;zset操作&quot;</span>);<br>        redisUtils.addZSet(<span class="hljs-string">&quot;movie&quot;</span>, <span class="hljs-string">&quot;热辣滚烫&quot;</span>, <span class="hljs-number">2.7d</span>);<br>        redisUtils.addZSet(<span class="hljs-string">&quot;movie&quot;</span>, <span class="hljs-string">&quot;飞驰人生&quot;</span>, <span class="hljs-number">9.1d</span>);<br>        redisUtils.addZSet(<span class="hljs-string">&quot;movie&quot;</span>, <span class="hljs-string">&quot;熊出没之逆转时空&quot;</span>, <span class="hljs-number">9.3d</span>);<br>        redisUtils.addZSet(<span class="hljs-string">&quot;movie&quot;</span>, <span class="hljs-string">&quot;二十一条&quot;</span>, <span class="hljs-number">8.2d</span>);<br>        Set&lt;Object&gt; movie = redisUtils.rangeByScore(<span class="hljs-string">&quot;movie&quot;</span>, <span class="hljs-number">3.0d</span>, <span class="hljs-number">9.3d</span>);<br>        <span class="hljs-keyword">for</span> (Object s : movie) &#123;<br>            System.out.print(s + <span class="hljs-string">&quot; &quot;</span>);<br>        &#125;<br>        System.out.println();<br><br>        System.out.println(<span class="hljs-string">&quot;基数操作&quot;</span>);<br>        redisUtils.addHyperLogLog(<span class="hljs-string">&quot;accessIp&quot;</span>, <span class="hljs-string">&quot;127.0.0.1&quot;</span>);<br>        redisUtils.addHyperLogLog(<span class="hljs-string">&quot;accessIp&quot;</span>, <span class="hljs-string">&quot;192.168.10.1&quot;</span>);<br>        redisUtils.addHyperLogLog(<span class="hljs-string">&quot;accessIp&quot;</span>, <span class="hljs-string">&quot;192.168.0.1&quot;</span>);<br>        redisUtils.addHyperLogLog(<span class="hljs-string">&quot;accessIp&quot;</span>, <span class="hljs-string">&quot;33.45.23.1&quot;</span>);<br>        System.out.println(redisUtils.countHyperLogLog(<span class="hljs-string">&quot;accessIp&quot;</span>));<br>    &#125;<br></code></pre></td></tr></table></figure><p>在测试之前，先删除之前添加的数据</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A02%E2%80%94SpringBoot%E6%95%B4%E5%90%88Redis%E3%80%81Redis%E5%B7%A5%E5%85%B7%E7%B1%BB/2.png" class=""><p>测试结果如下：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A02%E2%80%94SpringBoot%E6%95%B4%E5%90%88Redis%E3%80%81Redis%E5%B7%A5%E5%85%B7%E7%B1%BB/3.png" class="">]]></content>
    
    
    
    <tags>
      
      <tag>中间件</tag>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redis学习1-Redis简介、基础</title>
    <link href="/2024/04/02/Redis%E5%AD%A6%E4%B9%A01-Redis%E7%AE%80%E4%BB%8B%E3%80%81%E5%9F%BA%E7%A1%80/"/>
    <url>/2024/04/02/Redis%E5%AD%A6%E4%B9%A01-Redis%E7%AE%80%E4%BB%8B%E3%80%81%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h3 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a>1. 介绍</h3><h4 id="1-1-redis简介"><a href="#1-1-redis简介" class="headerlink" title="1.1. redis简介"></a>1.1. redis简介</h4><p>Redis(Remote Dictonary Server) 是由Salvatore Sanfilippo开发的key-value缓存数据库，基于C语言开发。目前市面上，Redis和MongoDB是当前使用最广泛的NoSQL，而就Redis技术而言，它的性能十分优越，可以支持每秒十几万此的读&#x2F;写操作，其性能远超数据库，并且还支持集群、分布式、主从同步等配置，原则上可以无限扩展，让更多的数据存储在内存中，更让人欣慰的是它还支持一定的事务能力，这保证了高并发的场景下数据的安全和一致性。</p><h4 id="1-2-redis特点"><a href="#1-2-redis特点" class="headerlink" title="1.2. redis特点"></a>1.2. redis特点</h4><p>与其他key&#x2F;value缓存产品相比，redis有以下特点：<br>1、Redis支持数据的持久化，可以将内存中的数据保存在磁盘中，重启的时候可以再次加载进行使用；<br>2、 Redis不仅支持key-value类型的数据，还提供list，set，zset，hash等数据结构的存储；<br>3、 Redis支持数据的备份，即master-slave模式的数据备份；</p><h3 id="2-Redis安装"><a href="#2-Redis安装" class="headerlink" title="2. Redis安装"></a>2. Redis安装</h3><h4 id="2-1-window"><a href="#2-1-window" class="headerlink" title="2.1. window"></a>2.1. window</h4><p>Redis Windows 下载地址：<a href="https://github.com/MicrosoftArchive/redis/releases">https://github.com/MicrosoftArchive/redis/releases</a></p><h4 id="2-2-linux"><a href="#2-2-linux" class="headerlink" title="2.2. linux"></a>2.2. linux</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-variable">$</span> <span class="hljs-built_in">wget</span> http://download.redis.io/releases/redis<span class="hljs-literal">-4</span>.<span class="hljs-number">0.2</span>.tar.gz<br><span class="hljs-variable">$</span> tar xzf redis<span class="hljs-literal">-4</span>.<span class="hljs-number">0.2</span>.tar.gz<br><span class="hljs-variable">$</span> <span class="hljs-built_in">cd</span> redis<span class="hljs-literal">-4</span>.<span class="hljs-number">0.2</span><br><span class="hljs-variable">$</span> make<br></code></pre></td></tr></table></figure><p>执行上述命令后，进入redis目录下的src目录<br>启动redis服务</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs axapta">./redis-<span class="hljs-keyword">server</span><br></code></pre></td></tr></table></figure><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A01-Redis%E7%AE%80%E4%BB%8B%E3%80%81%E5%9F%BA%E7%A1%80/1.png" class=""><p>进入redis命令行</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">./redis-<span class="hljs-keyword">cli</span><br></code></pre></td></tr></table></figure><h4 id="2-3-配置项"><a href="#2-3-配置项" class="headerlink" title="2.3. 配置项"></a>2.3. 配置项</h4><p>进入redis.conf，可以修改一些配置项，主要的配置项如下：</p><table><thead><tr><th>port</th><th>端口号</th></tr></thead><tbody><tr><td>dir</td><td>本地数据库存放目录</td></tr><tr><td>dbfilename</td><td>本地数据库文件名</td></tr><tr><td>bind</td><td>绑定的主机地址</td></tr><tr><td>timeout</td><td>设置客户端闲置多长时间后关闭连接</td></tr><tr><td>loglevel</td><td>日志记录级别，有：debug，verbose，notice，warning，默认为verbose</td></tr><tr><td>logfile</td><td>日志记录方式，默认为标准输出</td></tr></tbody></table><h3 id="3-Redis数据类型"><a href="#3-Redis数据类型" class="headerlink" title="3. Redis数据类型"></a>3. Redis数据类型</h3><h4 id="3-1-String字符串"><a href="#3-1-String字符串" class="headerlink" title="3.1. String字符串"></a>3.1. String字符串</h4><p>最基本的数据类型，一个key对应一个value，redis的string可包含任何数据，比如jpg图片或者序列化的对象，一个键最大能存储512MB的对象<br>示例如下：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A01-Redis%E7%AE%80%E4%BB%8B%E3%80%81%E5%9F%BA%E7%A1%80/2.png" class=""><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>SET</td><td>设置指定 key 的值</td></tr><tr><td>GET</td><td>获取指定 key 的值</td></tr><tr><td>MSET</td><td>同时设置一个或多个 key-value 对</td></tr><tr><td>MGET</td><td>获取所有(一个或多个)给定 key 的值</td></tr><tr><td>INCR</td><td>将 key 中储存的数字值增一</td></tr><tr><td>INCRBY</td><td>将 key 所储存的值加上给定的增量值 ( increment )</td></tr><tr><td>DECR</td><td>将 key 中储存的数字值减一</td></tr><tr><td>DECRBY</td><td>将 key 所储存的值减去给定的减量值 ( decrement )</td></tr></tbody></table><h4 id="3-2-Hash哈希"><a href="#3-2-Hash哈希" class="headerlink" title="3.2. Hash哈希"></a>3.2. Hash哈希</h4><p>Redis Hash是一个string类型的field和value的映射表，特别适合用于存储对象。<br>常用的命令为HMSET KEY FIELD VALUE FIELD VALUE，即同时将多个field-value（域-值）对设置到哈希表key中。示例如下：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A01-Redis%E7%AE%80%E4%BB%8B%E3%80%81%E5%9F%BA%E7%A1%80/3.png" class=""><p>其中，user:1为键</p><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>HEXISTS</td><td>查看哈希表 key 中，指定的字段是否存在</td></tr><tr><td>HGET</td><td>获取存储在哈希表中指定字段的值</td></tr><tr><td>HSET</td><td>将哈希表 key 中的字段 field 的值设为 value</td></tr><tr><td>HMSET</td><td>同时将多个 field-value (域-值)对设置到哈希表 key 中</td></tr><tr><td>HMGET</td><td>获取所有给定字段的值</td></tr><tr><td>HDEL</td><td>删除一个或多个哈希表字段</td></tr></tbody></table><h4 id="3-3-List列表"><a href="#3-3-List列表" class="headerlink" title="3.3. List列表"></a>3.3. List列表</h4><p>Redis List为最简单的字符串列表，按照插入顺序排序，可以添加一个元素到列表的头部（左边）或尾部（右边）。<br>常用的命令有lpush，rpush，lrange，示例如下：</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A01-Redis%E7%AE%80%E4%BB%8B%E3%80%81%E5%9F%BA%E7%A1%80/4.png" class=""><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>LINDEX</td><td>通过索引获取列表中的元素</td></tr><tr><td>LINSERT</td><td>在列表的元素前或者后插入元素</td></tr><tr><td>LLEN</td><td>获取列表长度</td></tr><tr><td>LPOP</td><td>移出并获取列表的第一个元素</td></tr><tr><td>LPUSH</td><td>将一个或多个值插入到列表头部</td></tr><tr><td>RPOP</td><td>移除并获取列表最后一个元素</td></tr><tr><td>RPUSH</td><td>在列表中添加一个或多个值</td></tr><tr><td>LSET</td><td>通过索引设置列表元素的值</td></tr><tr><td>LRANGE</td><td>获取列表指定范围内的元素</td></tr></tbody></table><h4 id="3-4-set集合"><a href="#3-4-set集合" class="headerlink" title="3.4. set集合"></a>3.4. set集合</h4><p>Redis是string类型的无序集合，通过哈希表实现，元素具有唯一性。<br>常用命令有sadd，smembers</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A01-Redis%E7%AE%80%E4%BB%8B%E3%80%81%E5%9F%BA%E7%A1%80/5.png" class=""><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>SADD</td><td>向集合添加一个或多个成员</td></tr><tr><td>SCARD</td><td>获取集合的成员数</td></tr><tr><td>SDIFF</td><td>返回给定所有集合的差集</td></tr><tr><td>SINTER</td><td>返回给定所有集合的交集</td></tr><tr><td>SISMEMBER</td><td>判断 member 元素是否是集合 key 的成员</td></tr><tr><td>SMEMBERS</td><td>返回集合中的所有成员</td></tr><tr><td>SUNION</td><td>返回所有给定集合的并集</td></tr><tr><td>SREM</td><td>移除集合中一个或多个成员</td></tr></tbody></table><h4 id="3-5-zset（sorted-set）有序集合"><a href="#3-5-zset（sorted-set）有序集合" class="headerlink" title="3.5. zset（sorted set）有序集合"></a>3.5. zset（sorted set）有序集合</h4><p>和set一样是string类型元素的集合，不同的是每个元素会关联一个double类型的分数，通过分数为集合中的成员进行从小到大的排序，zset的成员是唯一的，但分数可以重复。<br>常用命令有：zadd，zrangeByscore</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A01-Redis%E7%AE%80%E4%BB%8B%E3%80%81%E5%9F%BA%E7%A1%80/6.png" class=""><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>ZADD</td><td>向有序集合添加一个或多个成员，或者更新已存在成员的分数</td></tr><tr><td>ZCARD</td><td>获取有序集合的成员数</td></tr><tr><td>ZCOUNT</td><td>计算在有序集合中指定区间分数的成员数</td></tr><tr><td>ZRANGE</td><td>通过索引区间返回有序集合成指定区间内的成员</td></tr><tr><td>ZRANGEBYSCORE</td><td>通过分数返回有序集合指定区间内的成员</td></tr><tr><td>ZRANK</td><td>返回有序集合中指定成员的索引</td></tr><tr><td>ZSCORE</td><td>返回有序集中，成员的分数值</td></tr></tbody></table><h4 id="3-6-Redis-Bitmap-位图"><a href="#3-6-Redis-Bitmap-位图" class="headerlink" title="3.6. Redis Bitmap 位图"></a>3.6. Redis Bitmap 位图</h4><p>通过类似map结构存放0或1（bit位）作为值，可以用来统计状态，如日活，是否浏览过某个东西</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A01-Redis%E7%AE%80%E4%BB%8B%E3%80%81%E5%9F%BA%E7%A1%80/7.png" class=""><h4 id="3-7-HyperLogLogs基数统计"><a href="#3-7-HyperLogLogs基数统计" class="headerlink" title="3.7. HyperLogLogs基数统计"></a>3.7. HyperLogLogs基数统计</h4><p>可以接受多个元素作为输入，并给出输入元素的基数估算值<br>● 基数：集合中不同元素的数量，比如 {’apple’, ‘banana’, ‘cherry’, ‘banana’, ‘apple’} 的基数就是 3<br>● 估算值：算法给出的基数并不是精确的，可能会比实际稍微多一些或者稍微少一些，但会控制在合 理的范围之内<br>HyperLogLog 的优点是即使输入元素的数量或体积非常大，计算基数所需空间总是固定的，并且是很小的。<br>在Redis 里面，每个 HyperLogLog 键只需要花费 12 KB 内存，就可以计算接近 2^64 个不同元素的基数<br>这和计算基数时，元素越多耗费内存就越多的集合形成鲜明对比<br>因为HyperLogLog 只会根据输入元素来计算基数，而不会储存输入元素本身，所以 HyperLogLog 不能像集合那样，返回输入的各个元素</p><img src="/2024/04/02/Redis%E5%AD%A6%E4%B9%A01-Redis%E7%AE%80%E4%BB%8B%E3%80%81%E5%9F%BA%E7%A1%80/8.png" class=""><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>PFADD</td><td>添加指定元素到 HyperLogLog 中</td></tr><tr><td>PFCOUNT</td><td>返回给定 HyperLogLog 的基数估算值</td></tr><tr><td>PFMERGE</td><td>将多个 HyperLogLog 合并为一个 HyperLogLog</td></tr></tbody></table>]]></content>
    
    
    
    <tags>
      
      <tag>中间件</tag>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Nacos学习2—Nacos配置中心</title>
    <link href="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/"/>
    <url>/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/</url>
    
    <content type="html"><![CDATA[<p>在上一节中，介绍了Nacos配置中心的入门使用，在这一节，会讲解关于nacos配置中心的其他概念，比如命名空间、共享配置、以及如何在服务端更新nacos配置。</p><h3 id="1-nacos的基础概念"><a href="#1-nacos的基础概念" class="headerlink" title="1. nacos的基础概念"></a>1. nacos的基础概念</h3><p>如下图所示，在nacos配置中，namespace、group、dataId为最基础的、最重要的三个概念。<br>namespace: 命名空间可用于进行不同环境的配置隔离。一般一个环境划分到一个命名空间<br>group： 配置分组用于将不同的服务可以归类到同一分组。一般将一个项目的配置分到一组<br>dataId： 在系统中，一个配置文件通常就是一个配置集（dataId）。一般微服务的配置就是一个配置集</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image.png" class=""><p>当我们没有配置namespace时，其默认值就是public；没有配置group时，默认值为DEFAULT_GROUP，dataId默认是当前应用的application.name。<br>进入nacos，点击命名空间，选择新建命名空间</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image1.png" class=""><p>假设我们现在是在开发环境，然后我们创建一个dev命名空间，用于开发环境的相关配置,这里的命名空间id不用填，系统会自动生成</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image2.png" class=""><p>创建成功后，我们复制命名空间id</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image3.png" class=""><p>将这个命名空间id，粘贴到之前bootstrap.yml配置文件的namespace中</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image4.png" class=""><p>然后我们进入dev命名空间，新建一个配置</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image5.png" class=""><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image6.png" class=""><p>配置完毕后，启动项目，再次访问<a href="http://localhost:8080/test/hello%EF%BC%8C%E7%BB%93%E6%9E%9C%E5%A6%82%E4%B8%8B%EF%BC%9A">http://localhost:8080/test/hello，结果如下：</a></p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image7.png" class=""><p>可见，此时读取到的，是dev命名空间下的配置。</p><h3 id="2-共享配置"><a href="#2-共享配置" class="headerlink" title="2. 共享配置"></a>2. 共享配置</h3><p>当我们项目中的服务数量增加后，配置文件也会相应的增加，而多个配置文件中，可能存在相同的配置，因此我们可以将这些相同的配置独立出来，作为该项目各个服务的共享配置文件。<br>假设我们现在有两个服务，这两个服务都共享同一个redis数据源和同一个mysql数据源，因此我们可以把这两个数据源的配置，提取成共享配置。<br>service1和service2的bootstrap.yml配置分别如下：</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image8.png" class=""><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image9.png" class=""><p>这两个服务的bootstrap配置文件内容，基本一样（除了端口号和服务名），除此之外，这里共享配置中，common-redis共享配置的refresh值设置为true，而common-mysql没有设置，也就是说，这两个服务能监听到common-redis配置的变化，而不会关注到common-mysql配置的变化。<br>配置完成后，这两个应用，我们都添加下面这个controller类，用于进行测试：</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image10.png" class=""><p>然后，我们在nacos上添加相关的共享配置</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image11.png" class=""><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image12.png" class=""><p>启动服务1和服务2，然后分别访问获取mysql配置和redis配置的接口</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image13.png" class=""><p>然后我们在分别修改mysql和redis的配置</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image14.png" class=""><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image15.png" class=""><p>然后再次访问相关的接口，结果如下：</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image16.png" class=""><p>由上图可知，如果公共配置想要获取实时数据，需要加上refresh属性的配置。</p><h3 id="3-扩展配置"><a href="#3-扩展配置" class="headerlink" title="3. 扩展配置"></a>3. 扩展配置</h3><p>一般情况下，我们的配置文件一个就可以了，但有时候，如果我们的配置分散在多个配置文件时，就需要使用到扩展配置了。<br>假设我们现在有两个扩展配置，一个是配置日志打印的，一个是配置消息队列，假设配置内容如下：<br>ext-log.yaml</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image17.png" class=""><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image18.png" class=""><p>bootstrap.yml内容如下：</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image19.png" class=""><p>添加一个controller用于测试</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image20.png" class=""><p>启动应用，结果如下：</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image21.png" class=""><p>然后我们修改扩展配置</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image22.png" class=""><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image23.png" class=""><p>再次访问相关的接口</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image24.png" class=""><p>可见，对于扩展配置，如果要获取实时数据，那么也需要加上refresh</p><h3 id="4-更新数据到nacos"><a href="#4-更新数据到nacos" class="headerlink" title="4. 更新数据到nacos"></a>4. 更新数据到nacos</h3><p>假设我们现在有一个数据迁移的任务，每隔一段时间，会触发这个任务一次，该任务会读取nacos配置中的起始时间和结束时间，然后查询数据库并将查询的数据进行迁移，最后会更新起始时间，然后修改nacos中的配置。<br>首先我们在nacos上添加一个和数据迁移相关的配置：</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image25.png" class=""><p>添加一个config，用于构造configService</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image26.png" class=""><p>添加一个定时任务，用于查询nacos配置，并根据nacos配置迁移数据</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image27.png" class=""><p>执行结果如下图所示，每隔十秒执行一次任务，并且将起始时间进行更新。</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A02%E2%80%94Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image28.png" class=""><h3 id="5-参考文档"><a href="#5-参考文档" class="headerlink" title="5. 参考文档"></a>5. 参考文档</h3><p>（超详细）关于Nacos的共享配置( shared-configs)和拓展配置(extension-config)：<a href="https://blog.csdn.net/weixin_42329623/article/details/131018680">https://blog.csdn.net/weixin_42329623/article/details/131018680</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>中间件</tag>
      
      <tag>Nacos</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Nacos学习1—介绍、配置中心</title>
    <link href="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/"/>
    <url>/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/</url>
    
    <content type="html"><![CDATA[<h3 id="1-背景"><a href="#1-背景" class="headerlink" title="1. 背景"></a>1. 背景</h3><p>在之前的Spring Cloud Gateway学习中，我们了解了网关相关配置，包括断言、过滤器等内容。在之前的文章中，我们是将这些配置，写到application.yml上，而一般情况下，我们Spring Cloud Gateway的网关配置，肯定不会是一成不变的，如果配置信息是在application.yml上，那么当我们需要添加其他的路由配置时，就先修改application.yml配置，然后重启服务，这不利于用户使用和产品的稳定。我们希望通过一个配置中心，来方便我们对这些路由信息进行统一的维护、管理。</p><h4 id="1-1-配置中心思路"><a href="#1-1-配置中心思路" class="headerlink" title="1.1. 配置中心思路"></a>1.1. 配置中心思路</h4><p>配置中心的一般思路为：<br>1） 首先把项目中的各种配置全部放到一个集中的地方进行统一管理，并提供一套标准接口。<br>2）当各个服务需要获取配置的时候，就来配置中心的接口拉取自己的配置。<br>3）当配置中心中的各种参数有更新的时候，也能通知到各个服务实时同步最新的消息，使之动态更新。<br>当加入服务配置中心后，我们的系统架构图如下：</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image.png" class=""><h4 id="1-2-常用的服务配置中心"><a href="#1-2-常用的服务配置中心" class="headerlink" title="1.2. 常用的服务配置中心"></a>1.2. 常用的服务配置中心</h4><p>Spring Cloud Config:官方提供的分布式系统的外部配置中心。<br>Nacos:阿里开源的框架，致力于发现、配置和管理微服务。Nacos提供了一组简单易用的特性集，帮助您快速实现动态服务发现、服务配置、服务元数据及流量管理。<br>Apollo：携程框架部门研发的开源配置管理中心，能够集中化管理应用不同环境、不同集群的配置，配置修改后能够实时推送到应用端，并且具备规范的权限、流程治理等特性。</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image1.png" class=""><h3 id="2-Nacos介绍和环境搭建"><a href="#2-Nacos介绍和环境搭建" class="headerlink" title="2. Nacos介绍和环境搭建"></a>2. Nacos介绍和环境搭建</h3><h4 id="2-1-Nacos介绍"><a href="#2-1-Nacos介绍" class="headerlink" title="2.1. Nacos介绍"></a>2.1. Nacos介绍</h4><p>Nacos是阿里巴巴推出的一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。<br>Nacos的关键特性有以下几点：<br>1）服务发现和服务健康检测<br>Nacos 提供对服务的实时的健康检查，阻止向不健康的主机或服务实例发送请求。Nacos 支持传输层 (PING 或 TCP)和应用层 (如 HTTP、MySQL、用户自定义）的健康检查。 对于复杂的云环境和网络拓扑环境中（如 VPC、边缘网络等）服务的健康检查，Nacos 提供了 agent 上报模式和服务端主动检测2种健康检查模式。<br>2）动态配置服务<br>动态配置服务可以让您以中心化、外部化和动态化的方式管理所有环境的应用配置和服务配置。<br>动态配置消除了配置变更时重新部署应用和服务的需要，让配置管理变得更加高效和敏捷。<br>配置中心化管理让实现无状态服务变得更简单，让服务按需弹性扩展变得更容易。<br>3）动态DNS服务<br>动态 DNS 服务支持权重路由，从而更方便地实现中间层负载均衡、更灵活的路由策略、流量控制以及数据中心内网的简单DNS解析服务。<br>4）服务及其元数据管理<br>Nacos 能让您从微服务平台建设的视角管理数据中心的所有服务及元数据，包括管理服务的描述、生命周期、服务的静态依赖分析、服务的健康状态、服务的流量管理、路由及安全策略、服务的 SLA 以及最首要的 metrics 统计数据。</p><h4 id="2-2-Nacos环境搭建"><a href="#2-2-Nacos环境搭建" class="headerlink" title="2.2. Nacos环境搭建"></a>2.2. Nacos环境搭建</h4><p>进入Nacos官网：<a href="https://nacos.io/">https://nacos.io</a></p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image2.png" class=""><p>点击前往github，跳转至github下载页面，然后点击tags选择要下载的版本</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image3.png" class=""><p>下载完毕后解压到需要安装的目录</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image5.png" class=""><p>解压完毕后，进入bin目录，修改启动文件startup.cmd，将mode由”cluster”改为standalone</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image6.png" class=""><p>修改完毕后，双击startup.cmd启动Nacos服务</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image7.png" class=""><p>访问<a href="http://localhost:8848/nacos%EF%BC%8C%E9%BB%98%E8%AE%A4%E7%9A%84%E7%94%A8%E6%88%B7%E5%90%8D%E5%92%8C%E5%AF%86%E7%A0%81%E4%B8%BA%22nacos%22%E3%80%82">http://localhost:8848/nacos，默认的用户名和密码为&quot;nacos&quot;。</a></p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image8.png" class=""><h3 id="3-Nacos-Config配置中心"><a href="#3-Nacos-Config配置中心" class="headerlink" title="3. Nacos Config配置中心"></a>3. Nacos Config配置中心</h3><h4 id="3-1-基本使用"><a href="#3-1-基本使用" class="headerlink" title="3.1. 基本使用"></a>3.1. 基本使用</h4><p>添加Nacos config的依赖</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image9.png" class=""><p>注意，如果是在springboot2.4.x的版本之后，对于bootstrap.properties和bootstrap.yaml配置文件，需要在pom中加入依赖：</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image10.png" class=""><p>然后添加配置文件，注意，不能使用application.yml，要新建一个bootstrap.yml作为配置文件<br>配置文件有优先级为：<br>bootstrap.properties  &gt; bootstrap.yml &gt; application.properties &gt; application.yml<br>假设我们当前的配置如下：</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image11.png" class=""><p>然后我们添加一个controller用于测试，下面这个controller的hello方法，会返回helloWorld的值，这里我先设置了一个默认值为“defalut value”</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image12.png" class=""><p>当我们的hello.world在nacos上没有进行配置时，那么我们访问<a href="http://localhost/test/hello%EF%BC%8C%E7%BB%93%E6%9E%9C%E5%A6%82%E4%B8%8B%E5%9B%BE%E6%89%80%E7%A4%BA%EF%BC%9A">http://localhost:80/test/hello，结果如下图所示：</a></p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image13.png" class=""><p>现在我进入nacos官网，新建对应的配置，如下图所示，点击左边的创建配置</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image14.png" class=""><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image15.png" class=""><p>然后填写dataId,group,配置类型和配置的内容，注意，这里的data id要和我们的bootstrap.yml中配置的spring.cloud.nacos.config.name保持一致(如果不配置也可以，不配置的话，默认使用application.name的名称对应的配置）</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image16.png" class=""><p>配置完毕后点击发布</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image17.png" class=""><p>发布完成后，我们再次访问<a href="http://localhost/test/hello">http://localhost:80/test/hello</a></p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image18.png" class=""><h4 id="3-2-dataId"><a href="#3-2-dataId" class="headerlink" title="3.2. dataId"></a>3.2. dataId</h4><p>之所以配置spring.application.name或spring.cloud.nacos.config.name，是因为它是构成Nacos配置管理dataId字段的一部分。在Nacos 中，dataId完整格式如下：<br>${prefix}-${spring.profiles.active}.${file-extension}<br>prefix: 默认为spring.application.name的值，也可以通过配置项spring.cloud.nacos.config.name来配置<br>spring.profiles.active:当前环境对应的profile，当spring.profiles.active为空时，对应的连接符-也不存在<br>file-extension：配置内容的数据格式，可以通过spring.cloud.nacos.config.file-extension来配置，目前只支持properties和yaml类型<br>我们修改刚才的bootstrap.yaml配置文件，修改结果如下：</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image19.png" class=""><p>然后在nacos添加一个配置</p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image20.png" class=""><p>然后重启应用，访问<a href="http://localhost:8080/test/hello%EF%BC%8C%E7%BB%93%E6%9E%9C%E5%A6%82%E4%B8%8B%EF%BC%9A">http://localhost:8080/test/hello，结果如下：</a></p><img src="/2024/04/02/Nacos%E5%AD%A6%E4%B9%A01%E2%80%94%E4%BB%8B%E7%BB%8D%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/image21.png" class=""><h4 id="4-参考文章"><a href="#4-参考文章" class="headerlink" title="4. 参考文章"></a>4. 参考文章</h4><p>使用nacos作为配置中心：<a href="https://blog.csdn.net/weixin_65211978/article/details/128102799">https://blog.csdn.net/weixin_65211978/article/details/128102799</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>中间件</tag>
      
      <tag>Nacos</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringGateway学习2</title>
    <link href="/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A02/"/>
    <url>/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A02/</url>
    
    <content type="html"><![CDATA[<h3 id="1-断言"><a href="#1-断言" class="headerlink" title="1. 断言"></a>1. 断言</h3><p>在上一节中，我们的gateway应用，它的配置文件为：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">app-service1</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:9000</span><br>          <span class="hljs-attr">predicates:</span> <span class="hljs-comment">#断言，为真则匹配成功</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/app1/**</span> <span class="hljs-comment">#配置规则Path，如果是app1开头的请求，会转发到目标URL</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">app-service2</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:9001</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/app2/**</span><br></code></pre></td></tr></table></figure><p>这里面使用了Path断言，Path断言会根据请求的路径进行匹配，除了Path断言外，常用的断言如下图所示：</p><img src="/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A02/image.png" class=""><p>这里再简单介绍几个常用的断言：</p><h4 id="1-1-After"><a href="#1-1-After" class="headerlink" title="1.1. After"></a>1.1. After</h4><p>After用于匹配在指定日期时间之后发生的请求，也就是说，只有在指定日期之后的请求，才能被转发，假设我们的配置如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">app-service1</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:9000</span><br>          <span class="hljs-attr">predicates:</span> <span class="hljs-comment">#断言，为真则匹配成功</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">After=2025-01-20T09:08:01.000+08:00[Asia/Shanghai]</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/app1/**</span> <span class="hljs-comment">#配置规则Path，如果是app1开头的请求，会转发到目标URL</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">app-service2</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:9001</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/app2/**</span><br></code></pre></td></tr></table></figure><p>在1月20号9点8分之前：</p><img src="/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A02/image1.png" class=""><p>在1月20号9点8分之后：</p><img src="/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A02/image2.png" class=""><h4 id="1-2-Before"><a href="#1-2-Before" class="headerlink" title="1.2. Before"></a>1.2. Before</h4><p>Before用于匹配在指定日期之前的请求，也就是说，只有在指定日期之前，该请求才会被匹配并转发<br>假设我们的配置如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">app-service1</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:9000</span><br>          <span class="hljs-attr">predicates:</span> <span class="hljs-comment">#断言，为真则匹配成功</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">After=2024-01-20T09:08:01.000+08:00[Asia/Shanghai]</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/app1/**</span> <span class="hljs-comment">#配置规则Path，如果是app1开头的请求，会转发到目标URL</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">app-service2</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:9001</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Before=2024-01-20T09:17:01.000+08:00[Asia/Shanghai]</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/app2/**</span><br></code></pre></td></tr></table></figure><p>在1月20号9点17分之前：</p><img src="/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A02/image3.png" class=""><p>在1月20号9点17分之后：</p><img src="/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A02/image4.png" class=""><h3 id="2-网关过滤器"><a href="#2-网关过滤器" class="headerlink" title="2. 网关过滤器"></a>2. 网关过滤器</h3><h4 id="2-1-Gateway-Filter"><a href="#2-1-Gateway-Filter" class="headerlink" title="2.1. Gateway Filter"></a>2.1. Gateway Filter</h4><p>SpringCloud Gateway的Filter分为两种类型：Gateway Filter和Global Filter，过滤器会对请求和响应进行处理，比如添加参数，URL重写等，常用的网关过滤器如下：</p><img src="/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A02/image5.png" class=""><h5 id="2-1-1-AddRequestHeader"><a href="#2-1-1-AddRequestHeader" class="headerlink" title="2.1.1. AddRequestHeader"></a>2.1.1. AddRequestHeader</h5><p>AddRequestHeader需要name和value参数<br>假设我们修改gateway应用的配置如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">app-service1</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:9000</span><br>          <span class="hljs-attr">predicates:</span> <span class="hljs-comment">#断言，为真则匹配成功</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/app1/**</span> <span class="hljs-comment">#配置规则Path，如果是app1开头的请求，会转发到目标URL</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">AddRequestHeader=X-Request-red,blue</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">app-service2</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:9001</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/app2/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">AddRequestHeader=X-Request-red,blue</span><br></code></pre></td></tr></table></figure><p>这里会将blue消息头添加到所有匹配请求的下游请求消息头中<br>然后修改app-service1应用的controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(value = &quot;/app1&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App1Controller</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/test&quot;)</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">test</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>        System.out.println(request.getHeader(<span class="hljs-string">&quot;X-Request-red&quot;</span>));<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;app1&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>修改app-service2应用的controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(value = &quot;/app2&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App2Controller</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/test&quot;)</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">test</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>        System.out.println(request.getHeader(<span class="hljs-string">&quot;X-Request-red&quot;</span>));<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;app2&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>分别访问<a href="http://localhost/app1/test%E5%92%8Chttp://localhost/app2/test%EF%BC%8C%E7%84%B6%E5%90%8E%E6%9F%A5%E7%9C%8B%E6%8E%A7%E5%88%B6%E5%8F%B0%EF%BC%8C%E5%8F%91%E7%8E%B0%E7%A1%AE%E5%AE%9E%E6%9C%89%E6%B7%BB%E5%8A%A0%E4%B8%8Ablue%E8%AF%B7%E6%B1%82%E5%A4%B4">http://localhost/app1/test和http://localhost/app2/test，然后查看控制台，发现确实有添加上blue请求头</a></p><img src="/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A02/image6.png" class=""><img src="/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A02/image7.png" class=""><h5 id="2-1-2-AddRequestParameter"><a href="#2-1-2-AddRequestParameter" class="headerlink" title="2.1.2. AddRequestParameter"></a>2.1.2. AddRequestParameter</h5><p>AddRequestParamter需要name和value参数<br>我们修改gateway的配置如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">app-service1</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:9000</span><br>          <span class="hljs-attr">predicates:</span> <span class="hljs-comment">#断言，为真则匹配成功</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/app1/**</span> <span class="hljs-comment">#配置规则Path，如果是app1开头的请求，会转发到目标URL</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">AddRequestHeader=X-Request-red,blue</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">AddRequestParameter=red,blue</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">app-service2</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:9001</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/app2/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">AddRequestHeader=X-Request-red,blue</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">AddRequestParameter=red,blue</span><br></code></pre></td></tr></table></figure><p>这里表示将red&#x3D;blue添加到下游请求参数中<br>我们修改app-service1和app-service2的controller代码，方便查看结果：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(value = &quot;/app1&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App1Controller</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/test&quot;)</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">test</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>        System.out.println(request.getHeader(<span class="hljs-string">&quot;X-Request-red&quot;</span>));<br>        System.out.println(request.getParameter(<span class="hljs-string">&quot;red&quot;</span>));<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;app1&quot;</span>;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(value = &quot;/app2&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App2Controller</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/test&quot;)</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">test</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>        System.out.println(request.getHeader(<span class="hljs-string">&quot;X-Request-red&quot;</span>));<br>        System.out.println(request.getParameter(<span class="hljs-string">&quot;red&quot;</span>));<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;app2&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>分别访问<a href="http://localhost/app1/test%E5%92%8Chttp://localhost/app2/test%EF%BC%8C%E7%BB%93%E6%9E%9C%E5%A6%82%E4%B8%8B%EF%BC%9A">http://localhost/app1/test和http://localhost/app2/test，结果如下：</a></p><img src="/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A02/image8.png" class=""><img src="/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A02/image9.png" class=""><h4 id="2-2-GlobalFilter"><a href="#2-2-GlobalFilter" class="headerlink" title="2.2. GlobalFilter"></a>2.2. GlobalFilter</h4><p>GlobalFilter是应用于所有路由的特殊过滤器</p><img src="/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A02/image10.png" class=""><p>通过全局网关过滤器，我们可以很方便的实现统一鉴权，下面我们自定义一个全局过滤器，通过token判断用户是否登录，从而实现一个统一的鉴权。<br>我们在gateway项目中，添加一个鉴权的全局网关过滤器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.young.filter;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;<br><span class="hljs-keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;<br><span class="hljs-keyword">import</span> org.springframework.core.Ordered;<br><span class="hljs-keyword">import</span> org.springframework.core.io.buffer.DataBuffer;<br><span class="hljs-keyword">import</span> org.springframework.http.HttpStatus;<br><span class="hljs-keyword">import</span> org.springframework.http.server.reactive.ServerHttpRequest;<br><span class="hljs-keyword">import</span> org.springframework.http.server.reactive.ServerHttpResponse;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.springframework.util.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.web.server.ServerWebExchange;<br><span class="hljs-keyword">import</span> reactor.core.publisher.Flux;<br><span class="hljs-keyword">import</span> reactor.core.publisher.Mono;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthorizeFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GlobalFilter</span>, Ordered &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">ServerHttpResponse</span> <span class="hljs-variable">servletResponse</span> <span class="hljs-operator">=</span> exchange.getResponse();<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">servletRequest</span> <span class="hljs-operator">=</span> exchange.getRequest();<br>        <span class="hljs-comment">// 获取token参数</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> servletRequest.getHeaders().getFirst(<span class="hljs-string">&quot;token&quot;</span>);<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(token)) &#123;<br>            servletResponse.setStatusCode(HttpStatus.UNAUTHORIZED);<br>            servletResponse.getHeaders().add(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>            <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>            jsonObject.put(<span class="hljs-string">&quot;code&quot;</span>, <span class="hljs-string">&quot;403&quot;</span>);<br>            jsonObject.put(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;token is empty&quot;</span>);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">DataBuffer</span> <span class="hljs-variable">dataBuffer</span> <span class="hljs-operator">=</span> servletResponse.bufferFactory().wrap(jsonObject.toJSONString().getBytes());<br>            <span class="hljs-keyword">return</span> servletResponse.writeWith(Flux.just(dataBuffer));<br>        &#125;<br>        <span class="hljs-keyword">return</span> chain.filter(exchange);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>重新启动项目，然后访问<a href="http://localhost/app1/test">http://localhost/app1/test</a></p><img src="/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A02/image11.png" class=""><p>由于没有携带token，因此被拦截住，假设我们现在在请求头上添加token，再次访问，结果如下：</p><img src="/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A02/image12.png" class=""><p>此时能够访问成功，这里只是为了演示，因此鉴权逻辑写的比较简单，真实情况下的鉴权，可以基于此进行扩展和补充。</p><h3 id="3-参考文档"><a href="#3-参考文档" class="headerlink" title="3. 参考文档"></a>3. 参考文档</h3><p><a href="https://blog.csdn.net/zouliping123456/article/details/116128179">https://blog.csdn.net/zouliping123456/article/details/116128179</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>SpringBoot</tag>
      
      <tag>SpringGateway</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringGateway学习1</title>
    <link href="/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A01/"/>
    <url>/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A01/</url>
    
    <content type="html"><![CDATA[<h3 id="1-背景"><a href="#1-背景" class="headerlink" title="1. 背景"></a>1. 背景</h3><p>API网关是一个服务器，是系统对外的唯一入口，对于服务数量众多、复杂度比较高、规模比较大的业务来说，引入API网关有以下好处：<br>1） 聚合接口使得服务对调用者透明，客户端与后端耦合度降低<br>2） 聚合后台服务，节省流量，提高性能和用户体验<br>3）提供安全、流控、过滤、缓存、计费、监控等API管理功能<br>SpringCloud Gateway是基于Spring生态系统之上搭建的API网关，包括：Spring5， SpringBoot2和Project Reactor。Spring Cloud Gateway旨在提供一种简单有效的方法来路由到API，并为它们提供领域的关注点，例如安全性、监控&#x2F;指标、限流等。</p><h3 id="2-核心概念和原理"><a href="#2-核心概念和原理" class="headerlink" title="2. 核心概念和原理"></a>2. 核心概念和原理</h3><h4 id="2-1-核心概念"><a href="#2-1-核心概念" class="headerlink" title="2.1. 核心概念"></a>2.1. 核心概念</h4><p>路由（Route）：路由信息由ID、目标URL、一组断言和一组过滤器组成，如果断言路由为真，说明请求的URI和配置匹配<br>断言（Predicate）：Java8中的断言函数，SpringCloud Gateway中的断言函数，允许开发者去定义匹配来自Http Request中的任何信息，比如请求头和参数等<br>过滤器（Filter）：在SpringCloud Gateway中，有两种过滤器：Gateway Filter 和 Global Filter，过滤器负责对请求和响应进行处理。</p><h4 id="2-2-工作原理"><a href="#2-2-工作原理" class="headerlink" title="2.2. 工作原理"></a>2.2. 工作原理</h4><img src="/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A01/image1.png" class=""><p>客户端向Spring Cloud Gateway发出请求，由网关处理程序Gateway Handler Mapping映射确定与请求相匹配的路由（route），将其发送到网关web处理程序Gateway Web Handler，该程序通过指定的过滤器将请求发送到实际的服务，执行业务逻辑，然后返回。<br>过滤器由虚线分隔的原因是，过滤器可以在发送代理请求之前和之后运行逻辑。所有 pre过滤器逻辑均被执行。然后发出代理清求。发出代理清求后，将运行post过滤器逻辑。</p><h3 id="3-入门案例"><a href="#3-入门案例" class="headerlink" title="3. 入门案例"></a>3. 入门案例</h3><h4 id="3-1-创建普通的web项目，并测试相关接口"><a href="#3-1-创建普通的web项目，并测试相关接口" class="headerlink" title="3.1. 创建普通的web项目，并测试相关接口"></a>3.1. 创建普通的web项目，并测试相关接口</h4><p>创建一个maven项目，在该maven项目下，创建三个子模块，假设分别命名为gateway、app-service1、app-service2</p><img src="/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A01/image2.png" class=""><p>在父模块的pom.xml中，添加相关的版本管理</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springcloudgateway1<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>gateway<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>app-service1<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>app-service2<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring.boot.version</span>&gt;</span>2.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">spring.boot.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring.cloud.version</span>&gt;</span>2020.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">spring.cloud.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring.cloud.alibaba.version</span>&gt;</span>2.2.6.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">spring.cloud.alibaba.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--Spring版本--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.cloud.alibaba.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.cloud.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><p>在gateway模块，添加下列依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><p>app-service1和app-service2模块，添加下列依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><p>在app-service1模块，添加启动类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.young;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Service1App</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(Service1App.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>添加一个controller类用于测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(value = &quot;/app1&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App1Controller</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/test&quot;)</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;app1&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>application.yml配置信息如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9000</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">app-service1</span><br></code></pre></td></tr></table></figure><p>在app-service2中，添加启动类</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Service2App</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) &#123;<br>        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">Service2App</span>.<span class="hljs-property">class</span>, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>对外controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(value = &quot;/app2&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App2Controller</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/test&quot;)</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;app2&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>配置文件：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9001</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">app-service2</span><br></code></pre></td></tr></table></figure><p>启动app-service1和app-service2，然后访问<a href="http://localhost:9000/app1/test%E5%92%8Chttp://localhost:9001/app2/test%EF%BC%8C%E7%BB%93%E6%9E%9C%E5%A6%82%E4%B8%8B%EF%BC%9A">http://localhost:9000/app1/test和http://localhost:9001/app2/test，结果如下：</a></p><img src="/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A01/image3.png" class=""><img src="/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A01/image4.png" class=""><h4 id="3-2-配置网关转发"><a href="#3-2-配置网关转发" class="headerlink" title="3.2. 配置网关转发"></a>3.2. 配置网关转发</h4><p>在gateway模块，添加启动类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GatewayApp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(GatewayApp.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>修改配置文件，配置路由转发规则</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">app-service1</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:9000</span><br>          <span class="hljs-attr">predicates:</span> <span class="hljs-comment">#断言，为真则匹配成功</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/app1/**</span> <span class="hljs-comment">#配置规则Path，如果是app1开头的请求，会转发到目标URL</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">app-service2</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:9001</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/app2/**</span><br></code></pre></td></tr></table></figure><p>启动gateway项目，使用gateway的端口，进行测试</p><img src="/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A01/image5.png" class=""><img src="/2024/04/02/SpringGateway%E5%AD%A6%E4%B9%A01/image6.png" class="">]]></content>
    
    
    
    <tags>
      
      <tag>SpringBoot</tag>
      
      <tag>SpringGateway</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>线程池</title>
    <link href="/2024/04/02/%E7%BA%BF%E7%A8%8B%E6%B1%A0/"/>
    <url>/2024/04/02/%E7%BA%BF%E7%A8%8B%E6%B1%A0/</url>
    
    <content type="html"><![CDATA[<p>Executors是一个工厂类，提供了创建几种预配置线程池实例地方法，如果不需要应用任何自定义地微调，可以调用这些方法创建默认配置地线程池。Executors工厂类提供地线程池有以下几种：<br>1）newCachedThreadPool(): 创建一个可缓存地线程池，这个线程池地线程数量可以根据需要自动扩展，如果有可用的空闲线程，就会重用它们；如果没有可用的线程，就会创建一个新线程，适用于执行大量的短期异步任务。<br>2）newFixedThreadPool(int nThreads): 创建一个固定大小的线程池，其中包含指定数量的线程，线程数量是固定的，不会自动扩展，适用于执行固定数量的长期任务。<br>3）newSingleThreadExecutor(): 创建一个单线程的线程池，用于串行执行任务。适用于需要按顺序执行任务的场景。<br>4）newScheduledThreadPool(int corePoolSize): 创建一个单线程的定时执行线程池。只包含一个线程，用于串行定时执行任务。<br>5）newWorkStealingPool(int parallelism): 创建一个工作窃取线程池，线程数量根据CPU核心数动态调整，适用于CPU密集型的任务。</p><h3 id="ExecutorService"><a href="#ExecutorService" class="headerlink" title="ExecutorService"></a>ExecutorService</h3><p>ExecutorService是java.util.concurrent包的重要组成部分，是Java JDK提供的框架，用于简化异步模式下任务的执行。一般来说，ExecutorService会自动提供一个线程池和相关API，用于为其分配任务。</p><h4 id="工厂方法实例化ExecutorService"><a href="#工厂方法实例化ExecutorService" class="headerlink" title="工厂方法实例化ExecutorService"></a>工厂方法实例化ExecutorService</h4><p>Executors类提供了许多工厂方法用于实例化ExecutorService，最常用的是newFixedThreadPool方法，用于创建指定线程数的ExecutorService实例，使用方法如下所示：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">ExecutorService executor = Executors.newFixedThreadPool(10);<br></code></pre></td></tr></table></figure><h4 id="直接创建ExecutorService实例"><a href="#直接创建ExecutorService实例" class="headerlink" title="直接创建ExecutorService实例"></a>直接创建ExecutorService实例</h4><p>ExecutorService是一个接口，因此可以使用其任何实现类的实例，例如ThreadPoolExecutor类实现了ExecutorService接口并提供了一些构造函数用于配置执行程序服务及其内部池。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml">int core = Runtime.getRuntime().availableProcessors();<br>int max = Runtime.getRuntime().availableProcessors() * 2 + 1;<br>int wait = 60;<br>int capacity = 500;<br>ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor(core, max, wait, TimeUnit.SECONDS,<br>      new LinkedBlockingQueue<span class="hljs-tag">&lt;&gt;</span>(capacity),<br>      Executors.defaultThreadFactory(),<br>      new ThreadPoolExecutor.CallerRunsPolicy());<br></code></pre></td></tr></table></figure><p>这里的参数，从左到右分别表示：<br>1）corePoolSize：核心线程数<br>2）maxPoolSize：最大线程数<br>3）keepAliveTime：额外的线程（即实例化超过corePoolSize的线程）在空闲状态下的存活时间。<br>4）unit：等待时间单位<br>5）workQueue：任务队列<br>6）threadFactory：线程工厂<br>7）handler：拒绝策略<br>其中，拒绝策略主要有以下几种：<br>1）AbortPolicy：直接抛出RejectedExecutionException异常阻止系统正常运行。<br>2）CallerRunsPolicy：既不抛弃任务，也不抛出异常，而是将某些任务回退给调用者，从而降低任务的流量。<br>3）DiscardOldestPolicy：抛出等待队列中最先等待的任务，然后把当前任务加入队列中。<br>4）DiscardPolicy：既不处理也不抛出异常，如果允许任务丢弃，这是最好的方法。</p><h4 id="任务分配给ExecutorService"><a href="#任务分配给ExecutorService" class="headerlink" title="任务分配给ExecutorService"></a>任务分配给ExecutorService</h4><p>ExecutorService可以执行Runnable和Callable任务，首先我们创建两个原始任务类：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs xml">private static List&lt;Callable<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span>&gt; buildCallableTasks() &#123;<br>      Callable<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span> callableTask = () -&gt; &#123;<br>          TimeUnit.MILLISECONDS.sleep(300);<br>          System.out.println(&quot;buildCallable==========&quot;);<br>          return &quot;Task&#x27;s execution&quot;;<br>      &#125;;<br><br>      List&lt;Callable<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span>&gt; callableTasks = new ArrayList<span class="hljs-tag">&lt;&gt;</span>();<br>      callableTasks.add(callableTask);<br>      callableTasks.add(callableTask);<br>      callableTasks.add(callableTask);<br>      return callableTasks;<br>  &#125;<br><br>  private static Runnable buildRunnable() &#123;<br>      return () -&gt; &#123;<br>          try &#123;<br>              TimeUnit.MILLISECONDS.sleep(300);<br>              System.out.println(&quot;buildRunnable===========&quot;);<br>          &#125; catch (InterruptedException e) &#123;<br>              e.printStackTrace();<br>          &#125;<br>      &#125;;<br>  &#125;<br></code></pre></td></tr></table></figure><p>创建完任务之后，可以使用多种方法将任务分配给ExecutorService.</p><h5 id="execute"><a href="#execute" class="headerlink" title="execute"></a>execute</h5><p>改方法返回值为空(void),因此改方法没有任何可能获得任务执行结果或检查任务的状态。使用示例如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml">private static void testExecute() &#123;<br>       ExecutorService executorService = Executors.newFixedThreadPool(2);<br>       Runnable runnable = buildRunnable();<br>       executorService.execute(runnable);<br>       System.out.println(&quot;hello world=========&quot;);<br>   &#125;<br></code></pre></td></tr></table></figure><p>在main方法中调用该方法，结果如下：</p><img src="/2024/04/02/%E7%BA%BF%E7%A8%8B%E6%B1%A0/image.png" class=""><h5 id="submit"><a href="#submit" class="headerlink" title="submit"></a>submit</h5><p>submit方法会将一个Callable或Runnable任务提交给ExecutorService并返回future类型的结果。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml">private static void testSubmit() throws ExecutionException, InterruptedException &#123;<br>       ExecutorService executorService = Executors.newFixedThreadPool(2);<br>       Runnable runnable = buildRunnable();<br>       List&lt;Callable<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span>&gt; callableTasks = buildCallableTasks();<br>       Future&lt;?&gt; runnableFuture = executorService.submit(runnable);<br>       List&lt;Future<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span>&gt; callableFutures = new ArrayList<span class="hljs-tag">&lt;&gt;</span>();<br>       for (Callable<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span> callableTask : callableTasks) &#123;<br>           callableFutures.add(executorService.submit(callableTask));<br>       &#125;<br>       System.out.println(runnableFuture.get());<br>       for (Future<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span> callableFuture : callableFutures) &#123;<br>           System.out.println(callableFuture.get());<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><p>通过future类的get方法，能获取返回的结果，如果提交的是一个Runnable任务，那么通过future的get方法，返回的是一个null，如下图所示：</p><img src="/2024/04/02/%E7%BA%BF%E7%A8%8B%E6%B1%A0/image(1).png" class=""><h5 id="invokeAny"><a href="#invokeAny" class="headerlink" title="invokeAny"></a>invokeAny</h5><p>invokeAny方法将一组任务分配给ExecutorService，使每个任务执行，并返回任意一个成功执行的任务结果。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml">private static void testInvokeAny() throws ExecutionException, InterruptedException &#123;<br>      ExecutorService executorService = Executors.newFixedThreadPool(2);<br>      List&lt;Callable<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span>&gt; callableTasks = buildCallableTasks();<br>      String result = executorService.invokeAny(callableTasks);<br>      System.out.println(result);<br>  &#125;<br></code></pre></td></tr></table></figure><p>结果如下所示：</p><img src="/2024/04/02/%E7%BA%BF%E7%A8%8B%E6%B1%A0/image(2).png" class=""><h5 id="invokeAll"><a href="#invokeAll" class="headerlink" title="invokeAll"></a>invokeAll</h5><p>invokeAll方法将一组任务分配给ExecutorService，使每个任务执行，并以Future类型的对象列表形式返回所有任务执行的结果。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml">private static void testInvokeAll() throws InterruptedException, ExecutionException &#123;<br>       ExecutorService executorService = Executors.newFixedThreadPool(2);<br>       List&lt;Callable<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span>&gt; callableTasks = buildCallableTasks();<br>       List&lt;Future<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span>&gt; futures = executorService.invokeAll(callableTasks);<br>       for (Future<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span> future : futures) &#123;<br>           System.out.println(future.get());<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><p>结果如下：</p><img src="/2024/04/02/%E7%BA%BF%E7%A8%8B%E6%B1%A0/image(3).png" class=""><h4 id="关闭ExecutorService"><a href="#关闭ExecutorService" class="headerlink" title="关闭ExecutorService"></a>关闭ExecutorService</h4><p>一般情况下，ExecutorService并不会自动关闭，即使所有任务都执行完毕，或者没有要处理的任务，也不会自动销毁ExecutorService，会一直处于等待状态，等待我们给他分配新的工作。当应用程序需要处理不定期出现的任务时，这种机制很有用，但是也带来一些副作用：即使应用程序到达它的终点，也不会被停止，因为等待ExecutorService将导致JVM继续运行，这样，我们就需要主动关闭Executor Service。<br>要关闭ExecutorService，可以使用shutdown方法或shutdownNow方法</p><h5 id="shutdown"><a href="#shutdown" class="headerlink" title="shutdown"></a>shutdown</h5><p>shutdown方法并保护会立即销毁ExecutorService实例，而是首先让ExecutorService停止接受新任务，并且在所有正在运行的线程完成当前工作后关闭。</p><h5 id="shutdownNow"><a href="#shutdownNow" class="headerlink" title="shutdownNow"></a>shutdownNow</h5><p>shutdownNow() 方法会尝试立即销毁 ExecutorService 实例，所以并不能保证所有正在运行的线程将同时停止。该方法会返回等待处理的任务列表，由开发人员自行决定如何处理这些任务。<br>因为提供了两个方法，因此关闭 ExecutorService 实例的最佳实战 （ 也是 Oracle 所推荐的 ）就是同时使用这两种方法并结合 awaitTermination() 方法。<br>使用这种方式，ExecutorService 首先停止执行新任务，等待指定的时间段完成所有任务。如果该时间到期，则立即停止执行。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml">private static void testInvokeAll() throws InterruptedException, ExecutionException &#123;<br>     ExecutorService executorService = Executors.newFixedThreadPool(2);<br>     List&lt;Callable<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span>&gt; callableTasks = buildCallableTasks();<br>     List&lt;Future<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span>&gt; futures = executorService.invokeAll(callableTasks);<br>     for (Future<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span> future : futures) &#123;<br>         System.out.println(future.get());<br>     &#125;<br>     executorService.shutdown();<br>     try &#123;<br>         if (!executorService.awaitTermination(800, TimeUnit.MILLISECONDS)) &#123;<br>             executorService.shutdownNow();<br>         &#125;<br>     &#125; catch (InterruptedException e) &#123;<br>         executorService.shutdownNow();<br>     &#125;<br> &#125;<br></code></pre></td></tr></table></figure><h3 id="Future接口"><a href="#Future接口" class="headerlink" title="Future接口"></a>Future接口</h3><p>在ExecutorService的submit方法、invokeAll方法，都会返回一个Future对象或Future对象集合，这些Future接口的对象允许我们获取任务执行的结果或检查任务状态（运行中还是执行完毕）</p><h4 id="get方法"><a href="#get方法" class="headerlink" title="get方法"></a>get方法</h4><p>future接口提供一个特殊的阻塞方法get，它返回callable任务执行的实际结果，但如果是runnable任务，只会返回null。此外，正在执行的任务随时可能抛出异常或中断执行，因此我们要将get调用放在try catch语句块中，以捕获InterruptedException或ExecutionException异常。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs xml">private static void testFutureGet() &#123;<br>      ExecutorService executorService = Executors.newFixedThreadPool(2);<br>      Callable<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span> callable = () -&gt; &#123;<br>          System.out.println(&quot;执行callable任务&quot;);<br>          TimeUnit.MILLISECONDS.sleep(300);<br>          return &quot;callable执行完毕&quot;;<br>      &#125;;<br>      Future<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span> future = executorService.submit(callable);<br>      try &#123;<br>          String result = future.get();<br>          System.out.println(result);<br>      &#125; catch (InterruptedException | ExecutionException e) &#123;<br>          e.printStackTrace();<br>      &#125;<br>      executorService.shutdown();<br>      try &#123;<br>          if (!executorService.awaitTermination(800, TimeUnit.MILLISECONDS)) &#123;<br>              executorService.shutdownNow();<br>          &#125;<br>      &#125; catch (InterruptedException e) &#123;<br>          executorService.shutdownNow();<br>      &#125;<br>  &#125;<br><br></code></pre></td></tr></table></figure><p>因为get方法是阻塞的，并且不知道要阻塞多长时间，因此可能导致应用程序的性能降低，如果结果数据并不重要，我们可以使用超时机制来避免长时间阻塞，也就是使用get的重载方法，第一个参数为超时时间，第二个参数为时间的单位。如果在超时时间内正常结束，那么返回Future的结果，如果超时了还没结束，那么将抛出TimeoutExeception异常。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs xml">private static void testFutureGet() &#123;<br>        ExecutorService executorService = Executors.newFixedThreadPool(2);<br>        Callable<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span> callable = () -&gt; &#123;<br>            System.out.println(&quot;执行callable任务&quot;);<br>            TimeUnit.MILLISECONDS.sleep(300);<br>            return &quot;callable执行完毕&quot;;<br>        &#125;;<br>        Future<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span> future = executorService.submit(callable);<br>        try &#123;<br>            String result = future.get(400, TimeUnit.MILLISECONDS);<br>            System.out.println(result);<br>        &#125; catch (InterruptedException | ExecutionException | TimeoutException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        Callable<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span> callable2 = () -&gt; &#123;<br>            System.out.println(&quot;执行callable任务&quot;);<br>            TimeUnit.MILLISECONDS.sleep(500);<br>            return &quot;callable执行完毕&quot;;<br>        &#125;;<br>        Future<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span> future2 = executorService.submit(callable2);<br>        try &#123;<br>            String result = future2.get(400, TimeUnit.MILLISECONDS);<br>            System.out.println(result);<br>        &#125; catch (InterruptedException | ExecutionException | TimeoutException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        executorService.shutdown();<br>        try &#123;<br>            if (!executorService.awaitTermination(800, TimeUnit.MILLISECONDS)) &#123;<br>                executorService.shutdownNow();<br>            &#125;<br>        &#125; catch (InterruptedException e) &#123;<br>            executorService.shutdownNow();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>执行结果如下，第一个任务没有超时，所以能正常获取结果，第二个任务超时，所以会抛出异常。</p><img src="/2024/04/02/%E7%BA%BF%E7%A8%8B%E6%B1%A0/image(4).png" class=""><h4 id="其他方法"><a href="#其他方法" class="headerlink" title="其他方法"></a>其他方法</h4><p>除了get方法外，Future还提供许多方法，主要的方法如下：<br>1）isDone： 检查已分配的任务是否已处理<br>2）cancel： 取消任务执行<br>3）isCancelled：检查任务是否已取消</p><h3 id="ScheduledExecutorService接口"><a href="#ScheduledExecutorService接口" class="headerlink" title="ScheduledExecutorService接口"></a>ScheduledExecutorService接口</h3><p>ScheduledExecutorService接口用于在一些预定义的延迟之后运行任务或定期运行任务。我们可以通过Executors类的工厂方法实例化ScheduledExecutorService，如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">ScheduledExecutorService scheduledExecutorService = Executors.newSingleThreadScheduledExecutor();<br></code></pre></td></tr></table></figure><p>在ScheduledExecutorService接口中，有三个主要方法：<br>1）schedule：允许在指定的延迟后执行一次任务。<br>2）scheduleAtFixedRate：允许在指定的初始延迟后执行任务，然后以一定的周期重复执行，其中period参数用于指定两个任务的开始时间之间的间隔时间，因此任务执行的频率是固定的。<br>3）scheduleWithFixedDelay：类似于scheduleAtFixedRate，它也重复执行给定的任务，单period参数用于指定前一个任务的结束和下一个任务的开始之间的间隔时间，也就是指定下一个任务延时多久后才执行，执行频率可能会有所不同，具体取决于执行任务给定任务所需的时间。</p><h4 id="scheduled方法"><a href="#scheduled方法" class="headerlink" title="scheduled方法"></a>scheduled方法</h4><p>假设要在固定延迟后安排某个任务的执行，可以使用ScheduledExecutorService实例的scheduled方法：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs xml">private static void testScheduled() &#123;<br>        ScheduledExecutorService scheduledExecutorService = Executors.newSingleThreadScheduledExecutor();<br>        Callable<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span> callable = () -&gt; &#123;<br>            System.out.println(&quot;执行callable任务====&quot;);<br>            return &quot;callable&quot;;<br>        &#125;;<br>        ScheduledFuture<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span> schedule = scheduledExecutorService.schedule(callable, 1, TimeUnit.SECONDS);<br>        System.out.println(&quot;主线程运行中========&quot;);<br>        try &#123;<br>            System.out.println(schedule.get());<br>        &#125; catch (InterruptedException | ExecutionException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        scheduledExecutorService.shutdown();<br>        try &#123;<br>            if (!scheduledExecutorService.awaitTermination(800, TimeUnit.MILLISECONDS)) &#123;<br>                scheduledExecutorService.shutdownNow();<br>            &#125;<br>        &#125; catch (InterruptedException  e) &#123;<br>            scheduledExecutorService.shutdownNow();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>结果如下，在延迟一秒后，才开始执行线程任务：</p><img src="/2024/04/02/%E7%BA%BF%E7%A8%8B%E6%B1%A0/image(5).png" class=""><h4 id="scheduleAtFixedRate方法"><a href="#scheduleAtFixedRate方法" class="headerlink" title="scheduleAtFixedRate方法"></a>scheduleAtFixedRate方法</h4><p>当我们需要在固定延迟后，定期执行任务时，可以使用scheduleAtFixedRate方法，如下所示，每隔500毫秒执行相同的任务：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml">private static void testScheduleAtFixRate() &#123;<br>       ScheduledExecutorService scheduledExecutorService = Executors.newSingleThreadScheduledExecutor();<br>       Runnable runnable = () -&gt; &#123;<br>           System.out.println(System.currentTimeMillis());<br>           System.out.println(&quot;执行callable任务====&quot;);<br>       &#125;;<br>       // 延迟1秒后，每间隔2秒执行一次<br>       scheduledExecutorService.scheduleAtFixedRate(runnable, 1, 2, TimeUnit.SECONDS);<br>   &#125;<br></code></pre></td></tr></table></figure><p>结果如下所示，从时间戳我们可以看出，确实是每隔2秒执行一次</p><img src="/2024/04/02/%E7%BA%BF%E7%A8%8B%E6%B1%A0/image(6).png" class=""><p>如果任务执行时间比间隔时间长，那么scheduledExecutorService将等到当前任务执行后再开始下一个任务</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml">private static void testScheduleAtFixRate() &#123;<br>       ScheduledExecutorService scheduledExecutorService = Executors.newSingleThreadScheduledExecutor();<br>       Runnable runnable = () -&gt; &#123;<br>           System.out.println(System.currentTimeMillis());<br>           try &#123;<br>               TimeUnit.SECONDS.sleep(3);<br>           &#125; catch (InterruptedException e) &#123;<br>               throw new RuntimeException(e);<br>           &#125;<br>           System.out.println(&quot;执行callable任务====&quot;);<br>       &#125;;<br>       // 延迟1秒后，每间隔2秒执行一次<br>       scheduledExecutorService.scheduleAtFixedRate(runnable, 1, 2, TimeUnit.SECONDS);<br>   &#125;<br></code></pre></td></tr></table></figure><p>如下所示，我们执行任务需要3秒，而间隔时间是2秒，通过打印结果可以看出，任务之间间隔3秒，也就是会等待任务执行完成后才开始下一个任务：</p><img src="/2024/04/02/%E7%BA%BF%E7%A8%8B%E6%B1%A0/image(7).png" class=""><h4 id="scheduleWithFixedDelay方法"><a href="#scheduleWithFixedDelay方法" class="headerlink" title="scheduleWithFixedDelay方法"></a>scheduleWithFixedDelay方法</h4><p>如果任务之间必须具有固定长度的延迟，那么可以使用scheduleWithFixedDelay方法。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml">private static void testScheduleWithFixDelay() &#123;<br>     ScheduledExecutorService scheduledExecutorService = Executors.newSingleThreadScheduledExecutor();<br>     Runnable runnable = () -&gt; &#123;<br>         System.out.println(System.currentTimeMillis());<br>         try &#123;<br>             TimeUnit.SECONDS.sleep(3);<br>         &#125; catch (InterruptedException e) &#123;<br>             throw new RuntimeException(e);<br>         &#125;<br>         System.out.println(&quot;执行callable任务====&quot;);<br>     &#125;;<br>     // 延迟1秒后，每间隔2秒执行一次<br>     scheduledExecutorService.scheduleWithFixedDelay(runnable, 1, 2, TimeUnit.SECONDS);<br> &#125;<br><br></code></pre></td></tr></table></figure><p>在上述代码中，任务执行时长需要3秒，然后我们设置延迟时间为2秒，最终执行结果如下，从时间戳中可以看出，在上一个任务执行完毕后，间隔2秒才会开始下一个任务，因此任务与任务间隔时长为5秒。</p><img src="/2024/04/02/%E7%BA%BF%E7%A8%8B%E6%B1%A0/image(8).png" class=""><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="https://blog.csdn.net/qq_21484461/article/details/133101696">https://blog.csdn.net/qq_21484461&#x2F;article&#x2F;details&#x2F;133101696</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2024/04/02/hello-world/"/>
    <url>/2024/04/02/hello-world/</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
